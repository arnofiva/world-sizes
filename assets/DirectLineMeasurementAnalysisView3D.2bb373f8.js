var Ie=Object.defineProperty,Ue=Object.defineProperties;var He=Object.getOwnPropertyDescriptors;var Pe=Object.getOwnPropertySymbols;var We=Object.prototype.hasOwnProperty,Qe=Object.prototype.propertyIsEnumerable;var Le=(t,e,i)=>e in t?Ie(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,b=(t,e)=>{for(var i in e||(e={}))We.call(e,i)&&Le(t,i,e[i]);if(Pe)for(var i of Pe(e))Qe.call(e,i)&&Le(t,i,e[i]);return t},L=(t,e)=>Ue(t,He(e));import{aa as ke,a as r,d as o,n as ye,h as we,u as ee,al as m,aN as _e,p as P,d8 as Be,a_ as Se,H as M,U as E,t as _,gw as ae,eJ as q,bC as Fe,r as T,ik as ze,iA as Xe,iB as Je,c3 as Ye,bO as f,c5 as ne,ce as re,cg as te,ch as Ze,ci as Ke,cj as et,ck as tt,cl as it,cm as st,co as at,cq as nt,jE as rt,cr as ot,gY as lt,cu as dt,cw as ht,hd as ct,jF as ut,cC as pt,cF as gt,c9 as _t,j0 as mt,cB as vt,aO as oe,il as N,eM as K,im as yt,dm as le,cZ as xe,j1 as $,jG as k,jt as D,bL as Re,dk as be,i1 as me,eD as Ce,ai as wt,jH as bt,jB as ft,aQ as ve,hb as Ot,jI as Pt,bN as Lt,j3 as de,j4 as St,aR as zt,j9 as Ct,j5 as Mt,j6 as Et,jb as At,iS as Me,iy as $t,jh as je,jr as fe,af as Vt}from"./vendor.f59113c8.js";import{t as Dt,e as x,h as B,m as Tt,M as xt,R as Rt,b as he,f as Ee,_ as G,d as F,y as ce,i as jt,j as ue,s as Gt,a as pe,k as ge,w as Ae,g as Nt}from"./Segment.225e4750.js";import{b as qt,a as It,n as Ge,g as X,p as Ut}from"./LineVisualElement.2ffa1b42.js";import{geodesicLength as Ht}from"./geometryEngine.53974a6d.js";const Wt=ke.getLogger("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementController"),Qt=1e5;let A=class extends we{constructor(t){super(t),this._unitNormalizer=new Dt,this._handles=new ee,this._tempStartPosition=m(),this._tempEndPosition=m(),this._tempCornerPosition=m()}initialize(){this._handles.add(_e(this.view,"ready",()=>this._initialize(),!0))}destroy(){this._handles=P(this._handles)}_initialize(){const t=this.view.spatialReference,e=Be(t),i=e===Xe?Je:e;this._sphericalPCPF=i;const s=Se(t,i);this._unitNormalizer.spatialReference=s?i:t,this._handles.add([M(()=>({viewData:this.viewData,startPoint:this.analysis.startPoint}),({viewData:a,startPoint:n})=>{a.elevationAlignedStartPoint=this._applyProjectionAndElevationAlignment(n)},E),M(()=>({viewData:this.viewData,endPoint:this.analysis.endPoint}),({viewData:a,endPoint:n})=>{a.elevationAlignedEndPoint=this._applyProjectionAndElevationAlignment(n)},E),M(()=>({result:this._computedResult,viewData:this.viewData}),({result:a,viewData:n})=>{n.result=a},E)])}_applyProjectionAndElevationAlignment(t){if(_(t))return t;const e=qt(t,this.view.spatialReference,this.view.elevationProvider);return _(e)?(It(this.analysis,t.spatialReference,Wt),null):e}get _computedResult(){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,measurementMode:i}=this.viewData;if(_(t)||_(e))return null;const s=this._euclideanDistances(t,e),a=this._geodesicDistance(t,e,s.horizontal.value),n=i===x.Geodesic||i===x.Auto&&s.horizontal.value>Qt?"geodesic":"euclidean";return{mode:n,distance:n==="euclidean"?s.direct:a,directDistance:s.direct,horizontalDistance:s.horizontal,verticalDistance:s.vertical,geodesicDistance:a}}_euclideanDistances(t,e){const i=t.clone();i.z=e.z;const s=this._tempStartPosition,a=this._tempEndPosition,n=this._tempCornerPosition,c=this.view.spatialReference,d=this._sphericalPCPF,l=Se(c,d)?d:c;ae(t,s,l),ae(e,a,l),ae(i,n,l);const h=q(s,a),u=q(n,a),y=Math.abs(e.z-t.z),w=U=>this._unitNormalizer.normalizeDistance(U),O=w(h),R=w(u),I=w(y);return{direct:B(O,"meters"),horizontal:B(R,"meters"),vertical:B(I,"meters")}}_geodesicDistance(t,e,i){const s=t.spatialReference,a=new Fe({spatialReference:s});a.addPath([t,e]);const n=s.isGeographic&&Tt(s)?xt([a],"meters")[0]:s.isWebMercator?Ht(a,"meters"):null,c=T(n)?n:this._fallbackGeodesicDistance(t,e,i);return B(c,"meters")}_fallbackGeodesicDistance(t,e,i){if(ze(t,$e)&&ze(e,Ve)){const s={distance:0};return Rt(s,$e,Ve),s.distance}return i}};r([o()],A.prototype,"view",void 0),r([o()],A.prototype,"analysis",void 0),r([o()],A.prototype,"viewData",void 0),r([o()],A.prototype,"_computedResult",null),A=r([ye("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementController")],A);const $e=m(),Ve=m();var v,C;(function(t){t[t.None=0]="None",t[t.Direct=1]="Direct",t[t.Triangle=2]="Triangle",t[t.ProjectedGeodesic=3]="ProjectedGeodesic"})(v||(v={})),function(t){t[t.Auto=0]="Auto",t[t.AboveSegment=1]="AboveSegment",t[t.BelowSegment=2]="BelowSegment"}(C||(C={}));function kt(){const t=new Ye;t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("width","float"),t.attributes.add(f.POSITION,"vec3"),t.attributes.add(f.NORMAL,"vec3"),t.attributes.add(f.UV0,"vec2"),t.attributes.add(f.AUXPOS1,"float"),t.varyings.add("vtc","vec2"),t.varyings.add("vlength","float"),t.varyings.add("vradius","float"),t.vertex.code.add(ne`void main(void) {
vec3 bitangent = normal;
vtc = uv0;
vlength = auxpos1;
vradius = 0.5 * width;
vec4 pos = view * vec4(position + vradius * bitangent * uv0.y, 1.0);
gl_Position = proj * pos;
}`),t.fragment.uniforms.add("outlineSize","float").add("outlineColor","vec4").add("stripeLength","float").add("stripeEvenColor","vec4").add("stripeOddColor","vec4");const e=1/Math.sqrt(2);return t.fragment.code.add(ne`
    const float INV_SQRT2 = ${ne.float(e)};

    vec4 arrowColor(vec2 tc, float len) {
      float d = INV_SQRT2 * (tc.x - abs(tc.y));
      d = min(d, INV_SQRT2 * (len - tc.x - abs(tc.y)));
      d = min(d, 1.0 - abs(tc.y));

      if (d < 0.0) {
        return vec4(0.0);
      } else if (d < outlineSize) {
        return outlineColor;
      } else {
        return fract(0.5 / stripeLength * tc.x * vradius) >= 0.5 ? stripeOddColor : stripeEvenColor;
      }
    }

    void main(void) {
      vec2 ntc = vec2(vtc.x / vradius, vtc.y);
      vec4 color = arrowColor(ntc, vlength / vradius);
      if (color.a == 0.0) {
        discard;
      }
      gl_FragColor = color;
    }
  `),t}const Bt=Object.freeze({__proto__:null,build:kt});class ie extends et{constructor(e,i,s){super(e,i,s)}initializeProgram(e){const i=ie.shader.get().build();return new tt(e.rctx,i,it)}bindPass(e,i){st(this.program,i.camera.projectionMatrix),this.program.setUniform1f("width",e.width),this.program.setUniform1f("outlineSize",e.outlineSize),this.program.setUniform4fv("outlineColor",e.outlineColor),this.program.setUniform1f("stripeLength",e.stripeLength),this.program.setUniform4fv("stripeEvenColor",e.stripeEvenColor),this.program.setUniform4fv("stripeOddColor",e.stripeOddColor)}bindDraw(e){at(this.program,e),this.program.rebindTextures()}_setPipelineState(e){const i=e===te.NONE,s=this.configuration;return nt({blending:s.transparent?i?rt:ot(e):null,polygonOffset:this.configuration.polygonOffsetEnabled&&{factor:0,units:-4},depthTest:{func:lt.LESS},depthWrite:dt,colorWrite:ht})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return ct.TRIANGLE_STRIP}}ie.shader=new Ke(Bt,()=>import("./MeasurementArrow.glsl.e8f747ee.js"));class Y extends Ze{constructor(){super(...arguments),this.polygonOffsetEnabled=!1,this.transparent=!1,this.transparencyPassType=te.NONE}}r([re()],Y.prototype,"polygonOffsetEnabled",void 0),r([re()],Y.prototype,"transparent",void 0),r([re({count:te.COUNT})],Y.prototype,"transparencyPassType",void 0);class Ft extends pt{constructor(e){super(e,Jt),this.techniqueConfig=new Y}getTechniqueConfig(e,i){var s;return this.techniqueConfig.polygonOffsetEnabled=this.parameters.polygonOffset,this.techniqueConfig.transparent=this.parameters.stripeEvenColor[3]<1||this.parameters.stripeOddColor[3]<1||this.parameters.outlineColor[3]<1,this.techniqueConfig.transparencyPassType=(s=i==null?void 0:i.transparencyPassType)!=null?s:te.NONE,this.techniqueConfig}dispose(){}getPassParameters(){return this.parameters}intersect(){}requiresSlot(e){return e===gt.OPAQUE_MATERIAL}createGLMaterial(e){return e.output===_t.Color?new Xt(e):null}createBufferWriter(){return new si}}class Xt extends mt{updateParameters(e){return this.ensureTechnique(ie,e)}beginSlot(e){return this.updateParameters(e)}bind(e,i){i.bindPass(this._material.getPassParameters(),e)}}const Jt=b({width:32,outlineSize:.2,outlineColor:[1,.5,0,1],stripeLength:1,stripeEvenColor:[1,1,1,1],stripeOddColor:[1,.5,0,1],polygonOffset:!1},vt),Yt=ut().vec3f(f.POSITION).vec3f(f.NORMAL).vec2f(f.UV0).f32(f.AUXPOS1),Zt=m(),Kt=m(),ei=m(),ti=m(),ii=m();class si{constructor(){this.vertexBufferLayout=Yt}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 2*(e.indices.get(f.POSITION).length/2+1)}write(e,i,s,a){const n=i.vertexAttributes.get(f.POSITION).data,c=i.vertexAttributes.get(f.NORMAL).data,d=n.length/3,l=i&&i.indices&&i.indices.get(f.POSITION);l&&l.length!==2*(d-1)&&console.warn("MeasurementArrowMaterial does not support indices");const h=Zt,u=Kt,y=ei,w=ti,O=ii,R=e.transformation,I=e.invTranspTransformation,U=s.position,Oe=s.normal,H=s.uv0;let W=0;for(let S=0;S<d;++S){const se=3*S;if(oe(h,n[se],n[se+1],n[se+2]),S<d-1){const V=3*(S+1);oe(u,n[V],n[V+1],n[V+2]),oe(O,c[V],c[V+1],c[V+2]),N(O,O),K(y,u,h),N(y,y),yt(w,O,y),N(w,w)}const qe=q(h,u);R&&I&&(le(h,h,R),le(u,u,R),le(w,w,I));const j=a+2*S,Q=j+1;U.setVec(j,h),U.setVec(Q,h),Oe.setVec(j,w),Oe.setVec(Q,w),H.set(j,0,W),H.set(j,1,-1),H.set(Q,0,W),H.set(Q,1,1),S<d-1&&(W+=qe)}const Ne=s.auxpos1;for(let S=0;S<2*d;++S)Ne.set(a+S,W)}}class ai extends Ge{constructor(e){super(e),this._parameters=ni,this._handles=null,this._origin=m(),this._originTransform=xe(),this._arrowCenter=m(),this._renderOccluded=$.OccludeAndTransparent,this._geometry=null,this._stripeLength=1,this._stripesEnabled=!0,this._opacity=1,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._arrowMaterial&&this._arrowMaterial.setParameters({renderOccluded:e}))}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this._geometryChanged()}get stripeLength(){return this._stripeLength}set stripeLength(e){this._stripeLength=e,this.attached&&this._arrowMaterial.setParameters({stripeLength:this._stripeLength})}get stripesEnabled(){return this._stripesEnabled}set stripesEnabled(e){if(this._stripesEnabled=e,this.attached){const i=this.opacity,{arrowStripeEvenColor:s,arrowStripeOddColor:a}=this._parameters,n=k(De,this._stripesEnabled?s:a,i);this._arrowMaterial.setParameters({stripeEvenColor:n})}}get opacity(){return this._opacity}set opacity(e){e!==this._opacity&&(this._opacity=e,this._updateArrowOpacity())}createExternalResources(){const{arrowStripeEvenColor:e,arrowStripeOddColor:i,arrowOutlineColor:s}=this._parameters,a=this._stripesEnabled?e:i;this._arrowMaterial=new Ft({outlineColor:s,stripeEvenColor:a,stripeOddColor:i,renderOccluded:this.renderOccluded,polygonOffset:!0}),this._handles=new ee,this._handles.add(this.view.state.watch("camera",()=>{this._viewChanged()}))}destroyExternalResources(){this._arrowMaterial=null,this._handles.destroy(),this._handles=null}forEachExternalMaterial(e){e(this._arrowMaterial)}createGeometries(e){if(_(this._geometry)||_(this._geometry.startRenderSpace)||_(this._geometry.endRenderSpace))return;const i=this._createArrowGeometry(this._geometry.startRenderSpace,this._geometry.endRenderSpace,this._origin,this._geometry);e.addGeometry(i,this._arrowMaterial,this._originTransform),this._viewChanged()}_createArrowGeometry(e,i,s,a){const n=this.view.renderCoordsHelper,c=[],d=[],l=(h,u)=>{const y=D.get();K(y,h,s),c.push(y),d.push(u)};if(a.type==="euclidean"){a.eval(.5,this._arrowCenter);const h=D.get();n.worldUpAtPosition(this._arrowCenter,h),l(e,h),l(i,h)}else{a.eval(.5,this._arrowCenter);const h=this._parameters.arrowSubdivisions+1&-2;for(let u=0;u<h;++u){const y=u/(h-1),w=D.get(),O=D.get();a.eval(y,w),n.worldUpAtPosition(w,O),l(w,O)}}return Re.createPolylineGeometry(c,d)}_geometryChanged(){this.recreateGeometry()}_viewChanged(){if(this.view.ready&&this.attached&&T(this._geometry)){const e=this.view.state.camera.computeScreenPixelSizeAt(this._arrowCenter);this._arrowMaterial.setParameters({width:this._parameters.arrowWidth*e})}}_updateArrowOpacity(){const e=this.opacity,{arrowStripeEvenColor:i,arrowStripeOddColor:s,arrowOutlineColor:a}=this._parameters,n=k(De,this._stripesEnabled?i:s,e),c=k(ri,a,e),d=k(oi,s,e);this._arrowMaterial.setParameters({stripeEvenColor:n,outlineColor:c,stripeOddColor:d})}}const ni={arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128},De=be(),ri=be(),oi=be();class li extends Ge{constructor(e){super(e),this._handles=new ee,this._quadMaterial=null,this._outlineMaterial=null,this._maxSize=0,this._position=m(),this._up=m(),this._right=m(),this._renderOccluded=$.OccludeAndTransparent,this._color=me(1,0,0,1),this._outlineColor=me(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=$.Opaque,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateQuadMaterial())}get color(){return this._color}set color(e){Ce(this._color,e),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(e){Ce(this._outlineColor,e),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(e){const i=this._outlineSize===0!=(e===0);this._outlineSize=e,i?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(e){this._outlineRenderOccluded=e,this._updateOutlineMaterial()}set geometry({previous:e,center:i,next:s}){this._maxSize=Math.min(q(i,e),q(i,s))/3,N(this._up,K(this._up,e,i)),N(this._right,K(this._right,s,i)),wt(this._position,i),this.recreateGeometry()}createExternalResources(){this._quadMaterial=new bt(this.quadMaterialParameters),this._outlineMaterial=new ft(this.outlineMaterialParameters),this._handles.add(this.view.state.watch("camera",()=>this._updateTransform()))}destroyExternalResources(){this._quadMaterial=null,this._outlineMaterial=null,this._handles.removeAll()}forEachExternalMaterial(e){e(this._quadMaterial),e(this._outlineMaterial)}createGeometries(e){this._createQuadGeometry(e),this._createOutlineGeometry(e),this._updateTransform(e)}_createQuadGeometry(e){const i=this._quadGeometryData(this._up,this._right);e.addGeometry(i,this._quadMaterial)}_createOutlineGeometry(e){if(this._outlineSize===0)return;const i=ve(D.get(),this._up,this._right),s=Re.createPolylineGeometry([this._up,i,this._right]);e.addGeometry(s,this._outlineMaterial)}_updateTransform(e=this.object){const i=this.view.state.camera,s=this._size*i.computeScreenPixelSizeAt(this._position),a=Math.min(this._maxSize,s);Ot(J,this._position),Pt(J,J,[a,a,a]),T(e)&&(e.transformation=J)}_quadGeometryData(e,i){const s=ve(D.get(),e,i);return new Lt([[f.POSITION,{size:3,data:[0,0,0,...i,...e,...s],exclusive:!0}]],[[f.POSITION,new Uint16Array([0,1,2,1,2,3])]])}get quadMaterialParameters(){return{color:this._color,transparent:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded}}_updateQuadMaterial(){this._quadMaterial&&this._quadMaterial.setParameters(this.quadMaterialParameters)}get outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded}}_updateOutlineMaterial(){this._outlineMaterial&&this._outlineMaterial.setParameters(this.outlineMaterialParameters)}}const J=xe();var z;(function(t){t[t.Pending=0]="Pending",t[t.Ready=1]="Ready",t[t.Destroyed=2]="Destroyed"})(z||(z={}));let g=class extends we{constructor(t){super(t),this._params=b({},hi),this._handles=new ee,this._segmentVisualElement=null,this._triangleVisualElement=null,this._rightAngleQuad=null,this._projectedGeodesicLine=null,this._geodesicStartHint=null,this._geodesicEndHint=null,this._segmentLabel=null,this._verticalLabel=null,this._horizontalLabel=null,this._startPosition=m(),this._endPosition=m(),this._cornerPosition=m(),this._startPositionAtSeaLevel=m(),this._endPositionAtSeaLevel=m(),this._state=z.Pending,this._triangleOrientationOverride=null,this.messages=null,this.loadingMessages=!0,this.visualElementOrientation=C.Auto,this.triangleCollapseRatioThreshold=.03}get ready(){return this._state===z.Ready}get visible(){return this.analysisView.visible}get viewMode(){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:e}=this.analysisView;if(_(t)||_(e)||t.equals(e))return v.None;const i=this.analysisView.result;if(_(i))return v.Direct;if(i.mode==="geodesic")return this._requiresGeodesicGuideAt(this._startPosition)||this._requiresGeodesicGuideAt(this._endPosition)?v.ProjectedGeodesic:v.Direct;const{verticalDistance:s,horizontalDistance:a}=i,n=s.value,c=a.value;return Math.min(n/c,c/n)<this.triangleCollapseRatioThreshold?v.Direct:v.Triangle}get actualVisualizedMeasurement(){if(_(this.analysisView.result))switch(this.analysisView.measurementMode){case x.Auto:case x.Euclidean:default:return"euclidean";case x.Geodesic:return"geodesic"}return this.analysisView.result.mode}get allowVisualElementsOrientationChange(){return _(this._triangleOrientationOverride)}set allowVisualElementsOrientationChange(t){_(this._triangleOrientationOverride)!==t&&(_(this._triangleOrientationOverride)?this._triangleOrientationOverride=this._actualVisualElementsOrientation:this._triangleOrientationOverride=null)}get labels(){const t=this.actualVisualizedMeasurement==="geodesic";return{direct:this._segmentLabel,horizontal:t?this._segmentLabel:this._horizontalLabel,vertical:this._verticalLabel}}get testData(){var t;return{labels:this.labels,stripeLength:(t=this._segmentVisualElement)==null?void 0:t.stripeLength}}initialize(){this._handles.add(_e(this.view,"ready",()=>this._initialize(),!0))}_initialize(){switch(this._state){case z.Ready:throw new Error("invalid state");case z.Destroyed:return}const t=this._params,e={attached:!0,view:this.view};this._segmentVisualElement=new ai(L(b({},e),{geometry:null,renderOccluded:$.OccludeAndTransparent})),this._triangleVisualElement=new X(L(b({},e),{width:t.triangleLineWidth,color:t.triangleColor,renderOccluded:$.OccludeAndTransparent})),this._rightAngleQuad=new li(L(b({},e),{color:Z,renderOccluded:$.OccludeAndTransparent}));const i=L(b({},e),{polygonOffset:!0,renderOccluded:$.OccludeAndTransparent});this._projectedGeodesicLine=new X(L(b({},i),{width:t.geodesicProjectionLineWidth,color:t.geodesicProjectionLineColor,stipplePattern:de(t.guideStippleLengthPixels)})),this._geodesicStartHint=new X(L(b({},i),{width:t.guideLineWidth,color:t.geodesicProjectionLineColor,stipplePattern:de(t.guideStippleLengthPixels)})),this._geodesicEndHint=new X(L(b({},i),{width:t.guideLineWidth,color:t.geodesicProjectionLineColor,stipplePattern:de(t.guideStippleLengthPixels)})),this._segmentLabel=new he(L(b({},e),{fontSize:t.direcLabelFontSize})),this._verticalLabel=new he(L(b({},e),{fontSize:t.verticalLabelFontSize})),this._horizontalLabel=new he(L(b({},e),{fontSize:t.horizontalLabelFontSize})),this._handles.add([M(()=>{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:a}=this.analysisView,n=this.view;return{view:n,camera:n.state.camera,viewMode:this.viewMode,elevationAlignedStartPoint:s,elevationAlignedEndPoint:a,orientation:this._actualVisualElementsOrientation,visualizedMeasurement:this.actualVisualizedMeasurement,stripeLength:this._measurementArrowStripeLength}},s=>this._updateGeometryAndViewMode(s),E),M(()=>({visible:this.visible,viewMode:this.viewMode}),s=>this._updateVisualElementVisibility(s),E),M(()=>({text:this._labelsText,visualizedMeasurement:this.actualVisualizedMeasurement}),s=>this._updateLabelText(s),E),M(()=>({visible:this.visible,viewMode:this.viewMode,state:this._state}),s=>this._updateLabelVisibility(s),E),M(()=>this._measurementArrowStripeLength,s=>this._updateSegmentStripeLength(s),E),St(async()=>this._updateMessageBundle())]),this._state=z.Ready,this._updateMessageBundle()}destroy(){this._state!==z.Destroyed&&(this._handles=P(this._handles),this._segmentVisualElement=P(this._segmentVisualElement),this._triangleVisualElement=P(this._triangleVisualElement),this._rightAngleQuad=P(this._rightAngleQuad),this._projectedGeodesicLine=P(this._projectedGeodesicLine),this._geodesicStartHint=P(this._geodesicStartHint),this._geodesicEndHint=P(this._geodesicEndHint),this._segmentLabel=P(this._segmentLabel),this._verticalLabel=P(this._verticalLabel),this._horizontalLabel=P(this._horizontalLabel),this.set("view",null),this._state=z.Destroyed)}async whenReady(){await _e(this,"ready")}_updateVisualElementVisibility({visible:t,viewMode:e}){if(this._segmentVisualElement.visible=!1,this._triangleVisualElement.visible=!1,this._rightAngleQuad.visible=!1,this._projectedGeodesicLine.visible=!1,this._geodesicStartHint.visible=!1,this._geodesicEndHint.visible=!1,t)switch(e){case v.None:break;case v.Direct:this._segmentVisualElement.visible=!0;break;case v.Triangle:this._segmentVisualElement.visible=!0,this._triangleVisualElement.visible=!0,this._rightAngleQuad.visible=!0;break;case v.ProjectedGeodesic:this._segmentVisualElement.visible=!0,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}}_updateGeometryAndViewMode({view:t,camera:e,viewMode:i,elevationAlignedStartPoint:s,elevationAlignedEndPoint:a,orientation:n,visualizedMeasurement:c,stripeLength:d}){const l=t.renderCoordsHelper;if(_(s)||_(a)||s.equals(a))return;let h=this._startPosition,u=this._endPosition;l.toRenderCoords(s,h),l.toRenderCoords(a,u);const y=n===C.AboveSegment?1:-1,w=y*(l.getAltitude(u)-l.getAltitude(h));w<0&&(h=this._endPosition,u=this._startPosition);const O=c==="geodesic"?new Ee(this._startPosition,this._endPosition,l.spatialReference):new G(this._startPosition,this._endPosition);switch(this._segmentVisualElement.geometry=O,this._updateSegmentStripeLength(d),i){case v.Direct:this._updateSegment(O,n);break;case v.Triangle:this._updateSegmentAndTriangle({view:t,camera:e,segment:O,orientation:n,startPosition:h,endPosition:u,deltaSign:y,altitudeDelta:w});break;case v.ProjectedGeodesic:this._updateSegmentAndProjection({view:t,orientation:n,startPosition:h,endPosition:u})}}_updateSegment(t,e){this._segmentLabel.anchor=e===C.AboveSegment?"top":"bottom",this._segmentLabel.geometry={type:"segment",segment:t,sampleLocation:"center"}}_updateSegmentAndTriangle({view:{renderCoordsHelper:t},camera:e,segment:i,orientation:s,startPosition:a,endPosition:n,deltaSign:c,altitudeDelta:d}){const l=this._cornerPosition;t.worldUpAtPosition(a,l),zt(l,l,c*Math.abs(d)),ve(l,l,a),this._triangleVisualElement.geometry=[[[a[0],a[1],a[2]],[l[0],l[1],l[2]],[n[0],n[1],n[2]]]],this._rightAngleQuad.geometry={previous:a,center:l,next:n};const h=new G(a,l),u=new G(l,n),y=di(a,n,l,s,e);this._segmentLabel.anchor=y.segment,this._segmentLabel.geometry={type:"segment",segment:i,sampleLocation:"center"},this._verticalLabel.geometry={type:"segment",segment:h,sampleLocation:"center"},this._verticalLabel.anchor=y.vertical,this._horizontalLabel.geometry={type:"segment",segment:u,sampleLocation:"center"},this._horizontalLabel.anchor=y.horizontal}_updateSegmentAndProjection({view:{renderCoordsHelper:t},orientation:e,startPosition:i,endPosition:s}){t.setAltitude(this._startPositionAtSeaLevel,0,i),t.setAltitude(this._endPositionAtSeaLevel,0,s);const a=new Ee(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,t.spatialReference);this._projectedGeodesicLine.setGeometryFromSegment(a),this._geodesicStartHint.setGeometryFromSegment(new G(this._startPositionAtSeaLevel,i)),this._geodesicEndHint.setGeometryFromSegment(new G(this._endPositionAtSeaLevel,s)),this._segmentLabel.geometry={type:"segment",segment:a,sampleLocation:"center"},this._segmentLabel.anchor=e===C.AboveSegment?"top":"bottom"}_updateLabelText({text:t,visualizedMeasurement:e}){T(t)?(this._segmentLabel.text=e==="euclidean"?t.euclideanDistance:t.geodesicDistance,this._horizontalLabel.text=t.horizontalDistance,this._verticalLabel.text=t.verticalDistance):(this._segmentLabel.text=null,this._horizontalLabel.text=null,this._verticalLabel.text=null),this.notifyChange("labels")}_updateLabelVisibility({state:t,visible:e,viewMode:i}){if(t!==z.Ready)return;const s=this._segmentLabel,a=this._horizontalLabel,n=this._verticalLabel;if(s.visible=!1,a.visible=!1,n.visible=!1,e)switch(i){case v.Direct:s.visible=!0;break;case v.Triangle:s.visible=!0,a.visible=!0,n.visible=!0;break;case v.ProjectedGeodesic:s.visible=!0;case v.None:}}get _labelsText(){if(this._state!==z.Ready)return null;const t=this.messages,e=this.analysisView.result;if(_(e)||_(t))return null;const{directDistance:i,horizontalDistance:s,verticalDistance:a,geodesicDistance:n}=e,c=this.analysisView.unit,d=l=>b({euclideanDistance:"",geodesicDistance:"",horizontalDistance:"",verticalDistance:""},l);switch(c){case"metric":return d({euclideanDistance:i&&ue(t,i),geodesicDistance:n&&ue(t,n),horizontalDistance:s&&ue(t,s),verticalDistance:a&&Gt(t,a)});case"imperial":return d({euclideanDistance:i&&ce(t,i),geodesicDistance:n&&ce(t,n),horizontalDistance:s&&ce(t,s),verticalDistance:a&&jt(t,a)});default:return d({euclideanDistance:i&&F(t,i,c),geodesicDistance:n&&F(t,n,c),horizontalDistance:s&&F(t,s,c),verticalDistance:a&&F(t,a,c)})}}_updateSegmentStripeLength(t){const e=this._segmentVisualElement;T(t)?(e.stripeLength=t,e.stripesEnabled=!0):e.stripesEnabled=!1}get _actualVisualElementsOrientation(){if(T(this._triangleOrientationOverride))return this._triangleOrientationOverride;const t=this.visualElementOrientation;return t===C.Auto?this.view.state.camera.aboveGround?C.AboveSegment:C.BelowSegment:t}_requiresGeodesicGuideAt(t){const e=this.view;if(e==null||!e.state)return!1;const i=e.state.camera,s=e.renderCoordsHelper,a=i.computeScreenPixelSizeAt(t);return s.getAltitude(t)/a>=10}get _measurementArrowStripeLength(){const{result:t,unit:e}=this.analysisView;if(_(t))return null;let i=null;const s=t.directDistance;switch(e){case"metric":i=s&&pe(s,"meters");break;case"imperial":i=s&&pe(s,Ct(s.value,s.unit));break;default:i=s&&pe(s,e)}return _(i)?null:Mt(i.value/30)*Et(1,i.unit,"meters")}_updateMessageBundle(){this.loadingMessages=!0,At("esri/core/t9n/Units").then(t=>{this.messages=t}).finally(()=>{this.loadingMessages=!1})}};function di(t,e,i,s,a){const n=ci,c=ui;a.projectToRenderScreen(i,n),a.projectToRenderScreen(e,c);const d={segment:"bottom",horizontal:"top",vertical:n[0]<c[0]?"left":"right"};{const l=pi,h=gi;if(ge(t,i,l,a),ge(t,e,h,a),Me(l,h)>=Te){const u=Math.sign(l[1])===Math.sign(h[1]);d.segment=u?Ae(d.vertical):d.vertical}else{const u=_i;ge(i,e,u,a),Me(u,h)>=Te&&(d.segment=Math.sign(u[0])===Math.sign(h[0])?Ae(d.horizontal):d.horizontal)}}if(s===C.BelowSegment){const l=h=>h==="top"?"bottom":"top";d.segment=l(d.segment),d.horizontal=l(d.horizontal),d.vertical=l(d.vertical)}return d}r([o()],g.prototype,"_state",void 0),r([o()],g.prototype,"_triangleOrientationOverride",void 0),r([o()],g.prototype,"messages",void 0),r([o()],g.prototype,"view",void 0),r([o()],g.prototype,"analysis",void 0),r([o()],g.prototype,"analysisView",void 0),r([o()],g.prototype,"ready",null),r([o()],g.prototype,"loadingMessages",void 0),r([o()],g.prototype,"visible",null),r([o()],g.prototype,"viewMode",null),r([o()],g.prototype,"actualVisualizedMeasurement",null),r([o()],g.prototype,"visualElementOrientation",void 0),r([o()],g.prototype,"triangleCollapseRatioThreshold",void 0),r([o()],g.prototype,"allowVisualElementsOrientationChange",null),r([o()],g.prototype,"labels",null),r([o()],g.prototype,"testData",null),r([o()],g.prototype,"_labelsText",null),r([o()],g.prototype,"_actualVisualElementsOrientation",null),r([o()],g.prototype,"_measurementArrowStripeLength",null),g=r([ye("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementVisualization")],g);const Z=me(1,.5,0,.75),hi={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,triangleColor:Z,triangleLineWidth:3,triangleCornerSize:32,triangleSubdivisions:128,arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:Z,guideLineWidth:2,guideLineColor:Z,guideStippleLengthPixels:6,labelDistance:25,direcLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12},Te=Math.cos($t(12)),ci=je(),ui=je(),pi=fe(),gi=fe(),_i=fe();let p=class extends Ut(we){constructor(t){super(t),this.type="direct-line-measurement-view-3d",this.result=null,this.measurementMode=x.Auto,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}initialize(){const t=this.view,e=this.analysis;this._analysisVisualization=new g({view:t,analysis:e,analysisView:this}),this._analysisController=new A({view:t,analysis:e,viewData:this})}destroy(){this._analysisController=P(this._analysisController),this._analysisVisualization=P(this._analysisVisualization)}whenReady(){return this._analysisVisualization.whenReady()}get updating(){var t;return!((t=this._analysisVisualization)==null||!t.loadingMessages)}get viewMode(){return this._analysisVisualization.viewMode}get actualVisualizedMeasurement(){return this._analysisVisualization.actualVisualizedMeasurement}get visualElementOrientation(){return this._analysisVisualization.visualElementOrientation}set visualElementOrientation(t){this._analysisVisualization.visualElementOrientation=t}get allowVisualElementsOrientationChange(){return this._analysisVisualization.allowVisualElementsOrientationChange}set allowVisualElementsOrientationChange(t){this._analysisVisualization.allowVisualElementsOrientationChange=t}get triangleCollapseRatioThreshold(){return this._analysisVisualization.triangleCollapseRatioThreshold}set triangleCollapseRatioThreshold(t){this._analysisVisualization.triangleCollapseRatioThreshold=t}get directLabelText(){return this._analysisVisualization.labels.direct.text}get horizontalLabelText(){return this._analysisVisualization.labels.horizontal.text}get verticalLabelText(){return this._analysisVisualization.labels.vertical.text}get testData(){var t;return this.destroyed?{labels:null,stripeLength:null,visualization:null,controller:null}:L(b({},(t=this._analysisVisualization)==null?void 0:t.testData),{visualization:this._analysisVisualization,controller:this._analysisController})}get unit(){return Vt(this.analysis.unit,this._defaultUnit)}};r([o()],p.prototype,"updating",null),r([o()],p.prototype,"type",void 0),r([o()],p.prototype,"analysis",void 0),r([o()],p.prototype,"result",void 0),r([o()],p.prototype,"measurementMode",void 0),r([o()],p.prototype,"elevationAlignedStartPoint",void 0),r([o()],p.prototype,"elevationAlignedEndPoint",void 0),r([o({readOnly:!0})],p.prototype,"viewMode",null),r([o({readOnly:!0})],p.prototype,"actualVisualizedMeasurement",null),r([o()],p.prototype,"visualElementOrientation",null),r([o()],p.prototype,"allowVisualElementsOrientationChange",null),r([o()],p.prototype,"triangleCollapseRatioThreshold",null),r([o({readOnly:!0})],p.prototype,"directLabelText",null),r([o({readOnly:!0})],p.prototype,"horizontalLabelText",null),r([o({readOnly:!0})],p.prototype,"verticalLabelText",null),r([o()],p.prototype,"testData",null),r([o()],p.prototype,"_analysisVisualization",void 0),r([o()],p.prototype,"_analysisController",void 0),r([o()],p.prototype,"unit",null),r([o(Nt)],p.prototype,"_defaultUnit",void 0),p=r([ye("esri.views.3d.analysis.DirectLineMeasurementAnalysisView3D")],p);const mi=p;var Oi=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:mi});export{Oi as D,kt as r};
