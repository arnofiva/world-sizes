var Zwe=Object.defineProperty,Qwe=Object.defineProperties;var Jwe=Object.getOwnPropertyDescriptors;var iM=Object.getOwnPropertySymbols;var $X=Object.prototype.hasOwnProperty,DX=Object.prototype.propertyIsEnumerable;var IX=(e,t,i)=>t in e?Zwe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,I=(e,t)=>{for(var i in t||(t={}))$X.call(t,i)&&IX(e,i,t[i]);if(iM)for(var i of iM(t))DX.call(t,i)&&IX(e,i,t[i]);return e},me=(e,t)=>Qwe(e,Jwe(t));var c5=(e,t)=>{var i={};for(var r in e)$X.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(e!=null&&iM)for(var r of iM(e))t.indexOf(r)<0&&DX.call(e,r)&&(i[r]=e[r]);return i};const eD={transparent:[0,0,0,0],black:[0,0,0,1],silver:[192,192,192,1],gray:[128,128,128,1],white:[255,255,255,1],maroon:[128,0,0,1],red:[255,0,0,1],purple:[128,0,128,1],fuchsia:[255,0,255,1],green:[0,128,0,1],lime:[0,255,0,1],olive:[128,128,0,1],yellow:[255,255,0,1],navy:[0,0,128,1],blue:[0,0,255,1],teal:[0,128,128,1],aqua:[0,255,255,1],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],blanchedalmond:[255,235,205,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],oldlace:[253,245,230,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],rebeccapurple:[102,51,153,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],whitesmoke:[245,245,245,1],yellowgreen:[154,205,50,1]};function toe(e){return eD[e]||eD[e.toLowerCase()]}function n7(e){var t;return(t=eD[e])!=null?t:eD[e.toLowerCase()]}function Kwe(e){return[...n7(e)]}function u5(e,t,i){i<0&&++i,i>1&&--i;const r=6*i;return r<1?e+(t-e)*r:2*i<1?t:3*i<2?e+(t-e)*(2/3-i)*6:e}function ioe(e,t,i,r=1){const s=(e%360+360)%360/360,n=i<=.5?i*(t+1):i+t-i*t,o=2*i-n;return[Math.round(255*u5(o,n,s+1/3)),Math.round(255*u5(o,n,s)),Math.round(255*u5(o,n,s-1/3)),r]}function exe(e){const t=e.length>5,i=t?8:4,r=(1<<i)-1,s=t?1:17,n=t?e.length===9:e.length===5;let o=Number("0x"+e.substr(1));if(isNaN(o))return null;const a=[0,0,0,1];let l;return n&&(l=o&r,o>>=i,a[3]=s*l/255),l=o&r,o>>=i,a[2]=s*l,l=o&r,o>>=i,a[1]=s*l,l=o&r,o>>=i,a[0]=s*l,a}function M(){return[0,0,0]}function As(e){return[e[0],e[1],e[2]]}function je(e,t,i){return[e,t,i]}function da(e){const t=M(),i=Math.min(3,e.length);for(let r=0;r<i;++r)t[r]=e[r];return t}function o7(e,t){return new Float64Array(e,t,3)}function roe(){return M()}function soe(){return je(1,1,1)}function noe(){return je(1,0,0)}function ooe(){return je(0,1,0)}function a7(){return je(0,0,1)}const pl=roe(),up=soe(),txe=noe(),ixe=ooe(),aoe=a7();Object.freeze({__proto__:null,create:M,clone:As,fromValues:je,fromArray:da,createView:o7,zeros:roe,ones:soe,unitX:noe,unitY:ooe,unitZ:a7,ZEROS:pl,ONES:up,UNIT_X:txe,UNIT_Y:ixe,UNIT_Z:aoe});const wt=1e-6,Nh=Math.random,rxe=Math.PI/180,sxe=180/Math.PI;function xN(e){return e*rxe}function nxe(e){return e*sxe}function oxe(e,t){return Math.abs(e-t)<=wt*Math.max(1,Math.abs(e),Math.abs(t))}Object.freeze({__proto__:null,EPSILON:wt,RANDOM:Nh,toRadian:xN,toDegree:nxe,equals:oxe});function Pe(e){const t=e[0],i=e[1],r=e[2];return Math.sqrt(t*t+i*i+r*r)}function ne(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function oe(e,t,i,r){return e[0]=t,e[1]=i,e[2]=r,e}function pe(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e}function de(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e}function l7(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e}function tD(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e}function axe(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function lxe(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}function loe(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e}function coe(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e}function cxe(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e}function ae(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e}function Jz(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e}function xi(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return Math.sqrt(i*i+r*r+s*s)}function qn(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return i*i+r*r+s*s}function Go(e){const t=e[0],i=e[1],r=e[2];return t*t+i*i+r*r}function mo(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function uxe(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}function be(e,t){const i=t[0],r=t[1],s=t[2];let n=i*i+r*r+s*s;return n>0&&(n=1/Math.sqrt(n),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n),e}function _e(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function pt(e,t,i){const r=t[0],s=t[1],n=t[2],o=i[0],a=i[1],l=i[2];return e[0]=s*l-n*a,e[1]=n*o-r*l,e[2]=r*a-s*o,e}function Cs(e,t,i,r){const s=t[0],n=t[1],o=t[2];return e[0]=s+r*(i[0]-s),e[1]=n+r*(i[1]-n),e[2]=o+r*(i[2]-o),e}function hxe(e,t,i,r,s,n){const o=n*n,a=o*(2*n-3)+1,l=o*(n-2)+n,c=o*(n-1),h=o*(3-2*n);return e[0]=t[0]*a+i[0]*l+r[0]*c+s[0]*h,e[1]=t[1]*a+i[1]*l+r[1]*c+s[1]*h,e[2]=t[2]*a+i[2]*l+r[2]*c+s[2]*h,e}function dxe(e,t,i,r,s,n){const o=1-n,a=o*o,l=n*n,c=a*o,h=3*n*a,p=3*l*o,f=l*n;return e[0]=t[0]*c+i[0]*h+r[0]*p+s[0]*f,e[1]=t[1]*c+i[1]*h+r[1]*p+s[1]*f,e[2]=t[2]*c+i[2]*h+r[2]*p+s[2]*f,e}function pxe(e,t){t=t||1;const i=2*Nh()*Math.PI,r=2*Nh()-1,s=Math.sqrt(1-r*r)*t;return e[0]=Math.cos(i)*s,e[1]=Math.sin(i)*s,e[2]=r*t,e}function ke(e,t,i){const r=t[0],s=t[1],n=t[2];return e[0]=i[0]*r+i[4]*s+i[8]*n+i[12],e[1]=i[1]*r+i[5]*s+i[9]*n+i[13],e[2]=i[2]*r+i[6]*s+i[10]*n+i[14],e}function al(e,t,i){const r=t[0],s=t[1],n=t[2];return e[0]=r*i[0]+s*i[3]+n*i[6],e[1]=r*i[1]+s*i[4]+n*i[7],e[2]=r*i[2]+s*i[5]+n*i[8],e}function p0(e,t,i){const r=i[0],s=i[1],n=i[2],o=i[3],a=t[0],l=t[1],c=t[2];let h=s*c-n*l,p=n*a-r*c,f=r*l-s*a,g=s*f-n*p,y=n*h-r*f,v=r*p-s*h;const b=2*o;return h*=b,p*=b,f*=b,g*=2,y*=2,v*=2,e[0]=a+h+g,e[1]=l+p+y,e[2]=c+f+v,e}function fxe(e,t,i,r){const s=[],n=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],n[0]=s[0],n[1]=s[1]*Math.cos(r)-s[2]*Math.sin(r),n[2]=s[1]*Math.sin(r)+s[2]*Math.cos(r),e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e}function mxe(e,t,i,r){const s=[],n=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],n[0]=s[2]*Math.sin(r)+s[0]*Math.cos(r),n[1]=s[1],n[2]=s[2]*Math.cos(r)-s[0]*Math.sin(r),e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e}function gxe(e,t,i,r){const s=[],n=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],n[0]=s[0]*Math.cos(r)-s[1]*Math.sin(r),n[1]=s[0]*Math.sin(r)+s[1]*Math.cos(r),n[2]=s[2],e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e}function yxe(e,t){ne(rM,e),ne(sM,t),be(rM,rM),be(sM,sM);const i=_e(rM,sM);return i>1?0:i<-1?Math.PI:Math.acos(i)}const rM=M(),sM=M();function vxe(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"}function ll(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function bT(e,t){if(e===t)return!0;const i=e[0],r=e[1],s=e[2],n=t[0],o=t[1],a=t[2];return Math.abs(i-n)<=wt*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(r-o)<=wt*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(s-a)<=wt*Math.max(1,Math.abs(s),Math.abs(a))}function Um(e,t,i){const r=i[0]-t[0],s=i[1]-t[1],n=i[2]-t[2];let o=r*r+s*s+n*n;return o>0?(o=1/Math.sqrt(o),e[0]=r*o,e[1]=s*o,e[2]=n*o,e):(e[0]=0,e[1]=0,e[2]=0,e)}const vp=de,_xe=l7,bxe=tD,c7=xi,u7=qn,h7=Pe,Kz=Go,LX=Object.freeze({__proto__:null,length:Pe,copy:ne,set:oe,add:pe,subtract:de,multiply:l7,divide:tD,ceil:axe,floor:lxe,min:loe,max:coe,round:cxe,scale:ae,scaleAndAdd:Jz,distance:xi,squaredDistance:qn,squaredLength:Go,negate:mo,inverse:uxe,normalize:be,dot:_e,cross:pt,lerp:Cs,hermite:hxe,bezier:dxe,random:pxe,transformMat4:ke,transformMat3:al,transformQuat:p0,rotateX:fxe,rotateY:mxe,rotateZ:gxe,angle:yxe,str:vxe,exactEquals:ll,equals:bT,direction:Um,sub:vp,mul:_xe,div:bxe,dist:c7,sqrDist:u7,len:h7,sqrLen:Kz});function _a(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function Ho(e,t,i,r,s){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e}function d7(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e}function uoe(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}function hoe(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e[3]=t[3]*i[3],e}function doe(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e[3]=t[3]/i[3],e}function wxe(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e}function xxe(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e}function Txe(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e[3]=Math.min(t[3],i[3]),e}function Sxe(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e[3]=Math.max(t[3],i[3]),e}function Exe(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e}function JR(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e}function Axe(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e}function poe(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2],n=t[3]-e[3];return Math.sqrt(i*i+r*r+s*s+n*n)}function iD(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2],n=t[3]-e[3];return i*i+r*r+s*s+n*n}function p7(e){const t=e[0],i=e[1],r=e[2],s=e[3];return Math.sqrt(t*t+i*i+r*r+s*s)}function f7(e){const t=e[0],i=e[1],r=e[2],s=e[3];return t*t+i*i+r*r+s*s}function Cxe(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function Rxe(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e}function foe(e,t){const i=t[0],r=t[1],s=t[2],n=t[3];let o=i*i+r*r+s*s+n*n;return o>0&&(o=1/Math.sqrt(o),e[0]=i*o,e[1]=r*o,e[2]=s*o,e[3]=n*o),e}function moe(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function m7(e,t,i,r){const s=t[0],n=t[1],o=t[2],a=t[3];return e[0]=s+r*(i[0]-s),e[1]=n+r*(i[1]-n),e[2]=o+r*(i[2]-o),e[3]=a+r*(i[3]-a),e}function Oxe(e,t){let i,r,s,n,o,a;t=t||1;do i=2*Nh()-1,r=2*Nh()-1,o=i*i+r*r;while(o>=1);do s=2*Nh()-1,n=2*Nh()-1,a=s*s+n*n;while(a>=1);const l=Math.sqrt((1-o)/a);return e[0]=t*i,e[1]=t*r,e[2]=t*s*l,e[3]=t*n*l,e}function Ou(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3];return e[0]=i[0]*r+i[4]*s+i[8]*n+i[12]*o,e[1]=i[1]*r+i[5]*s+i[9]*n+i[13]*o,e[2]=i[2]*r+i[6]*s+i[10]*n+i[14]*o,e[3]=i[3]*r+i[7]*s+i[11]*n+i[15]*o,e}function Mxe(e,t,i){const r=t[0],s=t[1],n=t[2],o=i[0],a=i[1],l=i[2],c=i[3],h=c*r+a*n-l*s,p=c*s+l*r-o*n,f=c*n+o*s-a*r,g=-o*r-a*s-l*n;return e[0]=h*c+g*-o+p*-l-f*-a,e[1]=p*c+g*-a+f*-o-h*-l,e[2]=f*c+g*-l+h*-a-p*-o,e[3]=t[3],e}function Pxe(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}function g1(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function goe(e,t){const i=e[0],r=e[1],s=e[2],n=e[3],o=t[0],a=t[1],l=t[2],c=t[3];return Math.abs(i-o)<=wt*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-a)<=wt*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(s-l)<=wt*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=wt*Math.max(1,Math.abs(n),Math.abs(c))}const Ixe=uoe,$xe=hoe,Dxe=doe,Lxe=poe,Nxe=iD,Fxe=p7,Uxe=f7,yoe=Object.freeze({__proto__:null,copy:_a,set:Ho,add:d7,subtract:uoe,multiply:hoe,divide:doe,ceil:wxe,floor:xxe,min:Txe,max:Sxe,round:Exe,scale:JR,scaleAndAdd:Axe,distance:poe,squaredDistance:iD,length:p7,squaredLength:f7,negate:Cxe,inverse:Rxe,normalize:foe,dot:moe,lerp:m7,random:Oxe,transformMat4:Ou,transformQuat:Mxe,str:Pxe,exactEquals:g1,equals:goe,sub:Ixe,mul:$xe,div:Dxe,dist:Lxe,sqrDist:Nxe,len:Fxe,sqrLen:Uxe}),NX=new Float32Array(1);function wT(e){--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1}function Be(e,t,i){return Math.min(Math.max(e,t),i)}function xT(e){return(e&e-1)==0}function yft(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function vft(e){return 10**Math.ceil(Math.LOG10E*Math.log(e))}function qt(e,t,i){return e+(t-e)*i}function Rt(e){return e*Math.PI/180}function yl(e){return 180*e/Math.PI}function e6(e,t=1e-6){return(e<0?-1:1)/Math.max(Math.abs(e),t)}function Rs(e){return Math.acos(Be(e,-1,1))}function Yh(e){return Math.asin(Be(e,-1,1))}function kxe(e,t,i=1e-6){if(isNaN(e)||isNaN(t))return!1;if(e===t)return!0;const r=Math.abs(e-t),s=Math.abs(e),n=Math.abs(t);if(e===0||t===0||s<1e-12&&n<1e-12){if(r>.01*i)return!1}else if(r/(s+n)>i)return!1;return!0}function h5(e,t,i=1e-6){return isNaN(e)||isNaN(t)?!1:(e>t?e-t:t-e)<=i}function zxe(e){return voe(Math.max(-t6,Math.min(e,t6)))}function voe(e){return NX[0]=e,NX[0]}function TT(e,t,i){const r=Be((i-e)/(t-e),0,1);return r*r*(3-2*r)}function FX(e,t){const i=Pe(e),r=Yh(e[2]/i),s=Math.atan2(e[1]/i,e[0]/i);return oe(t,i,r,s),t}function _ft(e,t,i){return Ho(e,t[0],t[1],t[2],t[3]*i)}const t6=voe(34028234663852886e22),Fg=null;function _(e){return e!=null}function R(e){return e==null}function bft(e){return e===void 0}function po(e,t){return _(e)?t(e):Fg}function wft(e){return e}function Bxe(e,t){if(R(e))throw new Error(t);return e}function gt(e,t){return _(e)?e:typeof t=="function"?t():t}function xft(e,t){return _(e)?e:t}function rt(e){return _(e)&&e.destroy(),null}function tt(e){return _(e)&&e.dispose(),null}function Js(e){return _(e)&&e.remove(),null}function Iu(e){return _(e)&&e.abort(),null}function Xi(e){return _(e)&&e.release(),null}function Tft(e,t){return _(e)&&_(t)?e.equals(t):e===t}function Vxe(e){return null}function Sft(e,t){const i=new Array;return e.forEach(r=>{const s=t(r);_(s)&&i.push(s)}),i}function Eft(e,t){const i=new Array;for(const r of e)i.push(tl(r,null,t));return i}function Aft(e,t){for(const i of e)po(i,t)}function tl(e,t,i){return _(e)?i(e):t}function Cft(e){return e.filter(t=>_(t))}function Pr(e,...t){let i=e;for(let r=0;r<t.length&&i;++r)i=i[t[r]];return i}function Rft(e){return e}var UX,kX;let nm;var zX,BX;(UX=globalThis.dojoConfig)!=null&&UX.has||(kX=globalThis.esriConfig)!=null&&kX.has?nm=I(I({},(zX=globalThis.dojoConfig)==null?void 0:zX.has),(BX=globalThis.esriConfig)==null?void 0:BX.has):nm={};function ue(e){return typeof nm[e]=="function"?nm[e]=nm[e](globalThis):nm[e]}ue.add=(e,t,i,r)=>((r||nm[e]===void 0)&&(nm[e]=t),i&&ue(e)),ue.cache=nm,ue.add("esri-deprecation-warnings",!0),(()=>{var e;ue.add("host-webworker",globalThis.WorkerGlobalScope!==void 0&&self instanceof globalThis.WorkerGlobalScope);const t=typeof window!="undefined"&&typeof location!="undefined"&&typeof document!="undefined"&&window.location===location&&window.document===document;if(ue.add("host-browser",t),ue.add("host-node",typeof globalThis.process=="object"&&((e=globalThis.process.versions)==null?void 0:e.node)&&globalThis.process.versions.v8),ue.add("dom",t),ue("host-browser")){const i=navigator,r=i.userAgent,s=i.appVersion,n=parseFloat(s);if(ue.add("wp",parseFloat(r.split("Windows Phone")[1])||void 0),ue.add("msapp",parseFloat(r.split("MSAppHost/")[1])||void 0),ue.add("khtml",s.includes("Konqueror")?n:void 0),ue.add("edge",parseFloat(r.split("Edge/")[1])||void 0),ue.add("opr",parseFloat(r.split("OPR/")[1])||void 0),ue.add("webkit",!ue("wp")&&!ue("edge")&&parseFloat(r.split("WebKit/")[1])||void 0),ue.add("chrome",!ue("edge")&&!ue("opr")&&parseFloat(r.split("Chrome/")[1])||void 0),ue.add("android",!ue("wp")&&parseFloat(r.split("Android ")[1])||void 0),ue.add("safari",!s.includes("Safari")||ue("wp")||ue("chrome")||ue("android")||ue("edge")||ue("opr")?void 0:parseFloat(s.split("Version/")[1])),ue.add("mac",s.includes("Macintosh")),!ue("wp")&&r.match(/(iPhone|iPod|iPad)/)){const o=RegExp.$1.replace(/P/,"p"),a=r.match(/OS ([\d_]+)/)?RegExp.$1:"1",l=parseFloat(a.replace(/_/,".").replace(/_/g,""));ue.add(o,l),ue.add("ios",l)}ue.add("trident",parseFloat(s.split("Trident/")[1])||void 0),ue("webkit")||(!r.includes("Gecko")||ue("wp")||ue("khtml")||ue("trident")||ue("edge")||ue.add("mozilla",n),ue("mozilla")&&ue.add("ff",parseFloat(r.split("Firefox/")[1]||r.split("Minefield/")[1])||void 0))}})(),(()=>{if(globalThis.navigator){const e=navigator.userAgent,t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile/i.test(e),i=/iPhone/i.test(e);t&&ue.add("esri-mobile",t),i&&ue.add("esri-iPhone",i),ue.add("esri-geolocation",!!navigator.geolocation)}ue.add("esri-canvas-svg-support",!ue("trident")),ue.add("esri-wasm","WebAssembly"in globalThis),ue.add("esri-shared-array-buffer",()=>{const e="SharedArrayBuffer"in globalThis,t=globalThis.crossOriginIsolated===!1;return e&&!t}),ue.add("esri-atomics","Atomics"in globalThis),ue.add("esri-workers","Worker"in globalThis),ue.add("web-feat:cache","caches"in globalThis),ue.add("esri-workers-arraybuffer-transfer",!ue("safari")||Number(ue("safari"))>=12),ue.add("featurelayer-simplify-thresholds",[.5,.5,.5,.5]),ue.add("featurelayer-simplify-payload-size-factors",[1,1,4]),ue.add("featurelayer-snapshot-enabled",!0),ue.add("featurelayer-snapshot-point-min-threshold",8e4),ue.add("featurelayer-snapshot-point-max-threshold",4e5),ue.add("featurelayer-snapshot-point-coverage",.1),ue.add("featurelayer-advanced-symbols",!1),ue.add("featurelayer-pbf",!0),ue.add("featurelayer-pbf-statistics",!1),ue.add("feature-layers-workers",!0),ue.add("feature-polyline-generalization-factor",1),ue.add("mapview-transitions-duration",200),ue.add("mapview-srswitch-adjust-rotation-scale-threshold",24e6),ue.add("mapserver-pbf-enabled",!1),ue("host-webworker")||ue("host-browser")&&(ue.add("esri-csp-restrictions",()=>{try{new Function}catch{return!0}return!1}),ue.add("esri-image-decode",()=>{if("decode"in new Image){const e=new Image;return e.src='data:image/svg+xml;charset=UTF-8,<svg version="1.1" xmlns="http://www.w3.org/2000/svg"></svg>',void e.decode().then(()=>{ue.add("esri-image-decode",!0,!0,!0)}).catch(()=>{ue.add("esri-image-decode",!1,!0,!0)})}return!1}),ue.add("esri-url-encodes-apostrophe",()=>{const e=window.document.createElement("a");return e.href="?'",e.href.includes("?%27")}))})();class fu{constructor(t=1){this._seed=t}set seed(t){this._seed=t==null?Math.random()*fu._m:t}getInt(){return this._seed=(fu._a*this._seed+fu._c)%fu._m,this._seed}getFloat(){return this.getInt()/(fu._m-1)}getIntRange(t,i){return Math.round(this.getFloatRange(t,i))}getFloatRange(t,i){const r=i-t;return t+this.getInt()/fu._m*r}}fu._m=2147483647,fu._a=48271,fu._c=0;function TN(e,t){return t?e.filter((i,r,s)=>s.findIndex(t.bind(null,i))===r):e.filter((i,r,s)=>s.indexOf(i)===r)}function y1(e,t,i){if(R(e)&&R(t))return!0;if(R(e)||R(t)||e.length!==t.length)return!1;if(i){for(let r=0;r<e.length;r++)if(!i(e[r],t[r]))return!1}else for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function Gxe(e,t,i){let r,s;return i?(r=t.filter(n=>!e.some(o=>i(o,n))),s=e.filter(n=>!t.some(o=>i(o,n)))):(r=t.filter(n=>!e.includes(n)),s=e.filter(n=>!t.includes(n))),{added:r,removed:s}}function jxe(e){return e&&typeof e.length=="number"}function Oft(e,t){const i=e.length;if(i===0)return[];const r=[];for(let s=0;s<i;s+=t)r.push(e.slice(s,s+t));return r}const Hxe=!!Array.prototype.fill;function Mft(e,t){if(Hxe)return new Array(e).fill(t);const i=new Array(e);for(let r=0;r<e;r++)i[r]=t;return i}function qxe(e,t){t===void 0&&(t=e,e=0);const i=new Array(t-e);for(let r=e;r<t;r++)i[r-e]=r;return i}function Wxe(e,t,i){const r=e.length;let s=0,n=r-1;for(;s<n;){const a=s+Math.floor((n-s)/2);t>e[a]?s=a+1:n=a}const o=e[s];return i?t>=e[r-1]?-1:o===t?s:s-1:o===t?s:-1}function Pft(e){return e.reduce((t,i)=>t.concat(i||[]),[])}class _oe{constructor(){this.last=0}}const boe=new _oe;function woe(e,t,i,r){r=r||boe;const s=Math.max(0,r.last-10);for(let o=s;o<i;++o)if(e[o]===t)return r.last=o,o;const n=Math.min(s,i);for(let o=0;o<n;++o)if(e[o]===t)return r.last=o,o;return-1}function SN(e,t,i,r){const s=i==null?e.length:i,n=woe(e,t,s,r);if(n!==-1)return e[n]=e[s-1],i==null&&e.pop(),t}const Hu=new Set;function Xxe(e,t,i=e.length,r=t.length,s,n){if(r===0||i===0)return i;Hu.clear();for(let a=0;a<r;++a)Hu.add(t[a]);s=s||boe;const o=Math.max(0,s.last-10);for(let a=o;a<i;++a)if(Hu.has(e[a])&&(n&&n.push(e[a]),Hu.delete(e[a]),e[a]=e[i-1],--i,--a,Hu.size===0||i===0))return Hu.clear(),i;for(let a=0;a<o;++a)if(Hu.has(e[a])&&(n&&n.push(e[a]),Hu.delete(e[a]),e[a]=e[i-1],--i,--a,Hu.size===0||i===0))return Hu.clear(),i;return Hu.clear(),i}function Yxe(e){return e?(VX.seed=e,()=>VX.getFloat()):Math.random}function Ift(e,t){const i=Yxe(t);for(let r=e.length-1;r>0;r--){const s=Math.floor(i()*(r+1)),n=e[r];e[r]=e[s],e[s]=n}return e}const VX=new fu;function g7(e,t){const i=e.indexOf(t);return i!==-1?(e.splice(i,1),t):null}function Zxe(e,t){if(e.forEach)e.forEach(t);else for(let i=0;i<e.length;i++)t(e[i],i,e)}function y7(e,t,i){if(e.slice)return e.slice(t,i);t===void 0?t=0:(t<0&&(t+=e.length),t=Math.min(e.length,Math.max(0,t))),i===void 0?i=e.length:(i<0&&(i+=e.length),i=Math.min(e.length,Math.max(0,i)));const r=Math.max(0,i-t),s=new e.constructor(r);for(let n=0;n<r;n++)s[n]=e[t+n];return s}function c2(e){return e instanceof ArrayBuffer||e&&e.constructor&&e.constructor.name==="ArrayBuffer"}function Qxe(e){return e instanceof Int8Array||e&&e.constructor&&e.constructor.name==="Int8Array"}function E_(e){return e instanceof Uint8Array||e&&e.constructor&&e.constructor.name==="Uint8Array"}function Jxe(e){return e instanceof Uint8ClampedArray||e&&e.constructor&&e.constructor.name==="Uint8ClampedArray"}function Kxe(e){return e instanceof Int16Array||e&&e.constructor&&e.constructor.name==="Int16Array"}function rD(e){return e instanceof Uint16Array||e&&e.constructor&&e.constructor.name==="Uint16Array"}function eTe(e){return e instanceof Int32Array||e&&e.constructor&&e.constructor.name==="Int32Array"}function sD(e){return e instanceof Uint32Array||e&&e.constructor&&e.constructor.name==="Uint32Array"}function xoe(e){return e instanceof Float32Array||e&&e.constructor&&e.constructor.name==="Float32Array"}function Toe(e){return e instanceof Float64Array||e&&e.constructor&&e.constructor.name==="Float64Array"}function tTe(e){const t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=e[i];return t}function nM(e){return R(e)?0:128+e.buffer.byteLength+64}function Soe(e,t){let i;if(t)for(i in e)e.hasOwnProperty(i)&&(e[i]===void 0?delete e[i]:e[i]instanceof Object&&Soe(e[i],!0));else for(i in e)e.hasOwnProperty(i)&&e[i]===void 0&&delete e[i];return e}function se(e){if(!e||typeof e!="object"||typeof e=="function")return e;const t=Roe(e);if(_(t))return t;if(Eoe(e))return e.clone();if(Aoe(e))return e.map(se);if(Coe(e))return e.clone();const i={};for(const r of Object.getOwnPropertyNames(e))i[r]=se(e[r]);return i}function i6(e){if(!e||typeof e!="object"||typeof e=="function")return e;const t=Roe(e);if(_(t))return t;if(Aoe(e)){let i=!0;const r=e.map(s=>{const n=i6(s);return s!=null&&n==null&&(i=!1),n});return i?r:null}if(Eoe(e))return e.clone();if(!Coe(e)){const i=new(Object.getPrototypeOf(e)).constructor;for(const r of Object.getOwnPropertyNames(e)){const s=e[r],n=i6(s);if(s!=null&&n==null)return null;i[r]=n}return i}return null}function Eoe(e){return typeof e.clone=="function"}function Aoe(e){return typeof e.map=="function"&&typeof e.forEach=="function"}function Coe(e){return typeof e.notifyChange=="function"&&typeof e.watch=="function"}function Roe(e){if(Qxe(e)||E_(e)||Jxe(e)||Kxe(e)||rD(e)||eTe(e)||sD(e)||xoe(e)||Toe(e))return y7(e);if(e instanceof Date)return new Date(e.getTime());if(e instanceof ArrayBuffer)return e.slice(0,e.byteLength);if(e instanceof Map){const t=new Map;return e.forEach((i,r)=>{t.set(r,se(i))}),t}if(e instanceof Set){const t=new Set;return e.forEach(i=>{t.add(se(i))}),t}return null}function EN(e,t){return e===t||typeof e=="number"&&isNaN(e)&&typeof t=="number"&&isNaN(t)||typeof(e||{}).getTime=="function"&&typeof(t||{}).getTime=="function"&&e.getTime()===t.getTime()||!1}function Ooe(e,t,i=!1){return Poe(e,t,i)}function MS(e,t){if(t!=null)return t[e]||Moe(e.split("."),!1,t)}function yc(e,t,i){const r=e.split("."),s=r.pop(),n=Moe(r,!0,i);n&&s&&(n[s]=t)}function Moe(e,t,i){let r=i;for(const s of e){if(r==null)return;if(!(s in r)){if(!t)return;r[s]={}}r=r[s]}return r}function Poe(e,t,i){return t?Object.keys(t).reduce(function(r,s){let n=r[s],o=t[s];return n===o?r:n===void 0?(r[s]=se(o),r):(Array.isArray(o)||Array.isArray(r)?(n=n?Array.isArray(n)?r[s]=n.concat():r[s]=[n]:r[s]=[],o&&(Array.isArray(o)||(o=[o]),i?o.forEach(a=>{n.indexOf(a)===-1&&n.push(a)}):r[s]=o.concat())):o&&typeof o=="object"?r[s]=Poe(n,o,i):r.hasOwnProperty(s)&&!t.hasOwnProperty(s)||(r[s]=o),r)},e||{}):e}var GX;const Bi={apiKey:void 0,applicationUrl:(GX=globalThis.location)==null?void 0:GX.href,assetsPath:"",fontsUrl:"https://static.arcgis.com/fonts",geometryServiceUrl:"https://utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",geoRSSServiceUrl:"https://utility.arcgis.com/sharing/rss",kmlServiceUrl:"https://utility.arcgis.com/sharing/kml",portalUrl:"https://www.arcgis.com",routeServiceUrl:"https://route-api.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World",workers:{loaderConfig:{has:{},paths:{},map:{},packages:[]}},request:{httpsDomains:["arcgis.com","arcgisonline.com","esrikr.com","premiumservices.blackbridge.com","esripremium.accuweather.com","gbm.digitalglobe.com","firstlook.digitalglobe.com","msi.digitalglobe.com"],interceptors:[],maxUrlLength:2e3,proxyRules:[],proxyUrl:null,timeout:6e4,trustedServers:[],useIdentity:!0},log:{interceptors:[],level:null}};if(globalThis.esriConfig&&(Ooe(Bi,globalThis.esriConfig,!0),delete Bi.has),!Bi.assetsPath){const e="4.23.7";Bi.assetsPath=`https://js.arcgis.com/${e.slice(0,-2)}/@arcgis/core/assets`}Bi.baseUrl&&console.warn("[esri.config]","baseUrl has been replaced by assetsPath"),Object.defineProperty(Bi,"baseUrl",{set(){console.warn("[esri.config]","baseUrl has been replaced by assetsPath")}}),Bi.request.corsEnabledServers=[],Bi.request.corsEnabledServers.push=function(){return console.warn("[esri.config]","request.corsEnabledServers is not supported and will be removed in a future release. See http://esriurl.com/cors8664"),0};const iTe=/\{([^\}]+)\}/g;function jX(e){return e==null?"":e}function _p(e,t){return e.replace(iTe,typeof t=="object"?(i,r)=>jX(MS(r,t)):(i,r)=>jX(t(r)))}function Ioe(e,t){return e.replace(/([\.$?*|{}\(\)\[\]\\\/\+\-^])/g,i=>t&&t.indexOf(i)!==-1?i:`\\${i}`)}function v7(e){let t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return t}function $ft(e){return new DOMParser().parseFromString(e||"","text/html").body.innerText||""}const HX={info:0,warn:1,error:2,none:3};class he{constructor(t){this.level=null,this._module="",this._parent=null,this.writer=null,this._loggedMessages={error:new Map,warn:new Map,info:new Map},t.level!=null&&(this.level=t.level),t.writer!=null&&(this.writer=t.writer),this._module=t.module,he._loggers[this.module]=this;const i=this.module.lastIndexOf(".");i!==-1&&(this._parent=he.getLogger(this.module.slice(0,i)))}get module(){return this._module}get parent(){return this._parent}error(...t){this._log("error","always",...t)}warn(...t){this._log("warn","always",...t)}info(...t){this._log("info","always",...t)}errorOnce(...t){this._log("error","once",...t)}warnOnce(...t){this._log("warn","once",...t)}infoOnce(...t){this._log("info","once",...t)}errorOncePerTick(...t){this._log("error","oncePerTick",...t)}warnOncePerTick(...t){this._log("warn","oncePerTick",...t)}infoOncePerTick(...t){this._log("info","oncePerTick",...t)}get test(){const t=this;return{loggedMessages:t._loggedMessages,clearLoggedWarnings:()=>t._loggedMessages.warn.clear()}}static get testSingleton(){return{resetLoggers(t={}){const i=he._loggers;return he._loggers=t,i},set throttlingDisabled(t){he._throttlingDisabled=t}}}static getLogger(t){let i=he._loggers[t];return i||(i=new he({module:t})),i}_log(t,i,...r){if(!!this._matchLevel(t)){if(i!=="always"&&!he._throttlingDisabled){const s=this._argsToKey(r),n=this._loggedMessages[t].get(s);if(i==="once"&&n!=null||i==="oncePerTick"&&n&&n>=he._tickCounter)return;this._loggedMessages[t].set(s,he._tickCounter),he._scheduleTickCounterIncrement()}for(const s of Bi.log.interceptors)if(s(t,this.module,...r))return;this._inheritedWriter()(t,this.module,...r)}}_parentWithMember(t,i){let r=this;for(;_(r);){const s=r[t];if(_(s))return s;r=r.parent}return i}_inheritedWriter(){return this._parentWithMember("writer",this._consoleWriter)}_consoleWriter(t,i,...r){console[t](`[${i}]`,...r)}_matchLevel(t){const i=Bi.log.level?Bi.log.level:"warn";return HX[this._parentWithMember("level",i)]<=HX[t]}_argsToKey(...t){const i=(r,s)=>typeof s!="object"||Array.isArray(s)?s:"[Object]";return v7(JSON.stringify(t,i))}static _scheduleTickCounterIncrement(){he._tickCounterScheduled||(he._tickCounterScheduled=!0,Promise.resolve().then(()=>{he._tickCounter++,he._tickCounterScheduled=!1}))}}he._loggers={},he._tickCounter=0,he._tickCounterScheduled=!1,he._throttlingDisabled=!1;function qr(e,t){for(const[i,r]of e)if(t(r,i))return!0;return!1}function Dft(e,t){for(const[i,r]of e)if(t(r,i))return r;return null}function $oe(e,t,i){const r=e.get(t);if(r!==void 0)return r;const s=i();return e.set(t,s),s}const Wx=he.getLogger("esri.core.Accessor");function rTe(e){return e==null?e:new Date(e)}function sTe(e){return e==null?e:!!e}function KR(e){return e==null?e:e.toString()}function mu(e){return e==null?e:(e=parseFloat(e),isNaN(e)?0:e)}function _7(e){return e==null?e:Math.round(parseFloat(e))}function Doe(e){return e&&e.constructor&&e.constructor.__accessorMetadata__!==void 0}function nD(e,t){return t!=null&&e&&!(t instanceof e)}function Loe(e){return e&&"isCollection"in e}function qX(e){return e&&e.Type?typeof e.Type=="function"?e.Type:e.Type.base:null}function nTe(e,t){if(!t||!t.constructor||!Loe(t.constructor))return r6(e,t)?t:new e(t);const i=qX(e.prototype.itemType),r=qX(t.constructor.prototype.itemType);return i?r?i===r?t:i.prototype.isPrototypeOf(r.prototype)?new e(t):(r6(e,t),t):new e(t):t}function r6(e,t){return!!Doe(t)&&(Wx.error("Accessor#set","Assigning an instance of '"+(t.declaredClass||"unknown")+"' which is not a subclass of '"+AN(e)+"'"),!0)}function ST(e,t){return t==null?t:Loe(e)?nTe(e,t):nD(e,t)?r6(e,t)?t:new e(t):t}function AN(e){return e&&e.prototype&&e.prototype.declaredClass||"unknown"}const oTe=new WeakMap;function aTe(e){switch(e){case Number:return mu;case ir:return _7;case Boolean:return sTe;case String:return KR;case Date:return rTe;default:return $oe(oTe,e,()=>ST.bind(null,e))}}function Ir(e,t){const i=aTe(e);return arguments.length===1?i:i(t)}function IC(e,t,i){return arguments.length===1?IC.bind(null,e):t&&(Array.isArray(t)?t.map(r=>e(r,i)):[e(t,i)])}function lTe(e,t){return arguments.length===1?IC(Ir.bind(null,e)):IC(Ir.bind(null,e),t)}function Noe(e,t,i){return t!==0&&Array.isArray(i)?i.map(r=>Noe(e,t-1,r)):e(i)}function oD(e,t,i){if(arguments.length===2)return oD.bind(null,e,t);if(!i)return i;let r=t,s=i=Noe(e,t,i);for(;r>0&&Array.isArray(s);)r--,s=s[0];if(s!==void 0)for(let n=0;n<r;n++)i=[i];return i}function cTe(e,t,i){return arguments.length===2?oD(Ir.bind(null,e),t):oD(Ir.bind(null,e),t,i)}function Foe(e){return!!Array.isArray(e)&&!e.some(t=>{const i=typeof t;return!(i==="string"||i==="number"||i==="function"&&e.length>1)})}function s6(e,t){if(arguments.length===2)return s6(e).call(null,t);const i=new Set,r=e.filter(a=>typeof a!="function"),s=e.filter(a=>typeof a=="function");for(const a of e)typeof a!="string"&&typeof a!="number"||i.add(a);let n=null,o=null;return(a,l)=>{if(a==null)return a;const c=typeof a,h=c==="string"||c==="number";return h&&(i.has(a)||s.some(p=>c==="string"&&p===String||c==="number"&&p===Number))||c==="object"&&s.some(p=>!nD(a,p))?a:(h&&r.length?(n||(n=r.map(p=>typeof p=="string"?`'${p}'`:`${p}`).join(", ")),Wx.error("Accessor#set",`'${a}' is not a valid value for this property, only the following values are valid: ${n}`)):typeof a=="object"&&s.length?(o||(o=s.map(p=>AN(p)).join(", ")),Wx.error("Accessor#set",`'${a}' is not a valid value for this property, value must be one of ${o}`)):Wx.error("Accessor#set",`'${a}' is not a valid value for this property`),l&&(l.valid=!1),null)}}function Zh(e,t){if(arguments.length===2)return Zh(e).call(null,t);const i={},r=[],s=[];for(const l in e.typeMap){const c=e.typeMap[l];i[l]=Ir(c),r.push(AN(c)),s.push(l)}const n=()=>`'${r.join("', '")}'`,o=()=>`'${s.join("', '")}'`,a=typeof e.key=="string"?l=>l[e.key]:e.key;return l=>{if(e.base&&!nD(e.base,l)||l==null)return l;const c=a(l)||e.defaultKeyValue,h=i[c];if(!h)return Wx.error("Accessor#set",`Invalid property value, value needs to be one of ${n()}, or a plain object that can autocast (having .type = ${o()})`),null;if(!nD(e.typeMap[c],l))return l;if(typeof e.key=="string"&&!Doe(l)){const p={};for(const f in l)f!==e.key&&(p[f]=l[f]);return h(p)}return h(l)}}class ir{}const Lft={native:e=>({type:"native",value:e}),array:e=>({type:"array",value:e}),oneOf:e=>({type:"one-of",values:e})};function uTe(e){if(!e||!("type"in e))return!1;switch(e.type){case"native":case"array":case"one-of":return!0}return!1}function Uoe(e){switch(e.type){case"native":return Ir(e.value);case"array":return IC(Uoe(e.value));case"one-of":return hTe(e);default:return null}}function hTe(e){let t=null;return(i,r)=>o6(i,e)?i:(t==null&&(t=n6(e)),Wx.error("Accessor#set",`Invalid property value, value needs to be of type ${t}`),r&&(r.valid=!1),null)}function n6(e){switch(e.type){case"native":switch(e.value){case Number:return"number";case String:return"string";case Boolean:return"boolean";case ir:return"integer";case Date:return"date";default:return AN(e.value)}case"array":return`array of ${n6(e.value)}`;case"one-of":{const t=e.values.map(i=>n6(i));return`one of ${t.slice(0,t.length-1)} or ${t[t.length-1]}`}}return"unknown"}function o6(e,t){if(e==null)return!0;switch(t.type){case"native":switch(t.value){case Number:case ir:return typeof e=="number";case Boolean:return typeof e=="boolean";case String:return typeof e=="string"}return e instanceof t.value;case"array":return!!Array.isArray(e)&&!e.some(i=>!o6(i,t.value));case"one-of":return t.values.some(i=>o6(e,i))}}function oM(e){return Be(_7(e),0,255)}function aM(e,t,i){return e=Number(e),isNaN(e)?i:e<t?t:e>i?i:e}class Ns{constructor(t){this.r=255,this.g=255,this.b=255,this.a=1,t&&this.setColor(t)}static blendColors(t,i,r,s=new Ns){return s.r=Math.round(t.r+(i.r-t.r)*r),s.g=Math.round(t.g+(i.g-t.g)*r),s.b=Math.round(t.b+(i.b-t.b)*r),s.a=t.a+(i.a-t.a)*r,s._sanitize()}static fromRgb(t,i){const r=t.toLowerCase().match(/^(rgba?|hsla?)\(([\s\.\-,%0-9]+)\)/);if(r){const s=r[2].split(/\s*,\s*/),n=r[1];if(n==="rgb"&&s.length===3||n==="rgba"&&s.length===4){const o=s[0];if(o.charAt(o.length-1)==="%"){const a=s.map(l=>2.56*parseFloat(l));return s.length===4&&(a[3]=parseFloat(s[3])),Ns.fromArray(a,i)}return Ns.fromArray(s.map(a=>parseFloat(a)),i)}if(n==="hsl"&&s.length===3||n==="hsla"&&s.length===4)return Ns.fromArray(ioe(parseFloat(s[0]),parseFloat(s[1])/100,parseFloat(s[2])/100,parseFloat(s[3])),i)}return null}static fromHex(t,i=new Ns){if(t.length!==4&&t.length!==7||t[0]!=="#")return null;const r=t.length===4?4:8,s=(1<<r)-1;let n=Number("0x"+t.substr(1));return isNaN(n)?null:(["b","g","r"].forEach(o=>{const a=n&s;n>>=r,i[o]=r===4?17*a:a}),i.a=1,i)}static fromArray(t,i=new Ns){return i._set(Number(t[0]),Number(t[1]),Number(t[2]),Number(t[3])),isNaN(i.a)&&(i.a=1),i._sanitize()}static fromString(t,i){const r=toe(t)?n7(t):null;return r&&Ns.fromArray(r,i)||Ns.fromRgb(t,i)||Ns.fromHex(t,i)}static fromJSON(t){return t&&new Ns([t[0],t[1],t[2],t[3]/255])}static toUnitRGB(t){return _(t)?[t.r/255,t.g/255,t.b/255]:null}static toUnitRGBA(t){return _(t)?[t.r/255,t.g/255,t.b/255,t.a!=null?t.a:1]:null}get isBright(){return .299*this.r+.587*this.g+.114*this.b>=127}setColor(t){if(typeof t=="string")Ns.fromString(t,this);else if(Array.isArray(t))Ns.fromArray(t,this);else{var i,r,s,n;this._set((i=t.r)!=null?i:0,(r=t.g)!=null?r:0,(s=t.b)!=null?s:0,(n=t.a)!=null?n:1),t instanceof Ns||this._sanitize()}return this}toRgb(){return[this.r,this.g,this.b]}toRgba(){return[this.r,this.g,this.b,this.a]}toHex(){const t=this.r.toString(16),i=this.g.toString(16),r=this.b.toString(16);return`#${t.length<2?"0"+t:t}${i.length<2?"0"+i:i}${r.length<2?"0"+r:r}`}toCss(t=!1){const i=this.r+", "+this.g+", "+this.b;return t?`rgba(${i}, ${this.a})`:`rgb(${i})`}toString(){return this.toCss(!0)}toJSON(){return this.toArray()}toArray(t=Ns.AlphaMode.ALWAYS){const i=oM(this.r),r=oM(this.g),s=oM(this.b);return t===Ns.AlphaMode.ALWAYS||this.a!==1?[i,r,s,oM(255*this.a)]:[i,r,s]}clone(){return new Ns(this.toRgba())}hash(){return this.r<<24|this.g<<16|this.b<<8|255*this.a}equals(t){return _(t)&&t.r===this.r&&t.g===this.g&&t.b===this.b&&t.a===this.a}_sanitize(){return this.r=Math.round(aM(this.r,0,255)),this.g=Math.round(aM(this.g,0,255)),this.b=Math.round(aM(this.b,0,255)),this.a=aM(this.a,0,1),this}_set(t,i,r,s){this.r=t,this.g=i,this.b=r,this.a=s}}Ns.prototype.declaredClass="esri.Color",function(e){var t;(t=e.AlphaMode||(e.AlphaMode={}))[t.ALWAYS=0]="ALWAYS",t[t.UNLESS_OPAQUE=1]="UNLESS_OPAQUE"}(Ns||(Ns={}));const Je=Ns;function CN(e){return e&&(typeof e.on=="function"||typeof e.addEventListener=="function")}function eO(e,t,i){if(!CN(e))throw new TypeError("target is not a Evented or EventTarget object");if("on"in e)return e.on(t,i);if(Array.isArray(t)){const r=t.slice();for(const s of r)e.addEventListener(s,i);return{remove(){for(const s of r)e.removeEventListener(s,i)}}}return e.addEventListener(t,i),{remove(){e.removeEventListener(t,i)}}}function koe(e,t,i){if(!CN(e))throw new TypeError("target is not a Evented or EventTarget object");if("once"in e)return e.once(t,i);const r=eO(e,t,s=>{r.remove(),i.call(e,s)});return{remove(){r.remove()}}}const dTe={Win:"Meta",Scroll:"ScrollLock",Spacebar:" ",Down:"ArrowDown",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Del:"Delete",Apps:"ContextMenu",Esc:"Escape",Multiply:"*",Add:"+",Subtract:"-",Decimal:".",Divide:"/"};function A_({key:e}){return dTe[e]||e}function ET(e){return km(()=>e.forEach(t=>_(t)&&t.remove()))}function km(e){return{remove:()=>{e&&(e(),e=void 0)}}}function pTe(e,t){const i=setTimeout(e,t);return km(()=>clearTimeout(i))}function fTe(e){return{setTimeout:(t,i)=>{const r=e.setTimeout(t,i);return{remove:()=>e.clearTimeout(r)}}}}const RN=fTe(globalThis);function mTe(e,t){return e.replace(/\$\{([^\s\:\}]*)(?:\:([^\s\:\}]+))?\}/g,function(i,r){if(r==="")return"$";const s=MS(r,t),n=s==null?"":s;if(n===void 0)throw new Error(`could not find key "${r}" in template`);return n.toString()})}class ON{constructor(t,i,r){this.name=t,this.details=r,this.message=void 0,this instanceof ON&&(this.message=i&&mTe(i,r)||"")}toString(){return"["+this.name+"]: "+this.message}}class q extends ON{constructor(t,i,r){if(super(t,i,r),!(this instanceof q))return new q(t,i,r)}toJSON(){if(this.details!=null)try{return{name:this.name,message:this.message,details:JSON.parse(JSON.stringify(this.details,(t,i)=>{if(i&&typeof i=="object"&&typeof i.toJSON=="function")return i;try{return se(i)}catch{return"[object]"}}))}}catch(t){throw he.getLogger("esri.core.Error").error(t),t}return{name:this.name,message:this.message,details:this.details}}static fromJSON(t){return new q(t.name,t.message,t.details)}}q.prototype.type="error";function $C(e){return Promise.all(e)}function b7(e){return new Promise((t,i)=>{try{e(t,i)}catch(r){Promise.resolve().then(()=>i(r))}})}function pi(e="Aborted"){return new q("AbortError",e)}function Qt(e,t="Aborted"){if(Us(e))throw pi(t)}function MN(e){return _(e)?"aborted"in e?e:e.signal:e}function Us(e){const t=MN(e);return _(t)&&t.aborted}function zm(e){if(pr(e))throw e}function a6(e){if(!pr(e))throw e}function go(e,t){const i=MN(e);if(!R(i)){if(!i.aborted)return koe(i,"abort",()=>t());t()}}function tO(e,t){const i=MN(e);if(!R(i))return Qt(i),koe(i,"abort",()=>t(pi()))}function zoe(e,t){const i=MN(t);return R(i)?e:new Promise((r,s)=>{let n=go(t,()=>s(pi()));const o=()=>n=Js(n);e.then(o,o),e.then(r,s)})}function pr(e){return e&&e.name==="AbortError"}function l6(e){return e.catch(t=>{if(!pr(t))throw t})}function Nft(e,t=he.getLogger("esri")){return e.catch(i=>{pr(i)||t.error(i)})}function f0(){let e=null;const t=new Promise((i,r)=>{e={promise:void 0,resolve:i,reject:r}});return e.promise=t,e}function Ks(e){if(!e)return;if(typeof e.forEach!="function"){const i=Object.keys(e);return Ks(i.map(r=>e[r])).then(r=>{const s={};return i.forEach((n,o)=>s[n]=r[o]),s})}const t=e;return b7(i=>{const r=[];let s=t.length;s===0&&i(r),t.forEach(n=>{const o={promise:n||Promise.resolve(n)};r.push(o),o.promise.then(a=>{o.value=a}).catch(a=>{o.error=a}).then(()=>{--s,s===0&&i(r)})})})}function gTe(e){return Ks(e).then(t=>t.filter(i=>!!i.value).map(i=>i.value))}function WX(e){return Promise.reject(e)}function xx(e){return Promise.resolve(e)}function AT(e,t,i){const r=new AbortController;return go(i,()=>r.abort()),new Promise((s,n)=>{let o=setTimeout(()=>{o=0,s(t)},e);go(r,()=>{o&&(clearTimeout(o),n(pi()))})})}function Cc(e){return e&&typeof e.then=="function"}function c6(e){return Cc(e)?e:Promise.resolve(e)}function w7(e,t=-1){let i,r,s,n,o=null;const a=(...l)=>{if(i){r=l,n&&n.reject(pi()),n=f0();const f=n.promise;if(o){const g=o;o=null,g.abort()}return f}if(s=n||f0(),n=null,t>0){const f=new AbortController;i=c6(e(...l,f.signal));const g=i;AT(t).then(()=>{i===g&&(n?f.abort():o=f)})}else i=1,i=c6(e(...l));const c=()=>{const f=r;r=s=i=o=null,f!=null&&a(...f)},h=i,p=s;return h.then(c,c),h.then(p.resolve,p.reject),p.promise};return a}function Sm(){let e,t;const i=new Promise((s,n)=>{e=s,t=n}),r=s=>{e(s)};return r.resolve=s=>e(s),r.reject=s=>t(s),r.timeout=(s,n)=>RN.setTimeout(()=>r.reject(n),s),r.promise=i,r}function Fft(e,t){return e.then(t,t)}function iO(e,t){let i,r=new AbortController;const s=e(r.signal);let n={promise:s,finished:!1,abort:()=>{r&&(r.abort(),r=null)}};const o=()=>{n&&(n.finished=!0,n=null),_(i)&&(i.remove(),i=null),r=null};return s.then(o,o),i=go(t,()=>{_(n)&&n.abort()}),n}function Uft(e){return Promise.resolve().then(()=>{Qt(e)})}function yTe(e){return e&&e.release&&typeof e.release=="function"}function vTe(e){return e&&e.acquire&&typeof e.acquire=="function"}class Wr{constructor(t,i,r,s=1,n=0){if(this.ctor=t,this.acquireFunction=i,this.releaseFunction=r,this.allocationSize=s,this._pool=new Array(n),this._initialSize=n,this.ctor)for(let o=0;o<n;o++)this._pool[o]=new this.ctor;this.allocationSize=Math.max(s,1)}destroy(){this.prune(0)}acquire(...t){let i;if(Wr.test.disabled)i=new this.ctor;else{if(this._pool.length===0){const r=this.allocationSize;for(let s=0;s<r;s++)this._pool[s]=new this.ctor}i=this._pool.pop()}return this.acquireFunction?this.acquireFunction(i,...t):vTe(i)&&i.acquire(...t),i}release(t){t&&!Wr.test.disabled&&(this.releaseFunction?this.releaseFunction(t):yTe(t)&&t.release(),this._pool.push(t))}prune(t=this._initialSize){if(!(t>=this._pool.length)){for(let i=t;i<this._pool.length;++i){const r=this._pool[i];this._dispose(r)}this._pool.length=t}}_dispose(t){t.dispose&&typeof t.dispose=="function"&&t.dispose()}}Wr.test={disabled:!1};function _Te(e){e.length=0}class il{constructor(t=50,i=50){this._pool=new Wr(Array,void 0,_Te,i,t)}acquire(){return this._pool.acquire()}release(t){this._pool.release(t)}prune(){this._pool.prune(0)}static acquire(){return d5.acquire()}static release(t){return d5.release(t)}static prune(){d5.prune()}}const d5=new il(100);class Boe extends Wr{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=Vxe(this._set)}acquire(...t){const i=super.acquire(...t);return this._set.delete(i),i}release(t){t&&!this._set.has(t)&&(super.release(t),this._set.add(t))}_dispose(t){this._set.delete(t),super._dispose(t)}}const lM=[];function CT(e){lM.push(e),lM.length===1&&queueMicrotask(()=>{const t=lM.slice();lM.length=0;for(const i of t)i()})}const bTe=29;class r0{constructor(t,i=bTe){this.name=t,this._counter=0,this._items=new Array(i)}record(t){this._items[++this._counter%this._items.length]=t}get median(){return this._items.slice().sort((t,i)=>t-i)[Math.floor(this._items.length/2)]}get average(){return this._items.reduce((t,i)=>t+i,0)/this._items.length}get last(){return this._items[this._counter%this._items.length]}}var u6;(function(e){const t=(n,o,a,l)=>{let c=o,h=o;const p=a>>>1,f=n[c-1];for(;h<=p;){h=c<<1,h<a&&l(n[h-1],n[h])<0&&++h;const g=n[h-1];if(l(g,f)<=0)break;n[c-1]=g,c=h}n[c-1]=f},i=(n,o)=>n<o?-1:n>o?1:0;function r(n,o,a,l){o===void 0&&(o=0),a===void 0&&(a=n.length),l===void 0&&(l=i);for(let h=a>>>1;h>o;h--)t(n,h,a,l);const c=o+1;for(let h=a-1;h>o;h--){const p=n[o];n[o]=n[h],n[h]=p,t(n,c,h,l)}}function*s(n,o,a,l){o===void 0&&(o=0),a===void 0&&(a=n.length),l===void 0&&(l=i);for(let h=a>>>1;h>o;h--)t(n,h,a,l),yield;const c=o+1;for(let h=a-1;h>o;h--){const p=n[o];n[o]=n[h],n[h]=p,t(n,c,h,l),yield}}e.sort=r,e.iterableSort=s})(u6||(u6={}));const XX=u6,wTe=1.5,xTe=1.1;class $t{constructor(t){this.data=[],this._length=0,this._allocator=void 0,this._deallocator=()=>null,this._shrink=()=>{},this._hint=new _oe,t&&(t.initialSize&&(this.data=new Array(t.initialSize)),t.allocator&&(this._allocator=t.allocator),t.deallocator!==void 0&&(this._deallocator=t.deallocator),t.shrink&&(this._shrink=()=>YX(this)))}toArray(){return this.data.slice(0,this.length)}filter(t){const i=new Array;for(let r=0;r<this._length;r++){const s=this.data[r];t(s)&&i.push(s)}return i}getItemAt(t){if(!(t<0||t>=this._length))return this.data[t]}get length(){return this._length}set length(t){if(t>this._length){if(this._allocator){for(;this._length<t;)this.data[this._length++]=this._allocator(this.data[this._length]);return}this._length=t}else{if(this._deallocator)for(let i=t;i<this._length;++i)this.data[i]=this._deallocator(this.data[i]);this._length=t,this._shrink()}}clear(){this.length=0}prune(){this.clear(),this.data=[]}push(t){this.data[this._length++]=t}pushArray(t,i=t.length){for(let r=0;r<i;r++)this.data[this._length++]=t[r]}fill(t,i){for(let r=0;r<i;r++)this.data[this._length++]=t}pushNew(){this._allocator&&(this.data[this.length]=this._allocator(this.data[this.length]));const t=this.data[this._length];return++this._length,t}unshift(t){this.data.unshift(t),this._length++,YX(this)}pop(){if(this.length===0)return;const t=this.data[this.length-1];return this.length=this.length-1,this._shrink(),t}remove(t){const i=woe(this.data,t,this.length,this._hint);if(i!==-1)return this.data.splice(i,1),this.length=this.length-1,t}removeUnordered(t){const i=SN(this.data,t,this.length,this._hint);return i!==void 0&&(this.length=this.length-1),this._shrink(),i}removeUnorderedIndex(t){if(!(t>=this.length||t<0))return this.swapElements(t,this.length-1),this.pop()}removeUnorderedMany(t,i=t.length,r){this.length=Xxe(this.data,t,this.length,i,this._hint,r),this._shrink()}front(){if(this.length!==0)return this.data[0]}back(){if(this.length!==0)return this.data[this.length-1]}swapElements(t,i){t>=this.length||i>=this.length||t===i||([this.data[t],this.data[i]]=[this.data[i],this.data[t]])}sort(t){XX.sort(this.data,0,this.length,t)}iterableSort(t){return XX.iterableSort(this.data,0,this.length,t)}some(t,i){for(let r=0;r<this.length;++r)if(t.call(i,this.data[r],r,this.data))return!0;return!1}filterInPlace(t,i){let r=0;for(let s=0;s<this._length;++s){const n=this.data[s];t.call(i,n,s,this.data)&&(this.data[s]=this.data[r],this.data[r]=n,r++)}if(this._deallocator)for(let s=r;s<this._length;s++)this.data[s]=this._deallocator(this.data[s]);return this._length=r,this._shrink(),this}forAll(t,i){const r=this.length,s=this.data;for(let n=0;n<r;++n)t.call(i,s[n],n,s)}forEach(t,i){for(let r=0;r<this.length;++r)t.call(i,this.data[r],r,this.data)}map(t,i){const r=new Array(this.length);for(let s=0;s<this.length;++s)r[s]=t.call(i,this.data[s],s,this.data);return r}reduce(t,i){let r=i;for(let s=0;s<this.length;++s)r=t(r,this.data[s],s,this.data);return r}has(t){const i=this.length,r=this.data;for(let s=0;s<i;++s)if(r[s]===t)return!0;return!1}}function YX(e){e.data.length>wTe*e.length&&(e.data.length=Math.floor(e.length*xTe))}function Voe(e){return 1e3*e}function Goe(e){return .001*e}class TTe{constructor(t){this.phases=t,this.paused=!1,this.ticks=-1,this.removed=!1}}class STe{constructor(t){this.callback=t,this.isActive=!0}remove(){this.isActive=!1}}let h6=0,d6=0;const u2={time:0,deltaTime:0,elapsedFrameTime:0,frameDuration:0},p6=["prepare","preRender","render","postRender","update","finish"],f6=[],v1=new $t;class ETe{constructor(t){this._task=t}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1}}const aD={frameTasks:v1,willDispatch:!1,clearFrameTasks:ATe,dispatch:qoe,executeFrameTasks:RTe};function rO(e){const t=new STe(e);return f6.push(t),aD.willDispatch||(aD.willDispatch=!0,CT(qoe)),t}function _1(e){const t=new TTe(e);return v1.push(t),lD==null&&(h6=performance.now(),lD=requestAnimationFrame(joe)),new ETe(t)}let lD=null;function ATe(e=!1){v1.forAll(t=>{t.removed=!0}),e&&Hoe()}function CTe(e){d6=Math.max(0,e)}function joe(){const e=performance.now();lD=null,lD=v1.length>0?requestAnimationFrame(joe):null,aD.executeFrameTasks(e)}function RTe(e){const t=e-h6;h6=e;const i=d6>0?d6:1e3/60,r=Math.max(0,t-i);for(let s=0;s<p6.length;s++){const n=performance.now(),o=p6[s];v1.forAll(a=>{var l;a.paused||a.removed||(s===0&&a.ticks++,a.phases[o]&&(u2.time=e,u2.deltaTime=a.ticks===0?0:t,u2.elapsedFrameTime=performance.now()-e,u2.frameDuration=i-r,(l=a.phases[o])==null||l.call(a,u2)))}),OTe[s].record(performance.now()-n)}Hoe(),MTe.record(performance.now()-e)}const cM=new $t;function Hoe(){v1.forAll(e=>{e.removed&&cM.push(e)}),v1.removeUnorderedMany(cM.data,cM.length),cM.clear()}function qoe(){for(;f6.length;){const e=f6.shift();e.isActive&&e.callback()}aD.willDispatch=!1}function kft(e=1,t){const i=Sm(),r=()=>{Us(t)?i.reject(pi()):e===0?i():(--e,CT(()=>r()))};return r(),i.promise}const OTe=p6.map(e=>new r0(e)),MTe=new r0("total");function Woe(e,t){for(const i of e.entries())if(t(i[0]))return!0;return!1}let PTe=0;const ITe=0;function Ta(){return++PTe}function Ra(e){return e?e.__accessor__?e.__accessor__:e.propertyInvalidated?e:null:null}function $Te(e,t){return e!=null&&e.metadatas&&e.metadatas[t]!=null}function JP(e,t,i){return i?cD(e,t,{policy:i,path:""}):cD(e,t,null)}function cD(e,t,i){return t?Object.keys(t).reduce(function(r,s){let n=null,o="merge";if(i&&(n=i.path?`${i.path}.${s}`:s,o=i.policy(n)),o==="replace")return r[s]=t[s],r;if(r[s]===void 0)return r[s]=se(t[s]),r;let a=r[s],l=t[s];if(a===l)return r;if(Array.isArray(l)||Array.isArray(r))a=a?Array.isArray(a)?r[s]=a.concat():r[s]=[a]:r[s]=[],l&&(Array.isArray(l)||(l=[l]),l.forEach(c=>{a.indexOf(c)===-1&&a.push(c)}));else if(l&&typeof l=="object")if(i){const c=i.path;i.path=n,r[s]=cD(a,l,i),i.path=c}else r[s]=cD(a,l,null);else r.hasOwnProperty(s)&&!t.hasOwnProperty(s)||(r[s]=l);return r},e||{}):e}function Xoe(e){return Array.isArray(e)?e:e.split(".")}function ZX(e){return e.indexOf(",")>-1?e.split(",").map(t=>t.trim()):[e.trim()]}function DTe(e){if(Array.isArray(e)){const t=[];for(const i of e)t.push(...ZX(i));return t}return ZX(e)}function Yoe(e,t,i,r){const s=DTe(t);if(s.length!==1){const n=s.map(o=>r(e,o,i));return ET(n)}return r(e,s[0],i)}function x7(e){let t=!1;return()=>{t||(t=!0,e())}}function Zoe(e,t){const i=e[e.length-1]==="?"?e.slice(0,-1):e;if(t.getItemAt!=null||Array.isArray(t)){const s=parseInt(i,10);if(!isNaN(s))return Array.isArray(t)?t[s]:t.getItemAt(s)}const r=Ra(t);return $Te(r,i)?r.get(i):t[i]}function Qoe(e,t,i){if(e==null)return e;const r=Zoe(t[i],e);return!r&&i<t.length-1?void 0:i===t.length-1?r:Qoe(r,t,i+1)}function sO(e,t,i=0){return typeof t=="string"&&t.indexOf(".")===-1?Zoe(t,e):Qoe(e,Xoe(t),i)}function uD(e,t){return sO(e,t)}function QX(e,t){return sO(t,e)!==void 0}var er;(function(e){e[e.Dirty=1]="Dirty",e[e.Overriden=2]="Overriden",e[e.Computing=4]="Computing",e[e.NonNullable=8]="NonNullable",e[e.HasDefaultValue=16]="HasDefaultValue",e[e.DepTrackingInitialized=32]="DepTrackingInitialized",e[e.AutoTracked=64]="AutoTracked",e[e.ExplicitlyTracking=128]="ExplicitlyTracking"})(er||(er={}));let hD,TE=[];const LTe=he.getLogger("esri.core.Accessor");function Vt(e){hD!==void 0&&hD.onObservableAccessed(e)}let KP=!1,eI=!1;function Em(e,t,i){if(KP)return T7(e,t,i);Joe(e);const r=t.call(i);return Koe(),r}function NTe(e,t){return Em(void 0,e,t)}function T7(e,t,i){const r=KP;KP=!0,Joe(e);let s=null;try{s=t.call(i)}catch(n){eI&&LTe.error(n)}return Koe(),KP=r,s}function Joe(e){hD=e,TE.push(e)}function Koe(){const e=TE.pop();hD=TE.length>0?TE[TE.length-1]:void 0,e!==void 0&&e.onTrackingEnd()}function eae(e,t){if(t.flags&er.DepTrackingInitialized)return;const i=eI;eI=!1,t.flags&er.AutoTracked?T7(t,t.metadata.get,e):tae(e,t),eI=i}const FTe=[];function tae(e,t){t.flags&er.ExplicitlyTracking||(t.flags|=er.ExplicitlyTracking,T7(t,()=>{const i=t.metadata.dependsOn||FTe;for(const r of i)if(typeof r=="string"&&r.indexOf(".")===-1)JX(e,r,!1);else{const s=Xoe(r);for(let n=0,o=e;n<s.length&&o!=null&&typeof o=="object";++n)o=JX(o,s[n],n!==s.length-1)}}),t.flags&=~er.ExplicitlyTracking)}function JX(e,t,i){const r=t[t.length-1]==="?"?t.slice(0,-1):t;if(e.getItemAt!=null||Array.isArray(e)){const o=parseInt(r,10);if(!isNaN(o))return Array.isArray(e)?e[o]:e.getItemAt(o)}const s=Ra(e),n=s==null?void 0:s.properties.get(r);return n&&(Vt(n),eae(e,n)),i?e[r]:void 0}class PN{constructor(t){this._notify=t,this._accessed=[],this._handles=[],this._invalidCount=0}destroy(){this._accessed.length=0,this.clear()}onInvalidated(){this._invalidCount++}onCommitted(){const t=this._invalidCount;if(t===1)return this._invalidCount=0,void this._notify();this._invalidCount=t>0?t-1:0}onObservableAccessed(t){this._accessed.includes(t)||this._accessed.push(t)}onTrackingEnd(){const t=this._handles,i=this._accessed;for(let r=0;r<i.length;++r)t.push(i[r].observe(this));i.length=0}clear(){const t=this._handles;for(let i=0;i<t.length;++i)t[i].remove();t.length=0}}let Xx=!1;const dD=[];function iae(e,t){let i=new PN(n),r=null,s=!1;function n(){if(!i||s)return;if(Xx)return void nae(n);const a=r;i.clear(),Xx=!0,s=!0,r=Em(i,e),s=!1,Xx=!1,t(r,a),oae()}function o(){i&&(i.destroy(),i=null,r=null)}return s=!0,r=Em(i,e),s=!1,{remove:o}}function rae(e,t){let i=new PN(s),r=null;function s(){t(r,o)}function n(){i&&(i.destroy(),i=null),r=null}function o(){return i?(i.clear(),r=Em(i,e),r):null}return o(),{remove:n}}function sae(e){let t=new PN(r),i=!1;function r(){t&&!i&&(Xx?nae(r):(t.clear(),Xx=!0,i=!0,Em(t,e),i=!1,Xx=!1,oae()))}function s(){t&&(t.destroy(),t=null)}return i=!0,Em(t,e),i=!1,{remove:s}}function nae(e){dD.includes(e)||dD.unshift(e)}function oae(){for(;dD.length;)dD.pop()()}var kA;(function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"})(kA||(kA={}));class DC{constructor(){this.uid=Ta(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(t,i,r,s,n){return this.pool.acquire(kA.Untracked,t,i,r,s,n,EN)}static acquireTracked(t,i,r,s){return this.pool.acquire(kA.Tracked,t,i,r,null,null,s)}notify(t,i){this.type===kA.Untracked?this.callback.call(this.target,t,i,this.path,this.target):this.callback.call(null,t,i)}acquire(t,i,r,s,n,o,a){this.uid=Ta(),this.removed=!1,this.type=t,this.oldValue=i,this.callback=r,this.getValue=s,this.target=n,this.path=o,this.equals=a}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=Ta(),this.removed=!0}}DC.pool=new Boe(DC);const tI=new il,dm=new Set;let pD;function fD(e){dm.delete(e),dm.add(e),pD||(pD=rO(zTe))}function UTe(e){if(e.removed)return;const t=e.oldValue,i=e.getValue();e.equals(t,i)||(e.oldValue=i,e.notify(i,t))}function kTe(e){for(const t of dm.values())t.target===e&&(t.removed=!0)}function zTe(){let e=10;for(;pD&&e--;){pD=null;const t=BTe(),i=tI.acquire();for(const r of t){const s=r.uid;UTe(r),s===r.uid&&r.removed&&i.push(r)}for(const r of dm)r.removed&&(i.push(r),dm.delete(r));for(const r of i)DC.pool.release(r);tI.release(i),tI.release(t),m6.forEach(r=>r())}}function BTe(){const e=tI.acquire();e.length=dm.size;let t=0;for(const i of dm)e[t]=i,++t;return dm.clear(),e}const m6=new Set;function aae(e){return m6.add(e),{remove(){m6.delete(e)}}}function VTe(e,t,i){let r=Yoe(e,t,i,(s,n,o)=>{let a,l,c=rae(()=>sO(s,n),(h,p)=>{s.__accessor__.destroyed||a&&a.uid!==l?r.remove():(a||(a=DC.acquireUntracked(h,o,p,s,n),l=a.uid),fD(a))});return{remove:x7(()=>{c.remove(),a&&(a.uid!==l||a.removed||(a.removed=!0,fD(a)),a=null),r=c=null})}});return r}function GTe(e,t,i){const r=Yoe(e,t,i,(s,n,o)=>{let a=!1;return iae(()=>sO(s,n),(l,c)=>{s.__accessor__.destroyed?r.remove():a||(a=!0,EN(c,l)||o.call(s,l,c,n,s),a=!1)})});return r}function jTe(e,t,i,r=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:r?GTe(e,t,i):VTe(e,t,i)}function HTe(e,t,i){let r,s,n=rae(e,(o,a)=>{r&&r.uid!==s?n.remove():(r||(r=DC.acquireTracked(o,t,a,i),s=r.uid),fD(r))});return{remove:x7(()=>{n.remove(),r&&(r.uid!==s||r.removed||(r.removed=!0,fD(r)),r=null),n=null})}}function qTe(e,t,i){let r=!1;return iae(e,(s,n)=>{r||(r=!0,i(n,s)||t(s,n),r=!1)})}function WTe(e,t,i=!1,r=EN){return i?qTe(e,t,r):HTe(e,t,r)}function KX(e){return Woe(dm,t=>t.oldValue===e)}function Nt(e,t,i={}){return S7(e,t,i,lae)}function IN(e,t,i={}){return S7(e,t,i,cae)}function S7(e,t,i={},r){let s=null;const n=i.once?(o,a)=>{r(o)&&(Js(s),t(o,a))}:(o,a)=>{r(o)&&t(o,a)};if(s=WTe(e,n,i.sync,i.equals),i.initial){const o=e();n(o,o)}return s}function Yx(e,t,i,r={}){let s=null,n=null,o=null;function a(){s&&n&&(n.remove(),r.onListenerRemove==null||r.onListenerRemove(s),s=null,n=null)}function l(h){r.once&&r.once&&Js(o),i(h)}const c=Nt(e,(h,p)=>{a(),CN(h)&&(s=h,n=eO(h,t,l),r.onListenerAdd==null||r.onListenerAdd(h))},{sync:r.sync,initial:!0});return o=km(()=>{c.remove(),a()}),o}function mD(e,t){return XTe(e,cae,t)}function XTe(e,t,i){if(Us(i))return Promise.reject(pi());const r=e();if(t!=null&&t(r))return Promise.resolve(r);let s=null;function n(){s=Js(s)}return new Promise((o,a)=>{s=ET([go(i,()=>{n(),a(pi())}),S7(e,l=>{n(),o(l)},{sync:!1,once:!0},t!=null?t:lae)])})}function lae(e){return!0}function cae(e){return!!e}const Sh={sync:!0},fn={initial:!0},rc={sync:!0,initial:!0};function u(e,t,i,r){var s,n=arguments.length,o=n<3?t:r===null?r=Object.getOwnPropertyDescriptor(t,i):r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o}const eY=new Set;function YTe(e,t,i=!1){i&&eY.has(t)||(i&&eY.add(t),e.warn(`\u{1F6D1} DEPRECATED - ${t}`))}function bw(e,t,i={}){if(ue("esri-deprecation-warnings")){const{moduleName:r}=i;RT(e,`Function: ${(r?r+"::":"")+t+"()"}`,i)}}function ZTe(e,t,i={}){if(ue("esri-deprecation-warnings")){const{moduleName:r}=i;RT(e,`Property: ${(r?r+"::":"")+t}`,i)}}function RT(e,t,i={}){if(ue("esri-deprecation-warnings")){const{replacement:r,version:s,see:n,warnOnce:o}=i;let a=t;r&&(a+=`
	\u{1F6E0}\uFE0F Replacement: ${r}`),s&&(a+=`
	\u2699\uFE0F Version: ${s}`),n&&(a+=`
	\u{1F517} See ${n} for more details.`),YTe(e,a,o)}}var op;(function(e){e[e.INITIALIZING=0]="INITIALIZING",e[e.CONSTRUCTING=1]="CONSTRUCTING",e[e.CONSTRUCTED=2]="CONSTRUCTED"})(op||(op={}));class tY{constructor(t){this.autoDestroy=!1,this.properties=t}}function nO(e){let t=e.constructor.__accessorMetadata__;const i=Object.prototype.hasOwnProperty.call(e.constructor,"__accessorMetadata__");if(t){if(!i){const r=Object.create(t.properties),s=t.autoDestroy;for(const n in r)r[n]=se(r[n]);t=new tY(r),t.autoDestroy=s,Object.defineProperty(e.constructor,"__accessorMetadata__",{value:t,enumerable:!1,configurable:!0,writable:!0})}}else t=new tY({}),Object.defineProperty(e.constructor,"__accessorMetadata__",{value:t,enumerable:!1,configurable:!0,writable:!0});return e.constructor.__accessorMetadata__}function QTe(e){return nO(e).properties}function $N(e,t){const i=QTe(e);let r=i[t];return r||(r=i[t]={}),r}function JTe(e,t){return JP(e,t,eSe)}const KTe=/^(?:[^.]+\.)?(?:value|type|(?:json\.type|json\.origins\.[^.]\.type))$/;function eSe(e){return KTe.test(e)?"replace":"merge"}var oi;(function(e){e[e.DEFAULTS=0]="DEFAULTS",e[e.COMPUTED=1]="COMPUTED",e[e.SERVICE=2]="SERVICE",e[e.PORTAL_ITEM=3]="PORTAL_ITEM",e[e.WEB_SCENE=4]="WEB_SCENE",e[e.WEB_MAP=5]="WEB_MAP",e[e.USER=6]="USER"})(oi||(oi={}));const g6=oi.USER+1;function Ny(e){switch(e){case"defaults":return oi.DEFAULTS;case"service":return oi.SERVICE;case"portal-item":return oi.PORTAL_ITEM;case"web-scene":return oi.WEB_SCENE;case"web-map":return oi.WEB_MAP;case"user":return oi.USER}}function gD(e){switch(e){case oi.DEFAULTS:return"defaults";case oi.SERVICE:return"service";case oi.PORTAL_ITEM:return"portal-item";case oi.WEB_SCENE:return"web-scene";case oi.WEB_MAP:return"web-map";case oi.USER:return"user"}return void 0}function tSe(e){return gD(e)}class uae{constructor(t,i){this._observers=t,this._observer=i}remove(){g7(this._observers,this._observer)}}class iY{constructor(t,i,r){this.properties=t,this.propertyName=i,this.metadata=r,this._observers=null,this._accessed=null,this._handles=null,this.flags=er.Dirty|(r.nonNullable?er.NonNullable:0)|(r.hasOwnProperty("value")?er.HasDefaultValue:0)|(r.get===void 0?er.DepTrackingInitialized:0)|(r.dependsOn===void 0?er.AutoTracked:0)}destroy(){this._accessed=null,this._observers=null,this._clearObservationHandles()}getComputed(){Vt(this);const t=this.properties.store,i=this.propertyName,r=this.flags,s=t.get(i);if(r&er.Computing||~r&er.Dirty&&t.has(i))return s;this.flags|=er.Computing;const n=this.properties.host;let o;r&er.AutoTracked?o=Em(this,this.metadata.get,n):(tae(n,this),o=this.metadata.get.call(n)),t.set(i,o,oi.COMPUTED);const a=t.get(i);return a===s?this.flags&=~er.Dirty:NTe(this.commit,this),this.flags&=~er.Computing,a}onObservableAccessed(t){t!==this&&(this._accessed===null&&(this._accessed=[]),this._accessed.includes(t)||this._accessed.push(t))}onTrackingEnd(){this._clearObservationHandles(),this.flags|=er.DepTrackingInitialized;const t=this._accessed;if(t===null)return;let i=this._handles;i===null&&(i=this._handles=[]);for(let r=0;r<t.length;++r)i.push(t[r].observe(this));t.length=0}observe(t){return this._observers===null&&(this._observers=[]),this._observers.includes(t)||this._observers.push(t),new uae(this._observers,t)}notifyChange(){this.onInvalidated(),this.onCommitted()}invalidate(){this.onInvalidated()}onInvalidated(){~this.flags&er.Overriden&&(this.flags|=er.Dirty);const t=this._observers;if(t!==null)for(let i=0;i<t.length;++i)t[i].onInvalidated()}commit(){this.flags&=~er.Dirty,this.onCommitted()}onCommitted(){if(this._observers===null)return;const t=this._observers.slice();for(let i=0;i<t.length;++i)t[i].onCommitted()}_clearObservationHandles(){const t=this._handles;if(t!==null){for(let i=0;i<t.length;++i)t[i].remove();t.length=0}}}class E7{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(t){const i=new E7;return this._values.forEach((r,s)=>{t&&t.has(s)||i.set(s,se(r))}),i}get(t){return this._values.get(t)}originOf(){return oi.USER}keys(){return[...this._values.keys()]}set(t,i){this._values.set(t,i)}delete(t){this._values.delete(t)}has(t){return this._values.has(t)}forEach(t){this._values.forEach(t)}}function uM(e,t,i){return e!==void 0}function rY(e,t,i,r){return e!==void 0&&(!(i==null&&e.flags&er.NonNullable)||(r.lifecycle,op.INITIALIZING,!1))}function iSe(e){return e&&typeof e.destroy=="function"}he.getLogger("esri.core.accessorSupport.Properties");class rSe{constructor(t){this.host=t,this.properties=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=op.INITIALIZING,this.store=new E7,this._origin=oi.USER;const i=this.host.constructor.__accessorMetadata__,r=i.properties;for(const s in r){const n=new iY(this,s,r[s]);this.properties.set(s,n)}this.metadatas=r,this._autoDestroy=i.autoDestroy}initialize(){this.lifecycle=op.CONSTRUCTING}constructed(){this.lifecycle=op.CONSTRUCTED}destroy(){if(this.destroyed=!0,this._autoDestroy)for(const[t,i]of this.properties){const r=this.internalGet(t);r&&iSe(r)&&(r.destroy(),~i.flags&er.NonNullable&&this._internalSet(i,null)),i.destroy()}else for(const[t,i]of this.properties)i.destroy()}get initialized(){return this.lifecycle!==op.INITIALIZING}get(t){const i=this.properties.get(t);if(i.metadata.get)return i.getComputed();Vt(i);const r=this.store;return r.has(t)?r.get(t):i.metadata.value}originOf(t){const i=this.store.originOf(t);if(i===void 0){const r=this.properties.get(t);if(r!==void 0&&r.flags&er.HasDefaultValue)return"defaults"}return gD(i)}has(t){return!!this.properties.has(t)&&this.store.has(t)}keys(){return[...this.properties.keys()]}internalGet(t){const i=this.properties.get(t);if(uM(i))return this.store.has(t)?this.store.get(t):i.metadata.value}internalSet(t,i){const r=this.properties.get(t);uM(r)&&this._internalSet(r,i)}getDependsInfo(t,i,r){const s=this.properties.get(i);if(!uM(s))return"";const n=new Set,o=Em({onObservableAccessed:l=>n.add(l),onTrackingEnd:()=>{}},()=>{var l;return(l=s.metadata.get)==null?void 0:l.call(t)});let a=`${r}${t.declaredClass.split(".").pop()}.${i}: ${o}
`;if(n.size===0)return a;r+="  ";for(const l of n){if(!(l instanceof iY))continue;const c=l.properties.host,h=l.propertyName,p=Ra(c);a+=p?p.getDependsInfo(c,h,r):`${r}${h}: undefined
`}return a}setAtOrigin(t,i,r){const s=this.properties.get(t);if(uM(s))return this._setAtOrigin(s,i,r)}isOverridden(t){const i=this.properties.get(t);return i!==void 0&&!!(i.flags&er.Overriden)}clearOverride(t){const i=this.properties.get(t);i!==void 0&&i.flags&er.Overriden&&(i.flags&=~er.Overriden,i.notifyChange())}override(t,i){const r=this.properties.get(t);if(!rY(r,t,i,this))return;const s=r.metadata.cast;if(s){const n=this._cast(s,i),{valid:o,value:a}=n;if(p5.release(n),!o)return;i=a}r.flags|=er.Overriden,this._internalSet(r,i)}set(t,i){const r=this.properties.get(t);if(!rY(r,t,i,this))return;const s=r.metadata.cast;if(s){const o=this._cast(s,i),{valid:a,value:l}=o;if(p5.release(o),!a)return;i=l}const n=r.metadata.set;n?n.call(this.host,i):this._internalSet(r,i)}setDefaultOrigin(t){this._origin=Ny(t)}getDefaultOrigin(){return gD(this._origin)}notifyChange(t){const i=this.properties.get(t);i!==void 0&&i.notifyChange()}invalidate(t){const i=this.properties.get(t);i!==void 0&&i.invalidate()}commit(t){const i=this.properties.get(t);i!==void 0&&i.commit()}_internalSet(t,i){const r=this.lifecycle!==op.INITIALIZING?this._origin:oi.DEFAULTS;this._setAtOrigin(t,i,r)}_setAtOrigin(t,i,r){const s=this.store,n=t.propertyName;s.has(n,r)&&EN(i,s.get(n))&&~t.flags&er.Overriden&&r===s.originOf(n)||(t.invalidate(),s.set(n,i,r),t.commit(),eae(this.host,t))}_cast(t,i){const r=p5.acquire();return r.valid=!0,r.value=i,t&&(r.value=t.call(this.host,i,r)),r}}class sSe{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}}const p5=new Wr(sSe);function yD(e,t,i){if(e&&t)if(typeof t=="object")for(const r of Object.getOwnPropertyNames(t))yD(e,r,t[r]);else{if(t.indexOf(".")!==-1){const s=t.split("."),n=s.splice(s.length-1,1)[0];return void yD(uD(e,s),n,i)}const r=e.__accessor__;r!=null&&nSe(t,r),e[t]=i}}function nSe(e,t){if(ue("esri-unknown-property-errors")&&!oSe(e,t))throw new q("set:unknown-property",aSe(e,t))}function oSe(e,t){return t.metadatas[e]!=null}function aSe(e,t){return"setting unknown property '"+e+"' on instance of "+t.host.declaredClass}he.getLogger("esri.core.accessorSupport.set");function d(e={}){return(t,i)=>{if(t===Function.prototype)throw new Error(`Inappropriate use of @property() on a static field: ${t.name}.${i}. Accessor does not support static properties.`);const r=Object.getOwnPropertyDescriptor(t,i),s=$N(t,i);r&&(r.get||r.set?(s.get=r.get||s.get,s.set=r.set||s.set):"value"in r&&("value"in e&&he.getLogger("esri.core.accessorSupport.decorators.property").warn(`@property() will redefine the value of "${i}" on "${t.constructor.name}" already defined in the metadata`,e),s.value=e.value=r.value)),e.readOnly!=null&&(s.readOnly=e.readOnly);const n=e.aliasOf;if(n){const l=typeof n=="string"?n:n.source,c=typeof n=="string"?null:n.overridable===!0;let h;s.dependsOn=[l],s.get=function(){let p=uD(this,l);if(typeof p=="function"){h||(h=l.split(".").slice(0,-1).join("."));const f=uD(this,h);f&&(p=p.bind(f))}return p},s.readOnly||(s.set=c?function(p){p!==void 0?this._override(i,p):this._clearOverride(i)}:function(p){yD(this,l,p)})}const o=e.type,a=e.types;s.cast||(o?s.cast=lSe(o):a&&(Array.isArray(a)?s.cast=IC(Zh(a[0])):s.cast=Zh(a))),e.range&&(s.cast=cSe(s.cast,e.range)),JTe(s,e)}}function hae(e,t,i){const r=$N(e,i);r.json||(r.json={});let s=r.json;return t!==void 0&&(s.origins||(s.origins={}),s.origins[t]||(s.origins[t]={}),s=s.origins[t]),s}function lSe(e){let t=0,i=e;if(uTe(e))return Uoe(e);for(;Array.isArray(i)&&i.length===1&&typeof i[0]!="string"&&typeof i[0]!="number";)i=i[0],t++;const r=i;if(Foe(r))return t===0?s6(r):oD(s6(r),t);if(t===1)return lTe(r);if(t>1)return cTe(r,t);const s=e;return s.from?s.from:Ir(s)}function cSe(e,t){return i=>{let r=+e(i);return t.step!=null&&(r=Math.round(r/t.step)*t.step),t.min!=null&&(r=Math.max(t.min,r)),t.max!=null&&(r=Math.min(t.max,r)),r}}function uSe(e){if(e.json&&e.json.origins){const t=e.json.origins,i={"web-document":["web-scene","web-map"]};for(const r in i)if(t[r]){const s=t[r];i[r].forEach(n=>{t[n]=s}),delete t[r]}}}class vc extends ON{constructor(t,i,r){if(super(t,i,r),!(this instanceof vc))return new vc(t,i,r)}}vc.prototype.type="warning";function dae(e){return!!e&&e.prototype&&e.prototype.declaredClass&&e.prototype.declaredClass.indexOf("esri.core.Collection")===0}const y6=he.getLogger("esri.core.accessorSupport.extensions.serializableProperty.reader");function sY(e,t,i){var r,s;e&&(!i&&!t.read||(r=t.read)!=null&&r.reader||((s=t.read)==null?void 0:s.enabled)===!1||pSe(e)&&yc("read.reader",PS(e),t))}function PS(e){var t;const i=(t=e.ndimArray)!=null?t:0;if(i>1)return dSe(e);if(i===1)return nY(e);if("type"in e&&fae(e.type)){var r,s;const n=(r=e.type.prototype)==null||(s=r.itemType)==null?void 0:s.Type,o=nY(typeof n=="function"?{type:n}:{types:n});return(a,l,c)=>{const h=o(a,l,c);return h&&new e.type(h)}}return A7(e)}function A7(e){return"type"in e?hSe(e.type):fSe(e.types)}function hSe(e){return e.prototype.read?(t,i,r)=>{if(t==null)return t;const s=typeof t;if(s!=="object")return void y6.error(`Expected JSON value of type 'object' to deserialize type '${e.prototype.declaredClass}', but got '${s}'`);const n=new e;return n.read(t,r),n}:e.fromJSON}function pae(e,t,i,r){return r!==0&&Array.isArray(t)?t.map(s=>pae(e,s,i,r-1)):e(t,void 0,i)}function dSe(e){var t;const i=A7(e),r=pae.bind(null,i),s=(t=e.ndimArray)!=null?t:0;return(n,o,a)=>{if(n==null)return n;n=r(n,a,s);let l=s,c=n;for(;l>0&&Array.isArray(c);)l--,c=c[0];if(c!==void 0)for(let h=0;h<l;h++)n=[n];return n}}function nY(e){const t=A7(e);return(i,r,s)=>{if(i==null)return i;if(Array.isArray(i)){const o=[];for(const a of i){const l=t(a,void 0,s);l!==void 0&&o.push(l)}return o}const n=t(i,void 0,s);return n!==void 0?[n]:void 0}}function fae(e){if(!dae(e))return!1;const t=e.prototype.itemType;return!(!t||!t.Type)&&(typeof t.Type=="function"?C7(t.Type):mae(t.Type))}function pSe(e){return"types"in e?mae(e.types):C7(e.type)}function C7(e){return!Array.isArray(e)&&!!e&&e.prototype&&("read"in e.prototype||"fromJSON"in e||fae(e))}function mae(e){for(const t in e.typeMap)if(!C7(e.typeMap[t]))return!1;return!0}function fSe(e){var t;let i=null;const r=(t=e.errorContext)!=null?t:"type";return(s,n,o)=>{if(s==null)return s;const a=typeof s;if(a!=="object")return void y6.error(`Expected JSON value of type 'object' to deserialize, but got '${a}'`);i||(i=mSe(e));const l=e.key;if(typeof l!="string")return;const c=s[l],h=c?i[c]:e.defaultKeyValue?e.typeMap[e.defaultKeyValue]:void 0;if(!h){const f=`Type '${c||"unknown"}' is not supported`;return o&&o.messages&&s&&o.messages.push(new vc(`${r}:unsupported`,f,{definition:s,context:o})),void y6.error(f)}const p=new h;return p.read(s,o),p}}function mSe(e){const t={};for(const s in e.typeMap){var i,r;const n=e.typeMap[s],o=nO(n.prototype);if(typeof e.key=="function")continue;const a=o.properties[e.key];if(!a)continue;(i=a.json)!=null&&i.type&&Array.isArray(a.json.type)&&a.json.type.length===1&&typeof a.json.type[0]=="string"&&(t[a.json.type[0]]=n);const l=(r=a.json)==null?void 0:r.write;if(!l||!l.writer){t[s]=n;continue}const c=l.target,h=typeof c=="string"?c:e.key,p={};l.writer(s,p,h),p[h]&&(t[p[h]]=n)}return t}function gSe(e){if(e.json||(e.json={}),aY(e.json),lY(e.json),oY(e.json),e.json.origins)for(const t in e.json.origins)aY(e.json.origins[t]),lY(e.json.origins[t]),oY(e.json.origins[t]);return!0}function oY(e){e.name&&(e.read&&typeof e.read=="object"?e.read.source===void 0&&(e.read.source=e.name):e.read={source:e.name},e.write&&typeof e.write=="object"?e.write.target===void 0&&(e.write.target=e.name):e.write={target:e.name})}function aY(e){typeof e.read=="boolean"?e.read={enabled:e.read}:typeof e.read=="function"?e.read={enabled:!0,reader:e.read}:e.read&&typeof e.read=="object"&&e.read.enabled===void 0&&(e.read.enabled=!0)}function lY(e){typeof e.write=="boolean"?e.write={enabled:e.write}:typeof e.write=="function"?e.write={enabled:!0,writer:e.write}:e.write&&typeof e.write=="object"&&e.write.enabled===void 0&&(e.write.enabled=!0)}const ySe=he.getLogger("esri.core.accessorSupport.extensions.serializableProperty.writer");function cY(e,t){var i;if(!t.write||t.write.writer||t.write.enabled===!1&&!t.write.overridePolicy)return;const r=(i=e==null?void 0:e.ndimArray)!=null?i:0;e&&(r===1||"type"in e&&dae(e.type))?t.write.writer=bSe:r>1?t.write.writer=wSe(r):t.types?Array.isArray(t.types)?t.write.writer=_Se(t.types[0]):t.write.writer=vSe(t.types):t.write.writer=LC}function vSe(e){return(t,i,r,s)=>t?gae(t,e,s)?LC(t,i,r,s):void 0:LC(t,i,r,s)}function gae(e,t,i){for(const n in t.typeMap)if(e instanceof t.typeMap[n])return!0;if(i!=null&&i.messages){var r,s;const n=(r=t.errorContext)!=null?r:"type",o=`Values of type '${(s=typeof t.key!="function"?e[t.key]:e.declaredClass)!=null?s:"Unknown"}' cannot be written`;i&&i.messages&&e&&i.messages.push(new q(`${n}:unsupported`,o,{definition:e,context:i})),ySe.error(o)}return!1}function _Se(e){return(t,i,r,s)=>!t||!Array.isArray(t)?LC(t,i,r,s):LC(t.filter(n=>gae(n,e,s)),i,r,s)}function LC(e,t,i,r){yc(i,vD(e,r),t)}function vD(e,t){return e&&typeof e.write=="function"?e.write({},t):e&&typeof e.toJSON=="function"?e.toJSON():typeof e=="number"?_D(e):e}function _D(e){return e===-1/0?-Number.MAX_VALUE:e===1/0?Number.MAX_VALUE:isNaN(e)?null:e}function bSe(e,t,i,r){let s;e===null?s=null:e&&typeof e.map=="function"?(s=e.map(n=>vD(n,r)),typeof s.toArray=="function"&&(s=s.toArray())):s=[vD(e,r)],yc(i,s,t)}function yae(e,t,i){return i!==0&&Array.isArray(e)?e.map(r=>yae(r,t,i-1)):vD(e,t)}function wSe(e){return function(t,i,r,s){let n;if(t===null)n=null;else{n=yae(t,s,e);let o=e,a=n;for(;o>0&&Array.isArray(a);)o--,a=a[0];if(a!==void 0)for(let l=0;l<o;l++)n=[n]}yc(r,n,i)}}function v6(e,t){return R7(e,"read",t)}function vae(e,t){return R7(e,"write",t)}function R7(e,t,i){let r=e&&e.json;if(e&&e.json&&e.json.origins&&i){const s=e.json.origins[i.origin];s&&(t==="any"||t in s)&&(r=s)}return r}function xSe(e){const t=TSe(e);if(e.json.origins)for(const i in e.json.origins){const r=e.json.origins[i],s=r.types?SSe(r):t;sY(s,r,!1),r.types&&!r.write&&e.json.write&&e.json.write.enabled&&(r.write=I({},e.json.write)),cY(s,r)}sY(t,e.json,!0),cY(t,e.json)}function TSe(e){return e.json.types?_6(e.json):e.type?_ae(e):_6(e)}function SSe(e){return e.type?_ae(e):_6(e)}function _ae(e){if(!e.type)return;let t=0,i=e.type;for(;Array.isArray(i)&&!Foe(i);)i=i[0],t++;return{type:i,ndimArray:t}}function _6(e){if(!e.types)return;let t=0,i=e.types;for(;Array.isArray(i);)i=i[0],t++;return{types:i,ndimArray:t}}function ESe(e){gSe(e)&&(uSe(e),xSe(e))}const f5=new Set,m5=new Set;function P(e){return t=>{t.prototype.declaredClass=e,CSe(t);const i=[],r=[];let s=t.prototype;for(;s;)s.hasOwnProperty("initialize")&&!f5.has(s.initialize)&&(f5.add(s.initialize),i.push(s.initialize)),s.hasOwnProperty("destroy")&&!m5.has(s.destroy)&&(m5.add(s.destroy),r.push(s.destroy)),s=Object.getPrototypeOf(s);f5.clear(),m5.clear();class n extends t{constructor(...a){if(super(...a),this.constructor===n&&typeof this.postscript=="function"){if(i.length&&Object.defineProperty(this,"initialize",{enumerable:!1,configurable:!0,value(){for(let l=i.length-1;l>=0;l--)i[l].call(this)}}),r.length){let l=!1;Object.defineProperty(this,"destroy",{enumerable:!1,configurable:!0,value(){if(!l){l=!0;for(let c=0;c<r.length;c++)r[c].call(this)}}})}this.postscript(...a)}}}return n.__accessorMetadata__=nO(t.prototype),n.prototype.declaredClass=e,n}}function ASe(e,t){return t.get==null?function(){const i=this.__accessor__.properties.get(e);if(i===void 0)return;Vt(i);const r=this.__accessor__.store;return r.has(e)?r.get(e):i.metadata.value}:function(){const i=this.__accessor__.properties.get(e);if(i!==void 0)return i.getComputed()}}function CSe(e){const t=e.prototype,i=nO(t).properties,r={};for(const s of Object.getOwnPropertyNames(i)){const n=i[s];ESe(n),r[s]={enumerable:!0,configurable:!0,get:ASe(s,n),set(o){const a=this.__accessor__;if(a!==void 0){if(!Object.isFrozen(this)){if(a.initialized&&n.readOnly)throw new TypeError(`[accessor] cannot assign to read-only property '${s}' of ${this.declaredClass}`);if(a.lifecycle===op.CONSTRUCTED&&n.constructOnly)throw new TypeError(`[accessor] cannot assign to construct-only property '${s}' of ${this.declaredClass}`);a.set(s,o)}}else Object.defineProperty(this,s,{enumerable:!0,configurable:!0,writable:!0,value:o})}}}Object.defineProperties(e.prototype,r)}function RSe(e){if(e==null)return{value:e};if(Array.isArray(e))return{type:[e[0]],value:null};switch(typeof e){case"object":return e.constructor&&e.constructor.__accessorMetadata__||e instanceof Date?{type:e.constructor,value:e}:e;case"boolean":return{type:Boolean,value:e};case"string":return{type:String,value:e};case"number":return{type:Number,value:e};case"function":return{type:e,value:null};default:return}}class we{constructor(...t){if(this.constructor===we)throw new Error("[accessor] cannot instantiate Accessor. This can be fixed by creating a subclass of Accessor");Object.defineProperty(this,"__accessor__",{enumerable:!1,value:new rSe(this)}),t.length>0&&this.normalizeCtorArgs&&(this.__accessor__.ctorArgs=this.normalizeCtorArgs.apply(this,t))}static createSubclass(t={}){if(Array.isArray(t))throw new Error("Multi-inheritance unsupported since 4.16");const{properties:i,declaredClass:r,constructor:s}=t;delete t.declaredClass,delete t.properties,delete t.constructor;const n=this;class o extends n{constructor(...l){super(...l),this.inherited=null,s&&s.apply(this,l)}}nO(o.prototype);for(const a in t){const l=t[a];o.prototype[a]=typeof l=="function"?function(...c){const h=this.inherited;let p;this.inherited=function(...f){if(n.prototype[a])return n.prototype[a].apply(this,f)};try{p=l.apply(this,c)}catch(f){throw this.inherited=h,f}return this.inherited=h,p}:t[a]}for(const a in i){const l=RSe(i[a]);d(l)(o.prototype,a)}return P(r)(o)}postscript(t){const i=this.__accessor__,r=i.ctorArgs||t;i.initialize(),r&&(this.set(r),i.ctorArgs=null),i.constructed(),this.initialize()}initialize(){}destroy(){this.destroyed||(kTe(this),this.__accessor__.destroy())}get initialized(){return this.__accessor__&&this.__accessor__.initialized||!1}get constructed(){return this.__accessor__&&this.__accessor__.lifecycle===op.CONSTRUCTED||!1}get destroyed(){return this.__accessor__&&this.__accessor__.destroyed||!1}commitProperty(t){this.get(t)}get(t){return uD(this,t)}hasOwnProperty(t){return this.__accessor__?this.__accessor__.has(t):Object.prototype.hasOwnProperty.call(this,t)}isInstanceOf(t){return bw(he.getLogger(this.declaredClass),"isInstanceOf",{replacement:"Use instanceof directly",version:"4.16"}),this instanceof t}keys(){return this.__accessor__?this.__accessor__.keys():[]}set(t,i){return yD(this,t,i),this}watch(t,i,r){return jTe(this,t,i,r)}_clearOverride(t){return this.__accessor__.clearOverride(t)}_override(t,i){return this.__accessor__.override(t,i)}_isOverridden(t){return this.__accessor__.isOverridden(t)}notifyChange(t){this.__accessor__.notifyChange(t)}_get(t){return this.__accessor__.internalGet(t)}_set(t,i){return this.__accessor__.internalSet(t,i),this}}he.getLogger("esri.core.Clonable");const Dp=e=>{let t=class extends e{clone(){const i=Bxe(Ra(this),"unable to clone instance of non-accessor class"),r=i.metadatas,s=i.store,n={},o=new Map;for(const c in r){const h=r[c],p=s==null?void 0:s.originOf(c),f=h.clonable;if(h.readOnly||f===!1||p!==oi.USER&&p!==oi.DEFAULTS&&p!==oi.WEB_MAP&&p!==oi.WEB_SCENE)continue;const g=this[c];let y=null;y=typeof f=="function"?f(g):f==="reference"?g:i6(g),g!=null&&y==null||(p===oi.DEFAULTS?o.set(c,y):n[c]=y)}const a=new(Object.getPrototypeOf(this)).constructor(n);if(o.size){var l;const c=(l=Ra(a))==null?void 0:l.store;if(c)for(const[h,p]of o)c.set(h,p,oi.DEFAULTS)}return a}};return t=u([P("esri.core.Clonable")],t),t};let uY=class extends Dp(we){};uY=u([P("esri.core.Clonable")],uY);class O7{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(t){const i=new O7;return this._values.forEach((r,s)=>{t&&t.has(s)||i.set(s,se(r.value),r.origin)}),i}get(t,i){i=this._normalizeOrigin(i);const r=this._values.get(t);return i==null||(r==null?void 0:r.origin)===i?r==null?void 0:r.value:void 0}originOf(t){var i,r;return(i=(r=this._values.get(t))==null?void 0:r.origin)!=null?i:oi.USER}keys(t){t=this._normalizeOrigin(t);const i=[...this._values.keys()];return t==null?i:i.filter(r=>{var s;return((s=this._values.get(r))==null?void 0:s.origin)===t})}set(t,i,r){if((r=this._normalizeOrigin(r))===oi.DEFAULTS){const s=this._values.get(t);if(s&&s.origin!=null&&s.origin>r)return}this._values.set(t,new OSe(i,r))}delete(t,i){var r;(i=this._normalizeOrigin(i))!=null&&((r=this._values.get(t))==null?void 0:r.origin)!==i||this._values.delete(t)}has(t,i){var r;return(i=this._normalizeOrigin(i))!=null?((r=this._values.get(t))==null?void 0:r.origin)===i:this._values.has(t)}forEach(t){this._values.forEach(({value:i},r)=>t(i,r))}_normalizeOrigin(t){if(t!=null)return t===oi.DEFAULTS?t:oi.USER}}class OSe{constructor(t,i){this.value=t,this.origin=i}}function bae(e,t,i){t.keys().forEach(s=>{i.set(s,t.get(s),oi.DEFAULTS)});const r=e.metadatas;Object.keys(r).forEach(s=>{e.internalGet(s)&&i.set(s,e.internalGet(s),oi.DEFAULTS)})}function MSe(e,t,i){if(!e||!e.read||e.read.enabled===!1||!e.read.source)return!1;const r=e.read.source;if(typeof r=="string"){if(r===t||r.indexOf(".")>-1&&r.indexOf(t)===0&&QX(r,i))return!0}else for(const s of r)if(s===t||s.indexOf(".")>-1&&s.indexOf(t)===0&&QX(s,i))return!0;return!1}function PSe(e){return e&&(!e.read||e.read.enabled!==!1&&!e.read.source)}function ISe(e,t,i,r,s){let n=v6(t[i],s);PSe(n)&&(e[i]=!0);for(const o of Object.getOwnPropertyNames(t))n=v6(t[o],s),MSe(n,i,r)&&(e[o]=!0)}function $Se(e,t,i,r){const s=i.metadatas,n=R7(s[t],"any",r),o=n&&n.default;if(o===void 0)return;const a=typeof o=="function"?o.call(e,t,r):o;a!==void 0&&i.set(t,a)}const wae={origin:"service"};function xae(e,t,i=wae){if(!t||typeof t!="object")return;const r=Ra(e),s=r.metadatas,n={};for(const o of Object.getOwnPropertyNames(t))ISe(n,s,o,t,i);r.setDefaultOrigin(i.origin);for(const o of Object.getOwnPropertyNames(n)){const a=v6(s[o],i).read,l=a&&a.source;let c;c=l&&typeof l=="string"?sO(t,l):t[o],a&&a.reader&&(c=a.reader.call(e,c,t,i)),c!==void 0&&r.set(o,c)}if(!i||!i.ignoreDefaults){r.setDefaultOrigin("defaults");for(const o of Object.getOwnPropertyNames(s))n[o]||$Se(e,o,r,i)}r.setDefaultOrigin("user")}function Tae(e,t,i,r=wae){var s;const n=me(I({},r),{messages:[]});i(n),(s=n.messages)==null||s.forEach(o=>{o.type!=="warning"||e.loaded?r&&r.messages&&r.messages.push(o):e.loadWarnings.push(o)})}const DSe=he.getLogger("esri.core.accessorSupport.write");function LSe(e,t,i,r,s){var n,o;const a={};return(n=t.write)==null||(o=n.writer)==null||o.call(e,r,a,i,s),a}function Sae(e,t,i,r,s,n){if(!r||!r.write)return!1;const o=e.get(i);if(!s&&r.write.overridePolicy){const a=r.write.overridePolicy.call(e,o,i,n);a!==void 0&&(s=a)}if(s||(s=r.write),!s||s.enabled===!1)return!1;if((o===null&&!s.allowNull&&!s.writerEnsuresNonNull||o===void 0)&&s.isRequired){const a=new q("web-document-write:property-required",`Missing value for required property '${i}' on '${e.declaredClass}'`,{propertyName:i,target:e});return a&&n&&n.messages?n.messages.push(a):a&&!n&&DSe.error(a.name,a.message),!1}return!(o===void 0||o===null&&!s.allowNull&&!s.writerEnsuresNonNull||(!t.store.multipleOriginsSupported||t.store.originOf(i)===oi.DEFAULTS)&&NSe(e,i,n,r,o)||!s.ignoreOrigin&&n&&n.origin&&t.store.multipleOriginsSupported&&t.store.originOf(i)<Ny(n.origin))}function NSe(e,t,i,r,s){const n=r.default;if(n===void 0)return!1;if(r.defaultEquals!=null)return r.defaultEquals(s);if(typeof n=="function"){if(Array.isArray(s)){const o=n.call(e,t,i);return y1(o,s)}return!1}return n===s}function FSe(e,t,i,r){const s=Ra(e),n=s.metadatas,o=vae(n[t],r);return!!o&&Sae(e,s,t,o,i,r)}function Eae(e,t,i){if(e&&typeof e.toJSON=="function"&&(!e.toJSON.isDefaultToJSON||!e.write))return JP(t,e.toJSON());const r=Ra(e),s=r.metadatas;for(const a in s){const l=vae(s[a],i);if(!Sae(e,r,a,l,void 0,i))continue;const c=e.get(a),h=LSe(e,l,l.write&&typeof l.write.target=="string"?l.write.target:a,c,i);var n,o;Object.keys(h).length>0&&(t=JP(t,h),i!=null&&(n=i.resources)!=null&&(o=n.pendingOperations)!=null&&o.length&&Promise.all(i.resources.pendingOperations).then(()=>JP(t,h)),i&&i.writtenProperties&&i.writtenProperties.push({target:e,propName:a,oldOrigin:tSe(r.store.originOf(a)),newOrigin:i.origin}))}return t}const oO=e=>{let t=class extends e{constructor(...i){super(...i);const r=Ra(this),s=r.store,n=new O7;r.store=n,bae(r,s,n)}read(i,r){xae(this,i,r)}write(i={},r){return Eae(this,i,r)}toJSON(i){return this.write({},i)}static fromJSON(i,r){return USe.call(this,i,r)}};return t=u([P("esri.core.JSONSupport")],t),t.prototype.toJSON.isDefaultToJSON=!0,t};function USe(e,t){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");const i=new this;return i.read(e,t),i}let fe=class extends oO(we){};fe=u([P("esri.core.JSONSupport")],fe);const kSe=Object.prototype.toString;function zSe(e){const t="__accessorMetadata__"in e?Ir(e):e;return function(...i){if(i.push(t),typeof i[2]=="number")throw new Error("Using @cast has parameter decorator is not supported since 4.16");return BSe.apply(this,i)}}function BSe(e,t,i,r){$N(e,t).cast=r}function VSe(e){return function(t,i){$N(t,e).cast=t[i]}}function At(...e){if(e.length!==3||typeof e[1]!="string")return e.length===1&&kSe.call(e[0])==="[object Function]"?zSe(e[0]):e.length===1&&typeof e[0]=="string"?VSe(e[0]):void 0}function De(e,t,i){let r,s;return t===void 0||Array.isArray(t)?(s=e,i=t,r=[void 0]):(s=t,r=Array.isArray(e)?e:[e]),(n,o)=>{const a=n.constructor.prototype;r.forEach(l=>{const c=hae(n,l,s);c.read&&typeof c.read=="object"||(c.read={}),c.read.reader=a[o],i&&(c.read.source=(c.read.source||[]).concat(i))})}}function Fe(e,t,i){let r,s;return t===void 0?(s=e,r=[void 0]):typeof t!="string"?(s=e,r=[void 0],i=t):(s=t,r=Array.isArray(e)?e:[e]),(n,o)=>{const a=n.constructor.prototype;for(const l of r){const c=hae(n,l,s);c.write&&typeof c.write=="object"||(c.write={}),i&&(c.write.target=i),c.write.writer=a[o]}}}var xu;(function(e){e[e.CGCS2000=4490]="CGCS2000",e[e.GCSMARS2000=104971]="GCSMARS2000",e[e.GCSMARS2000_SPHERE=104905]="GCSMARS2000_SPHERE",e[e.GCSMOON2000=104903]="GCSMOON2000"})(xu||(xu={}));let m;const D={values:[1,.3048,.3048006096012192,.3047972654,.9143917962,.201166195164,.9143984146160287,.3047994715386762,20.11676512155263,20.11678249437587,.9143985307444408,.91439523,.3047997101815088,20.1168,20.116756,5e4,15e4],units:["Meter","Foot","Foot_US","Foot_Clarke","Yard_Clarke","Link_Clarke","Yard_Sears","Foot_Sears","Chain_Sears","Chain_Benoit_1895_B","Yard_Indian","Yard_Indian_1937","Foot_Gold_Coast","Chain","Chain_Sears_1922_Truncated","50_Kilometers","150_Kilometers"],2066:5,2136:12,2155:2,2157:0,2158:0,2159:12,2160:12,2204:2,2219:0,2220:0,2254:2,2255:2,2256:1,2265:1,2266:1,2267:2,2268:2,2269:1,2270:1,2271:2,2272:2,2273:1,2294:0,2295:0,2314:3,2899:2,2900:2,2901:1,2909:1,2910:1,2911:2,2912:2,2913:1,2914:1,2992:1,2993:0,2994:1,3080:1,3089:2,3090:0,3091:2,3102:2,3141:0,3142:0,3167:14,3359:2,3360:0,3361:1,3362:0,3363:2,3364:0,3365:2,3366:3,3404:2,3405:0,3406:0,3407:3,3439:0,3440:0,3479:1,3480:0,3481:1,3482:0,3483:1,3484:0,3485:2,3486:0,3487:2,3488:0,3489:0,3490:2,3491:0,3492:2,3493:0,3494:2,3495:0,3496:2,3497:0,3498:2,3499:0,3500:2,3501:0,3502:2,3503:0,3504:2,3505:0,3506:2,3507:0,3508:2,3509:0,3510:2,3511:0,3512:2,3513:0,3514:0,3515:2,3516:0,3517:2,3518:0,3519:2,3520:0,3521:2,3522:0,3523:2,3524:0,3525:2,3526:0,3527:2,3528:0,3529:2,3530:0,3531:2,3532:0,3533:2,3534:0,3535:2,3536:0,3537:2,3538:0,3539:2,3540:0,3541:2,3542:0,3543:2,3544:0,3545:2,3546:0,3547:2,3548:0,3549:2,3550:0,3551:2,3552:0,3553:2,3582:2,3583:0,3584:2,3585:0,3586:2,3587:0,3588:1,3589:0,3590:1,3591:0,3592:0,3593:1,3598:2,3599:0,3600:2,3605:1,3606:0,3607:0,3608:2,3609:0,3610:2,3611:0,3612:2,3613:0,3614:2,3615:0,3616:2,3617:0,3618:2,3619:0,3620:2,3621:0,3622:2,3623:0,3624:2,3625:0,3626:2,3627:0,3628:2,3629:0,3630:2,3631:0,3632:2,3633:0,3634:1,3635:0,3636:1,3640:2,3641:0,3642:2,3643:0,3644:1,3645:0,3646:1,3647:0,3648:1,3649:0,3650:2,3651:0,3652:2,3653:0,3654:2,3655:0,3656:1,3657:0,3658:2,3659:0,3660:2,3661:0,3662:2,3663:0,3664:2,3668:2,3669:0,3670:2,3671:0,3672:2,3673:0,3674:2,3675:0,3676:1,3677:2,3678:0,3679:1,3680:2,3681:0,3682:1,3683:2,3684:0,3685:0,3686:2,3687:0,3688:2,3689:0,3690:2,3691:0,3692:2,3696:2,3697:0,3698:2,3699:0,3700:2,3793:0,3794:0,3812:0,3854:0,3857:0,3920:0,3978:0,3979:0,3991:2,3992:2,4026:0,4037:0,4038:0,4071:0,4082:0,4083:0,4087:0,4088:0,4217:2,4414:0,4415:0,4417:0,4434:0,4437:0,4438:2,4439:2,4462:0,4467:0,4471:0,4474:0,4559:0,4647:0,4822:0,4826:0,4839:0,5018:0,5048:0,5167:0,5168:0,5221:0,5223:0,5234:0,5235:0,5243:0,5247:0,5266:0,5316:0,5320:0,5321:0,5325:0,5337:0,5361:0,5362:0,5367:0,5382:0,5383:0,5396:0,5456:0,5457:0,5469:0,5472:4,5490:0,5513:0,5514:0,5523:0,5559:0,5588:1,5589:3,5596:0,5627:0,5629:0,5641:0,5643:0,5644:0,5646:2,5654:2,5655:2,5659:0,5700:0,5825:0,5836:0,5837:0,5839:0,5842:0,5844:0,5858:0,5879:0,5880:0,5887:0,5890:0,6128:1,6129:1,6141:1,6204:0,6210:0,6211:0,6307:0,6312:0,6316:0,6362:0,6391:1,6405:1,6406:0,6407:1,6408:0,6409:1,6410:0,6411:2,6412:0,6413:2,6414:0,6415:0,6416:2,6417:0,6418:2,6419:0,6420:2,6421:0,6422:2,6423:0,6424:2,6425:0,6426:2,6427:0,6428:2,6429:0,6430:2,6431:0,6432:2,6433:0,6434:2,6435:0,6436:2,6437:0,6438:2,6439:0,6440:0,6441:2,6442:0,6443:2,6444:0,6445:2,6446:0,6447:2,6448:0,6449:2,6450:0,6451:2,6452:0,6453:2,6454:0,6455:2,6456:0,6457:2,6458:0,6459:2,6460:0,6461:2,6462:0,6463:2,6464:0,6465:2,6466:0,6467:2,6468:0,6469:2,6470:0,6471:2,6472:0,6473:2,6474:0,6475:2,6476:0,6477:2,6478:0,6479:2,6484:2,6485:0,6486:2,6487:0,6488:2,6489:0,6490:2,6491:0,6492:2,6493:0,6494:1,6495:0,6496:1,6497:0,6498:0,6499:1,6500:0,6501:2,6502:0,6503:2,6504:0,6505:2,6506:0,6507:2,6508:0,6509:0,6510:2,6515:1,6516:0,6518:0,6519:2,6520:0,6521:2,6522:0,6523:2,6524:0,6525:2,6526:0,6527:2,6528:0,6529:2,6530:0,6531:2,6532:0,6533:2,6534:0,6535:2,6536:0,6537:2,6538:0,6539:2,6540:0,6541:2,6542:0,6543:2,6544:0,6545:1,6546:0,6547:1,6548:0,6549:2,6550:0,6551:2,6552:0,6553:2,6554:0,6555:2,6556:0,6557:1,6558:0,6559:1,6560:0,6561:1,6562:0,6563:2,6564:0,6565:2,6566:0,6567:0,6568:2,6569:0,6570:1,6571:0,6572:2,6573:0,6574:2,6575:0,6576:2,6577:0,6578:2,6582:2,6583:0,6584:2,6585:0,6586:2,6587:0,6588:2,6589:0,6590:2,6591:0,6592:0,6593:2,6594:0,6595:2,6596:0,6597:2,6598:0,6599:2,6600:0,6601:2,6602:0,6603:2,6605:2,6606:0,6607:2,6608:0,6609:2,6610:0,6611:0,6612:2,6613:0,6614:2,6615:0,6616:2,6617:0,6618:2,6633:2,6646:0,6703:0,6784:0,6785:1,6786:0,6787:1,6788:0,6789:1,6790:0,6791:1,6792:0,6793:1,6794:0,6795:1,6796:0,6797:1,6798:0,6799:1,6800:0,6801:1,6802:0,6803:1,6804:0,6805:1,6806:0,6807:1,6808:0,6809:1,6810:0,6811:1,6812:0,6813:1,6814:0,6815:1,6816:0,6817:1,6818:0,6819:1,6820:0,6821:1,6822:0,6823:1,6824:0,6825:1,6826:0,6827:1,6828:0,6829:1,6830:0,6831:1,6832:0,6833:1,6834:0,6835:1,6836:0,6837:1,6838:0,6839:1,6840:0,6841:1,6842:0,6843:1,6844:0,6845:1,6846:0,6847:1,6848:0,6849:1,6850:0,6851:1,6852:0,6853:1,6854:0,6855:1,6856:0,6857:1,6858:0,6859:1,6860:0,6861:1,6862:0,6863:1,6867:0,6868:1,6870:0,6875:0,6876:0,6879:0,6880:2,6884:0,6885:1,6886:0,6887:1,6915:0,6922:0,6923:2,6924:0,6925:2,6962:0,6984:0,6991:0,7128:2,7131:0,7132:2,7142:0,7257:0,7258:2,7259:0,7260:2,7261:0,7262:2,7263:0,7264:2,7265:0,7266:2,7267:0,7268:2,7269:0,7270:2,7271:0,7272:2,7273:0,7274:2,7275:0,7276:2,7277:0,7278:2,7279:0,7280:2,7281:0,7282:2,7283:0,7284:2,7285:0,7286:2,7287:0,7288:2,7289:0,7290:2,7291:0,7292:2,7293:0,7294:2,7295:0,7296:2,7297:0,7298:2,7299:0,7300:2,7301:0,7302:2,7303:0,7304:2,7305:0,7306:2,7307:0,7308:2,7309:0,7310:2,7311:0,7312:2,7313:0,7314:2,7315:0,7316:2,7317:0,7318:2,7319:0,7320:2,7321:0,7322:2,7323:0,7324:2,7325:0,7326:2,7327:0,7328:2,7329:0,7330:2,7331:0,7332:2,7333:0,7334:2,7335:0,7336:2,7337:0,7338:2,7339:0,7340:2,7341:0,7342:2,7343:0,7344:2,7345:0,7346:2,7347:0,7348:2,7349:0,7350:2,7351:0,7352:2,7353:0,7354:2,7355:0,7356:2,7357:0,7358:2,7359:0,7360:2,7361:0,7362:2,7363:0,7364:2,7365:0,7366:2,7367:0,7368:2,7369:0,7370:2,7877:0,7878:0,7882:0,7883:0,7887:0,7899:0,7991:0,7992:0,8035:2,8036:2,8058:0,8059:0,8082:0,8083:0,8088:0,8090:0,8091:2,8092:0,8093:2,8095:0,8096:2,8097:0,8098:2,8099:0,8100:2,8101:0,8102:2,8103:0,8104:2,8105:0,8106:2,8107:0,8108:2,8109:0,8110:2,8111:0,8112:2,8113:0,8114:2,8115:0,8116:2,8117:0,8118:2,8119:0,8120:2,8121:0,8122:2,8123:0,8124:2,8125:0,8126:2,8127:0,8128:2,8129:0,8130:2,8131:0,8132:2,8133:0,8134:2,8135:0,8136:2,8137:0,8138:2,8139:0,8140:2,8141:0,8142:2,8143:0,8144:2,8145:0,8146:2,8147:0,8148:2,8149:0,8150:2,8151:0,8152:2,8153:0,8154:2,8155:0,8156:2,8157:0,8158:2,8159:0,8160:2,8161:0,8162:2,8163:0,8164:2,8165:0,8166:2,8167:0,8168:2,8169:0,8170:2,8171:0,8172:2,8173:0,8177:2,8179:0,8180:2,8181:0,8182:2,8184:0,8185:2,8187:0,8189:2,8191:0,8193:2,8196:0,8197:2,8198:0,8200:2,8201:0,8202:2,8203:0,8204:2,8205:0,8206:2,8207:0,8208:2,8209:0,8210:2,8212:0,8213:2,8214:0,8216:2,8218:0,8220:2,8222:0,8224:2,8225:0,8226:2,8311:0,8312:1,8313:0,8314:1,8315:0,8316:1,8317:0,8318:1,8319:0,8320:1,8321:0,8322:1,8323:0,8324:1,8325:0,8326:1,8327:0,8328:1,8329:0,8330:1,8331:0,8332:1,8333:0,8334:1,8335:0,8336:1,8337:0,8338:1,8339:0,8340:1,8341:0,8342:1,8343:0,8344:1,8345:0,8346:1,8347:0,8348:1,8352:0,8353:0,8379:0,8380:2,8381:0,8382:2,8383:0,8384:2,8385:0,8387:2,8391:0,8395:0,8433:0,8441:0,8455:0,8456:0,8531:2,8682:0,8686:0,8687:0,8692:0,8693:0,8826:0,8903:0,8950:0,8951:0,9039:0,9040:0,9141:0,9149:0,9150:0,9191:0,9221:0,9222:0,9249:0,9250:0,9252:0,9254:0,9265:0,9284:0,9285:0,9300:0,9354:0,9367:0,9373:0,9377:0,9387:0,9391:0,9456:0,9473:0,9498:0,9674:0,9678:0,9680:0,9709:0,9712:0,9713:0,9716:0,9741:0,9748:2,9749:2,9761:0,9766:0,20499:0,20538:0,20539:0,20790:0,20791:0,21291:0,21292:0,21500:0,21817:0,21818:0,22032:0,22033:0,22091:0,22092:0,22332:0,22391:0,22392:0,22700:0,22770:0,22780:0,22832:0,23090:0,23095:0,23239:0,23240:0,23433:0,23700:0,24047:0,24048:0,24100:3,24200:0,24305:0,24306:0,24382:10,24383:0,24500:0,24547:0,24548:0,24571:9,24600:0,25e3:0,25231:0,25884:0,25932:0,26237:0,26331:0,26332:0,26432:0,26591:0,26592:0,26632:0,26692:0,27120:0,27200:0,27291:6,27292:6,27429:0,27492:0,27493:0,27500:0,27700:0,28232:0,28600:0,28991:0,28992:0,29100:0,29101:0,29220:0,29221:0,29333:0,29635:0,29636:0,29701:0,29738:0,29739:0,29849:0,29850:0,29871:8,29872:7,29873:0,29874:0,30200:5,30339:0,30340:0,30591:0,30592:0,30791:0,30792:0,30800:0,31028:0,31121:0,31154:0,31170:0,31171:0,31370:0,31528:0,31529:0,31600:0,31700:0,31838:0,31839:0,31900:0,31901:0,32061:0,32062:0,32098:0,32099:2,32100:0,32104:0,32161:0,32766:0,53048:0,53049:0,54090:0,54091:0,65061:2,65062:2,65161:0,65163:0,102041:2,102064:11,102068:15,102069:16,102118:2,102119:1,102120:2,102121:2,102217:2,102218:0,102219:2,102220:2,102378:1,102379:1,102380:0,102381:1,102589:2,102599:2,102600:2,102604:2,102647:0,102704:2,102705:2,102706:0,102759:1,102760:1,102761:2,102762:0,102763:2,102764:0,102765:0,102766:2,102962:0,102963:0,102970:1,102974:2,102993:0,102994:0,102995:2,102996:2,103015:0,103016:2,103017:0,103018:2,103025:0,103026:0,103027:2,103028:2,103035:0,103036:0,103037:2,103038:2,103039:0,103040:0,103041:2,103042:2,103043:0,103044:0,103045:2,103046:2,103047:0,103048:0,103049:2,103050:2,103051:0,103052:2,103053:0,103054:2,103055:0,103056:2,103057:0,103058:0,103059:2,103060:2,103061:0,103062:0,103063:2,103064:2,103069:2,103070:0,103071:0,103072:2,103073:2,103086:0,103087:0,103088:2,103089:2,103094:1,103095:0,103096:2,103103:0,103104:2,103105:0,103106:2,103121:0,103122:2,103123:0,103124:0,103125:1,103126:1,103127:0,103128:0,103129:2,103130:2,103131:0,103132:0,103133:2,103134:2,103135:0,103136:0,103137:1,103138:1,103139:0,103140:2,103141:0,103142:2,103143:0,103144:2,103145:0,103146:1,103147:0,103148:0,103149:2,103150:2,103151:0,103152:2,103172:0,103173:2,103174:0,103175:0,103176:2,103177:2,103178:0,103179:0,103180:2,103181:2,103182:0,103183:0,103184:2,103185:2,103228:0,103229:0,103230:2,103231:2,103250:0,103251:2,103252:0,103253:2,103260:0,103261:0,103262:2,103263:2,103270:0,103271:0,103272:2,103273:2,103274:0,103275:0,103276:2,103277:2,103278:0,103279:0,103280:2,103281:2,103282:0,103283:0,103284:2,103285:2,103286:0,103287:2,103288:0,103289:2,103290:0,103291:2,103292:0,103293:0,103294:2,103295:2,103296:0,103297:0,103298:2,103299:2,103376:2,103377:0,103378:0,103379:2,103380:2,103393:0,103394:0,103395:2,103396:2,103472:0,103473:1,103474:0,103475:2,103482:0,103483:2,103484:0,103485:2,103500:0,103501:2,103502:0,103503:0,103504:1,103505:1,103506:0,103507:0,103508:2,103509:2,103510:0,103511:0,103512:2,103513:2,103514:0,103515:2,103516:0,103517:2,103518:0,103519:2,103520:0,103521:1,103522:0,103523:0,103524:2,103525:2,103526:0,103527:2,103561:2,103562:2,103563:0,103564:0,103565:2,103566:2,103567:0,103568:0,103569:2,103570:2,103584:0,103585:2,103586:0,103587:2,103588:1,103589:0,103590:2,103591:1,103592:0,103593:2,103594:1,103695:2};for(m=2e3;m<=2045;m++)D[m]=0;for(m=2056;m<=2065;m++)D[m]=0;for(m=2067;m<=2135;m++)D[m]=0;for(m=2137;m<=2154;m++)D[m]=0;for(m=2161;m<=2170;m++)D[m]=0;for(m=2172;m<=2193;m++)D[m]=0;for(m=2195;m<=2198;m++)D[m]=0;for(m=2200;m<=2203;m++)D[m]=0;for(m=2205;m<=2217;m++)D[m]=0;for(m=2222;m<=2224;m++)D[m]=1;for(m=2225;m<=2250;m++)D[m]=2;for(m=2251;m<=2253;m++)D[m]=1;for(m=2257;m<=2264;m++)D[m]=2;for(m=2274;m<=2279;m++)D[m]=2;for(m=2280;m<=2282;m++)D[m]=1;for(m=2283;m<=2289;m++)D[m]=2;for(m=2290;m<=2292;m++)D[m]=0;for(m=2308;m<=2313;m++)D[m]=0;for(m=2315;m<=2491;m++)D[m]=0;for(m=2494;m<=2866;m++)D[m]=0;for(m=2867;m<=2869;m++)D[m]=1;for(m=2870;m<=2888;m++)D[m]=2;for(m=2891;m<=2895;m++)D[m]=2;for(m=2896;m<=2898;m++)D[m]=1;for(m=2902;m<=2908;m++)D[m]=2;for(m=2915;m<=2920;m++)D[m]=2;for(m=2921;m<=2923;m++)D[m]=1;for(m=2924;m<=2930;m++)D[m]=2;for(m=2931;m<=2962;m++)D[m]=0;for(m=2964;m<=2968;m++)D[m]=2;for(m=2969;m<=2973;m++)D[m]=0;for(m=2975;m<=2991;m++)D[m]=0;for(m=2995;m<=3051;m++)D[m]=0;for(m=3054;m<=3079;m++)D[m]=0;for(m=3081;m<=3088;m++)D[m]=0;for(m=3092;m<=3101;m++)D[m]=0;for(m=3106;m<=3138;m++)D[m]=0;for(m=3146;m<=3151;m++)D[m]=0;for(m=3153;m<=3166;m++)D[m]=0;for(m=3168;m<=3172;m++)D[m]=0;for(m=3174;m<=3203;m++)D[m]=0;for(m=3294;m<=3358;m++)D[m]=0;for(m=3367;m<=3403;m++)D[m]=0;for(m=3408;m<=3416;m++)D[m]=0;for(m=3417;m<=3438;m++)D[m]=2;for(m=3441;m<=3446;m++)D[m]=2;for(m=3447;m<=3450;m++)D[m]=0;for(m=3451;m<=3459;m++)D[m]=2;for(m=3460;m<=3478;m++)D[m]=0;for(m=3554;m<=3559;m++)D[m]=0;for(m=3560;m<=3570;m++)D[m]=2;for(m=3571;m<=3581;m++)D[m]=0;for(m=3594;m<=3597;m++)D[m]=0;for(m=3601;m<=3604;m++)D[m]=0;for(m=3637;m<=3639;m++)D[m]=0;for(m=3665;m<=3667;m++)D[m]=0;for(m=3693;m<=3695;m++)D[m]=0;for(m=3701;m<=3727;m++)D[m]=0;for(m=3728;m<=3739;m++)D[m]=2;for(m=3740;m<=3751;m++)D[m]=0;for(m=3753;m<=3760;m++)D[m]=2;for(m=3761;m<=3773;m++)D[m]=0;for(m=3775;m<=3777;m++)D[m]=0;for(m=3779;m<=3781;m++)D[m]=0;for(m=3783;m<=3785;m++)D[m]=0;for(m=3788;m<=3791;m++)D[m]=0;for(m=3797;m<=3802;m++)D[m]=0;for(m=3814;m<=3816;m++)D[m]=0;for(m=3825;m<=3829;m++)D[m]=0;for(m=3832;m<=3841;m++)D[m]=0;for(m=3844;m<=3852;m++)D[m]=0;for(m=3873;m<=3885;m++)D[m]=0;for(m=3890;m<=3893;m++)D[m]=0;for(m=3907;m<=3912;m++)D[m]=0;for(m=3942;m<=3950;m++)D[m]=0;for(m=3968;m<=3970;m++)D[m]=0;for(m=3973;m<=3976;m++)D[m]=0;for(m=3986;m<=3989;m++)D[m]=0;for(m=3994;m<=3997;m++)D[m]=0;for(m=4048;m<=4051;m++)D[m]=0;for(m=4056;m<=4063;m++)D[m]=0;for(m=4093;m<=4096;m++)D[m]=0;for(m=4390;m<=4398;m++)D[m]=0;for(m=4399;m<=4413;m++)D[m]=2;for(m=4418;m<=4433;m++)D[m]=2;for(m=4455;m<=4457;m++)D[m]=2;for(m=4484;m<=4489;m++)D[m]=0;for(m=4491;m<=4554;m++)D[m]=0;for(m=4568;m<=4589;m++)D[m]=0;for(m=4652;m<=4656;m++)D[m]=0;for(m=4766;m<=4800;m++)D[m]=0;for(m=5014;m<=5016;m++)D[m]=0;for(m=5069;m<=5072;m++)D[m]=0;for(m=5105;m<=5130;m++)D[m]=0;for(m=5173;m<=5188;m++)D[m]=0;for(m=5253;m<=5259;m++)D[m]=0;for(m=5269;m<=5275;m++)D[m]=0;for(m=5292;m<=5311;m++)D[m]=0;for(m=5329;m<=5331;m++)D[m]=0;for(m=5343;m<=5349;m++)D[m]=0;for(m=5355;m<=5357;m++)D[m]=0;for(m=5387;m<=5389;m++)D[m]=0;for(m=5459;m<=5463;m++)D[m]=0;for(m=5479;m<=5482;m++)D[m]=0;for(m=5518;m<=5520;m++)D[m]=0;for(m=5530;m<=5539;m++)D[m]=0;for(m=5550;m<=5552;m++)D[m]=0;for(m=5562;m<=5583;m++)D[m]=0;for(m=5623;m<=5625;m++)D[m]=2;for(m=5631;m<=5639;m++)D[m]=0;for(m=5649;m<=5653;m++)D[m]=0;for(m=5663;m<=5680;m++)D[m]=0;for(m=5682;m<=5685;m++)D[m]=0;for(m=5875;m<=5877;m++)D[m]=0;for(m=5896;m<=5899;m++)D[m]=0;for(m=5921;m<=5940;m++)D[m]=0;for(m=6050;m<=6125;m++)D[m]=0;for(m=6244;m<=6275;m++)D[m]=0;for(m=6328;m<=6348;m++)D[m]=0;for(m=6350;m<=6356;m++)D[m]=0;for(m=6366;m<=6372;m++)D[m]=0;for(m=6381;m<=6387;m++)D[m]=0;for(m=6393;m<=6404;m++)D[m]=0;for(m=6480;m<=6483;m++)D[m]=0;for(m=6511;m<=6514;m++)D[m]=0;for(m=6579;m<=6581;m++)D[m]=0;for(m=6619;m<=6624;m++)D[m]=0;for(m=6625;m<=6627;m++)D[m]=2;for(m=6628;m<=6632;m++)D[m]=0;for(m=6634;m<=6637;m++)D[m]=0;for(m=6669;m<=6692;m++)D[m]=0;for(m=6707;m<=6709;m++)D[m]=0;for(m=6720;m<=6723;m++)D[m]=0;for(m=6732;m<=6738;m++)D[m]=0;for(m=6931;m<=6933;m++)D[m]=0;for(m=6956;m<=6959;m++)D[m]=0;for(m=7005;m<=7007;m++)D[m]=0;for(m=7057;m<=7070;m++)D[m]=2;for(m=7074;m<=7082;m++)D[m]=0;for(m=7109;m<=7118;m++)D[m]=0;for(m=7119;m<=7127;m++)D[m]=1;for(m=7374;m<=7376;m++)D[m]=0;for(m=7528;m<=7586;m++)D[m]=0;for(m=7587;m<=7645;m++)D[m]=2;for(m=7692;m<=7696;m++)D[m]=0;for(m=7755;m<=7787;m++)D[m]=0;for(m=7791;m<=7795;m++)D[m]=0;for(m=7799;m<=7801;m++)D[m]=0;for(m=7803;m<=7805;m++)D[m]=0;for(m=7825;m<=7831;m++)D[m]=0;for(m=7845;m<=7859;m++)D[m]=0;for(m=8013;m<=8032;m++)D[m]=0;for(m=8065;m<=8068;m++)D[m]=1;for(m=8518;m<=8529;m++)D[m]=2;for(m=8533;m<=8536;m++)D[m]=2;for(m=8538;m<=8540;m++)D[m]=2;for(m=8677;m<=8679;m++)D[m]=0;for(m=8836;m<=8840;m++)D[m]=0;for(m=8857;m<=8859;m++)D[m]=0;for(m=8908;m<=8910;m++)D[m]=0;for(m=9154;m<=9159;m++)D[m]=0;for(m=9205;m<=9218;m++)D[m]=0;for(m=9271;m<=9273;m++)D[m]=0;for(m=9295;m<=9297;m++)D[m]=0;for(m=9356;m<=9360;m++)D[m]=0;for(m=9404;m<=9407;m++)D[m]=0;for(m=9476;m<=9482;m++)D[m]=0;for(m=9487;m<=9494;m++)D[m]=0;for(m=9697;m<=9699;m++)D[m]=0;for(m=20002;m<=20032;m++)D[m]=0;for(m=20062;m<=20092;m++)D[m]=0;for(m=20135;m<=20138;m++)D[m]=0;for(m=20248;m<=20258;m++)D[m]=0;for(m=20348;m<=20358;m++)D[m]=0;for(m=20436;m<=20440;m++)D[m]=0;for(m=20822;m<=20824;m++)D[m]=0;for(m=20904;m<=20932;m++)D[m]=0;for(m=20934;m<=20936;m++)D[m]=0;for(m=21004;m<=21032;m++)D[m]=0;for(m=21035;m<=21037;m++)D[m]=0;for(m=21095;m<=21097;m++)D[m]=0;for(m=21148;m<=21150;m++)D[m]=0;for(m=21207;m<=21264;m++)D[m]=0;for(m=21307;m<=21364;m++)D[m]=0;for(m=21413;m<=21423;m++)D[m]=0;for(m=21453;m<=21463;m++)D[m]=0;for(m=21473;m<=21483;m++)D[m]=0;for(m=21780;m<=21782;m++)D[m]=0;for(m=21891;m<=21894;m++)D[m]=0;for(m=21896;m<=21899;m++)D[m]=0;for(m=22171;m<=22177;m++)D[m]=0;for(m=22181;m<=22187;m++)D[m]=0;for(m=22191;m<=22197;m++)D[m]=0;for(m=22234;m<=22236;m++)D[m]=0;for(m=22521;m<=22525;m++)D[m]=0;for(m=22991;m<=22994;m++)D[m]=0;for(m=23028;m<=23038;m++)D[m]=0;for(m=23830;m<=23853;m++)D[m]=0;for(m=23866;m<=23872;m++)D[m]=0;for(m=23877;m<=23884;m++)D[m]=0;for(m=23886;m<=23894;m++)D[m]=0;for(m=23946;m<=23948;m++)D[m]=0;for(m=24311;m<=24313;m++)D[m]=0;for(m=24342;m<=24347;m++)D[m]=0;for(m=24370;m<=24374;m++)D[m]=10;for(m=24375;m<=24381;m++)D[m]=0;for(m=24718;m<=24721;m++)D[m]=0;for(m=24817;m<=24821;m++)D[m]=0;for(m=24877;m<=24882;m++)D[m]=0;for(m=24891;m<=24893;m++)D[m]=0;for(m=25391;m<=25395;m++)D[m]=0;for(m=25828;m<=25838;m++)D[m]=0;for(m=26191;m<=26195;m++)D[m]=0;for(m=26391;m<=26393;m++)D[m]=0;for(m=26701;m<=26722;m++)D[m]=0;for(m=26729;m<=26799;m++)D[m]=2;for(m=26801;m<=26803;m++)D[m]=2;for(m=26811;m<=26813;m++)D[m]=2;for(m=26847;m<=26870;m++)D[m]=2;for(m=26891;m<=26899;m++)D[m]=0;for(m=26901;m<=26923;m++)D[m]=0;for(m=26929;m<=26946;m++)D[m]=0;for(m=26948;m<=26998;m++)D[m]=0;for(m=27037;m<=27040;m++)D[m]=0;for(m=27205;m<=27232;m++)D[m]=0;for(m=27258;m<=27260;m++)D[m]=0;for(m=27391;m<=27398;m++)D[m]=0;for(m=27561;m<=27564;m++)D[m]=0;for(m=27571;m<=27574;m++)D[m]=0;for(m=27581;m<=27584;m++)D[m]=0;for(m=27591;m<=27594;m++)D[m]=0;for(m=28191;m<=28193;m++)D[m]=0;for(m=28348;m<=28358;m++)D[m]=0;for(m=28402;m<=28432;m++)D[m]=0;for(m=28462;m<=28492;m++)D[m]=0;for(m=29118;m<=29122;m++)D[m]=0;for(m=29168;m<=29172;m++)D[m]=0;for(m=29177;m<=29185;m++)D[m]=0;for(m=29187;m<=29195;m++)D[m]=0;for(m=29900;m<=29903;m++)D[m]=0;for(m=30161;m<=30179;m++)D[m]=0;for(m=30491;m<=30494;m++)D[m]=0;for(m=30729;m<=30732;m++)D[m]=0;for(m=31251;m<=31259;m++)D[m]=0;for(m=31265;m<=31268;m++)D[m]=0;for(m=31275;m<=31279;m++)D[m]=0;for(m=31281;m<=31297;m++)D[m]=0;for(m=31461;m<=31469;m++)D[m]=0;for(m=31491;m<=31495;m++)D[m]=0;for(m=31917;m<=31922;m++)D[m]=0;for(m=31965;m<=32e3;m++)D[m]=0;for(m=32001;m<=32003;m++)D[m]=2;for(m=32005;m<=32031;m++)D[m]=2;for(m=32033;m<=32060;m++)D[m]=2;for(m=32064;m<=32067;m++)D[m]=2;for(m=32074;m<=32077;m++)D[m]=2;for(m=32081;m<=32086;m++)D[m]=0;for(m=32107;m<=32130;m++)D[m]=0;for(m=32133;m<=32158;m++)D[m]=0;for(m=32164;m<=32167;m++)D[m]=2;for(m=32180;m<=32199;m++)D[m]=0;for(m=32201;m<=32260;m++)D[m]=0;for(m=32301;m<=32360;m++)D[m]=0;for(m=32601;m<=32662;m++)D[m]=0;for(m=32664;m<=32667;m++)D[m]=2;for(m=32701;m<=32761;m++)D[m]=0;for(m=53001;m<=53004;m++)D[m]=0;for(m=53008;m<=53019;m++)D[m]=0;for(m=53021;m<=53032;m++)D[m]=0;for(m=53034;m<=53037;m++)D[m]=0;for(m=53042;m<=53046;m++)D[m]=0;for(m=53074;m<=53080;m++)D[m]=0;for(m=54001;m<=54004;m++)D[m]=0;for(m=54008;m<=54019;m++)D[m]=0;for(m=54021;m<=54032;m++)D[m]=0;for(m=54034;m<=54037;m++)D[m]=0;for(m=54042;m<=54046;m++)D[m]=0;for(m=54048;m<=54053;m++)D[m]=0;for(m=54074;m<=54080;m++)D[m]=0;for(m=54098;m<=54101;m++)D[m]=0;for(m=102001;m<=102040;m++)D[m]=0;for(m=102042;m<=102063;m++)D[m]=0;for(m=102065;m<=102067;m++)D[m]=0;for(m=102070;m<=102117;m++)D[m]=0;for(m=102122;m<=102216;m++)D[m]=0;for(m=102221;m<=102377;m++)D[m]=0;for(m=102382;m<=102388;m++)D[m]=0;for(m=102389;m<=102398;m++)D[m]=2;for(m=102399;m<=102444;m++)D[m]=0;for(m=102445;m<=102447;m++)D[m]=2;for(m=102448;m<=102458;m++)D[m]=0;for(m=102459;m<=102468;m++)D[m]=2;for(m=102469;m<=102499;m++)D[m]=0;for(m=102500;m<=102519;m++)D[m]=1;for(m=102520;m<=102524;m++)D[m]=0;for(m=102525;m<=102529;m++)D[m]=2;for(m=102530;m<=102588;m++)D[m]=0;for(m=102590;m<=102598;m++)D[m]=0;for(m=102601;m<=102603;m++)D[m]=0;for(m=102605;m<=102628;m++)D[m]=0;for(m=102629;m<=102646;m++)D[m]=2;for(m=102648;m<=102700;m++)D[m]=2;for(m=102701;m<=102703;m++)D[m]=0;for(m=102707;m<=102730;m++)D[m]=2;for(m=102733;m<=102758;m++)D[m]=2;for(m=102767;m<=102900;m++)D[m]=0;for(m=102901;m<=102933;m++)D[m]=2;for(m=102934;m<=102950;m++)D[m]=13;for(m=102951;m<=102960;m++)D[m]=0;for(m=102965;m<=102969;m++)D[m]=0;for(m=102971;m<=102973;m++)D[m]=0;for(m=102975;m<=102989;m++)D[m]=0;for(m=102990;m<=102992;m++)D[m]=1;for(m=102997;m<=103002;m++)D[m]=0;for(m=103003;m<=103008;m++)D[m]=2;for(m=103009;m<=103011;m++)D[m]=0;for(m=103012;m<=103014;m++)D[m]=2;for(m=103019;m<=103021;m++)D[m]=0;for(m=103022;m<=103024;m++)D[m]=2;for(m=103029;m<=103031;m++)D[m]=0;for(m=103032;m<=103034;m++)D[m]=2;for(m=103065;m<=103068;m++)D[m]=0;for(m=103074;m<=103076;m++)D[m]=0;for(m=103077;m<=103079;m++)D[m]=1;for(m=103080;m<=103082;m++)D[m]=0;for(m=103083;m<=103085;m++)D[m]=2;for(m=103090;m<=103093;m++)D[m]=0;for(m=103097;m<=103099;m++)D[m]=0;for(m=103100;m<=103102;m++)D[m]=2;for(m=103107;m<=103109;m++)D[m]=0;for(m=103110;m<=103112;m++)D[m]=2;for(m=103113;m<=103116;m++)D[m]=0;for(m=103117;m<=103120;m++)D[m]=2;for(m=103153;m<=103157;m++)D[m]=0;for(m=103158;m<=103162;m++)D[m]=2;for(m=103163;m<=103165;m++)D[m]=0;for(m=103166;m<=103168;m++)D[m]=1;for(m=103169;m<=103171;m++)D[m]=2;for(m=103186;m<=103188;m++)D[m]=0;for(m=103189;m<=103191;m++)D[m]=2;for(m=103192;m<=103195;m++)D[m]=0;for(m=103196;m<=103199;m++)D[m]=2;for(m=103200;m<=103224;m++)D[m]=0;for(m=103225;m<=103227;m++)D[m]=1;for(m=103232;m<=103237;m++)D[m]=0;for(m=103238;m<=103243;m++)D[m]=2;for(m=103244;m<=103246;m++)D[m]=0;for(m=103247;m<=103249;m++)D[m]=2;for(m=103254;m<=103256;m++)D[m]=0;for(m=103257;m<=103259;m++)D[m]=2;for(m=103264;m<=103266;m++)D[m]=0;for(m=103267;m<=103269;m++)D[m]=2;for(m=103300;m<=103375;m++)D[m]=0;for(m=103381;m<=103383;m++)D[m]=0;for(m=103384;m<=103386;m++)D[m]=1;for(m=103387;m<=103389;m++)D[m]=0;for(m=103390;m<=103392;m++)D[m]=2;for(m=103397;m<=103399;m++)D[m]=0;for(m=103400;m<=103471;m++)D[m]=2;for(m=103476;m<=103478;m++)D[m]=0;for(m=103479;m<=103481;m++)D[m]=2;for(m=103486;m<=103488;m++)D[m]=0;for(m=103489;m<=103491;m++)D[m]=2;for(m=103492;m<=103495;m++)D[m]=0;for(m=103496;m<=103499;m++)D[m]=2;for(m=103528;m<=103543;m++)D[m]=0;for(m=103544;m<=103548;m++)D[m]=2;for(m=103549;m<=103551;m++)D[m]=0;for(m=103552;m<=103554;m++)D[m]=1;for(m=103555;m<=103557;m++)D[m]=2;for(m=103558;m<=103560;m++)D[m]=0;for(m=103571;m<=103573;m++)D[m]=0;for(m=103574;m<=103576;m++)D[m]=2;for(m=103577;m<=103580;m++)D[m]=0;for(m=103581;m<=103583;m++)D[m]=2;for(m=103595;m<=103694;m++)D[m]=0;for(m=103696;m<=103699;m++)D[m]=0;for(m=103700;m<=103793;m++)D[m]=2;for(m=103794;m<=103872;m++)D[m]=0;for(m=103900;m<=103971;m++)D[m]=2;const GSe={102113:!0,102100:!0,3857:!0,3785:!0},jSe={102113:!0,102100:!0,3857:!0,3785:!0,4326:!0},hY='PROJCS["WGS_1984_Web_Mercator_Auxiliary_Sphere",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator_Auxiliary_Sphere"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],PARAMETER["Auxiliary_Sphere_Type",0.0],UNIT["Meter",1.0]]',hM=[-20037508342788905e-9,20037508342788905e-9],dM=[-20037508342787e-6,20037508342787e-6],Aae={102113:{wkTemplate:'PROJCS["WGS_1984_Web_Mercator",GEOGCS["GCS_WGS_1984_Major_Auxiliary_Sphere",DATUM["D_WGS_1984_Major_Auxiliary_Sphere",SPHEROID["WGS_1984_Major_Auxiliary_Sphere",6378137.0,0.0]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],UNIT["Meter",1.0]]',valid:hM,origin:dM,dx:1e-5},102100:{wkTemplate:hY,valid:hM,origin:dM,dx:1e-5},3785:{wkTemplate:'PROJCS["WGS_1984_Web_Mercator",GEOGCS["GCS_WGS_1984_Major_Auxiliary_Sphere",DATUM["D_WGS_1984_Major_Auxiliary_Sphere",SPHEROID["WGS_1984_Major_Auxiliary_Sphere",6378137.0,0.0]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],UNIT["Meter",1.0]]',valid:hM,origin:dM,dx:1e-5},3857:{wkTemplate:hY,valid:hM,origin:dM,dx:1e-5},4326:{wkTemplate:'GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",{Central_Meridian}],UNIT["Degree",0.0174532925199433]]',altTemplate:'PROJCS["WGS_1984_Plate_Carree",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Plate_Carree"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],UNIT["Degrees",111319.491]]',valid:[-180,180],origin:[-180,90],dx:1e-5},104971:{wkTemplate:'GEOGCS["Mars_2000_(Sphere)",DATUM["Mars_2000_(Sphere)",SPHEROID["Mars_2000_(Sphere)",3396190.0,0.0]],PRIMEM["Reference_Meridian",0.0],UNIT["Degree",0.0174532925199433]]',valid:[-180,180],origin:[-180,90],dx:1e-5},104905:{wkTemplate:'GEOGCS["GCS_Mars_2000",DATUM["D_Mars_2000",SPHEROID["Mars_2000_IAU_IAG",3396190.0,169.8944472236118]],PRIMEM["Reference_Meridian",0.0],UNIT["Degree",0.0174532925199433]]',valid:[-180,180],origin:[-180,90],dx:1e-5}};function Rc(e,t){return!R(e)&&!R(t)&&(e===t||(e.wkid!=null||t.wkid!=null?e.wkid===t.wkid||b1(e)&&b1(t)||t.latestWkid!=null&&e.wkid===t.latestWkid||e.latestWkid!=null&&t.wkid===e.latestWkid:!(!e.wkt||!t.wkt)&&e.wkt.toUpperCase()===t.wkt.toUpperCase()))}function s0(e){return _c(e)&&e.wkid?Aae[e.wkid]:null}function Cae(e){return!!_c(e)&&(e.wkid?D[e.wkid]==null:!!e.wkt&&!!/^\s*GEOGCS/i.test(e.wkt))}function OT(e){return!(Lp(e)||Np(e))}function NC(e){return _c(e)&&e.wkid===4326}function Rae(e){return _c(e)&&e.wkid===xu.CGCS2000}function b1(e){return _c(e)&&e.wkid!=null&&GSe[e.wkid]===!0}function Oae(e){return _c(e)&&e.wkid===32662}function M7(e){return e===xu.GCSMARS2000||e===xu.GCSMARS2000_SPHERE}function Lp(e){return _c(e)&&e.wkid!=null&&M7(e.wkid)}function P7(e){return e===xu.GCSMOON2000}function Np(e){return _c(e)&&e.wkid!=null&&P7(e.wkid)}function HSe(e){return _c(e)&&e.wkid!=null&&jSe[e.wkid]===!0}function _c(e){return _(e)&&(e.wkid!=null&&e.wkid>=2e3||e.wkt!=null)}const qSe={wkid:4326,wkt:_p(Aae[4326].wkTemplate,{Central_Meridian:"0.0"})},WSe={wkid:102100,latestWkid:3857},XSe={wkid:32662};var Rd;let Qi=Rd=class extends fe{constructor(e){super(e),this.latestWkid=null,this.wkid=null,this.wkt=null,this.vcsWkid=null,this.latestVcsWkid=null,this.imageCoordinateSystem=null}static fromJSON(e){if(!e)return null;if(e.wkid){if(e.wkid===102100)return Rd.WebMercator;if(e.wkid===4326)return Rd.WGS84}const t=new Rd;return t.read(e),t}normalizeCtorArgs(e){return e&&typeof e=="object"?e:{[typeof e=="string"?"wkt":"wkid"]:e}}get isWGS84(){return NC(this)}get isWebMercator(){return b1(this)}get isGeographic(){return Cae(this)}get isWrappable(){return HSe(this)}writeWkt(e,t){this.wkid||(t.wkt=e)}clone(){if(this===Rd.WGS84)return Rd.WGS84;if(this===Rd.WebMercator)return Rd.WebMercator;const e=new Rd;return this.wkid!=null?(e.wkid=this.wkid,this.latestWkid!=null&&(e.latestWkid=this.latestWkid),this.vcsWkid!=null&&(e.vcsWkid=this.vcsWkid),this.latestVcsWkid!=null&&(e.latestVcsWkid=this.latestVcsWkid)):this.wkt!=null&&(e.wkt=this.wkt),this.imageCoordinateSystem&&(e.imageCoordinateSystem=se(this.imageCoordinateSystem)),e}equals(e){if(e==null)return!1;if(this.imageCoordinateSystem||e.imageCoordinateSystem){if(this.imageCoordinateSystem==null||e.imageCoordinateSystem==null)return!1;const{id:t,referenceServiceName:i}=e.imageCoordinateSystem,{geodataXform:r}=e.imageCoordinateSystem,s=this.imageCoordinateSystem;return t==null||r?JSON.stringify(s)===JSON.stringify(e.imageCoordinateSystem):i?s.id===t&&s.referenceServiceName===i:s.id===t}return Rc(this,e)}toJSON(e){return this.write(void 0,e)}};Qi.GCS_NAD_1927=null,Qi.WGS84=null,Qi.WebMercator=null,Qi.PlateCarree=null,u([d({readOnly:!0})],Qi.prototype,"isWGS84",null),u([d({readOnly:!0})],Qi.prototype,"isWebMercator",null),u([d({readOnly:!0})],Qi.prototype,"isGeographic",null),u([d({readOnly:!0})],Qi.prototype,"isWrappable",null),u([d({type:ir,json:{write:!0}})],Qi.prototype,"latestWkid",void 0),u([d({type:ir,json:{write:!0,origins:{"web-scene":{write:{overridePolicy(){return{isRequired:this.wkt===null}}}}}}})],Qi.prototype,"wkid",void 0),u([d({type:String,json:{origins:{"web-scene":{write:{overridePolicy(){return{isRequired:this.wkid===null}}}}}}})],Qi.prototype,"wkt",void 0),u([Fe("wkt"),Fe("web-scene","wkt")],Qi.prototype,"writeWkt",null),u([d({type:ir,json:{write:!0}})],Qi.prototype,"vcsWkid",void 0),u([d({type:ir,json:{write:!0}})],Qi.prototype,"latestVcsWkid",void 0),u([d()],Qi.prototype,"imageCoordinateSystem",void 0),Qi=Rd=u([P("esri.geometry.SpatialReference")],Qi),Qi.prototype.toJSON.isDefaultToJSON=!0,Qi.GCS_NAD_1927=new Qi({wkid:4267,wkt:'GEOGCS["GCS_North_American_1927",DATUM["D_North_American_1927",SPHEROID["Clarke_1866",6378206.4,294.9786982]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]]'}),Qi.WGS84=new Qi(qSe),Qi.WebMercator=new Qi(WSe),Qi.PlateCarree=new Qi(XSe),Object.freeze&&(Object.freeze(Qi.GCS_NAD_1927),Object.freeze(Qi.WGS84),Object.freeze(Qi.WebMercator));const He=Qi;let Od=class extends fe{constructor(...e){super(...e),this.type=null,this.hasM=!1,this.hasZ=!1,this.spatialReference=He.WGS84}get cache(){return this.commitProperty("spatialReference"),{}}get extent(){return null}readSpatialReference(e,t){if(e instanceof He)return e;if(e!=null){const i=new He;return i.read(e,t),i}return e}clone(){return console.warn(".clone() is not implemented for "+this.declaredClass),null}clearCache(){this.notifyChange("cache")}getCacheValue(e){return this.cache[e]}setCacheValue(e,t){this.cache[e]=t}};u([d()],Od.prototype,"type",void 0),u([d({readOnly:!0})],Od.prototype,"cache",null),u([d({readOnly:!0})],Od.prototype,"extent",null),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],Od.prototype,"hasM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],Od.prototype,"hasZ",void 0),u([d({type:He,json:{write:!0}})],Od.prototype,"spatialReference",void 0),u([De("spatialReference")],Od.prototype,"readSpatialReference",null),Od=u([P("esri.geometry.Geometry")],Od);const vl=Od;function YSe(e,t,i,r){var s;return e.x=e.x+t,e.y=e.y+i,r!=null&&(e.z=((s=e.z)!=null?s:0)+r),e}function ZSe(e,t){const i=e.x-t.x,r=e.y-t.y,s=e.hasZ&&t.hasZ?e.z-t.z:0;return Math.sqrt(i*i+r*r+s*s)}class I7{constructor(t,i,r,s){this.semiMajorAxis=t,this.flattening=i,this.outerAtmosphereRimWidth=r;const n=1-this.flattening;this.semiMinorAxis=this.semiMajorAxis*n,this.halfSemiMajorAxis=this.semiMajorAxis/2,this.halfCircumference=Math.PI*this.semiMajorAxis,this.metersPerDegree=this.halfCircumference/180,this.inverseFlattening=1/(1-this.flattening)-1,this.eccentricitySquared=s||2*this.flattening-this.flattening*this.flattening,this.meanRadiusSemiAxes=(2*this.semiMajorAxis+this.semiMinorAxis)/3}get radius(){return this.semiMajorAxis}}const ai=new I7(6378137,1/298.257223563,3e5,.006694379990137799),pp=new I7(3396190,1/169.8944472236118,23e4),Am=new I7(1737400,0,0),QSe=57.29577951308232,JSe=.017453292519943;function dY(e){return e*QSe}function pY(e){return e*JSe}function fY(e){return e/ai.radius}function bD(e){return Math.PI/2-2*Math.atan(Math.exp(-e/ai.radius))}function b6(e){return e.wkid!=null||e.wkt!=null}const g5=[0,0];function wD(e,t,i,r,s){const n=e,o=s;if(o.spatialReference=i,"x"in n&&"x"in o)[o.x,o.y]=t(n.x,n.y,g5,r);else if("xmin"in n&&"xmin"in o)[o.xmin,o.ymin]=t(n.xmin,n.ymin,g5,r),[o.xmax,o.ymax]=t(n.xmax,n.ymax,g5,r);else if("paths"in n&&"paths"in o||"rings"in n&&"rings"in o){const a="paths"in n?n.paths:n.rings,l=[];let c;for(let h=0;h<a.length;h++){const p=a[h];c=[],l.push(c);for(let f=0;f<p.length;f++)c.push(t(p[f][0],p[f][1],[0,0],r)),p[f].length>2&&c[f].push(p[f][2]),p[f].length>3&&c[f].push(p[f][3])}"paths"in o?o.paths=l:o.rings=l}else if("points"in n&&"points"in o){const a=n.points,l=[];for(let c=0;c<a.length;c++)l[c]=t(a[c][0],a[c][1],[0,0],r),a[c].length>2&&l[c].push(a[c][2]),a[c].length>3&&l[c].push(a[c][3]);o.points=l}return s}function pm(e,t){const i=e&&(b6(e)?e:e.spatialReference),r=t&&(b6(t)?t:t.spatialReference);return!(e&&"type"in e&&e.type==="mesh"||t&&"type"in t&&t.type==="mesh"||!i||!r)&&(!!Rc(r,i)||b1(r)&&NC(i)||b1(i)&&NC(r))}function sb(e,t){if(R(e))return null;const i=e.spatialReference,r=t&&(b6(t)?t:t.spatialReference);return pm(i,r)?Rc(i,r)?se(e):b1(r)?wD(e,Tx,He.WebMercator,!1,se(e)):NC(r)?wD(e,zA,He.WGS84,!1,se(e)):null:null}function Tx(e,t,i=[0,0]){t>89.99999?t=89.99999:t<-89.99999&&(t=-89.99999);const r=pY(t);return i[0]=pY(e)*ai.radius,i[1]=ai.halfSemiMajorAxis*Math.log((1+Math.sin(r))/(1-Math.sin(r))),i}function zA(e,t,i=[0,0],r=!1){const s=dY(e/ai.radius);return i[0]=r?s:s-360*Math.floor((s+180)/360),i[1]=dY(Math.PI/2-2*Math.atan(Math.exp(-t/ai.radius))),i}function fm(e,t=!1,i=se(e)){return wD(e,Tx,He.WebMercator,t,i)}function SE(e,t=!1,i=se(e)){return wD(e,zA,He.WGS84,t,i)}var iI;const h2=[0,0];function mY(e){return e&&(e.declaredClass==="esri.geometry.SpatialReference"||e.wkid!=null)}const pM=he.getLogger("esri.geometry.Point");let ia=iI=class extends vl{constructor(...e){super(...e),this.x=0,this.y=0,this.z=void 0,this.m=void 0,this.type="point"}static copy(e,t){t._set("x",e._get("x")),t._set("y",e._get("y")),t._set("z",e._get("z")),t._set("m",e._get("m"));const i=e._get("spatialReference");t._set("spatialReference",Object.isFrozen(i)?i:i.clone())}normalizeCtorArgs(e,t,i,r,s){let n;if(Array.isArray(e))n=e,s=t,e=n[0],t=n[1],i=n[2],r=n[3];else if(e&&typeof e=="object"){if(n=e,e=n.x!=null?n.x:n.longitude,t=n.y!=null?n.y:n.latitude,i=n.z,r=n.m,(s=n.spatialReference)&&s.declaredClass!=="esri.geometry.SpatialReference"&&(s=new He(s)),n.longitude!=null||n.latitude!=null){if(n.longitude==null)pM.warn(".longitude=","Latitude was defined without longitude");else if(n.latitude==null)pM.warn(".latitude=","Longitude was defined without latitude");else if(!n.declaredClass&&s&&s.isWebMercator){const a=Tx(n.longitude,n.latitude,h2);e=a[0],t=a[1]}}}else mY(i)?(s=i,i=null):mY(r)&&(s=r,r=null);const o={x:e,y:t};return o.x==null&&o.y!=null?pM.warn(".y=","Y coordinate was defined without an X coordinate"):o.y==null&&o.x!=null&&pM.warn(".x=","X coordinate was defined without a Y coordinate"),s!=null&&(o.spatialReference=s),i!=null&&(o.z=i),r!=null&&(o.m=r),o}get cache(){return this.commitProperty("x"),this.commitProperty("y"),this.commitProperty("z"),this.commitProperty("m"),this.commitProperty("spatialReference"),{}}get hasM(){return this.m!==void 0}set hasM(e){e!==(this._get("m")!==void 0)&&(this._set("m",e?0:void 0),this._set("hasM",e))}get hasZ(){return this.z!==void 0}set hasZ(e){e!==(this._get("z")!==void 0)&&(this._set("z",e?0:void 0),this._set("hasZ",e))}get latitude(){const{spatialReference:e,x:t,y:i}=this;if(e){if(e.isWebMercator)return zA(t,i,h2)[1];if(e.isGeographic)return i}return null}set latitude(e){const{spatialReference:t,x:i}=this;t&&(t.isWebMercator?this._set("y",Tx(i,e,h2)[1]):t.isGeographic&&this._set("y",e),this._set("latitude",e))}get longitude(){const{x:e,y:t,spatialReference:i}=this;if(i){if(i.isWebMercator)return zA(e,t,h2)[0];if(i.isGeographic)return e}return null}set longitude(e){const{y:t,spatialReference:i}=this;i&&(i.isWebMercator?this._set("x",Tx(e,t,h2)[0]):i.isGeographic&&this._set("x",e),this._set("longitude",e))}writeX(e,t,i){t[i]=isNaN(e)?"NaN":e}readX(e){return typeof e=="string"?NaN:e}clone(){const e=new iI;return e.x=this.x,e.y=this.y,e.z=this.z,e.m=this.m,e.spatialReference=this.spatialReference,e}copy(e){return iI.copy(e,this),this}equals(e){if(R(e))return!1;const{x:t,y:i,z:r,m:s,spatialReference:n}=this,{z:o,m:a}=e;let{x:l,y:c,spatialReference:h}=e;if(!n.equals(h))if(n.isWebMercator&&h.isWGS84)[l,c]=Tx(l,c),h=n;else{if(!n.isWGS84||!h.isWebMercator)return!1;[l,c]=zA(l,c),h=n}return t===l&&i===c&&r===o&&s===a&&n.wkid===h.wkid}offset(e,t,i){return YSe(this,e,t,i)}normalize(){if(!this.spatialReference)return this;const e=s0(this.spatialReference);if(!e)return this;let t=this.x;const[i,r]=e.valid,s=2*r;let n;return t>r?(n=Math.ceil(Math.abs(t-r)/s),t-=n*s):t<i&&(n=Math.ceil(Math.abs(t-i)/s),t+=n*s),this._set("x",t),this}distance(e){return ZSe(this,e)}toArray(){const e=this.hasZ,t=this.hasM;return e&&t?[this.x,this.y,this.z,this.m]:e?[this.x,this.y,this.z]:t?[this.x,this.y,this.m]:[this.x,this.y]}toJSON(e){return this.write({},e)}};u([d({readOnly:!0})],ia.prototype,"cache",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!1,overridePolicy:null}}})],ia.prototype,"hasM",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!1,overridePolicy:null}}})],ia.prototype,"hasZ",null),u([d({type:Number})],ia.prototype,"latitude",null),u([d({type:Number})],ia.prototype,"longitude",null),u([d({type:Number,json:{type:[Number,String],write:{isRequired:!0,allowNull:!0}}}),At(e=>isNaN(e)?e:mu(e))],ia.prototype,"x",void 0),u([Fe("x")],ia.prototype,"writeX",null),u([De("x")],ia.prototype,"readX",null),u([d({type:Number,json:{write:!0}})],ia.prototype,"y",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.hasZ}}}}})],ia.prototype,"z",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.hasM}}}}})],ia.prototype,"m",void 0),ia=iI=u([P("esri.geometry.Point")],ia),ia.prototype.toJSON.isDefaultToJSON=!0;const et=ia;function w1(e){const t=e[0]*e[0]+e[4]*e[4]+e[8]*e[8],i=e[1]*e[1]+e[5]*e[5]+e[9]*e[9],r=e[2]*e[2]+e[6]*e[6]+e[10]*e[10];return Math.sqrt(Math.max(t,i,r))}function KSe(e,t){const i=Math.sqrt(t[0]*t[0]+t[4]*t[4]+t[8]*t[8]),r=Math.sqrt(t[1]*t[1]+t[5]*t[5]+t[9]*t[9]),s=Math.sqrt(t[2]*t[2]+t[6]*t[6]+t[10]*t[10]);return oe(e,i,r,s),e}function zft(e,t,i){i=i||e;const r=_e(e,t);oe(i,e[0]-r*t[0],e[1]-r*t[1],e[2]-r*t[2]),be(i,i)}function Bft(e,t,i){Math.abs(e[0])>Math.abs(e[1])?oe(t,0,1,0):oe(t,1,0,0),pt(i,e,t),be(t,t),pt(t,i,e),be(i,i)}function e2e(e,t){return(e%t+t)%t}function fM(e,t,i,r,s,n){const o=e+(t-e)*s;return o+(i+(r-i)*s-o)*n}function t2e(e,t,i,r=M()){const s=Pe(e),n=Pe(t),o=_e(e,t)/(s*n);if(o<.9999999999999999){const a=Math.acos(o),l=((1-i)*s+i*n)/Math.sin(a),c=l/s*Math.sin((1-i)*a),h=l/n*Math.sin(i*a);return ae(V_,e,c),ae(G_,t,h),pe(r,V_,G_)}return Cs(r,e,t,i)}function Vft(e,t,i,r=M(),s=M()){const n=Pe(e),o=Pe(t),a=_e(e,t)/(n*o);if(a<.9999999999999999){const l=Math.acos(a),c=Math.sin(l),h=Math.sin(i*l),p=Math.sin((1-i)*l),f=(1-i)*n+i*o;{const g=f/c,y=g/o*h;ae(V_,e,g/n*p),ae(G_,t,y),pe(r,V_,G_)}{const g=1/n*(-Math.cos((1-i)*l)*l*f+p*(-n+o));ae(V_,e,g);const y=1/o*(Math.cos(i*l)*l*f+h*(-n+o));ae(G_,t,y),pe(s,V_,G_),ae(s,s,1/c)}return s}return Cs(r,e,t,i),de(s,t,e),be(s,s),s}function y5(e,t,i){e=be(V_,e),t=be(G_,t);const r=Rs(_e(e,t));if(i){const s=pt(r2e,e,t);if(_e(s,i)<0)return-r}return r}function rI(e){const t=e.length;return function(i){if(i<=e[0][0])return e[0][1];if(i>=e[t-1][0])return e[t-1][1];let r=1;for(;i>e[r][0];)r++;const s=e[r-1][0],n=e[r][0],o=(n-i)/(n-s);return o*e[r-1][1]+(1-o)*e[r][1]}}class m0{constructor(t,i){this.min=t,this.max=i,this.range=i-t}ndiff(t,i=0){return Math.ceil((t-i)/this.range)*this.range+i}_normalize(t,i,r,s=0,n=!1){return(r-=s)<t?r+=this.ndiff(t-r):r>i&&(r-=this.ndiff(r-i)),n&&r===i&&(r=t),r+s}normalize(t,i=0,r=!1){return this._normalize(this.min,this.max,t,i,r)}clamp(t,i=0){return Be(t-i,this.min,this.max)+i}monotonic(t,i,r){return t<i?i:i+this.ndiff(t-i,r)}minimalMonotonic(t,i,r){return this._normalize(t,t+this.range,i,r)}center(t,i,r){return i=this.monotonic(t,i,r),this.normalize((t+i)/2,r)}diff(t,i,r){return this.monotonic(t,i,r)-t}shortestSignedDiff(t,i){t=this.normalize(t);const r=(i=this.normalize(i))-t,s=i<t?this.minimalMonotonic(t,i)-t:i-this.minimalMonotonic(i,t);return Math.abs(r)<Math.abs(s)?r:s}contains(t,i,r){return i=this.minimalMonotonic(t,i),(r=this.minimalMonotonic(t,r))>t&&r<i}}function Gft(e,t,i,r){de(gY,t,e),de(yY,i,e),pt(r,gY,yY),be(r,r),r[3]=-_e(e,r)}const gY=M(),yY=M();function $7(e){for(const t in e){const i=e[t];i instanceof Function&&(e[t]=i.bind(e))}return e}const i2e=$7(new m0(0,2*Math.PI)),g0=$7(new m0(-Math.PI,Math.PI)),D7=$7(new m0(0,360)),r2e=M(),V_=M(),G_=M();let mf=class extends Dp(fe){constructor(...e){super(...e),this.position=new et([0,0,0]),this.heading=0,this.tilt=0,this.fov=55}normalizeCtorArgs(e,t,i,r){if(e&&typeof e=="object"&&("x"in e||Array.isArray(e))){const s={position:e};return t!=null&&(s.heading=t),i!=null&&(s.tilt=i),r!=null&&(s.fov=r),s}return e}writePosition(e,t,i,r){const s=e.clone();s.x=mu(e.x||0),s.y=mu(e.y||0),s.z=e.hasZ?mu(e.z||0):e.z,t[i]=s.write({},r)}readPosition(e,t){const i=new et;return i.read(e,t),i.x=mu(i.x||0),i.y=mu(i.y||0),i.z=i.hasZ?mu(i.z||0):i.z,i}equals(e){return!!e&&this.tilt===e.tilt&&this.heading===e.heading&&this.fov===e.fov&&this.position.equals(e.position)}};u([d({type:et,json:{write:{isRequired:!0}}})],mf.prototype,"position",void 0),u([Fe("position")],mf.prototype,"writePosition",null),u([De("position")],mf.prototype,"readPosition",null),u([d({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),At(e=>D7.normalize(mu(e)))],mf.prototype,"heading",void 0),u([d({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),At(e=>Be(mu(e),-180,180))],mf.prototype,"tilt",void 0),u([d({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],mf.prototype,"fov",void 0),mf=u([P("esri.Camera")],mf);const _l=mf,v5=[0,0];function aO(e,t){return!!_(t)&&ca(e,t.x,t.y,t.z)}function jft(e,t){if(!t.points||t.points.length)return!1;for(const i of t.points)if(!MT(e,i))return!1;return!0}function s2e(e,t){const{xmin:i,ymin:r,zmin:s,xmax:n,ymax:o,zmax:a}=t;return e.hasZ&&t.hasZ?ca(e,i,r,s)&&ca(e,i,o,s)&&ca(e,n,o,s)&&ca(e,n,r,s)&&ca(e,i,r,a)&&ca(e,i,o,a)&&ca(e,n,o,a)&&ca(e,n,r,a):ca(e,i,r)&&ca(e,i,o)&&ca(e,n,o)&&ca(e,n,r)}function MT(e,t){return ca(e,t[0],t[1])}function n2e(e,t){return ca(e,t[0],t[1],t[2])}function ca(e,t,i,r){return t>=e.xmin&&t<=e.xmax&&i>=e.ymin&&i<=e.ymax&&(r==null||!e.hasZ||r>=e.zmin&&r<=e.zmax)}function o2e(e,t){return v5[1]=t.y,v5[0]=t.x,Mae(e,v5)}function Mae(e,t){return a2e(e.rings,t)}function a2e(e,t){if(!e)return!1;if(l2e(e))return vY(!1,e,t);let i=!1;for(let r=0,s=e.length;r<s;r++)i=vY(i,e[r],t);return i}function l2e(e){return!Array.isArray(e[0][0])}function vY(e,t,i){const[r,s]=i;let n=e,o=0;for(let a=0,l=t.length;a<l;a++){o++,o===l&&(o=0);const[c,h]=t[a],[p,f]=t[o];(h<s&&f>=s||f<s&&h>=s)&&c+(s-h)/(f-h)*(p-c)<r&&(n=!n)}return n}function c2e(e,t){return aO(e,t)}function u2e(e,t){const i=e.hasZ&&t.hasZ;let r,s,n;if(e.xmin<=t.xmin){if(r=t.xmin,e.xmax<r)return!1}else if(r=e.xmin,t.xmax<r)return!1;if(e.ymin<=t.ymin){if(s=t.ymin,e.ymax<s)return!1}else if(s=e.ymin,t.ymax<s)return!1;if(i&&t.hasZ){if(e.zmin<=t.zmin){if(n=t.zmin,e.zmax<n)return!1}else if(n=e.zmin,t.zmax<n)return!1}return!0}function h2e(e,t){const{points:i,hasZ:r}=t,s=r?n2e:MT;for(const n of i)if(s(e,n))return!0;return!1}const x1=[0,0],T1=[0,0],S1=[0,0],E1=[0,0],d2e=[x1,T1,S1,E1],Pae=[[S1,x1],[x1,T1],[T1,E1],[E1,S1]];function p2e(e,t){x1[0]=e.xmin,x1[1]=e.ymax,T1[0]=e.xmax,T1[1]=e.ymax,S1[0]=e.xmin,S1[1]=e.ymin,E1[0]=e.xmax,E1[1]=e.ymin;for(const i of d2e)if(Mae(t,i))return!0;for(const i of t.rings){if(!i.length)continue;let r=i[0];if(MT(e,r))return!0;for(let s=1;s<i.length;s++){const n=i[s];if(MT(e,n)||Iae(r,n,Pae))return!0;r=n}}return!1}function f2e(e,t){x1[0]=e.xmin,x1[1]=e.ymax,T1[0]=e.xmax,T1[1]=e.ymax,S1[0]=e.xmin,S1[1]=e.ymin,E1[0]=e.xmax,E1[1]=e.ymin;const i=t.paths;for(const r of i){if(!i.length)continue;let s=r[0];if(MT(e,s))return!0;for(let n=1;n<r.length;n++){const o=r[n];if(MT(e,o)||Iae(s,o,Pae))return!0;s=o}}return!1}const En=[0,0];function m2e(e){for(let t=0;t<e.length;t++){const i=e[t];for(let s=0;s<i.length-1;s++){const n=i[s],o=i[s+1];for(let a=t+1;a<e.length;a++)for(let l=0;l<e[a].length-1;l++){const c=e[a][l],h=e[a][l+1];if(w6(n,o,c,h,En)&&!(En[0]===n[0]&&En[1]===n[1]||En[0]===c[0]&&En[1]===c[1]||En[0]===o[0]&&En[1]===o[1]||En[0]===h[0]&&En[1]===h[1]))return!0}}const r=i.length;if(!(r<=4))for(let s=0;s<r-3;s++){let n=r-1;s===0&&(n=r-2);const o=i[s],a=i[s+1];for(let l=s+2;l<n;l++){const c=i[l],h=i[l+1];if(w6(o,a,c,h,En)&&!(En[0]===o[0]&&En[1]===o[1]||En[0]===c[0]&&En[1]===c[1]||En[0]===a[0]&&En[1]===a[1]||En[0]===h[0]&&En[1]===h[1]))return!0}}}return!1}function Iae(e,t,i){for(let r=0;r<i.length;r++)if(w6(e,t,i[r][0],i[r][1]))return!0;return!1}function w6(e,t,i,r,s){const[n,o]=e,[a,l]=t,[c,h]=i,[p,f]=r,g=p-c,y=n-c,v=a-n,b=f-h,w=o-h,S=l-o,T=b*v-g*S;if(T===0)return!1;const A=(g*w-b*y)/T,C=(v*w-S*y)/T;return A>=0&&A<=1&&C>=0&&C<=1&&(s&&(s[0]=n+A*(a-n),s[1]=o+A*(l-o)),!0)}function g2e(e){switch(e){case"esriGeometryEnvelope":case"extent":return u2e;case"esriGeometryMultipoint":case"multipoint":return h2e;case"esriGeometryPoint":case"point":return c2e;case"esriGeometryPolygon":case"polygon":return p2e;case"esriGeometryPolyline":case"polyline":return f2e}}var qc;function y2e(e){return e&&(e.declaredClass==="esri.geometry.SpatialReference"||e.wkid!=null)}function rg(e,t,i){return t==null?i:i==null?t:e(t,i)}let on=qc=class extends vl{constructor(...e){super(...e),this.type="extent",this.xmin=0,this.ymin=0,this.mmin=void 0,this.zmin=void 0,this.xmax=0,this.ymax=0,this.mmax=void 0,this.zmax=void 0}normalizeCtorArgs(e,t,i,r,s){return y2e(e)?{spatialReference:e,xmin:0,ymin:0,xmax:0,ymax:0}:typeof e=="object"?(e.spatialReference=e.spatialReference==null?He.WGS84:e.spatialReference,e):{xmin:e,ymin:t,xmax:i,ymax:r,spatialReference:s==null?He.WGS84:s}}static fromBounds(e,t){return new qc({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:t})}static fromPoint(e){return new qc({xmin:e.x,ymin:e.y,zmin:e.z,xmax:e.x,ymax:e.y,zmax:e.z,spatialReference:e.spatialReference})}get cache(){return this.commitProperty("xmin"),this.commitProperty("ymin"),this.commitProperty("zmin"),this.commitProperty("mmin"),this.commitProperty("xmax"),this.commitProperty("ymax"),this.commitProperty("zmax"),this.commitProperty("mmax"),this.commitProperty("spatialReference"),{}}get center(){const e=new et({x:.5*(this.xmin+this.xmax),y:.5*(this.ymin+this.ymax),spatialReference:this.spatialReference});return this.hasZ&&(e.z=.5*(this.zmin+this.zmax)),this.hasM&&(e.m=.5*(this.mmin+this.mmax)),e}get extent(){return this.clone()}get hasM(){return this.mmin!=null&&this.mmax!=null}get hasZ(){return this.zmin!=null&&this.zmax!=null}get height(){return Math.abs(this.ymax-this.ymin)}get width(){return Math.abs(this.xmax-this.xmin)}centerAt(e){const t=this.center;return e.z!=null&&this.hasZ?this.offset(e.x-t.x,e.y-t.y,e.z-t.z):this.offset(e.x-t.x,e.y-t.y)}clone(){const e=new qc;return e.xmin=this.xmin,e.ymin=this.ymin,e.xmax=this.xmax,e.ymax=this.ymax,e.spatialReference=this.spatialReference,this.zmin!=null&&(e.zmin=this.zmin,e.zmax=this.zmax),this.mmin!=null&&(e.mmin=this.mmin,e.mmax=this.mmax),e}contains(e){if(!e)return!1;const t=this.spatialReference,i=e.spatialReference;return t&&i&&!t.equals(i)&&pm(t,i)&&(e=t.isWebMercator?fm(e):SE(e,!0)),e.type==="point"?aO(this,e):e.type==="extent"&&s2e(this,e)}equals(e){if(this===e)return!0;if(R(e))return!1;const t=this.spatialReference,i=e.spatialReference;return t&&i&&!t.equals(i)&&pm(t,i)&&(e=t.isWebMercator?fm(e):SE(e,!0)),this.xmin===e.xmin&&this.ymin===e.ymin&&this.zmin===e.zmin&&this.mmin===e.mmin&&this.xmax===e.xmax&&this.ymax===e.ymax&&this.zmax===e.zmax&&this.mmax===e.mmax}expand(e){const t=.5*(1-e),i=this.width*t,r=this.height*t;if(this.xmin+=i,this.ymin+=r,this.xmax-=i,this.ymax-=r,this.hasZ){const s=(this.zmax-this.zmin)*t;this.zmin+=s,this.zmax-=s}if(this.hasM){const s=(this.mmax-this.mmin)*t;this.mmin+=s,this.mmax-=s}return this}intersects(e){if(R(e))return!1;e.type==="mesh"&&(e=e.extent);const t=this.spatialReference,i=e.spatialReference;return t&&i&&!t.equals(i)&&pm(t,i)&&(e=t.isWebMercator?fm(e):SE(e,!0)),g2e(e.type)(this,e)}normalize(){const e=this._normalize(!1,!0);return Array.isArray(e)?e:[e]}offset(e,t,i){return this.xmin+=e,this.ymin+=t,this.xmax+=e,this.ymax+=t,i!=null&&(this.zmin+=i,this.zmax+=i),this}shiftCentralMeridian(){return this._normalize(!0)}union(e){return this===e||(this.xmin=Math.min(this.xmin,e.xmin),this.ymin=Math.min(this.ymin,e.ymin),this.xmax=Math.max(this.xmax,e.xmax),this.ymax=Math.max(this.ymax,e.ymax),(this.hasZ||e.hasZ)&&(this.zmin=rg(Math.min,this.zmin,e.zmin),this.zmax=rg(Math.max,this.zmax,e.zmax)),(this.hasM||e.hasM)&&(this.mmin=rg(Math.min,this.mmin,e.mmin),this.mmax=rg(Math.max,this.mmax,e.mmax))),this}intersection(e){return this===e?this:R(e)||!this.intersects(e)?null:(this.xmin=Math.max(this.xmin,e.xmin),this.ymin=Math.max(this.ymin,e.ymin),this.xmax=Math.min(this.xmax,e.xmax),this.ymax=Math.min(this.ymax,e.ymax),(this.hasZ||e.hasZ)&&(this.zmin=rg(Math.max,this.zmin,e.zmin),this.zmax=rg(Math.min,this.zmax,e.zmax)),(this.hasM||e.hasM)&&(this.mmin=rg(Math.max,this.mmin,e.mmin),this.mmax=rg(Math.min,this.mmax,e.mmax)),this)}toJSON(e){return this.write({},e)}_shiftCM(e=s0(this.spatialReference)){if(!e||!this.spatialReference)return this;const t=this.spatialReference,i=this._getCM(e);if(i){const r=t.isWebMercator?SE(i):i;this.xmin-=i.x,this.xmax-=i.x,t.isWebMercator||(r.x=this._normalizeX(r.x,e).x),this.spatialReference=new He(_p(t.isWGS84?e.altTemplate:e.wkTemplate,{Central_Meridian:r.x}))}return this}_getCM(e){let t=null;const[i,r]=e.valid,s=this.xmin,n=this.xmax;return s>=i&&s<=r&&n>=i&&n<=r||(t=this.center),t}_normalize(e,t,i){const r=this.spatialReference;if(!r)return this;if(!(i=i||s0(r)))return this;const s=this._getParts(i).map(a=>a.extent);if(s.length<2)return s[0]||this;if(s.length>2)return e?this._shiftCM(i):this.set({xmin:i.valid[0],xmax:i.valid[1]});if(e)return this._shiftCM(i);if(t)return s;let n=!0,o=!0;return s.forEach(a=>{a.hasZ||(n=!1),a.hasM||(o=!1)}),{rings:s.map(a=>{const l=[[a.xmin,a.ymin],[a.xmin,a.ymax],[a.xmax,a.ymax],[a.xmax,a.ymin],[a.xmin,a.ymin]];if(n){const c=(a.zmax-a.zmin)/2;for(let h=0;h<l.length;h++)l[h].push(c)}if(o){const c=(a.mmax-a.mmin)/2;for(let h=0;h<l.length;h++)l[h].push(c)}return l}),hasZ:n,hasM:o,spatialReference:r}}_getParts(e){let t=this.cache._parts;if(!t){t=[];const{ymin:s,ymax:n,spatialReference:o}=this,a=this.width,l=this.xmin,c=this.xmax;let h;e=e||s0(o);const[p,f]=e.valid;h=this._normalizeX(this.xmin,e);const g=h.x,y=h.frameId;h=this._normalizeX(this.xmax,e);const v=h.x,b=h.frameId,w=g===v&&a>0;if(a>2*f){const S=new qc(l<c?g:v,s,f,n,o),T=new qc(p,s,l<c?v:g,n,o),A=new qc(0,s,f,n,o),C=new qc(p,s,0,n,o),O=[],L=[];S.contains(A)&&O.push(y),S.contains(C)&&L.push(y),T.contains(A)&&O.push(b),T.contains(C)&&L.push(b);for(let U=y+1;U<b;U++)O.push(U),L.push(U);t.push({extent:S,frameIds:[y]},{extent:T,frameIds:[b]},{extent:A,frameIds:O},{extent:C,frameIds:L})}else g>v||w?t.push({extent:new qc(g,s,f,n,o),frameIds:[y]},{extent:new qc(p,s,v,n,o),frameIds:[b]}):t.push({extent:new qc(g,s,v,n,o),frameIds:[y]});this.cache._parts=t}const i=this.hasZ,r=this.hasM;if(i||r){const s={};i&&(s.zmin=this.zmin,s.zmax=this.zmax),r&&(s.mmin=this.mmin,s.mmax=this.mmax);for(let n=0;n<t.length;n++)t[n].extent.set(s)}return t}_normalizeX(e,t){const[i,r]=t.valid,s=2*r;let n,o=0;return e>r?(n=Math.ceil(Math.abs(e-r)/s),e-=n*s,o=n):e<i&&(n=Math.ceil(Math.abs(e-i)/s),e+=n*s,o=-n),{x:e,frameId:o}}};u([d({readOnly:!0})],on.prototype,"cache",null),u([d({readOnly:!0})],on.prototype,"center",null),u([d({readOnly:!0})],on.prototype,"extent",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:null}}})],on.prototype,"hasM",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:null}}})],on.prototype,"hasZ",null),u([d({readOnly:!0})],on.prototype,"height",null),u([d({readOnly:!0})],on.prototype,"width",null),u([d({type:Number,json:{type:[Number,String],write:{enabled:!0,allowNull:!0}}})],on.prototype,"xmin",void 0),u([d({type:Number,json:{write:!0}})],on.prototype,"ymin",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasM}}}}})],on.prototype,"mmin",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasZ}}}}})],on.prototype,"zmin",void 0),u([d({type:Number,json:{write:!0}})],on.prototype,"xmax",void 0),u([d({type:Number,json:{write:!0}})],on.prototype,"ymax",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasM}}}}})],on.prototype,"mmax",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasZ}}}}})],on.prototype,"zmax",void 0),on=qc=u([P("esri.geometry.Extent")],on),on.prototype.toJSON.isDefaultToJSON=!0;const Xt=on;function PT(e,t,i=!1){let{hasM:r,hasZ:s}=e;Array.isArray(t)?t.length!==4||r||s?t.length===3&&i&&!r?(s=!0,r=!1):t.length===3&&r&&s&&(r=!1,s=!1):(r=!0,s=!0):(s=!s&&t.hasZ&&(!r||t.hasM),r=!r&&t.hasM&&(!s||t.hasZ)),e.hasZ=s,e.hasM=r}var x6;function _Y(e){return(t,i)=>t==null?i:i==null?t:e(t,i)}function v2e(e){return e&&(e.declaredClass==="esri.geometry.SpatialReference"||e.wkid!=null)}let Ug=x6=class extends vl{constructor(...e){super(...e),this.points=[],this.type="multipoint"}normalizeCtorArgs(e,t){if(!e&&!t)return null;const i={};Array.isArray(e)?(i.points=e,i.spatialReference=t):v2e(e)?i.spatialReference=e:(e.points&&(i.points=e.points),e.spatialReference&&(i.spatialReference=e.spatialReference),e.hasZ&&(i.hasZ=e.hasZ),e.hasM&&(i.hasM=e.hasM));const r=i.points&&i.points[0];return r&&(i.hasZ===void 0&&i.hasM===void 0?(i.hasZ=r.length>2,i.hasM=!1):i.hasZ===void 0?i.hasZ=r.length>3:i.hasM===void 0&&(i.hasM=r.length>3)),i}get cache(){return this.commitProperty("points"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get extent(){const e=this.points;if(!e.length)return null;const t=new Xt,i=this.hasZ,r=this.hasM,s=i?3:2,n=e[0],o=_Y(Math.min),a=_Y(Math.max);let l,c,h,p,[f,g]=n,[y,v]=n;for(let b=0,w=e.length;b<w;b++){const S=e[b],[T,A]=S;if(f=o(f,T),g=o(g,A),y=a(y,T),v=a(v,A),i&&S.length>2){const C=S[2];l=o(l,C),h=a(h,C)}if(r&&S.length>s){const C=S[s];c=o(c,C),p=a(p,C)}}return t.xmin=f,t.ymin=g,t.xmax=y,t.ymax=v,t.spatialReference=this.spatialReference,i?(t.zmin=l,t.zmax=h):(t.zmin=null,t.zmax=null),r?(t.mmin=c,t.mmax=p):(t.mmin=null,t.mmax=null),t}writePoints(e,t){t.points=se(this.points)}addPoint(e){return PT(this,e),Array.isArray(e)?this.points.push(e):this.points.push(e.toArray()),this.notifyChange("points"),this}clone(){const e={points:se(this.points),spatialReference:this.spatialReference};return this.hasZ&&(e.hasZ=!0),this.hasM&&(e.hasM=!0),new x6(e)}getPoint(e){if(!this._validateInputs(e))return null;const t=this.points[e],i={x:t[0],y:t[1],spatialReference:this.spatialReference};let r=2;return this.hasZ&&(i.z=t[2],r=3),this.hasM&&(i.m=t[r]),new et(i)}removePoint(e){if(!this._validateInputs(e))return null;const t=new et(this.points.splice(e,1)[0],this.spatialReference);return this.notifyChange("points"),t}setPoint(e,t){return this._validateInputs(e)?(PT(this,t),Array.isArray(t)||(t=t.toArray()),this.points[e]=t,this.notifyChange("points"),this):this}toJSON(e){return this.write({},e)}_validateInputs(e){return e!=null&&e>=0&&e<this.points.length}};u([d({readOnly:!0})],Ug.prototype,"cache",null),u([d()],Ug.prototype,"extent",null),u([d({type:[[Number]],json:{write:{isRequired:!0}}})],Ug.prototype,"points",void 0),u([Fe("points")],Ug.prototype,"writePoints",null),Ug=x6=u([P("esri.geometry.Multipoint")],Ug),Ug.prototype.toJSON.isDefaultToJSON=!0;const nb=Ug;function L7(e,t){const i=t[0]-e[0],r=t[1]-e[1];if(e.length>2&&t.length>2){const s=e[2]-t[2];return Math.sqrt(i*i+r*r+s*s)}return Math.sqrt(i*i+r*r)}function $ae(e,t,i){const r=e[0]+i*(t[0]-e[0]),s=e[1]+i*(t[1]-e[1]);return e.length>2&&t.length>2?[r,s,e[2]+i*(t[2]-e[2])]:[r,s]}function _2e(e,t){return $ae(e,t,.5)}function Dae(e){const t=e.length;let i=0;for(let r=0;r<t-1;++r)i+=L7(e[r],e[r+1]);return i}function Lae(e,t){if(t<=0)return e[0];const i=e.length;let r=0;for(let s=0;s<i-1;++s){const n=L7(e[s],e[s+1]);if(t-r<n){const o=(t-r)/n;return $ae(e[s],e[s+1],o)}r+=n}return e[i-1]}function N7(e,t,i){const r=e.length;let s=0,n=0,o=0;for(let a=0;a<r;a++){const l=e[a],c=e[(a+1)%r];let h=2;s+=l[0]*c[1]-c[0]*l[1],l.length>2&&c.length>2&&i&&(n+=l[0]*c[2]-c[0]*l[2],h=3),l.length>h&&c.length>h&&t&&(o+=l[0]*c[h]-c[0]*l[h])}return s<=0&&n<=0&&o<=0}function Hft(e){return e?e.hasZ?[e.xmax-e.xmin/2,e.ymax-e.ymin/2,e.zmax-e.zmin/2]:[e.xmax-e.xmin/2,e.ymax-e.ymin/2]:null}function b2e(e){return e?Nae(e.rings,e.hasZ):null}function Nae(e,t){if(!e||!e.length)return null;const i=[],r=[],s=t?[1/0,-1/0,1/0,-1/0,1/0,-1/0]:[1/0,-1/0,1/0,-1/0];for(let n=0,o=e.length;n<o;n++){const a=w2e(e[n],t,s);a&&r.push(a)}if(r.sort((n,o)=>{let a=n[2]-o[2];return a===0&&t&&(a=n[4]-o[4]),a}),r.length&&(i[0]=r[0][0],i[1]=r[0][1],t&&(i[2]=r[0][3]),(i[0]<s[0]||i[0]>s[1]||i[1]<s[2]||i[1]>s[3]||t&&(i[2]<s[4]||i[2]>s[5]))&&(i.length=0)),!i.length){const n=e[0]&&e[0].length?x2e(e[0],t):null;if(!n)return null;i[0]=n[0],i[1]=n[1],t&&n.length>2&&(i[2]=n[2])}return i}function w2e(e,t,i){let r=0,s=0,n=0,o=0,a=0;const l=e.length?e[0][0]:0,c=e.length?e[0][1]:0,h=e.length&&t?e[0][2]:0;for(let f=0;f<e.length;f++){const g=e[f],y=e[(f+1)%e.length],[v,b,w]=g,S=v-l,T=b-c,A=t?w-h:void 0,[C,O,L]=y,U=C-l,N=O-c,z=t?L-h:void 0,V=S*N-U*T;if(o+=V,r+=(S+U)*V,s+=(T+N)*V,t&&g.length>2&&y.length>2){const B=S*z-U*A;n+=(A+z)*B,a+=B}v<i[0]&&(i[0]=v),v>i[1]&&(i[1]=v),b<i[2]&&(i[2]=b),b>i[3]&&(i[3]=b),t&&(w<i[4]&&(i[4]=w),w>i[5]&&(i[5]=w))}if(o>0&&(o*=-1),a>0&&(a*=-1),!o)return null;o*=.5,a*=.5;const p=[r/(6*o)+l,s/(6*o)+c,o];return t&&(i[4]===i[5]||a===0?(p[3]=(i[4]+i[5])/2,p[4]=0):(p[3]=n/(6*a)+h,p[4]=a)),p}function x2e(e,t){const i=t?[0,0,0]:[0,0],r=t?[0,0,0]:[0,0];let s=0,n=0,o=0,a=0;for(let l=0,c=e.length;l<c-1;l++){const h=e[l],p=e[l+1];if(h&&p){i[0]=h[0],i[1]=h[1],r[0]=p[0],r[1]=p[1],t&&h.length>2&&p.length>2&&(i[2]=h[2],r[2]=p[2]);const f=L7(i,r);if(f){s+=f;const g=_2e(h,p);n+=f*g[0],o+=f*g[1],t&&g.length>2&&(a+=f*g[2])}}}return s>0?t?[n/s,o/s,a/s]:[n/s,o/s]:e.length?e[0]:null}function Fae(e){return e.xmin!==void 0&&e.ymin!==void 0&&e.xmax!==void 0&&e.ymax!==void 0}function Uae(e){return e.points!==void 0}function kae(e){return e.x!==void 0&&e.y!==void 0}function zae(e){return e.paths!==void 0}function Bae(e){return e.rings!==void 0}function Vae(e){return(t,i)=>t==null?i:i==null?t:e(t,i)}const Fy=Vae(Math.min),Uy=Vae(Math.max);function qft(e,t){return zae(t)?IT(e,t.paths,!1,!1):Bae(t)?IT(e,t.rings,!1,!1):Uae(t)?F7(e,t.points,!1,!1,!1,!1):Fae(t)?Gae(e,t):(kae(t)&&(e[0]=t.x,e[1]=t.y,e[2]=t.x,e[3]=t.y),e)}function Wft(e,t){return zae(t)?IT(e,t.paths,!0,!1):Bae(t)?IT(e,t.rings,!0,!1):Uae(t)?F7(e,t.points,!0,!1,!0,!1):Fae(t)?Gae(e,t,!0,!1,!0,!1):(kae(t)&&(e[0]=t.x,e[1]=t.y,e[2]=t.z,e[3]=t.x,e[4]=t.y,e[5]=t.z),e)}function IT(e,t,i,r){const s=i?3:2;if(!t.length||!t[0].length)return null;let n,o,a,l,[c,h]=t[0][0],[p,f]=t[0][0];for(let g=0;g<t.length;g++){const y=t[g];for(let v=0;v<y.length;v++){const b=y[v],[w,S]=b;if(c=Fy(c,w),h=Fy(h,S),p=Uy(p,w),f=Uy(f,S),i&&b.length>2){const T=b[2];n=Fy(n,T),o=Uy(o,T)}if(r&&b.length>s){const T=b[s];a=Fy(n,T),l=Uy(o,T)}}}return i?r?(e[0]=c,e[1]=h,e[2]=n,e[3]=a,e[4]=p,e[5]=f,e[6]=o,e[7]=l,e.length=8,e):(e[0]=c,e[1]=h,e[2]=n,e[3]=p,e[4]=f,e[5]=o,e.length=6,e):r?(e[0]=c,e[1]=h,e[2]=a,e[3]=p,e[4]=f,e[5]=l,e.length=6,e):(e[0]=c,e[1]=h,e[2]=p,e[3]=f,e.length=4,e)}function Gae(e,t,i,r,s,n){const o=t.xmin,a=t.xmax,l=t.ymin,c=t.ymax;let h=t.zmin,p=t.zmax,f=t.mmin,g=t.mmax;return s?(h=h||0,p=p||0,n?(f=f||0,g=g||0,e[0]=o,e[1]=l,e[2]=h,e[3]=f,e[4]=a,e[5]=c,e[6]=p,e[7]=g,e):(e[0]=o,e[1]=l,e[2]=h,e[3]=a,e[4]=c,e[5]=p,e)):n?(f=f||0,g=g||0,e[0]=o,e[1]=l,e[2]=f,e[3]=a,e[4]=c,e[5]=g,e):(e[0]=o,e[1]=l,e[2]=a,e[3]=c,e)}function F7(e,t,i,r,s,n){const o=i?3:2,a=r&&n,l=i&&s;if(!t.length||!t[0].length)return null;let c,h,p,f,[g,y]=t[0],[v,b]=t[0];for(let w=0;w<t.length;w++){const S=t[w],[T,A]=S;if(g=Fy(g,T),y=Fy(y,A),v=Uy(v,T),b=Uy(b,A),l&&S.length>2){const C=S[2];c=Fy(c,C),h=Uy(h,C)}if(a&&S.length>o){const C=S[o];p=Fy(c,C),f=Uy(h,C)}}return s?(c=c||0,h=h||0,n?(p=p||0,f=f||0,e[0]=g,e[1]=y,e[2]=c,e[3]=p,e[4]=v,e[5]=b,e[6]=h,e[7]=f,e):(e[0]=g,e[1]=y,e[2]=c,e[3]=v,e[4]=b,e[5]=h,e)):n?(p=p||0,f=f||0,e[0]=g,e[1]=y,e[2]=p,e[3]=v,e[4]=b,e[5]=f,e):(e[0]=g,e[1]=y,e[2]=v,e[3]=b,e)}function T2e(e){return e.xmin!==void 0&&e.ymin!==void 0&&e.xmax!==void 0&&e.ymax!==void 0}function S2e(e){return e.points!==void 0}function E2e(e){return e.x!==void 0&&e.y!==void 0}function A2e(e){return e.paths!==void 0}function C2e(e){return e.rings!==void 0}const U7=[];function jae(e,t,i,r){return{xmin:e,ymin:t,xmax:i,ymax:r}}function Hae(e,t,i,r,s,n){return{xmin:e,ymin:t,zmin:i,xmax:r,ymax:s,zmax:n}}function qae(e,t,i,r,s,n){return{xmin:e,ymin:t,mmin:i,xmax:r,ymax:s,mmax:n}}function Wae(e,t,i,r,s,n,o,a){return{xmin:e,ymin:t,zmin:i,mmin:r,xmax:s,ymax:n,zmax:o,mmax:a}}function k7(e,t=!1,i=!1){return t?i?Wae(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7]):Hae(e[0],e[1],e[2],e[3],e[4],e[5]):i?qae(e[0],e[1],e[2],e[3],e[4],e[5]):jae(e[0],e[1],e[2],e[3])}function Xft(e){return e?T2e(e)?e:E2e(e)?O2e(e):C2e(e)?Xae(e):A2e(e)?Yae(e):S2e(e)?R2e(e):null:null}function R2e(e){const{hasZ:t,hasM:i,points:r}=e;return k7(F7(U7,r,t,i),t,i)}function O2e(e){const{x:t,y:i,z:r,m:s}=e,n=s!=null;return r!=null?n?Wae(t,i,r,s,t,i,r,s):Hae(t,i,r,t,i,r):n?qae(t,i,s,t,i,s):jae(t,i,t,i)}function Xae(e){const{hasZ:t,hasM:i,rings:r}=e,s=IT(U7,r,t,i);return s?k7(s,t,i):null}function Yae(e){const{hasZ:t,hasM:i,paths:r}=e,s=IT(U7,r,t,i);return s?k7(s,t,i):null}var sI;function bY(e){return!Array.isArray(e[0])}let Md=sI=class extends vl{constructor(...e){super(...e),this.rings=[],this.type="polygon"}static fromExtent(e){const t=e.clone().normalize(),i=e.spatialReference;let r=!1,s=!1;for(const o of t)o.hasZ&&(r=!0),o.hasM&&(s=!0);const n={rings:t.map(function(o){const a=[[o.xmin,o.ymin],[o.xmin,o.ymax],[o.xmax,o.ymax],[o.xmax,o.ymin],[o.xmin,o.ymin]];if(r&&o.hasZ){const l=o.zmin+.5*(o.zmax-o.zmin);for(let c=0;c<a.length;c++)a[c].push(l)}if(s&&o.hasM){const l=o.mmin+.5*(o.mmax-o.mmin);for(let c=0;c<a.length;c++)a[c].push(l)}return a}),spatialReference:i};return r&&(n.hasZ=!0),s&&(n.hasM=!0),new sI(n)}normalizeCtorArgs(e,t){let i,r,s=null,n=null;return e&&!Array.isArray(e)?(s=e.rings?e.rings:null,t||(e.spatialReference?t=e.spatialReference:e.rings||(t=e)),i=e.hasZ,r=e.hasM):s=e,s=s||[],t=t||He.WGS84,s.length&&s[0]&&s[0][0]!=null&&typeof s[0][0]=="number"&&(s=[s]),n=s[0]&&s[0][0],n&&(i===void 0&&r===void 0?(i=n.length>2,r=n.length>3):i===void 0?i=r?n.length>3:n.length>2:r===void 0&&(r=i?n.length>3:n.length>2)),{rings:s,spatialReference:t,hasZ:i,hasM:r}}get cache(){return this.commitProperty("rings"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get centroid(){const e=b2e(this);if(!e||isNaN(e[0])||isNaN(e[1])||this.hasZ&&isNaN(e[2]))return null;const t=new et;return t.x=e[0],t.y=e[1],t.spatialReference=this.spatialReference,this.hasZ&&(t.z=e[2]),t}get extent(){const{spatialReference:e}=this,t=Xae(this);if(!t)return null;const i=new Xt(t);return i.spatialReference=e,i}get isSelfIntersecting(){return m2e(this.rings)}writeRings(e,t){t.rings=se(this.rings)}addRing(e){if(!e)return;const t=this.rings,i=t.length;if(bY(e)){const r=[];for(let s=0,n=e.length;s<n;s++)r[s]=e[s].toArray();t[i]=r}else t[i]=e.concat();return this.notifyChange("rings"),this}clone(){const e=new sI;return e.spatialReference=this.spatialReference,e.rings=se(this.rings),e.hasZ=this.hasZ,e.hasM=this.hasM,e}equals(e){if(this===e)return!0;if(R(e))return!1;const t=this.spatialReference,i=e.spatialReference;if(_(t)!==_(i)||_(t)&&_(i)&&!t.equals(i)||this.rings.length!==e.rings.length)return!1;const r=([s,n,o,a],[l,c,h,p])=>s===l&&n===c&&(o==null&&h==null||o===h)&&(a==null&&p==null||a===p);for(let s=0;s<this.rings.length;s++){const n=this.rings[s],o=e.rings[s];if(!y1(n,o,r))return!1}return!0}contains(e){if(!e)return!1;const t=sb(e,this.spatialReference);return o2e(this,_(t)?t:e)}isClockwise(e){let t;return t=bY(e)?e.map(i=>this.hasZ?this.hasM?[i.x,i.y,i.z,i.m]:[i.x,i.y,i.z]:[i.x,i.y]):e,N7(t,this.hasM,this.hasZ)}getPoint(e,t){if(!this._validateInputs(e,t))return null;const i=this.rings[e][t],r=this.hasZ,s=this.hasM;return r&&!s?new et(i[0],i[1],i[2],void 0,this.spatialReference):s&&!r?new et(i[0],i[1],void 0,i[2],this.spatialReference):r&&s?new et(i[0],i[1],i[2],i[3],this.spatialReference):new et(i[0],i[1],this.spatialReference)}insertPoint(e,t,i){return this._validateInputs(e,t,!0)?(PT(this,i),Array.isArray(i)||(i=i.toArray()),this.rings[e].splice(t,0,i),this.notifyChange("rings"),this):this}removePoint(e,t){if(!this._validateInputs(e,t))return null;const i=new et(this.rings[e].splice(t,1)[0],this.spatialReference);return this.notifyChange("rings"),i}removeRing(e){if(!this._validateInputs(e,null))return null;const t=this.rings.splice(e,1)[0],i=this.spatialReference,r=t.map(s=>new et(s,i));return this.notifyChange("rings"),r}setPoint(e,t,i){return this._validateInputs(e,t)?(PT(this,i),Array.isArray(i)||(i=i.toArray()),this.rings[e][t]=i,this.notifyChange("rings"),this):this}_validateInputs(e,t,i=!1){if(e==null||e<0||e>=this.rings.length)return!1;if(t!=null){const r=this.rings[e];if(i&&(t<0||t>r.length)||!i&&(t<0||t>=r.length))return!1}return!0}toJSON(e){return this.write({},e)}};u([d({readOnly:!0})],Md.prototype,"cache",null),u([d({readOnly:!0})],Md.prototype,"centroid",null),u([d({readOnly:!0})],Md.prototype,"extent",null),u([d({readOnly:!0})],Md.prototype,"isSelfIntersecting",null),u([d({type:[[[Number]]],json:{write:{isRequired:!0}}})],Md.prototype,"rings",void 0),u([Fe("rings")],Md.prototype,"writeRings",null),Md=sI=u([P("esri.geometry.Polygon")],Md),Md.prototype.toJSON.isDefaultToJSON=!0;const bc=Md;var T6;function M2e(e){return!Array.isArray(e[0])}let kg=T6=class extends vl{constructor(...e){super(...e),this.paths=[],this.type="polyline"}normalizeCtorArgs(e,t){let i,r,s=null,n=null;return e&&!Array.isArray(e)?(s=e.paths?e.paths:null,t||(e.spatialReference?t=e.spatialReference:e.paths||(t=e)),i=e.hasZ,r=e.hasM):s=e,s=s||[],t=t||He.WGS84,s.length&&s[0]&&s[0][0]!=null&&typeof s[0][0]=="number"&&(s=[s]),n=s[0]&&s[0][0],n&&(i===void 0&&r===void 0?(i=n.length>2,r=!1):i===void 0?i=!r&&n.length>3:r===void 0&&(r=!i&&n.length>3)),{paths:s,spatialReference:t,hasZ:i,hasM:r}}get cache(){return this.commitProperty("paths"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get extent(){const{spatialReference:e}=this,t=Yae(this);if(!t)return null;const i=new Xt(t);return i.spatialReference=e,i}writePaths(e,t){t.paths=se(this.paths)}addPath(e){if(!e)return;const t=this.paths,i=t.length;if(M2e(e)){const r=[];for(let s=0,n=e.length;s<n;s++)r[s]=e[s].toArray();t[i]=r}else t[i]=e.concat();return this.notifyChange("paths"),this}clone(){const e=new T6;return e.spatialReference=this.spatialReference,e.paths=se(this.paths),e.hasZ=this.hasZ,e.hasM=this.hasM,e}getPoint(e,t){if(!this._validateInputs(e,t))return null;const i=this.paths[e][t],r=this.hasZ,s=this.hasM;return r&&!s?new et(i[0],i[1],i[2],void 0,this.spatialReference):s&&!r?new et(i[0],i[1],void 0,i[2],this.spatialReference):r&&s?new et(i[0],i[1],i[2],i[3],this.spatialReference):new et(i[0],i[1],this.spatialReference)}insertPoint(e,t,i){return this._validateInputs(e,t,!0)?(PT(this,i),Array.isArray(i)||(i=i.toArray()),this.paths[e].splice(t,0,i),this.notifyChange("paths"),this):this}removePath(e){if(!this._validateInputs(e,null))return null;const t=this.paths.splice(e,1)[0],i=this.spatialReference,r=t.map(s=>new et(s,i));return this.notifyChange("paths"),r}removePoint(e,t){if(!this._validateInputs(e,t))return null;const i=new et(this.paths[e].splice(t,1)[0],this.spatialReference);return this.notifyChange("paths"),i}setPoint(e,t,i){return this._validateInputs(e,t)?(PT(this,i),Array.isArray(i)||(i=i.toArray()),this.paths[e][t]=i,this.notifyChange("paths"),this):this}_validateInputs(e,t,i=!1){if(e==null||e<0||e>=this.paths.length)return!1;if(t!=null){const r=this.paths[e];if(i&&(t<0||t>r.length)||!i&&(t<0||t>=r.length))return!1}return!0}toJSON(e){return this.write({},e)}};u([d({readOnly:!0})],kg.prototype,"cache",null),u([d({readOnly:!0})],kg.prototype,"extent",null),u([d({type:[[[Number]]],json:{write:{isRequired:!0}}})],kg.prototype,"paths",void 0),u([Fe("paths")],kg.prototype,"writePaths",null),kg=T6=u([P("esri.geometry.Polyline")],kg),kg.prototype.toJSON.isDefaultToJSON=!0;const cc=kg;class si{constructor(t,i={ignoreUnknown:!1,useNumericKeys:!1}){this.jsonToAPI=t,this.options=i,this.apiValues=[],this.jsonValues=[],this.apiToJSON=this._invertMap(t),this.apiValues=this._getKeysSorted(this.apiToJSON),this.jsonValues=this._getKeysSorted(this.jsonToAPI),this.read=r=>this.fromJSON(r),this.write=(r,s,n)=>{const o=this.toJSON(r);o!==void 0&&yc(n,o,s)},this.write.isJSONMapWriter=!0}toJSON(t){if(this.apiToJSON.hasOwnProperty(t)){const i=this.apiToJSON[t];return this.options.useNumericKeys?+i:i}return this.options.ignoreUnknown?void 0:t}fromJSON(t){return this.jsonToAPI.hasOwnProperty(t)?this.jsonToAPI[t]:this.options.ignoreUnknown?void 0:t}_invertMap(t){const i={};for(const r in t)i[t[r]]=r;return i}_getKeysSorted(t){const i=[];for(const r in t)i.push(r);return i.sort(),i}}function _o(){return function(e,t){return new si(e,I({ignoreUnknown:!0},t))}}const Zae=_o()({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon"}),wY=_o()({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh"});function Qae(e){return e.xmin!==void 0&&e.ymin!==void 0&&e.xmax!==void 0&&e.ymax!==void 0}function z7(e){return e.points!==void 0}function B7(e){return e.x!==void 0&&e.y!==void 0}function V7(e){return e.paths!==void 0}function r1(e){return e.rings!==void 0}function bp(e){return R(e)?null:e instanceof vl?e:B7(e)?et.fromJSON(e):V7(e)?cc.fromJSON(e):r1(e)?bc.fromJSON(e):z7(e)?nb.fromJSON(e):Qae(e)?Xt.fromJSON(e):null}function F0(e){return e?B7(e)?"esriGeometryPoint":V7(e)?"esriGeometryPolyline":r1(e)?"esriGeometryPolygon":Qae(e)?"esriGeometryEnvelope":z7(e)?"esriGeometryMultipoint":null:null}const P2e={esriGeometryPoint:et,esriGeometryPolyline:cc,esriGeometryPolygon:bc,esriGeometryEnvelope:Xt,esriGeometryMultipoint:nb};function Jae(e){return e&&P2e[e]||null}const ob={base:vl,key:"type",typeMap:{extent:Xt,multipoint:nb,point:et,polyline:cc,polygon:bc}};Zh(ob);class Zx{constructor(){this._emitter=new Zx.EventEmitter(this)}emit(t,i){return this._emitter.emit(t,i)}on(t,i){return this._emitter.on(t,i)}once(t,i){return this._emitter.once(t,i)}hasEventListener(t){return this._emitter.hasEventListener(t)}}(function(e){class t{constructor(s=null){this.target=s,this._listenersMap=null}clear(){this._listenersMap&&this._listenersMap.clear(),this._listenersMap=null}emit(s,n){const o=this._listenersMap&&this._listenersMap.get(s);if(!o)return!1;const a=this.target||this;return[...o].forEach(l=>{l.call(a,n)}),o.length>0}on(s,n){if(Array.isArray(s)){const a=s.map(l=>this.on(l,n));return ET(a)}if(s.indexOf(",")>-1)throw new TypeError("Evented.on() with a comma delimited string of event types is not supported");this._listenersMap||(this._listenersMap=new Map);const o=this._listenersMap.get(s)||[];return o.push(n),this._listenersMap.set(s,o),{remove:()=>{const a=this._listenersMap&&this._listenersMap.get(s)||[],l=a.indexOf(n);l>=0&&a.splice(l,1)}}}once(s,n){const o=this.on(s,a=>{o.remove(),n.call(null,a)});return o}hasEventListener(s){const n=this._listenersMap&&this._listenersMap.get(s);return n!=null&&n.length>0}}e.EventEmitter=t,e.EventedMixin=r=>{let s=class extends r{constructor(){super(...arguments),this._emitter=new t}destroy(){this._emitter.clear()}emit(n,o){return this._emitter.emit(n,o)}on(n,o){return this._emitter.on(n,o)}once(n,o){return this._emitter.once(n,o)}hasEventListener(n){return this._emitter.hasEventListener(n)}};return s=u([P("esri.core.Evented")],s),s};let i=class extends we{constructor(){super(...arguments),this._emitter=new Zx.EventEmitter(this)}destroy(){this._emitter.clear()}emit(r,s){return this._emitter.emit(r,s)}on(r,s){return this._emitter.on(r,s)}once(r,s){return this._emitter.once(r,s)}hasEventListener(r){return this._emitter.hasEventListener(r)}};i=u([P("esri.core.Evented")],i),e.EventedAccessor=i})(Zx||(Zx={}));const xr=Zx;var Ai;(function(e){e[e.ADD=1]="ADD",e[e.REMOVE=2]="REMOVE",e[e.MOVE=4]="MOVE"})(Ai||(Ai={}));function G7(e){return(t,i)=>{t[i]=e}}class I2e{constructor(){this._observers=[]}observe(t){return this._observers.includes(t)||this._observers.push(t),new uae(this._observers,t)}notify(){const t=this._observers.slice();for(let i=0;i<t.length;++i){const r=t[i];r.onInvalidated(),r.onCommitted()}}}var Qf;class $2e{constructor(){this.target=null,this.cancellable=!1,this.defaultPrevented=!1,this.item=void 0,this.type=void 0}preventDefault(){this.cancellable&&(this.defaultPrevented=!0)}reset(t){this.defaultPrevented=!1,this.item=t}}const $c=new Wr($2e,void 0,e=>{e.item=null,e.target=null,e.defaultPrevented=!1,e.cancellable=!1}),D2e=()=>{};function _5(e){return e?e instanceof C_?e.toArray():e.length?Array.prototype.slice.apply(e):[]:[]}function b5(e){if(e&&e.length)return e[0]}function L2e(e,t,i,r){const s=Math.min(e.length-i,t.length-r);let n=0;for(;n<s&&e[i+n]===t[r+n];)n++;return n}function Kae(e,t,i,r){t&&t.forEach((s,n,o)=>{e.push(s),Kae(e,i.call(r,s,n,o),i,r)})}const sg=new Set,ng=new Set,og=new Set,w5=new Map;let N2e=0,C_=Qf=class extends xr.EventedAccessor{constructor(e){super(e),this._chgListeners=[],this._notifications=null,this._timer=null,this._observable=new I2e,this.length=0,this._items=[],Object.defineProperty(this,"uid",{value:N2e++})}static isCollection(e){return e!=null&&e instanceof Qf}normalizeCtorArgs(e){return e?Array.isArray(e)||e instanceof Qf?{items:e}:e:{}}destroy(){this.removeAll()}*[Symbol.iterator](){yield*this.items}get items(){return Vt(this._observable),this._items}set items(e){this._emitBeforeChanges(Ai.ADD)||(this._splice(0,this.length,_5(e)),this._emitAfterChanges(Ai.ADD))}hasEventListener(e){return e==="change"?this._chgListeners.length>0:this._emitter.hasEventListener(e)}on(e,t){if(e==="change"){const i=this._chgListeners,r={removed:!1,callback:t};return i.push(r),this._notifications&&this._notifications.push({listeners:i.slice(),items:this._items.slice(),changes:[]}),{remove(){this.remove=D2e,r.removed=!0,i.splice(i.indexOf(r),1)}}}return this._emitter.on(e,t)}once(e,t){const i=this.on(e,t);return{remove(){i.remove()}}}add(e,t){if(Vt(this._observable),this._emitBeforeChanges(Ai.ADD))return this;const i=this.getNextIndex(t!=null?t:null);return this._splice(i,0,[e]),this._emitAfterChanges(Ai.ADD),this}addMany(e,t=this._items.length){if(Vt(this._observable),!e||!e.length)return this;if(this._emitBeforeChanges(Ai.ADD))return this;const i=this.getNextIndex(t);return this._splice(i,0,_5(e)),this._emitAfterChanges(Ai.ADD),this}at(e){if(Vt(this._observable),(e=Math.trunc(e)||0)<0&&(e+=this.length),!(e<0||e>=this.length))return this._items[e]}removeAll(){if(Vt(this._observable),!this.length||this._emitBeforeChanges(Ai.REMOVE))return[];const e=this._splice(0,this.length)||[];return this._emitAfterChanges(Ai.REMOVE),e}clone(){return Vt(this._observable),this._createNewInstance({items:this._items.map(se)})}concat(...e){Vt(this._observable);const t=e.map(_5);return this._createNewInstance({items:this._items.concat(...t)})}drain(e,t){if(Vt(this._observable),!this.length||this._emitBeforeChanges(Ai.REMOVE))return;const i=this._splice(0,this.length),r=i.length;for(let s=0;s<r;s++)e.call(t,i[s],s,i);this._emitAfterChanges(Ai.REMOVE)}every(e,t){return Vt(this._observable),this._items.every(e,t)}filter(e,t){let i;return Vt(this._observable),i=arguments.length===2?this._items.filter(e,t):this._items.filter(e),this._createNewInstance({items:i})}find(e,t){return Vt(this._observable),this._items.find(e,t)}findIndex(e,t){return Vt(this._observable),this._items.findIndex(e,t)}flatten(e,t){Vt(this._observable);const i=[];return Kae(i,this,e,t),new Qf(i)}forEach(e,t){return Vt(this._observable),this._items.forEach(e,t)}getItemAt(e){return Vt(this._observable),this._items[e]}getNextIndex(e){Vt(this._observable);const t=this.length;return(e=e==null?t:e)<0?e=0:e>t&&(e=t),e}includes(e,t=0){return Vt(this._observable),this._items.includes(e,t)}indexOf(e,t=0){return Vt(this._observable),this._items.indexOf(e,t)}join(e=","){return Vt(this._observable),this._items.join(e)}lastIndexOf(e,t=this.length-1){return Vt(this._observable),this._items.lastIndexOf(e,t)}map(e,t){Vt(this._observable);const i=this._items.map(e,t);return new Qf({items:i})}reorder(e,t=this.length-1){Vt(this._observable);const i=this.indexOf(e);if(i!==-1){if(t<0?t=0:t>=this.length&&(t=this.length-1),i!==t){if(this._emitBeforeChanges(Ai.MOVE))return e;this._splice(i,1),this._splice(t,0,[e]),this._emitAfterChanges(Ai.MOVE)}return e}}pop(){if(Vt(this._observable),!this.length||this._emitBeforeChanges(Ai.REMOVE))return;const e=b5(this._splice(this.length-1,1));return this._emitAfterChanges(Ai.REMOVE),e}push(...e){return Vt(this._observable),this._emitBeforeChanges(Ai.ADD)||(this._splice(this.length,0,e),this._emitAfterChanges(Ai.ADD)),this.length}reduce(e,t){Vt(this._observable);const i=this._items;return arguments.length===2?i.reduce(e,t):i.reduce(e)}reduceRight(e,t){Vt(this._observable);const i=this._items;return arguments.length===2?i.reduceRight(e,t):i.reduceRight(e)}remove(e){return Vt(this._observable),this.removeAt(this.indexOf(e))}removeAt(e){if(Vt(this._observable),e<0||e>=this.length||this._emitBeforeChanges(Ai.REMOVE))return;const t=b5(this._splice(e,1));return this._emitAfterChanges(Ai.REMOVE),t}removeMany(e){if(Vt(this._observable),!e||!e.length||this._emitBeforeChanges(Ai.REMOVE))return[];const t=e instanceof Qf?e.toArray():e,i=this._items,r=[],s=t.length;for(let n=0;n<s;n++){const o=t[n],a=i.indexOf(o);if(a>-1){const l=1+L2e(t,i,n+1,a+1),c=this._splice(a,l);c&&c.length>0&&r.push.apply(r,c),n+=l-1}}return this._emitAfterChanges(Ai.REMOVE),r}reverse(){if(Vt(this._observable),this._emitBeforeChanges(Ai.MOVE))return this;const e=this._splice(0,this.length);return e&&(e.reverse(),this._splice(0,0,e)),this._emitAfterChanges(Ai.MOVE),this}shift(){if(Vt(this._observable),!this.length||this._emitBeforeChanges(Ai.REMOVE))return;const e=b5(this._splice(0,1));return this._emitAfterChanges(Ai.REMOVE),e}slice(e=0,t=this.length){return Vt(this._observable),this._createNewInstance({items:this._items.slice(e,t)})}some(e,t){return Vt(this._observable),this._items.some(e,t)}sort(e){if(Vt(this._observable),!this.length||this._emitBeforeChanges(Ai.MOVE))return this;const t=this._splice(0,this.length);return arguments.length?t.sort(e):t.sort(),this._splice(0,0,t),this._emitAfterChanges(Ai.MOVE),this}splice(e,t,...i){Vt(this._observable);const r=(t?Ai.REMOVE:0)|(i.length?Ai.ADD:0);if(this._emitBeforeChanges(r))return[];const s=this._splice(e,t,i)||[];return this._emitAfterChanges(r),s}toArray(){return Vt(this._observable),this._items.slice()}toJSON(){return Vt(this._observable),this.toArray()}toLocaleString(){return Vt(this._observable),this._items.toLocaleString()}toString(){return Vt(this._observable),this._items.toString()}unshift(...e){return Vt(this._observable),!e.length||this._emitBeforeChanges(Ai.ADD)||(this._splice(0,0,e),this._emitAfterChanges(Ai.ADD)),this.length}_createNewInstance(e){return new this.constructor(e)}_splice(e,t,i){const r=this._items,s=this.itemType;let n,o;if(!this._notifications&&this.hasEventListener("change")&&(this._notifications=[{listeners:this._chgListeners.slice(),items:this._items.slice(),changes:[]}],this._timer&&this._timer.remove(),this._timer=rO(()=>this._dispatchChange())),t){if(o=r.splice(e,t),this.hasEventListener("before-remove")){const a=$c.acquire();a.target=this,a.cancellable=!0;for(let l=0,c=o.length;l<c;l++)n=o[l],a.reset(n),this.emit("before-remove",a),a.defaultPrevented&&(o.splice(l,1),r.splice(e,0,n),e+=1,l-=1,c-=1);$c.release(a)}if(this.length=this._items.length,this.hasEventListener("after-remove")){const a=$c.acquire();a.target=this,a.cancellable=!1;const l=o.length;for(let c=0;c<l;c++)a.reset(o[c]),this.emit("after-remove",a);$c.release(a)}}if(i&&i.length){if(s){const h=[];for(const p of i){const f=s.ensureType(p);f==null&&p!=null||h.push(f)}i=h}const a=this.hasEventListener("before-add"),l=this.hasEventListener("after-add"),c=e===this.length;if(a||l){const h=$c.acquire();h.target=this,h.cancellable=!0;const p=$c.acquire();p.target=this,p.cancellable=!1;for(const f of i)a?(h.reset(f),this.emit("before-add",h),h.defaultPrevented||(c?r.push(f):r.splice(e++,0,f),this._set("length",r.length),l&&(p.reset(f),this.emit("after-add",p)))):(c?r.push(f):r.splice(e++,0,f),this._set("length",r.length),p.reset(f),this.emit("after-add",p));$c.release(p),$c.release(h)}else{if(c)for(const h of i)r.push(h);else r.splice(e,0,...i);this._set("length",r.length)}}return(i&&i.length||o&&o.length)&&this._notifyChangeEvent(i,o),o}_emitBeforeChanges(e){let t=!1;if(this.hasEventListener("before-changes")){const i=$c.acquire();i.target=this,i.cancellable=!0,i.type=e,this.emit("before-changes",i),t=i.defaultPrevented,$c.release(i)}return t}_emitAfterChanges(e){if(this.hasEventListener("after-changes")){const t=$c.acquire();t.target=this,t.cancellable=!1,t.type=e,this.emit("after-changes",t),$c.release(t)}this._observable.notify()}_notifyChangeEvent(e,t){this.hasEventListener("change")&&this._notifications&&this._notifications[this._notifications.length-1].changes.push({added:e,removed:t})}_dispatchChange(){if(this._timer&&(this._timer.remove(),this._timer=null),!this._notifications)return;const e=this._notifications;this._notifications=null;for(const t of e){const i=t.changes;sg.clear(),ng.clear(),og.clear();for(const{added:l,removed:c}of i){if(l)if(og.size===0&&ng.size===0)for(const h of l)sg.add(h);else for(const h of l)ng.has(h)?(og.add(h),ng.delete(h)):og.has(h)||sg.add(h);if(c)if(og.size===0&&sg.size===0)for(const h of c)ng.add(h);else for(const h of c)sg.has(h)?sg.delete(h):(og.delete(h),ng.add(h))}const r=il.acquire();sg.forEach(l=>{r.push(l)});const s=il.acquire();ng.forEach(l=>{s.push(l)});const n=this._items,o=t.items,a=il.acquire();if(og.forEach(l=>{o.indexOf(l)!==n.indexOf(l)&&a.push(l)}),t.listeners&&(r.length||s.length||a.length)){const l={target:this,added:r,removed:s,moved:a},c=t.listeners.length;for(let h=0;h<c;h++){const p=t.listeners[h];p.removed||p.callback.call(this,l)}}il.release(r),il.release(s),il.release(a)}sg.clear(),ng.clear(),og.clear()}};C_.ofType=e=>{if(!e)return Qf;if(w5.has(e))return w5.get(e);let t=null;if(typeof e=="function")t=e.prototype.declaredClass;else if(e.base)t=e.base.prototype.declaredClass;else for(const r in e.typeMap){const s=e.typeMap[r].prototype.declaredClass;t?t+=` | ${s}`:t=s}let i=class extends Qf{};return u([G7({Type:e,ensureType:typeof e=="function"?Ir(e):Zh(e)})],i.prototype,"itemType",void 0),i=u([P(`esri.core.Collection<${t}>`)],i),w5.set(e,i),i},u([d()],C_.prototype,"length",void 0),u([d()],C_.prototype,"items",null),C_=Qf=u([P("esri.core.Collection")],C_);const it=C_;var $T;function F2e(e,t){switch(e.type){case"range":{const i="range"in e?e.range[0]:e.minValue,r="range"in e?e.range[1]:e.maxValue;if(+t<i||+t>r)return $T.VALUE_OUT_OF_RANGE;break}case"coded-value":case"codedValue":if(e.codedValues==null||e.codedValues.every(i=>i==null||i.code!==t))return $T.INVALID_CODED_VALUE}return null}(function(e){e.VALUE_OUT_OF_RANGE="domain-validation-error::value-out-of-range",e.INVALID_CODED_VALUE="domain-validation-error::invalid-coded-value"})($T||($T={}));let x5;function wp(){return x5||(x5=(async()=>{const e=await import("./arcadeUtils.1e20f716.js").then(function(t){return t.q});return{arcade:e.arcade,arcadeUtils:e,Dictionary:e.Dictionary,Feature:e.arcadeFeature}})()),x5}const U2e=(e,t,i)=>lO.create(e,t,i,null,["$feature"]),k2e=(e,t,i)=>lO.create(e,t,i,null,["$feature","$view"]),z2e=(e,t,i,r)=>lO.create(e,t,i,r,["$feature","$view"]);class lO{constructor(t,i,r,s,n,o,a,l){this.script=t,this.evaluate=n;const c=Array.isArray(a)?a:a.fields;this.fields=c,this._syntaxTree=s,this._arcade=i,this._arcadeDictionary=r,this._arcadeFeature=o,this._spatialReference=l,this._referencesGeometry=i.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static async create(t,i,r,s,n,o){const{arcade:a,Feature:l,Dictionary:c}=await wp(),h=He.fromJSON(i),p=a.parseScript(t,o),f=n.reduce((C,O)=>me(I({},C),{[O]:null}),{});let g=null;_(s)&&(g=new c(s),g.immutable=!0,f.$config=null);const y=a.scriptUsesGeometryEngine(p)&&a.enableGeometrySupport(),v=a.scriptUsesFeatureSet(p)&&a.enableFeatureSetSupport(),b=a.scriptIsAsync(p)&&a.enableAsyncSupport(),w={vars:f,spatialReference:h,useAsync:!!b},S=new c;S.immutable=!1,S.setField("scale",0);const T=a.compileScript(p,w),A=C=>("$view"in C&&C.$view&&(S.setField("scale",C.$view.scale),C.$view=S),g&&(C.$config=g),T({vars:C,spatialReference:h}));return await Promise.all([y,v,b]),new lO(t,a,c,p,A,new l,r,h)}repurposeFeature(t){return t.geometry&&!t.geometry.spatialReference&&(t.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(t.geometry,t.attributes,{fields:this.fields}),this._arcadeFeature}createDictionary(){return new this._arcadeDictionary}referencesMember(t){return this._arcade.referencesMember(this._syntaxTree,t)}referencesFunction(t){return this._arcade.referencesFunction(this._syntaxTree,t)}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}extractFieldLiterals(){return this._arcade.extractExpectedFieldLiterals(this._syntaxTree)}}const B2e=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],V2e=["field","normalizationField"];function xY(e,t){if(e!=null&&t!=null){for(const i of Array.isArray(e)?e:[e])if(TY(B2e,i,t),"visualVariables"in i&&i.visualVariables)for(const r of i.visualVariables)TY(V2e,r,t)}}function TY(e,t,i){if(e)for(const r of e){const s=MS(r,t),n=s&&typeof s!="function"&&i.get(s);n&&yc(r,n.name,t)}}function ele(e,t){if(e!=null&&t!=null&&t.fields.length)if("startField"in e){const i=t.get(e.startField),r=t.get(e.endField);e.startField=i&&i.name||null,e.endField=r&&r.name||null}else{const i=t.get(e.startTimeField),r=t.get(e.endTimeField);e.startTimeField=i&&i.name||null,e.endTimeField=r&&r.name||null}}const T5=new Set;function tle(e,t){return e&&t?(T5.clear(),FC(T5,e,t),Array.from(T5).sort()):[]}function FC(e,t,i){var r;if(i)if(t!=null&&(r=t.fields)!=null&&r.length)if(i.includes("*"))for(const{name:s}of t.fields)e.add(s);else for(const s of i)Mu(e,t,s);else{if(i.includes("*"))return e.clear(),void e.add("*");for(const s of i)e.add(s)}}function Mu(e,t,i){if(typeof i=="string")if(t){const r=t.get(i);r&&e.add(r.name)}else e.add(i)}function Yft(e,t){return R(t)||R(e)?[]:t.includes("*")?e.fields.map(i=>i.name):t}async function wc(e,t,i){var r;if(!i)return;const{arcadeUtils:s}=await wp(),n=s.extractFieldNames(i,t==null||(r=t.fields)==null?void 0:r.map(o=>o.name));for(const o of n)Mu(e,t,o)}async function ile(e,t,i){if(i&&i!=="1=1"){const r=(await import("./WhereClause.d621a470.js")).WhereClause.create(i,t);if(!r.isStandardized)throw new q("fieldUtils:collectFilterFields","Where clause is not standardized");FC(e,t,r.fieldNames)}}function G2e({displayField:e,fields:t}){return e||(t&&t.length?S5(t,"name-or-title")||S5(t,"unique-identifier")||S5(t,"type-or-category")||j2e(t):null)}function j2e(e){for(const t of e){if(!t||!t.name)continue;const i=t.name.toLowerCase();if(i.indexOf("name")>-1||i.indexOf("title")>-1)return t.name}return null}function S5(e,t){for(const i of e)if(i&&i.valueType&&i.valueType===t)return i.name;return null}async function Zft(e,t){if(!t)return;const i=MS("elevationInfo.featureExpressionInfo",t);return i?i.collectRequiredFields(e,t.fieldsIndex):void 0}async function H2e(e,t,i){i.outStatistic.onStatisticValueExpression?wc(e,t,i.outStatistic.onStatisticValueExpression):e.add(i.outStatistic.onStatisticField)}async function Qft(e,t,i){var r,s;if(!t||!i||i.type!=="cluster")return;const n=[];if((r=i.popupTemplate)!=null&&r.expressionInfos&&n.push(...i.popupTemplate.expressionInfos.map(o=>wc(e,t.fieldsIndex,o.expression))),Array.isArray((s=i.popupTemplate)==null?void 0:s.content)){const o=i.popupTemplate.content;for(const a of o)a.type==="expression"&&a.expressionInfo&&n.push(wc(e,t.fieldsIndex,a.expressionInfo.expression))}i.fields&&n.push(...i.fields.map(o=>H2e(e,t.fieldsIndex,o))),await Promise.all(n)}async function Jft(e,t,i){t&&(t.timeInfo&&_(i)&&i.timeExtent&&FC(e,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),t.floorInfo&&FC(e,t.fieldsIndex,[t.floorInfo.floorField]),_(i)&&_(i.where)&&await ile(e,t.fieldsIndex,i.where))}async function Kft(e,t,i){t&&i&&await Promise.all(i.map(r=>q2e(e,t,r)))}async function q2e(e,t,i){t&&i&&(i.valueExpression?await wc(e,t.fieldsIndex,i.valueExpression):i.field&&Mu(e,t.fieldsIndex,i.field))}function emt(e){if(!e)return[];const t="editFieldsInfo"in e&&e.editFieldsInfo;return t?tle(e.fieldsIndex,[t&&t.creatorField,t&&t.creationDateField,t&&t.editorField,t&&t.editDateField]):[]}async function tmt(e,t){const{labelingInfo:i,fieldsIndex:r}=t;i&&i.length&&await Promise.all(i.map(s=>W2e(e,r,s)))}async function W2e(e,t,i){if(!i)return;const r=i.getLabelExpression(),s=i.where;if(r.type==="arcade")await wc(e,t,r.expression);else{const n=r.expression.match(/{[^}]*}/g);n&&n.forEach(o=>{Mu(e,t,o.slice(1,-1))})}await ile(e,t,s)}function X2e(e){const t=e.defaultValue;return t!==void 0&&nle(e,t)?t:e.nullable?null:void 0}function rle(e){return typeof e=="number"&&!isNaN(e)&&isFinite(e)}function Y2e(e){return e===null||rle(e)}const j7="isInteger"in Number?Number.isInteger:e=>typeof e=="number"&&isFinite(e)&&Math.floor(e)===e;function Z2e(e){return e===null||j7(e)}function sle(e){return e!=null&&typeof e=="string"}function Q2e(e){return e===null||sle(e)}function J2e(){return!0}function nle(e,t){let i;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":i=e.nullable?Z2e:j7;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":i=e.nullable?Y2e:rle;break;case"string":case"esriFieldTypeString":i=e.nullable?Q2e:sle;break;default:i=J2e}return arguments.length===1?i:i(t)}const K2e=["integer","small-integer","single","double"],eEe=new Set([...K2e,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]);function DN(e){return e!=null&&eEe.has(e.type)}function imt(e){return e!=null&&(e.type==="string"||e.type==="esriFieldTypeString")}var xD,TD;function rmt(e){return e==null||typeof e=="number"&&isNaN(e)?null:e}function smt(e,t){return e.nullable&&t===null?null:DN(e)&&!tEe(e.type,Number(t))?xD.OUT_OF_RANGE:nle(e,t)?e.domain?F2e(e.domain,t):null:TD.INVALID_TYPE}function tEe(e,t){const i=typeof e=="string"?ole(e):e;return!!i&&(i.isInteger?j7(t)&&t>=i.min&&t<=i.max:t>=i.min&&t<=i.max)}function ole(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return iEe;case"esriFieldTypeInteger":case"integer":return rEe;case"esriFieldTypeSingle":case"single":return sEe;case"esriFieldTypeDouble":case"double":return nEe}}(function(e){e.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"})(xD||(xD={})),function(e){e.INVALID_TYPE="type-validation-error::invalid-type"}(TD||(TD={}));const iEe={min:-32768,max:32767,isInteger:!0},rEe={min:-2147483648,max:2147483647,isInteger:!0},sEe={min:-34e37,max:12e37,isInteger:!1},nEe={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function nmt(e,t,i){switch(e){case $T.INVALID_CODED_VALUE:return`Value ${i} is not in the coded domain - field: ${t.name}, domain: ${JSON.stringify(t.domain)}`;case $T.VALUE_OUT_OF_RANGE:return`Value ${i} is out of the range of valid values - field: ${t.name}, domain: ${JSON.stringify(t.domain)}`;case TD.INVALID_TYPE:return`Value ${i} is not a valid value for the field type - field: ${t.name}, type: ${t.type}, nullable: ${t.nullable}`;case xD.OUT_OF_RANGE:{const{min:r,max:s}=ole(t.type);return`Value ${i} is out of range for the number type - field: ${t.name}, type: ${t.type}, value range is ${r} to ${s}`}}}function oEe(e,t){return!aEe(e,t,null)}function aEe(e,t,i){if(!t||!t.attributes||!e){if(_(i))for(const n of e)i.add(n);return!0}const r=t.attributes;let s=!1;for(const n of e)if(!(n in r)){if(s=!0,!_(i))break;i.add(n)}return s}let nI=class extends fe{constructor(e){super(e),this.type=null}};u([d({type:["attachments","custom","fields","media","text","expression"],readOnly:!0,json:{read:!1,write:!0}})],nI.prototype,"type",void 0),nI=u([P("esri.popup.content.Content")],nI);const ab=nI;var S6;let Mv=S6=class extends ab{constructor(e){super(e),this.description=null,this.displayType="auto",this.title=null,this.type="attachments"}clone(){return new S6({description:this.description,displayType:this.displayType,title:this.title})}};u([d({type:String,json:{write:!0}})],Mv.prototype,"description",void 0),u([d({type:["auto","preview","list"],json:{write:!0}})],Mv.prototype,"displayType",void 0),u([d({type:String,json:{write:!0}})],Mv.prototype,"title",void 0),u([d({type:["attachments"],readOnly:!0,json:{read:!1,write:!0}})],Mv.prototype,"type",void 0),Mv=S6=u([P("esri.popup.content.AttachmentsContent")],Mv);const UC=Mv;var E6;let Pv=E6=class extends ab{constructor(e){super(e),this.creator=null,this.destroyer=null,this.outFields=null,this.type="custom"}clone(){return new E6({creator:this.creator,destroyer:this.destroyer,outFields:Array.isArray(this.outFields)?se(this.outFields):null})}};u([d()],Pv.prototype,"creator",void 0),u([d()],Pv.prototype,"destroyer",void 0),u([d()],Pv.prototype,"outFields",void 0),u([d({type:["custom"],readOnly:!0})],Pv.prototype,"type",void 0),Pv=E6=u([P("esri.popup.content.CustomContent")],Pv);const lEe=Pv;var A6;let ww=A6=class extends fe{constructor(e){super(e),this.title=null,this.expression=null,this.returnType="dictionary"}clone(){return new A6({title:this.title,expression:this.expression})}};u([d({type:String,json:{write:!0}})],ww.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],ww.prototype,"expression",void 0),u([d({type:["dictionary"],readOnly:!0,json:{read:!1,write:!0}})],ww.prototype,"returnType",void 0),ww=A6=u([P("esri.popup.ElementExpressionInfo")],ww);const ale=ww;var C6;let EE=C6=class extends ab{constructor(e){super(e),this.expressionInfo=null,this.type="expression"}clone(){var e;return new C6({expressionInfo:(e=this.expressionInfo)==null?void 0:e.clone()})}};u([d({type:ale,json:{write:!0}})],EE.prototype,"expressionInfo",void 0),u([d({type:["expression"],readOnly:!0,json:{read:!1,write:!0}})],EE.prototype,"type",void 0),EE=C6=u([P("esri.popup.content.ExpressionContent")],EE);const H7=EE;function ut(e,t={}){var i;const r=e instanceof si?e:new si(e,t),s={type:(i=t==null?void 0:t.ignoreUnknown)==null||i?r.apiValues:String,json:{type:r.jsonValues,read:(t==null||!t.readOnly)&&{reader:r.read},write:{writer:r.write}}};return(t==null?void 0:t.readOnly)!==void 0&&(s.readOnly=!!t.readOnly),(t==null?void 0:t.default)!==void 0&&(s.json.default=t.default),(t==null?void 0:t.name)!==void 0&&(s.json.name=t.name),d(s)}const kC=_o()({shortDate:"short-date",shortDateShortTime:"short-date-short-time",shortDateShortTime24:"short-date-short-time-24",shortDateLongTime:"short-date-long-time",shortDateLongTime24:"short-date-long-time-24",shortDateLE:"short-date-le",shortDateLEShortTime:"short-date-le-short-time",shortDateLEShortTime24:"short-date-le-short-time-24",shortDateLELongTime:"short-date-le-long-time",shortDateLELongTime24:"short-date-le-long-time-24",longMonthDayYear:"long-month-day-year",longMonthDayYearShortTime:"long-month-day-year-short-time",longMonthDayYearShortTime24:"long-month-day-year-short-time-24",longMonthDayYearLongTime:"long-month-day-year-long-time",longMonthDayYearLongTime24:"long-month-day-year-long-time-24",dayShortMonthYear:"day-short-month-year",dayShortMonthYearShortTime:"day-short-month-year-short-time",dayShortMonthYearShortTime24:"day-short-month-year-short-time-24",dayShortMonthYearLongTime:"day-short-month-year-long-time",dayShortMonthYearLongTime24:"day-short-month-year-long-time-24",longDate:"long-date",longDateShortTime:"long-date-short-time",longDateShortTime24:"long-date-short-time-24",longDateLongTime:"long-date-long-time",longDateLongTime24:"long-date-long-time-24",longMonthYear:"long-month-year",shortMonthYear:"short-month-year",year:"year"});kC.toJSON.bind(kC);kC.fromJSON.bind(kC);var SY,EY,AY;let cEe,BA;const CY=(SY=(EY=globalThis.esriConfig)==null?void 0:EY.locale)!=null?SY:(AY=globalThis.dojoConfig)==null?void 0:AY.locale;function lle(){var e,t;return(e=CY!=null?CY:(t=globalThis.navigator)==null?void 0:t.language)!=null?e:"en"}function dc(){return BA===void 0&&(BA=lle()),BA}const VA=[];function uEe(e){return VA.push(e),{remove(){VA.splice(VA.indexOf(e),1)}}}const R6=[];function q7(e){return R6.push(e),{remove(){VA.splice(R6.indexOf(e),1)}}}function hEe(){var e;const t=(e=cEe)!=null?e:lle();BA!==t&&(BA=t,[...R6].forEach(i=>{i.call(null,t)}),[...VA].forEach(i=>{i.call(null,t)}))}globalThis.addEventListener==null||globalThis.addEventListener("languagechange",hEe);const cd={year:"numeric",month:"numeric",day:"numeric"},d2={year:"numeric",month:"long",day:"numeric"},p2={year:"numeric",month:"short",day:"numeric"},f2={year:"numeric",month:"long",weekday:"long",day:"numeric"},Wc={hour:"numeric",minute:"numeric"},qu=me(I({},Wc),{second:"numeric"}),W7={"short-date":cd,"short-date-short-time":I(I({},cd),Wc),"short-date-short-time-24":me(I(I({},cd),Wc),{hour12:!1}),"short-date-long-time":I(I({},cd),qu),"short-date-long-time-24":me(I(I({},cd),qu),{hour12:!1}),"short-date-le":cd,"short-date-le-short-time":I(I({},cd),Wc),"short-date-le-short-time-24":me(I(I({},cd),Wc),{hour12:!1}),"short-date-le-long-time":I(I({},cd),qu),"short-date-le-long-time-24":me(I(I({},cd),qu),{hour12:!1}),"long-month-day-year":d2,"long-month-day-year-short-time":I(I({},d2),Wc),"long-month-day-year-short-time-24":me(I(I({},d2),Wc),{hour12:!1}),"long-month-day-year-long-time":I(I({},d2),qu),"long-month-day-year-long-time-24":me(I(I({},d2),qu),{hour12:!1}),"day-short-month-year":p2,"day-short-month-year-short-time":I(I({},p2),Wc),"day-short-month-year-short-time-24":me(I(I({},p2),Wc),{hour12:!1}),"day-short-month-year-long-time":I(I({},p2),qu),"day-short-month-year-long-time-24":me(I(I({},p2),qu),{hour12:!1}),"long-date":f2,"long-date-short-time":I(I({},f2),Wc),"long-date-short-time-24":me(I(I({},f2),Wc),{hour12:!1}),"long-date-long-time":I(I({},f2),qu),"long-date-long-time-24":me(I(I({},f2),qu),{hour12:!1}),"long-month-year":{month:"long",year:"numeric"},"short-month-year":{month:"short",year:"numeric"},year:{year:"numeric"},"short-time":Wc,"long-time":qu},zC=_o()({shortDate:"short-date",shortDateShortTime:"short-date-short-time",shortDateShortTime24:"short-date-short-time-24",shortDateLongTime:"short-date-long-time",shortDateLongTime24:"short-date-long-time-24",shortDateLE:"short-date-le",shortDateLEShortTime:"short-date-le-short-time",shortDateLEShortTime24:"short-date-le-short-time-24",shortDateLELongTime:"short-date-le-long-time",shortDateLELongTime24:"short-date-le-long-time-24",longMonthDayYear:"long-month-day-year",longMonthDayYearShortTime:"long-month-day-year-short-time",longMonthDayYearShortTime24:"long-month-day-year-short-time-24",longMonthDayYearLongTime:"long-month-day-year-long-time",longMonthDayYearLongTime24:"long-month-day-year-long-time-24",dayShortMonthYear:"day-short-month-year",dayShortMonthYearShortTime:"day-short-month-year-short-time",dayShortMonthYearShortTime24:"day-short-month-year-short-time-24",dayShortMonthYearLongTime:"day-short-month-year-long-time",dayShortMonthYearLongTime24:"day-short-month-year-long-time-24",longDate:"long-date",longDateShortTime:"long-date-short-time",longDateShortTime24:"long-date-short-time-24",longDateLongTime:"long-date-long-time",longDateLongTime24:"long-date-long-time-24",longMonthYear:"long-month-year",shortMonthYear:"short-month-year",year:"year"});zC.apiValues;zC.toJSON.bind(zC);zC.fromJSON.bind(zC);const dEe={ar:"ar-u-nu-latn-ca-gregory"};let oI=new WeakMap,cle=W7["short-date-short-time"];function pEe(e){const t=e||cle;if(!oI.has(t)){const i=dc(),r=dEe[dc()]||i;oI.set(t,new Intl.DateTimeFormat(r,t))}return oI.get(t)}function X7(e){return W7[e]||null}function Cm(e,t){return pEe(t).format(e)}q7(()=>{oI=new WeakMap,cle=W7["short-date-short-time"]});const fEe={ar:"ar-u-nu-latn"};let aI=new WeakMap,ule={};function mEe(e){const t=e||ule;if(!aI.has(t)){const i=dc(),r=fEe[dc()]||i;aI.set(t,new Intl.NumberFormat(r,e))}return aI.get(t)}function hle(e={}){const t={};return e.digitSeparator!=null&&(t.useGrouping=e.digitSeparator),e.places!=null&&(t.minimumFractionDigits=t.maximumFractionDigits=e.places),t}function Rm(e,t){return mEe(t).format(e)}q7(()=>{aI=new WeakMap,ule={}});var O6;let Iv=O6=class extends fe{constructor(e){super(e),this.dateFormat=null,this.dateTimeFormatOptions=null,this.digitSeparator=!1,this.places=null}clone(){return new O6({dateFormat:this.dateFormat,digitSeparator:this.digitSeparator,places:this.places})}format(e){return this.dateFormat?Cm(e,I(I({},X7(this.dateFormat)),this.dateTimeFormatOptions)):Rm(e,hle(this))}};u([ut(kC)],Iv.prototype,"dateFormat",void 0),u([d({type:Object,json:{read:!1}})],Iv.prototype,"dateTimeFormatOptions",void 0),u([d({type:Boolean,json:{write:!0}})],Iv.prototype,"digitSeparator",void 0),u([d({type:ir,json:{write:!0}})],Iv.prototype,"places",void 0),Iv=O6=u([P("esri.popup.support.FieldInfoFormat")],Iv);const GA=Iv;var M6;let rh=M6=class extends fe{constructor(e){super(e),this.fieldName=null,this.format=null,this.isEditable=!1,this.label=null,this.stringFieldOption="text-box",this.statisticType=null,this.tooltip=null,this.visible=!0}clone(){return new M6({fieldName:this.fieldName,format:this.format?se(this.format):null,isEditable:this.isEditable,label:this.label,stringFieldOption:this.stringFieldOption,statisticType:this.statisticType,tooltip:this.tooltip,visible:this.visible})}};u([d({type:String,json:{write:!0}})],rh.prototype,"fieldName",void 0),u([d({type:GA,json:{write:!0}})],rh.prototype,"format",void 0),u([d({type:Boolean,json:{write:!0,default:!1}})],rh.prototype,"isEditable",void 0),u([d({type:String,json:{write:!0}})],rh.prototype,"label",void 0),u([ut(new si({richtext:"rich-text",textarea:"text-area",textbox:"text-box"}),{default:"text-box"})],rh.prototype,"stringFieldOption",void 0),u([d({type:["count","sum","min","max","avg","stddev","var"],json:{write:!0}})],rh.prototype,"statisticType",void 0),u([d({type:String,json:{write:!0}})],rh.prototype,"tooltip",void 0),u([d({type:Boolean,json:{write:!0}})],rh.prototype,"visible",void 0),rh=M6=u([P("esri.popup.FieldInfo")],rh);const cO=rh;var P6;let gf=P6=class extends ab{constructor(e){super(e),this.attributes=null,this.description=null,this.fieldInfos=null,this.title=null,this.type="fields"}writeFieldInfos(e,t){t.fieldInfos=e&&e.map(i=>i.toJSON())}clone(){return new P6(se({attributes:this.attributes,description:this.description,fieldInfos:this.fieldInfos,title:this.title}))}};u([d({type:Object,json:{write:!0}})],gf.prototype,"attributes",void 0),u([d({type:String,json:{write:!0}})],gf.prototype,"description",void 0),u([d({type:[cO]})],gf.prototype,"fieldInfos",void 0),u([Fe("fieldInfos")],gf.prototype,"writeFieldInfos",null),u([d({type:String,json:{write:!0}})],gf.prototype,"title",void 0),u([d({type:["fields"],readOnly:!0,json:{read:!1,write:!0}})],gf.prototype,"type",void 0),gf=P6=u([P("esri.popup.content.FieldsContent")],gf);const DT=gf;let $v=class extends fe{constructor(e){super(e),this.altText=null,this.caption="",this.title="",this.type=null}};u([d({type:String,json:{write:!0}})],$v.prototype,"altText",void 0),u([d({type:String,json:{write:!0}})],$v.prototype,"caption",void 0),u([d({type:String,json:{write:!0}})],$v.prototype,"title",void 0),u([d({type:["image","bar-chart","column-chart","line-chart","pie-chart"],readOnly:!0,json:{read:!1,write:!0}})],$v.prototype,"type",void 0),$v=u([P("esri.popup.content.mixins.MediaInfo")],$v);const Y7=$v;var I6;let AE=I6=class extends we{constructor(e){super(e),this.tooltip=null,this.value=null}clone(){return new I6({tooltip:this.tooltip,value:this.value})}};u([d()],AE.prototype,"tooltip",void 0),u([d()],AE.prototype,"value",void 0),AE=I6=u([P("esri.popup.content.support.ChartMediaInfoValueSeries")],AE);const dle=AE;var $6;let Dv=$6=class extends fe{constructor(e){super(e),this.fields=[],this.normalizeField=null,this.series=[],this.tooltipField=null}clone(){return new $6({fields:se(this.fields),normalizeField:this.normalizeField,tooltipField:this.tooltipField})}};u([d({type:[String],json:{write:!0}})],Dv.prototype,"fields",void 0),u([d({type:String,json:{write:!0}})],Dv.prototype,"normalizeField",void 0),u([d({type:[dle],json:{read:!1}})],Dv.prototype,"series",void 0),u([d({type:String,json:{write:!0}})],Dv.prototype,"tooltipField",void 0),Dv=$6=u([P("esri.popup.content.support.ChartMediaInfoValue")],Dv);const gEe=Dv;let CE=class extends Y7{constructor(e){super(e),this.type=null,this.value=null}};u([d({type:["bar-chart","column-chart","line-chart","pie-chart"],readOnly:!0,json:{read:!1,write:!0}})],CE.prototype,"type",void 0),u([d({type:gEe,json:{write:!0}})],CE.prototype,"value",void 0),CE=u([P("esri.popup.content.mixins.ChartMediaInfo")],CE);const LN=CE,NN=_o()({barchart:"bar-chart",columnchart:"column-chart",linechart:"line-chart",piechart:"pie-chart"});var D6;let lI=D6=class extends LN{constructor(e){super(e),this.type="bar-chart"}clone(){return new D6({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["bar-chart"],readOnly:!0,json:{type:["barchart"],read:!1,write:NN.write}})],lI.prototype,"type",void 0),lI=D6=u([P("esri.popup.content.BarChartMediaInfo")],lI);const ple=lI;var L6;let cI=L6=class extends LN{constructor(e){super(e),this.type="column-chart"}clone(){return new L6({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["column-chart"],readOnly:!0,json:{type:["columnchart"],read:!1,write:NN.write}})],cI.prototype,"type",void 0),cI=L6=u([P("esri.popup.content.ColumnChartMediaInfo")],cI);const fle=cI;var N6;let RE=N6=class extends fe{constructor(e){super(e),this.linkURL=null,this.sourceURL=null}clone(){return new N6({linkURL:this.linkURL,sourceURL:this.sourceURL})}};u([d({type:String,json:{write:!0}})],RE.prototype,"linkURL",void 0),u([d({type:String,json:{write:!0}})],RE.prototype,"sourceURL",void 0),RE=N6=u([P("esri.popup.content.support.ImageMediaInfoValue")],RE);const yEe=RE;var F6;let xw=F6=class extends Y7{constructor(e){super(e),this.refreshInterval=null,this.type="image",this.value=null}clone(){return new F6({altText:this.altText,title:this.title,caption:this.caption,refreshInterval:this.refreshInterval,value:this.value?this.value.clone():null})}};u([d({type:Number,json:{write:!0}})],xw.prototype,"refreshInterval",void 0),u([d({type:["image"],readOnly:!0,json:{read:!1,write:!0}})],xw.prototype,"type",void 0),u([d({type:yEe,json:{write:!0}})],xw.prototype,"value",void 0),xw=F6=u([P("esri.popup.content.ImageMediaInfo")],xw);const mle=xw;var U6;let uI=U6=class extends LN{constructor(e){super(e),this.type="line-chart"}clone(){return new U6({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["line-chart"],readOnly:!0,json:{type:["linechart"],read:!1,write:NN.write}})],uI.prototype,"type",void 0),uI=U6=u([P("esri.popup.content.LineChartMediaInfo")],uI);const gle=uI;var k6;let hI=k6=class extends LN{constructor(e){super(e),this.type="pie-chart"}clone(){return new k6({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["pie-chart"],readOnly:!0,json:{type:["piechart"],read:!1,write:NN.write}})],hI.prototype,"type",void 0),hI=k6=u([P("esri.popup.content.PieChartMediaInfo")],hI);const yle=hI,vle={base:Y7,key:"type",defaultKeyValue:"image",typeMap:{"bar-chart":ple,"column-chart":fle,"line-chart":gle,"pie-chart":yle,image:mle}};var z6;let sh=z6=class extends ab{constructor(e){super(e),this.activeMediaInfoIndex=null,this.attributes=null,this.description=null,this.mediaInfos=null,this.title=null,this.type="media"}readMediaInfos(e){return e&&e.map(t=>t.type==="image"?mle.fromJSON(t):t.type==="barchart"?ple.fromJSON(t):t.type==="columnchart"?fle.fromJSON(t):t.type==="linechart"?gle.fromJSON(t):t.type==="piechart"?yle.fromJSON(t):void 0).filter(Boolean)}writeMediaInfos(e,t){t.mediaInfos=e&&e.map(i=>i.toJSON())}clone(){return new z6(se({activeMediaInfoIndex:this.activeMediaInfoIndex,attributes:this.attributes,description:this.description,mediaInfos:this.mediaInfos,title:this.title}))}};u([d()],sh.prototype,"activeMediaInfoIndex",void 0),u([d({type:Object,json:{write:!0}})],sh.prototype,"attributes",void 0),u([d({type:String,json:{write:!0}})],sh.prototype,"description",void 0),u([d({types:[vle]})],sh.prototype,"mediaInfos",void 0),u([De("mediaInfos")],sh.prototype,"readMediaInfos",null),u([Fe("mediaInfos")],sh.prototype,"writeMediaInfos",null),u([d({type:String,json:{write:!0}})],sh.prototype,"title",void 0),u([d({type:["media"],readOnly:!0,json:{read:!1,write:!0}})],sh.prototype,"type",void 0),sh=z6=u([P("esri.popup.content.MediaContent")],sh);const BC=sh;var B6;let OE=B6=class extends ab{constructor(e){super(e),this.text=null,this.type="text"}clone(){return new B6({text:this.text})}};u([d({type:String,json:{write:!0}})],OE.prototype,"text",void 0),u([d({type:["text"],readOnly:!0,json:{read:!1,write:!0}})],OE.prototype,"type",void 0),OE=B6=u([P("esri.popup.content.TextContent")],OE);const LT=OE,vEe={base:null,key:"type",typeMap:{attachment:UC,media:BC,text:LT,expression:H7,field:DT}};var V6;let Lv=V6=class extends fe{constructor(e){super(e),this.name=null,this.title=null,this.expression=null,this.returnType=null}clone(){return new V6({name:this.name,title:this.title,expression:this.expression,returnType:this.returnType})}};u([d({type:String,json:{write:!0}})],Lv.prototype,"name",void 0),u([d({type:String,json:{write:!0}})],Lv.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],Lv.prototype,"expression",void 0),u([d({type:["string","number"],json:{write:!0}})],Lv.prototype,"returnType",void 0),Lv=V6=u([P("esri.popup.ExpressionInfo")],Lv);const _le=Lv;var G6;let ME=G6=class extends fe{constructor(e){super(e),this.returnTopmostRaster=null,this.showNoDataRecords=null}clone(){return new G6({showNoDataRecords:this.showNoDataRecords,returnTopmostRaster:this.returnTopmostRaster})}};u([d({type:Boolean,json:{write:!0}})],ME.prototype,"returnTopmostRaster",void 0),u([d({type:Boolean,json:{write:!0}})],ME.prototype,"showNoDataRecords",void 0),ME=G6=u([P("esri.popup.LayerOptions")],ME);const _Ee=ME;var j6;let PE=j6=class extends fe{constructor(e){super(e),this.field=null,this.order=null}clone(){return new j6({field:this.field,order:this.order})}};u([d({type:String,json:{write:!0}})],PE.prototype,"field",void 0),u([d({type:["asc","desc"],json:{write:!0}})],PE.prototype,"order",void 0),PE=j6=u([P("esri.popup.support.RelatedRecordsInfoFieldOrder")],PE);const ble=PE;var H6;let IE=H6=class extends fe{constructor(e){super(e),this.showRelatedRecords=null,this.orderByFields=null}clone(){return new H6({showRelatedRecords:this.showRelatedRecords,orderByFields:this.orderByFields?se(this.orderByFields):null})}};u([d({type:Boolean,json:{write:!0}})],IE.prototype,"showRelatedRecords",void 0),u([d({type:[ble],json:{write:!0}})],IE.prototype,"orderByFields",void 0),IE=H6=u([P("esri.popup.RelatedRecordsInfo")],IE);const bEe=IE;let wEe=0;const FN=e=>{let t=class extends e{constructor(...i){super(...i),Object.defineProperty(this,"uid",{writable:!1,configurable:!1,value:Date.now().toString(16)+"-object-"+wEe++})}};return t=u([P("esri.core.Identifiable")],t),t};let RY=class extends FN(class{}){};RY=u([P("esri.core.Identifiable")],RY);var q6;let nh=q6=class extends FN(we){constructor(e){super(e),this.active=!1,this.className=null,this.disabled=!1,this.id=null,this.indicator=!1,this.title=null,this.type=null,this.visible=!0}clone(){return new q6({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible})}};u([d()],nh.prototype,"active",void 0),u([d()],nh.prototype,"className",void 0),u([d()],nh.prototype,"disabled",void 0),u([d()],nh.prototype,"id",void 0),u([d()],nh.prototype,"indicator",void 0),u([d()],nh.prototype,"title",void 0),u([d()],nh.prototype,"type",void 0),u([d()],nh.prototype,"visible",void 0),nh=q6=u([P("esri.support.actions.ActionBase")],nh);const UN=nh;var W6;let dI=W6=class extends UN{constructor(e){super(e),this.image=null,this.type="button"}clone(){return new W6({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,image:this.image})}};u([d()],dI.prototype,"image",void 0),dI=W6=u([P("esri.support.Action.ActionButton")],dI);const IS=dI;var X6;let $E=X6=class extends UN{constructor(e){super(e),this.image=null,this.type="toggle",this.value=!1}clone(){return new X6({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,image:this.image,value:this.value})}};u([d()],$E.prototype,"image",void 0),u([d()],$E.prototype,"value",void 0),$E=X6=u([P("esri.support.Action.ActionToggle")],$E);const wle=$E;var Y6;const xEe=it.ofType({key:"type",defaultKeyValue:"button",base:UN,typeMap:{button:IS,toggle:wle}}),TEe={base:ab,key:"type",typeMap:{media:BC,custom:lEe,text:LT,attachments:UC,fields:DT,expression:H7}},xle="esri.PopupTemplate",SEe=he.getLogger(xle),EEe=["attachments","fields","media","text","expression"];let Bs=Y6=class extends fe{constructor(){super(...arguments),this.actions=null,this.content="",this.expressionInfos=null,this.fieldInfos=null,this.layerOptions=null,this.lastEditInfoEnabled=!0,this.outFields=null,this.overwriteActions=!1,this.returnGeometry=!1,this.title="",this.relatedRecordsInfo=null}castContent(e){return Array.isArray(e)?e.map(t=>Zh(TEe,t)):typeof e=="string"||typeof e=="function"||e instanceof HTMLElement||Cc(e)?e:(SEe.error("content error","unsupported content value",{value:e}),null)}readContent(e,t){const{popupElements:i}=t;return Array.isArray(i)&&i.length>0?this._readPopupInfoElements(t):this._readPopupInfo(t)}writeContent(e,t,i,r){typeof e!="string"?Array.isArray(e)&&(t.popupElements=e.filter(s=>EEe.indexOf(s.type)!==-1).map(s=>s&&s.toJSON(r)),t.popupElements.forEach(s=>{s.type==="attachments"?this._writeAttachmentContent(t):s.type==="media"?this._writeMediaContent(s,t):s.type==="text"&&this._writeTextContent(s,t)})):t.description=e}writeFieldInfos(e,t,i,r){const{content:s}=this,n=Array.isArray(s)?s:null;if(e){const o=n?n.filter(l=>l.type==="fields"):[],a=o.length&&o.every(l=>{var c;return(c=l.fieldInfos)==null?void 0:c.length});t.fieldInfos=e.filter(Boolean).map(l=>{const c=l.toJSON(r);return a&&(c.visible=!1),c})}if(n)for(const o of n)o.type==="fields"&&this._writeFieldsContent(o,t)}writeLayerOptions(e,t,i,r){t[i]=!e||e.showNoDataRecords===null&&e.returnTopmostRaster===null?null:e.toJSON(r)}writeTitle(e,t){t.title=e||""}clone(){const{actions:e}=this,t=e?se(e.toArray()):[];return new Y6({actions:t,content:Array.isArray(this.content)?se(this.content):this.content,expressionInfos:Array.isArray(this.expressionInfos)?se(this.expressionInfos):null,fieldInfos:Array.isArray(this.fieldInfos)?se(this.fieldInfos):null,layerOptions:this.layerOptions?se(this.layerOptions):null,lastEditInfoEnabled:this.lastEditInfoEnabled,outFields:Array.isArray(this.outFields)?se(this.outFields):null,overwriteActions:this.overwriteActions,returnGeometry:this.returnGeometry,title:this.title,relatedRecordsInfo:this.relatedRecordsInfo?se(this.relatedRecordsInfo):null})}async collectRequiredFields(e,t){const i=this.expressionInfos||[];await this._collectExpressionInfoFields(e,t,[...i,...this._getContentExpressionInfos(this.content,i)]),FC(e,t,[...this.outFields||[],...this._getActionsFields(this.actions),...this._getTitleFields(this.title),...this._getContentFields(this.content)])}async getRequiredFields(e){const t=new Set;return await this.collectRequiredFields(t,e),[...t].sort()}_writeFieldsContent(e,t){if(!Array.isArray(e.fieldInfos)||!e.fieldInfos.length)return;const i=se(e.fieldInfos);Array.isArray(t.fieldInfos)?i.forEach(r=>{const s=t.fieldInfos.find(n=>n.fieldName.toLowerCase()===r.fieldName.toLowerCase());s?s.visible=!0:t.fieldInfos.push(r)}):t.fieldInfos=i}_writeAttachmentContent(e){e.showAttachments||(e.showAttachments=!0)}_writeTextContent(e,t){!t.description&&e.text&&(t.description=e.text)}_writeMediaContent(e,t){if(!Array.isArray(e.mediaInfos)||!e.mediaInfos.length)return;const i=se(e.mediaInfos);Array.isArray(t.mediaInfos)?t.mediaInfos=[...t.mediaInfos,...i]:t.mediaInfos=i}_readPopupInfoElements({description:e,mediaInfos:t,popupElements:i}){const r={description:!1,mediaInfos:!1};return i.map(s=>s.type==="media"?(s.mediaInfos||!t||r.mediaInfos||(s.mediaInfos=t,r.mediaInfos=!0),BC.fromJSON(s)):s.type==="text"?(s.text||!e||r.description||(s.text=e,r.description=!0),LT.fromJSON(s)):s.type==="attachments"?UC.fromJSON(s):s.type==="fields"?DT.fromJSON(s):s.type==="expression"?H7.fromJSON(s):void 0).filter(Boolean)}_readPopupInfo({description:e,mediaInfos:t,showAttachments:i}){const r=[];return e?r.push(new LT({text:e})):r.push(new DT),Array.isArray(t)&&t.length&&r.push(BC.fromJSON({mediaInfos:t})),i&&r.push(UC.fromJSON({displayType:"auto"})),r.length?r:e}_getContentElementFields(e){const t=e==null?void 0:e.type;if(t==="attachments")return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description)];if(t==="custom")return e.outFields||[];if(t==="fields")return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...this._getFieldInfoFields(e.fieldInfos||this.fieldInfos)];if(t==="media"){const i=e.mediaInfos||[];return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...i.reduce((r,s)=>[...r,...this._getMediaInfoFields(s)],[])]}return t==="text"?this._extractFieldNames(e.text):[]}_getMediaInfoFields(e){const{caption:t,title:i,value:r}=e,s=r||{},{fields:n=[],normalizeField:o,tooltipField:a,sourceURL:l,linkURL:c}=s,h=[...this._extractFieldNames(i),...this._extractFieldNames(t),...this._extractFieldNames(l),...this._extractFieldNames(c),...n];return o&&h.push(o),a&&h.push(a),h}_getContentExpressionInfos(e,t){return Array.isArray(e)?e.reduce((i,r)=>[...i,...r.type==="expression"&&r.expressionInfo?[r.expressionInfo]:[]],t):[]}_getContentFields(e){return typeof e=="string"?this._extractFieldNames(e):Array.isArray(e)?e.reduce((t,i)=>[...t,...this._getContentElementFields(i)],[]):[]}async _collectExpressionInfoFields(e,t,i){i&&await Promise.all(i.map(r=>wc(e,t,r.expression)))}_getFieldInfoFields(e){return e?e.filter(t=>t.visible===void 0||!!t.visible).map(t=>t.fieldName).filter(t=>t.indexOf("relationships/")===-1&&t.indexOf("expression/")===-1):[]}_getActionsFields(e){return e?e.toArray().reduce((t,i)=>[...t,...this._getActionFields(i)],[]):[]}_getActionFields(e){const{className:t,title:i,type:r}=e,s=r==="button"||r==="toggle"?e.image:"";return[...this._extractFieldNames(i),...this._extractFieldNames(t),...this._extractFieldNames(s)]}_getTitleFields(e){return typeof e=="string"?this._extractFieldNames(e):[]}_extractFieldNames(e){if(!e||typeof e!="string")return[];const t=/{[^}]*}/g,i=e.match(t);if(!i)return[];const r=/\{(\w+):.+\}/,s=i.filter(n=>!(n.indexOf("{relationships/")===0||n.indexOf("{expression/")===0)).map(n=>n.replace(r,"{$1}"));return s?s.map(n=>n.slice(1,-1)):[]}};u([d({type:xEe})],Bs.prototype,"actions",void 0),u([d()],Bs.prototype,"content",void 0),u([At("content")],Bs.prototype,"castContent",null),u([De("content",["description","fieldInfos","popupElements","mediaInfos","showAttachments"])],Bs.prototype,"readContent",null),u([Fe("content",{popupElements:{type:it.ofType(vEe)},showAttachments:{type:Boolean},mediaInfos:{type:it.ofType(vle)},description:{type:String}})],Bs.prototype,"writeContent",null),u([d({type:[_le],json:{write:!0}})],Bs.prototype,"expressionInfos",void 0),u([d({type:[cO]})],Bs.prototype,"fieldInfos",void 0),u([Fe("fieldInfos")],Bs.prototype,"writeFieldInfos",null),u([d({type:_Ee})],Bs.prototype,"layerOptions",void 0),u([Fe("layerOptions")],Bs.prototype,"writeLayerOptions",null),u([d({type:Boolean,json:{read:{source:"showLastEditInfo"},write:{target:"showLastEditInfo"},default:!0}})],Bs.prototype,"lastEditInfoEnabled",void 0),u([d()],Bs.prototype,"outFields",void 0),u([d()],Bs.prototype,"overwriteActions",void 0),u([d()],Bs.prototype,"returnGeometry",void 0),u([d({json:{type:String}})],Bs.prototype,"title",void 0),u([Fe("title")],Bs.prototype,"writeTitle",null),u([d({type:bEe,json:{write:!0}})],Bs.prototype,"relatedRecordsInfo",void 0),Bs=Y6=u([P(xle)],Bs);const kN=Bs,OY=new si({esriSMS:"simple-marker",esriPMS:"picture-marker",esriSLS:"simple-line",esriSFS:"simple-fill",esriPFS:"picture-fill",esriTS:"text",esriSHD:"shield-label-symbol",PointSymbol3D:"point-3d",LineSymbol3D:"line-3d",PolygonSymbol3D:"polygon-3d",WebStyleSymbol:"web-style",MeshSymbol3D:"mesh-3d",LabelSymbol3D:"label-3d",CIMSymbolReference:"cim"});let AEe=0,Tw=class extends fe{constructor(e){super(e),this.id="sym"+AEe++,this.type=null,this.color=new Je([0,0,0,1])}readColor(e){return e&&e[0]!=null?[e[0],e[1],e[2],e[3]/255]:e}async collectRequiredFields(e,t){}hash(){return JSON.stringify(this.toJSON())}clone(){}};u([d({type:OY.apiValues,readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0,writer:OY.write}}})],Tw.prototype,"type",void 0),u([d({type:Je,json:{write:{allowNull:!0}}})],Tw.prototype,"color",void 0),u([De("color")],Tw.prototype,"readColor",null),Tw=u([P("esri.symbols.Symbol")],Tw);const Al=Tw;var Z6;let zg=Z6=class extends Al{constructor(e){super(e),this.data=null,this.type="cim"}readData(e,t){return t}writeData(e,t){if(e)for(const i in e)t[i]=e[i]}async collectRequiredFields(e,t){if(this.data.type==="CIMSymbolReference"){const i=this.data.primitiveOverrides;if(i){const r=i.map(s=>{const n=s.valueExpressionInfo;return wc(e,t,n.expression)});await Promise.all(r)}}}clone(){return new Z6({data:se(this.data)})}hash(){return v7(JSON.stringify(this.data)).toString()}};u([d({json:{write:!1}})],zg.prototype,"color",void 0),u([d({json:{write:!0}})],zg.prototype,"data",void 0),u([De("data",["symbol"])],zg.prototype,"readData",null),u([Fe("data",{})],zg.prototype,"writeData",null),u([ut({CIMSymbolReference:"cim"},{readOnly:!0})],zg.prototype,"type",void 0),zg=Z6=u([P("esri.symbols.CIMSymbol")],zg);const $S=zg;let Sw=class extends fe{constructor(e){super(e),this.enabled=!0,this.type=null}writeEnabled(e,t,i){e||(t[i]=e)}};u([d({type:Boolean,json:{read:{source:"enable"},write:{target:"enable"}}})],Sw.prototype,"enabled",void 0),u([Fe("enabled")],Sw.prototype,"writeEnabled",null),u([d({type:["icon","object","line","path","fill","water","extrude","text"],readOnly:!0})],Sw.prototype,"type",void 0),Sw=u([P("esri.symbols.Symbol3DLayer")],Sw);const Fp=Sw,CEe=/^-?(\d+(\.\d+)?)\s*((px)|(pt))?$/i,REe="screenUtils.toPt: input not recognized!",Tle=96;function fo(e){return e?e/72*Tle:0}function Qh(e){return e?72*e/Tle:0}function Vi(e){if(typeof e=="string"){const t=e.match(CEe);if(t){const i=Number(t[1]),r=t[3]&&t[3].toLowerCase(),s=e.charAt(0)==="-",n=r==="px"?Qh(i):i;return s?-n:n}return console.warn(REe),null}return e}function Jh(e=0,t=0){return{x:e,y:t}}function Rr(e=0,t=0){return[e,t]}function OEe(e=0,t=0){return[e,t]}function zn(e=0,t=0,i=0){return[e,t,i]}function em(e,t){return t?(t[0]=e.x,t[1]=e.y,t.length>2&&(t[2]=0),t):[e.x,e.y]}function zN(e){const t=_7(100*(1-e));return Math.max(0,Math.min(t,100))}function NT(e){const t=1-e/100;return Math.max(0,Math.min(t,1))}function MEe(e,t){const i=t.transparency!=null?NT(t.transparency):1,r=t.color;return r&&Array.isArray(r)?new Je([r[0]||0,r[1]||0,r[2]||0,i]):null}function PEe(e,t){t.color=e.toJSON().slice(0,3);const i=zN(e.a);i!==0&&(t.transparency=i)}const Bm={type:Je,json:{type:[ir],default:null,read:{source:["color","transparency"],reader:MEe},write:{target:{color:{type:[ir]},transparency:{type:ir}},writer:PEe}}},xp={type:Number,cast:Vi,json:{write:!0}};let Nv=class extends fe{constructor(e){super(e),this.color=new Je([0,0,0,1]),this.extensionLength=0,this.size=Qh(1)}clone(){}cloneProperties(){return{color:se(this.color),size:this.size,extensionLength:this.extensionLength}}};u([d({type:["solid","sketch"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],Nv.prototype,"type",void 0),u([d(Bm)],Nv.prototype,"color",void 0),u([d(me(I({},xp),{json:{write:{overridePolicy:e=>({enabled:!!e})}}}))],Nv.prototype,"extensionLength",void 0),u([d(xp)],Nv.prototype,"size",void 0),Nv=u([P("esri.symbols.edges.Edges3D")],Nv);const Z7=Nv;var Q6;let pI=Q6=class extends Z7{constructor(e){super(e),this.type="sketch"}clone(){return new Q6(this.cloneProperties())}};u([ut({sketch:"sketch"},{readOnly:!0})],pI.prototype,"type",void 0),pI=Q6=u([P("esri.symbols.edges.SketchEdges3D")],pI);const IEe=pI;var J6;let fI=J6=class extends Z7{constructor(e){super(e),this.type="solid"}clone(){return new J6(this.cloneProperties())}};u([ut({solid:"solid"},{readOnly:!0})],fI.prototype,"type",void 0),fI=J6=u([P("esri.symbols.support.SolidEdges3D")],fI);const $Ee=fI,Sle={types:{key:"type",base:Z7,typeMap:{solid:$Ee,sketch:IEe}},json:{write:!0}};var K6;let pc=K6=class extends fe{constructor(e){super(e),this.color=null}clone(){const e={color:_(this.color)?this.color.clone():null};return new K6(e)}};u([d(Bm)],pc.prototype,"color",void 0),pc=K6=u([P("esri.symbols.support.Symbol3DMaterial")],pc);var eB;let Bg=eB=class extends Fp{constructor(e){super(e),this.type="extrude",this.size=1,this.material=null,this.castShadows=!0,this.edges=null}clone(){return new eB({edges:this.edges&&this.edges.clone(),enabled:this.enabled,material:_(this.material)?this.material.clone():null,castShadows:this.castShadows,size:this.size})}};u([ut({Extrude:"extrude"},{readOnly:!0})],Bg.prototype,"type",void 0),u([d({type:Number,json:{write:{enabled:!0,isRequired:!0}},nonNullable:!0})],Bg.prototype,"size",void 0),u([d({type:pc,json:{write:!0}})],Bg.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],Bg.prototype,"castShadows",void 0),u([d(Sle)],Bg.prototype,"edges",void 0),Bg=eB=u([P("esri.symbols.ExtrudeSymbol3DLayer")],Bg);const Q7=Bg;let DE=class extends Al{constructor(e){super(e),this.type="simple-line",this.width=.75}hash(){return`${this.type}.${this.width}`}};u([ut({esriSLS:"simple-line"},{readOnly:!0})],DE.prototype,"type",void 0),u([d({type:Number,cast:Vi,json:{write:!0}})],DE.prototype,"width",void 0),DE=u([P("esri.symbols.LineSymbol")],DE);const DEe=DE,LEe=["begin","end","begin-end"],Ele=["arrow","circle","square","diamond","cross","x"];var tB;let Pd=tB=class extends fe{constructor(e){super(e),this.placement="begin-end",this.type="line-marker",this.style="arrow"}writeStyle(e,t,i,r){(r==null?void 0:r.origin)==="web-map"?t[i]="arrow":t[i]=e}set color(e){this._set("color",e)}readColor(e){return e&&e[0]!=null?[e[0],e[1],e[2],e[3]/255]:e}writeColor(e,t,i,r){(r==null?void 0:r.origin)==="web-map"||(t[i]=e)}clone(){return new tB({color:se(this.color),placement:this.placement,style:this.style})}hash(){var e;return`${this.placement}.${(e=this.color)==null?void 0:e.hash()}.${this.style}`}};u([d({type:["begin","end","begin-end"],json:{write:!0}})],Pd.prototype,"placement",void 0),u([ut({"line-marker":"line-marker"},{readOnly:!0}),d({json:{origins:{"web-map":{write:!1}}}})],Pd.prototype,"type",void 0),u([d({type:Ele})],Pd.prototype,"style",void 0),u([Fe("style")],Pd.prototype,"writeStyle",null),u([d({type:Je,value:null,json:{write:{allowNull:!0}}})],Pd.prototype,"color",null),u([De("color")],Pd.prototype,"readColor",null),u([Fe("color")],Pd.prototype,"writeColor",null),Pd=tB=u([P("esri.symbols.LineSymbolMarker")],Pd);const NEe=Pd;var iB;const E5=new si({esriSLSSolid:"solid",esriSLSDash:"dash",esriSLSDot:"dot",esriSLSDashDot:"dash-dot",esriSLSDashDotDot:"long-dash-dot-dot",esriSLSNull:"none",esriSLSInsideFrame:"inside-frame",esriSLSShortDash:"short-dash",esriSLSShortDot:"short-dot",esriSLSShortDashDot:"short-dash-dot",esriSLSShortDashDotDot:"short-dash-dot-dot",esriSLSLongDash:"long-dash",esriSLSLongDashDot:"long-dash-dot"});let yf=iB=class extends DEe{constructor(...e){super(...e),this.type="simple-line",this.style="solid",this.cap="round",this.join="round",this.marker=null,this.miterLimit=2}normalizeCtorArgs(e,t,i,r,s,n){if(e&&typeof e!="string")return e;const o={};return e!=null&&(o.style=e),t!=null&&(o.color=t),i!=null&&(o.width=Vi(i)),r!=null&&(o.cap=r),s!=null&&(o.join=s),n!=null&&(o.miterLimit=Vi(n)),o}clone(){var e;return new iB({color:se(this.color),style:this.style,width:this.width,cap:this.cap,join:this.join,miterLimit:this.miterLimit,marker:(e=this.marker)==null?void 0:e.clone()})}hash(){var e,t;return`${super.hash()}.${(e=this.color)==null?void 0:e.hash()}.${this.style}.${this.cap}.${this.join}.${this.miterLimit}.${(t=this.marker)==null?void 0:t.hash()}`}};u([ut({esriSLS:"simple-line"},{readOnly:!0})],yf.prototype,"type",void 0),u([d({type:E5.apiValues,json:{read:E5.read,write:E5.write}})],yf.prototype,"style",void 0),u([d({type:["butt","round","square"],json:{write:{overridePolicy:(e,t,i)=>({enabled:e!=="round"&&(i==null||i.origin==null)})}}})],yf.prototype,"cap",void 0),u([d({type:["miter","round","bevel"],json:{write:{overridePolicy:(e,t,i)=>({enabled:e!=="round"&&(i==null||i.origin==null)})}}})],yf.prototype,"join",void 0),u([d({types:{key:"type",base:null,defaultKeyValue:"line-marker",typeMap:{"line-marker":NEe}},json:{write:!0,origins:{"web-scene":{write:!1}}}})],yf.prototype,"marker",void 0),u([d({type:Number,json:{read:!1,write:!1}})],yf.prototype,"miterLimit",void 0),yf=iB=u([P("esri.symbols.SimpleLineSymbol")],yf);const sd=yf;let LE=class extends Al{constructor(e){super(e),this.outline=null,this.type=null}hash(){return`${this.type}.${this.outline&&this.outline.hash()}`}};u([d({types:{key:"type",base:null,defaultKeyValue:"simple-line",typeMap:{"simple-line":sd}},json:{default:null,write:!0}})],LE.prototype,"outline",void 0),u([d({type:["simple-fill","picture-fill"],readOnly:!0})],LE.prototype,"type",void 0),LE=u([P("esri.symbols.FillSymbol")],LE);const Ale=LE;let mI=class extends fe{constructor(e){super(e)}clone(){}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],mI.prototype,"type",void 0),mI=u([P("esri.symbols.patterns.LinePattern3D")],mI);const Cle=mI,FEe=["dash","dash-dot","dot","long-dash","long-dash-dot","long-dash-dot-dot","none","short-dash","short-dash-dot","short-dash-dot-dot","short-dot","solid"];var rB;const UEe=_o()({dash:"dash","dash-dot":"dash-dot","dash-dot-dot":"long-dash-dot-dot",dot:"dot","long-dash":"long-dash","long-dash-dot":"long-dash-dot",null:"none","short-dash":"short-dash","short-dash-dot":"short-dash-dot","short-dash-dot-dot":"short-dash-dot-dot","short-dot":"short-dot",solid:"solid"});let NE=rB=class extends Cle{constructor(e){super(e),this.type="style",this.style="solid"}clone(){const e={style:this.style};return new rB(e)}};u([d({type:["style"]})],NE.prototype,"type",void 0),u([ut(UEe),d({type:FEe})],NE.prototype,"style",void 0),NE=rB=u([P("esri.symbols.patterns.LineStylePattern3D")],NE);const J7=NE;let gI=class extends fe{constructor(e){super(e)}clone(){}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],gI.prototype,"type",void 0),gI=u([P("esri.symbols.patterns.Pattern3D")],gI);const Rle=gI,kEe=["backward-diagonal","cross","diagonal-cross","forward-diagonal","horizontal","none","solid","vertical"];var sB;let FE=sB=class extends Rle{constructor(e){super(e),this.type="style",this.style="solid"}clone(){const e={style:this.style};return new sB(e)}};u([d({type:["style"]})],FE.prototype,"type",void 0),u([d({type:kEe,json:{read:!0,write:!0}})],FE.prototype,"style",void 0),FE=sB=u([P("esri.symbols.patterns.StylePattern3D")],FE);const Ole=FE,zEe={types:{key:"type",base:Rle,typeMap:{style:Ole}},json:{write:!0}},Mle={types:{key:"type",base:Cle,typeMap:{style:J7}},json:{write:!0}},jA=new Je("white");new Je("black");const BEe=new Je([255,255,255,0]);function VEe(e){return e.r===0&&e.g===0&&e.b===0}var nB;let HA=nB=class extends pc{constructor(e){super(e),this.colorMixMode=null}clone(){const e={color:_(this.color)?this.color.clone():null,colorMixMode:this.colorMixMode};return new nB(e)}};u([ut({multiply:"multiply",replace:"replace",tint:"tint"})],HA.prototype,"colorMixMode",void 0),HA=nB=u([P("esri.symbols.support.Symbol3DFillMaterial")],HA);function Dt(e=XEe){return[e[0],e[1],e[2],e[3]]}function omt(e){return[e[0],e[1],e[2],e[3]]}function y0(e,t){return e!==t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]),e}function GEe(e,t,i,r,s=Dt()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function Ple(e,t=Dt()){return t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax,t}function BN(e,t){return new Xt({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:t})}function Ile(e,t){t[0]<e[0]&&(e[0]=t[0]),t[0]>e[2]&&(e[2]=t[0]),t[1]<e[1]&&(e[1]=t[1]),t[1]>e[3]&&(e[3]=t[1])}function n0(e,t,i){if(R(t))y0(i,e);else if("length"in t)aB(t)?(i[0]=Math.min(e[0],t[0]),i[1]=Math.min(e[1],t[1]),i[2]=Math.max(e[2],t[2]),i[3]=Math.max(e[3],t[3])):t.length!==2&&t.length!==3||(i[0]=Math.min(e[0],t[0]),i[1]=Math.min(e[1],t[1]),i[2]=Math.max(e[2],t[0]),i[3]=Math.max(e[3],t[1]));else switch(t.type){case"extent":i[0]=Math.min(e[0],t.xmin),i[1]=Math.min(e[1],t.ymin),i[2]=Math.max(e[2],t.xmax),i[3]=Math.max(e[3],t.ymax);break;case"point":i[0]=Math.min(e[0],t.x),i[1]=Math.min(e[1],t.y),i[2]=Math.max(e[2],t.x),i[3]=Math.max(e[3],t.y)}}function A5(e,t,i=e){const r=t.length;let s=e[0],n=e[1],o=e[2],a=e[3];for(let l=0;l<r;l++){const c=t[l];s=Math.min(s,c[0]),n=Math.min(n,c[1]),o=Math.max(o,c[0]),a=Math.max(a,c[1])}return i[0]=s,i[1]=n,i[2]=o,i[3]=a,i}function oB(e){for(let t=0;t<4;t++)if(!isFinite(e[t]))return!1;return!0}function tm(e){return R(e)||e[0]>=e[2]?0:e[2]-e[0]}function A1(e){return e[1]>=e[3]?0:e[3]-e[1]}function amt(e){return tm(e)*A1(e)}function K7(e,t=[0,0]){return t[0]=(e[0]+e[2])/2,t[1]=(e[1]+e[3])/2,t}function ej(e,t){return $le(e,t[0],t[1])}function jEe(e,t){const i=t[3],r=.5*(e[0]+e[2]),s=Math.abs(t[0]-r),n=.5*(e[2]-e[0]);if(s>i+n)return!1;const o=.5*(e[1]+e[3]),a=.5*(e[3]-e[1]),l=Math.abs(t[1]-o);if(l>i+a)return!1;if(s<n||l<a)return!0;const c=s-n,h=l-a;return c*c+h*h<=i*i}function lmt(e,t,i){const r=e[0],s=e[1],n=e[2],o=e[3],{x:a,y:l}=t,{x:c,y:h}=i,p=(b,w)=>(h-l)*b+(a-c)*w+(c*l-a*h)<0,f=p(r,o),g=p(n,o),y=p(n,s),v=p(r,s);return!(f===g&&g===y&&y===v&&v===f||a<r&&c<r||a>n&&c>n||l>o&&h>o||l<s&&h<s)}function cmt(e,t){return $le(e,t.x,t.y)}function $le(e,t,i){return t>=e[0]&&i>=e[1]&&t<=e[2]&&i<=e[3]}function HEe(e,t,i){return t[0]>=e[0]-i&&t[1]>=e[1]-i&&t[0]<=e[2]+i&&t[1]<=e[3]+i}function VN(e,t){return Math.max(t[0],e[0])<=Math.min(t[2],e[2])&&Math.max(t[1],e[1])<=Math.min(t[3],e[3])}function MY(e,t){return t[0]>=e[0]&&t[2]<=e[2]&&t[1]>=e[1]&&t[3]<=e[3]}function yI(e,t,i){if(R(t))return y0(i,e);const r=t[0],s=t[1],n=t[2],o=t[3];return i[0]=Be(e[0],r,n),i[1]=Be(e[1],s,o),i[2]=Be(e[2],r,n),i[3]=Be(e[3],s,o),i}function qEe(e,t){const i=(e[0]+e[2])/2,r=(e[1]+e[3])/2,s=Math.max(Math.abs(t[0]-i)-tm(e)/2,0),n=Math.max(Math.abs(t[1]-r)-A1(e)/2,0);return Math.sqrt(s*s+n*n)}function SD(e,t,i,r=e){return r[0]=e[0]+t,r[1]=e[1]+i,r[2]=e[2]+t,r[3]=e[3]+i,r}function $u(e){return e?y0(e,PY):Dt(PY)}function aB(e){return e!=null&&e.length===4}function WEe(e){return!(tm(e)!==0&&isFinite(e[0])||A1(e)!==0&&isFinite(e[1]))}function s1(e,t){return aB(e)&&aB(t)?e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]:e===t}const umt=[-1/0,-1/0,1/0,1/0],PY=[1/0,1/0,-1/0,-1/0],XEe=[0,0,0,0];function cs(e=Fle){return[e[0],e[1],e[2],e[3],e[4],e[5]]}function C1(e,t,i,r,s,n,o=cs()){return o[0]=e,o[1]=t,o[2]=i,o[3]=r,o[4]=s,o[5]=n,o}function FT(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.min(e[2],t[2]),e[3]=Math.max(e[3],t[3]),e[4]=Math.max(e[4],t[4]),e[5]=Math.max(e[5],t[5])}function YEe(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[3]=Math.max(e[3],t[2]),e[4]=Math.max(e[4],t[3])}function Tp(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.min(e[2],t[2]),e[3]=Math.max(e[3],t[0]),e[4]=Math.max(e[4],t[1]),e[5]=Math.max(e[5],t[2])}function uc(e,t,i=0,r=t.length/3){let s=e[0],n=e[1],o=e[2],a=e[3],l=e[4],c=e[5];for(let h=0;h<r;h++)s=Math.min(s,t[i+3*h]),n=Math.min(n,t[i+3*h+1]),o=Math.min(o,t[i+3*h+2]),a=Math.max(a,t[i+3*h]),l=Math.max(l,t[i+3*h+1]),c=Math.max(c,t[i+3*h+2]);e[0]=s,e[1]=n,e[2]=o,e[3]=a,e[4]=l,e[5]=c}function ZEe(e,t,i,r){e[0]=Math.min(e[0],e[0]+t),e[3]=Math.max(e[3],e[3]+t),e[1]=Math.min(e[1],e[1]+i),e[4]=Math.max(e[4],e[4]+i),e[2]=Math.min(e[2],e[2]+r),e[5]=Math.max(e[5],e[5]+r)}function C5(e,t,i){const r=t.length;let s=e[0],n=e[1],o=e[2],a=e[3],l=e[4],c=e[5];if(i)for(let h=0;h<r;h++){const p=t[h];s=Math.min(s,p[0]),n=Math.min(n,p[1]),o=Math.min(o,p[2]),a=Math.max(a,p[0]),l=Math.max(l,p[1]),c=Math.max(c,p[2])}else for(let h=0;h<r;h++){const p=t[h];s=Math.min(s,p[0]),n=Math.min(n,p[1]),a=Math.max(a,p[0]),l=Math.max(l,p[1])}e[0]=s,e[1]=n,e[2]=o,e[3]=a,e[4]=l,e[5]=c}function QEe(e){for(let t=0;t<6;t++)if(!isFinite(e[t]))return!1;return!0}function DS(e){return e[0]>=e[3]?0:e[3]-e[0]}function LS(e){return e[1]>=e[4]?0:e[4]-e[1]}function lb(e){return e[2]>=e[5]?0:e[5]-e[2]}function JEe(e){const t=DS(e),i=lb(e),r=LS(e);return Math.sqrt(t*t+i*i+r*r)}function Fh(e,t=[0,0,0]){return t[0]=e[0]+DS(e)/2,t[1]=e[1]+LS(e)/2,t[2]=e[2]+lb(e)/2,t}function mM(e,t=[0,0,0]){return t[0]=DS(e),t[1]=LS(e),t[2]=lb(e),t}function KEe(e){return Math.max(DS(e),lb(e),LS(e))}function tj(e,t){return t[0]>=e[0]&&t[1]>=e[1]&&t[2]>=e[2]&&t[0]<=e[3]&&t[1]<=e[4]&&t[2]<=e[5]}function hmt(e,t){return t[0]>=e[0]&&t[1]>=e[1]&&t[2]>=e[2]&&t[3]<=e[3]&&t[4]<=e[4]&&t[5]<=e[5]}function eAe(e,t){return Math.max(t[0],e[0])<=Math.min(t[3],e[3])&&Math.max(t[1],e[1])<=Math.min(t[4],e[4])&&Math.max(t[2],e[2])<=Math.min(t[5],e[5])}function Uh(e,t){return!!R(t)||eAe(e,t)}function Dle(e,t,i,r,s=e){return s[0]=e[0]+t,s[1]=e[1]+i,s[2]=e[2]+r,s[3]=e[3]+t,s[4]=e[4]+i,s[5]=e[5]+r,s}function Lle(e,t,i=e){return i[0]=t[0],i[1]=t[1],i[2]=t[2],i!==e&&(i[3]=e[3],i[4]=e[4],i[5]=e[5]),i}function Nle(e,t,i=e){return i[3]=t[0],i[4]=t[1],i[5]=t[2],i!==e&&(i[0]=e[0],i[1]=e[1],i[2]=e[2]),e}function GN(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function ki(e){return e?GN(e,$Y):cs($Y)}function ij(e,t){return t||(t=Dt()),t[0]=e[0],t[1]=e[1],t[2]=e[3],t[3]=e[4],t}function dmt(e,t){return e[0]=t[0],e[1]=t[1],e[2]=Number.NEGATIVE_INFINITY,e[3]=t[2],e[4]=t[3],e[5]=Number.POSITIVE_INFINITY,e}function IY(e){return e.length===6}function jN(e){return DS(e)===0&&LS(e)===0&&lb(e)===0}function pmt(e,t,i){if(R(e)||R(t))return e===t;if(!IY(e)||!IY(t))return!1;if(i){for(let r=0;r<e.length;r++)if(!i(e[r],t[r]))return!1}else for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function tAe(e,t,i,r,s,n){return C1(e,t,i,r,s,n,iAe)}const fmt=[-1/0,-1/0,-1/0,1/0,1/0,1/0],$Y=[1/0,1/0,1/0,-1/0,-1/0,-1/0],Fle=[0,0,0,0,0,0],iAe=cs();function R5(e,{isPrimitive:t,width:i,depth:r,height:s}){const n=t?10:1;if(i==null&&s==null&&r==null)return[n*e[0],n*e[1],n*e[2]];const o=je(i,r,s);let a;for(let l=0;l<3;l++){const c=o[l];if(c!=null){a=c/e[l];break}}for(let l=0;l<3;l++)o[l]==null&&(o[l]=e[l]*a);return o}const rAe=C1(-.5,-.5,-.5,.5,.5,.5),sAe=C1(-.5,-.5,0,.5,.5,1),nAe=C1(-.5,-.5,0,.5,.5,.5);function oAe(e){switch(e){case"sphere":case"cube":case"diamond":return rAe;case"cylinder":case"cone":case"inverted-cone":return sAe;case"tetrahedron":return nAe;default:return}}const rj=["butt","square","round"],aAe=[...rj,"none"],Ule=["miter","bevel","round"];var lB;let Fv=lB=class extends fe{constructor(e){super(e),this.color=new Je([0,0,0,1]),this.size=Qh(1),this.pattern=null,this.patternCap="butt"}clone(){const e={color:_(this.color)?this.color.clone():null,size:this.size,pattern:_(this.pattern)?this.pattern.clone():null,patternCap:this.patternCap};return new lB(e)}};u([d(Bm)],Fv.prototype,"color",void 0),u([d(xp)],Fv.prototype,"size",void 0),u([d(Mle)],Fv.prototype,"pattern",void 0),u([d({type:rj,json:{default:"butt",write:{overridePolicy(){return{enabled:_(this.pattern)}}}}})],Fv.prototype,"patternCap",void 0),Fv=lB=u([P("esri.symbols.support.Symbol3DOutline")],Fv);var vI;let vf=vI=class extends Fp{constructor(e){super(e),this.type="fill",this.material=null,this.pattern=null,this.castShadows=!0,this.outline=null,this.edges=null}clone(){const e={edges:_(this.edges)?this.edges.clone():null,enabled:this.enabled,material:_(this.material)?this.material.clone():null,pattern:_(this.pattern)?this.pattern.clone():null,castShadows:this.castShadows,outline:_(this.outline)?this.outline.clone():null};return new vI(e)}static fromSimpleFillSymbol(e){var t,i,r,s,n,o;const a=e.outline&&e.outline.style&&e.outline.style!=="inside-frame"&&e.outline.style!=="solid"?new J7({style:e.outline.style}):null,l={size:(t=(i=e.outline)==null?void 0:i.width)!=null?t:0,color:((r=(s=e.outline)==null?void 0:s.color)!=null?r:jA).clone(),pattern:a};return a&&(n=e.outline)!=null&&n.cap&&(l.patternCap=e.outline.cap),new vI({material:new HA({color:((o=e.color)!=null?o:BEe).clone()}),pattern:e.style&&e.style!=="solid"?new Ole({style:e.style}):null,outline:l})}};u([ut({Fill:"fill"},{readOnly:!0})],vf.prototype,"type",void 0),u([d({type:HA,json:{write:!0}})],vf.prototype,"material",void 0),u([d(zEe)],vf.prototype,"pattern",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],vf.prototype,"castShadows",void 0),u([d({type:Fv,json:{write:!0}})],vf.prototype,"outline",void 0),u([d(Sle)],vf.prototype,"edges",void 0),vf=vI=u([P("esri.symbols.FillSymbol3DLayer")],vf);const uO=vf,lAe=["none","underline","line-through"],cAe=["normal","italic","oblique"],uAe=["normal","lighter","bold","bolder"],kle={type:Number,cast:e=>{const t=mu(e);return t===0?1:Be(t,.1,4)},nonNullable:!0},hAe=["left","right","center","justify"],dAe=["left","right","center"],pAe=["baseline","top","middle","bottom"],fAe={type:hAe,nonNullable:!0},mAe={type:dAe,nonNullable:!0},zle={type:pAe,nonNullable:!0};var cB;let _f=cB=class extends fe{constructor(e){super(e),this.decoration="none",this.family="sans-serif",this.size=9,this.style="normal",this.weight="normal"}castSize(e){return Vi(e)}clone(){return new cB({decoration:this.decoration,family:this.family,size:this.size,style:this.style,weight:this.weight})}hash(){return`${this.decoration}.${this.family}.${this.size}.${this.style}.${this.weight}`}};u([d({type:lAe,json:{default:"none",write:!0}})],_f.prototype,"decoration",void 0),u([d({type:String,json:{write:!0}})],_f.prototype,"family",void 0),u([d({type:Number,json:{write:{overridePolicy:(e,t,i)=>({enabled:!i||!i.textSymbol3D})}}})],_f.prototype,"size",void 0),u([At("size")],_f.prototype,"castSize",null),u([d({type:cAe,json:{default:"normal",write:!0}})],_f.prototype,"style",void 0),u([d({type:uAe,json:{default:"normal",write:!0}})],_f.prototype,"weight",void 0),_f=cB=u([P("esri.symbols.Font")],_f);const HN=_f,gAe=he.getLogger("esri.core.urlUtils"),NS=Bi.request,DY="esri/config: esriConfig.request.proxyUrl is not set.",Ble=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,Vle=/^\s*http:/i,yAe=/^\s*https:/i,vAe=/^\s*file:/i,_Ae=/:\d+$/,bAe=/^https?:\/\/[^/]+\.arcgis.com\/sharing(\/|$)/i,wAe=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),xAe=new RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$");class Qx{constructor(t=""){this.uri=t,this.scheme=null,this.authority=null,this.path=null,this.query=null,this.fragment=null,this.user=null,this.password=null,this.host=null,this.port=null;let i=this.uri.match(wAe);this.scheme=i[2]||(i[1]?"":null),this.authority=i[4]||(i[3]?"":null),this.path=i[5],this.query=i[7]||(i[6]?"":null),this.fragment=i[9]||(i[8]?"":null),this.authority!=null&&(i=this.authority.match(xAe),this.user=i[3]||null,this.password=i[4]||null,this.host=i[6]||i[7],this.port=i[9]||null)}toString(){return this.uri}}const gM={},TAe=new Qx(Bi.applicationUrl);let jo=TAe;const SAe=EAe();let sj=SAe;const Gle=()=>jo,mmt=()=>sj;function EAe(){const e=jo.path,t=e.substring(0,e.lastIndexOf(e.split("/")[e.split("/").length-1]));return`${`${jo.scheme}://${jo.host}${jo.port!=null?`:${jo.port}`:""}`}${t}`}function Ts(e){const t={path:null,query:null},i=new Qx(e),r=e.indexOf("?");return i.query===null?t.path=e:(t.path=e.substring(0,r),t.query=jle(i.query)),i.fragment&&(t.hash=i.fragment,i.query===null&&(t.path=t.path.substring(0,t.path.length-(i.fragment.length+1)))),t}function jle(e){const t=e.split("&"),i={};for(const r of t){if(!r)continue;const s=r.indexOf("=");let n,o;s<0?(n=decodeURIComponent(r),o=""):(n=decodeURIComponent(r.slice(0,s)),o=decodeURIComponent(r.slice(s+1)));let a=i[n];typeof a=="string"&&(a=i[n]=[a]),Array.isArray(a)?a.push(o):i[n]=o}return i}function LY(e){return e&&typeof e=="object"&&"toJSON"in e&&typeof e.toJSON=="function"}function VC(e,t){return e?t&&typeof t=="function"?Object.keys(e).map(i=>encodeURIComponent(i)+"="+encodeURIComponent(t(i,e[i]))).join("&"):Object.keys(e).map(i=>{const r=e[i];if(r==null)return"";const s=encodeURIComponent(i)+"=",n=t&&t[i];return n?s+encodeURIComponent(n(r)):Array.isArray(r)?r.map(o=>LY(o)?s+encodeURIComponent(JSON.stringify(o)):s+encodeURIComponent(o)).join("&"):LY(r)?s+encodeURIComponent(JSON.stringify(r)):s+encodeURIComponent(r)}).filter(i=>i).join("&"):""}function AAe(e=!1){let t,i=NS.proxyUrl;if(typeof e=="string"){t=$Ae(e);const r=qN(e);r&&(i=r.proxyUrl)}else t=!!e;if(!i)throw gAe.warn(DY),new q("urlutils:proxy-not-set",DY);return t&&uB()&&(i=cj(i)),Ts(i)}function CAe(e){const t=qN(e);let i,r;if(t){const s=nj(t.proxyUrl);i=s.path,r=s.query?jle(s.query):null}if(i){const s=Ts(e);e=i+"?"+s.path;const n=VC(I(I({},r),s.query));n&&(e=`${e}?${n}`)}return e}const m2={path:"",query:""};function nj(e){const t=e.indexOf("?");return t!==-1?(m2.path=e.slice(0,t),m2.query=e.slice(t+1)):(m2.path=e,m2.query=null),m2}function Hle(e){return e=(e=AD(e=kAe(e=nj(e).path),!0)).toLowerCase()}function RAe(e){const t={proxyUrl:e.proxyUrl,urlPrefix:Hle(e.urlPrefix)},i=NS.proxyRules,r=t.urlPrefix;let s=i.length;for(let n=0;n<i.length;n++){const o=i[n].urlPrefix;if(r.indexOf(o)===0){if(r.length===o.length)return-1;s=n;break}o.indexOf(r)===0&&(s=n+1)}return i.splice(s,0,t),s}function qN(e){const t=NS.proxyRules,i=Hle(e);for(let r=0;r<t.length;r++)if(i.indexOf(t[r].urlPrefix)===0)return t[r]}function qle(e,t){return e=NY(e),t=NY(t),AD(e)===AD(t)}function NY(e){const t=(e=Pu(e)).indexOf("/sharing");return t>0?e.substring(0,t):e.replace(/\/+$/,"")}function Wle(e){const t=r=>r==null||r instanceof RegExp&&r.test(e)||typeof r=="string"&&e.startsWith(r),i=NS.interceptors;if(i){for(const r of i)if(Array.isArray(r.urls)){if(r.urls.some(t))return r}else if(t(r.urls))return r}return null}function ED(e,t,i=!1){const r=dB(e),s=dB(t);return!(!i&&r.scheme!==s.scheme)&&r.host!=null&&s.host!=null&&r.host.toLowerCase()===s.host.toLowerCase()&&r.port===s.port}function oj(e){if(typeof e=="string"){if(!fc(e))return!0;e=dB(e)}if(ED(e,jo))return!0;const t=NS.trustedServers||[];for(let i=0;i<t.length;i++){const r=OAe(t[i]);for(let s=0;s<r.length;s++)if(ED(e,r[s]))return!0}return!1}function OAe(e){return gM[e]||(lj(e)||Sp(e)?gM[e]=[new Qx(Au(e))]:gM[e]=[new Qx(`http://${e}`),new Qx(`https://${e}`)]),gM[e]}function Au(e,t=sj,i){return Sp(e)?i&&i.preserveProtocolRelative?e:jo.scheme==="http"&&jo.authority===FS(e).slice(2)?`http:${e}`:`https:${e}`:lj(e)?e:bl(e[0]==="/"?FAe(t):t,e)}function aj(e,t=sj,i){if(!fc(e))return e;const r=Pu(e),s=r.toLowerCase(),n=Pu(t).toLowerCase().replace(/\/+$/,""),o=i?Pu(i).toLowerCase().replace(/\/+$/,""):null;if(o&&n.indexOf(o)!==0)return e;const a=(p,f,g)=>(g=p.indexOf(f,g))===-1?p.length:g;let l=a(s,"/",s.indexOf("//")+2),c=-1;for(;s.slice(0,l+1)===n.slice(0,l)+"/"&&(c=l+1,l!==s.length);)l=a(s,"/",l+1);if(c===-1||o&&c<o.length)return e;e=r.slice(c);const h=n.slice(c-1).replace(/[^/]+/g,"").length;if(h>0)for(let p=0;p<h;p++)e=`../${e}`;else e=`./${e}`;return e}function Pu(e){return e=VAe(e=BAe(e=zAe(e=Au(e=e.trim()))))}function bl(...e){const t=e.filter(_);if(!t||!t.length)return;const i=[];if(fc(t[0])){const s=t[0],n=s.indexOf("//");n!==-1&&(i.push(s.slice(0,n+1)),LAe(t[0])&&(i[0]+="/"),t[0]=s.slice(n+2))}else t[0][0]==="/"&&i.push("");const r=t.reduce((s,n)=>n?s.concat(n.split("/")):s,[]);for(let s=0;s<r.length;s++){const n=r[s];n===".."&&i.length>0&&i[i.length-1]!==".."?i.pop():(!n&&s===r.length-1||n&&(n!=="."||i.length===0))&&i.push(n)}return i.join("/")}function FS(e,t=!1){if(UT(e)||Up(e))return null;let i=e.indexOf("://");if(i===-1&&Sp(e))i=2;else{if(i===-1)return null;i+=3}const r=e.indexOf("/",i);return r!==-1&&(e=e.slice(0,r)),t&&(e=AD(e,!0)),e}function fc(e){return Sp(e)||lj(e)}function UT(e){return e!=null&&e.slice(0,5)==="blob:"}function Up(e){return e.slice(0,5)==="data:"}function Xle(e){const t=WN(e);if(!t||!t.isBase64)return null;const i=atob(t.data),r=new Uint8Array(i.length);for(let s=0;s<i.length;s++)r[s]=i.charCodeAt(s);return r.buffer}function gmt(e){return btoa(String.fromCharCode.apply(null,e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}const MAe=/^data:(.*?)(;base64)?,(.*)$/;function WN(e){const t=e.match(MAe);if(!t)return null;const[,i,r,s]=t;return{mediaType:i,isBase64:!!r,data:s}}function Yle(e){return e.isBase64?`data:${e.mediaType};base64,${e.data}`:`data:${e.mediaType},${e.data}`}function ymt(e,t){PAe(e,t)||IAe(e,t)}function PAe(e,t){if(!e)return!1;const i=document.createElement("a");if(!("download"in i))return!1;const r=URL.createObjectURL(e);return i.download=t,i.href=r,i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r),!0}function IAe(e,t){return!!window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveOrOpenBlob(e,t)}function Sp(e){return e!=null&&e!==void 0&&e[0]==="/"&&e[1]==="/"}function lj(e){return Ble.test(e)}function $Ae(e){return yAe.test(e)||jo.scheme==="https"&&Sp(e)}function DAe(e){return Vle.test(e)||jo.scheme==="http"&&Sp(e)}function LAe(e){return vAe.test(e)}function cj(e){return Sp(e)?`https:${e}`:e.replace(Vle,"https:")}function NAe(){return jo.scheme==="http"}function uB(){return jo.scheme==="https"}function AD(e,t=!1){return Sp(e)?e.slice(2):(e=e.replace(Ble,""),t&&e.length>1&&e[0]==="/"&&e[1]==="/"&&(e=e.slice(2)),e)}function FAe(e){const t=e.indexOf("//"),i=e.indexOf("/",t+2);return i===-1?e:e.slice(0,i)}function UAe(e){let t=0;if(fc(e)){const r=e.indexOf("//");r!==-1&&(t=r+2)}const i=e.lastIndexOf("/");return i<t?e:e.slice(0,i+1)}function vmt(e,t){if(!e)return"";const i=Ts(e).path.replace(/\/+$/,""),r=i.substring(i.lastIndexOf("/")+1);if(t==null||!t.length)return r;const s=new RegExp(`.(${t.join("|")})$`,"ig");return r.replace(s,"")}function kAe(e){return e&&e[e.length-1]==="/"?e:`${e}/`}function Zle(e){return e.replace(/\/+$/,"")}function zAe(e){if(/^https?:\/\//i.test(e)){const t=nj(e);e=(e=t.path.replace(/\/{2,}/g,"/")).replace("/","//"),t.query&&(e+=`?${t.query}`)}return e}function BAe(e){return e.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function VAe(e){const t=NS.httpsDomains;if(!DAe(e))return e;const i=e.indexOf("/",7);let r;if(r=i===-1?e:e.slice(0,i),r=r.toLowerCase().slice(7),_Ae.test(r)){if(!r.endsWith(":80"))return e;r=r.slice(0,-3),e=e.replace(":80","")}return NAe()&&r===jo.authority&&!bAe.test(e)||(uB()&&r===jo.authority||t&&t.some(s=>r===s||r.endsWith(`.${s}`))||uB()&&!qN(e))&&(e=cj(e)),e}function hB(e,t,i){if(!(t&&i&&e&&fc(e)))return e;const r=e.indexOf("//"),s=e.indexOf("/",r+2),n=e.indexOf(":",r+2),o=Math.min(s<0?e.length:s,n<0?e.length:n);return e.slice(r+2,o).toLowerCase()!==t.toLowerCase()?e:`${e.slice(0,r+2)}${i}${e.slice(o)}`}function dB(e){return typeof e=="string"?new Qx(Au(e)):(e.scheme||(e.scheme=jo.scheme),e)}function uj(e){return HAe.test(e)}function Qle(e,t){const i=Ts(e),r=Object.keys(i.query||{});return r.length>0&&t&&t.warn("removeQueryParameters()",`Url query parameters are not supported, the following parameters have been removed: ${r.join(", ")}.`),i.path}function hj(e,t,i){const r=Ts(e),s=r.query||{};return s[t]=String(i),`${r.path}?${VC(s)}`}function FY(e,t){const i=Ts(e),r=i.query||{};for(const n in t)r[n]=t[n];const s=VC(r);return s?`${i.path}?${s}`:i.path}function GAe(e){if(R(e))return null;const t=e.match(jAe);return t?t[1]:null}const jAe=/.*?\.([^\/]*)$/,HAe=/(^data:image\/svg|\.svg$)/i;function US(e,t){const i=t&&t.url&&t.url.path;if(e&&i&&(e=Au(e,i,{preserveProtocolRelative:!0}),t.portalItem&&t.readResourcePaths)){const r=aj(e,t.portalItem.itemUrl);WAe.test(r)&&t.readResourcePaths.push(t.portalItem.resourceFromPath(r).path)}return pB(e,t&&t.portal)}function R1(e,t,i=GC.YES){if(!e)return e;!fc(e)&&t&&t.blockedRelativeUrls&&t.blockedRelativeUrls.push(e);let r=Au(e);if(t){const s=t.verifyItemRelativeUrls&&t.verifyItemRelativeUrls.rootPath||t.url&&t.url.path;if(s){const n=pB(s,t.portal);r=aj(pB(r,t.portal),n,n),r!==e&&t.verifyItemRelativeUrls&&t.verifyItemRelativeUrls.writtenUrls.push(r)}}return r=YAe(r,t&&t.portal),fc(r)&&(r=Pu(r)),t!=null&&t.resources&&t!=null&&t.portalItem&&!fc(r)&&!Up(r)&&i===GC.YES&&t.resources.toKeep.push({resource:t.portalItem.resourceFromPath(r)}),r}function dj(e,t,i){return US(e,i)}function v0(e,t,i,r){const s=R1(e,r);s!==void 0&&(t[i]=s)}const qAe=/\/items\/([^\/]+)\/resources\//,WAe=/^\.\/resources\//;function XAe(e){const t=_(e)?e.match(qAe):null;return _(t)?t[1]:null}function YAe(e,t){return t&&!t.isPortal&&t.urlKey&&t.customBaseUrl?hB(e,`${t.urlKey}.${t.customBaseUrl}`,t.portalHostname):e}function pB(e,t){if(!t||t.isPortal||!t.urlKey||!t.customBaseUrl)return e;const i=`${t.urlKey}.${t.customBaseUrl}`,r=Gle();return ED(r,`${r.scheme}://${i}`)?hB(e,t.portalHostname,i):hB(e,i,t.portalHostname)}var GC;(function(e){e[e.YES=0]="YES",e[e.NO=1]="NO"})(GC||(GC={}));const _mt=Object.freeze({__proto__:null,fromJSON:US,toJSON:R1,read:dj,write:v0,itemIdFromResourceUrl:XAe,get MarkKeep(){return GC}});var fB;const ZAe=_o()({circle:"circle",square:"square",cross:"cross",x:"x",kite:"kite",triangle:"triangle"});let Uv=fB=class extends fe{constructor(e){super(e)}readHref(e,t,i){return e?US(e,i):t.dataURI}writeHref(e,t,i,r){e&&(Up(e)?t.dataURI=e:(t.href=R1(e,r),fc(t.href)&&(t.href=Pu(t.href))))}clone(){return new fB({href:this.href,primitive:this.primitive})}};u([d({type:String,json:{write:!0,read:{source:["href","dataURI"]}}})],Uv.prototype,"href",void 0),u([De("href")],Uv.prototype,"readHref",null),u([Fe("href",{href:{type:String},dataURI:{type:String}})],Uv.prototype,"writeHref",null),u([ut(ZAe)],Uv.prototype,"primitive",void 0),Uv=fB=u([P("esri.symbols.support.IconSymbol3DLayerResource")],Uv);const QAe="circle";var mB;let Sx=mB=class extends we{constructor(){super(...arguments),this.x=0,this.y=0}clone(){return new mB({x:this.x,y:this.y})}};u([d({type:Number})],Sx.prototype,"x",void 0),u([d({type:Number})],Sx.prototype,"y",void 0),Sx=mB=u([P("esri.symbols.support.Symbol3DAnchorPosition2D")],Sx);var gB;let UE=gB=class extends fe{constructor(e){super(e),this.color=new Je([0,0,0,1]),this.size=Qh(1)}clone(){const e={color:_(this.color)?this.color.clone():null,size:this.size};return new gB(e)}};u([d(Bm)],UE.prototype,"color",void 0),u([d(xp)],UE.prototype,"size",void 0),UE=gB=u([P("esri.symbols.support.Symbol3DIconOutline")],UE);var Ew;const JAe=he.getLogger("esri.symbols.IconSymbol3DLayer");let Id=Ew=class extends Fp{constructor(e){super(e),this.material=null,this.resource=null,this.type="icon",this.size=12,this.anchor="center",this.anchorPosition=void 0,this.outline=void 0}clone(){return new Ew({anchor:this.anchor,anchorPosition:this.anchorPosition&&this.anchorPosition.clone(),enabled:this.enabled,material:_(this.material)?this.material.clone():null,outline:_(this.outline)?this.outline.clone():null,resource:this.resource&&this.resource.clone(),size:this.size})}static fromSimpleMarkerSymbol(e){const t=e.color||jA,i=UY(e),r=e.outline&&e.outline.width>0?{size:e.outline.width,color:(e.outline.color||jA).clone()}:null;return new Ew({size:e.size,resource:{primitive:eCe(e.style)},material:{color:t},outline:r,anchor:i?"relative":void 0,anchorPosition:i})}static fromPictureMarkerSymbol(e){const t=!e.color||VEe(e.color)?jA:e.color,i=UY(e);return new Ew({size:e.width<=e.height?e.height:e.width,resource:{href:e.url},material:{color:t.clone()},anchor:i?"relative":void 0,anchorPosition:i})}static fromCIMSymbol(e){return new Ew({resource:{href:Yle({mediaType:"application/json",data:JSON.stringify(e.data)})}})}};function UY(e){const t="width"in e?e.width:e.size,i="height"in e?e.height:e.size,r=kY(e.xoffset),s=kY(e.yoffset);return(r||s)&&t&&i?{x:-r/t,y:s/i}:null}function kY(e){return isFinite(e)?e:0}u([d({type:pc,json:{write:!0}})],Id.prototype,"material",void 0),u([d({type:Uv,json:{write:!0}})],Id.prototype,"resource",void 0),u([ut({Icon:"icon"},{readOnly:!0})],Id.prototype,"type",void 0),u([d(xp)],Id.prototype,"size",void 0),u([ut({center:"center",left:"left",right:"right",top:"top",bottom:"bottom",topLeft:"top-left",topRight:"top-right",bottomLeft:"bottom-left",bottomRight:"bottom-right",relative:"relative"}),d({json:{default:"center"}})],Id.prototype,"anchor",void 0),u([d({type:Sx,json:{type:[Number],read:{reader:e=>new Sx({x:e[0],y:e[1]})},write:{writer:(e,t)=>{t.anchorPosition=[e.x,e.y]},overridePolicy(){return{enabled:this.anchor==="relative"}}}}})],Id.prototype,"anchorPosition",void 0),u([d({type:UE,json:{write:!0}})],Id.prototype,"outline",void 0),Id=Ew=u([P("esri.symbols.IconSymbol3DLayer")],Id);const KAe={circle:"circle",cross:"cross",diamond:"kite",square:"square",x:"x",triangle:"triangle",path:null};function eCe(e){return KAe[e]||(JAe.warn(`${e} cannot be mapped to Icon symbol. Fallback to "circle"`),"circle")}const om=Id;function Om(e,t,i=it){return t||(t=new i),t===e||(t.removeAll(),tCe(e)?t.addMany(e):e&&t.add(e)),t}function pj(e){return e}function tCe(e){return e&&(Array.isArray(e)||"items"in e&&Array.isArray(e.items))}const Jle="20220404",Kle="ecb69ff5e08a61c162de0ddc0b1f397ed5d4071b",fj="4.23",iCe={async request(e,t){var i;const{default:r}=await Promise.resolve().then(function(){return gCe}),s=e.options,n=s.responseType;s.signal=t==null?void 0:t.signal,s.responseType=n==="native"||n==="native-request-init"?"native-request-init":["blob","json","text"].includes(n)&&(i=Wle(e.url))!=null&&i.after?n:"array-buffer";const o=await r(e.url,s),a={data:o.data,ssl:o.ssl};switch(o.requestOptions.responseType){case"native-request-init":return delete a.data.signal,a;case"blob":a.data=await a.data.arrayBuffer();break;case"json":a.data=new TextEncoder().encode(JSON.stringify(a.data)).buffer;break;case"text":a.data=new TextEncoder().encode(a.data).buffer}return{result:a,transferList:[a.data]}}};let Ss;function bmt(e){Ss=e}function rCe(e){const t=Ss&&Ss.findCredential(e);return t&&t.token?hj(e,"token",t.token):e}ue("host-webworker")||(ue("edge")||ue("trident"))&&console.warn("Deprecated browser - see http://esriurl.com/oldbrowser");const sCe=["elevation3d.arcgis.com","js.arcgis.com","jsdev.arcgis.com","jsqa.arcgis.com","static.arcgis.com"];function ece(e){const t=FS(e,!0);return t&&t.endsWith(".arcgis.com")&&!sCe.includes(t)&&!e.endsWith("/sharing/rest/generateToken")}function tce(e,t,i=!1,r){return new Promise((s,n)=>{if(Us(r))return void n(zY());let o=()=>{c(),n(new Error(`Unable to load ${t}`))},a=()=>{const h=e;c(),s(h)},l=()=>{if(!e)return;const h=e;c(),h.src="",n(zY())};const c=()=>{ue("esri-image-decode")||(e.removeEventListener("error",o),e.removeEventListener("load",a)),o=null,a=null,e=null,_(r)&&r.removeEventListener("abort",l),l=null,i&&URL.revokeObjectURL(t)};_(r)&&r.addEventListener("abort",l),ue("esri-image-decode")?e.decode().then(a,o):(e.addEventListener("error",o),e.addEventListener("load",a))})}function zY(){try{return new DOMException("Aborted","AbortError")}catch{const e=new Error;return e.name="AbortError",e}}async function Ti(e,t){var i;const r=Up(e),s=UT(e);s||r||(e=Pu(e));const n={url:e,requestOptions:I({},t)};let o=Wle(e);if(o){const h=await dCe(o,n);if(h!=null)return{data:h,getHeader:mj,requestOptions:n.requestOptions,url:n.url};o.after||o.error||(o=null)}if(e=n.url,(t=n.requestOptions).responseType==="image"){if(ue("host-webworker")||ue("host-node"))throw kh("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),n)}else if(r)throw kh("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+t.responseType),n);if(t.method==="head"){if(t.body)throw kh("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),n);if(r||s)throw kh("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),n)}if(await cCe(),CD)return CD.execute(e,t);const a=new AbortController;go(t,()=>a.abort());const l={controller:a,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:o,params:n,redoRequest:!1,useIdentity:qf.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},c=await fCe(l);return(i=o)==null||i.after==null||i.after(c),c}let CD;const qf=Bi.request,ice="FormData"in globalThis,nCe=[499,498,403,401],oCe=["COM_0056","COM_0057","SB_0008"],aCe=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],mj=()=>null,yB=Symbol();function lCe(e){const t=FS(e);t&&!Ti._corsServers.includes(t)&&Ti._corsServers.push(t)}function BY(e){const t=FS(e);return!t||t.endsWith(".arcgis.com")||Ti._corsServers.includes(t)||oj(t)}function kh(e,t,i,r){let s="Error";const n={url:i.url,requestOptions:i.requestOptions,getHeader:mj,ssl:!1};if(t instanceof q)return t.details?(t.details=se(t.details),t.details.url=i.url,t.details.requestOptions=i.requestOptions):t.details=n,t;if(t){const o=r&&(c=>r.headers.get(c)),a=r&&r.status,l=t.message;l&&(s=l),o&&(n.getHeader=o),n.httpStatus=(t.httpCode!=null?t.httpCode:t.code)||a||0,n.subCode=t.subcode,n.messageCode=t.messageCode,typeof t.details=="string"?n.messages=[t.details]:n.messages=t.details,n.raw=yB in t?t[yB]:t}return pr(t)?pi():new q(e,s,n)}async function cCe(){ue("host-webworker")?CD||(CD=await import("./request.7c9d6261.js")):Ti._abortableFetch||(Ti._abortableFetch=globalThis.fetch.bind(globalThis))}async function vB(){Ss||await import("./IdentityManager.69401577.js")}async function uCe(e){const t=e.params.url,i=e.params.requestOptions,r=e.controller.signal,s=i.body;let n=null,o=null,a=null;if(ice&&"HTMLFormElement"in globalThis&&(s instanceof FormData?n=s:s instanceof HTMLFormElement&&(o=s,n=new FormData(o))),typeof s=="string"&&(a=s),e.fetchOptions={cache:i.cacheBust&&!Ti._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:i.headers||{},method:i.method==="head"?"HEAD":"GET",mode:"cors",redirect:"follow",signal:r},(n||a)&&(e.fetchOptions.body=n||a),i.authMode==="anonymous"&&(e.useIdentity=!1),e.hasToken=!!(/token=/i.test(t)||i.query&&i.query.token||n&&n.get&&n.get("token")||o&&o.elements.token),!e.hasToken&&Bi.apiKey&&ece(t)&&(i.query||(i.query={}),i.query.token=Bi.apiKey,e.hasToken=!0),e.useIdentity&&!e.hasToken&&!e.credentialToken&&!rce(t)&&!Us(r)){let l;i.authMode==="immediate"?(await vB(),l=await Ss.getCredential(t,{signal:r}),e.credential=l):i.authMode==="no-prompt"?(await vB(),l=await Ss.getCredential(t,{prompt:!1,signal:r}).catch(()=>{}),e.credential=l):Ss&&(l=Ss.findCredential(t)),l&&(e.credentialToken=l.token,e.useSSL=!!l.ssl)}}function rce(e){return aCe.some(t=>t.test(e))}async function hCe(e){let t=e.params.url;const i=e.params.requestOptions,r=e.fetchOptions,s=UT(t)||Up(t),n=i.responseType||"json",o=s?0:i.timeout!=null?i.timeout:qf.timeout;let a=!1;if(!s){e.useSSL&&(t=cj(t)),i.cacheBust&&r.cache==="default"&&(t=hj(t,"request.preventCache",Date.now()));let f=I({},i.query);e.credentialToken&&(f.token=e.credentialToken);let g=VC(f);ue("esri-url-encodes-apostrophe")&&(g=g.replace(/'/g,"%27"));const y=t.length+1+g.length;let v;a=i.method==="delete"||i.method==="post"||i.method==="put"||!!i.body||y>qf.maxUrlLength;const b=i.useProxy||!!qN(t);if(b){const w=AAe(t);v=w.path,!a&&v.length+1+y>qf.maxUrlLength&&(a=!0),w.query&&(f=I(I({},w.query),f))}if(r.method==="HEAD"&&(a||b)){if(a)throw y>qf.maxUrlLength?kh("request:invalid-parameters",new Error("URL exceeds maximum length"),e.params):kh("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),e.params);if(b)throw kh("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),e.params)}if(a?(r.method=i.method==="delete"?"DELETE":i.method==="put"?"PUT":"POST",i.body?t=FY(t,f):(r.body=VC(f),r.headers["Content-Type"]="application/x-www-form-urlencoded")):t=FY(t,f),b&&(e.useProxy=!0,t=`${v}?${t}`),f.token&&ice&&r.body instanceof FormData){const w=r.body;w.set?w.set("token",f.token):w.append("token",f.token)}if(i.hasOwnProperty("withCredentials"))e.withCredentials=i.withCredentials;else if(!ED(t,Gle())){if(oj(t))e.withCredentials=!0;else if(Ss){const w=Ss.findServerInfo(t);w&&w.webTierAuth&&(e.withCredentials=!0)}}e.withCredentials&&(r.credentials="include")}let l,c,h=0,p=!1;o>0&&(h=setTimeout(()=>{p=!0,e.controller.abort()},o));try{if(i.responseType==="native-request-init")c=r,c.url=t;else if(i.responseType!=="image"||r.cache!=="default"||r.method!=="GET"||a||pCe(i.headers)||!s&&!e.useProxy&&qf.proxyUrl&&!BY(t)){if(l=await Ti._abortableFetch(t,r),e.useProxy||lCe(t),i.responseType==="native")c=l;else if(r.method!=="HEAD")if(l.ok){switch(n){case"array-buffer":c=await l.arrayBuffer();break;case"blob":case"image":c=await l.blob();break;default:c=await l.text()}if(h&&(clearTimeout(h),h=0),n==="json"||n==="xml"||n==="document")if(c)switch(n){case"json":c=JSON.parse(c);break;case"xml":c=VY(c,"application/xml");break;case"document":c=VY(c,"text/html")}else c=null;if(c){if(n==="array-buffer"||n==="blob"){const f=l.headers.get("Content-Type");if(/application\/json|text\/plain/i.test(f)&&c[n==="blob"?"size":"byteLength"]<=750)try{const g=await new Response(c).json();g.error&&(c=g)}catch{}}n==="image"&&c instanceof Blob&&(c=await GY(URL.createObjectURL(c),e,!0))}}else c=await l.text()}else c=await GY(t,e)}catch(f){if(f.name==="AbortError")throw p?new Error("Timeout exceeded"):pi("Request canceled");if(!(!l&&f instanceof TypeError&&qf.proxyUrl)||i.body||i.method==="delete"||i.method==="head"||i.method==="post"||i.method==="put"||e.useProxy||BY(t))throw f;e.redoRequest=!0,RAe({proxyUrl:qf.proxyUrl,urlPrefix:FS(t)})}finally{h&&clearTimeout(h)}return[l,c]}async function dCe(e,t){if(e.responseData!=null)return e.responseData;if(e.headers&&(t.requestOptions.headers=I(I({},t.requestOptions.headers),e.headers)),e.query&&(t.requestOptions.query=I(I({},t.requestOptions.query),e.query)),e.before){let i,r;try{r=await e.before(t)}catch(s){i=kh("request:interceptor",s,t)}if((r instanceof Error||r instanceof q)&&(i=kh("request:interceptor",r,t)),i)throw e.error&&e.error(i),i;return r}}function pCe(e){if(e){for(const t of Object.getOwnPropertyNames(e))if(e[t])return!0}return!1}function VY(e,t){let i;try{i=new DOMParser().parseFromString(e,t)}catch{}if(!i||i.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return i}async function fCe(e){var t,i;let r,s;await uCe(e);try{do[r,s]=await hCe(e);while(!await mCe(e,r,s))}catch(a){const l=kh("request:server",a,e.params,r);throw l.details.ssl=e.useSSL,e.interceptor&&e.interceptor.error&&e.interceptor.error(l),l}const n=e.params.url;if(/\/sharing\/rest\/(accounts|portals)\/self/i.test(n)&&!e.hasToken&&!e.credentialToken&&(t=s)!=null&&(i=t.user)!=null&&i.username&&!oj(n)){const a=FS(n,!0);a&&qf.trustedServers.push(a)}const o=e.credential;if(o&&Ss){const a=Ss.findServerInfo(o.server);let l=a&&a.owningSystemUrl;if(l){l=l.replace(/\/?$/,"/sharing");const c=Ss.findCredential(l,o.userId);c&&Ss._getIdenticalSvcIdx(l,c)===-1&&c.resources.unshift(l)}}return{data:s,getHeader:r?a=>r.headers.get(a):mj,requestOptions:e.params.requestOptions,ssl:e.useSSL,url:e.params.url}}async function mCe(e,t,i){if(e.redoRequest)return e.redoRequest=!1,!1;const r=e.params.requestOptions;if(!t||r.responseType==="native"||r.responseType==="native-request-init")return!0;let s,n,o,a;if(!t.ok)throw s=new Error(`Unable to load ${t.url} status: ${t.status}`),s[yB]=i,s;i!=null&&i.error&&(s=i.error),s&&(n=Number(s.code),o=s.hasOwnProperty("subcode")?Number(s.subcode):null,a=s.messageCode,a=a&&a.toUpperCase());const l=r.authMode;if(n===403&&(o===4||s.message&&s.message.toLowerCase().indexOf("ssl")>-1&&s.message.toLowerCase().indexOf("permission")===-1)){if(!e.useSSL)return e.useSSL=!0,!1}else if(!e.hasToken&&e.useIdentity&&(l!=="no-prompt"||n===498)&&nCe.indexOf(n)!==-1&&!rce(e.params.url)&&(n!==403||oCe.indexOf(a)===-1&&(o==null||o===2&&e.credentialToken))){await vB();try{const c=await Ss.getCredential(e.params.url,{error:kh("request:server",s,e.params),prompt:l!=="no-prompt",signal:e.controller.signal,token:e.credentialToken});return e.credential=c,e.credentialToken=c.token,e.useSSL=e.useSSL||c.ssl,!1}catch(c){if(l==="no-prompt")return e.credential=null,e.credentialToken=null,!1;s=c}}if(s)throw s;return!0}function GY(e,t,i=!1){const r=t.controller.signal,s=new Image;return t.withCredentials?s.crossOrigin="use-credentials":s.crossOrigin="anonymous",s.alt="",s.src=e,tce(s,e,i,r)}Ti._abortableFetch=null,Ti._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];var gCe=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Ti}),gy;(function(e){e[e.PENDING=0]="PENDING",e[e.RESOLVED=1]="RESOLVED",e[e.REJECTED=2]="REJECTED"})(gy||(gy={}));class yCe{constructor(t){this.instance=t,this._resolver=f0(),this._status=gy.PENDING,this._resolvingPromises=[],this._resolver.promise.then(()=>{this._status=gy.RESOLVED,this._cleanUp()},()=>{this._status=gy.REJECTED,this._cleanUp()})}addResolvingPromise(t){this._resolvingPromises.push(t),this._tryResolve()}isResolved(){return this._status===gy.RESOLVED}isRejected(){return this._status===gy.REJECTED}isFulfilled(){return this._status!==gy.PENDING}abort(){this._resolver.reject(pi())}when(t,i){return this._resolver.promise.then(t,i)}_cleanUp(){this._allPromise=this._resolvingPromises=this._allPromise=null}_tryResolve(){if(this.isFulfilled())return;const t=f0(),i=[...this._resolvingPromises,t.promise],r=this._allPromise=Promise.all(i);r.then(()=>{this.isFulfilled()||this._allPromise!==r||this._resolver.resolve(this.instance)},s=>{this.isFulfilled()||this._allPromise!==r||pr(s)||this._resolver.reject(s)}),t.resolve()}}const kS=e=>{let t=class extends e{constructor(...i){super(...i),this._promiseProps=new yCe(this),this.addResolvingPromise(Promise.resolve())}isResolved(){return this._promiseProps.isResolved()}isRejected(){return this._promiseProps.isRejected()}isFulfilled(){return this._promiseProps.isFulfilled()}when(i,r){return new Promise((s,n)=>{this._promiseProps.when(s,n)}).then(i,r)}catch(i){return this.when(null,i)}addResolvingPromise(i){i&&!this._promiseProps.isFulfilled()&&this._promiseProps.addResolvingPromise("_promiseProps"in i?i.when():i)}};return t=u([P("esri.core.Promise")],t),t};let RD=class extends kS(we){};RD=u([P("esri.core.Promise")],RD);const vCe="not-loaded",_Ce="loading",bCe="failed",jY="loaded",sce=e=>{let t=class extends e{constructor(...i){super(...i),this._loadController=null,this.loadError=null,this.loadStatus="not-loaded",this._set("loadWarnings",[]),this.addResolvingPromise(new Promise(r=>{const s=this.load.bind(this);this.load=n=>{const o=new Promise((a,l)=>{const c=tO(n,l);this.destroyed&&l(new q("load:instance-destroyed",`Instance of '${this.declaredClass||this.constructor.name}' is already destroyed`,{instance:this})),this._promiseProps.when(a,l).finally(()=>{c&&c.remove()})});if(this.loadStatus===vCe){this._set("loadStatus",_Ce);const a=this._loadController=new AbortController;s({signal:a.signal}),go(a.signal,()=>{this._promiseProps.abort()})}return r(),o}})),this.when(()=>{this._set("loadStatus",jY),this._loadController=null},r=>{this._set("loadStatus",bCe),this._set("loadError",r),this._loadController=null})}get loaded(){return this.loadStatus===jY}get loadWarnings(){return this._get("loadWarnings")}load(){return null}cancelLoad(){var i;return this.isFulfilled()||(this._set("loadError",new q("load:cancelled","Cancelled")),(i=this._loadController)==null||i.abort()),this}};return u([d({readOnly:!0})],t.prototype,"loaded",null),u([d({readOnly:!0})],t.prototype,"loadError",void 0),u([d({clonable:!1})],t.prototype,"loadStatus",void 0),u([d({type:[vc],readOnly:!0})],t.prototype,"loadWarnings",null),t=u([P("esri.core.Loadable")],t),t};let kE=class extends sce(RD){};kE=u([P("esri.core.Loadable")],kE),function(e){function t(i){return!(!i||!i.load)}e.LoadableMixin=sce,e.isLoadable=t}(kE||(kE={}));const Ep=kE;var _B;const wCe=new si({avgRating:"avg-rating",numRatings:"num-ratings",numComments:"num-comments",numViews:"num-views"});let Xc=_B=class extends we{constructor(e){super(e),this.categories=null,this.disableExtraQuery=!1,this.extent=null,this.filter=null,this.num=10,this.query=null,this.sortField=null,this.start=1}get sortOrder(){return this._get("sortOrder")||"asc"}set sortOrder(e){e!=="asc"&&e!=="desc"||this._set("sortOrder",e)}clone(){return new _B({categories:this.categories?se(this.categories):null,disableExtraQuery:this.disableExtraQuery,extent:this.extent?this.extent.clone():null,filter:this.filter,num:this.num,query:this.query,sortField:this.sortField,sortOrder:this.sortOrder,start:this.start})}toRequestOptions(e,t){let i,r;if(this.categories&&(i=this.categories.map(o=>Array.isArray(o)?JSON.stringify(o):o)),this.extent){const o=sb(this.extent,He.WGS84);_(o)&&(r=`${o.xmin},${o.ymin},${o.xmax},${o.ymax}`)}let s=this.query;!this.disableExtraQuery&&e.extraQuery&&(s="("+s+")"+e.extraQuery);const n={categories:i,bbox:r,q:s,filter:this.filter,num:this.num,sortField:null,sortOrder:null,start:this.start};return this.sortField&&(n.sortField=this.sortField.split(",").map(o=>wCe.toJSON(o.trim())).join(","),n.sortOrder=this.sortOrder),{query:I(I({},t),n)}}};u([d()],Xc.prototype,"categories",void 0),u([d()],Xc.prototype,"disableExtraQuery",void 0),u([d({type:Xt})],Xc.prototype,"extent",void 0),u([d()],Xc.prototype,"filter",void 0),u([d()],Xc.prototype,"num",void 0),u([d()],Xc.prototype,"query",void 0),u([d()],Xc.prototype,"sortField",void 0),u([d()],Xc.prototype,"sortOrder",null),u([d()],Xc.prototype,"start",void 0),Xc=_B=u([P("esri.portal.PortalQueryParams")],Xc);const im=Xc;let kv=class extends we{constructor(e){super(e),this.nextQueryParams=null,this.queryParams=null,this.results=null,this.total=null}};u([d()],kv.prototype,"nextQueryParams",void 0),u([d()],kv.prototype,"queryParams",void 0),u([d()],kv.prototype,"results",void 0),u([d()],kv.prototype,"total",void 0),kv=u([P("esri.portal.PortalQueryResult")],kv);const xCe=kv;let bf=class extends fe{constructor(e){super(e),this.created=null,this.id=null,this.portal=null,this.title=null,this.username=null}get url(){const e=this.get("portal.restUrl");return e?`${e}/content/users/${this.username}/${this.id}`:null}toJSON(){throw new q("internal:not-yet-implemented","PortalFolder.toJSON is not yet implemented")}};u([d({type:Date})],bf.prototype,"created",void 0),u([d()],bf.prototype,"id",void 0),u([d()],bf.prototype,"portal",void 0),u([d()],bf.prototype,"title",void 0),u([d({readOnly:!0})],bf.prototype,"url",null),u([d()],bf.prototype,"username",void 0),bf=u([P("esri.portal.PortalFolder")],bf);const TCe=bf;let an=class extends fe{constructor(e){super(e),this.access=null,this.created=null,this.description=null,this.id=null,this.isInvitationOnly=!1,this.modified=null,this.owner=null,this.portal=null,this.snippet=null,this.sortField=null,this.sortOrder=null,this.tags=null,this.title=null}get thumbnailUrl(){const e=this.url,t=this.thumbnail;return e&&t?this.portal._normalizeUrl(`${e}/info/${t}?f=json`):null}get url(){const e=this.get("portal.restUrl");return e?e+"/community/groups/"+this.id:null}fetchCategorySchema(e){return this.portal._request(this.url+"/categorySchema",e).then(t=>{const i=t.categorySchema||[];return i.some(r=>r.source==="contentCategorySetsGroupQuery.LivingAtlas")?this._fetchCategorySchemaSet("LivingAtlas",e):i})}fetchMembers(e){return this.portal._request(this.url+"/users",e)}getThumbnailUrl(e){let t=this.thumbnailUrl;return t&&e&&(t+=`&w=${e}`),t}toJSON(){throw new q("internal:not-yet-implemented","PortalGroup.toJSON is not yet implemented")}queryItems(e,t){let i=Ir(im,e);return parseFloat(this.portal.currentVersion)>5?(i=i||new im,this.portal._queryPortal(`/content/groups/${this.id}/search`,i,"PortalItem",t)):(i=i?i.clone():new im,i.query="group:"+this.id+(i.query?" "+i.query:""),this.portal.queryItems(i,t))}_fetchCategorySchemaSet(e,t){return this.portal._fetchSelf(this.portal.authMode,!0,t).then(i=>{const r=i.contentCategorySetsGroupQuery;if(r){const s=new im;return s.disableExtraQuery=!0,s.num=1,s.query=r,this.portal.queryGroups(s,t)}throw new q("portal-group:fetchCategorySchema","contentCategorySetsGroupQuery value not found")}).then(i=>{if(i.total){const r=i.results[0],s=new im;return s.num=1,s.query=`typekeywords:"${e}"`,r.queryItems(s,t)}throw new q("portal-group:fetchCategorySchema","contentCategorySetsGroupQuery group not found")}).then(i=>i.total?i.results[0].fetchData("json",t).then(r=>{const s=r&&r.categorySchema;return s&&s.length?s:[]}):[])}};u([d()],an.prototype,"access",void 0),u([d({type:Date})],an.prototype,"created",void 0),u([d()],an.prototype,"description",void 0),u([d()],an.prototype,"id",void 0),u([d()],an.prototype,"isInvitationOnly",void 0),u([d({type:Date})],an.prototype,"modified",void 0),u([d()],an.prototype,"owner",void 0),u([d()],an.prototype,"portal",void 0),u([d()],an.prototype,"snippet",void 0),u([d()],an.prototype,"sortField",void 0),u([d()],an.prototype,"sortOrder",void 0),u([d()],an.prototype,"tags",void 0),u([d()],an.prototype,"thumbnail",void 0),u([d({readOnly:!0})],an.prototype,"thumbnailUrl",null),u([d()],an.prototype,"title",void 0),u([d({readOnly:!0})],an.prototype,"url",null),an=u([P("esri.portal.PortalGroup")],an);const bB=an;var SCe=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:bB}),wB;let Tr=wB=class extends fe{constructor(...e){super(...e),this.access=null,this.created=null,this.culture=null,this.description=null,this.email=null,this.fullName=null,this.modified=null,this.orgId=null,this.portal=null,this.preferredView=null,this.privileges=null,this.region=null,this.role=null,this.roleId=null,this.sourceJSON=null,this.units=null,this.username=null,this.userType=null}get thumbnailUrl(){const e=this.url,t=this.thumbnail;return e&&t?this.portal._normalizeUrl(`${e}/info/${t}?f=json`):null}get userContentUrl(){const e=this.get("portal.restUrl");return e?`${e}/content/users/${this.username}`:null}get url(){const e=this.get("portal.restUrl");return e?`${e}/community/users/${this.username}`:null}addItem(e){const t=e&&e.item,i=e&&e.data,r=e&&e.folder,s={method:"post"};t&&(s.query=t.createPostQuery(),i!=null&&(typeof i=="string"?s.query.text=i:typeof i=="object"&&(s.query.text=JSON.stringify(i))));let n=this.userContentUrl;return r&&(n+="/"+(typeof r=="string"?r:r.id)),this.portal._request(n+"/addItem",s).then(o=>(t.id=o.id,t.portal=this.portal,t.loaded?t.reload():t.load()))}deleteItem(e){let t=this.userContentUrl;return e.ownerFolder&&(t+="/"+e.ownerFolder),this.portal._request(t+`/items/${e.id}/delete`,{method:"post"}).then(()=>{e.id=null,e.portal=null})}deleteItems(e){const t=this.userContentUrl+"/deleteItems",i=e.map(r=>r.id);if(i.length){const r={method:"post",query:{items:i.join(",")}};return this.portal._request(t,r).then(()=>{e.forEach(s=>{s.id=null,s.portal=null})})}return Promise.resolve(void 0)}fetchFolders(){const e={query:{num:1}};return this.portal._request(this.userContentUrl,e).then(t=>{let i;return i=t&&t.folders?t.folders.map(r=>{const s=TCe.fromJSON(r);return s.portal=this.portal,s}):[],i})}fetchGroups(){return this.portal._request(this.url).then(e=>{let t;return t=e&&e.groups?e.groups.map(i=>{const r=bB.fromJSON(i);return r.portal=this.portal,r}):[],t})}fetchItems(e){e||(e={});let t,i=this.userContentUrl;return e.folder&&(i+="/"+e.folder.id),Promise.resolve().then(function(){return Wfe}).then(({default:r})=>{t=r;const s={folders:!1,num:e.num||10,start:e.start||1,sortField:e.sortField||"created",sortOrder:e.sortOrder||"asc"};return this.portal._request(i,{query:s})}).then(r=>{let s;return r&&r.items?(s=r.items.map(n=>{const o=t.fromJSON(n);return o.portal=this.portal,o}),Promise.all(s.map(n=>n.load())).catch(n=>n).then(()=>({items:s,nextStart:r.nextStart,total:r.total}))):{items:[],nextStart:-1,total:0}})}fetchTags(){return this.portal._request(this.url+"/tags").then(e=>e.tags)}getThumbnailUrl(e){let t=this.thumbnailUrl;return t&&e&&(t+=`&w=${e}`),t}queryFavorites(e){return this.favGroupId?(this._favGroup||(this._favGroup=new bB({id:this.favGroupId,portal:this.portal})),this._favGroup.queryItems(e)):Promise.reject(new q("internal:unknown","Unknown internal error",{internalError:"Unknown favGroupId"}))}toJSON(){throw new q("internal:not-yet-implemented","PortalGroup.toJSON is not yet implemented")}static fromJSON(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");const t=new wB;return t.sourceJSON=e,t.read(e),t}};u([d()],Tr.prototype,"access",void 0),u([d({type:Date})],Tr.prototype,"created",void 0),u([d()],Tr.prototype,"culture",void 0),u([d()],Tr.prototype,"description",void 0),u([d()],Tr.prototype,"email",void 0),u([d()],Tr.prototype,"favGroupId",void 0),u([d()],Tr.prototype,"fullName",void 0),u([d({type:Date})],Tr.prototype,"modified",void 0),u([d()],Tr.prototype,"orgId",void 0),u([d()],Tr.prototype,"portal",void 0),u([d()],Tr.prototype,"preferredView",void 0),u([d()],Tr.prototype,"privileges",void 0),u([d()],Tr.prototype,"region",void 0),u([d()],Tr.prototype,"role",void 0),u([d()],Tr.prototype,"roleId",void 0),u([d()],Tr.prototype,"sourceJSON",void 0),u([d()],Tr.prototype,"thumbnail",void 0),u([d({readOnly:!0})],Tr.prototype,"thumbnailUrl",null),u([d()],Tr.prototype,"units",void 0),u([d({readOnly:!0})],Tr.prototype,"userContentUrl",null),u([d({readOnly:!0})],Tr.prototype,"url",null),u([d()],Tr.prototype,"username",void 0),u([d()],Tr.prototype,"userType",void 0),Tr=wB=u([P("esri.portal.PortalUser")],Tr);const gj=Tr;var ECe=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:gj}),Fl;let O5;const HY={PortalGroup:()=>Promise.resolve().then(function(){return SCe}),PortalItem:()=>Promise.resolve().then(function(){return Wfe}),PortalUser:()=>Promise.resolve().then(function(){return ECe})};let Ue=Fl=class extends oO(Ep){constructor(e){super(e),this.access=null,this.allSSL=!1,this.authMode="auto",this.authorizedCrossOriginDomains=null,this.basemapGalleryGroupQuery=null,this.bingKey=null,this.canListApps=!1,this.canListData=!1,this.canListPreProvisionedItems=!1,this.canProvisionDirectPurchase=!1,this.canSearchPublic=!0,this.canShareBingPublic=!1,this.canSharePublic=!1,this.canSignInArcGIS=!1,this.canSignInIDP=!1,this.colorSetsGroupQuery=null,this.commentsEnabled=!1,this.created=null,this.culture=null,this.customBaseUrl=null,this.defaultBasemap=null,this.defaultDevBasemap=null,this.defaultExtent=null,this.defaultVectorBasemap=null,this.description=null,this.devBasemapGalleryGroupQuery=null,this.eueiEnabled=null,this.featuredGroups=null,this.featuredItemsGroupQuery=null,this.galleryTemplatesGroupQuery=null,this.livingAtlasGroupQuery=null,this.hasCategorySchema=!1,this.helperServices=null,this.homePageFeaturedContent=null,this.homePageFeaturedContentCount=null,this.httpPort=null,this.httpsPort=null,this.id=null,this.ipCntryCode=null,this.isPortal=!1,this.isReadOnly=!1,this.layerTemplatesGroupQuery=null,this.maxTokenExpirationMinutes=null,this.modified=null,this.name=null,this.portalHostname=null,this.portalMode=null,this.portalProperties=null,this.region=null,this.rotatorPanels=null,this.showHomePageDescription=!1,this.sourceJSON=null,this.supportsHostedServices=!1,this.symbolSetsGroupQuery=null,this.templatesGroupQuery=null,this.units=null,this.url=Bi.portalUrl,this.urlKey=null,this.user=null,this.useStandardizedQuery=!1,this.useVectorBasemaps=!1,this.vectorBasemapGalleryGroupQuery=null}normalizeCtorArgs(e){return typeof e=="string"?{url:e}:e}destroy(){this._esriId_credentialCreateHandle&&(this._esriId_credentialCreateHandle.remove(),this._esriId_credentialCreateHandle=null)}readAuthorizedCrossOriginDomains(e){if(e)for(const t of e)Bi.request.trustedServers.indexOf(t)===-1&&Bi.request.trustedServers.push(t);return e}readDefaultBasemap(e){return this._readBasemap(e)}readDefaultDevBasemap(e){return this._readBasemap(e)}readDefaultVectorBasemap(e){return this._readBasemap(e)}get extraQuery(){const e=!(this.user&&this.user.orgId)||this.canSearchPublic;return this.id&&!e?` AND orgid:${this.id}`:null}get isOrganization(){return!!this.access}get restUrl(){let e=this.url;if(e){const t=e.indexOf("/sharing");e=t>0?e.substring(0,t):this.url.replace(/\/+$/,""),e+="/sharing/rest"}return e}get stylesGroupQuery(){return ZTe(he.getLogger(this.declaredClass),"stylesGroupQuery",{replacement:"stylesGroupQuery3d",version:"4.21"}),this.stylesGroupQuery3d}get thumbnailUrl(){const e=this.restUrl,t=this.thumbnail;return e&&t?this._normalizeSSL(e+"/portals/self/resources/"+t):null}readUrlKey(e){return e&&e.toLowerCase()}readUser(e){let t=null;return e&&(t=gj.fromJSON(e),t.portal=this),t}load(e){const t=Promise.resolve().then(function(){return dBe}).then(({default:i})=>{Qt(e),O5=i}).then(()=>this.sourceJSON?this.sourceJSON:this._fetchSelf(this.authMode,!1,e)).then(i=>{if(Ss){const r=Ss;this.credential=r.findCredential(this.restUrl),this.credential||this.authMode!==Fl.AUTH_MODE_AUTO||(this._esriId_credentialCreateHandle=r.on("credential-create",()=>{r.findCredential(this.restUrl)&&this._signIn()}))}this.sourceJSON=i,this.read(i)});return this.addResolvingPromise(t),Promise.resolve(this)}async createClosestFacilityTask(){bw(he.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/closestFacility",version:"4.21"}),await this.load();const e=this._getHelperServiceUrl("closestFacility");return new(await import("./ClosestFacilityTask.b46b269a.js")).default(e)}async createElevationLayers(){await this.load();const e=this._getHelperService("defaultElevationLayers"),t=(await import("./ElevationLayer.57c5f4f1.js")).default;return e?e.map(i=>new t({id:i.id,url:i.url})):[]}async createGeometryService(){bw(he.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/geometryService",version:"4.21"}),await this.load();const e=this._getHelperServiceUrl("geometry");return new(await import("./GeometryService.77a50a38.js")).default({url:e})}async createPrintTask(){bw(he.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/print",version:"4.21"}),await this.load();const e=this._getHelperServiceUrl("printTask");return new(await import("./PrintTask.7c4a3274.js")).default(e)}async createRouteTask(){bw(he.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/route",version:"4.21"}),await this.load();const e=this._getHelperServiceUrl("route");return new(await import("./RouteTask.61de5689.js")).default(e)}async createServiceAreaTask(){bw(he.getLogger(this.declaredClass),null,{replacement:"Use helperServices url with esri/rest/serviceArea",version:"4.21"}),await this.load();const e=this._getHelperServiceUrl("serviceArea");return new(await import("./ServiceAreaTask.e9cf3a2a.js")).default(e)}fetchBasemaps(e,t){const i=new im;return i.query=e||(Bi.apiKey&&ece(this.url)?this.devBasemapGalleryGroupQuery:this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),i.disableExtraQuery=!0,this.queryGroups(i,t).then(r=>{if(i.num=100,i.query='type:"Web Map" -type:"Web Application"',r.total){const s=r.results[0];return i.sortField=s.sortField||"name",i.sortOrder=s.sortOrder||"desc",s.queryItems(i,t)}return null}).then(r=>{let s;return s=r&&r.total?r.results.filter(n=>n.type==="Web Map").map(n=>new O5({portalItem:n})):[],s})}fetchCategorySchema(e){return this.hasCategorySchema?this._request(this.restUrl+"/portals/self/categorySchema",e).then(t=>t.categorySchema):Us(e)?Promise.reject(pi()):Promise.resolve([])}fetchFeaturedGroups(e){const t=this.featuredGroups,i=new im;if(i.num=100,i.sortField="title",t&&t.length){const r=[];for(const s of t)r.push(`(title:"${s.title}" AND owner:${s.owner})`);return i.query=r.join(" OR "),this.queryGroups(i,e).then(s=>s.results)}return Us(e)?Promise.reject(pi()):Promise.resolve([])}fetchRegions(e){var t;const i=((t=this.user)==null?void 0:t.culture)||this.culture||dc();return this._request(this.restUrl+"/portals/regions",me(I({},e),{query:{culture:i}}))}fetchSettings(e){var t;const i=((t=this.user)==null?void 0:t.culture)||this.culture||dc();return this._request(this.restUrl+"/portals/self/settings",me(I({},e),{query:{culture:i}}))}static getDefault(){return Fl._default&&!Fl._default.destroyed||(Fl._default=new Fl),Fl._default}queryGroups(e,t){return this._queryPortal("/community/groups",e,"PortalGroup",t)}queryItems(e,t){return this._queryPortal("/search",e,"PortalItem",t)}queryUsers(e,t){return e.sortField||(e.sortField="username"),this._queryPortal("/community/users",e,"PortalUser",t)}toJSON(){throw new q("internal:not-yet-implemented","Portal.toJSON is not yet implemented")}static fromJSON(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");return new Fl({sourceJSON:e})}_getHelperService(e){const t=this.helperServices&&this.helperServices[e];if(!t)throw new q("portal:service-not-found",`The \`helperServices\` do not include an entry named "${e}"`);return t}_getHelperServiceUrl(e){const t=this._getHelperService(e);if(!t.url)throw new q("portal:service-url-not-found",`The \`helperServices\` entry "${e}" does not include a \`url\` value`);return t.url}_fetchSelf(e=this.authMode,t=!1,i){const r=this.restUrl+"/portals/self",s=I({authMode:e,query:{culture:dc().toLowerCase()}},i);return s.authMode==="auto"&&(s.authMode="no-prompt"),t&&(s.query.default=!0),this._request(r,s)}_queryPortal(e,t,i,r){const s=Ir(im,t),n=o=>this._request(this.restUrl+e,I(I({},s.toRequestOptions(this)),r)).then(a=>{const l=s.clone();return l.start=a.nextStart,new xCe({nextQueryParams:l,queryParams:s,total:a.total,results:Fl._resultsToTypedArray(o,{portal:this},a,r)})}).then(a=>Promise.all(a.results.map(l=>typeof l.when=="function"?l.when():a)).then(()=>a,l=>(zm(l),a)));return i&&HY[i]?HY[i]().then(({default:o})=>(Qt(r),n(o))):n()}_signIn(){if(this.authMode===Fl.AUTH_MODE_ANONYMOUS)return Promise.reject(new q("portal:invalid-auth-mode",`Current "authMode"' is "${this.authMode}"`));if(this.loadStatus==="failed")return Promise.reject(this.loadError);const e=t=>Promise.resolve().then(()=>this.loadStatus==="not-loaded"?(t||(this.authMode="immediate"),this.load().then(()=>null)):this.loadStatus==="loading"?this.load().then(()=>this.credential?null:(this.credential=t,this._fetchSelf("immediate"))):this.user&&this.credential===t?null:(this.credential=t,this._fetchSelf("immediate"))).then(i=>{i&&(this.sourceJSON=i,this.read(i))});return Ss?Ss.getCredential(this.restUrl).then(t=>e(t)):e(this.credential)}_normalizeSSL(e){return e.replace(/^http:/i,"https:").replace(":7080",":7443")}_normalizeUrl(e){const t=this.credential&&this.credential.token;return this._normalizeSSL(t?e+(e.indexOf("?")>-1?"&":"?")+"token="+t:e)}_requestToTypedArray(e,t,i){return this._request(e,t).then(r=>{const s=Fl._resultsToTypedArray(i,{portal:this},r);return Promise.all(s.map(n=>typeof n.when=="function"?n.when():r)).then(()=>s,()=>s)})}_readBasemap(e){if(e){const t=O5.fromJSON(e);return t.portalItem={portal:this},t}return null}_request(e,t={}){const i=I({f:"json"},t.query),{authMode:r=this.authMode===Fl.AUTH_MODE_ANONYMOUS?"anonymous":"auto",body:s=null,cacheBust:n=!1,method:o="auto",responseType:a="json",signal:l}=t,c={authMode:r,body:s,cacheBust:n,method:o,query:i,responseType:a,timeout:0,signal:l};return Ti(this._normalizeSSL(e),c).then(h=>h.data)}static _resultsToTypedArray(e,t,i,r){let s;if(i){const n=_(r)?r.signal:null;s=i.listings||i.notifications||i.userInvitations||i.tags||i.items||i.groups||i.comments||i.provisions||i.results||i.relatedItems||i,(e||t)&&(s=s.map(o=>{const a=Object.assign(e?e.fromJSON(o):o,t);return typeof a.load=="function"&&a.load(n),a}))}else s=[];return s}};Ue.AUTH_MODE_ANONYMOUS="anonymous",Ue.AUTH_MODE_AUTO="auto",Ue.AUTH_MODE_IMMEDIATE="immediate",u([d()],Ue.prototype,"access",void 0),u([d()],Ue.prototype,"allSSL",void 0),u([d()],Ue.prototype,"authMode",void 0),u([d()],Ue.prototype,"authorizedCrossOriginDomains",void 0),u([De("authorizedCrossOriginDomains")],Ue.prototype,"readAuthorizedCrossOriginDomains",null),u([d()],Ue.prototype,"basemapGalleryGroupQuery",void 0),u([d()],Ue.prototype,"bingKey",void 0),u([d()],Ue.prototype,"canListApps",void 0),u([d()],Ue.prototype,"canListData",void 0),u([d()],Ue.prototype,"canListPreProvisionedItems",void 0),u([d()],Ue.prototype,"canProvisionDirectPurchase",void 0),u([d()],Ue.prototype,"canSearchPublic",void 0),u([d()],Ue.prototype,"canShareBingPublic",void 0),u([d()],Ue.prototype,"canSharePublic",void 0),u([d()],Ue.prototype,"canSignInArcGIS",void 0),u([d()],Ue.prototype,"canSignInIDP",void 0),u([d()],Ue.prototype,"colorSetsGroupQuery",void 0),u([d()],Ue.prototype,"commentsEnabled",void 0),u([d({type:Date})],Ue.prototype,"created",void 0),u([d()],Ue.prototype,"credential",void 0),u([d()],Ue.prototype,"culture",void 0),u([d()],Ue.prototype,"currentVersion",void 0),u([d()],Ue.prototype,"customBaseUrl",void 0),u([d()],Ue.prototype,"defaultBasemap",void 0),u([De("defaultBasemap")],Ue.prototype,"readDefaultBasemap",null),u([d()],Ue.prototype,"defaultDevBasemap",void 0),u([De("defaultDevBasemap")],Ue.prototype,"readDefaultDevBasemap",null),u([d({type:Xt})],Ue.prototype,"defaultExtent",void 0),u([d()],Ue.prototype,"defaultVectorBasemap",void 0),u([De("defaultVectorBasemap")],Ue.prototype,"readDefaultVectorBasemap",null),u([d()],Ue.prototype,"description",void 0),u([d()],Ue.prototype,"devBasemapGalleryGroupQuery",void 0),u([d()],Ue.prototype,"eueiEnabled",void 0),u([d({readOnly:!0})],Ue.prototype,"extraQuery",null),u([d()],Ue.prototype,"featuredGroups",void 0),u([d()],Ue.prototype,"featuredItemsGroupQuery",void 0),u([d()],Ue.prototype,"galleryTemplatesGroupQuery",void 0),u([d()],Ue.prototype,"livingAtlasGroupQuery",void 0),u([d()],Ue.prototype,"hasCategorySchema",void 0),u([d()],Ue.prototype,"helpBase",void 0),u([d()],Ue.prototype,"helperServices",void 0),u([d()],Ue.prototype,"helpMap",void 0),u([d()],Ue.prototype,"homePageFeaturedContent",void 0),u([d()],Ue.prototype,"homePageFeaturedContentCount",void 0),u([d()],Ue.prototype,"httpPort",void 0),u([d()],Ue.prototype,"httpsPort",void 0),u([d()],Ue.prototype,"id",void 0),u([d()],Ue.prototype,"ipCntryCode",void 0),u([d({readOnly:!0})],Ue.prototype,"isOrganization",null),u([d()],Ue.prototype,"isPortal",void 0),u([d()],Ue.prototype,"isReadOnly",void 0),u([d()],Ue.prototype,"layerTemplatesGroupQuery",void 0),u([d()],Ue.prototype,"maxTokenExpirationMinutes",void 0),u([d({type:Date})],Ue.prototype,"modified",void 0),u([d()],Ue.prototype,"name",void 0),u([d()],Ue.prototype,"portalHostname",void 0),u([d()],Ue.prototype,"portalMode",void 0),u([d()],Ue.prototype,"portalProperties",void 0),u([d()],Ue.prototype,"region",void 0),u([d({readOnly:!0})],Ue.prototype,"restUrl",null),u([d()],Ue.prototype,"rotatorPanels",void 0),u([d()],Ue.prototype,"showHomePageDescription",void 0),u([d()],Ue.prototype,"sourceJSON",void 0),u([d()],Ue.prototype,"staticImagesUrl",void 0),u([d({readOnly:!0,json:{read:!1}})],Ue.prototype,"stylesGroupQuery",null),u([d({json:{name:"2DStylesGroupQuery"}})],Ue.prototype,"stylesGroupQuery2d",void 0),u([d({json:{name:"stylesGroupQuery"}})],Ue.prototype,"stylesGroupQuery3d",void 0),u([d()],Ue.prototype,"supportsHostedServices",void 0),u([d()],Ue.prototype,"symbolSetsGroupQuery",void 0),u([d()],Ue.prototype,"templatesGroupQuery",void 0),u([d()],Ue.prototype,"thumbnail",void 0),u([d({readOnly:!0})],Ue.prototype,"thumbnailUrl",null),u([d()],Ue.prototype,"units",void 0),u([d()],Ue.prototype,"url",void 0),u([d()],Ue.prototype,"urlKey",void 0),u([De("urlKey")],Ue.prototype,"readUrlKey",null),u([d()],Ue.prototype,"user",void 0),u([De("user")],Ue.prototype,"readUser",null),u([d()],Ue.prototype,"useStandardizedQuery",void 0),u([d()],Ue.prototype,"useVectorBasemaps",void 0),u([d()],Ue.prototype,"vectorBasemapGalleryGroupQuery",void 0),Ue=Fl=u([P("esri.portal.Portal")],Ue);const Bn=Ue;let zv=class extends Dp(fe){constructor(e){super(e),this.type="style",this.placement="begin-end",this.style="arrow",this.color=null}equals(e){return _(e)&&e.placement===this.placement&&e.style===this.style&&(R(this.color)&&R(e.color)||_(this.color)&&_(e.color)&&this.color.toJSON()===e.color.toJSON())}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],zv.prototype,"type",void 0),u([d({type:LEe,json:{default:"begin-end",write:!0}})],zv.prototype,"placement",void 0),u([d({type:Ele,json:{default:"arrow",write:!0}})],zv.prototype,"style",void 0),u([d({type:Je,json:{type:[ir],default:null,write:!0}})],zv.prototype,"color",void 0),zv=u([P("esri.symbols.LineStyleMarker3D")],zv);const xB=zv;var _I;let $d=_I=class extends Fp{constructor(e){super(e),this.material=null,this.type="line",this.join="miter",this.cap="butt",this.size=Qh(1),this.pattern=null,this.marker=null}clone(){const e={enabled:this.enabled,material:_(this.material)?this.material.clone():null,size:this.size,join:this.join,cap:this.cap,pattern:_(this.pattern)?this.pattern.clone():null,marker:_(this.marker)?this.marker.clone():null};return new _I(e)}static fromSimpleLineSymbol(e){var t,i,r;const s={enabled:!0,size:(t=e.width)!=null?t:Qh(1),cap:e.cap||"butt",join:e.join||"miter",pattern:e.style&&e.style!=="inside-frame"?new J7({style:e.style}):null,material:new pc({color:(e.color||jA).clone()}),marker:e.marker?new xB({placement:e.marker.placement,style:e.marker.style,color:(i=(r=e.marker.color)==null?void 0:r.clone())!=null?i:null}):null};return new _I(s)}};u([d({type:pc,json:{write:!0}})],$d.prototype,"material",void 0),u([ut({Line:"line"},{readOnly:!0})],$d.prototype,"type",void 0),u([d({type:Ule,json:{write:!0,default:"miter"}})],$d.prototype,"join",void 0),u([d({type:rj,json:{write:!0,default:"butt"}})],$d.prototype,"cap",void 0),u([d(xp)],$d.prototype,"size",void 0),u([d(Mle)],$d.prototype,"pattern",void 0),u([d({types:{key:"type",base:xB,typeMap:{style:xB}},json:{write:!0}})],$d.prototype,"marker",void 0),$d=_I=u([P("esri.symbols.LineSymbol3DLayer")],$d);const zS=$d;var TB;const ACe=_o()({sphere:"sphere",cylinder:"cylinder",cube:"cube",cone:"cone",diamond:"diamond",tetrahedron:"tetrahedron",invertedCone:"inverted-cone"});let zE=TB=class extends fe{clone(){return new TB({href:this.href,primitive:this.primitive})}};u([d({type:String,json:{read:dj,write:v0}})],zE.prototype,"href",void 0),u([ut(ACe)],zE.prototype,"primitive",void 0),zE=TB=u([P("esri.symbols.support.ObjectSymbol3DLayerResource")],zE);const nce="sphere";var SB;let R_=SB=class extends we{constructor(){super(...arguments),this.x=0,this.y=0,this.z=0}clone(){return new SB({x:this.x,y:this.y,z:this.z})}};u([d({type:Number})],R_.prototype,"x",void 0),u([d({type:Number})],R_.prototype,"y",void 0),u([d({type:Number})],R_.prototype,"z",void 0),R_=SB=u([P("esri.symbols.support.Symbol3DAnchorPosition3D")],R_);var EB;let Eo=EB=class extends Fp{constructor(e){super(e),this.material=null,this.castShadows=!0,this.resource=null,this.type="object",this.width=void 0,this.height=void 0,this.depth=void 0,this.anchor=void 0,this.anchorPosition=void 0,this.heading=void 0,this.tilt=void 0,this.roll=void 0}clone(){return new EB({heading:this.heading,tilt:this.tilt,roll:this.roll,anchor:this.anchor,anchorPosition:this.anchorPosition&&this.anchorPosition.clone(),depth:this.depth,enabled:this.enabled,height:this.height,material:_(this.material)?this.material.clone():null,castShadows:this.castShadows,resource:this.resource&&this.resource.clone(),width:this.width})}get isPrimitive(){return!this.resource||typeof this.resource.href!="string"}};u([d({type:pc,json:{write:!0}})],Eo.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],Eo.prototype,"castShadows",void 0),u([d({type:zE,json:{write:!0}})],Eo.prototype,"resource",void 0),u([ut({Object:"object"},{readOnly:!0})],Eo.prototype,"type",void 0),u([d({type:Number,json:{write:!0}})],Eo.prototype,"width",void 0),u([d({type:Number,json:{write:!0}})],Eo.prototype,"height",void 0),u([d({type:Number,json:{write:!0}})],Eo.prototype,"depth",void 0),u([ut({center:"center",top:"top",bottom:"bottom",origin:"origin",relative:"relative"}),d({json:{default:"origin"}})],Eo.prototype,"anchor",void 0),u([d({type:R_,json:{type:[Number],read:{reader:e=>new R_({x:e[0],y:e[1],z:e[2]})},write:{writer:(e,t)=>{t.anchorPosition=[e.x,e.y,e.z]},overridePolicy(){return{enabled:this.anchor==="relative"}}}}})],Eo.prototype,"anchorPosition",void 0),u([d({type:Number,json:{write:!0}})],Eo.prototype,"heading",void 0),u([d({type:Number,json:{write:!0}})],Eo.prototype,"tilt",void 0),u([d({type:Number,json:{write:!0}})],Eo.prototype,"roll",void 0),u([d({readOnly:!0})],Eo.prototype,"isPrimitive",null),Eo=EB=u([P("esri.symbols.ObjectSymbol3DLayer")],Eo);const XN=Eo;var AB;let ra=AB=class extends Fp{constructor(e){super(e),this.material=null,this.castShadows=!0,this.type="path",this.profile="circle",this.join="miter",this.cap="butt",this.width=void 0,this.height=void 0,this.anchor="center",this.profileRotation="all"}readWidth(e,t){return e!=null?e:t.height==null&&t.size!=null?t.size:void 0}readHeight(e,t){return e!=null?e:t.width==null&&t.size!=null?t.size:void 0}clone(){return new AB({enabled:this.enabled,material:_(this.material)?this.material.clone():null,castShadows:this.castShadows,profile:this.profile,join:this.join,cap:this.cap,width:this.width,height:this.height,profileRotation:this.profileRotation,anchor:this.anchor})}};u([d({type:pc,json:{write:!0}})],ra.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],ra.prototype,"castShadows",void 0),u([ut({Path:"path"},{readOnly:!0})],ra.prototype,"type",void 0),u([d({type:["circle","quad"],json:{write:!0,default:"circle"}})],ra.prototype,"profile",void 0),u([d({type:Ule,json:{write:!0,default:"miter"}})],ra.prototype,"join",void 0),u([d({type:aAe,json:{write:!0,default:"butt"}})],ra.prototype,"cap",void 0),u([d({type:Number,json:{write:{enabled:!0,target:{width:{type:Number},size:{type:Number}}}}})],ra.prototype,"width",void 0),u([De("width",["width","size","height"])],ra.prototype,"readWidth",null),u([d({type:Number,json:{write:!0}})],ra.prototype,"height",void 0),u([De("height",["height","size","width"])],ra.prototype,"readHeight",null),u([d({type:["center","bottom","top"],json:{write:!0,default:"center"}})],ra.prototype,"anchor",void 0),u([d({type:["heading","all"],json:{write:!0,default:"all"}})],ra.prototype,"profileRotation",void 0),ra=AB=u([P("esri.symbols.PathSymbol3DLayer")],ra);const yj=ra;var CB;let Ex=CB=class extends fe{constructor(){super(...arguments),this.color=new Je([0,0,0,1]),this.size=0}clone(){const e={color:se(this.color),size:this.size};return new CB(e)}};u([d(Bm)],Ex.prototype,"color",void 0),u([d(xp)],Ex.prototype,"size",void 0),Ex=CB=u([P("esri.symbols.support.Symbol3DHalo")],Ex);let qA=class extends Dp(fe){constructor(e){super(e),this.color=null}};u([d(Bm)],qA.prototype,"color",void 0),qA=u([P("esri.symbols.support.Symbol3DTextBackground")],qA);var bI;let ka=bI=class extends Fp{constructor(e){super(e),this._userSize=void 0,this.halo=null,this.horizontalAlignment="center",this.lineHeight=1,this.material=null,this.background=null,this.text=null,this.type="text",this.verticalAlignment="baseline"}get font(){return this._get("font")||null}set font(e){_(e)&&_(this._userSize)&&(e.size=this._userSize),this._set("font",e)}writeFont(e,t,i,r){const s=me(I({},r),{textSymbol3D:!0});t.font=e.write({},s),delete t.font.size}get size(){return _(this._userSize)?this._userSize:_(this.font)&&this.font.size!=null?this.font.size:9}set size(e){this._userSize=e,_(this.font)&&(this.font.size=this._userSize),this.notifyChange("size")}clone(){const e=new bI({enabled:this.enabled,font:this.font&&se(this.font),halo:this.halo&&se(this.halo),horizontalAlignment:this.horizontalAlignment,lineHeight:this.lineHeight,material:_(this.material)?this.material.clone():null,text:this.text,verticalAlignment:this.verticalAlignment,background:se(this.background)});return e._userSize=this._userSize,e}static fromTextSymbol(e){return new bI({font:_(e.font)?e.font.clone():new HN,halo:CCe(e.haloColor,e.haloSize),horizontalAlignment:e.horizontalAlignment,lineHeight:e.lineHeight,material:e.color?new pc({color:e.color.clone()}):null,text:e.text,verticalAlignment:e.verticalAlignment,background:e.backgroundColor?new qA({color:e.backgroundColor.clone()}):null})}};function CCe(e,t){return e&&t>0?new Ex({color:se(e),size:t}):null}u([d({type:HN,json:{write:!0}})],ka.prototype,"font",null),u([Fe("font")],ka.prototype,"writeFont",null),u([d({type:Ex,json:{write:!0}})],ka.prototype,"halo",void 0),u([d(me(I({},mAe),{json:{default:"center",write:!0}}))],ka.prototype,"horizontalAlignment",void 0),u([d(me(I({},kle),{json:{default:1,write:!0}}))],ka.prototype,"lineHeight",void 0),u([d({type:pc,json:{write:!0}})],ka.prototype,"material",void 0),u([d({type:qA,json:{write:!0}})],ka.prototype,"background",void 0),u([d(xp)],ka.prototype,"size",null),u([d({type:String,json:{write:!0}})],ka.prototype,"text",void 0),u([ut({Text:"text"},{readOnly:!0})],ka.prototype,"type",void 0),u([d(me(I({},zle),{json:{default:"baseline",write:!0}}))],ka.prototype,"verticalAlignment",void 0),ka=bI=u([P("esri.symbols.TextSymbol3DLayer")],ka);const cb=ka;var RB;let Vg=RB=class extends Fp{constructor(e){super(e),this.color=OB.clone(),this.type="water",this.waterbodySize="medium",this.waveDirection=null,this.waveStrength="moderate"}clone(){return new RB({color:se(this.color),waterbodySize:this.waterbodySize,waveDirection:this.waveDirection,waveStrength:this.waveStrength})}};u([d({type:Je,nonNullable:!0,json:{type:[ir],write:(e,t,i)=>t[i]=e.toArray(Je.AlphaMode.UNLESS_OPAQUE),default:()=>OB.clone(),defaultEquals:e=>e.toCss(!0)===OB.toCss(!0)}})],Vg.prototype,"color",void 0),u([ut({Water:"water"},{readOnly:!0})],Vg.prototype,"type",void 0),u([d({type:["small","medium","large"],json:{write:!0,default:"medium"}})],Vg.prototype,"waterbodySize",void 0),u([d({type:Number,json:{write:!0,default:null}})],Vg.prototype,"waveDirection",void 0),u([d({type:["calm","rippled","slight","moderate"],json:{write:!0,default:"moderate"}})],Vg.prototype,"waveStrength",void 0),Vg=RB=u([P("esri.symbols.WaterSymbol3DLayer")],Vg);const OB=new Je([0,119,190]),vj=Vg;var MB;let Bv=MB=class extends we{constructor(){super(...arguments),this.portal=null}clone(){return new MB({name:this.name,styleUrl:this.styleUrl,styleName:this.styleName,portal:this.portal})}};u([d({type:String})],Bv.prototype,"name",void 0),u([d({type:String})],Bv.prototype,"styleUrl",void 0),u([d({type:String})],Bv.prototype,"styleName",void 0),u([d({type:Bn})],Bv.prototype,"portal",void 0),Bv=MB=u([P("esri.symbols.support.StyleOrigin")],Bv);const PB=Bv;var IB;let WA=IB=class extends we{clone(){return new IB({url:this.url})}};u([d({type:String})],WA.prototype,"url",void 0),WA=IB=u([P("esri.symbols.support.Thumbnail")],WA);const oce={icon:om,object:XN,line:zS,path:yj,fill:uO,extrude:Q7,text:cb,water:vj},RCe=it.ofType({base:Fp,key:"type",typeMap:oce,errorContext:"symbol-layer"}),OCe=he.getLogger("esri.symbols.Symbol3D");let Dd=class extends Al{constructor(e){super(e),this.styleOrigin=null,this.thumbnail=null,this.type=null;const t=this.__accessor__&&this.__accessor__.metadatas&&this.__accessor__.metadatas.symbolLayers,i=t&&t.type||it;this._set("symbolLayers",new i)}get color(){return null}set color(e){this.initialized&&OCe.error("Symbol3D does not support colors on the symbol level. Colors may be set on individual symbol layer materials instead.")}set symbolLayers(e){Om(e,this._get("symbolLayers"))}readStyleOrigin(e,t,i){if(e.styleUrl&&e.name){const r=US(e.styleUrl,i);return new PB({styleUrl:r,name:e.name})}if(e.styleName&&e.name)return new PB({portal:i&&i.portal||Bn.getDefault(),styleName:e.styleName,name:e.name});i&&i.messages&&i.messages.push(new vc("symbol3d:incomplete-style-origin","Style origin requires either a 'styleUrl' or 'styleName' and a 'name' property",{context:i,definition:e}))}writeStyleOrigin(e,t,i,r){if(e.styleUrl&&e.name){let s=R1(e.styleUrl,r);fc(s)&&(s=Pu(s)),t.styleOrigin={styleUrl:s,name:e.name}}else e.styleName&&e.name&&(e.portal&&r&&r.portal&&!qle(e.portal.restUrl,r.portal.restUrl)?r&&r.messages&&r.messages.push(new vc("symbol:cross-portal","The symbol style origin cannot be persisted because it refers to an item on a different portal than the one being saved to.",{symbol:this})):t.styleOrigin={styleName:e.styleName,name:e.name})}normalizeCtorArgs(e){return e instanceof Fp||e&&oce[e.type]?{symbolLayers:[e]}:Array.isArray(e)?{symbolLayers:e}:e}};u([d({json:{read:!1,write:!1}})],Dd.prototype,"color",null),u([d({type:RCe,nonNullable:!0,json:{write:!0}}),At(pj)],Dd.prototype,"symbolLayers",null),u([d({type:PB})],Dd.prototype,"styleOrigin",void 0),u([De("styleOrigin")],Dd.prototype,"readStyleOrigin",null),u([Fe("styleOrigin",{"styleOrigin.styleUrl":{type:String},"styleOrigin.styleName":{type:String},"styleOrigin.name":{type:String}})],Dd.prototype,"writeStyleOrigin",null),u([d({type:WA,json:{read:!1}})],Dd.prototype,"thumbnail",void 0),u([d({type:["point-3d","line-3d","polygon-3d","mesh-3d","label-3d"],readOnly:!0})],Dd.prototype,"type",void 0),Dd=u([P("esri.symbols.Symbol3D")],Dd);const BS=Dd;let BE=class extends fe{constructor(e){super(e),this.visible=!0}clone(){}};u([d({type:["line"],readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0}}})],BE.prototype,"type",void 0),u([d({readOnly:!0})],BE.prototype,"visible",void 0),BE=u([P("esri.symbols.callouts.Callout3D")],BE);const ace=BE;var $B;let XA=$B=class extends fe{constructor(){super(...arguments),this.color=new Je("white")}clone(){return new $B({color:se(this.color)})}};u([d(Bm)],XA.prototype,"color",void 0),XA=$B=u([P("esri.symbols.callouts.LineCallout3DBorder")],XA);const lce=XA;Object.freeze({__proto__:null,get LineCallout3DBorder(){return XA},default:lce});var DB;let Gg=DB=class extends ace{constructor(e){super(e),this.type="line",this.color=new Je([0,0,0,1]),this.size=Qh(1),this.border=null}get visible(){return this.size>0&&_(this.color)&&this.color.a>0}clone(){return new DB({color:se(this.color),size:this.size,border:se(this.border)})}};u([ut({line:"line"},{readOnly:!0})],Gg.prototype,"type",void 0),u([d(Bm)],Gg.prototype,"color",void 0),u([d(xp)],Gg.prototype,"size",void 0),u([d({type:lce,json:{write:!0}})],Gg.prototype,"border",void 0),u([d({readOnly:!0})],Gg.prototype,"visible",null),Gg=DB=u([P("esri.symbols.callouts.LineCallout3D")],Gg);const MCe=Gg;function _j(e){if(!e)return!1;const t=e.verticalOffset;return!!t&&!(t.screenLength<=0||t.maxWorldLength<=0)}function cce(e){if(!e||!e.supportsCallout||!e.supportsCallout())return!1;const t=e.callout;return!!t&&!!t.visible&&!!_j(e)}function bj(e){return e.type==="point-3d"||e.type==="label-3d"}function uce(e){const{horizontalAlignment:t}=e;return t==="center"||t==="justify"}const hce={types:{key:"type",base:ace,typeMap:{line:MCe}},json:{write:!0}};var LB;let O_=LB=class extends fe{constructor(){super(...arguments),this.screenLength=0,this.minWorldLength=0}clone(){return new LB({screenLength:this.screenLength,minWorldLength:this.minWorldLength,maxWorldLength:this.maxWorldLength})}};u([d(xp)],O_.prototype,"screenLength",void 0),u([d({type:Number,json:{write:!0,default:0}})],O_.prototype,"minWorldLength",void 0),u([d({type:Number,json:{write:!0}})],O_.prototype,"maxWorldLength",void 0),O_=LB=u([P("esri.symbols.support.Symbol3DVerticalOffset")],O_);var wI;const dce=it.ofType({base:null,key:"type",typeMap:{text:cb}});let jg=wI=class extends BS{constructor(e){super(e),this.verticalOffset=null,this.callout=null,this.styleOrigin=null,this.symbolLayers=new dce,this.type="label-3d"}supportsCallout(){return!0}hasVisibleCallout(){return cce(this)}hasVisibleVerticalOffset(){return _j(this)}clone(){return new wI({styleOrigin:se(this.styleOrigin),symbolLayers:se(this.symbolLayers),thumbnail:se(this.thumbnail),callout:se(this.callout),verticalOffset:se(this.verticalOffset)})}static fromTextSymbol(e){return new wI({symbolLayers:[cb.fromTextSymbol(e)]})}};u([d({type:O_,json:{write:!0}})],jg.prototype,"verticalOffset",void 0),u([d(hce)],jg.prototype,"callout",void 0),u([d({json:{read:!1,write:!1}})],jg.prototype,"styleOrigin",void 0),u([d({type:dce})],jg.prototype,"symbolLayers",void 0),u([ut({LabelSymbol3D:"label-3d"},{readOnly:!0})],jg.prototype,"type",void 0),jg=wI=u([P("esri.symbols.LabelSymbol3D")],jg);const YN=jg;var xI;const pce=it.ofType({base:null,key:"type",typeMap:{line:zS,path:yj}}),PCe=it.ofType({base:null,key:"type",typeMap:{line:zS,path:yj}});let VE=xI=class extends BS{constructor(e){super(e),this.symbolLayers=new pce,this.type="line-3d"}clone(){return new xI({styleOrigin:se(this.styleOrigin),symbolLayers:se(this.symbolLayers),thumbnail:se(this.thumbnail)})}static fromSimpleLineSymbol(e){return new xI({symbolLayers:[zS.fromSimpleLineSymbol(e)]})}};u([d({type:pce,json:{type:PCe}})],VE.prototype,"symbolLayers",void 0),u([ut({LineSymbol3D:"line-3d"},{readOnly:!0})],VE.prototype,"type",void 0),VE=xI=u([P("esri.symbols.LineSymbol3D")],VE);const ZN=VE;let Hg=class extends Al{constructor(e){super(e),this.angle=0,this.type=null,this.xoffset=0,this.yoffset=0,this.size=9}hash(){return`${this.type}.${this.angle}.${this.size}.${this.xoffset}.${this.yoffset}`}};u([d({type:Number,json:{read:e=>e&&-1*e,write:(e,t)=>t.angle=e&&-1*e}})],Hg.prototype,"angle",void 0),u([d({type:["simple-marker","picture-marker"],readOnly:!0})],Hg.prototype,"type",void 0),u([d({type:Number,cast:Vi,json:{write:!0}})],Hg.prototype,"xoffset",void 0),u([d({type:Number,cast:Vi,json:{write:!0}})],Hg.prototype,"yoffset",void 0),u([d({type:Number,cast:e=>e==="auto"?e:Vi(e),json:{write:!0}})],Hg.prototype,"size",void 0),Hg=u([P("esri.symbols.MarkerSymbol")],Hg);const fce=Hg;var NB;const mce=it.ofType({base:null,key:"type",typeMap:{fill:uO}});let GE=NB=class extends BS{constructor(e){super(e),this.symbolLayers=new mce,this.type="mesh-3d"}clone(){return new NB({styleOrigin:se(this.styleOrigin),symbolLayers:se(this.symbolLayers),thumbnail:se(this.thumbnail)})}};u([d({type:mce})],GE.prototype,"symbolLayers",void 0),u([ut({MeshSymbol3D:"mesh-3d"},{readOnly:!0})],GE.prototype,"type",void 0),GE=NB=u([P("esri.symbols.MeshSymbol3D")],GE);const wj=GE;function ICe(e,t,i){return t.imageData?Yle({mediaType:t.contentType||"image/png",isBase64:!0,data:t.imageData}):gce(t.url,i)}function gce(e,t){return DCe(t)&&!fc(e)&&t.layer.parsedUrl?bl(t.layer.parsedUrl.path,"images",e):US(e,t)}function $Ce(e,t,i,r){if(Up(e)){const s=WN(e);t.contentType=s.mediaType,t.imageData=s.data,i&&i.imageData===t.imageData&&i.url&&v0(i.url,t,"url",r)}else v0(e,t,"url",r)}const yce={json:{read:{source:["imageData","url"],reader:ICe},write:{writer(e,t,i,r){$Ce(e,t,this.source,r)}}}},vce={readOnly:!0,json:{read:{source:["imageData","url"],reader(e,t,i){const r={};return t.imageData&&(r.imageData=t.imageData),t.contentType&&(r.contentType=t.contentType),t.url&&(r.url=gce(t.url,i)),r}}}};function DCe(e){return e&&(e.origin==="service"||e.origin==="portal-item")&&e.layer&&(e.layer.type==="feature"||e.layer.type==="stream")}var FB;let Yc=FB=class extends Ale{constructor(...e){super(...e),this.type="picture-fill",this.url=null,this.xscale=1,this.yscale=1,this.width=12,this.height=12,this.xoffset=0,this.yoffset=0,this.source=null}normalizeCtorArgs(e,t,i,r){if(e&&typeof e!="string"&&e.imageData==null)return e;const s={};return e&&(s.url=e),t&&(s.outline=t),i!=null&&(s.width=Vi(i)),r!=null&&(s.height=Vi(r)),s}clone(){const e=new FB({color:se(this.color),height:this.height,outline:this.outline&&this.outline.clone(),url:this.url,width:this.width,xoffset:this.xoffset,xscale:this.xscale,yoffset:this.yoffset,yscale:this.yscale});return e._set("source",se(this.source)),e}hash(){var e;return`${super.hash()}.${(e=this.color)==null?void 0:e.hash()}.${this.height}.${this.url}.${this.width}.${this.xoffset}.${this.xscale}.${this.yoffset}.${this.yscale}`}};u([ut({esriPFS:"picture-fill"},{readOnly:!0})],Yc.prototype,"type",void 0),u([d(yce)],Yc.prototype,"url",void 0),u([d({type:Number,json:{write:!0}})],Yc.prototype,"xscale",void 0),u([d({type:Number,json:{write:!0}})],Yc.prototype,"yscale",void 0),u([d({type:Number,cast:Vi,json:{write:!0}})],Yc.prototype,"width",void 0),u([d({type:Number,cast:Vi,json:{write:!0}})],Yc.prototype,"height",void 0),u([d({type:Number,cast:Vi,json:{write:!0}})],Yc.prototype,"xoffset",void 0),u([d({type:Number,cast:Vi,json:{write:!0}})],Yc.prototype,"yoffset",void 0),u([d(vce)],Yc.prototype,"source",void 0),Yc=FB=u([P("esri.symbols.PictureFillSymbol")],Yc);const _ce=Yc;var UB;let oh=UB=class extends fce{constructor(...e){super(...e),this.color=null,this.type="picture-marker",this.url=null,this.source=null,this.height=12,this.width=12,this.size=null}normalizeCtorArgs(e,t,i){if(e&&typeof e!="string"&&e.imageData==null)return e;const r={};return e&&(r.url=e),t!=null&&(r.width=Vi(t)),i!=null&&(r.height=Vi(i)),r}readHeight(e,t){return t.size||e}readWidth(e,t){return t.size||e}clone(){const e=new UB({angle:this.angle,height:this.height,url:this.url,width:this.width,xoffset:this.xoffset,yoffset:this.yoffset});return e._set("source",se(this.source)),e}hash(){return`${super.hash()}.${this.height}.${this.url}.${this.width}`}};u([d({json:{write:!1}})],oh.prototype,"color",void 0),u([ut({esriPMS:"picture-marker"},{readOnly:!0})],oh.prototype,"type",void 0),u([d(yce)],oh.prototype,"url",void 0),u([d(vce)],oh.prototype,"source",void 0),u([d({type:Number,cast:Vi,json:{write:!0}})],oh.prototype,"height",void 0),u([De("height",["height","size"])],oh.prototype,"readHeight",null),u([d({type:Number,cast:Vi,json:{write:!0}})],oh.prototype,"width",void 0),u([d({json:{write:!1}})],oh.prototype,"size",void 0),oh=UB=u([P("esri.symbols.PictureMarkerSymbol")],oh);const QN=oh;var qg;const bce=it.ofType({base:null,key:"type",typeMap:{icon:om,object:XN,text:cb}});let Vv=qg=class extends BS{constructor(e){super(e),this.verticalOffset=null,this.callout=null,this.symbolLayers=new bce,this.type="point-3d"}supportsCallout(){if((this.symbolLayers?this.symbolLayers.length:0)<1)return!1;for(const e of this.symbolLayers.items)switch(e.type){case"icon":case"text":case"object":continue;default:return!1}return!0}hasVisibleCallout(){return cce(this)}hasVisibleVerticalOffset(){return _j(this)}clone(){return new qg({verticalOffset:se(this.verticalOffset),callout:se(this.callout),styleOrigin:se(this.styleOrigin),symbolLayers:se(this.symbolLayers),thumbnail:se(this.thumbnail)})}static fromSimpleMarkerSymbol(e){return new qg({symbolLayers:[om.fromSimpleMarkerSymbol(e)]})}static fromPictureMarkerSymbol(e){return new qg({symbolLayers:[om.fromPictureMarkerSymbol(e)]})}static fromCIMSymbol(e){var t,i;return((t=e.data)==null||(i=t.symbol)==null?void 0:i.type)!=="CIMPointSymbol"?null:e.data.symbol.callout?new qg({symbolLayers:[om.fromCIMSymbol(e)],callout:{type:"line",size:.5,color:[0,0,0]},verticalOffset:{screenLength:40}}):new qg({symbolLayers:[om.fromCIMSymbol(e)]})}static fromTextSymbol(e){return new qg({symbolLayers:[cb.fromTextSymbol(e)]})}};u([d({type:O_,json:{write:!0}})],Vv.prototype,"verticalOffset",void 0),u([d(hce)],Vv.prototype,"callout",void 0),u([d({type:bce,json:{origins:{"web-scene":{write:!0}}}})],Vv.prototype,"symbolLayers",void 0),u([ut({PointSymbol3D:"point-3d"},{readOnly:!0})],Vv.prototype,"type",void 0),Vv=qg=u([P("esri.symbols.PointSymbol3D")],Vv);const ky=Vv;var jE;const wce=it.ofType({base:null,key:"type",typeMap:{extrude:Q7,fill:uO,icon:om,line:zS,object:XN,text:cb,water:vj}}),LCe=it.ofType({base:null,key:"type",typeMap:{extrude:Q7,fill:uO,icon:om,line:zS,object:XN,water:vj}});let Aw=jE=class extends BS{constructor(e){super(e),this.symbolLayers=new wce,this.type="polygon-3d"}writeSymbolLayers(e,t,i,r){const s=e.filter(n=>n.type!=="text");if(r&&r.messages&&s.length<e.length){const n=e.find(o=>o.type==="text");r.messages.push(new q("symbol-layer:unsupported","Symbol layers of type 'text' cannot be persisted in PolygonSymbol3D",{symbolLayer:n}))}t[i]=s.map(n=>n.write({},r)).toArray()}clone(){return new jE({styleOrigin:se(this.styleOrigin),symbolLayers:se(this.symbolLayers),thumbnail:se(this.thumbnail)})}static fromJSON(e){const t=new jE;if(t.read(e),t.symbolLayers.length===2&&t.symbolLayers.getItemAt(0).type==="fill"&&t.symbolLayers.getItemAt(1).type==="line"){const i=t.symbolLayers.getItemAt(0),r=t.symbolLayers.getItemAt(1);!r.enabled||e.symbolLayers&&e.symbolLayers[1]&&e.symbolLayers[1].enable===!1||(i.outline={size:r.size,color:_(r.material)?r.material.color:null}),t.symbolLayers.removeAt(1)}return t}static fromSimpleFillSymbol(e){return new jE({symbolLayers:[uO.fromSimpleFillSymbol(e)]})}};u([d({type:wce,json:{type:LCe}})],Aw.prototype,"symbolLayers",void 0),u([Fe("web-scene","symbolLayers")],Aw.prototype,"writeSymbolLayers",null),u([ut({PolygonSymbol3D:"polygon-3d"},{readOnly:!0})],Aw.prototype,"type",void 0),Aw=jE=u([P("esri.symbols.PolygonSymbol3D")],Aw);const hO=Aw;var kB;const M5=new si({esriSFSSolid:"solid",esriSFSNull:"none",esriSFSHorizontal:"horizontal",esriSFSVertical:"vertical",esriSFSForwardDiagonal:"forward-diagonal",esriSFSBackwardDiagonal:"backward-diagonal",esriSFSCross:"cross",esriSFSDiagonalCross:"diagonal-cross"});let Gv=kB=class extends Ale{constructor(...e){super(...e),this.color=new Je([0,0,0,.25]),this.outline=new sd,this.type="simple-fill",this.style="solid"}normalizeCtorArgs(e,t,i){if(e&&typeof e!="string")return e;const r={};return e&&(r.style=e),t&&(r.outline=t),i&&(r.color=i),r}clone(){return new kB({color:se(this.color),outline:this.outline&&this.outline.clone(),style:this.style})}hash(){return`${super.hash()}${this.style}.${this.color&&this.color.hash()}`}};u([d()],Gv.prototype,"color",void 0),u([d()],Gv.prototype,"outline",void 0),u([ut({esriSFS:"simple-fill"},{readOnly:!0})],Gv.prototype,"type",void 0),u([d({type:M5.apiValues,json:{read:M5.read,write:M5.write}})],Gv.prototype,"style",void 0),Gv=kB=u([P("esri.symbols.SimpleFillSymbol")],Gv);const ub=Gv;var zB;const P5=new si({esriSMSCircle:"circle",esriSMSSquare:"square",esriSMSCross:"cross",esriSMSX:"x",esriSMSDiamond:"diamond",esriSMSTriangle:"triangle",esriSMSPath:"path"});let Ld=zB=class extends fce{constructor(...e){super(...e),this.color=new Je([255,255,255,.25]),this.type="simple-marker",this.size=12,this.style="circle",this.outline=new sd}normalizeCtorArgs(e,t,i,r){if(e&&typeof e!="string")return e;const s={};return e&&(s.style=e),t!=null&&(s.size=Vi(t)),i&&(s.outline=i),r&&(s.color=r),s}writeColor(e,t){e&&this.style!=="x"&&this.style!=="cross"&&(t.color=e.toJSON()),e===null&&(t.color=null)}set path(e){this.style="path",this._set("path",e)}clone(){return new zB({angle:this.angle,color:se(this.color),outline:this.outline&&this.outline.clone(),path:this.path,size:this.size,style:this.style,xoffset:this.xoffset,yoffset:this.yoffset})}hash(){var e;return`${super.hash()}.${this.color&&this.color.hash()}.${this.path}.${this.style}.${(e=this.outline)==null?void 0:e.hash()}`}};u([d()],Ld.prototype,"color",void 0),u([Fe("color")],Ld.prototype,"writeColor",null),u([ut({esriSMS:"simple-marker"},{readOnly:!0})],Ld.prototype,"type",void 0),u([d()],Ld.prototype,"size",void 0),u([d({type:P5.apiValues,json:{read:P5.read,write:P5.write}})],Ld.prototype,"style",void 0),u([d({type:String,json:{write:!0}})],Ld.prototype,"path",null),u([d({types:{key:"type",base:null,defaultKeyValue:"simple-line",typeMap:{"simple-line":sd}},json:{default:null,write:!0}})],Ld.prototype,"outline",void 0),Ld=zB=u([P("esri.symbols.SimpleMarkerSymbol")],Ld);const VS=Ld;var BB;let $r=BB=class extends Al{constructor(...e){super(...e),this.backgroundColor=null,this.borderLineColor=null,this.borderLineSize=null,this.font=new HN,this.horizontalAlignment="center",this.kerning=!0,this.haloColor=null,this.haloSize=null,this.rightToLeft=null,this.rotated=!1,this.text="",this.type="text",this.verticalAlignment="baseline",this.xoffset=0,this.yoffset=0,this.angle=0,this.width=null,this.lineWidth=192,this.lineHeight=1}normalizeCtorArgs(e,t,i){if(e&&typeof e!="string")return e;const r={};return e&&(r.text=e),t&&(r.font=t),i&&(r.color=i),r}writeLineWidth(e,t,i,r){r&&typeof r!="string"?r.origin:t[i]=e}castLineWidth(e){return Vi(e)}writeLineHeight(e,t,i,r){r&&typeof r!="string"?r.origin:t[i]=e}clone(){return new BB({angle:this.angle,backgroundColor:se(this.backgroundColor),borderLineColor:se(this.borderLineColor),borderLineSize:this.borderLineSize,color:se(this.color),font:this.font&&this.font.clone(),haloColor:se(this.haloColor),haloSize:this.haloSize,horizontalAlignment:this.horizontalAlignment,kerning:this.kerning,lineHeight:this.lineHeight,lineWidth:this.lineWidth,rightToLeft:this.rightToLeft,rotated:this.rotated,text:this.text,verticalAlignment:this.verticalAlignment,width:this.width,xoffset:this.xoffset,yoffset:this.yoffset})}hash(){return`${this.backgroundColor&&this.backgroundColor.hash()}.${this.borderLineColor}.${this.borderLineSize}.${this.color.hash()}.${this.font&&this.font.hash()}.${this.haloColor&&this.haloColor.hash()}.${this.haloSize}.${this.horizontalAlignment}.${this.kerning}.${this.rightToLeft}.${this.rotated}.${this.text}.${this.verticalAlignment}.${this.width}.${this.xoffset}.${this.yoffset}.${this.lineHeight}.${this.lineWidth}.${this.angle}`}};u([d({type:Je,json:{write:!0}})],$r.prototype,"backgroundColor",void 0),u([d({type:Je,json:{write:!0}})],$r.prototype,"borderLineColor",void 0),u([d({type:Number,json:{write:!0}})],$r.prototype,"borderLineSize",void 0),u([d({type:HN,json:{write:!0}})],$r.prototype,"font",void 0),u([d(me(I({},fAe),{json:{write:!0}}))],$r.prototype,"horizontalAlignment",void 0),u([d({type:Boolean,json:{write:!0}})],$r.prototype,"kerning",void 0),u([d({type:Je,json:{write:!0}})],$r.prototype,"haloColor",void 0),u([d({type:Number,cast:Vi,json:{write:!0}})],$r.prototype,"haloSize",void 0),u([d({type:Boolean,json:{write:!0}})],$r.prototype,"rightToLeft",void 0),u([d({type:Boolean,json:{write:!0}})],$r.prototype,"rotated",void 0),u([d({type:String,json:{write:!0}})],$r.prototype,"text",void 0),u([ut({esriTS:"text"},{readOnly:!0})],$r.prototype,"type",void 0),u([d(me(I({},zle),{json:{write:!0}}))],$r.prototype,"verticalAlignment",void 0),u([d({type:Number,cast:Vi,json:{write:!0}})],$r.prototype,"xoffset",void 0),u([d({type:Number,cast:Vi,json:{write:!0}})],$r.prototype,"yoffset",void 0),u([d({type:Number,json:{read:e=>e&&-1*e,write:(e,t)=>t.angle=e&&-1*e}})],$r.prototype,"angle",void 0),u([d({type:Number,json:{write:!0}})],$r.prototype,"width",void 0),u([d({type:Number})],$r.prototype,"lineWidth",void 0),u([Fe("lineWidth")],$r.prototype,"writeLineWidth",null),u([At("lineWidth")],$r.prototype,"castLineWidth",null),u([d(kle)],$r.prototype,"lineHeight",void 0),u([Fe("lineHeight")],$r.prototype,"writeLineHeight",null),$r=BB=u([P("esri.symbols.TextSymbol")],$r);const GS=$r;var VB;const NCe=he.getLogger("esri.symbols.WebStyleSymbol");let Nd=VB=class extends Al{constructor(e){super(e),this.styleName=null,this.portal=null,this.styleUrl=null,this.thumbnail=null,this.name=null,this.type="web-style"}read(e,t){this.portal=t?t.portal:void 0,super.read(e,t)}clone(){return new VB({name:this.name,styleUrl:this.styleUrl,styleName:this.styleName,portal:this.portal})}fetchSymbol(e){return this._fetchSymbol("webRef",e)}fetchCIMSymbol(e){return this._fetchSymbol("cimRef",e)}async _fetchSymbol(e,t){const i=await FCe();Qt(t);const r=i.resolveWebStyleSymbol(this,{portal:this.portal},e,t);return r.catch(s=>{NCe.error("#fetchSymbol()","Failed to create symbol from style",s)}),r}};function FCe(){return import("./webStyleSymbolUtils.1ca85e2f.js")}u([d({json:{write:!1}})],Nd.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],Nd.prototype,"styleName",void 0),u([d({type:Bn,json:{write:!1}})],Nd.prototype,"portal",void 0),u([d({type:String,json:{read:dj,write:v0}})],Nd.prototype,"styleUrl",void 0),u([d({type:WA,json:{read:!1}})],Nd.prototype,"thumbnail",void 0),u([d({type:String,json:{write:!0}})],Nd.prototype,"name",void 0),u([ut({styleSymbolReference:"web-style"},{readOnly:!0})],Nd.prototype,"type",void 0),Nd=VB=u([P("esri.symbols.WebStyleSymbol")],Nd);const hb=Nd;function xj(e){if(!e)return!1;switch(e.type){case"picture-fill":case"picture-marker":case"simple-fill":case"simple-line":case"simple-marker":case"text":case"cim":return!0;default:return!1}}function jC(e){if(!e)return!1;switch(e.type){case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":return!0;default:return!1}}const n1={base:Al,key:"type",typeMap:{"simple-fill":ub,"picture-fill":_ce,"picture-marker":QN,"simple-line":sd,"simple-marker":VS,text:GS,"label-3d":YN,"line-3d":ZN,"mesh-3d":wj,"point-3d":ky,"polygon-3d":hO,"web-style":hb,cim:$S},errorContext:"symbol"},UCe={base:Al,key:"type",typeMap:{"picture-marker":QN,"simple-marker":VS,text:GS,"web-style":hb,cim:$S},errorContext:"symbol"},kCe=PS({types:n1}),xce={base:Al,key:"type",typeMap:{"simple-fill":ub,"picture-fill":_ce,"picture-marker":QN,"simple-line":sd,"simple-marker":VS,text:GS,"line-3d":ZN,"mesh-3d":wj,"point-3d":ky,"polygon-3d":hO,"web-style":hb,cim:$S},errorContext:"symbol"},zCe={base:Al,key:"type",typeMap:{text:GS,"label-3d":YN},errorContext:"symbol"},qY={base:Al,key:"type",typeMap:{"line-3d":ZN,"mesh-3d":wj,"point-3d":ky,"polygon-3d":hO,"web-style":hb,cim:$S},errorContext:"symbol"},BCe={base:Al,key:"type",typeMap:{"label-3d":YN},errorContext:"symbol"},Tce=Zh(n1);function VCe(e){if(!e)return null;const t={};for(const i in e){const r=bp(e[i]);r&&(t[i]=r)}return Object.keys(t).length!==0?t:null}function GCe(e){if(!_(e))return null;const t={};for(const i in e){const r=e[i];r&&(t[i]=r.toJSON())}return Object.keys(t).length!==0?t:null}let za=class extends Dp(fe){constructor(...e){super(...e),this.isAggregate=!1,this.layer=null,this.popupTemplate=null,this.sourceLayer=null,Object.defineProperty(this,"uid",{value:Ta(),configurable:!0})}normalizeCtorArgs(e,t,i,r){return e&&!e.declaredClass?e:{geometry:e,symbol:t,attributes:i,popupTemplate:r}}set aggregateGeometries(e){const t=this._get("aggregateGeometries");JSON.stringify(t)!==JSON.stringify(e)&&this._set("aggregateGeometries",e)}set attributes(e){const t=this._get("attributes");t!==e&&(this._set("attributes",e),this._notifyLayer("attributes",t,e))}set geometry(e){const t=this._get("geometry");t!==e&&(this._set("geometry",e),this._notifyLayer("geometry",t,e))}set symbol(e){const t=this._get("symbol");t!==e&&(this._set("symbol",e),this._notifyLayer("symbol",t,e))}set visible(e){const t=this._get("visible");t!==e&&(this._set("visible",e),this._notifyLayer("visible",t,e))}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;for(const t of[this.sourceLayer,this.layer])if(t){if("popupTemplate"in t&&t.popupTemplate)return t.popupTemplate;if(e&&"defaultPopupTemplate"in t&&_(t.defaultPopupTemplate))return t.defaultPopupTemplate}return null}getAttribute(e){return this.attributes&&this.attributes[e]}setAttribute(e,t){if(this.attributes){const i=this.getAttribute(e);this.attributes[e]=t,this._notifyLayer("attributes",i,t,e)}else this.attributes={[e]:t},this._notifyLayer("attributes",void 0,t,e)}getObjectId(){return this.sourceLayer&&"objectIdField"in this.sourceLayer&&this.sourceLayer.objectIdField?this.getAttribute(this.sourceLayer.objectIdField):null}toJSON(){return{aggregateGeometries:GCe(this.aggregateGeometries),geometry:_(this.geometry)?this.geometry.toJSON():null,symbol:_(this.symbol)?this.symbol.toJSON():null,attributes:I({},this.attributes),popupTemplate:this.popupTemplate&&this.popupTemplate.toJSON()}}notifyGeometryChanged(){this._notifyLayer("geometry",this.geometry,this.geometry)}notifyMeshTransformChanged(){_(this.geometry)&&this.geometry.type==="mesh"&&this._notifyLayer("transform",this.geometry.transform,this.geometry.transform)}_notifyLayer(e,t,i,r){if(!this.layer||!("graphicChanged"in this.layer))return;const s={graphic:this,property:e,oldValue:t,newValue:i};e==="attributes"&&(s.attributeName=r),this.layer.graphicChanged(s)}};u([d({value:null,json:{read:VCe}})],za.prototype,"aggregateGeometries",null),u([d({value:null})],za.prototype,"attributes",null),u([d({value:null,types:ob,json:{read:bp}})],za.prototype,"geometry",null),u([d({type:Boolean})],za.prototype,"isAggregate",void 0),u([d({clonable:"reference"})],za.prototype,"layer",void 0),u([d({type:kN})],za.prototype,"popupTemplate",void 0),u([d({clonable:"reference"})],za.prototype,"sourceLayer",void 0),u([d({value:null,types:n1})],za.prototype,"symbol",null),u([d({type:Boolean,value:!0})],za.prototype,"visible",null),za=u([P("esri.Graphic")],za),function(e){e.generateUID=Ta}(za||(za={}));const qo=za;function wmt(e){}function jCe(e){return()=>e}function JN(e,t,i){return Ks(e.map((r,s)=>t.apply(i,[r,s])))}function HCe(e,t,i){return Ks(e.map((r,s)=>t.apply(i,[r,s]))).then(r=>r.map(s=>s.value))}function wl(e){return R(e)?xx():e.then(t=>({ok:!0,value:t})).catch(t=>({ok:!1,error:t}))}function xmt(e){return e.then(t=>({ok:!0,value:t})).catch(t=>(zm(t),{ok:!1,error:t}))}function Tmt(e){if(e.ok===!0)return e.value;throw e.error}async function Tj(e,t){return await e.load(),qCe(e,t)}async function qCe(e,t){const i=[],r=(...n)=>{for(const o of n)R(o)||(Array.isArray(o)?r(...o):it.isCollection(o)?o.forEach(a=>r(a)):Ep.isLoadable(o)&&i.push(o))};t(r);let s=null;if(await HCe(i,async n=>{(await wl(WCe(n)?n.loadAll():n.load())).ok!==!1||s||(s=n)}),s)throw s.loadError;return e}function WCe(e){return"loadAll"in e&&typeof e.loadAll=="function"}var GB;let TI=GB=class extends fe{constructor(e){super(e),this.type="none"}clone(){return new GB({type:this.type})}};u([ut({none:"none",stayAbove:"stay-above"})],TI.prototype,"type",void 0),TI=GB=u([P("esri.ground.NavigationConstraint")],TI);var jB;const WY=he.getLogger("esri.Ground");let wf=jB=class extends oO(Ep){constructor(e){super(e),this.opacity=1,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new it;const t=r=>{r.parent&&r.parent!==this&&"remove"in r.parent&&r.parent.remove(r),r.parent=this,r.type!=="elevation"&&r.type!=="base-elevation"&&WY.error(`Layer '${r.title}, id:${r.id}' of type '${r.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)},i=r=>{r.parent=null};this.layers.on("after-add",r=>t(r.item)),this.layers.on("after-remove",r=>i(r.item))}initialize(){this.when().catch(e=>{WY.error("#load()","Failed to load ground",e)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const e=this.layers.removeAll();for(const t of e)t.destroy();this.layers.destroy()}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e=I({},e)).resourceInfo),e}set layers(e){this._set("layers",Om(e,this._get("layers")))}writeLayers(e,t,i,r){const s=[];e&&(r=me(I({},r),{layerContainerType:"ground"}),e.forEach(n=>{if("write"in n){const o={};jCe(n)().write(o,r)&&s.push(o)}else r&&r.messages&&r.messages.push(new q("layer:unsupported",`Layers (${n.title}, ${n.id}) of type '${n.declaredClass}' cannot be persisted in the ground`,{layer:n}))})),t.layers=s}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return Tj(this,e=>{e(this.layers)})}async queryElevation(e,t){await this.load({signal:t==null?void 0:t.signal});const{ElevationQuery:i}=await import("./ElevationQuery.0fe41bd3.js");Qt(t);const r=new i,s=this.layers.filter(XY).toArray();return r.queryAll(s,e,t)}async createElevationSampler(e,t){await this.load({signal:t==null?void 0:t.signal});const{ElevationQuery:i}=await import("./ElevationQuery.0fe41bd3.js");Qt(t);const r=new i,s=this.layers.filter(XY).toArray();return r.createSamplerAll(s,e,t)}clone(){const e={opacity:this.opacity,surfaceColor:se(this.surfaceColor),navigationConstraint:se(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(e.loadStatus="loaded"),new jB({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}_loadFromSource(e){const t=this.resourceInfo;return t?this._loadLayersFromJSON(t.data,t.context,e):Promise.resolve(null)}_loadLayersFromJSON(e,t,i){const r=t&&t.origin||"web-scene",s=t&&t.portal||null,n=t&&t.url||null;return import("./layersCreator.cc0b2319.js").then(({populateOperationalLayers:o})=>{Qt(i);const a=[];if(e.layers&&Array.isArray(e.layers)){const l={context:{origin:r,url:n,portal:s,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};a.push(o(this.layers,e.layers,l))}return Ks(a)}).then(()=>{})}};function XCe(e){return e&&"createElevationSampler"in e}function XY(e){return e.type==="elevation"||XCe(e)}u([d({json:{read:!1}})],wf.prototype,"layers",null),u([Fe("layers")],wf.prototype,"writeLayers",null),u([d({readOnly:!0})],wf.prototype,"resourceInfo",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:ir,read:{reader:NT,source:"transparency"},write:{writer:(e,t)=>{t.transparency=zN(e)},target:"transparency"}}})],wf.prototype,"opacity",void 0),u([d({type:Je,json:{type:[ir],write:(e,t)=>{t.surfaceColor=e.toJSON().slice(0,3)}}})],wf.prototype,"surfaceColor",void 0),u([d({type:TI,json:{write:!0}})],wf.prototype,"navigationConstraint",void 0),wf=jB=u([P("esri.Ground")],wf);const kT=wf;var HB;let Wg=HB=class extends fe{constructor(e){super(e),this.rotation=0,this.scale=0,this.targetGeometry=null,this.camera=null}castRotation(e){return(e%=360)<0&&(e+=360),e}clone(){return new HB({rotation:this.rotation,scale:this.scale,targetGeometry:_(this.targetGeometry)?this.targetGeometry.clone():null,camera:_(this.camera)?this.camera.clone():null})}};function I5(){return{enabled:!this.camera}}u([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:I5}}}}})],Wg.prototype,"rotation",void 0),u([At("rotation")],Wg.prototype,"castRotation",null),u([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:I5}}}}})],Wg.prototype,"scale",void 0),u([d({types:ob,json:{read:bp,write:!0,origins:{"web-scene":{read:bp,write:{overridePolicy:I5}}}}})],Wg.prototype,"targetGeometry",void 0),u([d({type:_l,json:{write:!0}})],Wg.prototype,"camera",void 0),Wg=HB=u([P("esri.Viewpoint")],Wg);const xl=Wg;function KN(e){return typeof e=="string"?document.getElementById(e):e}function Sce(e){for(;e.hasChildNodes();)e.removeChild(e.firstChild)}function YY(e,t){const i=t.parentNode;i&&i.insertBefore(e,t)}function ZY(e,t){for(;;){const i=e.firstChild;if(!i)break;t.appendChild(i)}}function Smt(e){const t=[];return function*(){yield*t;for(const i of e)t.push(i),yield i}}function Emt(e,t){for(const i of e)if(i!=null&&t(i))return i}function YCe(e){return e!=null&&typeof e[Symbol.iterator]=="function"}var Sa;(function(e){e[e.HANDSHAKE=0]="HANDSHAKE",e[e.OPEN=1]="OPEN",e[e.OPENED=2]="OPENED",e[e.RESPONSE=3]="RESPONSE",e[e.INVOKE=4]="INVOKE",e[e.ABORT=5]="ABORT",e[e.CLOSE=6]="CLOSE",e[e.OPEN_PORT=7]="OPEN_PORT",e[e.ON=8]="ON"})(Sa||(Sa={}));let ZCe=0;function Ece(){return ZCe++}function QCe(e){return e&&typeof e=="object"&&("result"in e||"transferList"in e)}function OD(e){return e?typeof e=="string"?JSON.stringify({name:"message",message:e}):e.toJSON?JSON.stringify(e):JSON.stringify({name:e.name,message:e.message,details:e.details||{stack:e.stack}}):null}function Ace(e,t,i,r){if(t.type===Sa.OPEN_PORT)return void e.postMessage(t,[t.port]);if(t.type!==Sa.INVOKE&&t.type!==Sa.RESPONSE)return void e.postMessage(t);let s;QCe(i)?(s=QY(i.transferList),t.data=i.result):(s=QY(r),t.data=i),s?e.postMessage(t,s):e.postMessage(t)}function HC(e){if(!e)return null;const t=e.data;return t?typeof t=="string"?JSON.parse(t):t:null}function QY(e){if(!e||!e.length)return null;if(ue("esri-workers-arraybuffer-transfer"))return e;const t=e.filter(i=>!JCe(i));return t.length?t:null}function JCe(e){return e instanceof ArrayBuffer||e&&e.constructor&&e.constructor.name==="ArrayBuffer"}const KCe={statsWorker:()=>import("./statsWorker.904f66cd.js"),geometryEngineWorker:()=>import("./geometryEngineWorker.49a69fdc.js"),CSVSourceWorker:()=>import("./CSVSourceWorker.5d8e5653.js"),EdgeProcessingWorker:()=>Promise.resolve().then(function(){return iht}),ElevationSamplerWorker:()=>import("./ElevationSamplerWorker.a28a86ce.js"),FeatureServiceSnappingSourceWorker:()=>import("./FeatureServiceSnappingSourceWorker.b3efac3f.js"),GeoJSONSourceWorker:()=>import("./GeoJSONSourceWorker.90202c9b.js"),LercWorker:()=>import("./LercWorker.81e6a77a.js"),MemorySourceWorker:()=>import("./MemorySourceWorker.b135d0aa.js"),PBFDecoderWorker:()=>import("./PBFDecoderWorker.4f6bf516.js"),Pipeline:()=>import("./Pipeline.f19deb94.js").then(function(e){return e.P}),PointCloudWorker:()=>import("./PointCloudWorker.f215842a.js"),RasterWorker:()=>import("./RasterWorker.a432ae8c.js"),SceneLayerWorker:()=>import("./SceneLayerWorker.add8071b.js").then(function(e){return e.S}),WFSSourceWorker:()=>import("./WFSSourceWorker.1c7b9ef3.js"),WorkerTileHandler:()=>import("./WorkerTileHandler.6424f5c4.js")},{CLOSE:JY,ABORT:KY,INVOKE:eZ,RESPONSE:g2,OPEN_PORT:tZ,ON:eRe}=Sa;class tRe{constructor(t){this._timer=null,this._cancelledJobIds=new Set,this._invokeMessages=[],this._invoke=t,this._timer=null,this._process=this._process.bind(this)}push(t){t.type===Sa.ABORT?this._cancelledJobIds.add(t.jobId):(this._invokeMessages.push(t),this._timer===null&&(this._timer=setTimeout(this._process,0)))}clear(){this._invokeMessages.length=0,this._cancelledJobIds.clear(),this._timer=null}_process(){this._timer=null;for(const t of this._invokeMessages)this._cancelledJobIds.has(t.jobId)||this._invoke(t);this._cancelledJobIds.clear(),this._invokeMessages.length=0}}class sl{constructor(t,i){this._port=t,this._outJobs=new Map,this._inJobs=new Map,this._invokeQueue=new tRe(r=>this._onInvokeMessage(r)),this._client=i.client,this._onMessage=this._onMessage.bind(this),this._channel=i.channel,this._schedule=i.schedule,this._port.addEventListener("message",this._onMessage),this._port.start()}static connect(t){const i=new MessageChannel;let r;r=typeof t=="function"?new t:"default"in t&&typeof t.default=="function"?new t.default:t;const s=new sl(i.port1,{channel:i,client:r});return typeof r=="object"&&"remoteClient"in r&&(r.remoteClient=s),sl.clients.set(s,r),i.port2}static loadWorker(t){const i=KCe[t];return i?i():Promise.resolve(null)}close(){this._post({type:JY}),this._close()}isBusy(){return this._outJobs.size>0}invoke(t,i,r){const s=r&&r.signal,n=r&&r.transferList;if(!this._port)return Promise.reject(new q("worker:port-closed",`Cannot call invoke('${t}'), port is closed`,{methodName:t,data:i}));const o=Ece();return new Promise((a,l)=>{const c=tO(s,()=>{var p;const f=this._outJobs.get(o);f&&(this._outJobs.delete(o),(p=f.abortHandle)==null||p.remove(),this._post({type:KY,jobId:o}),l(pi()))}),h={resolve:a,reject:l,abortHandle:c,debugInfo:t};this._outJobs.set(o,h),this._post({type:eZ,jobId:o,methodName:t,abortable:s!=null},i,n)})}on(t,i){const r=new MessageChannel;function s(n){i(n.data)}return this._port.postMessage({type:Sa.ON,eventType:t,port:r.port2},[r.port2]),r.port1.addEventListener("message",s),r.port1.start(),{remove(){r.port1.postMessage({type:Sa.CLOSE}),r.port1.close(),r.port1.removeEventListener("message",s)}}}openPort(){const t=new MessageChannel;return this._post({type:tZ,port:t.port2}),t.port1}_close(){this._channel&&(this._channel=null),this._port.removeEventListener("message",this._onMessage),this._port.close(),this._outJobs.forEach(t=>{var i;(i=t.abortHandle)==null||i.remove(),t.reject(pi(`Worker closing, aborting job calling '${t.debugInfo}'`))}),this._inJobs.clear(),this._outJobs.clear(),this._invokeQueue.clear(),this._port=this._client=this._schedule=null}_onMessage(t){_(this._schedule)?this._schedule(()=>this._processMessage(t)):this._processMessage(t)}_processMessage(t){const i=HC(t);if(i)switch(i.type){case g2:this._onResponseMessage(i);break;case eZ:this._invokeQueue.push(i);break;case KY:this._onAbortMessage(i);break;case JY:this._onCloseMessage();break;case tZ:this._onOpenPortMessage(i);break;case eRe:this._onOnMessage(i)}}_onAbortMessage(t){const i=this._inJobs,r=t.jobId,s=i.get(r);this._invokeQueue.push(t),s&&(s.controller&&s.controller.abort(),i.delete(r))}_onCloseMessage(){const t=this._client;this._close(),t&&"destroy"in t&&sl.clients.get(this)===t&&t.destroy(),sl.clients.delete(this),t&&t.remoteClient&&(t.remoteClient=null)}_onInvokeMessage(t){const{methodName:i,jobId:r,data:s,abortable:n}=t,o=n?new AbortController:null,a=this._inJobs;let l,c=this._client,h=c[i];try{if(!h&&i&&i.indexOf(".")!==-1){const p=i.split(".");for(let f=0;f<p.length-1;f++)c=c[p[f]],h=c[p[f+1]]}if(typeof h!="function")throw new TypeError(`${i} is not a function`);l=h.call(c,s,{client:this,signal:o?o.signal:null})}catch(p){return void this._post({type:g2,jobId:r,error:OD(p)})}Cc(l)?(a.set(r,{controller:o,promise:l}),l.then(p=>{a.has(r)&&(a.delete(r),this._post({type:g2,jobId:r},p))},p=>{a.has(r)&&(a.delete(r),pr(p)||this._post({type:g2,jobId:r,error:OD(p||{message:`Error encountered at method ${i}`})}))})):this._post({type:g2,jobId:r},l)}_onOpenPortMessage(t){new sl(t.port,{client:this._client})}_onOnMessage(t){const{port:i}=t,r=this._client.on(t.eventType,n=>{i.postMessage(n)}),s=eO(t.port,"message",n=>{HC(n).type===Sa.CLOSE&&(s.remove(),r.remove(),i.close())})}_onResponseMessage(t){var i;const{jobId:r,error:s,data:n}=t,o=this._outJobs;if(!o.has(r))return;const a=o.get(r);o.delete(r),(i=a.abortHandle)==null||i.remove(),s?a.reject(q.fromJSON(JSON.parse(s))):a.resolve(n)}_post(t,i,r){return Ace(this._port,t,i,r)}}sl.kernelInfo={revision:Kle,version:fj,buildDate:Jle},sl.clients=new Map;const iRe=he.getLogger("esri.core.workers.Connection");class rRe{constructor(){this._clients=new Array,this._clientPromises=new Array,this._clientIdx=0}destroy(){this.close()}get closed(){return!this._clients||!this._clients.length}open(t,i){return new Promise((r,s)=>{let n=!0;const o=a=>{Qt(i.signal),n&&(n=!1,a())};this._clients.length=t.length,this._clientPromises.length=t.length;for(let a=0;a<t.length;++a){const l=t[a];Cc(l)?this._clientPromises[a]=l.then(c=>(this._clients[a]=new sl(c,i),o(r),this._clients[a]),()=>(o(s),null)):(this._clients[a]=new sl(l,i),this._clientPromises[a]=Promise.resolve(this._clients[a]),o(r))}})}broadcast(t,i,r){const s=new Array(this._clientPromises.length);for(let n=0;n<this._clientPromises.length;++n){const o=this._clientPromises[n];s[n]=o.then(a=>a.invoke(t,i,r))}return s}close(){for(const t of this._clientPromises)t.then(i=>i.close());this._clients.length=0,this._clientPromises.length=0}getAvailableClient(){let t;for(let i=0;i<this._clients.length;++i){const r=this._clients[i];if(r){if(!r.isBusy())return Promise.resolve(r)}else t=t||[],t.push(this._clientPromises[i])}return t?Promise.race(t):(this._clientIdx=(this._clientIdx+1)%this._clients.length,Promise.resolve(this._clients[this._clientIdx]))}invoke(t,i,r){let s=null;return Array.isArray(r)?(iRe.warn("invoke()","The transferList parameter is deprecated, use the options object instead"),s={transferList:r}):s=r,this.closed?Promise.reject(new Error("Connection closed")):this.getAvailableClient().then(n=>n.invoke(t,i,s))}on(t,i){return Promise.all(this._clientPromises).then(()=>ET(this._clients.map(r=>r.on(t,i))))}openPorts(){return new Promise(t=>{const i=new Array(this._clientPromises.length);let r=i.length;for(let s=0;s<this._clientPromises.length;++s)this._clientPromises[s].then(n=>{i[s]=n.openPort(),--r==0&&t(i)})})}get test(){return{numClients:this._clients.length}}}const sRe=he.getLogger("esri.assets");function nRe(e,t){return Ti(ui(e),t)}function ui(e){if(!Bi.assetsPath)throw sRe.errorOnce("The API assets location needs to be set using config.assetsPath. More information: https://arcg.is/1OzLe50"),new q("assets:path-not-set","config.assetsPath is not set");return bl(Bi.assetsPath,e)}const Cce=he.getLogger("esri.intl");function xf(e,t,i={}){const{format:r={}}=i;return _p(e,s=>oRe(s,t,r))}function oRe(e,t,i){let r,s;const n=e.indexOf(":");if(n===-1?r=e.trim():(r=e.slice(0,n).trim(),s=e.slice(n+1).trim()),!r)return"";const o=MS(r,t);if(o==null)return"";const a=i[s]||i[r];return a?aRe(o,a):s?lRe(o,s):Sj(o)}function aRe(e,t){switch(t.type){case"date":return Cm(e,t.intlOptions);case"number":return Rm(e,t.intlOptions);default:return Cce.warn("missing format descriptor for key {key}"),Sj(e)}}function lRe(e,t){switch(t.toLowerCase()){case"dateformat":return Cm(e);case"numberformat":return Rm(e);default:return Cce.warn(`inline format is unsupported since 4.12: ${t}`),/^(dateformat|datestring)/i.test(t)?Cm(e):/^numberformat/i.test(t)?Rm(e):Sj(e)}}function Sj(e){switch(typeof e){case"string":return e;case"number":return Rm(e);case"boolean":return""+e;default:return e instanceof Date?Cm(e):""}}const iZ=/^([a-z]{2})(?:[-_]([A-Za-z]{2}))?$/,cRe={ar:!0,bg:!0,bs:!0,ca:!0,cs:!0,da:!0,de:!0,el:!0,en:!0,es:!0,et:!0,fi:!0,fr:!0,he:!0,hr:!0,hu:!0,id:!0,it:!0,ja:!0,ko:!0,lt:!0,lv:!0,nb:!0,nl:!0,pl:!0,"pt-BR":!0,"pt-PT":!0,ro:!0,ru:!0,sk:!0,sl:!0,sr:!0,sv:!0,th:!0,tr:!0,uk:!0,vi:!0,"zh-CN":!0,"zh-HK":!0,"zh-TW":!0};function rZ(e){var t;return(t=cRe[e])!=null&&t}const HE=[],Jx=new Map;function sZ(e){for(const t of Jx.keys())Oce(e.pattern,t)&&Jx.delete(t)}function uRe(e){return HE.includes(e)||(sZ(e),HE.unshift(e)),{remove(){const t=HE.indexOf(e);t>-1&&(HE.splice(t,1),sZ(e))}}}async function Rce(e){const t=dc();Jx.has(e)||Jx.set(e,dRe(e,t));const i=Jx.get(e);return await pRe.add(i),i}function hRe(e){if(!iZ.test(e))return null;const[,t,i]=iZ.exec(e),r=t+(i?"-"+i.toUpperCase():"");return rZ(r)?r:rZ(t)?t:null}async function dRe(e,t){const i=[];for(const r of HE)if(Oce(r.pattern,e))try{return await r.fetchMessageBundle(e,t)}catch(s){i.push(s)}throw i.length?new q("intl:message-bundle-error",`Errors occurred while loading "${e}"`,{errors:i}):new q("intl:no-message-bundle-loader",`No loader found for message bundle "${e}"`)}function Oce(e,t){return typeof e=="string"?t.startsWith(e):e.test(t)}q7(()=>{Jx.clear()});const pRe=new class{constructor(){this._numLoading=0}async waitForAll(){this._dfd&&await this._dfd.promise}add(e){return this._increase(),e.then(()=>this._decrease(),()=>this._decrease()),this.waitForAll()}_increase(){this._numLoading++,this._dfd||(this._dfd=f0())}_decrease(){this._numLoading=Math.max(this._numLoading-1,0),this._dfd&&this._numLoading===0&&(this._dfd.resolve(),this._dfd=null)}};async function fRe(e,t,i,r){const s=t.exec(i);if(!s)throw new q("esri-intl:invalid-bundle",`Bundle id "${i}" is not compatible with the pattern "${t}"`);const n=s[1]?`${s[1]}/`:"",o=s[2],a=hRe(r),l=`${n}${o}.json`,c=a?`${n}${o}_${a}.json`:l;let h;try{h=await nZ(e(c))}catch(p){if(c===l)throw new q("intl:unknown-bundle",`Bundle "${i}" cannot be loaded`,{error:p});try{h=await nZ(e(l))}catch(f){throw new q("intl:unknown-bundle",`Bundle "${i}" cannot be loaded`,{error:f})}}return h}async function nZ(e){if(_(oZ.fetchBundleAsset))return oZ.fetchBundleAsset(e);const t=await Ti(e,{responseType:"text"});return JSON.parse(t.data)}class mRe{constructor({base:t="",pattern:i,location:r=new URL(window.location.href)}){let s;s=typeof r=="string"?n=>new URL(n,new URL(r,window.location.href)).href:r instanceof URL?n=>new URL(n,r).href:r,this.pattern=typeof i=="string"?new RegExp(`^${i}`):i,this.getAssetUrl=s,t=t?t.endsWith("/")?t:t+"/":"",this.matcher=new RegExp(`^${t}(?:(.*)/)?(.*)$`)}fetchMessageBundle(t,i){return fRe(this.getAssetUrl,this.matcher,t,i)}}function gRe(e){return new mRe(e)}const oZ={};uRe(gRe({pattern:"esri/",location:ui}));const aZ={};function yRe(e,t){for(const i of e)if(i.name===t.name)return;e.push(t)}function vRe(e){var t;const i={async:e.async,isDebug:e.isDebug,locale:e.locale,baseUrl:e.baseUrl,has:I({},e.has),map:I({},e.map),packages:e.packages&&e.packages.concat()||[],paths:I({},e.paths)};return e.hasOwnProperty("async")||(i.async=!0),e.hasOwnProperty("isDebug")||(i.isDebug=!1),e.baseUrl||(i.baseUrl=aZ.baseUrl),(t=aZ.packages)==null||t.forEach(r=>{yRe(i.packages,r)}),i}class _Re{constructor(){const t=document.createDocumentFragment();["addEventListener","dispatchEvent","removeEventListener"].forEach(i=>{this[i]=(...r)=>t[i](...r)})}}class SI{constructor(){this._dispatcher=new _Re,this._workerPostMessage({type:Sa.HANDSHAKE})}terminate(){}get onmessage(){return this._onmessageHandler}set onmessage(t){this._onmessageHandler&&this.removeEventListener("message",this._onmessageHandler),this._onmessageHandler=t,t&&this.addEventListener("message",t)}get onmessageerror(){return this._onmessageerrorHandler}set onmessageerror(t){this._onmessageerrorHandler&&this.removeEventListener("messageerror",this._onmessageerrorHandler),this._onmessageerrorHandler=t,t&&this.addEventListener("messageerror",t)}get onerror(){return this._onerrorHandler}set onerror(t){this._onerrorHandler&&this.removeEventListener("error",this._onerrorHandler),this._onerrorHandler=t,t&&this.addEventListener("error",t)}postMessage(t){CT(()=>{this._workerMessageHandler(new MessageEvent("message",{data:t}))})}dispatchEvent(t){return this._dispatcher.dispatchEvent(t)}addEventListener(t,i,r){this._dispatcher.addEventListener(t,i,r)}removeEventListener(t,i,r){this._dispatcher.removeEventListener(t,i,r)}_workerPostMessage(t){CT(()=>{this.dispatchEvent(new MessageEvent("message",{data:t}))})}async _workerMessageHandler(t){const i=HC(t);if(i&&i.type===Sa.OPEN){const{modulePath:r,jobId:s}=i;let n=await sl.loadWorker(r);n||(n=await import(r));const o=sl.connect(n);this._workerPostMessage({type:Sa.OPENED,jobId:s,data:o})}}}const qB=he.getLogger("esri.core.workers"),{HANDSHAKE:bRe}=Sa,wRe='let globalId=0;const outgoing=new Map,configuration=JSON.parse("{CONFIGURATION}");self.esriConfig=configuration.esriConfig;const workerPath=self.esriConfig.workers.workerPath,HANDSHAKE=0,OPEN=1,OPENED=2,RESPONSE=3,INVOKE=4,ABORT=5;function createAbortError(){const e=new Error("Aborted");return e.name="AbortError",e}function receiveMessage(e){return e&&e.data?"string"==typeof e.data?JSON.parse(e.data):e.data:null}function invokeStaticMessage(e,o,r){const t=r&&r.signal,n=globalId++;return new Promise(((r,i)=>{if(t){if(t.aborted)return i(createAbortError());t.addEventListener("abort",(()=>{outgoing.get(n)&&(outgoing.delete(n),self.postMessage({type:5,jobId:n}),i(createAbortError()))}))}outgoing.set(n,{resolve:r,reject:i}),self.postMessage({type:4,jobId:n,methodName:e,abortable:null!=t,data:o})}))}let workerRevisionChecked=!1;function checkWorkerRevision(e){if(!workerRevisionChecked&&e.kernelInfo){workerRevisionChecked=!0;const{revision:o,buildDate:r,version:t}=configuration.kernelInfo,{revision:n,buildDate:i,version:s}=e.kernelInfo;o!==n&&console.warn(`[esri.core.workers] Version mismatch detected between ArcGIS API for JavaScript and assets:\\nAPI version: ${t} [Date: ${r}, Revision: ${o.slice(0,8)}]\nAssets version: ${s} [Date: ${i}, Revision: ${n.slice(0,8)}]`)}}function messageHandler(e){const o=receiveMessage(e);if(!o)return;const r=o.jobId;switch(o.type){case 1:let e;function t(o){const t=e.connect(o);self.postMessage({type:2,jobId:r,data:t},[t])}"function"==typeof define&&define.amd?require([workerPath],(r=>{e=r.default||r,checkWorkerRevision(e),e.loadWorker(o.modulePath).then((e=>e||new Promise((e=>{require([o.modulePath],e)})))).then(t)})):"System"in self&&"function"==typeof System.import?System.import(workerPath).then((r=>(e=r.default,checkWorkerRevision(e),e.loadWorker(o.modulePath)))).then((e=>e||System.import(o.modulePath))).then(t):esriConfig.workers.useDynamicImport?import(workerPath).then((r=>{e=r.default||r,checkWorkerRevision(e),e.loadWorker(o.modulePath).then((e=>e||import(o.modulePath))).then(t)})):(self.RemoteClient||importScripts(workerPath),e=self.RemoteClient.default||self.RemoteClient,checkWorkerRevision(e),e.loadWorker(o.modulePath).then(t));break;case 3:if(outgoing.has(r)){const e=outgoing.get(r);outgoing.delete(r),o.error?e.reject(JSON.parse(o.error)):e.resolve(o.data)}}}self.dojoConfig=configuration.loaderConfig,esriConfig.workers.loaderUrl&&(self.importScripts(esriConfig.workers.loaderUrl),"function"==typeof require&&"function"==typeof require.config&&require.config(configuration.loaderConfig)),self.addEventListener("message",messageHandler),self.postMessage({type:0});';let yM,vM;const lZ="Failed to create Worker. Fallback to execute module in main thread";async function xRe(){if(!ue("esri-workers")||(ue("mozilla"),0))return cZ(new SI);if(!yM&&!vM)try{const t=wRe.replace('"{CONFIGURATION}"',`'${TRe()}'`);yM=URL.createObjectURL(new Blob([t],{type:"text/javascript"}))}catch(t){vM=t||{}}let e;if(yM)try{e=new Worker(yM,{name:"esri-worker-"+SRe++})}catch{qB.warn(lZ,vM),e=new SI}else qB.warn(lZ,vM),e=new SI;return cZ(e)}async function cZ(e){return new Promise(t=>{function i(s){const n=HC(s);n&&n.type===bRe&&(e.removeEventListener("message",i),e.removeEventListener("error",r),t(e))}function r(s){s.preventDefault(),e.removeEventListener("message",i),e.removeEventListener("error",r),qB.warn("Failed to create Worker. Fallback to execute module in main thread",s),(e=new SI).addEventListener("message",i),e.addEventListener("error",r)}e.addEventListener("message",i),e.addEventListener("error",r)})}function TRe(){let e;if(Bi.default!=null){const s=I({},Bi);delete s.default,e=JSON.parse(JSON.stringify(s))}else e=JSON.parse(JSON.stringify(Bi));e.assetsPath=Au(e.assetsPath),e.request.interceptors=[],e.log.interceptors=[],e.locale=dc(),e.has={"esri-csp-restrictions":ue("esri-csp-restrictions"),"esri-2d-debug":!1,"esri-2d-update-debug":ue("esri-2d-update-debug"),"esri-2d-query-centroid-enabled":ue("esri-2d-query-centroid-enabled"),"featurelayer-pbf":ue("featurelayer-pbf"),"featurelayer-simplify-thresholds":ue("featurelayer-simplify-thresholds"),"featurelayer-simplify-payload-size-factors":ue("featurelayer-simplify-payload-size-factors"),"featurelayer-simplify-mobile-factor":ue("featurelayer-simplify-mobile-factor"),"esri-atomics":ue("esri-atomics"),"esri-shared-array-buffer":ue("esri-shared-array-buffer"),"esri-tiles-debug":ue("esri-tiles-debug"),"esri-workers-arraybuffer-transfer":ue("esri-workers-arraybuffer-transfer"),"feature-polyline-generalization-factor":ue("feature-polyline-generalization-factor"),"host-webworker":1},e.workers.loaderUrl&&(e.workers.loaderUrl=Au(e.workers.loaderUrl)),e.workers.workerPath?e.workers.workerPath=Au(e.workers.workerPath):e.workers.workerPath=Au(ui("esri/core/workers/RemoteClient.js")),e.workers.useDynamicImport=!1;const t=Bi.workers.loaderConfig,i=vRe({baseUrl:t==null?void 0:t.baseUrl,locale:dc(),has:I({"csp-restrictions":1,"dojo-test-sniff":0,"host-webworker":1},t==null?void 0:t.has),map:I({},t==null?void 0:t.map),paths:I({},t==null?void 0:t.paths),packages:(t==null?void 0:t.packages)||[]}),r={version:fj,buildDate:Jle,revision:Kle};return JSON.stringify({esriConfig:e,loaderConfig:i,kernelInfo:r})}let SRe=0;const ERe=he.getLogger("esri.core.workers"),{ABORT:uZ,INVOKE:ARe,OPEN:CRe,OPENED:RRe,RESPONSE:y2}=Sa;class Ej{constructor(t,i){this._outJobs=new Map,this._inJobs=new Map,this.worker=t,this.id=i,t.addEventListener("message",this._onMessage.bind(this)),t.addEventListener("error",r=>{r.preventDefault(),ERe.error(r)})}static async create(t){const i=await xRe();return new Ej(i,t)}terminate(){this.worker.terminate()}async open(t,i={}){const{signal:r}=i,s=Ece();return new Promise((n,o)=>{const a={resolve:n,reject:o,abortHandle:tO(r,()=>{this._outJobs.delete(s),this._post({type:uZ,jobId:s})})};this._outJobs.set(s,a),this._post({type:CRe,jobId:s,modulePath:t})})}_onMessage(t){const i=HC(t);if(i)switch(i.type){case RRe:this._onOpenedMessage(i);break;case y2:this._onResponseMessage(i);break;case uZ:this._onAbortMessage(i);break;case ARe:this._onInvokeMessage(i)}}_onAbortMessage(t){const i=this._inJobs,r=t.jobId,s=i.get(r);s&&(s.controller&&s.controller.abort(),i.delete(r))}_onInvokeMessage(t){const{methodName:i,jobId:r,data:s,abortable:n}=t,o=n?new AbortController:null,a=this._inJobs,l=iCe[i];let c;try{if(typeof l!="function")throw new TypeError(`${i} is not a function`);c=l.call(null,s,{signal:o?o.signal:null})}catch(h){return void this._post({type:y2,jobId:r,error:OD(h)})}Cc(c)?(a.set(r,{controller:o,promise:c}),c.then(h=>{a.has(r)&&(a.delete(r),this._post({type:y2,jobId:r},h))},h=>{a.has(r)&&(a.delete(r),h||(h={message:"Error encountered at method"+i}),pr(h)||this._post({type:y2,jobId:r,error:OD(h||{message:`Error encountered at method ${i}`})}))})):this._post({type:y2,jobId:r},c)}_onOpenedMessage(t){var i;const{jobId:r,data:s}=t,n=this._outJobs.get(r);n&&(this._outJobs.delete(r),(i=n.abortHandle)==null||i.remove(),n.resolve(s))}_onResponseMessage(t){var i;const{jobId:r,error:s,data:n}=t,o=this._outJobs.get(r);o&&(this._outJobs.delete(r),(i=o.abortHandle)==null||i.remove(),s?o.reject(q.fromJSON(JSON.parse(s))):o.resolve(n))}_post(t,i,r){return Ace(this.worker,t,i,r)}}let j_=ue("esri-workers-debug")?1:ue("host-browser")?navigator.hardwareConcurrency-1:0;j_||(j_=ue("safari")&&ue("mac")||ue("trident")?7:2);let hZ=0;const EI=[];function ORe(){Pce()}async function _M(e,t){const i=new rRe;return await i.open(e,t),i}async function Mce(e,t={}){if(typeof e!="string")throw new q("workers:undefined-module","modulePath is missing");let i=t.strategy||"distributed";if(ue("host-webworker")&&!ue("esri-workers")&&(i="local"),i==="local"){let r=await sl.loadWorker(e);r||(r=await import(e)),Qt(t.signal);const s=t.client||r;return _M([sl.connect(r)],me(I({},t),{client:s}))}if(await Pce(),Qt(t.signal),i==="dedicated"){const r=hZ++%j_;return _M([await EI[r].open(e,t)],t)}if(t.maxNumWorkers&&t.maxNumWorkers>0){const r=Math.min(t.maxNumWorkers,j_);if(r<j_){const s=new Array(r);for(let n=0;n<r;++n){const o=hZ++%j_;s[n]=EI[o].open(e,t)}return _M(s,t)}}return _M(EI.map(r=>r.open(e,t)),t)}let bM=null;async function Pce(){if(bM)return bM;new AbortController;const e=[];for(let t=0;t<j_;t++){const i=Ej.create(t).then(r=>(EI[t]=r,r));e.push(i)}return bM=Promise.all(e),bM}let AI=class extends we{constructor(e){super(e),this._groups=new Map}destroy(){this.removeAll()}get size(){let e=0;return this._groups.forEach(t=>{e+=t.length}),e}add(e,t){if(!this._isHandle(e)&&!Array.isArray(e)&&!it.isCollection(e))return this;const i=this._getOrCreateGroup(t);return Array.isArray(e)||it.isCollection(e)?e.forEach(r=>this._isHandle(r)&&i.push(r)):i.push(e),this.notifyChange("size"),this}forEach(e,t){if(typeof e=="function")this._groups.forEach(i=>i.forEach(e));else{const i=this._getGroup(e);i&&t&&i.forEach(t)}}has(e){return this._groups.has(this._ensureGroupKey(e))}remove(e){if(Array.isArray(e)||it.isCollection(e))return e.forEach(this.remove,this),this;if(!this.has(e))return this;const t=this._getGroup(e);for(let i=0;i<t.length;i++)t[i].remove();return this._deleteGroup(e),this.notifyChange("size"),this}removeAll(){return this._groups.forEach(e=>{for(let t=0;t<e.length;t++)e[t].remove()}),this._groups.clear(),this.notifyChange("size"),this}_isHandle(e){return e&&!!e.remove}_getOrCreateGroup(e){if(this.has(e))return this._getGroup(e);const t=[];return this._groups.set(this._ensureGroupKey(e),t),t}_getGroup(e){return this._groups.get(this._ensureGroupKey(e))}_deleteGroup(e){return this._groups.delete(this._ensureGroupKey(e))}_ensureGroupKey(e){return e||"_default_"}};u([d({readOnly:!0})],AI.prototype,"size",null),AI=u([P("esri.core.Handles")],AI);const Ut=AI;let fp=class extends we{constructor(){super(...arguments),this.updating=!1,this.handleId=0,this.handles=new Ut,this.scheduleHandleId=0,this.pendingPromises=new Set}destroy(){this.removeAll(),this.handles.destroy()}add(e,t,i={}){return this._installWatch(e,t,i,Nt)}addWhen(e,t,i={}){return this._installWatch(e,t,i,IN)}addOnCollectionChange(e,t,{initial:i=!1}={}){const r=++this.handleId;return this.handles.add([Yx(e,"after-changes",this._createSyncUpdatingCallback(),Sh),Yx(e,"change",t,{onListenerAdd:i?s=>t({added:s.toArray(),removed:[]}):void 0})],r),{remove:()=>this.handles.remove(r)}}addPromise(e){if(R(e))return e;const t=++this.handleId;this.handles.add({remove:()=>{this.pendingPromises.delete(e)&&(this.pendingPromises.size!==0||this.handles.has(wM)||this._set("updating",!1))}},t),this.pendingPromises.add(e),this._set("updating",!0);const i=()=>this.handles.remove(t);return e.then(i,i),e}removeAll(){this.pendingPromises.clear(),this.handles.removeAll(),this._set("updating",!1)}_installWatch(e,t,i={},r){const s=++this.handleId;i.sync||this._installSyncUpdatingWatch(e,s);const n=r(e,t,i);return this.handles.add(n,s),{remove:()=>this.handles.remove(s)}}_installSyncUpdatingWatch(e,t){const i=this._createSyncUpdatingCallback(),r=Nt(e,i,{sync:!0,equals:()=>!1});return this.handles.add(r,t),r}_createSyncUpdatingCallback(){return()=>{this.handles.remove(wM),++this.scheduleHandleId;const e=this.scheduleHandleId;this._get("updating")||this._set("updating",!0),this.handles.add(rO(()=>{e===this.scheduleHandleId&&(this._set("updating",this.pendingPromises.size>0),this.handles.remove(wM))}),wM)}}};u([d({readOnly:!0})],fp.prototype,"updating",void 0),fp=u([P("esri.views.support.WatchUpdatingTracking")],fp);const wM=-42;var dZ;(function(e){e[e.NONE=0]="NONE",e[e.SYNC=1]="SYNC",e[e.INIT=2]="INIT"})(dZ||(dZ={}));const Vm=e=>{let t=class extends e{destroy(){var i,r;this.destroyed||((i=this._get("handles"))==null||i.destroy(),(r=this._get("updatingHandles"))==null||r.destroy())}get handles(){return this._get("handles")||new Ut}get updatingHandles(){return this._get("updatingHandles")||new fp}};return u([d({readOnly:!0})],t.prototype,"handles",null),u([d({readOnly:!0})],t.prototype,"updatingHandles",null),t=u([P("esri.core.HandleOwner")],t),t};let zT=class extends Vm(we){};zT=u([P("esri.core.HandleOwner")],zT);he.getLogger("esri.core.support.OwningCollection");let YA=class extends Vm(it){constructor(e){super(e),this.handles.add([this.on("before-add",t=>{R(t.item)&&t.preventDefault()}),this.on("after-add",t=>this._own(t.item)),this.on("after-remove",t=>this._release(t.item))])}get owner(){return this._get("owner")}set owner(e){e!==this._get("owner")&&(this._releaseAll(),this._set("owner",e),this._ownAll())}_ownAll(){for(const e of this.items)this._own(e)}_releaseAll(){for(const e of this.items)this._release(e)}_createNewInstance(e){return this.itemType?new(it.ofType(this.itemType.Type))(e):new it(e)}};function WB(e,t){return{type:e,cast:pj,set(i){const r=Om(i,this._get(t),e);r.owner=this,this._set(t,r)}}}u([d()],YA.prototype,"owner",null),YA=u([P("esri.core.support.OwningCollection")],YA);function Aj(e){return new He({wkt:`GEOCCS["Spherical geocentric",
    DATUM["Not specified",
      SPHEROID["Sphere",${e.radius},0]],
    PRIMEM["Greenwich",0.0,
      AUTHORITY["EPSG","8901"]],
    UNIT["m",1.0],
    AXIS["Geocentric X",OTHER],
    AXIS["Geocentric Y",EAST],
    AXIS["Geocentric Z",NORTH]
  ]`})}const Ice=Aj(ai),MD=Aj(pp),PD=Aj(Am),MRe=new He({wkt:`GEOCCS["WGS 84",
  DATUM["WGS_1984",
    SPHEROID["WGS 84",${ai.radius},298.257223563,
      AUTHORITY["EPSG","7030"]],
    AUTHORITY["EPSG","6326"]],
  PRIMEM["Greenwich",0,
    AUTHORITY["EPSG","8901"]],
  UNIT["m",1.0,
    AUTHORITY["EPSG","9001"]],
  AXIS["Geocentric X",OTHER],
  AXIS["Geocentric Y",OTHER],
  AXIS["Geocentric Z",NORTH],
  AUTHORITY["EPSG","4978"]
]`});function eF(e){return e&&(Lp(e)||e===MD)?MD:e&&(Np(e)||e===PD)?PD:Ice}function di(e){return e&&(Lp(e)||e===MD)?pp:e&&(Np(e)||e===PD)?Am:ai}function Amt(e){return M7(e)?pp:P7(e)?Am:ai}const $ce=39.37,PRe=ai.radius*Math.PI/200,Dce=/UNIT\[([^\]]+)\]\]$/i,o1=D,Lce=/UNIT\[([^\]]+)\]/i,IRe=new Set([4261,4305,4807,4810,4811,4812,4816,4819,4821,4901,4902,37225,104139,104140]),$Re=_o()({meter:"meters",foot:"feet",foot_us:"us-feet",foot_clarke:"clarke-feet",yard_clarke:"clarke-yards",link_clarke:"clarke-links",yard_sears:"sears-yards",foot_sears:"sears-feet",chain_sears:"sears-chains",chain_benoit_1895_b:"benoit-1895-b-chains",yard_indian:"indian-yards",yard_indian_1937:"indian-1937-yards",foot_gold_coast:"gold-coast-feet",chain_sears_1922_truncated:"sears-1922-truncated-chains","50_kilometers":"50-kilometers","150_kilometers":"150-kilometers"}),ud=e=>e*e,ag=e=>e*e*e,qC={length:{baseUnit:"meters",units:{millimeters:{inBaseUnits:.001},centimeters:{inBaseUnits:.01},decimeters:{inBaseUnits:.1},meters:{inBaseUnits:1},kilometers:{inBaseUnits:1e3},inches:{inBaseUnits:.0254},feet:{inBaseUnits:.3048},yards:{inBaseUnits:.9144},miles:{inBaseUnits:1609.344},"nautical-miles":{inBaseUnits:1852},"us-feet":{inBaseUnits:1200/3937}}},area:{baseUnit:"square-meters",units:{"square-millimeters":{inBaseUnits:ud(.001)},"square-centimeters":{inBaseUnits:ud(.01)},"square-decimeters":{inBaseUnits:ud(.1)},"square-meters":{inBaseUnits:1},"square-kilometers":{inBaseUnits:ud(1e3)},"square-inches":{inBaseUnits:ud(.0254)},"square-feet":{inBaseUnits:ud(.3048)},"square-yards":{inBaseUnits:ud(.9144)},"square-miles":{inBaseUnits:ud(1609.344)},"square-us-feet":{inBaseUnits:ud(1200/3937)},acres:{inBaseUnits:.0015625*ud(1609.344)},ares:{inBaseUnits:100},hectares:{inBaseUnits:1e4}}},volume:{baseUnit:"liters",units:{liters:{inBaseUnits:1},"cubic-millimeters":{inBaseUnits:1e3*ag(.001)},"cubic-centimeters":{inBaseUnits:1e3*ag(.01)},"cubic-decimeters":{inBaseUnits:1e3*ag(.1)},"cubic-meters":{inBaseUnits:1e3},"cubic-kilometers":{inBaseUnits:1e3*ag(1e3)},"cubic-inches":{inBaseUnits:1e3*ag(.0254)},"cubic-feet":{inBaseUnits:1e3*ag(.3048)},"cubic-yards":{inBaseUnits:1e3*ag(.9144)},"cubic-miles":{inBaseUnits:1e3*ag(1609.344)}}},angle:{baseUnit:"radians",units:{radians:{inBaseUnits:1},degrees:{inBaseUnits:Math.PI/180}}}},DRe=function(){const e={};for(const t in qC)for(const i in qC[t].units)e[i]=t;return e}();function LRe(e,t,i){return e*qC[i].units[t].inBaseUnits}function NRe(e,t,i){return e/qC[i].units[t].inBaseUnits}function XB(e){const t=DRe[e];if(t)return t;throw new Error("unknown type")}function pZ(e,t=null){return t=t||XB(e),qC[t].baseUnit===e}function _s(e,t,i){if(t===i)return e;const r=XB(t);if(r!==XB(i))throw new Error("incompatible units");const s=pZ(t,r)?e:LRe(e,t,r);return pZ(i,r)?s:NRe(s,i,r)}function FRe(e,t){return _s(e,t,"meters")<3e3?"meters":"kilometers"}function URe(e,t){return _s(e,t,"meters")<1e5?"meters":"kilometers"}function kRe(e,t){return _s(e,t,"feet")<1e3?"feet":"miles"}function zRe(e,t){return _s(e,t,"feet")<1e5?"feet":"miles"}function Cmt(e,t){return _s(e,t,"square-meters")<3e6?"square-meters":"square-kilometers"}function Rmt(e,t){return _s(e,t,"square-feet")<1e6?"square-feet":"square-miles"}function BRe(e,t,i){return _s(e,t,"meters")/(i*Math.PI/180)}function Nce(e){return $Re.fromJSON(e.toLowerCase())||null}function BT(e){if(e&&typeof e=="object"&&!OT(e))return 1;const t=Cl(e);return t>1e5?1:t}function VRe(e){return Cl(e)>=(e instanceof He?di(e).metersPerDegree:1e5)?"meters":Uce(e)}function Cl(e,t=ai.metersPerDegree){return GRe(e,!0)||t}function GRe(e,t=!1){let i,r,s=null;if(e!=null&&(typeof e=="object"?(i=e.wkid,r=e.wkt):typeof e=="number"?i=e:typeof e=="string"&&(r=e)),i){if(M7(i))return pp.metersPerDegree;if(P7(i))return Am.metersPerDegree;s=o1.values[o1[i]],!s&&t&&IRe.has(i)&&(s=PRe)}else r&&(zce(r)?s=fZ(Dce.exec(r),s):kce(r)&&(s=fZ(Lce.exec(r),s)));return s}function fZ(e,t){return e&&e[1]?Fce(e[1]):t}function Fce(e){return parseFloat(e.split(",")[1])}function Uce(e){let t,i,r=null;if(e!=null&&(typeof e=="object"?(t=e.wkid,i=e.wkt):typeof e=="number"?t=e:typeof e=="string"&&(i=e)),t)r=o1.units[o1[t]];else if(i){const s=zce(i)?Dce:kce(i)?Lce:null;if(s){const n=s.exec(i);n&&n[1]&&(r=HRe(n[1]))}}return _(r)?Nce(r):null}function kce(e){return/^GEOCCS/i.test(e)}function zce(e){return/^PROJCS/i.test(e)}const jRe=1e-7;function HRe(e){const t=/[\\"\\']{1}([^\\"\\']+)/.exec(e);let i=t&&t[1];if(!i||o1.units.indexOf(i)===-1){const r=Fce(e);i=null;const s=o1.values;for(let n=0;n<s.length;++n)if(Math.abs(r-s[n])<jRe){i=o1.units[n];break}}return i}function Omt(e){if(!e)return null;switch(Uce(e)){case"feet":case"us-feet":case"clarke-feet":case"clarke-yards":case"clarke-links":case"sears-yards":case"sears-feet":case"sears-chains":case"benoit-1895-b-chains":case"indian-yards":case"indian-1937-yards":case"gold-coast-feet":case"sears-1922-truncated-chains":return"imperial";case"50-kilometers":case"150-kilometers":case"meters":return"metric";case null:case void 0:return null}return null}const Bce={esriAcres:"acres",esriAres:"ares",esriHectares:"hectares",esriSquareCentimeters:"square-centimeters",esriSquareDecimeters:"square-decimeters",esriSquareFeet:"square-feet",esriSquareInches:"square-inches",esriSquareKilometers:"square-kilometers",esriSquareMeters:"square-meters",esriSquareMiles:"square-miles",esriSquareMillimeters:"square-millimeters",esriSquareUsFeet:"square-us-feet",esriSquareYards:"square-yards"},Vce={esriCentimeters:"centimeters",esriDecimeters:"decimeters",esriFeet:"feet",esriInches:"inches",esriKilometers:"kilometers",esriMeters:"meters",esriMiles:"miles",esriMillimeters:"millimeters",esriNauticalMiles:"nautical-miles",esriYards:"yards"},qRe=_o()(Bce),WRe=_o()(Vce);_o()(I(I({},Bce),Vce));var qE;const ID=_o()({orthometric:"gravity-related-height",gravity_related_height:"gravity-related-height",ellipsoidal:"ellipsoidal"}),Gce=ID.jsonValues.slice();SN(Gce,"orthometric");const ZA=_o()({meter:"meters",foot:"feet","us-foot":"us-feet","clarke-foot":"clarke-feet","clarke-yard":"clarke-yards","clarke-link":"clarke-links","sears-yard":"sears-yards","sears-foot":"sears-feet","sears-chain":"sears-chains","benoit-1895-b-chain":"benoit-1895-b-chains","indian-yard":"indian-yards","indian-1937-yard":"indian-1937-yards","gold-coast-foot":"gold-coast-feet","sears-1922-truncated-chain":"sears-1922-truncated-chains","50-kilometers":"50-kilometers","150-kilometers":"150-kilometers"});let ah=qE=class extends fe{constructor(e){super(e),this.heightModel="gravity-related-height",this.heightUnit="meters",this.vertCRS=null}writeHeightModel(e,t,i){return ID.write(e,t,i)}readHeightModel(e,t,i){return ID.read(e)||(i&&i.messages&&i.messages.push(XRe(e,{context:i})),null)}readHeightUnit(e,t,i){return ZA.read(e)||(i&&i.messages&&i.messages.push(mZ(e,{context:i})),null)}readHeightUnitService(e,t,i){return Nce(e)||ZA.read(e)||(i&&i.messages&&i.messages.push(mZ(e,{context:i})),null)}readVertCRS(e,t){return t.vertCRS||t.ellipsoid||t.geoid}clone(){return new qE({heightModel:this.heightModel,heightUnit:this.heightUnit,vertCRS:this.vertCRS})}equals(e){return!!e&&(this===e||this.heightModel===e.heightModel&&this.heightUnit===e.heightUnit&&this.vertCRS===e.vertCRS)}static deriveUnitFromSR(e,t){const i=VRe(t);return new qE({heightModel:e.heightModel,heightUnit:i,vertCRS:e.vertCRS})}write(e,t){return t=I({origin:"web-scene"},t),super.write(e,t)}static fromJSON(e){if(!e)return null;const t=new qE;return t.read(e,{origin:"web-scene"}),t}};function mZ(e,t){return new vc("height-unit:unsupported",`Height unit of value '${e}' is not supported`,t)}function XRe(e,t){return new vc("height-model:unsupported",`Height model of value '${e}' is not supported`,t)}u([d({type:ID.apiValues,constructOnly:!0,json:{origins:{"web-scene":{type:Gce,default:"ellipsoidal"}}}})],ah.prototype,"heightModel",void 0),u([Fe("web-scene","heightModel")],ah.prototype,"writeHeightModel",null),u([De(["web-scene","service"],"heightModel")],ah.prototype,"readHeightModel",null),u([d({type:ZA.apiValues,constructOnly:!0,json:{origins:{"web-scene":{type:ZA.jsonValues,write:ZA.write}}}})],ah.prototype,"heightUnit",void 0),u([De("web-scene","heightUnit")],ah.prototype,"readHeightUnit",null),u([De("service","heightUnit")],ah.prototype,"readHeightUnitService",null),u([d({type:String,constructOnly:!0,json:{origins:{"web-scene":{write:!0}}}})],ah.prototype,"vertCRS",void 0),u([De("service","vertCRS",["vertCRS","ellipsoid","geoid"])],ah.prototype,"readVertCRS",null),ah=qE=u([P("esri.geometry.HeightModelInfo")],ah);const U0=ah;function Ur(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function kp(e,t,i,r,s,n,o,a,l,c,h,p,f,g,y,v,b){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e[4]=n,e[5]=o,e[6]=a,e[7]=l,e[8]=c,e[9]=h,e[10]=p,e[11]=f,e[12]=g,e[13]=y,e[14]=v,e[15]=b,e}function Ap(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Oa(e,t){if(e===t){const i=t[1],r=t[2],s=t[3],n=t[6],o=t[7],a=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=i,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=n,e[11]=t[14],e[12]=s,e[13]=o,e[14]=a}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function fr(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=t[9],f=t[10],g=t[11],y=t[12],v=t[13],b=t[14],w=t[15],S=i*a-r*o,T=i*l-s*o,A=i*c-n*o,C=r*l-s*a,O=r*c-n*a,L=s*c-n*l,U=h*v-p*y,N=h*b-f*y,z=h*w-g*y,V=p*b-f*v,B=p*w-g*v,J=f*w-g*b;let Q=S*J-T*B+A*V+C*z-O*N+L*U;return Q?(Q=1/Q,e[0]=(a*J-l*B+c*V)*Q,e[1]=(s*B-r*J-n*V)*Q,e[2]=(v*L-b*O+w*C)*Q,e[3]=(f*O-p*L-g*C)*Q,e[4]=(l*z-o*J-c*N)*Q,e[5]=(i*J-s*z+n*N)*Q,e[6]=(b*A-y*L-w*T)*Q,e[7]=(h*L-f*A+g*T)*Q,e[8]=(o*B-a*z+c*U)*Q,e[9]=(r*z-i*B-n*U)*Q,e[10]=(y*O-v*A+w*S)*Q,e[11]=(p*A-h*O-g*S)*Q,e[12]=(a*N-o*V-l*U)*Q,e[13]=(i*V-r*N+s*U)*Q,e[14]=(v*T-y*C-b*S)*Q,e[15]=(h*C-p*T+f*S)*Q,e):null}function YRe(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=t[9],f=t[10],g=t[11],y=t[12],v=t[13],b=t[14],w=t[15];return e[0]=a*(f*w-g*b)-p*(l*w-c*b)+v*(l*g-c*f),e[1]=-(r*(f*w-g*b)-p*(s*w-n*b)+v*(s*g-n*f)),e[2]=r*(l*w-c*b)-a*(s*w-n*b)+v*(s*c-n*l),e[3]=-(r*(l*g-c*f)-a*(s*g-n*f)+p*(s*c-n*l)),e[4]=-(o*(f*w-g*b)-h*(l*w-c*b)+y*(l*g-c*f)),e[5]=i*(f*w-g*b)-h*(s*w-n*b)+y*(s*g-n*f),e[6]=-(i*(l*w-c*b)-o*(s*w-n*b)+y*(s*c-n*l)),e[7]=i*(l*g-c*f)-o*(s*g-n*f)+h*(s*c-n*l),e[8]=o*(p*w-g*v)-h*(a*w-c*v)+y*(a*g-c*p),e[9]=-(i*(p*w-g*v)-h*(r*w-n*v)+y*(r*g-n*p)),e[10]=i*(a*w-c*v)-o*(r*w-n*v)+y*(r*c-n*a),e[11]=-(i*(a*g-c*p)-o*(r*g-n*p)+h*(r*c-n*a)),e[12]=-(o*(p*b-f*v)-h*(a*b-l*v)+y*(a*f-l*p)),e[13]=i*(p*b-f*v)-h*(r*b-s*v)+y*(r*f-s*p),e[14]=-(i*(a*b-l*v)-o*(r*b-s*v)+y*(r*l-s*a)),e[15]=i*(a*f-l*p)-o*(r*f-s*p)+h*(r*l-s*a),e}function ZRe(e){const t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],o=e[5],a=e[6],l=e[7],c=e[8],h=e[9],p=e[10],f=e[11],g=e[12],y=e[13],v=e[14],b=e[15];return(t*o-i*n)*(p*b-f*v)-(t*a-r*n)*(h*b-f*y)+(t*l-s*n)*(h*v-p*y)+(i*a-r*o)*(c*b-f*g)-(i*l-s*o)*(c*v-p*g)+(r*l-s*a)*(c*y-h*g)}function dr(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=t[8],f=t[9],g=t[10],y=t[11],v=t[12],b=t[13],w=t[14],S=t[15];let T=i[0],A=i[1],C=i[2],O=i[3];return e[0]=T*r+A*a+C*p+O*v,e[1]=T*s+A*l+C*f+O*b,e[2]=T*n+A*c+C*g+O*w,e[3]=T*o+A*h+C*y+O*S,T=i[4],A=i[5],C=i[6],O=i[7],e[4]=T*r+A*a+C*p+O*v,e[5]=T*s+A*l+C*f+O*b,e[6]=T*n+A*c+C*g+O*w,e[7]=T*o+A*h+C*y+O*S,T=i[8],A=i[9],C=i[10],O=i[11],e[8]=T*r+A*a+C*p+O*v,e[9]=T*s+A*l+C*f+O*b,e[10]=T*n+A*c+C*g+O*w,e[11]=T*o+A*h+C*y+O*S,T=i[12],A=i[13],C=i[14],O=i[15],e[12]=T*r+A*a+C*p+O*v,e[13]=T*s+A*l+C*f+O*b,e[14]=T*n+A*c+C*g+O*w,e[15]=T*o+A*h+C*y+O*S,e}function Wo(e,t,i){const r=i[0],s=i[1],n=i[2];let o,a,l,c,h,p,f,g,y,v,b,w;return t===e?(e[12]=t[0]*r+t[4]*s+t[8]*n+t[12],e[13]=t[1]*r+t[5]*s+t[9]*n+t[13],e[14]=t[2]*r+t[6]*s+t[10]*n+t[14],e[15]=t[3]*r+t[7]*s+t[11]*n+t[15]):(o=t[0],a=t[1],l=t[2],c=t[3],h=t[4],p=t[5],f=t[6],g=t[7],y=t[8],v=t[9],b=t[10],w=t[11],e[0]=o,e[1]=a,e[2]=l,e[3]=c,e[4]=h,e[5]=p,e[6]=f,e[7]=g,e[8]=y,e[9]=v,e[10]=b,e[11]=w,e[12]=o*r+h*s+y*n+t[12],e[13]=a*r+p*s+v*n+t[13],e[14]=l*r+f*s+b*n+t[14],e[15]=c*r+g*s+w*n+t[15]),e}function tF(e,t,i){const r=i[0],s=i[1],n=i[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function cl(e,t,i,r){let s,n,o,a,l,c,h,p,f,g,y,v,b,w,S,T,A,C,O,L,U,N,z,V,B=r[0],J=r[1],Q=r[2],te=Math.sqrt(B*B+J*J+Q*Q);return te<wt?null:(te=1/te,B*=te,J*=te,Q*=te,s=Math.sin(i),n=Math.cos(i),o=1-n,a=t[0],l=t[1],c=t[2],h=t[3],p=t[4],f=t[5],g=t[6],y=t[7],v=t[8],b=t[9],w=t[10],S=t[11],T=B*B*o+n,A=J*B*o+Q*s,C=Q*B*o-J*s,O=B*J*o-Q*s,L=J*J*o+n,U=Q*J*o+B*s,N=B*Q*o+J*s,z=J*Q*o-B*s,V=Q*Q*o+n,e[0]=a*T+p*A+v*C,e[1]=l*T+f*A+b*C,e[2]=c*T+g*A+w*C,e[3]=h*T+y*A+S*C,e[4]=a*O+p*L+v*U,e[5]=l*O+f*L+b*U,e[6]=c*O+g*L+w*U,e[7]=h*O+y*L+S*U,e[8]=a*N+p*z+v*V,e[9]=l*N+f*z+b*V,e[10]=c*N+g*z+w*V,e[11]=h*N+y*z+S*V,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}function VT(e,t,i){const r=Math.sin(i),s=Math.cos(i),n=t[4],o=t[5],a=t[6],l=t[7],c=t[8],h=t[9],p=t[10],f=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=n*s+c*r,e[5]=o*s+h*r,e[6]=a*s+p*r,e[7]=l*s+f*r,e[8]=c*s-n*r,e[9]=h*s-o*r,e[10]=p*s-a*r,e[11]=f*s-l*r,e}function iF(e,t,i){const r=Math.sin(i),s=Math.cos(i),n=t[0],o=t[1],a=t[2],l=t[3],c=t[8],h=t[9],p=t[10],f=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*s-c*r,e[1]=o*s-h*r,e[2]=a*s-p*r,e[3]=l*s-f*r,e[8]=n*r+c*s,e[9]=o*r+h*s,e[10]=a*r+p*s,e[11]=l*r+f*s,e}function GT(e,t,i){const r=Math.sin(i),s=Math.cos(i),n=t[0],o=t[1],a=t[2],l=t[3],c=t[4],h=t[5],p=t[6],f=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*s+c*r,e[1]=o*s+h*r,e[2]=a*s+p*r,e[3]=l*s+f*r,e[4]=c*s-n*r,e[5]=h*s-o*r,e[6]=p*s-a*r,e[7]=f*s-l*r,e}function rF(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function QRe(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Tl(e,t,i){let r,s,n,o=i[0],a=i[1],l=i[2],c=Math.sqrt(o*o+a*a+l*l);return c<wt?null:(c=1/c,o*=c,a*=c,l*=c,r=Math.sin(t),s=Math.cos(t),n=1-s,e[0]=o*o*n+s,e[1]=a*o*n+l*r,e[2]=l*o*n-a*r,e[3]=0,e[4]=o*a*n-l*r,e[5]=a*a*n+s,e[6]=l*a*n+o*r,e[7]=0,e[8]=o*l*n+a*r,e[9]=a*l*n-o*r,e[10]=l*l*n+s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function jce(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=i,e[7]=0,e[8]=0,e[9]=-i,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function JRe(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=0,e[2]=-i,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=i,e[9]=0,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Hce(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=0,e[3]=0,e[4]=-i,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function qce(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=r+r,l=s+s,c=n+n,h=r*a,p=r*l,f=r*c,g=s*l,y=s*c,v=n*c,b=o*a,w=o*l,S=o*c;return e[0]=1-(g+v),e[1]=p+S,e[2]=f-w,e[3]=0,e[4]=p-S,e[5]=1-(h+v),e[6]=y+b,e[7]=0,e[8]=f+w,e[9]=y-b,e[10]=1-(h+g),e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}function KRe(e,t){const i=eOe,r=-t[0],s=-t[1],n=-t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=r*r+s*s+n*n+o*o;return p>0?(i[0]=2*(a*o+h*r+l*n-c*s)/p,i[1]=2*(l*o+h*s+c*r-a*n)/p,i[2]=2*(c*o+h*n+a*s-l*r)/p):(i[0]=2*(a*o+h*r+l*n-c*s),i[1]=2*(l*o+h*s+c*r-a*n),i[2]=2*(c*o+h*n+a*s-l*r)),qce(e,t,i),e}const eOe=M();function tOe(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function iOe(e,t){const i=t[0],r=t[1],s=t[2],n=t[4],o=t[5],a=t[6],l=t[8],c=t[9],h=t[10];return e[0]=Math.sqrt(i*i+r*r+s*s),e[1]=Math.sqrt(n*n+o*o+a*a),e[2]=Math.sqrt(l*l+c*c+h*h),e}function rOe(e,t){const i=t[0]+t[5]+t[10];let r=0;return i>0?(r=2*Math.sqrt(i+1),e[3]=.25*r,e[0]=(t[6]-t[9])/r,e[1]=(t[8]-t[2])/r,e[2]=(t[1]-t[4])/r):t[0]>t[5]&&t[0]>t[10]?(r=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/r,e[0]=.25*r,e[1]=(t[1]+t[4])/r,e[2]=(t[8]+t[2])/r):t[5]>t[10]?(r=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/r,e[0]=(t[1]+t[4])/r,e[1]=.25*r,e[2]=(t[6]+t[9])/r):(r=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/r,e[0]=(t[8]+t[2])/r,e[1]=(t[6]+t[9])/r,e[2]=.25*r),e}function sOe(e,t,i,r){const s=t[0],n=t[1],o=t[2],a=t[3],l=s+s,c=n+n,h=o+o,p=s*l,f=s*c,g=s*h,y=n*c,v=n*h,b=o*h,w=a*l,S=a*c,T=a*h,A=r[0],C=r[1],O=r[2];return e[0]=(1-(y+b))*A,e[1]=(f+T)*A,e[2]=(g-S)*A,e[3]=0,e[4]=(f-T)*C,e[5]=(1-(p+b))*C,e[6]=(v+w)*C,e[7]=0,e[8]=(g+S)*O,e[9]=(v-w)*O,e[10]=(1-(p+y))*O,e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}function nOe(e,t,i,r,s){const n=t[0],o=t[1],a=t[2],l=t[3],c=n+n,h=o+o,p=a+a,f=n*c,g=n*h,y=n*p,v=o*h,b=o*p,w=a*p,S=l*c,T=l*h,A=l*p,C=r[0],O=r[1],L=r[2],U=s[0],N=s[1],z=s[2],V=(1-(v+w))*C,B=(g+A)*C,J=(y-T)*C,Q=(g-A)*O,te=(1-(f+w))*O,ie=(b+S)*O,$=(y+T)*L,F=(b-S)*L,k=(1-(f+v))*L;return e[0]=V,e[1]=B,e[2]=J,e[3]=0,e[4]=Q,e[5]=te,e[6]=ie,e[7]=0,e[8]=$,e[9]=F,e[10]=k,e[11]=0,e[12]=i[0]+U-(V*U+Q*N+$*z),e[13]=i[1]+N-(B*U+te*N+F*z),e[14]=i[2]+z-(J*U+ie*N+k*z),e[15]=1,e}function oOe(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=i+i,a=r+r,l=s+s,c=i*o,h=r*o,p=r*a,f=s*o,g=s*a,y=s*l,v=n*o,b=n*a,w=n*l;return e[0]=1-p-y,e[1]=h+w,e[2]=f-b,e[3]=0,e[4]=h-w,e[5]=1-c-y,e[6]=g+v,e[7]=0,e[8]=f+b,e[9]=g-v,e[10]=1-c-p,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Wce(e,t,i,r,s,n,o){const a=1/(i-t),l=1/(s-r),c=1/(n-o);return e[0]=2*n*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*n*l,e[6]=0,e[7]=0,e[8]=(i+t)*a,e[9]=(s+r)*l,e[10]=(o+n)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*n*2*c,e[15]=0,e}function aOe(e,t,i,r,s){const n=1/Math.tan(t/2);let o;return e[0]=n/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,s!=null&&s!==1/0?(o=1/(r-s),e[10]=(s+r)*o,e[14]=2*s*r*o):(e[10]=-1,e[14]=-2*r),e}function lOe(e,t,i,r){const s=Math.tan(t.upDegrees*Math.PI/180),n=Math.tan(t.downDegrees*Math.PI/180),o=Math.tan(t.leftDegrees*Math.PI/180),a=Math.tan(t.rightDegrees*Math.PI/180),l=2/(o+a),c=2/(s+n);return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=-(o-a)*l*.5,e[9]=(s-n)*c*.5,e[10]=r/(i-r),e[11]=-1,e[12]=0,e[13]=0,e[14]=r*i/(i-r),e[15]=0,e}function Cj(e,t,i,r,s,n,o){const a=1/(t-i),l=1/(r-s),c=1/(n-o);return e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+i)*a,e[13]=(s+r)*l,e[14]=(o+n)*c,e[15]=1,e}function sF(e,t,i,r){let s,n,o,a,l,c,h,p,f,g;const y=t[0],v=t[1],b=t[2],w=r[0],S=r[1],T=r[2],A=i[0],C=i[1],O=i[2];return Math.abs(y-A)<wt&&Math.abs(v-C)<wt&&Math.abs(b-O)<wt?Ap(e):(h=y-A,p=v-C,f=b-O,g=1/Math.sqrt(h*h+p*p+f*f),h*=g,p*=g,f*=g,s=S*f-T*p,n=T*h-w*f,o=w*p-S*h,g=Math.sqrt(s*s+n*n+o*o),g?(g=1/g,s*=g,n*=g,o*=g):(s=0,n=0,o=0),a=p*o-f*n,l=f*s-h*o,c=h*n-p*s,g=Math.sqrt(a*a+l*l+c*c),g?(g=1/g,a*=g,l*=g,c*=g):(a=0,l=0,c=0),e[0]=s,e[1]=a,e[2]=h,e[3]=0,e[4]=n,e[5]=l,e[6]=p,e[7]=0,e[8]=o,e[9]=c,e[10]=f,e[11]=0,e[12]=-(s*y+n*v+o*b),e[13]=-(a*y+l*v+c*b),e[14]=-(h*y+p*v+f*b),e[15]=1,e)}function Xce(e,t,i,r){const s=t[0],n=t[1],o=t[2],a=r[0],l=r[1],c=r[2];let h=s-i[0],p=n-i[1],f=o-i[2],g=h*h+p*p+f*f;g>0&&(g=1/Math.sqrt(g),h*=g,p*=g,f*=g);let y=l*f-c*p,v=c*h-a*f,b=a*p-l*h;return g=y*y+v*v+b*b,g>0&&(g=1/Math.sqrt(g),y*=g,v*=g,b*=g),e[0]=y,e[1]=v,e[2]=b,e[3]=0,e[4]=p*b-f*v,e[5]=f*y-h*b,e[6]=h*v-p*y,e[7]=0,e[8]=h,e[9]=p,e[10]=f,e[11]=0,e[12]=s,e[13]=n,e[14]=o,e[15]=1,e}function cOe(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"}function uOe(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2+e[4]**2+e[5]**2+e[6]**2+e[7]**2+e[8]**2+e[9]**2+e[10]**2+e[11]**2+e[12]**2+e[13]**2+e[14]**2+e[15]**2)}function hOe(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e[6]=t[6]+i[6],e[7]=t[7]+i[7],e[8]=t[8]+i[8],e[9]=t[9]+i[9],e[10]=t[10]+i[10],e[11]=t[11]+i[11],e[12]=t[12]+i[12],e[13]=t[13]+i[13],e[14]=t[14]+i[14],e[15]=t[15]+i[15],e}function Yce(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e[6]=t[6]-i[6],e[7]=t[7]-i[7],e[8]=t[8]-i[8],e[9]=t[9]-i[9],e[10]=t[10]-i[10],e[11]=t[11]-i[11],e[12]=t[12]-i[12],e[13]=t[13]-i[13],e[14]=t[14]-i[14],e[15]=t[15]-i[15],e}function dOe(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*i,e[9]=t[9]*i,e[10]=t[10]*i,e[11]=t[11]*i,e[12]=t[12]*i,e[13]=t[13]*i,e[14]=t[14]*i,e[15]=t[15]*i,e}function pOe(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e[4]=t[4]+i[4]*r,e[5]=t[5]+i[5]*r,e[6]=t[6]+i[6]*r,e[7]=t[7]+i[7]*r,e[8]=t[8]+i[8]*r,e[9]=t[9]+i[9]*r,e[10]=t[10]+i[10]*r,e[11]=t[11]+i[11]*r,e[12]=t[12]+i[12]*r,e[13]=t[13]+i[13]*r,e[14]=t[14]+i[14]*r,e[15]=t[15]+i[15]*r,e}function fOe(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]}function YB(e,t){if(e===t)return!0;const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],g=e[11],y=e[12],v=e[13],b=e[14],w=e[15],S=t[0],T=t[1],A=t[2],C=t[3],O=t[4],L=t[5],U=t[6],N=t[7],z=t[8],V=t[9],B=t[10],J=t[11],Q=t[12],te=t[13],ie=t[14],$=t[15];return Math.abs(i-S)<=wt*Math.max(1,Math.abs(i),Math.abs(S))&&Math.abs(r-T)<=wt*Math.max(1,Math.abs(r),Math.abs(T))&&Math.abs(s-A)<=wt*Math.max(1,Math.abs(s),Math.abs(A))&&Math.abs(n-C)<=wt*Math.max(1,Math.abs(n),Math.abs(C))&&Math.abs(o-O)<=wt*Math.max(1,Math.abs(o),Math.abs(O))&&Math.abs(a-L)<=wt*Math.max(1,Math.abs(a),Math.abs(L))&&Math.abs(l-U)<=wt*Math.max(1,Math.abs(l),Math.abs(U))&&Math.abs(c-N)<=wt*Math.max(1,Math.abs(c),Math.abs(N))&&Math.abs(h-z)<=wt*Math.max(1,Math.abs(h),Math.abs(z))&&Math.abs(p-V)<=wt*Math.max(1,Math.abs(p),Math.abs(V))&&Math.abs(f-B)<=wt*Math.max(1,Math.abs(f),Math.abs(B))&&Math.abs(g-J)<=wt*Math.max(1,Math.abs(g),Math.abs(J))&&Math.abs(y-Q)<=wt*Math.max(1,Math.abs(y),Math.abs(Q))&&Math.abs(v-te)<=wt*Math.max(1,Math.abs(v),Math.abs(te))&&Math.abs(b-ie)<=wt*Math.max(1,Math.abs(b),Math.abs(ie))&&Math.abs(w-$)<=wt*Math.max(1,Math.abs(w),Math.abs($))}function Rj(e){const t=wt,i=e[0],r=e[1],s=e[2],n=e[4],o=e[5],a=e[6],l=e[8],c=e[9],h=e[10];return Math.abs(1-(i*i+n*n+l*l))<=t&&Math.abs(1-(r*r+o*o+c*c))<=t&&Math.abs(1-(s*s+a*a+h*h))<=t}const mOe=dr,gOe=Yce;Object.freeze({__proto__:null,copy:Ur,set:kp,identity:Ap,transpose:Oa,invert:fr,adjoint:YRe,determinant:ZRe,multiply:dr,translate:Wo,scale:tF,rotate:cl,rotateX:VT,rotateY:iF,rotateZ:GT,fromTranslation:rF,fromScaling:QRe,fromRotation:Tl,fromXRotation:jce,fromYRotation:JRe,fromZRotation:Hce,fromRotationTranslation:qce,fromQuat2:KRe,getTranslation:tOe,getScaling:iOe,getRotation:rOe,fromRotationTranslationScale:sOe,fromRotationTranslationScaleOrigin:nOe,fromQuat:oOe,frustum:Wce,perspective:aOe,perspectiveFromFieldOfView:lOe,ortho:Cj,lookAt:sF,targetTo:Xce,str:cOe,frob:uOe,add:hOe,subtract:Yce,multiplyScalar:dOe,multiplyScalarAndAdd:pOe,exactEquals:fOe,equals:YB,isOrthoNormal:Rj,mul:mOe,sub:gOe});let $5,re=null;function Zce(){return!!re}function yOe(){return!!ue("esri-wasm")}function Qce(){return $5||($5=import("./pe-wasm.1d1b20e7.js").then(e=>e.p).then(({default:e})=>e({locateFile:t=>ui(`esri/geometry/support/${t}`)})).then(e=>{Kce(e)}),$5)}var ZB,Lr,QB;(function(e){function t(n,o,a){re.ensureCache.prepare();const l=M_(a),c=a===l,h=re.ensureFloat64(l),p=re._pe_geog_to_proj(re.getPointer(n),o,h);return p&&Oy(a,o,h,c),p}function i(n,o,a,l){switch(l){case Lr.PE_TRANSFORM_P_TO_G:return r(n,o,a);case Lr.PE_TRANSFORM_G_TO_P:return t(n,o,a)}return 0}function r(n,o,a){return s(n,o,a,0)}function s(n,o,a,l){re.ensureCache.prepare();const c=M_(a),h=a===c,p=re.ensureFloat64(c),f=re._pe_proj_to_geog_center(re.getPointer(n),o,p,l);return f&&Oy(a,o,p,h),f}e.geogToProj=t,e.projGeog=i,e.projToGeog=r,e.projToGeogCenter=s})(ZB||(ZB={})),function(e){function t(){e.PE_BUFFER_MAX=re.PeDefs.prototype.PE_BUFFER_MAX,e.PE_NAME_MAX=re.PeDefs.prototype.PE_NAME_MAX,e.PE_MGRS_MAX=re.PeDefs.prototype.PE_MGRS_MAX,e.PE_USNG_MAX=re.PeDefs.prototype.PE_USNG_MAX,e.PE_DD_MAX=re.PeDefs.prototype.PE_DD_MAX,e.PE_DDM_MAX=re.PeDefs.prototype.PE_DDM_MAX,e.PE_DMS_MAX=re.PeDefs.prototype.PE_DMS_MAX,e.PE_UTM_MAX=re.PeDefs.prototype.PE_UTM_MAX,e.PE_PARM_MAX=re.PeDefs.prototype.PE_PARM_MAX,e.PE_TYPE_NONE=re.PeDefs.prototype.PE_TYPE_NONE,e.PE_TYPE_GEOGCS=re.PeDefs.prototype.PE_TYPE_GEOGCS,e.PE_TYPE_PROJCS=re.PeDefs.prototype.PE_TYPE_PROJCS,e.PE_TYPE_GEOGTRAN=re.PeDefs.prototype.PE_TYPE_GEOGTRAN,e.PE_TYPE_COORDSYS=re.PeDefs.prototype.PE_TYPE_COORDSYS,e.PE_TYPE_UNIT=re.PeDefs.prototype.PE_TYPE_UNIT,e.PE_TYPE_LINUNIT=re.PeDefs.prototype.PE_TYPE_LINUNIT,e.PE_STR_OPTS_NONE=re.PeDefs.prototype.PE_STR_OPTS_NONE,e.PE_STR_AUTH_NONE=re.PeDefs.prototype.PE_STR_AUTH_NONE,e.PE_STR_AUTH_TOP=re.PeDefs.prototype.PE_STR_AUTH_TOP,e.PE_STR_NAME_CANON=re.PeDefs.prototype.PE_STR_NAME_CANON,e.PE_PARM_X0=re.PeDefs.prototype.PE_PARM_X0,e.PE_PARM_ND=re.PeDefs.prototype.PE_PARM_ND,e.PE_TRANSFORM_1_TO_2=re.PeDefs.prototype.PE_TRANSFORM_1_TO_2,e.PE_TRANSFORM_2_TO_1=re.PeDefs.prototype.PE_TRANSFORM_2_TO_1,e.PE_TRANSFORM_P_TO_G=re.PeDefs.prototype.PE_TRANSFORM_P_TO_G,e.PE_TRANSFORM_G_TO_P=re.PeDefs.prototype.PE_TRANSFORM_G_TO_P,e.PE_HORIZON_RECT=re.PeDefs.prototype.PE_HORIZON_RECT,e.PE_HORIZON_POLY=re.PeDefs.prototype.PE_HORIZON_POLY,e.PE_HORIZON_LINE=re.PeDefs.prototype.PE_HORIZON_LINE,e.PE_HORIZON_DELTA=re.PeDefs.prototype.PE_HORIZON_DELTA}e.init=t}(Lr||(Lr={})),function(e){const t={},i={},r=g=>{if(g){const y=g.getType();switch(y){case Lr.PE_TYPE_GEOGCS:g=re.castObject(g,re.PeGeogcs);break;case Lr.PE_TYPE_PROJCS:g=re.castObject(g,re.PeProjcs);break;case Lr.PE_TYPE_GEOGTRAN:g=re.castObject(g,re.PeGeogtran);break;default:y&Lr.PE_TYPE_UNIT&&(g=re.castObject(g,re.PeUnit))}}return g};function s(){re.PeFactory.prototype.initialize(null)}function n(g){return o(Lr.PE_TYPE_COORDSYS,g)}function o(g,y){let v=null,b=t[g];if(b||(b={},t[g]=b),b.hasOwnProperty(String(y)))v=b[y];else{const w=re.PeFactory.prototype.factoryByType(g,y);re.compare(w,re.NULL)||(v=w,b[y]=v)}return v=r(v),v}function a(g,y){let v=null,b=i[g];if(b||(b={},i[g]=b),b.hasOwnProperty(y))v=b[y];else{const w=re.PeFactory.prototype.fromString(g,y);re.compare(w,re.NULL)||(v=w,b[y]=v)}return v=r(v),v}function l(g){return o(Lr.PE_TYPE_GEOGCS,g)}function c(g){return o(Lr.PE_TYPE_GEOGTRAN,g)}function h(g){return re.PeFactory.prototype.getCode(g)}function p(g){return o(Lr.PE_TYPE_PROJCS,g)}function f(g){return o(Lr.PE_TYPE_UNIT,g)}e.initialize=s,e.coordsys=n,e.factoryByType=o,e.fromString=a,e.geogcs=l,e.geogtran=c,e.getCode=h,e.projcs=p,e.unit=f}(QB||(QB={}));let Jce=null;var $D,JB,KB,eV,DD,tV,LD,ND,iV;function Kce(e){function t(n,o,a){n[o]=a(n[o])}re=e,Lr.init(),$D.init(),DD.init(),LD.init(),ND.init(),Jce=class extends re.PeGCSExtent{destroy(){re.destroy(this)}};const i=[re.PeDatum,re.PeGeogcs,re.PeGeogtran,re.PeObject,re.PeParameter,re.PePrimem,re.PeProjcs,re.PeSpheroid,re.PeUnit];for(const n of i)t(n.prototype,"getName",o=>function(){return o.call(this,new Array(Lr.PE_NAME_MAX))});for(const n of[re.PeGeogtran,re.PeProjcs])t(n.prototype,"getParameters",o=>function(){const a=new Array(Lr.PE_PARM_MAX);let l=o.call(this);for(let c=0;c<a.length;c++){const h=re.getValue(l,"*");a[c]=h?re.wrapPointer(h,re.PeParameter):null,l+=Int32Array.BYTES_PER_ELEMENT}return a});t(re.PeHorizon.prototype,"getCoord",n=>function(){const o=this.getSize();if(!o)return null;const a=[];return Oy(a,o,n.call(this)),a}),t(re.PeGTlistExtendedEntry.prototype,"getEntries",n=>{const o=re._pe_getPeGTlistExtendedGTsSize();return function(){let a=null;const l=n.call(this);if(!re.compare(l,re.NULL)){a=[l];const c=this.getSteps();if(c>1){const h=re.getPointer(l);for(let p=1;p<c;p++)a.push(re.wrapPointer(h+o*p,re.PeGTlistExtendedGTs))}}return a}});const r=re._pe_getPeHorizonSize(),s=n=>function(){let o=this._cache;if(o||(o=new Map,this._cache=o),o.has(n))return o.get(n);let a=null;const l=n.call(this);if(!re.compare(l,re.NULL)){a=[l];const c=l.getNump();if(c>1){const h=re.getPointer(l);for(let p=1;p<c;p++)a.push(re.wrapPointer(h+r*p,re.PeHorizon))}}return o.set(n,a),a};t(re.PeProjcs.prototype,"horizonGcsGenerate",s),t(re.PeProjcs.prototype,"horizonPcsGenerate",s),re.PeObject.prototype.toString=function(n=Lr.PE_STR_OPTS_NONE){re.ensureCache.prepare();const o=re.getPointer(this),a=re.ensureInt8(new Array(Lr.PE_BUFFER_MAX));return re.UTF8ToString(re._pe_object_to_string_ext(o,n,a))}}function Yp(e){if(!e)return;const t=re.getClass(e);if(!t)return;const i=re.getCache(t);if(!i)return;const r=re.getPointer(e);r&&delete i[r]}function xM(e,t){const i=[],r=new Array(t);for(let s=0;s<e;s++)i.push(re.ensureInt8(r));return i}function M_(e){let t;return Array.isArray(e[0])?(t=[],e.forEach(i=>{t.push(i[0],i[1])})):t=e,t}function Oy(e,t,i,r=!1){if(r)for(let s=0;s<2*t;s++)e[s]=re.getValue(i+s*Float64Array.BYTES_PER_ELEMENT,"double");else{const s=e.length===0;for(let n=0;n<t;n++)s&&(e[n]=new Array(2)),e[n][0]=re.getValue(i,"double"),e[n][1]=re.getValue(i+Float64Array.BYTES_PER_ELEMENT,"double"),i+=2*Float64Array.BYTES_PER_ELEMENT}}(function(e){let t;function i(){e.PE_GTLIST_OPTS_COMMON=re.PeGTlistExtended.prototype.PE_GTLIST_OPTS_COMMON,t=re._pe_getPeGTlistExtendedEntrySize()}function r(s,n,o,a,l,c){let h=null;const p=new re.PeInteger(c);try{const f=re.PeGTlistExtended.prototype.getGTlist(s,n,o,a,l,p);if((c=p.val)&&(h=[f],c>1)){const g=re.getPointer(f);for(let y=1;y<c;y++)h.push(re.wrapPointer(g+t*y,re.PeGTlistExtendedEntry))}}finally{re.destroy(p)}return h}e.init=i,e.getGTlist=r})($D||($D={})),function(e){function t(i){if(i&&i.length){for(const r of i)Yp(r),r.getEntries().forEach(s=>{Yp(s);const n=s.getGeogtran();Yp(n),n.getParameters().forEach(Yp),[n.getGeogcs1(),n.getGeogcs2()].forEach(o=>{Yp(o);const a=o.getDatum();Yp(a),Yp(a.getSpheroid()),Yp(o.getPrimem()),Yp(o.getUnit())})});re.PeGTlistExtendedEntry.prototype.Delete(i[0])}}e.destroy=t}(JB||(JB={})),function(e){function t(i,r,s,n,o){re.ensureCache.prepare();const a=M_(s),l=s===a,c=re.ensureFloat64(a);let h=0;n&&(h=re.ensureFloat64(n));const p=re._pe_geog_to_geog(re.getPointer(i),r,c,h,o);return p&&Oy(s,r,c,l),p}e.geogToGeog=t}(KB||(KB={})),function(e){const t=(c,h,p,f,g,y)=>{let v,b;switch(re.ensureCache.prepare(),c){case"dd":v=re._pe_geog_to_dd,b=Lr.PE_DD_MAX;break;case"ddm":v=re._pe_geog_to_ddm,b=Lr.PE_DDM_MAX;break;case"dms":v=re._pe_geog_to_dms,b=Lr.PE_DMS_MAX}let w=0;h&&(w=re.getPointer(h));const S=M_(f),T=re.ensureFloat64(S),A=xM(p,b),C=v(w,p,T,g,re.ensureInt32(A));if(C)for(let O=0;O<p;O++)y[O]=re.UTF8ToString(A[O]);return C},i=(c,h,p,f,g)=>{let y;switch(re.ensureCache.prepare(),c){case"dd":y=re._pe_dd_to_geog;break;case"ddm":y=re._pe_ddm_to_geog;break;case"dms":y=re._pe_dms_to_geog}let v=0;h&&(v=re.getPointer(h));const b=f.map(A=>re.ensureString(A)),w=re.ensureInt32(b),S=re.ensureFloat64(new Array(2*p)),T=y(v,p,w,S);return T&&Oy(g,p,S),T};function r(c,h,p,f,g){return t("dms",c,h,p,f,g)}function s(c,h,p,f){return i("dms",c,h,p,f)}function n(c,h,p,f,g){return t("ddm",c,h,p,f,g)}function o(c,h,p,f){return i("ddm",c,h,p,f)}function a(c,h,p,f,g){return t("dd",c,h,p,f,g)}function l(c,h,p,f){return i("dd",c,h,p,f)}e.geogToDms=r,e.dmsToGeog=s,e.geogToDdm=n,e.ddmToGeog=o,e.geogToDd=a,e.ddToGeog=l}(eV||(eV={})),function(e){function t(){e.PE_MGRS_STYLE_NEW=re.PeNotationMgrs.prototype.PE_MGRS_STYLE_NEW,e.PE_MGRS_STYLE_OLD=re.PeNotationMgrs.prototype.PE_MGRS_STYLE_OLD,e.PE_MGRS_STYLE_AUTO=re.PeNotationMgrs.prototype.PE_MGRS_STYLE_AUTO,e.PE_MGRS_180_ZONE_1_PLUS=re.PeNotationMgrs.prototype.PE_MGRS_180_ZONE_1_PLUS,e.PE_MGRS_ADD_SPACES=re.PeNotationMgrs.prototype.PE_MGRS_ADD_SPACES}function i(s,n,o,a,l,c,h){re.ensureCache.prepare();let p=0;s&&(p=re.getPointer(s));const f=M_(o),g=re.ensureFloat64(f),y=xM(n,Lr.PE_MGRS_MAX),v=re.ensureInt32(y),b=re._pe_geog_to_mgrs_extended(p,n,g,a,l,c,v);if(b)for(let w=0;w<n;w++)h[w]=re.UTF8ToString(y[w]);return b}function r(s,n,o,a,l){re.ensureCache.prepare();let c=0;s&&(c=re.getPointer(s));const h=o.map(y=>re.ensureString(y)),p=re.ensureInt32(h),f=re.ensureFloat64(new Array(2*n)),g=re._pe_mgrs_to_geog_extended(c,n,p,a,f);return g&&Oy(l,n,f),g}e.init=t,e.geogToMgrsExtended=i,e.mgrsToGeogExtended=r}(DD||(DD={})),function(e){function t(r,s,n,o,a,l,c){re.ensureCache.prepare();let h=0;r&&(h=re.getPointer(r));const p=M_(n),f=re.ensureFloat64(p),g=xM(s,Lr.PE_MGRS_MAX),y=re.ensureInt32(g),v=re._pe_geog_to_usng(h,s,f,o,a,l,y);if(v)for(let b=0;b<s;b++)c[b]=re.UTF8ToString(g[b]);return v}function i(r,s,n,o){re.ensureCache.prepare();let a=0;r&&(a=re.getPointer(r));const l=n.map(f=>re.ensureString(f)),c=re.ensureInt32(l),h=re.ensureFloat64(new Array(2*s)),p=re._pe_usng_to_geog(a,s,c,h);return p&&Oy(o,s,h),p}e.geogToUsng=t,e.usngToGeog=i}(tV||(tV={})),function(e){function t(){e.PE_UTM_OPTS_NONE=re.PeNotationUtm.prototype.PE_UTM_OPTS_NONE,e.PE_UTM_OPTS_ADD_SPACES=re.PeNotationUtm.prototype.PE_UTM_OPTS_ADD_SPACES,e.PE_UTM_OPTS_NS=re.PeNotationUtm.prototype.PE_UTM_OPTS_NS}function i(s,n,o,a,l){re.ensureCache.prepare();let c=0;s&&(c=re.getPointer(s));const h=M_(o),p=re.ensureFloat64(h),f=xM(n,Lr.PE_UTM_MAX),g=re.ensureInt32(f),y=re._pe_geog_to_utm(c,n,p,a,g);if(y)for(let v=0;v<n;v++)l[v]=re.UTF8ToString(f[v]);return y}function r(s,n,o,a,l){re.ensureCache.prepare();let c=0;s&&(c=re.getPointer(s));const h=o.map(y=>re.ensureString(y)),p=re.ensureInt32(h),f=re.ensureFloat64(new Array(2*n)),g=re._pe_utm_to_geog(c,n,p,a,f);return g&&Oy(l,n,f),g}e.init=t,e.geogToUtm=i,e.utmToGeog=r}(LD||(LD={})),function(e){const t=new Map;function i(){e.PE_PCSINFO_OPTION_NONE=re.PePCSInfo.prototype.PE_PCSINFO_OPTION_NONE,e.PE_PCSINFO_OPTION_DOMAIN=re.PePCSInfo.prototype.PE_PCSINFO_OPTION_DOMAIN,e.PE_POLE_OUTSIDE_BOUNDARY=re.PePCSInfo.prototype.PE_POLE_OUTSIDE_BOUNDARY,e.PE_POLE_POINT=re.PePCSInfo.prototype.PE_POLE_POINT}function r(s,n=e.PE_PCSINFO_OPTION_DOMAIN){let o,a;return t.has(s)&&(a=t.get(s),a[n]&&(o=a[n])),o||(o=re.PePCSInfo.prototype.generate(s,n),a||(a=[],t.set(s,a)),a[n]=o),o}e.init=i,e.generate=r}(ND||(ND={})),function(e){function t(){return re.PeVersion.prototype.version_string()}e.versionString=t}(iV||(iV={}));const vOe=Object.freeze({__proto__:null,get _pe(){return re},isLoaded:Zce,isSupported:yOe,load:Qce,get PeCSTransformations(){return ZB},get PeDefs(){return Lr},get PeFactory(){return QB},get PeGCSExtent(){return Jce},get PeGTlistExtended(){return $D},get PeGTlistExtendedEntry(){return JB},get PeGTTransformations(){return KB},get PeNotationDms(){return eV},get PeNotationMgrs(){return DD},get PeNotationUsng(){return tV},get PeNotationUtm(){return LD},get PePCSInfo(){return ND},get PeVersion(){return iV},_init:Kce}),Mmt=Math.PI/180,Pmt=/SPHEROID\[([^\]]+)]/i,lg=ai.radius,Wu=ai.eccentricitySquared,_Oe={a1:lg*Wu,a2:lg*Wu*lg*Wu,a3:lg*Wu*Wu/2,a4:lg*Wu*lg*Wu*2.5,a5:lg*Wu+lg*Wu*Wu/2,a6:1-Wu},Imt={4267:{a:63782064e-1,f:1/294.9786982},4269:{a:6378137,f:1/298.257222101},4326:{a:ai.radius,f:ai.flattening},104900:{a:2439700,f:0},104901:{a:6051e3,f:0},104902:{a:6051800,f:0},104903:{a:Am.radius,f:Am.flattening},104904:{a:3393400,f:1/192.0430107526882},104905:{a:pp.radius,f:pp.flattening},104906:{a:6200,f:0},104907:{a:11100,f:0},104908:{a:71492e3,f:.06487439154031222},104909:{a:8200,f:0},104910:{a:83500,f:0},104911:{a:1e4,f:0},104912:{a:2409300,f:0},104913:{a:15e3,f:0},104914:{a:4e4,f:0},104915:{a:1562090,f:0},104916:{a:2632345,f:0},104917:{a:85e3,f:0},104918:{a:1821460,f:0},104919:{a:5e3,f:0},104920:{a:12e3,f:0},104921:{a:3e4,f:3},104922:{a:18e3,f:0},104923:{a:14e3,f:0},104924:{a:49300,f:0},104925:{a:60268e3,f:1/10.2079945799458},104926:{a:16e3,f:0},104927:{a:9500,f:0},104928:{a:56e4,f:0},104929:{a:249400,f:0},104930:{a:59500,f:0},104931:{a:16e3,f:0},104932:{a:133e3,f:0},104933:{a:718e3,f:0},104934:{a:888e3,f:0},104935:{a:1986300,f:0},104936:{a:1e4,f:0},104937:{a:41900,f:0},104938:{a:11e4,f:0},104939:{a:50100,f:0},104940:{a:764e3,f:0},104941:{a:11e3,f:0},104942:{a:529800,f:0},104943:{a:2575e3,f:0},104944:{a:25559e3,f:1/43.61604095563141},104945:{a:578900,f:0},104946:{a:33e3,f:0},104947:{a:21e3,f:0},104948:{a:13e3,f:0},104949:{a:31e3,f:0},104950:{a:27e3,f:0},104951:{a:42e3,f:0},104952:{a:235800,f:0},104953:{a:761400,f:0},104954:{a:15e3,f:0},104955:{a:54e3,f:0},104956:{a:77e3,f:0},104957:{a:27e3,f:0},104958:{a:788900,f:0},104959:{a:584700,f:0},104960:{a:24764e3,f:.01708124697141011},104961:{a:74e3,f:0},104962:{a:79e3,f:0},104963:{a:104e3,f:.14423076923076922},104964:{a:29e3,f:0},104965:{a:17e4,f:0},104966:{a:208e3,f:0},104967:{a:4e4,f:0},104968:{a:1352600,f:0},104969:{a:1195e3,f:0},104970:{a:593e3,f:0},104971:{a:pp.radius,f:0},104972:{a:47e4,f:0},104973:{a:255e3,f:0},104974:{a:2439400,f:0}};let TM=0;class Kx{constructor(t=null){this.uid=TM++,t?(this._wkt=t.wkt!==void 0?t.wkt:null,this._wkid=t.wkid!==void 0?t.wkid:-1,this._isInverse=t.isInverse!==void 0&&t.isInverse===!0):(this._wkt=null,this._wkid=-1,this._isInverse=!1)}static fromGE(t){const i=new Kx;return i._wkt=t.wkt,i._wkid=t.wkid,i._isInverse=t.isInverse,i}get wkt(){return this._wkt}set wkt(t){this._wkt=t,this.uid=TM++}get wkid(){return this._wkid}set wkid(t){this._wkid=t,this.uid=TM++}get isInverse(){return this._isInverse}set isInverse(t){this._isInverse=t,this.uid=TM++}getInverse(){const t=new Kx;return t._wkt=this.wkt,t._wkid=this._wkid,t._isInverse=!this.isInverse,t}}class zy{constructor(t){if(this.steps=[],this._cached_projection={},this._chain="",this._gtlistentry=null,t&&t.steps)for(const i of t.steps)i instanceof Kx?this.steps.push(i):this.steps.push(new Kx({wkid:i.wkid,wkt:i.wkt,isInverse:i.isInverse}))}static cacheKey(t,i){return[t.wkid!==void 0&&t.wkid!==null?t.wkid.toString():"-1",t.wkt!==void 0&&t.wkt!==null?t.wkt.toString():"",i.wkid!==void 0&&i.wkid!==null?i.wkid.toString():"-1",i.wkt!==void 0&&i.wkt!==null?i.wkt.toString():""].join(",")}static fromGE(t){const i=new zy;let r="";for(const s of t.steps){const n=Kx.fromGE(s);i.steps.push(n),r+=n.uid.toString()+","}return i._cached_projection={},i._gtlistentry=null,i._chain=r,i}getInverse(){const t=new zy;t.steps=[];for(let i=this.steps.length-1;i>=0;i--){const r=this.steps[i];t.steps.push(r.getInverse())}return t}getGTListEntry(){let t="";for(const i of this.steps)t+=i.uid.toString()+",";return t!==this._chain&&(this._gtlistentry=null,this._cached_projection={},this._chain=t),this._gtlistentry}assignCachedGe(t,i,r){this._cached_projection[zy.cacheKey(t,i)]=r}getCachedGeTransformation(t,i){let r="";for(const n of this.steps)r+=n.uid.toString()+",";r!==this._chain&&(this._gtlistentry=null,this._cached_projection={},this._chain=r);const s=this._cached_projection[zy.cacheKey(t,i)];return s===void 0?null:s}}function Oj(e,t,i){if(R(t)||R(i)||i.vcsWkid||Rc(t,i))return null;const r=BT(t)/BT(i);if(r===1)return null;switch(e){case"point":case"esriGeometryPoint":return s=>bOe(s,r);case"polyline":case"esriGeometryPolyline":return s=>xOe(s,r);case"polygon":case"esriGeometryPolygon":return s=>wOe(s,r);case"multipoint":case"esriGeometryMultipoint":return s=>TOe(s,r);case"extent":case"esriGeometryExtent":return s=>SOe(s,r);default:return null}}function bOe(e,t){e&&e.z!=null&&(e.z*=t)}function wOe(e,t){if(e)for(const i of e.rings)for(const r of i)r.length>2&&(r[2]*=t)}function xOe(e,t){if(e)for(const i of e.paths)for(const r of i)r.length>2&&(r[2]*=t)}function TOe(e,t){if(e)for(const i of e.points)i.length>2&&(i[2]*=t)}function SOe(e,t){e&&e.zmin!=null&&e.zmax!=null&&(e.zmin*=t,e.zmax*=t)}let O1=null,FD=null,D5=null,L5={};function eue(){return!!O1&&Zce()}function rV(e){return R(D5)&&(D5=Promise.all([Qce(),import("./geometryEngineBase.40db0853.js").then(t=>t.g),import("./hydrated.7003737e.js")])),D5.then(([,t,{hydratedAdapter:i}])=>{Qt(e),FD=i,O1=t.default,O1._enableProjection(vOe)})}function dO(e,t,i=null){return Array.isArray(e)?e.length===0?[]:gZ(FD,e,e[0].spatialReference,t,i):gZ(FD,[e],e.spatialReference,t,i)[0]}function gZ(e,t,i,r,s=null){if(R(i)||R(r))return t;if(M1(i,r,s))return t.map(n=>tue(n,i,r));if(R(s)){const n=zy.cacheKey(i,r);L5[n]!==void 0?s=L5[n]:(s=EOe(i,r,null),R(s)&&(s=new zy),L5[n]=s)}if(R(O1))throw new Mj;return O1._project(e,t,i,r,s)}function EOe(e,t,i=null){if(R(O1))throw new Mj;if(R(e)||R(t))return null;const r=O1._getTransformation(FD,e,t,i,i==null?void 0:i.spatialReference);return r!==null?zy.fromGE(r):null}class Mj extends q{constructor(){super("projection:not-loaded","projection engine not fully loaded yet, please call load()")}}var Y;function $mt(e,t){try{const i=dO(e,t);if(i==null)return null;"xmin"in e&&"xmin"in i&&(i.zmin=e.zmin,i.zmax=e.zmax);const r=Oj(i.type,e.spatialReference,t);return _(r)&&r(i),i}catch(i){if(!(i instanceof Mj))throw i;return null}}function M1(e,t,i){return!i&&(!!Rc(e,t)||_c(e)&&_c(t)&&!!Dj(e,t,Nj))}async function Dmt(e,t,i,r){if(!eue()){if(Array.isArray(e)){for(const{source:s,dest:n,geographicTransformation:o}of e)if(!M1(s,n,o))return rV(r)}else if(!M1(e,t,i))return rV(r)}}function Lmt(e,t){switch(Dj(e,t,Nj)){case qi:return"copy3";case Vy:return"wgs84ToSphericalECEF";case P1:return"wgs84ToWebMercator";case By:return"wgs84ToPlateCarree";case jy:return"wgs84ToWGS84ECEF";case a1:return"webMercatorToWGS84";case aue:return"webMercatorToSphericalECEF";case lue:return"webMercatorToWGS84ECEF";case cue:return"webMercatorToPlateCarree";case Hy:return"wgs84ECEFToWGS84";case due:return"wgs84ECEFToSphericalECEF";case pue:return"wgs84ECEFToWebMercator";case Gy:return"sphericalECEFToWGS84";case uue:return"sphericalECEFToWebMercator";case aV:return"sphericalMarsPCPFToMars2000";case oV:return"sphericalMoonPCPFToMoon2000";case hue:return"sphericalECEFToWGS84ECEF";case nV:return"mars2000ToSphericalPCPF";case sV:return"moon2000ToSphericalPCPF";default:return null}}function tue(e,t,i){return e?"x"in e?iue(e,t,new et,i,0):"xmin"in e?OOe(e,t,new Xt,i,0):"rings"in e?rue(e,t,new bc,i,0):"paths"in e?ROe(e,t,new cc,i,0):"points"in e?COe(e,t,new nb,i,0):null:null}function AOe(e,t,i=t.spatialReference,r=0){return!R(i)&&_(iue(e,e.spatialReference,t,i,r))}function iue(e,t,i,r,s){gi[0]=e.x,gi[1]=e.y;const n=e.z;return gi[2]=n!==void 0?n:s,br(gi,t,0,gi,r,0,1)?(i.x=gi[0],i.y=gi[1],i.spatialReference=r,n===void 0?(i.z=void 0,i.hasZ=!1):(i.z=gi[2],i.hasZ=!0),e.m===void 0?(i.m=void 0,i.hasM=!1):(i.m=e.m,i.hasM=!0),i):null}function COe(e,t,i,r,s){const{points:n,hasZ:o,hasM:a}=e,l=[],c=n.length,h=[];for(const p of n)h.push(p[0],p[1],o?p[2]:s);if(!br(h,t,0,h,r,0,c))return null;for(let p=0;p<c;++p){const f=3*p,g=h[f],y=h[f+1];o&&a?l.push([g,y,h[f+2],n[p][3]]):o?l.push([g,y,h[f+2]]):a?l.push([g,y,n[p][2]]):l.push([g,y])}return i.points=l,i.spatialReference=r,i.hasZ=o,i.hasM=a,i}function ROe(e,t,i,r,s){const{paths:n,hasZ:o,hasM:a}=e,l=[];return nue(n,o,a,t,l,r,s)?(i.paths=l,i.spatialReference=r,i.hasZ=o,i.hasM=a,i):null}function Nmt(e,t,i=t.spatialReference,r=0){return _(i)&&_(rue(e,e.spatialReference,t,i,r))}function rue(e,t,i,r,s){const{rings:n,hasZ:o,hasM:a}=e,l=[];return nue(n,o,a,t,l,r,s)?(i.rings=l,i.spatialReference=r,i.hasZ=o,i.hasM=a,i):null}function OOe(e,t,i,r,s){const{xmin:n,ymin:o,xmax:a,ymax:l,hasZ:c,hasM:h}=e;return yZ(n,o,c?e.zmin:s,t,gi,r)?(i.xmin=gi[0],i.ymin=gi[1],c&&(i.zmin=gi[2]),yZ(a,l,c?e.zmax:s,t,gi,r)?(i.xmax=gi[0],i.ymax=gi[1],c&&(i.zmax=gi[2]),h&&(i.mmin=e.mmin,i.mmax=e.mmax),i.spatialReference=r,i):null):null}function _0(e,t,i){if(R(t)||R(i))return null;const r=new et({spatialReference:i});return br(e,t,0,gi,i,0,1)?(r.x=gi[0],r.y=gi[1],r.z=gi[2],r):null}function sue(e,t,i){return br(e,t,0,gi,i.spatialReference,0,1)?(i.x=gi[0],i.y=gi[1],i.z=gi[2],i):null}function tn(e,t,i,r=0){gi[0]=e.x,gi[1]=e.y;const s=e.z;return gi[2]=s!==void 0?s:r,br(gi,e.spatialReference,0,t,i,0,1)}function yZ(e,t,i,r,s,n){return gr[0]=e,gr[1]=t,gr[2]=i,br(gr,r,0,s,n,0,1)}function wn(e,t,i,r){return!(R(t)||R(r)||e.length<2)&&(e.length===2&&(gr[0]=e[0],gr[1]=e[1],gr[2]=0,e=gr),br(e,t,0,i,r,0,1))}function MOe(e,t){gi[0]=e.x,gi[1]=e.y;const i=e.z;return gi[2]=i!==void 0?i:0,POe(gi,e.spatialReference,t)}function POe(e,t,i){return IOe(e,t,i)}function IOe(e,t,i){if(R(t))return!1;const r=b0(t,oF),s=hp[r][Y.WGS84_COMPARABLE_LON_LAT];return!R(s)&&(s(e,0,gr,0),i!==gr&&(i[0]=gr[0],i[1]=gr[1],i.length>2&&(i[2]=gr[2])),!0)}function br(e,t,i,r,s,n,o=1){const a=Dj(t,s,Nj);if(R(a))return!1;if(a===qi){if(e===r&&i===n)return!0;const c=i+3*o;for(let h=i,p=n;h<c;h++,p++)r[p]=e[h];return!0}const l=i+3*o;for(let c=i,h=n;c<l;c+=3,h+=3)a(e,c,r,h);return!0}function Fmt(e,t,i,r,s){ne(gi,e),pe(SM,e,t),wn(gi,i,gi,s),wn(SM,i,SM,s),de(r,SM,gi),be(r,r)}function nue(e,t,i,r,s,n,o=0){const a=new Array;for(const c of e)for(const h of c)a.push(h[0],h[1],t?h[2]:o);if(!br(a,r,0,a,n,0,a.length/3))return!1;let l=0;s.length=0;for(const c of e){const h=new Array;for(const p of c)t&&i?h.push([a[l++],a[l++],a[l++],p[3]]):t?h.push([a[l++],a[l++],a[l++]]):i?(h.push([a[l++],a[l++],p[2]]),l++):(h.push([a[l++],a[l++]]),l++);s.push(h)}return!0}function Umt(e,t,i,r){if(R(t)||R(r))return!1;const s=fue(t,r,zOe);if(s.projector===qi)return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],!0;if(R(s.projector))return!1;const{source:n,dest:o}=s;if(o.spatialReferenceId===Y.WEB_MERCATOR){const a=hp[n.spatialReferenceId][Y.WGS84];return!R(a)&&(a(e,0,Ah,0),P1(Ah,0,i,0),i[3]=vZ(Ah[1],e[2],e[3],ai.radius),!0)}if(n.spatialReferenceId!==Y.WGS84&&n.spatialReferenceId!==Y.CGCS2000||o.spatialReferenceId!==Y.PLATE_CARREE)s.projector(e,0,i,0),i[3]=e[3]*n.metersPerUnit/o.metersPerUnit;else{const a=hp[n.spatialReferenceId][Y.SPHERICAL_ECEF],l=hp[Y.SPHERICAL_ECEF][Y.PLATE_CARREE];let c=e[3];_(a)&&_(l)&&(c=vZ(e[1],e[2],e[3],ai.radius)),s.projector(e,0,i,0),i[3]=c}return!0}function vZ(e,t,i,r){const s=r+t;if(s<r/2||i>s)return Number.MAX_VALUE;const n=Math.abs(zh*e)+Math.asin(i/s);return n>=Math.PI/2?Number.MAX_VALUE:i/Math.cos(n)}function nF(e,t,i,r){return e!=null&&(Rc(t,r)?(y0(i,e),!0):(gr[0]=e[0],gr[1]=e[1],gr[2]=0,!!br(gr,t,0,gr,r,0,1)&&(i[0]=gr[0],i[1]=gr[1],gr[0]=e[2],gr[1]=e[3],gr[2]=0,!!br(gr,t,0,gr,r,0,1)&&(i[2]=gr[0],i[3]=gr[1],!0))))}function kmt(e,t,i,r){if(R(t)||R(r))return!1;const s=b0(t,oF),n=b0(r,mue);if(s===n&&s!==Y.UNKNOWN||Rc(t,r))return i[0]=1,i[1]=1,i[2]=1,!0;if(s===Y.SPHERICAL_ECEF){const o=Pe(e),a=o/Math.sqrt(e[0]*e[0]+e[1]*e[1]),l=o/ai.radius;if(n===Y.WEB_MERCATOR)return i[0]=a*l,i[1]=a*l,i[2]=1,!0;if(n===Y.WGS84||n===Y.CGCS2000){const c=QA;return i[0]=c*a*l,i[1]=c*l,i[2]=1,!0}}else if(s===Y.PLATE_CARREE){if(n===Y.WGS84||n===Y.CGCS2000)return i[0]=QA,i[1]=QA,i[2]=1,!0;if(n===Y.WEB_MERCATOR){const o=e[1]/ai.radius;return i[0]=1,i[1]=1/Math.cos(o),i[2]=1,!0}}return!1}function Kh(e,t,i,r){if(R(e)||R(r))return!1;const s=b0(e,oF),n=b0(r,mue);if(s===n&&!_Z(n)&&(s!==Y.UNKNOWN||Rc(e,r)))return rF(i,t),!0;if(_Z(n)){const o=hp[s][Y.LON_LAT],a=hp[Y.LON_LAT][n];return!R(o)&&!R(a)&&(o(t,0,Ah,0),a(Ah,0,cg,0),oue(zh*Ah[0],zh*Ah[1],i),i[12]=cg[0],i[13]=cg[1],i[14]=cg[2],!0)}if((n===Y.WEB_MERCATOR||n===Y.PLATE_CARREE)&&(s===Y.WGS84||s===Y.CGCS2000&&n===Y.PLATE_CARREE||s===Y.SPHERICAL_ECEF||s===Y.WEB_MERCATOR)){const o=hp[s][Y.LON_LAT],a=hp[Y.LON_LAT][n];return!R(o)&&!R(a)&&(o(t,0,Ah,0),a(Ah,0,cg,0),s===Y.SPHERICAL_ECEF?$Oe(zh*Ah[0],zh*Ah[1],i):Ap(i),i[12]=cg[0],i[13]=cg[1],i[14]=cg[2],!0)}return!1}function _Z(e){return e===Y.SPHERICAL_ECEF||e===Y.SPHERICAL_MARS_PCPF||e===Y.SPHERICAL_MOON_PCPF}function oue(e,t,i){const r=Math.sin(e),s=Math.cos(e),n=Math.sin(t),o=Math.cos(t),a=i;return a[0]=-r,a[4]=-n*s,a[8]=o*s,a[12]=0,a[1]=s,a[5]=-n*r,a[9]=o*r,a[13]=0,a[2]=0,a[6]=o,a[10]=n,a[14]=0,a[3]=0,a[7]=0,a[11]=0,a[15]=1,a}function $Oe(e,t,i){return oue(e,t,i),Oa(i,i),i}function b0(e,t){return t.spatialReference===e?t.spatialReferenceId:(t.spatialReference=e,"metersPerUnit"in t&&(t.metersPerUnit=Cl(e,1)),e.wkt===Ice.wkt?t.spatialReferenceId=Y.SPHERICAL_ECEF:NC(e)?t.spatialReferenceId=Y.WGS84:b1(e)?t.spatialReferenceId=Y.WEB_MERCATOR:Oae(e)?t.spatialReferenceId=Y.PLATE_CARREE:e.wkt===MRe.wkt?t.spatialReferenceId=Y.WGS84_ECEF:e.wkid===xu.CGCS2000?t.spatialReferenceId=Y.CGCS2000:e.wkt===MD.wkt?t.spatialReferenceId=Y.SPHERICAL_MARS_PCPF:e.wkt===PD.wkt?t.spatialReferenceId=Y.SPHERICAL_MOON_PCPF:Lp(e)?t.spatialReferenceId=Y.GCSMARS2000:Np(e)?t.spatialReferenceId=Y.GCSMOON2000:t.spatialReferenceId=Y.UNKNOWN)}function qi(e,t,i,r){e!==i&&(i[r++]=e[t++],i[r++]=e[t++],i[r]=e[t])}function a1(e,t,i,r){i[r++]=jT*(e[t++]/ai.radius),i[r++]=jT*(Math.PI/2-2*Math.atan(Math.exp(-e[t++]/ai.radius))),i[r]=e[t]}function aue(e,t,i,r){a1(e,t,i,r),Vy(i,r,i,r)}function lue(e,t,i,r){a1(e,t,i,r),jy(i,r,i,r)}function Pj(e,t,i,r,s){const n=.4999999*Math.PI,o=Be(zh*e[t+1],-n,n),a=Math.sin(o);i[r++]=zh*e[t]*s.radius,i[r++]=s.halfSemiMajorAxis*Math.log((1+a)/(1-a)),i[r]=e[t+2]}function P1(e,t,i,r){Pj(e,t,i,r,ai)}(function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SPHERICAL_ECEF=1]="SPHERICAL_ECEF",e[e.WGS84=2]="WGS84",e[e.WEB_MERCATOR=3]="WEB_MERCATOR",e[e.WGS84_ECEF=4]="WGS84_ECEF",e[e.CGCS2000=5]="CGCS2000",e[e.WGS84_COMPARABLE_LON_LAT=6]="WGS84_COMPARABLE_LON_LAT",e[e.SPHERICAL_MARS_PCPF=7]="SPHERICAL_MARS_PCPF",e[e.GCSMARS2000=8]="GCSMARS2000",e[e.SPHERICAL_MOON_PCPF=9]="SPHERICAL_MOON_PCPF",e[e.GCSMOON2000=10]="GCSMOON2000",e[e.LON_LAT=11]="LON_LAT",e[e.PLATE_CARREE=12]="PLATE_CARREE"})(Y||(Y={}));const bZ=ai.radius*Math.PI/180,QA=180/(ai.radius*Math.PI);function By(e,t,i,r){i[r]=e[t]*bZ,i[r+1]=e[t+1]*bZ,i[r+2]=e[t+2]}function H_(e,t,i,r){i[r]=e[t]*QA,i[r+1]=e[t+1]*QA,i[r+2]=e[t+2]}function cue(e,t,i,r){a1(e,t,i,r),By(i,r,i,r)}function DOe(e,t,i,r){Hy(e,t,i,r),By(i,r,i,r)}function LOe(e,t,i,r){Gy(e,t,i,r),By(i,r,i,r)}function NOe(e,t,i,r){H_(e,t,i,r),Vy(i,r,i,r)}function FOe(e,t,i,r){H_(e,t,i,r),P1(i,r,i,r)}function UOe(e,t,i,r){H_(e,t,i,r),jy(i,r,i,r)}function I1(e){if(R(e))return!1;const t=b0(e,oF);return!!hp[t][Y.WGS84_COMPARABLE_LON_LAT]}function v2(e,t,i,r,s=0){const n=r+s,o=Math.cos(i);e[0]=Math.cos(t)*o*n,e[1]=Math.sin(t)*o*n,e[2]=Math.sin(i)*n}function Ij(e,t,i,r,s){const n=s+e[t+2],o=zh*e[t+1],a=zh*e[t],l=Math.cos(o);i[r++]=Math.cos(a)*l*n,i[r++]=Math.sin(a)*l*n,i[r]=Math.sin(o)*n}function sV(e,t,i,r){Ij(e,t,i,r,Am.radius)}function nV(e,t,i,r){Ij(e,t,i,r,pp.radius)}function Vy(e,t,i,r){Ij(e,t,i,r,ai.radius)}function $j(e,t,i,r,s){const n=e[t],o=e[t+1],a=e[t+2],l=Math.sqrt(n*n+o*o+a*a),c=Yh(a/(l===0?1:l)),h=Math.atan2(o,n);i[r++]=jT*h,i[r++]=jT*c,i[r]=l-s}function oV(e,t,i,r){$j(e,t,i,r,Am.radius)}function aV(e,t,i,r){$j(e,t,i,r,pp.radius)}function Gy(e,t,i,r){$j(e,t,i,r,ai.radius)}function uue(e,t,i,r){Gy(e,t,i,r),P1(i,r,i,r)}function hue(e,t,i,r){Gy(e,t,i,r),jy(i,r,i,r)}function kOe(e,t,i,r,s){const n=zh*e[t],o=zh*e[t+1],a=e[t+2],l=Math.sin(o),c=Math.cos(o),h=s.radius/Math.sqrt(1-s.eccentricitySquared*l*l);i[r++]=(h+a)*c*Math.cos(n),i[r++]=(h+a)*c*Math.sin(n),i[r++]=(h*(1-s.eccentricitySquared)+a)*l}function jy(e,t,i,r){kOe(e,t,i,r,ai)}function Hy(e,t,i,r){const s=_Oe,n=e[t],o=e[t+1],a=e[t+2];let l,c,h,p,f,g,y,v,b,w,S,T,A,C,O,L,U,N,z,V,B;l=Math.abs(a),c=n*n+o*o,h=Math.sqrt(c),p=c+a*a,f=Math.sqrt(p),V=Math.atan2(o,n),g=a*a/p,y=c/p,C=s.a2/f,O=s.a3-s.a4/f,y>.3?(v=l/f*(1+y*(s.a1+C+g*O)/f),z=Math.asin(v),w=v*v,b=Math.sqrt(1-w)):(b=h/f*(1-g*(s.a5-C-y*O)/f),z=Math.acos(b),w=1-b*b,v=Math.sqrt(w)),S=1-ai.eccentricitySquared*w,T=ai.radius/Math.sqrt(S),A=s.a6*T,C=h-T*b,O=l-A*v,U=b*C+v*O,L=b*O-v*C,N=L/(A/S+U),z+=N,B=U+L*N/2,a<0&&(z=-z),i[r++]=jT*V,i[r++]=jT*z,i[r]=B}function due(e,t,i,r){Hy(e,t,i,r),Vy(i,r,i,r)}function pue(e,t,i,r){Hy(e,t,i,r),P1(i,r,i,r)}const hp={[Y.WGS84]:{[Y.CGCS2000]:null,[Y.GCSMARS2000]:null,[Y.GCSMOON2000]:null,[Y.LON_LAT]:qi,[Y.WGS84_COMPARABLE_LON_LAT]:qi,[Y.SPHERICAL_ECEF]:Vy,[Y.SPHERICAL_MARS_PCPF]:null,[Y.SPHERICAL_MOON_PCPF]:null,[Y.UNKNOWN]:null,[Y.WEB_MERCATOR]:P1,[Y.PLATE_CARREE]:By,[Y.WGS84]:qi,[Y.WGS84_ECEF]:jy},[Y.CGCS2000]:{[Y.CGCS2000]:qi,[Y.GCSMARS2000]:null,[Y.GCSMOON2000]:null,[Y.LON_LAT]:qi,[Y.WGS84_COMPARABLE_LON_LAT]:qi,[Y.SPHERICAL_ECEF]:Vy,[Y.SPHERICAL_MARS_PCPF]:null,[Y.SPHERICAL_MOON_PCPF]:null,[Y.UNKNOWN]:null,[Y.WEB_MERCATOR]:null,[Y.PLATE_CARREE]:By,[Y.WGS84]:null,[Y.WGS84_ECEF]:jy},[Y.GCSMARS2000]:{[Y.CGCS2000]:null,[Y.GCSMARS2000]:qi,[Y.GCSMOON2000]:null,[Y.LON_LAT]:qi,[Y.WGS84_COMPARABLE_LON_LAT]:null,[Y.SPHERICAL_ECEF]:null,[Y.SPHERICAL_MARS_PCPF]:nV,[Y.SPHERICAL_MOON_PCPF]:null,[Y.UNKNOWN]:null,[Y.WEB_MERCATOR]:null,[Y.PLATE_CARREE]:null,[Y.WGS84]:null,[Y.WGS84_ECEF]:null},[Y.GCSMOON2000]:{[Y.CGCS2000]:null,[Y.GCSMARS2000]:null,[Y.GCSMOON2000]:qi,[Y.LON_LAT]:qi,[Y.WGS84_COMPARABLE_LON_LAT]:null,[Y.SPHERICAL_ECEF]:null,[Y.SPHERICAL_MARS_PCPF]:null,[Y.SPHERICAL_MOON_PCPF]:sV,[Y.UNKNOWN]:null,[Y.WEB_MERCATOR]:null,[Y.PLATE_CARREE]:null,[Y.WGS84]:null,[Y.WGS84_ECEF]:null},[Y.WEB_MERCATOR]:{[Y.CGCS2000]:null,[Y.GCSMARS2000]:null,[Y.GCSMOON2000]:null,[Y.LON_LAT]:a1,[Y.WGS84_COMPARABLE_LON_LAT]:a1,[Y.SPHERICAL_ECEF]:aue,[Y.SPHERICAL_MARS_PCPF]:null,[Y.SPHERICAL_MOON_PCPF]:null,[Y.UNKNOWN]:null,[Y.WEB_MERCATOR]:qi,[Y.PLATE_CARREE]:cue,[Y.WGS84]:a1,[Y.WGS84_ECEF]:lue},[Y.WGS84_ECEF]:{[Y.CGCS2000]:Hy,[Y.GCSMARS2000]:null,[Y.GCSMOON2000]:null,[Y.LON_LAT]:Hy,[Y.WGS84_COMPARABLE_LON_LAT]:Hy,[Y.SPHERICAL_ECEF]:due,[Y.SPHERICAL_MARS_PCPF]:null,[Y.SPHERICAL_MOON_PCPF]:null,[Y.UNKNOWN]:null,[Y.WEB_MERCATOR]:pue,[Y.PLATE_CARREE]:DOe,[Y.WGS84]:Hy,[Y.WGS84_ECEF]:qi},[Y.SPHERICAL_ECEF]:{[Y.CGCS2000]:Gy,[Y.GCSMARS2000]:null,[Y.GCSMOON2000]:null,[Y.LON_LAT]:Gy,[Y.WGS84_COMPARABLE_LON_LAT]:Gy,[Y.SPHERICAL_ECEF]:qi,[Y.SPHERICAL_MARS_PCPF]:null,[Y.SPHERICAL_MOON_PCPF]:null,[Y.UNKNOWN]:null,[Y.WEB_MERCATOR]:uue,[Y.PLATE_CARREE]:LOe,[Y.WGS84]:Gy,[Y.WGS84_ECEF]:hue},[Y.SPHERICAL_MARS_PCPF]:{[Y.CGCS2000]:null,[Y.GCSMARS2000]:aV,[Y.GCSMOON2000]:null,[Y.LON_LAT]:aV,[Y.WGS84_COMPARABLE_LON_LAT]:null,[Y.SPHERICAL_ECEF]:null,[Y.SPHERICAL_MARS_PCPF]:qi,[Y.SPHERICAL_MOON_PCPF]:null,[Y.UNKNOWN]:null,[Y.WEB_MERCATOR]:null,[Y.PLATE_CARREE]:null,[Y.WGS84]:null,[Y.WGS84_ECEF]:null},[Y.SPHERICAL_MOON_PCPF]:{[Y.CGCS2000]:null,[Y.GCSMARS2000]:null,[Y.GCSMOON2000]:oV,[Y.LON_LAT]:oV,[Y.WGS84_COMPARABLE_LON_LAT]:null,[Y.SPHERICAL_ECEF]:null,[Y.SPHERICAL_MARS_PCPF]:null,[Y.SPHERICAL_MOON_PCPF]:qi,[Y.UNKNOWN]:null,[Y.WEB_MERCATOR]:null,[Y.PLATE_CARREE]:null,[Y.WGS84]:null,[Y.WGS84_ECEF]:null},[Y.UNKNOWN]:{[Y.CGCS2000]:null,[Y.GCSMARS2000]:null,[Y.GCSMOON2000]:null,[Y.LON_LAT]:null,[Y.WGS84_COMPARABLE_LON_LAT]:null,[Y.SPHERICAL_ECEF]:null,[Y.SPHERICAL_MARS_PCPF]:null,[Y.SPHERICAL_MOON_PCPF]:null,[Y.UNKNOWN]:qi,[Y.WEB_MERCATOR]:null,[Y.PLATE_CARREE]:null,[Y.WGS84]:null,[Y.WGS84_ECEF]:null},[Y.LON_LAT]:{[Y.CGCS2000]:qi,[Y.GCSMARS2000]:qi,[Y.GCSMOON2000]:qi,[Y.LON_LAT]:qi,[Y.WGS84_COMPARABLE_LON_LAT]:qi,[Y.SPHERICAL_ECEF]:Vy,[Y.SPHERICAL_MARS_PCPF]:nV,[Y.SPHERICAL_MOON_PCPF]:sV,[Y.UNKNOWN]:null,[Y.WEB_MERCATOR]:P1,[Y.PLATE_CARREE]:By,[Y.WGS84]:qi,[Y.WGS84_ECEF]:jy},[Y.WGS84_COMPARABLE_LON_LAT]:{[Y.CGCS2000]:null,[Y.GCSMARS2000]:null,[Y.GCSMOON2000]:null,[Y.LON_LAT]:qi,[Y.WGS84_COMPARABLE_LON_LAT]:qi,[Y.SPHERICAL_ECEF]:Vy,[Y.SPHERICAL_MARS_PCPF]:null,[Y.SPHERICAL_MOON_PCPF]:null,[Y.UNKNOWN]:null,[Y.WEB_MERCATOR]:null,[Y.PLATE_CARREE]:By,[Y.WGS84]:qi,[Y.WGS84_ECEF]:jy},[Y.PLATE_CARREE]:{[Y.CGCS2000]:H_,[Y.GCSMARS2000]:null,[Y.GCSMOON2000]:null,[Y.LON_LAT]:H_,[Y.WGS84_COMPARABLE_LON_LAT]:H_,[Y.SPHERICAL_ECEF]:NOe,[Y.SPHERICAL_MARS_PCPF]:null,[Y.SPHERICAL_MOON_PCPF]:null,[Y.UNKNOWN]:null,[Y.WEB_MERCATOR]:FOe,[Y.PLATE_CARREE]:qi,[Y.WGS84]:H_,[Y.WGS84_ECEF]:UOe}};function Dj(e,t,i=Lj()){return R(e)||R(t)?null:fue(e,t,i).projector}function fue(e,t,i){if(R(e)||R(t)||i.source.spatialReference===e&&i.dest.spatialReference===t)return i;const r=b0(e,i.source),s=b0(t,i.dest);return r===Y.UNKNOWN&&s===Y.UNKNOWN?Rc(e,t)?i.projector=qi:i.projector=null:i.projector=hp[r][s],i}function Lj(){return{source:{spatialReference:null,spatialReferenceId:Y.UNKNOWN,metersPerUnit:1},dest:{spatialReference:null,spatialReferenceId:Y.UNKNOWN,metersPerUnit:1},projector:qi}}const oF={spatialReference:null,spatialReferenceId:Y.UNKNOWN},mue={spatialReference:null,spatialReferenceId:Y.UNKNOWN},Nj=Lj(),zOe=Lj(),zh=Rt(1),jT=yl(1),gr=M(),Ah=M(),cg=M(),gi=M(),SM=M();class Gm{constructor(t){this.allocator=t,this._items=[],this._itemsPtr=0,this._grow()}get(){return this._itemsPtr===0&&CT(()=>this._reset()),this._itemsPtr===this._items.length&&this._grow(),this._items[this._itemsPtr++]}_reset(){const t=Math.min(3*Math.max(8,this._itemsPtr),this._itemsPtr+3*wZ);this._items.length=Math.min(t,this._items.length),this._itemsPtr=0}_grow(){for(let t=0;t<Math.max(8,Math.min(this._items.length,wZ));t++)this._items.push(this.allocator())}}const wZ=1024;function Te(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function l1(e){return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]]}function Fj(e,t,i,r,s,n,o,a,l,c,h,p,f,g,y,v){return[e,t,i,r,s,n,o,a,l,c,h,p,f,g,y,v]}function gue(e,t){return new Float64Array(e,t,16)}const ls=Te();Object.freeze({__proto__:null,create:Te,clone:l1,fromValues:Fj,createView:gue,IDENTITY:ls});var mc;(function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"})(mc||(mc={}));function BOe(e){return 32+e.length}function VOe(){return 16}function yue(e){if(!e)return 0;let t=32;for(const i in e)if(e.hasOwnProperty(i)){const r=e[i];switch(typeof r){case"string":t+=BOe(r);break;case"number":t+=VOe();break;case"boolean":t+=4}}return t}function zmt(e,t){return 32+e.length*t}var HT;(function(e){e[e.KILOBYTES=1024]="KILOBYTES",e[e.MEGABYTES=1048576]="MEGABYTES",e[e.GIGABYTES=1073741824]="GIGABYTES"})(HT||(HT={}));function wr(){return[1,0,0,0,1,0,0,0,1]}function GOe(e){return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]]}function jOe(e,t,i,r,s,n,o,a,l){return[e,t,i,r,s,n,o,a,l]}function vue(e,t){return new Float64Array(e,t,9)}Object.freeze({__proto__:null,create:wr,clone:GOe,fromValues:jOe,createView:vue});function k0(){return[0,0,0,1]}function HOe(e){return[e[0],e[1],e[2],e[3]]}function qOe(e,t,i,r){return[e,t,i,r]}function _ue(e,t){return new Float64Array(e,t,4)}const WOe=k0();Object.freeze({__proto__:null,create:k0,clone:HOe,fromValues:qOe,createView:_ue,IDENTITY:WOe});function Ye(){return[0,0]}function WE(e){return[e[0],e[1]]}function vi(e,t){return[e,t]}function XOe(e){const t=Ye(),i=Math.min(2,e.length);for(let r=0;r<i;++r)t[r]=e[r];return t}function bue(e,t){return new Float64Array(e,t,2)}function wue(){return Ye()}function xue(){return vi(1,1)}function Tue(){return vi(1,0)}function Sue(){return vi(0,1)}const lV=wue(),YOe=xue(),ZOe=Tue(),QOe=Sue();Object.freeze({__proto__:null,create:Ye,clone:WE,fromValues:vi,fromArray:XOe,createView:bue,zeros:wue,ones:xue,unitX:Tue,unitY:Sue,ZEROS:lV,ONES:YOe,UNIT_X:ZOe,UNIT_Y:QOe});function ni(){return[0,0,0,0]}function aF(e){return[e[0],e[1],e[2],e[3]]}function yi(e,t,i,r){return[e,t,i,r]}function Uj(e){const t=ni(),i=Math.min(4,e.length);for(let r=0;r<i;++r)t[r]=e[r];return t}function Eue(e,t){return new Float64Array(e,t,4)}function Aue(){return ni()}function Cue(){return yi(1,1,1,1)}function Rue(){return yi(1,0,0,0)}function Oue(){return yi(0,1,0,0)}function Mue(){return yi(0,0,1,0)}function Pue(){return yi(0,0,0,1)}const c1=Aue(),ap=Cue(),JOe=Rue(),KOe=Oue(),eMe=Mue(),tMe=Pue();Object.freeze({__proto__:null,create:ni,clone:aF,fromValues:yi,fromArray:Uj,createView:Eue,zeros:Aue,ones:Cue,unitX:Rue,unitY:Oue,unitZ:Mue,unitW:Pue,ZEROS:c1,ONES:ap,UNIT_X:JOe,UNIT_Y:KOe,UNIT_Z:eMe,UNIT_W:tMe});class sc{constructor(t,i,r){this.itemByteSize=t,this.itemCreate=i,this._buffers=new Array,this._items=new Array,this._itemsPtr=0,this._itemsPerBuffer=Math.ceil(r/this.itemByteSize)}get(){this._itemsPtr===0&&CT(()=>this._reset());const t=Math.floor(this._itemsPtr/this._itemsPerBuffer);for(;this._buffers.length<=t;){const i=new ArrayBuffer(this._itemsPerBuffer*this.itemByteSize);for(let r=0;r<this._itemsPerBuffer;++r)this._items.push(this.itemCreate(i,r*this.itemByteSize));this._buffers.push(i)}return this._items[this._itemsPtr++]}_reset(){const t=2*(Math.floor(this._itemsPtr/this._itemsPerBuffer)+1);for(;this._buffers.length>t;)this._buffers.pop(),this._items.length=this._buffers.length*this._itemsPerBuffer;this._itemsPtr=0}static createVec2f64(t=Sb){return new sc(16,bue,t)}static createVec3f64(t=Sb){return new sc(24,o7,t)}static createVec4f64(t=Sb){return new sc(32,Eue,t)}static createMat3f64(t=Sb){return new sc(72,vue,t)}static createMat4f64(t=Sb){return new sc(128,gue,t)}static createQuatf64(t=Sb){return new sc(32,_ue,t)}get test(){return{size:this._buffers.length*this._itemsPerBuffer*this.itemByteSize}}}const Sb=4*HT.KILOBYTES,Bmt=sc.createVec2f64(),Ne=sc.createVec3f64(),kj=sc.createVec4f64();sc.createMat3f64();const pO=sc.createMat4f64();sc.createQuatf64();function z0(e){return e?{origin:As(e.origin),vector:As(e.vector)}:{origin:M(),vector:M()}}function u1(e,t,i=z0()){return ne(i.origin,e),de(i.vector,t,e),i}function zj(e,t){const i=de(Ne.get(),t,e.origin),r=_e(e.vector,i),s=_e(e.vector,e.vector),n=Be(r/s,0,1),o=de(Ne.get(),ae(Ne.get(),e.vector,n),i);return _e(o,o)}function xZ(e,t,i,r,s){const{vector:n,origin:o}=e,a=de(Ne.get(),t,o),l=_e(n,a)/Go(n);return ae(s,n,Be(l,i,r)),pe(s,s,e.origin)}function Iue(e,t,i){return!!iMe(e,t,!0,TZ)&&(ne(i,TZ.pA),!0)}function iMe(e,t,i,r){const n=e.origin,o=pe(Ne.get(),n,e.vector),a=t.origin,l=pe(Ne.get(),a,t.vector),c=Ne.get(),h=Ne.get();if(c[0]=n[0]-a[0],c[1]=n[1]-a[1],c[2]=n[2]-a[2],h[0]=l[0]-a[0],h[1]=l[1]-a[1],h[2]=l[2]-a[2],Math.abs(h[0])<1e-6&&Math.abs(h[1])<1e-6&&Math.abs(h[2])<1e-6)return!1;const p=Ne.get();if(p[0]=o[0]-n[0],p[1]=o[1]-n[1],p[2]=o[2]-n[2],Math.abs(p[0])<1e-6&&Math.abs(p[1])<1e-6&&Math.abs(p[2])<1e-6)return!1;const f=c[0]*h[0]+c[1]*h[1]+c[2]*h[2],g=h[0]*p[0]+h[1]*p[1]+h[2]*p[2],y=c[0]*p[0]+c[1]*p[1]+c[2]*p[2],v=h[0]*h[0]+h[1]*h[1]+h[2]*h[2],b=(p[0]*p[0]+p[1]*p[1]+p[2]*p[2])*v-g*g;if(Math.abs(b)<1e-6)return!1;let w=(f*g-y*v)/b,S=(f+g*w)/v;i&&(w=Be(w,0,1),S=Be(S,0,1));const T=Ne.get(),A=Ne.get();return T[0]=n[0]+w*p[0],T[1]=n[1]+w*p[1],T[2]=n[2]+w*p[2],A[0]=a[0]+S*h[0],A[1]=a[1]+S*h[1],A[2]=a[2]+S*h[2],r.tA=w,r.tB=S,r.pA=T,r.pB=A,r.distance2=qn(T,A),!0}const TZ={tA:0,tB:0,pA:M(),pB:M(),distance2:0};new Gm(()=>({origin:null,vector:null}));function Vn(e){return e?{origin:As(e.origin),direction:As(e.direction)}:{origin:M(),direction:M()}}function Vmt(e,t){return y1(e.origin,t.origin)&&y1(e.direction,t.direction)}function xc(e,t){const i=aMe.get();return i.origin=e,i.direction=t,i}function UD(e,t=Vn()){return $ue(e.origin,e.direction,t)}function rMe(e,t,i=Vn()){return ne(i.origin,e),de(i.direction,t,e),i}function $ue(e,t,i=Vn()){return ne(i.origin,e),ne(i.direction,t),i}function sMe(e,t){const i=pt(Ne.get(),be(Ne.get(),e.direction),de(Ne.get(),t,e.origin));return _e(i,i)}function nMe(e,t,i){const r=_e(e.direction,de(i,t,e.origin));return pe(i,e.origin,ae(i,e.direction,r)),i}function oMe(){return{origin:null,direction:null}}const aMe=new Gm(oMe);function JA(e,t){return _e(e,t)/Pe(e)}function Bj(e,t){const i=_e(e,t)/(Pe(e)*Pe(t));return-Rs(i)}function lMe(e,t,i){be(EM,e),be(N5,t);const r=_e(EM,N5),s=Rs(r),n=pt(EM,EM,N5);return _e(n,i)<0?2*Math.PI-s:s}const EM=M(),N5=M(),cMe=he.getLogger("esri.geometry.support.sphere");function xn(){return ni()}function qT(e,t=xn()){return _a(t,e)}function Due(e,t){return yi(e[0],e[1],e[2],t)}function uMe(e){return e}function Lue(e){e[0]=e[1]=e[2]=e[3]=0}function hMe(e){return e}function lF(e){return Array.isArray(e)?e[3]:e}function Tc(e){return Array.isArray(e)?e:vMe}function Nue(e,t,i,r){return yi(e,t,i,r)}function dMe(e,t,i){return e!==i&&ne(i,e),i[3]=e[3]+t,i}function pMe(e,t,i){return cMe.error("sphere.setExtent is not yet supported"),e===i?i:qT(e,i)}function B0(e,t,i){if(R(t))return!1;const{origin:r,direction:s}=t,n=fMe;n[0]=r[0]-e[0],n[1]=r[1]-e[1],n[2]=r[2]-e[2];const o=s[0]*s[0]+s[1]*s[1]+s[2]*s[2],a=2*(s[0]*n[0]+s[1]*n[1]+s[2]*n[2]),l=a*a-4*o*(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]-e[3]*e[3]);if(l<0)return!1;const c=Math.sqrt(l);let h=(-a-c)/(2*o);const p=(-a+c)/(2*o);return(h<0||p<h&&p>0)&&(h=p),!(h<0)&&(i&&(i[0]=r[0]+s[0]*h,i[1]=r[1]+s[1]*h,i[2]=r[2]+s[2]*h),!0)}const fMe=M();function cV(e,t){return B0(e,t,null)}function mMe(e,t,i){if(B0(e,t,i))return i;const r=jS(e,t,Ne.get());return pe(i,t.origin,ae(Ne.get(),t.direction,xi(t.origin,r)/Pe(t.direction))),i}function jS(e,t,i){const r=Ne.get(),s=pO.get();pt(r,t.origin,t.direction);const n=lF(e);pt(i,r,t.origin),ae(i,i,1/Pe(i)*n);const o=kue(e,t.origin),a=Bj(t.origin,i);return Tl(s,a+o,r),ke(i,i,s),i}function gMe(e,t,i){return B0(e,t,i)?i:(nMe(t,Tc(e),i),Fue(e,i,i))}function Fue(e,t,i){const r=de(Ne.get(),t,Tc(e)),s=ae(Ne.get(),r,e[3]/Pe(r));return pe(i,s,Tc(e))}function Uue(e,t){const i=de(Ne.get(),t,Tc(e)),r=Go(i),s=e[3]*e[3];return Math.sqrt(Math.abs(r-s))}function kue(e,t){const i=de(Ne.get(),t,Tc(e)),r=Pe(i),s=lF(e),n=s+Math.abs(s-r);return Rs(s/n)}const F5=M();function zue(e,t,i,r){const s=de(F5,t,Tc(e));switch(i){case mc.X:{const n=FX(s,F5)[2];return oe(r,-Math.sin(n),Math.cos(n),0)}case mc.Y:{const n=FX(s,F5),o=n[1],a=n[2],l=Math.sin(o);return oe(r,-l*Math.cos(a),-l*Math.sin(a),Math.cos(o))}case mc.Z:return be(r,s);default:return}}function Bue(e,t){const i=de(uV,t,Tc(e));return Pe(i)-e[3]}function yMe(e,t,i,r){const s=Bue(e,t),n=zue(e,t,mc.Z,uV),o=ae(uV,n,i-s);return pe(r,t,o)}const vMe=M(),uV=M(),_Me=Object.freeze({__proto__:null,create:xn,copy:qT,fromCenterAndRadius:Due,wrap:uMe,clear:Lue,fromRadius:hMe,getRadius:lF,getCenter:Tc,fromValues:Nue,elevate:dMe,setExtent:pMe,intersectRay:B0,intersectsRay:cV,intersectRayClosestSilhouette:mMe,closestPointOnSilhouette:jS,closestPoint:gMe,projectPoint:Fue,distanceToSilhouette:Uue,angleToSilhouette:kue,axisAt:zue,altitudeAt:Bue,setAltitudeAt:yMe});function ii(e=CMe){return[e[0],e[1],e[2],e[3]]}function bMe(e,t,i,r){return Vj(e,t,i,r,kj.get())}function cF(e,t){return Vj(t[0],t[1],t[2],t[3],e)}function Vj(e,t,i,r,s=ii()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function Vue(e,t,i){return ne(i,e),i[3]=t,i}function WT(e,t,i){const r=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=Math.abs(r-1)>1e-5&&r>1e-12?1/Math.sqrt(r):1;return i[0]=t[0]*s,i[1]=t[1]*s,i[2]=t[2]*s,i[3]=-(i[0]*e[0]+i[1]*e[1]+i[2]*e[2]),i}function co(e,t,i,r=ii()){const s=i[0]-t[0],n=i[1]-t[1],o=i[2]-t[2],a=e[0]-t[0],l=e[1]-t[1],c=e[2]-t[2],h=n*c-o*l,p=o*a-s*c,f=s*l-n*a,g=h*h+p*p+f*f,y=Math.abs(g-1)>1e-5&&g>1e-12?1/Math.sqrt(g):1;r[0]=h*y,r[1]=p*y,r[2]=f*y,r[3]=-(r[0]*e[0]+r[1]*e[1]+r[2]*e[2])}function Gue(e,t,i,r,s){if(e.count<3)return!1;e.getVec(i,_2);let n=r,o=!1;for(;n<e.count-1&&!o;)e.getVec(n,Eb),n++,o=!ll(_2,Eb);if(!o)return!1;for(n=Math.max(n,s),o=!1;n<e.count&&!o;)e.getVec(n,P_),n++,de(AM,_2,Eb),be(AM,AM),de(CM,Eb,P_),be(CM,CM),o=!ll(_2,P_)&&!ll(Eb,P_)&&Math.abs(_e(AM,CM))<wMe;return o?(co(_2,Eb,P_,t),!0):(i!==0||r!==1||s!==2)&&Gue(e,t,0,1,2)}const wMe=.99619469809,_2=M(),Eb=M(),P_=M(),AM=M(),CM=M();function hV(e,t,i){return t!==e&&cF(e,t),e[3]=-_e(e,i),e}function dV(e,t){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function WC(e,t,i,r){return pt(P_,t,e),WT(i,P_,r)}function Gmt(e,t,i,r){return uF(e,t,de(Ne.get(),i,t),RMe,r)}function db(e,t,i){return!!_(t)&&uF(e,t.origin,t.direction,OMe,i)}function xMe(e,t,i){return uF(e,t.origin,t.vector,mp.NONE,i)}function TMe(e,t,i){return uF(e,t.origin,t.vector,mp.CLAMP,i)}function jue(e,t){return tr(e,t)>=0}function SMe(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5];return e[0]*(e[0]>0?i:n)+e[1]*(e[1]>0?r:o)+e[2]*(e[2]>0?s:a)+e[3]>=0}function EMe(e,t){const i=_e(e,t.ray.direction),r=-tr(e,t.ray.origin);if(r<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return r>0;if((r<0||i<0)&&!(r<0&&i<0))return!0;const s=r/i;return i>0?s<t.c1&&(t.c1=s):s>t.c0&&(t.c0=s),t.c0<=t.c1}function AMe(e,t,i){const r=ae(Ne.get(),e,-e[3]),s=pV(e,de(Ne.get(),t,r),Ne.get());return pe(i,s,r),i}function pV(e,t,i){const r=ae(Ne.get(),e,_e(e,t));return de(i,t,r),i}function tr(e,t){return _e(e,t)+e[3]}function uF(e,t,i,r,s){const n=_e(e,i);if(n===0)return!1;let o=-(_e(e,t)+e[3])/n;return r&mp.CLAMP&&(o=Be(o,0,1)),!(!(r&mp.INFINITE_MIN)&&o<0||!(r&mp.INFINITE_MAX)&&o>1)&&(pe(s,t,ae(s,i,o)),!0)}function jmt(e){return e}const CMe=[0,0,1,0];var mp;(function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.INFINITE_MIN=4]="INFINITE_MIN",e[e.INFINITE_MAX=8]="INFINITE_MAX"})(mp||(mp={}));const RMe=mp.INFINITE_MIN|mp.INFINITE_MAX,OMe=mp.INFINITE_MAX,U5=he.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");class Hue{constructor(){this.plane=ii(),this.origin=M(),this.basis1=M(),this.basis2=M()}}function pb(e=ihe){return{plane:ii(e.plane),origin:As(e.origin),basis1:As(e.basis1),basis2:As(e.basis2)}}function MMe(e,t,i){const r=VMe.get();return r.origin=e,r.basis1=t,r.basis2=i,r.plane=bMe(0,0,0,0),hF(r),r}function HS(e,t=pb()){return Gj(e.origin,e.basis1,e.basis2,t)}function que(e,t){ne(t.origin,e.origin),ne(t.basis1,e.basis1),ne(t.basis2,e.basis2),cF(t.plane,e.plane)}function Gj(e,t,i,r=pb()){return ne(r.origin,e),ne(r.basis1,t),ne(r.basis2,i),hF(r),zMe(r,"fromValues()"),r}function hF(e){WC(e.basis2,e.basis1,e.origin,e.plane)}function Wue(e,t,i){e!==i&&HS(e,i);const r=ae(Ne.get(),Mm(e),t);return pe(i.origin,i.origin,r),i.plane[3]-=t,i}function PMe(e,t,i){return Xue(t,i),Wue(i,Wj(e,e.origin),i),i}function Xue(e,t=pb()){const i=(e[2]-e[0])/2,r=(e[3]-e[1])/2;return oe(t.origin,e[0]+i,e[1]+r,0),oe(t.basis1,i,0,0),oe(t.basis2,0,r,0),Vj(0,0,1,0,t.plane),t}function jj(e,t,i){return!!db(e.plane,t,i)&&ehe(e,i)}function IMe(e,t,i){if(jj(e,t,i))return i;const r=Yue(e,t,Ne.get());return pe(i,t.origin,ae(Ne.get(),t.direction,xi(t.origin,r)/Pe(t.direction))),i}function Yue(e,t,i){const r=kD.get();the(e,t,r,kD.get());let s=Number.POSITIVE_INFINITY;for(const n of Yj){const o=Xj(e,n,dF.get()),a=Ne.get();if(xMe(r,o,a)){const l=Um(Ne.get(),t.origin,a),c=Math.abs(Rs(_e(t.direction,l)));c<s&&(s=c,ne(i,a))}}return s===Number.POSITIVE_INFINITY?Zue(e,t,i):i}function Zue(e,t,i){if(jj(e,t,i))return i;const r=kD.get(),s=kD.get();the(e,t,r,s);let n=Number.POSITIVE_INFINITY;for(const o of Yj){const a=Xj(e,o,dF.get()),l=Ne.get();if(TMe(r,a,l)){const c=sMe(t,l);if(!jue(s,l))continue;c<n&&(n=c,ne(i,l))}}return Hj(e,t.origin)<n&&Que(e,t.origin,i),i}function Que(e,t,i){const r=AMe(e.plane,t,Ne.get()),s=xZ(SZ(e,e.basis1),r,-1,1,Ne.get()),n=xZ(SZ(e,e.basis2),r,-1,1,Ne.get());return de(i,pe(Ne.get(),s,n),e.origin),i}function Jue(e,t,i){const{origin:r,basis1:s,basis2:n}=e,o=de(Ne.get(),t,r),a=JA(s,o),l=JA(n,o),c=JA(Mm(e),o);return oe(i,a,l,c)}function Hj(e,t){const i=Jue(e,t,Ne.get()),{basis1:r,basis2:s}=e,n=Pe(r),o=Pe(s),a=Math.max(Math.abs(i[0])-n,0),l=Math.max(Math.abs(i[1])-o,0),c=i[2];return a*a+l*l+c*c}function $Me(e,t){return Math.sqrt(Hj(e,t))}function DMe(e,t){let i=Number.NEGATIVE_INFINITY;for(const r of Yj){const s=Xj(e,r,dF.get()),n=zj(s,t);n>i&&(i=n)}return Math.sqrt(i)}function qj(e,t){return jue(e.plane,t)&&ehe(e,t)}function LMe(e,t,i,r){return kMe(e,i,r)}function Wj(e,t){const i=-e.plane[3];return JA(Mm(e),t)-i}function NMe(e,t,i,r){const s=Wj(e,t),n=ae(BMe,Mm(e),i-s);return pe(r,t,n),r}function FMe(e,t){return ll(e.basis1,t.basis1)&&ll(e.basis2,t.basis2)&&ll(e.origin,t.origin)}function Kue(e,t,i){return e!==i&&HS(e,i),fr(Ab,t),Oa(Ab,Ab),ke(i.basis1,e.basis1,Ab),ke(i.basis2,e.basis2,Ab),ke(i.plane,e.plane,Ab),ke(i.origin,e.origin,t),hV(i.plane,i.plane,i.origin),i}function UMe(e,t,i,r){return e!==r&&HS(e,r),Tl(k5,t,i),ke(r.basis1,e.basis1,k5),ke(r.basis2,e.basis2,k5),hF(r),r}function Mm(e){return e.plane}function kMe(e,t,i){switch(t){case mc.X:ne(i,e.basis1),be(i,i);break;case mc.Y:ne(i,e.basis2),be(i,i);break;case mc.Z:ne(i,Mm(e))}return i}function ehe(e,t){const i=de(Ne.get(),t,e.origin),r=Go(e.basis1),s=Go(e.basis2),n=_e(e.basis1,i),o=_e(e.basis2,i);return-n-r<0&&n-r<0&&-o-s<0&&o-s<0}function SZ(e,t){const i=dF.get();return ne(i.origin,e.origin),ne(i.vector,t),i}function Xj(e,t,i){const{basis1:r,basis2:s,origin:n}=e,o=ae(Ne.get(),r,t.origin[0]),a=ae(Ne.get(),s,t.origin[1]);pe(i.origin,o,a),pe(i.origin,i.origin,n);const l=ae(Ne.get(),r,t.direction[0]),c=ae(Ne.get(),s,t.direction[1]);return ae(i.vector,pe(l,l,c),2),i}function zMe(e,t){Math.abs(_e(e.basis1,e.basis2)/(Pe(e.basis1)*Pe(e.basis2)))>1e-6&&U5.warn(t,"Provided basis vectors are not perpendicular"),Math.abs(_e(e.basis1,Mm(e)))>1e-6&&U5.warn(t,"Basis vectors and plane normal are not perpendicular"),Math.abs(-_e(Mm(e),e.origin)-e.plane[3])>1e-6&&U5.warn(t,"Plane offset is not consistent with plane origin")}function the(e,t,i,r){const s=Mm(e);WC(s,t.direction,t.origin,i),WC(i,s,t.origin,r)}const ihe={plane:ii(),origin:je(0,0,0),basis1:je(1,0,0),basis2:je(0,1,0)},kD=new Gm(ii),dF=new Gm(z0),BMe=M(),VMe=new Gm(()=>({origin:null,basis1:null,basis2:null,plane:null})),Yj=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],Ab=Te(),k5=Te(),GMe=Object.freeze({__proto__:null,BoundedPlaneClass:Hue,create:pb,wrap:MMe,copy:HS,copyWithoutVerify:que,fromValues:Gj,updateUnboundedPlane:hF,elevate:Wue,setExtent:PMe,fromAABoundingRect:Xue,intersectRay:jj,intersectRayClosestSilhouette:IMe,closestPointOnSilhouette:Yue,closestPoint:Zue,projectPoint:Que,projectPointLocal:Jue,distance2:Hj,distance:$Me,distanceToSilhouette:DMe,extrusionContainsPoint:qj,axisAt:LMe,altitudeAt:Wj,setAltitudeAt:NMe,equals:FMe,transform:Kue,rotate:UMe,normal:Mm,UP:ihe});function jMe(e){const{value:t,operations:i}=e;return{operations:i,value:i.create(t)}}function HMe(e,t,i){return e.operations.setExtent(e.value,t,i.value),i}function qMe(e){return{operations:e,value:e.create()}}function rhe(e,t,i=qMe(e)){return i.operations=e,e.copy(t,i.value),i}function WMe(e){return rhe(_Me,Nue(0,0,0,di(e).radius))}const EZ=2**50;function XMe(){return rhe(GMe,Gj([0,0,0],[EZ,0,0],[0,EZ,0]))}function YMe(e,t,i){return e.operations.axisAt(e.value,t,mc.Z,i)}function ZMe(e,t,i,r){return e.operations.axisAt(e.value,t,i,r)}function QMe(e,t,i){return e.operations.intersectRay(e.value,t,i)}function JMe(e,t,i){return e.operations.intersectRayClosestSilhouette(e.value,t,i)}function KMe(e,t){return e.operations.altitudeAt(e.value,t)}function she(e,t,i,r){return e.operations.setAltitudeAt(e.value,t,i,r)}function e3e(e,t,i,r){return t!==r&&Ur(r,t),oe(Cb,r[12],r[13],r[14]),she(e,Cb,i,Cb),r[12]=Cb[0],r[13]=Cb[1],r[14]=Cb[2],r}function z5(e,t,i){return e.operations.elevate(e.value,t,i.value)}const Cb=M();function AZ(e,t,i,r,s){return s[0]=_e(e,t),s[1]=_e(e,i),s[2]=_e(e,r),s}function fV(e,t,i,r,s){ne(i,e),ne(RM,t),be(RM,RM),pt(r,RM,i),pt(s,r,i)}function nhe(e,t){return e?eF(t):t.isGeographic?He.PlateCarree:t}const RM=M(),ohe=96;function Hmt(e,t){const i=t||e.extent,r=e.width,s=Cl(i&&i.spatialReference);return i&&r?i.width/r*s*$ce*ohe:0}function ahe(e,t){return e/(Cl(t)*$ce*ohe)}var CZ,zD,KA,RZ,I_;(function(e){e[e.Binary=0]="Binary",e[e.JSON=1]="JSON"})(CZ||(CZ={})),function(e){e[e.TreeIndex=0]="TreeIndex",e[e.TreeStats=1]="TreeStats",e[e.TreeData=2]="TreeData",e[e.BrickBundles=3]="BrickBundles",e[e.Section=4]="Section",e[e.VariableStats=5]="VariableStats"}(zD||(zD={})),function(e){e[e.None=1]="None",e[e.Front=2]="Front",e[e.Back=3]="Back"}(KA||(KA={})),function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(RZ||(RZ={})),function(e){e[e.None=0]="None",e[e.StaticSections=1]="StaticSections",e[e.Slices=2]="Slices",e[e.DynamicSections=4]="DynamicSections",e[e.GhostShell=8]="GhostShell",e[e.Isosurface=16]="Isosurface",e[e.Quality=32]="Quality",e[e.SunLocation=64]="SunLocation",e[e.StaticSectionSelection=128]="StaticSectionSelection",e[e.ExaggerationAndOffset=256]="ExaggerationAndOffset",e[e.CurrentTime=512]="CurrentTime",e[e.CurrentVariable=1024]="CurrentVariable",e[e.DeleteIsosurface=2048]="DeleteIsosurface",e[e.ContainerVisibility=4096]="ContainerVisibility",e[e.RenderMode=8192]="RenderMode",e[e.Optimization=16384]="Optimization"}(I_||(I_={}));function t3e(e){return new Promise(t=>import("./vxlLayer.26ce0764.js").then(i=>i.v).then(({default:i})=>{const r=i({locateFile:i3e,preinitializedWebGLContext:e,onRuntimeInitialized:()=>t(r)})})).catch(t=>Promise.reject(t))}function i3e(e){return ui(`esri/libs/vxl/${e}`)}var Le;(function(e){e[e.MATERIAL=0]="MATERIAL",e[e.MATERIAL_ALPHA=1]="MATERIAL_ALPHA",e[e.MATERIAL_DEPTH=2]="MATERIAL_DEPTH",e[e.MATERIAL_NORMAL=3]="MATERIAL_NORMAL",e[e.MATERIAL_DEPTH_SHADOWMAP_ALL=4]="MATERIAL_DEPTH_SHADOWMAP_ALL",e[e.MATERIAL_HIGHLIGHT=5]="MATERIAL_HIGHLIGHT",e[e.MATERIAL_DEPTH_SHADOWMAP_DEFAULT=6]="MATERIAL_DEPTH_SHADOWMAP_DEFAULT",e[e.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT=7]="MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT",e[e.MAX_PASS=8]="MAX_PASS"})(Le||(Le={}));var ve;(function(e){e[e.INTEGRATED_MESH=0]="INTEGRATED_MESH",e[e.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",e[e.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",e[e.OPAQUE_PLUGIN=3]="OPAQUE_PLUGIN",e[e.TRANSPARENT_MATERIAL=4]="TRANSPARENT_MATERIAL",e[e.TRANSPARENT_PLUGIN=5]="TRANSPARENT_PLUGIN",e[e.TRANSPARENT_TERRAIN=6]="TRANSPARENT_TERRAIN",e[e.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL=7]="TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL",e[e.OCCLUDED_TERRAIN=8]="OCCLUDED_TERRAIN",e[e.OCCLUDER_MATERIAL=9]="OCCLUDER_MATERIAL",e[e.TRANSPARENT_OCCLUDER_MATERIAL=10]="TRANSPARENT_OCCLUDER_MATERIAL",e[e.OCCLUSION_PIXELS=11]="OCCLUSION_PIXELS",e[e.POSTPROCESSING_ENVIRONMENT_OPAQUE=12]="POSTPROCESSING_ENVIRONMENT_OPAQUE",e[e.POSTPROCESSING_ENVIRONMENT_TRANSPARENT=13]="POSTPROCESSING_ENVIRONMENT_TRANSPARENT",e[e.LASERLINES=14]="LASERLINES",e[e.LASERLINES_CONTRAST_CONTROL=15]="LASERLINES_CONTRAST_CONTROL",e[e.HUD_MATERIAL=16]="HUD_MATERIAL",e[e.LABEL_MATERIAL=17]="LABEL_MATERIAL",e[e.LINE_CALLOUTS=18]="LINE_CALLOUTS",e[e.LINE_CALLOUTS_HUD_DEPTH=19]="LINE_CALLOUTS_HUD_DEPTH",e[e.DRAPED_MATERIAL=20]="DRAPED_MATERIAL",e[e.DRAPED_WATER=21]="DRAPED_WATER",e[e.VOXEL=22]="VOXEL",e[e.MAX_SLOTS=23]="MAX_SLOTS"})(ve||(ve={}));var Kt;function r3e(e,t,i={}){const r=lhe(e);for(;r.length>1;){const s=BD(t,r.shift(),i);if(_(s))return s}return s3e(t,r.shift(),i)}function lhe(e){const t=ue("esri-force-webgl");if(t===Kt.WEBGL1||t===Kt.WEBGL2)return[t];switch(e){case"2d":return[Kt.WEBGL1];case"3d":return[Kt.WEBGL2,Kt.WEBGL1]}}function s3e(e,t,i={}){if(!window.WebGLRenderingContext)return OZ(e,n3e),null;const r=BD(e,t,i);return R(r)&&OZ(e,o3e),r}function BD(e,t,i={}){const r=t===Kt.WEBGL1?["webgl","experimental-webgl","webkit-3d","moz-webgl"]:["webgl2"];let s=null;for(const n of r){try{s=e.getContext(n,i)}catch{}if(s)break}return s}function OZ(e,t){const i=e.parentNode;i&&(i.innerHTML='<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+t+"</div></div></td></tr></table>")}(function(e){e[e.WEBGL1=1]="WEBGL1",e[e.WEBGL2=2]="WEBGL2"})(Kt||(Kt={}));const n3e='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',o3e=`It doesn't appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>`;var bi,Tt,Ee,Cp,ft,ba,XT,ot,Li,Ui,Ge,ct,st,$e,nt,yt,Bo,ri,nc,qs,vr,ti;(function(e){e[e.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",e[e.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",e[e.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT"})(bi||(bi={})),function(e){e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.LINE_LOOP=2]="LINE_LOOP",e[e.LINE_STRIP=3]="LINE_STRIP",e[e.TRIANGLES=4]="TRIANGLES",e[e.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=6]="TRIANGLE_FAN"}(Tt||(Tt={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_COLOR=768]="SRC_COLOR",e[e.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",e[e.SRC_ALPHA=770]="SRC_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA=772]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",e[e.DST_COLOR=774]="DST_COLOR",e[e.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=32769]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA"}(Ee||(Ee={})),function(e){e[e.ADD=32774]="ADD",e[e.SUBTRACT=32778]="SUBTRACT",e[e.REVERSE_SUBTRACT=32779]="REVERSE_SUBTRACT"}(Cp||(Cp={})),function(e){e[e.ARRAY_BUFFER=34962]="ARRAY_BUFFER",e[e.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",e[e.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",e[e.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",e[e.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",e[e.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",e[e.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER"}(ft||(ft={})),function(e){e[e.FRONT=1028]="FRONT",e[e.BACK=1029]="BACK",e[e.FRONT_AND_BACK=1032]="FRONT_AND_BACK"}(ba||(ba={})),function(e){e[e.CW=2304]="CW",e[e.CCW=2305]="CCW"}(XT||(XT={})),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT"}(ot||(ot={})),function(e){e[e.NEVER=512]="NEVER",e[e.LESS=513]="LESS",e[e.EQUAL=514]="EQUAL",e[e.LEQUAL=515]="LEQUAL",e[e.GREATER=516]="GREATER",e[e.NOTEQUAL=517]="NOTEQUAL",e[e.GEQUAL=518]="GEQUAL",e[e.ALWAYS=519]="ALWAYS"}(Li||(Li={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=7680]="KEEP",e[e.REPLACE=7681]="REPLACE",e[e.INCR=7682]="INCR",e[e.DECR=7683]="DECR",e[e.INVERT=5386]="INVERT",e[e.INCR_WRAP=34055]="INCR_WRAP",e[e.DECR_WRAP=34056]="DECR_WRAP"}(Ui||(Ui={})),function(e){e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9729]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(Ge||(Ge={})),function(e){e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.REPEAT=10497]="REPEAT",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT"}(ct||(ct={})),function(e){e[e.TEXTURE_2D=3553]="TEXTURE_2D",e[e.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",e[e.TEXTURE_3D=32879]="TEXTURE_3D",e[e.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",e[e.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",e[e.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",e[e.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",e[e.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY"}(st||(st={})),function(e){e[e.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",e[e.DEPTH_STENCIL=34041]="DEPTH_STENCIL",e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",e[e.RED=6403]="RED",e[e.RG=33319]="RG",e[e.RED_INTEGER=36244]="RED_INTEGER",e[e.RG_INTEGER=33320]="RG_INTEGER",e[e.RGB_INTEGER=36248]="RGB_INTEGER",e[e.RGBA_INTEGER=36249]="RGBA_INTEGER"}($e||($e={})),function(e){e[e.RGBA4=32854]="RGBA4",e[e.R16F=33325]="R16F",e[e.RG16F=33327]="RG16F",e[e.RGB32F=34837]="RGB32F",e[e.RGBA16F=34842]="RGBA16F",e[e.R32F=33326]="R32F",e[e.RG32F=33328]="RG32F",e[e.RGBA32F=34836]="RGBA32F",e[e.R11F_G11F_B10F=35898]="R11F_G11F_B10F",e[e.RGB8=32849]="RGB8",e[e.RGBA8=32856]="RGBA8",e[e.RGB5_A1=32855]="RGB5_A1",e[e.R8=33321]="R8",e[e.RG8=33323]="RG8",e[e.R8I=33329]="R8I",e[e.R8UI=33330]="R8UI",e[e.R16I=33331]="R16I",e[e.R16UI=33332]="R16UI",e[e.R32I=33333]="R32I",e[e.R32UI=33334]="R32UI",e[e.RG8I=33335]="RG8I",e[e.RG8UI=33336]="RG8UI",e[e.RG16I=33337]="RG16I",e[e.RG16UI=33338]="RG16UI",e[e.RG32I=33339]="RG32I",e[e.RG32UI=33340]="RG32UI",e[e.RGB16F=34843]="RGB16F",e[e.RGB9_E5=35901]="RGB9_E5",e[e.SRGB8=35905]="SRGB8",e[e.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",e[e.RGB565=36194]="RGB565",e[e.RGBA32UI=36208]="RGBA32UI",e[e.RGB32UI=36209]="RGB32UI",e[e.RGBA16UI=36214]="RGBA16UI",e[e.RGB16UI=36215]="RGB16UI",e[e.RGBA8UI=36220]="RGBA8UI",e[e.RGB8UI=36221]="RGB8UI",e[e.RGBA32I=36226]="RGBA32I",e[e.RGB32I=36227]="RGB32I",e[e.RGBA16I=36232]="RGBA16I",e[e.RGB16I=36233]="RGB16I",e[e.RGBA8I=36238]="RGBA8I",e[e.RGB8I=36239]="RGB8I",e[e.R8_SNORM=36756]="R8_SNORM",e[e.RG8_SNORM=36757]="RG8_SNORM",e[e.RGB8_SNORM=36758]="RGB8_SNORM",e[e.RGBA8_SNORM=36759]="RGBA8_SNORM",e[e.RGB10_A2=32857]="RGB10_A2",e[e.RGB10_A2UI=36975]="RGB10_A2UI"}(nt||(nt={})),function(e){e[e.FLOAT=5126]="FLOAT",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",e[e.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",e[e.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",e[e.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.INT=5124]="INT",e[e.HALF_FLOAT=5131]="HALF_FLOAT",e[e.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",e[e.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",e[e.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",e[e.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV"}(yt||(yt={})),function(e){e[e.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",e[e.STENCIL_INDEX8=36168]="STENCIL_INDEX8",e[e.DEPTH_STENCIL=34041]="DEPTH_STENCIL",e[e.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",e[e.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",e[e.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",e[e.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8"}(Bo||(Bo={})),function(e){e[e.STATIC_DRAW=35044]="STATIC_DRAW",e[e.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",e[e.STREAM_DRAW=35040]="STREAM_DRAW",e[e.STATIC_READ=35045]="STATIC_READ",e[e.DYNAMIC_READ=35049]="DYNAMIC_READ",e[e.STREAM_READ=35041]="STREAM_READ",e[e.STATIC_COPY=35046]="STATIC_COPY",e[e.DYNAMIC_COPY=35050]="DYNAMIC_COPY",e[e.STREAM_COPY=35042]="STREAM_COPY"}(ri||(ri={})),function(e){e[e.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",e[e.VERTEX_SHADER=35633]="VERTEX_SHADER"}(nc||(nc={})),function(e){e[e.FRAMEBUFFER=36160]="FRAMEBUFFER",e[e.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",e[e.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER"}(qs||(qs={})),function(e){e[e.TEXTURE=0]="TEXTURE",e[e.RENDER_BUFFER=1]="RENDER_BUFFER",e[e.CUBEMAP=2]="CUBEMAP"}(vr||(vr={})),function(e){e[e.NONE=0]="NONE",e[e.DEPTH_RENDER_BUFFER=1]="DEPTH_RENDER_BUFFER",e[e.STENCIL_RENDER_BUFFER=2]="STENCIL_RENDER_BUFFER",e[e.DEPTH_STENCIL_RENDER_BUFFER=3]="DEPTH_STENCIL_RENDER_BUFFER",e[e.DEPTH_STENCIL_TEXTURE=4]="DEPTH_STENCIL_TEXTURE"}(ti||(ti={}));const B5=33984;var ks,ql;(function(e){e[e.Texture=0]="Texture",e[e.Buffer=1]="Buffer",e[e.VAO=2]="VAO",e[e.Shader=3]="Shader",e[e.Program=4]="Program",e[e.Framebuffer=5]="Framebuffer",e[e.Renderbuffer=6]="Renderbuffer",e[e.Sync=7]="Sync",e[e.COUNT=8]="COUNT"})(ks||(ks={})),function(e){e[e.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",e[e.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",e[e.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",e[e.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",e[e.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",e[e.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",e[e.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",e[e.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",e[e.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",e[e.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",e[e.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",e[e.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",e[e.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",e[e.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",e[e.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",e[e.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15"}(ql||(ql={}));const MZ=33306;var Ar,Fo,PZ,IZ,VD,mV,$Z;(function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC"})(Ar||(Ar={})),function(e){e[e.FLOAT=5126]="FLOAT",e[e.FLOAT_VEC2=35664]="FLOAT_VEC2",e[e.FLOAT_VEC3=35665]="FLOAT_VEC3",e[e.FLOAT_VEC4=35666]="FLOAT_VEC4",e[e.INT=5124]="INT",e[e.INT_VEC2=35667]="INT_VEC2",e[e.INT_VEC3=35668]="INT_VEC3",e[e.INT_VEC4=35669]="INT_VEC4",e[e.BOOL=35670]="BOOL",e[e.BOOL_VEC2=35671]="BOOL_VEC2",e[e.BOOL_VEC3=35672]="BOOL_VEC3",e[e.BOOL_VEC4=35673]="BOOL_VEC4",e[e.FLOAT_MAT2=35674]="FLOAT_MAT2",e[e.FLOAT_MAT3=35675]="FLOAT_MAT3",e[e.FLOAT_MAT4=35676]="FLOAT_MAT4",e[e.SAMPLER_2D=35678]="SAMPLER_2D",e[e.SAMPLER_CUBE=35680]="SAMPLER_CUBE",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",e[e.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",e[e.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",e[e.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",e[e.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",e[e.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",e[e.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",e[e.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",e[e.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",e[e.SAMPLER_3D=35679]="SAMPLER_3D",e[e.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",e[e.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",e[e.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",e[e.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",e[e.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",e[e.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",e[e.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",e[e.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",e[e.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",e[e.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",e[e.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",e[e.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY"}(Fo||(Fo={})),function(e){e[e.OBJECT_TYPE=37138]="OBJECT_TYPE",e[e.SYNC_CONDITION=37139]="SYNC_CONDITION",e[e.SYNC_STATUS=37140]="SYNC_STATUS",e[e.SYNC_FLAGS=37141]="SYNC_FLAGS"}(PZ||(PZ={})),function(e){e[e.UNSIGNALED=37144]="UNSIGNALED",e[e.SIGNALED=37145]="SIGNALED"}(IZ||(IZ={})),function(e){e[e.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",e[e.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",e[e.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",e[e.WAIT_FAILED=37149]="WAIT_FAILED"}(VD||(VD={})),function(e){e[e.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE"}(mV||(mV={})),function(e){e[e.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT"}($Z||($Z={}));const b2=he.getLogger("esri.layers.VoxelWasmPerScene");var Pi;(function(e){e[e.Lifetime=1]="Lifetime",e[e.RequestResponse=2]="RequestResponse",e[e.Rendering=3]="Rendering",e[e.Error=4]="Error"})(Pi||(Pi={}));class a3e{constructor(t){this._halfIntTexturesAvailable=!1,this._havePreparedWithAllLayers=!1,this._renderPluginContext=null,this._vxl=null,this._pluginIsActive=!1,this._moreToLoad=!1,this._viewportWidth=-1,this._viewportHeight=-1,this._newLayers=[],this._layers=new Map,this._renderPass=Le.MATERIAL,this._renderSlot=ve.VOXEL,this._rctx=null,this._renderTargetToRestore=null,this._lastFrameWasStationary=!1,this._wasmMemBlockSizes=[512,1024,2048,4096,8192,16384,32768,65536],this._wasmMemBlocks=new Map,this._dbgFlags=new Set,this._view=t,this._initialize()}get canRender(){return!!this._vxl&&this._view.viewingMode==="local"}_dbg(t,i){this._dbgFlags.has(t)&&(t===Pi.Error?b2.error(i):b2.warn(i))}_removeRenderPlugin(){this._pluginIsActive&&this._view._stage&&(this._dbg(Pi.Lifetime,"--removeRenderPlugin--"),this._view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1}_initialize(){this._dbg(Pi.Lifetime,"--initialize--");for(const t of this._wasmMemBlockSizes)this._wasmMemBlocks.set(t,0);this._readyWatchHandle=Nt(()=>this._view.ready,t=>{t&&this._view.viewingMode==="local"?(this._dbg(Pi.Lifetime,"view ready status changed to ready on a local view, calling addRenderPlugin"),this._view._stage.addRenderPlugin([this._renderSlot],this),this._pluginIsActive=!0):(this._dbg(Pi.Lifetime,"view ready status changed, not ready or not a local view!"),this._removeRenderPlugin())},{initial:!0}),this._qualityWatchHandle=Nt(()=>{var t;return(t=this._view)==null?void 0:t.qualityProfile},t=>{this._dbg(Pi.Rendering,"qualityProfile changed to "+t),this._vxl&&this._vxl.set_quality(this._toWasmQuality(t))},{initial:!0}),this._timeExtentWatchHandle=Nt(()=>{var t;return(t=this._view)==null?void 0:t.timeExtent},()=>{if(this._vxl){var t;const i=this._getTimeArgs((t=this._view)==null?void 0:t.timeExtent);this._dbg(Pi.Rendering,"sceneView timeExtent changed to useTime="+i.useTime+" st="+i.startTime+" et="+i.endTime),this._vxl.set_scene_time_extent(i.startTime,i.endTime,i.useTime),this._renderPluginContext.requestRender()}},{initial:!0}),this._stationaryWatchHandle=Nt(()=>{var t;return(t=this._view)==null?void 0:t.stationary},t=>{this._vxl&&t&&!this._lastFrameWasStationary&&this._renderPluginContext.requestRender()})}initializeRenderContext(t){this._dbg(Pi.Lifetime,"--initializeRenderContext--");const i=t.renderContext.rctx;i.type===Kt.WEBGL2?(this._renderPluginContext=t,this._rctx=t.renderContext.rctx,this._halfIntTexturesAvailable=!!this._rctx.capabilities.textureNorm16,this._initializeWasm(i.gl)):this._dbg(Pi.Error,"WebGL 1 context only!")}uninitializeRenderContext(){this._renderPluginContext=null,this._rctx=null,this._dbg(Pi.Lifetime,"--uninitializeRenderContext--")}_restoreFramebuffer(){if(!this._renderTargetToRestore)return;const t=this._renderTargetToRestore.fbo;if(!this._rctx)return void this._dbg(Pi.Error,"no context in restoreFramebuffer!");this._rctx.bindFramebuffer(t,!0);const i=this._renderTargetToRestore.viewport;this._rctx.setViewport(i.x,i.y,i.width,i.height)}_bindPreviousDepthToSlot(t,i){const r=!!this._rctx,s=!!this._renderTargetToRestore;if(!r||!s)return 0;const n=this._renderTargetToRestore.fbo.depthStencilTexture;return n?(i===0?this._rctx.bindTexture(null,t,!0):this._rctx.bindTexture(n,t,!0),1):(this._dbg(Pi.Error,"no depth/stencil texture exists!"),0)}_modifyResourceCount(t,i,r){if(!this._rctx)return void this._dbg(Pi.Error,"modifyAllocation callback has no rendering context!");const s=t;r===1?this._rctx.instanceCounter.increment(s,i):this._rctx.instanceCounter.decrement(s,i)}_setBlendState(t,i,r,s){this._rctx?(this._rctx.setBlendingEnabled(t===1),this._rctx.setBlendFunction(i,r),this._rctx.setBlendEquation(s)):this._dbg(Pi.Error,"setBlendState callback has no rendering context!")}_setFrontFace(t){this._rctx?this._rctx.setFrontFace(t):this._dbg(Pi.Error,"setFrontFace callback has no rendering context!")}_setDepthStencilStateFunction(t,i,r){this._rctx?(this._rctx.setDepthFunction(r),this._rctx.setDepthTestEnabled(t===1),this._rctx.setDepthWriteEnabled(i===1),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(Li.ALWAYS,0,255),this._rctx.setStencilOpSeparate(ba.FRONT,Ui.KEEP,Ui.INCR,Ui.KEEP),this._rctx.setStencilOpSeparate(ba.BACK,Ui.KEEP,Ui.DECR,Ui.KEEP)):this._dbg(Pi.Error,"setDepthStencilStateFunction callback has no rendering context!")}_setRasterizerState(t){if(this._rctx)switch(t){case KA.None:this._rctx.setFaceCullingEnabled(!1);break;case KA.Back:this._rctx.setCullFace(ba.BACK),this._rctx.setFaceCullingEnabled(!0);break;case KA.Front:this._rctx.setCullFace(ba.FRONT),this._rctx.setFaceCullingEnabled(!0)}else this._dbg(Pi.Error,"setRasterizerState callback has no rendering context!")}_setViewport(t,i,r,s){this._rctx?this._rctx.setViewport(t,i,r,s):this._dbg(Pi.Error,"setViewport callback has no rendering context!")}_updateMemoryUsage(){this._layers.forEach((t,i)=>{if(t.needMemoryUsageUpdate){const r=this._vxl.estimate_memory_usage(i);r>=0&&(t.needMemoryUsageUpdate=!1,t.layerView.setUsedMemory(r))}})}_syncRequestsResponses(){this._layers.forEach((t,i)=>{const r=[];t.responses.forEach((a,l)=>{r.push(l),this._dbg(Pi.RequestResponse,"responding for requestID:"+l+" size:"+a.size),this._vxl.respond(i,l,a),a.requestType!==zD.TreeIndex&&a.requestType!==zD.Section||(t.needMemoryUsageUpdate=!0)});const s=t.responses;for(const a of r)s.delete(a);const n=this._vxl.get_new_requests(i),o=t.abortController.signal;for(const a in n){t.outstandingRequestCount+=1,t.outstandingRequestCount===1&&t.layerView.updatingFlagChanged();const l=n[a],c={responseType:"array-buffer",signal:o};this._dbg(Pi.RequestResponse,"making requestID:"+a+" url:"+l.url),Ti(l.url,c).then(h=>{t.outstandingRequestCount-=1,t.outstandingRequestCount===0&&t.layerView.updatingFlagChanged(),this._dbg(Pi.RequestResponse,"have response for requestID:"+a);let p=0;if(h.data.byteLength>0){p=this._vxl._malloc(h.data.byteLength);const f=new Uint8Array(this._vxl.HEAPU8.buffer,p,h.data.byteLength),g=new Uint8Array(h.data);for(let y=0;y<h.data.byteLength;++y)f[y]=g[y]}s.set(+a,{responseType:l.responseType,ptr:p,size:h.data.byteLength,success:!0,requestType:l.requestType})}).catch(h=>{t.outstandingRequestCount-=1,t.outstandingRequestCount===0&&t.layerView.updatingFlagChanged(),pr(h)||(this._dbg(Pi.Error,`requestID:${a} failed, error=${h.toString()}`),s.set(+a,{responseType:l.responseType,ptr:0,size:0,success:!1,requestType:l.requestType}))})}})}updateWasmCamera(t){this._vxl.set_projection_matrix.apply(this._vxl,t.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,t.viewMatrix),this._vxl.set_near_far(t.near,t.far)}isUpdating(t){return!(this._vxl||!this._vxlPromise)||!!this._layers.has(t)&&this._layers.get(t).outstandingRequestCount>0}setEnabled(t,i){this._layers.forEach((r,s)=>{r.layerView===t&&(this._vxl.set_enabled(s,i),this._renderPluginContext.requestRender())})}setSlices(t,i){const r={mask:I_.Slices,slices:{planes:i,currentEditPlane:-1}};return this._doMaskedUIUpdate(t,r,!0)}setDynamicSections(t,i){const r={mask:I_.DynamicSections,dynamicSections:{planes:i,currentEditPlane:-1}};return this._doMaskedUIUpdate(t,r,!0)}setStaticSections(t,i){const r={mask:I_.StaticSections,staticSections:i};return this._doMaskedUIUpdate(t,r,!0)}setCurrentVariable(t,i){const r={mask:I_.CurrentVariable,currentVariable:i};return this._doMaskedUIUpdate(t,r,!0)}setRenderMode(t,i){const r={mask:I_.RenderMode,renderMode:i};return this._doMaskedUIUpdate(t,r,!0)}_doMaskedUIUpdate(t,i,r){if(!this._vxl)return!1;let s=!1;return this._layers.forEach((n,o)=>{if(n.layerView===t){const a={str:JSON.stringify(i),byteCount:0,ptr:0,isReusable:!1};this._allocateBlock(a)&&(s=this._vxl.handle_masked_ui_update(o,a.ptr,a.byteCount)===1,a.isReusable||this._vxl._free(a.ptr))}}),s&&r&&this._renderPluginContext.requestRender(),s}addVoxelLayer(t){if(!this._vxl){const r={layerView:t,resolveCallback:null,rejectCallback:null},s=new Promise((n,o)=>{r.resolveCallback=n,r.rejectCallback=o});return this._newLayers.push(r),s}const i=this._addVoxelLayer(t);return i<0?Promise.reject(-1):Promise.resolve(i)}removeVoxelLayer(t){if(!this._vxl){const s=this._newLayers.findIndex(o=>t===o.layerView);s>=0&&(this._newLayers[s].resolveCallback(-1),this._newLayers.splice(s,1));const n=this._newLayers.length;return n===0&&(this._dbg(Pi.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),n}let i=-1;this._layers.forEach((s,n)=>{s.layerView===t&&(i=n,s.abortController.abort(),this._vxl.remove_layer(i))}),i>=0&&this._layers.delete(i);const r=this._layers.size;return r===0&&(this._dbg(Pi.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),r}_getBlockSize(t){for(const i of this._wasmMemBlockSizes)if(t<i)return i;return-1}_allocateBlock(t){t.byteCount=this._vxl.lengthBytesUTF8(t.str)+1;const i=this._getBlockSize(t.byteCount);return i<0?(t.isReusable=!1,t.ptr=this._vxl._malloc(t.byteCount)):(t.isReusable=!0,t.ptr=this._wasmMemBlocks.get(i),t.ptr===0&&(t.ptr=this._vxl._malloc(i),this._wasmMemBlocks.set(i,t.ptr))),t.ptr!==0&&(this._vxl.stringToUTF8(t.str,t.ptr,t.byteCount),!0)}_getTimeArgs(t){let i=-Number.MAX_VALUE,r=Number.MAX_VALUE,s=!1;return _(t)&&(t.isAllTime?s=!0:(_(t.start)&&(s=!0,i=t.start.getTime()/1e3),_(t.end)&&(s=!0,r=t.end.getTime()/1e3))),{startTime:i,endTime:r,useTime:s}}_addVoxelLayer(t){var i;const r=t.layer;let s=-1;const n=r.getConfiguration();if(n.length<1)return-1;const o={str:n,byteCount:0,ptr:0,isReusable:!1};if(!this._allocateBlock(o))return-1;const a=this._getTimeArgs((i=this._view)==null?void 0:i.timeExtent),l=this._view.spatialReference.isWGS84&&r.spatialReference.isWGS84?111319.49079327357:1;if(s=this._vxl.add_layer(r.serviceRoot,o.ptr,o.byteCount,l,l,a.startTime,a.endTime,a.useTime,this._toWasmQuality(this._view.qualityProfile)),o.isReusable||this._vxl._free(o.ptr),s>=0){const c=new AbortController;if(this._layers.set(s,{layerView:t,responses:new Map,outstandingRequestCount:0,abortController:c,needMemoryUsageUpdate:!1}),!this._halfIntTexturesAvailable||ue("mac")){const h=[];let p="";for(const f of t.layer.variables)f.renderingFormat.type!=="Int16"&&f.renderingFormat.type!=="UInt16"||(h.push(f.name),f.id===t.layer.style.currentVariableId&&(p=f.name));p!==""&&b2.error("#addVoxelLayer_error()",t.layer,`The voxel layer '${t.layer.title}' cannot render the current variable '${p}' in this browser`),h.length>0&&b2.warn("#addVoxelLayer_warning()",t.layer,`The voxel layer '${t.layer.title}' cannot render the variables '${h.toString()}' in this browser`)}return ue("esri-mobile")&&b2.warnOnce("Mobile support differs across devices. Voxel layer might not display as expected."),s}return-1}prepareRender(t){if(!this._vxl)return;const i=t.viewForward,r=t.eye;this._vxl.update_camera_pos_and_direction(r[0],r[1],r[2],i[0],i[1],i[2]);const s=this._vxl.cull();this._dbg(Pi.RequestResponse,"missingResourceCount="+s),this._moreToLoad=s>0,this._havePreparedWithAllLayers=this._newLayers.length===0,this._updateMemoryUsage()}render(t){if(!this._vxl||t.pass!==this._renderPass||t.slot!==this._renderSlot)return;for(const r of this._newLayers){const s=this._addVoxelLayer(r.layerView);s===-1?r.rejectCallback(-1):r.resolveCallback(s)}if(this._newLayers=[],this._layers.size===0)return void this._dbg(Pi.Error,"No voxel layers but RenderPlugin instance is being asked to render!");this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this._syncRequestsResponses(),this._lastFrameWasStationary=this._view.stationary,this._rctx.setPolygonOffsetFillEnabled(!1),this._rctx.setScissorTestEnabled(!1),this._rctx.setColorMask(!0,!0,!0,!0),this._vxl.begin_color_frame(!this._view.stationary||this._moreToLoad,t.scenelightingData.lightingMainDirection[0],t.scenelightingData.lightingMainDirection[1],t.scenelightingData.lightingMainDirection[2]);const i=this._renderTargetToRestore.viewport;i.width===this._viewportWidth&&i.height===this._viewportHeight||(this._viewportWidth=i.width,this._viewportHeight=i.height,this._vxl.set_viewport(i.width,i.height),this._layers.forEach(r=>{r.needMemoryUsageUpdate=!0})),i.x===0&&i.y===0||this._dbg(Pi.Error,"Unsupported viewport parameters detected!"),this.updateWasmCamera(t.camera),this._vxl.draw(),this._renderTargetToRestore.fbo=null,t.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),t.rctx.externalVertexArrayObjectUpdate(),t.rctx.externalVertexBufferUpdate(),this._rctx.externalProgramUpdate(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender()}destroy(){this._dbg(Pi.Lifetime,"--destroy--"),this._removeRenderPlugin(),this._readyWatchHandle=Js(this._readyWatchHandle),this._qualityWatchHandle=Js(this._qualityWatchHandle),this._timeExtentWatchHandle=Js(this._timeExtentWatchHandle),this._stationaryWatchHandle=Js(this._stationaryWatchHandle),this._vxl&&(this._layers.forEach(t=>{t.abortController.abort()}),this._wasmMemBlocks.forEach(t=>{t!==0&&this._vxl._free(t)}),this._vxl.uninitialize_voxel_wasm(),this._vxl=null)}_initializeWasm(t){return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=t3e(t).then(i=>{var r;if(this._vxl=i,this._vxlPromise=null,this._newLayers.length<=0)return this._dbg(Pi.Lifetime," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),void this.destroy();const s=this._getTimeArgs((r=this._view)==null?void 0:r.timeExtent),n=this._vxl.addFunction(this._restoreFramebuffer.bind(this),"v"),o=this._vxl.addFunction(this._setBlendState.bind(this),"viiii"),a=this._vxl.addFunction(this._setFrontFace.bind(this),"vi"),l=this._vxl.addFunction(this._setRasterizerState.bind(this),"vi"),c=this._vxl.addFunction(this._setDepthStencilStateFunction.bind(this),"viii"),h=this._vxl.addFunction(this._setViewport.bind(this),"viiii"),p=this._vxl.addFunction(this._bindPreviousDepthToSlot.bind(this),"iii"),f=this._vxl.addFunction(this._modifyResourceCount.bind(this),"viii"),g=this._halfIntTexturesAvailable&&!ue("mac");this._vxl.initialize_voxel_wasm(n,o,a,l,c,h,p,f,s.startTime,s.endTime,s.useTime,g),this._renderPluginContext&&this._renderPluginContext.requestRender()}).catch(()=>{for(const i of this._newLayers)i.rejectCallback(-2);this._dbg(Pi.Error," WASM failed to download, removing RenderPlugin and destroying"),this.destroy()})),this._vxlPromise)}pickDepth(t,i,r){if(!this._vxl||!this._rctx||this._layers.size===0)return null;const s=r.viewport[3]-i;if(t<0||t>r.viewport[2]||i<0||i>r.viewport[3])return this._dbg(Pi.Error,`pickDepth: outOfRange, screenXY=[${t}, ${s}], vp=[${r.viewport.toString()}]`),null;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};const n=r.viewForward,o=r.eye;this._vxl.update_camera_pos_and_direction(o[0],o[1],o[2],n[0],n[1],n[2]),this.updateWasmCamera(r),this._vxl.begin_frame();const a=this._vxl.pick_depth(t,s);return this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate(),this._rctx.externalProgramUpdate(),a.success?a.distanceToCamera:null}_toWasmQuality(t){switch(t){case"low":return 0;case"medium":return 1;case"high":return 2}}}class Ax{constructor(){this.view2WASM=new Map}static getInstance(){return Ax.instance||(Ax.instance=new Ax),Ax.instance}getVoxelWasmPerSceneView(t){return this.view2WASM.has(t)?this.view2WASM.get(t):null}isUpdating(t,i){return!!this.view2WASM.has(t)&&this.view2WASM.get(t).isUpdating(i)}addLayer(t,i){return this.view2WASM.has(t)||this.view2WASM.set(t,new a3e(t)),this.view2WASM.get(t).addVoxelLayer(i)}removeLayer(t,i){this.view2WASM.has(t)&&this.view2WASM.get(t).removeVoxelLayer(i)<1&&this.view2WASM.delete(t)}setLayerEnabled(t,i,r){this.view2WASM.has(t)&&this.view2WASM.get(t).setEnabled(i,r)}setLayerSlices(t,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===t&&(r=s.setSlices(o,i))})}),r}setLayerDynamicSections(t,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===t&&(r=s.setDynamicSections(o,i))})}),r}setLayerCurrentVariable(t,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===t&&(r=s.setCurrentVariable(o,i))})}),r}setLayerRenderMode(t,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===t&&(r=s.setRenderMode(o,i))})}),r}setLayerStaticSections(t,i){let r=!1;return this.view2WASM.forEach((s,n)=>{n.allLayerViews.filter(o=>o.type==="voxel-3d").forEach(o=>{o.layer===t&&(r=s.setStaticSections(o,i))})}),r}}function eC(e){return e&&e.type==="base-tile"||e.type==="tile"||e.type==="elevation"||e.type==="imagery-tile"||e.type==="base-elevation"||e.type==="open-street-map"||e.type==="wcs"||e.type==="web-tile"||e.type==="wmts"||e.type==="vector-tile"}function DZ(e){return e&&e.type==="imagery-tile"}function l3e(e){return e&&e.type==="wmts"}function LZ(e){return e&&e.type==="voxel"}function che(e){return e.parent&&e.parent.declaredClass==="esri.Basemap"&&e.parent.baseLayers.indexOf(e)>-1}function gV(e){return e.labelsVisible===!0&&e.labelingInfo!=null&&e.labelingInfo.length>0}function c3e(e){if(e.activeLayer){const t=e.activeLayer.tileMatrixSet;if(t)return t;const i=e.activeLayer.tileMatrixSets;if(i)return i}return null}const u3e=he.getLogger("esri.support.AnalysesCollection");let YT=class extends YA{constructor(e){super(e),this.handles.add(this.on("before-add",t=>{R(t.item)||t.item.parent===this.owner&&(u3e.warn("Analysis inside the collection must be unique. Not adding this element again."),t.preventDefault())}))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};YT=u([P("esri.support.AnalysesCollection")],YT);const CI={widthBreakpoint:{getValue(e){const t=e.viewSize[0],i=e.breakpoints,r=this.values;return t<=i.xsmall?r.xsmall:t<=i.small?r.small:t<=i.medium?r.medium:t<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(e){const t=e.viewSize[1],i=e.breakpoints,r=this.values;return t<=i.xsmall?r.xsmall:t<=i.small?r.small:t<=i.medium?r.medium:t<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(e){const t=e.viewSize,i=t[0],r=t[1],s=this.values;return r>=i?s.portrait:s.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},V5={xsmall:544,small:768,medium:992,large:1200};function h3e(e){const t=e;return t&&t.xsmall<t.small&&t.small<t.medium&&t.medium<t.large}function G5(e,t){return t?CI[e].valueToClassName[t].split(" "):[]}const d3e=e=>{let t=class extends e{constructor(...i){super(...i),this._breakpointsHandles=new Ut,this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=V5}initialize(){this._breakpointsHandles.add(Nt(()=>[this.breakpoints,this.size],()=>this._updateClassNames(),fn))}destroy(){this.destroyed||(this._removeActiveClassNames(),this._breakpointsHandles=rt(this._breakpointsHandles))}set breakpoints(i){if(i===this._get("breakpoints"))return;const r=h3e(i);if(!r){const s=JSON.stringify(V5,null,2);console.warn("provided breakpoints are not valid, using defaults:"+s)}i=r?i:V5,this._set("breakpoints",I({},i))}_updateClassNames(){if(!this.container)return;const i=il.acquire(),r=il.acquire();let s,n=!1;for(s in CI){const o=this[s],a=CI[s].getValue({viewSize:this.size,breakpoints:this.breakpoints});o!==a&&(n=!0,this[s]=a,G5(s,o).forEach(l=>r.push(l)),G5(s,a).forEach(l=>i.push(l)))}n&&(this._applyClassNameChanges(i,r),il.release(i),il.release(r))}_applyClassNameChanges(i,r){const s=this.container;s&&(r.forEach(n=>s.classList.remove(n)),i.forEach(n=>s.classList.add(n)))}_removeActiveClassNames(){const i=this.container;if(!i)return;let r;for(r in CI)G5(r,this[r]).forEach(s=>i.classList.remove(s))}};return u([d()],t.prototype,"breakpoints",null),u([d()],t.prototype,"orientation",void 0),u([d()],t.prototype,"widthBreakpoint",void 0),u([d()],t.prototype,"heightBreakpoint",void 0),t=u([P("esri.views.BreakpointsOwner")],t),t};/*!
 * @esri/arcgis-html-sanitizer - v2.9.0 - Mon Dec 13 2021 15:07:01 GMT-0500 (Eastern Standard Time)
 * Copyright (c) 2021 - Environmental Systems Research Institute, Inc.
 * Apache-2.0
 * 
 * js-xss
 * Copyright (c) 2012-2017 Zongmin Lei() <leizongmin@gmail.com>
 * http://ucdok.com
 * MIT License, see https://github.com/leizongmin/js-xss/blob/master/LICENSE for details
 * 
 * Lodash/isPlainObject
 * Copyright (c) JS Foundation and other contributors <https://js.foundation/>
 * MIT License, see https://raw.githubusercontent.com/lodash/lodash/4.17.10-npm/LICENSE for details
 */var p3e="[object Object]";function f3e(e){var t=!1;if(e!=null&&typeof e.toString!="function")try{t=!!(e+"")}catch{}return t}function m3e(e,t){return function(i){return e(t(i))}}var g3e=Function.prototype,uhe=Object.prototype,hhe=g3e.toString,y3e=uhe.hasOwnProperty,v3e=hhe.call(Object),_3e=uhe.toString,b3e=m3e(Object.getPrototypeOf,Object);function w3e(e){return!!e&&typeof e=="object"}function x3e(e){if(!w3e(e)||_3e.call(e)!=p3e||f3e(e))return!1;var t=b3e(e);if(t===null)return!0;var i=y3e.call(t,"constructor")&&t.constructor;return typeof i=="function"&&i instanceof i&&hhe.call(i)==v3e}var T3e=x3e,Cx={exports:{}},hs={},XC={exports:{}},fb={};function dhe(){var e={};return e["align-content"]=!1,e["align-items"]=!1,e["align-self"]=!1,e["alignment-adjust"]=!1,e["alignment-baseline"]=!1,e.all=!1,e["anchor-point"]=!1,e.animation=!1,e["animation-delay"]=!1,e["animation-direction"]=!1,e["animation-duration"]=!1,e["animation-fill-mode"]=!1,e["animation-iteration-count"]=!1,e["animation-name"]=!1,e["animation-play-state"]=!1,e["animation-timing-function"]=!1,e.azimuth=!1,e["backface-visibility"]=!1,e.background=!0,e["background-attachment"]=!0,e["background-clip"]=!0,e["background-color"]=!0,e["background-image"]=!0,e["background-origin"]=!0,e["background-position"]=!0,e["background-repeat"]=!0,e["background-size"]=!0,e["baseline-shift"]=!1,e.binding=!1,e.bleed=!1,e["bookmark-label"]=!1,e["bookmark-level"]=!1,e["bookmark-state"]=!1,e.border=!0,e["border-bottom"]=!0,e["border-bottom-color"]=!0,e["border-bottom-left-radius"]=!0,e["border-bottom-right-radius"]=!0,e["border-bottom-style"]=!0,e["border-bottom-width"]=!0,e["border-collapse"]=!0,e["border-color"]=!0,e["border-image"]=!0,e["border-image-outset"]=!0,e["border-image-repeat"]=!0,e["border-image-slice"]=!0,e["border-image-source"]=!0,e["border-image-width"]=!0,e["border-left"]=!0,e["border-left-color"]=!0,e["border-left-style"]=!0,e["border-left-width"]=!0,e["border-radius"]=!0,e["border-right"]=!0,e["border-right-color"]=!0,e["border-right-style"]=!0,e["border-right-width"]=!0,e["border-spacing"]=!0,e["border-style"]=!0,e["border-top"]=!0,e["border-top-color"]=!0,e["border-top-left-radius"]=!0,e["border-top-right-radius"]=!0,e["border-top-style"]=!0,e["border-top-width"]=!0,e["border-width"]=!0,e.bottom=!1,e["box-decoration-break"]=!0,e["box-shadow"]=!0,e["box-sizing"]=!0,e["box-snap"]=!0,e["box-suppress"]=!0,e["break-after"]=!0,e["break-before"]=!0,e["break-inside"]=!0,e["caption-side"]=!1,e.chains=!1,e.clear=!0,e.clip=!1,e["clip-path"]=!1,e["clip-rule"]=!1,e.color=!0,e["color-interpolation-filters"]=!0,e["column-count"]=!1,e["column-fill"]=!1,e["column-gap"]=!1,e["column-rule"]=!1,e["column-rule-color"]=!1,e["column-rule-style"]=!1,e["column-rule-width"]=!1,e["column-span"]=!1,e["column-width"]=!1,e.columns=!1,e.contain=!1,e.content=!1,e["counter-increment"]=!1,e["counter-reset"]=!1,e["counter-set"]=!1,e.crop=!1,e.cue=!1,e["cue-after"]=!1,e["cue-before"]=!1,e.cursor=!1,e.direction=!1,e.display=!0,e["display-inside"]=!0,e["display-list"]=!0,e["display-outside"]=!0,e["dominant-baseline"]=!1,e.elevation=!1,e["empty-cells"]=!1,e.filter=!1,e.flex=!1,e["flex-basis"]=!1,e["flex-direction"]=!1,e["flex-flow"]=!1,e["flex-grow"]=!1,e["flex-shrink"]=!1,e["flex-wrap"]=!1,e.float=!1,e["float-offset"]=!1,e["flood-color"]=!1,e["flood-opacity"]=!1,e["flow-from"]=!1,e["flow-into"]=!1,e.font=!0,e["font-family"]=!0,e["font-feature-settings"]=!0,e["font-kerning"]=!0,e["font-language-override"]=!0,e["font-size"]=!0,e["font-size-adjust"]=!0,e["font-stretch"]=!0,e["font-style"]=!0,e["font-synthesis"]=!0,e["font-variant"]=!0,e["font-variant-alternates"]=!0,e["font-variant-caps"]=!0,e["font-variant-east-asian"]=!0,e["font-variant-ligatures"]=!0,e["font-variant-numeric"]=!0,e["font-variant-position"]=!0,e["font-weight"]=!0,e.grid=!1,e["grid-area"]=!1,e["grid-auto-columns"]=!1,e["grid-auto-flow"]=!1,e["grid-auto-rows"]=!1,e["grid-column"]=!1,e["grid-column-end"]=!1,e["grid-column-start"]=!1,e["grid-row"]=!1,e["grid-row-end"]=!1,e["grid-row-start"]=!1,e["grid-template"]=!1,e["grid-template-areas"]=!1,e["grid-template-columns"]=!1,e["grid-template-rows"]=!1,e["hanging-punctuation"]=!1,e.height=!0,e.hyphens=!1,e.icon=!1,e["image-orientation"]=!1,e["image-resolution"]=!1,e["ime-mode"]=!1,e["initial-letters"]=!1,e["inline-box-align"]=!1,e["justify-content"]=!1,e["justify-items"]=!1,e["justify-self"]=!1,e.left=!1,e["letter-spacing"]=!0,e["lighting-color"]=!0,e["line-box-contain"]=!1,e["line-break"]=!1,e["line-grid"]=!1,e["line-height"]=!1,e["line-snap"]=!1,e["line-stacking"]=!1,e["line-stacking-ruby"]=!1,e["line-stacking-shift"]=!1,e["line-stacking-strategy"]=!1,e["list-style"]=!0,e["list-style-image"]=!0,e["list-style-position"]=!0,e["list-style-type"]=!0,e.margin=!0,e["margin-bottom"]=!0,e["margin-left"]=!0,e["margin-right"]=!0,e["margin-top"]=!0,e["marker-offset"]=!1,e["marker-side"]=!1,e.marks=!1,e.mask=!1,e["mask-box"]=!1,e["mask-box-outset"]=!1,e["mask-box-repeat"]=!1,e["mask-box-slice"]=!1,e["mask-box-source"]=!1,e["mask-box-width"]=!1,e["mask-clip"]=!1,e["mask-image"]=!1,e["mask-origin"]=!1,e["mask-position"]=!1,e["mask-repeat"]=!1,e["mask-size"]=!1,e["mask-source-type"]=!1,e["mask-type"]=!1,e["max-height"]=!0,e["max-lines"]=!1,e["max-width"]=!0,e["min-height"]=!0,e["min-width"]=!0,e["move-to"]=!1,e["nav-down"]=!1,e["nav-index"]=!1,e["nav-left"]=!1,e["nav-right"]=!1,e["nav-up"]=!1,e["object-fit"]=!1,e["object-position"]=!1,e.opacity=!1,e.order=!1,e.orphans=!1,e.outline=!1,e["outline-color"]=!1,e["outline-offset"]=!1,e["outline-style"]=!1,e["outline-width"]=!1,e.overflow=!1,e["overflow-wrap"]=!1,e["overflow-x"]=!1,e["overflow-y"]=!1,e.padding=!0,e["padding-bottom"]=!0,e["padding-left"]=!0,e["padding-right"]=!0,e["padding-top"]=!0,e.page=!1,e["page-break-after"]=!1,e["page-break-before"]=!1,e["page-break-inside"]=!1,e["page-policy"]=!1,e.pause=!1,e["pause-after"]=!1,e["pause-before"]=!1,e.perspective=!1,e["perspective-origin"]=!1,e.pitch=!1,e["pitch-range"]=!1,e["play-during"]=!1,e.position=!1,e["presentation-level"]=!1,e.quotes=!1,e["region-fragment"]=!1,e.resize=!1,e.rest=!1,e["rest-after"]=!1,e["rest-before"]=!1,e.richness=!1,e.right=!1,e.rotation=!1,e["rotation-point"]=!1,e["ruby-align"]=!1,e["ruby-merge"]=!1,e["ruby-position"]=!1,e["shape-image-threshold"]=!1,e["shape-outside"]=!1,e["shape-margin"]=!1,e.size=!1,e.speak=!1,e["speak-as"]=!1,e["speak-header"]=!1,e["speak-numeral"]=!1,e["speak-punctuation"]=!1,e["speech-rate"]=!1,e.stress=!1,e["string-set"]=!1,e["tab-size"]=!1,e["table-layout"]=!1,e["text-align"]=!0,e["text-align-last"]=!0,e["text-combine-upright"]=!0,e["text-decoration"]=!0,e["text-decoration-color"]=!0,e["text-decoration-line"]=!0,e["text-decoration-skip"]=!0,e["text-decoration-style"]=!0,e["text-emphasis"]=!0,e["text-emphasis-color"]=!0,e["text-emphasis-position"]=!0,e["text-emphasis-style"]=!0,e["text-height"]=!0,e["text-indent"]=!0,e["text-justify"]=!0,e["text-orientation"]=!0,e["text-overflow"]=!0,e["text-shadow"]=!0,e["text-space-collapse"]=!0,e["text-transform"]=!0,e["text-underline-position"]=!0,e["text-wrap"]=!0,e.top=!1,e.transform=!1,e["transform-origin"]=!1,e["transform-style"]=!1,e.transition=!1,e["transition-delay"]=!1,e["transition-duration"]=!1,e["transition-property"]=!1,e["transition-timing-function"]=!1,e["unicode-bidi"]=!1,e["vertical-align"]=!1,e.visibility=!1,e["voice-balance"]=!1,e["voice-duration"]=!1,e["voice-family"]=!1,e["voice-pitch"]=!1,e["voice-range"]=!1,e["voice-rate"]=!1,e["voice-stress"]=!1,e["voice-volume"]=!1,e.volume=!1,e["white-space"]=!1,e.widows=!1,e.width=!0,e["will-change"]=!1,e["word-break"]=!0,e["word-spacing"]=!0,e["word-wrap"]=!0,e["wrap-flow"]=!1,e["wrap-through"]=!1,e["writing-mode"]=!1,e["z-index"]=!1,e}function S3e(e,t,i){}function E3e(e,t,i){}var A3e=/javascript\s*\:/img;function C3e(e,t){return A3e.test(t)?"":t}fb.whiteList=dhe();fb.getDefaultWhiteList=dhe;fb.onAttr=S3e;fb.onIgnoreAttr=E3e;fb.safeAttrValue=C3e;var R3e={indexOf:function(e,t){var i,r;if(Array.prototype.indexOf)return e.indexOf(t);for(i=0,r=e.length;i<r;i++)if(e[i]===t)return i;return-1},forEach:function(e,t,i){var r,s;if(Array.prototype.forEach)return e.forEach(t,i);for(r=0,s=e.length;r<s;r++)t.call(i,e[r],r,e)},trim:function(e){return String.prototype.trim?e.trim():e.replace(/(^\s*)|(\s*$)/g,"")},trimRight:function(e){return String.prototype.trimRight?e.trimRight():e.replace(/(\s*$)/g,"")}},w2=R3e;function O3e(e,t){e=w2.trimRight(e),e[e.length-1]!==";"&&(e+=";");var i=e.length,r=!1,s=0,n=0,o="";function a(){if(!r){var h=w2.trim(e.slice(s,n)),p=h.indexOf(":");if(p!==-1){var f=w2.trim(h.slice(0,p)),g=w2.trim(h.slice(p+1));if(f){var y=t(s,o.length,f,g,h);y&&(o+=y+"; ")}}}s=n+1}for(;n<i;n++){var l=e[n];if(l==="/"&&e[n+1]==="*"){var c=e.indexOf("*/",n+2);if(c===-1)break;n=c+1,s=n+1,r=!1}else l==="("?r=!0:l===")"?r=!1:l===";"?r||a():l===`
`&&a()}return w2.trim(o)}var M3e=O3e,OM=fb,P3e=M3e;function NZ(e){return e==null}function I3e(e){var t={};for(var i in e)t[i]=e[i];return t}function phe(e){e=I3e(e||{}),e.whiteList=e.whiteList||OM.whiteList,e.onAttr=e.onAttr||OM.onAttr,e.onIgnoreAttr=e.onIgnoreAttr||OM.onIgnoreAttr,e.safeAttrValue=e.safeAttrValue||OM.safeAttrValue,this.options=e}phe.prototype.process=function(e){if(e=e||"",e=e.toString(),!e)return"";var t=this,i=t.options,r=i.whiteList,s=i.onAttr,n=i.onIgnoreAttr,o=i.safeAttrValue,a=P3e(e,function(l,c,h,p,f){var g=r[h],y=!1;if(g===!0?y=g:typeof g=="function"?y=g(p):g instanceof RegExp&&(y=g.test(p)),y!==!0&&(y=!1),p=o(h,p),!!p){var v={position:c,sourcePosition:l,source:f,isWhite:y};if(y){var b=s(h,p,v);return NZ(b)?h+":"+p:b}else{var b=n(h,p,v);if(!NZ(b))return b}}});return a};var $3e=phe;(function(e,t){var i=fb,r=$3e;function s(o,a){var l=new r(a);return l.process(o)}t=e.exports=s,t.FilterCSS=r;for(var n in i)t[n]=i[n]})(XC,XC.exports);var Zj={indexOf:function(e,t){var i,r;if(Array.prototype.indexOf)return e.indexOf(t);for(i=0,r=e.length;i<r;i++)if(e[i]===t)return i;return-1},forEach:function(e,t,i){var r,s;if(Array.prototype.forEach)return e.forEach(t,i);for(r=0,s=e.length;r<s;r++)t.call(i,e[r],r,e)},trim:function(e){return String.prototype.trim?e.trim():e.replace(/(^\s*)|(\s*$)/g,"")},spaceIndex:function(e){var t=/\s|\n|\t/,i=t.exec(e);return i?i.index:-1}},D3e=XC.exports.FilterCSS,L3e=XC.exports.getDefaultWhiteList,GD=Zj;function fhe(){return{a:["target","href","title"],abbr:["title"],address:[],area:["shape","coords","href","alt"],article:[],aside:[],audio:["autoplay","controls","crossorigin","loop","muted","preload","src"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:[],dl:[],dt:[],em:[],figcaption:[],figure:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["src","alt","title","width","height"],ins:["datetime"],li:[],mark:[],nav:[],ol:[],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],summary:[],sup:[],strong:[],strike:[],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],video:["autoplay","controls","crossorigin","loop","muted","playsinline","poster","preload","src","height","width"]}}var mhe=new D3e;function N3e(e,t,i){}function F3e(e,t,i){}function U3e(e,t,i){}function k3e(e,t,i){}function ghe(e){return e.replace(B3e,"&lt;").replace(V3e,"&gt;")}function z3e(e,t,i,r){if(i=xhe(i),t==="href"||t==="src"){if(i=GD.trim(i),i==="#")return"#";if(!(i.substr(0,7)==="http://"||i.substr(0,8)==="https://"||i.substr(0,7)==="mailto:"||i.substr(0,4)==="tel:"||i.substr(0,11)==="data:image/"||i.substr(0,6)==="ftp://"||i.substr(0,2)==="./"||i.substr(0,3)==="../"||i[0]==="#"||i[0]==="/"))return""}else if(t==="background"){if(MM.lastIndex=0,MM.test(i))return""}else if(t==="style"){if(FZ.lastIndex=0,FZ.test(i)||(UZ.lastIndex=0,UZ.test(i)&&(MM.lastIndex=0,MM.test(i))))return"";r!==!1&&(r=r||mhe,i=r.process(i))}return i=The(i),i}var B3e=/</g,V3e=/>/g,G3e=/"/g,j3e=/&quot;/g,H3e=/&#([a-zA-Z0-9]*);?/gim,q3e=/&colon;?/gim,W3e=/&newline;?/gim,MM=/((j\s*a\s*v\s*a|v\s*b|l\s*i\s*v\s*e)\s*s\s*c\s*r\s*i\s*p\s*t\s*|m\s*o\s*c\s*h\s*a)\:/gi,FZ=/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\(.*/gi,UZ=/u\s*r\s*l\s*\(.*/gi;function yhe(e){return e.replace(G3e,"&quot;")}function vhe(e){return e.replace(j3e,'"')}function _he(e){return e.replace(H3e,function(i,r){return r[0]==="x"||r[0]==="X"?String.fromCharCode(parseInt(r.substr(1),16)):String.fromCharCode(parseInt(r,10))})}function bhe(e){return e.replace(q3e,":").replace(W3e," ")}function whe(e){for(var t="",i=0,r=e.length;i<r;i++)t+=e.charCodeAt(i)<32?" ":e.charAt(i);return GD.trim(t)}function xhe(e){return e=vhe(e),e=_he(e),e=bhe(e),e=whe(e),e}function The(e){return e=yhe(e),e=ghe(e),e}function X3e(){return""}function Y3e(e,t){typeof t!="function"&&(t=function(){});var i=!Array.isArray(e);function r(o){return i?!0:GD.indexOf(e,o)!==-1}var s=[],n=!1;return{onIgnoreTag:function(o,a,l){if(r(o))if(l.isClosing){var c="[/removed]",h=l.position+c.length;return s.push([n!==!1?n:l.position,h]),n=!1,c}else return n||(n=l.position),"[removed]";else return t(o,a,l)},remove:function(o){var a="",l=0;return GD.forEach(s,function(c){a+=o.slice(l,c[0]),l=c[1]}),a+=o.slice(l),a}}}function Z3e(e){for(var t="",i=0;i<e.length;){var r=e.indexOf("<!--",i);if(r===-1){t+=e.slice(i);break}t+=e.slice(i,r);var s=e.indexOf("-->",r);if(s===-1)break;i=s+3}return t}function Q3e(e){var t=e.split("");return t=t.filter(function(i){var r=i.charCodeAt(0);return r===127?!1:r<=31?r===10||r===13:!0}),t.join("")}hs.whiteList=fhe();hs.getDefaultWhiteList=fhe;hs.onTag=N3e;hs.onIgnoreTag=F3e;hs.onTagAttr=U3e;hs.onIgnoreTagAttr=k3e;hs.safeAttrValue=z3e;hs.escapeHtml=ghe;hs.escapeQuote=yhe;hs.unescapeQuote=vhe;hs.escapeHtmlEntities=_he;hs.escapeDangerHtml5Entities=bhe;hs.clearNonPrintableCharacter=whe;hs.friendlyAttrValue=xhe;hs.escapeAttrValue=The;hs.onIgnoreTagStripAll=X3e;hs.StripTagBody=Y3e;hs.stripCommentTag=Z3e;hs.stripBlankChar=Q3e;hs.cssFilter=mhe;hs.getDefaultCSSWhiteList=L3e;var pF={},yy=Zj;function J3e(e){var t=yy.spaceIndex(e);if(t===-1)var i=e.slice(1,-1);else var i=e.slice(1,t+1);return i=yy.trim(i).toLowerCase(),i.slice(0,1)==="/"&&(i=i.slice(1)),i.slice(-1)==="/"&&(i=i.slice(0,-1)),i}function K3e(e){return e.slice(0,2)==="</"}function ePe(e,t,i){var r="",s=0,n=!1,o=!1,a=0,l=e.length,c="",h="";e:for(a=0;a<l;a++){var p=e.charAt(a);if(n===!1){if(p==="<"){n=a;continue}}else if(o===!1){if(p==="<"){r+=i(e.slice(s,a)),n=a,s=a;continue}if(p===">"){r+=i(e.slice(s,n)),h=e.slice(n,a+1),c=J3e(h),r+=t(n,r.length,c,h,K3e(h)),s=a+1,n=!1;continue}if(p==='"'||p==="'")for(var f=1,g=e.charAt(a-f);g.trim()===""||g==="=";){if(g==="="){o=p;continue e}g=e.charAt(a-++f)}}else if(p===o){o=!1;continue}}return s<e.length&&(r+=i(e.substr(s))),r}var tPe=/[^a-zA-Z0-9_:\.\-]/gim;function iPe(e,t){var i=0,r=[],s=!1,n=e.length;function o(p,f){if(p=yy.trim(p),p=p.replace(tPe,"").toLowerCase(),!(p.length<1)){var g=t(p,f||"");g&&r.push(g)}}for(var a=0;a<n;a++){var l=e.charAt(a),c,h;if(s===!1&&l==="="){s=e.slice(i,a),i=a+1;continue}if(s!==!1&&a===i&&(l==='"'||l==="'")&&e.charAt(a-1)==="="){if(h=e.indexOf(l,a+1),h===-1)break;c=yy.trim(e.slice(i+1,h)),o(s,c),s=!1,a=h,i=a+1;continue}if(/\s|\n|\t/.test(l))if(e=e.replace(/\s|\n|\t/g," "),s===!1)if(h=rPe(e,a),h===-1){c=yy.trim(e.slice(i,a)),o(c),s=!1,i=a+1;continue}else{a=h-1;continue}else if(h=sPe(e,a-1),h===-1){c=yy.trim(e.slice(i,a)),c=kZ(c),o(s,c),s=!1,i=a+1;continue}else continue}return i<e.length&&(s===!1?o(e.slice(i)):o(s,kZ(yy.trim(e.slice(i))))),yy.trim(r.join(" "))}function rPe(e,t){for(;t<e.length;t++){var i=e[t];if(i!==" ")return i==="="?t:-1}}function sPe(e,t){for(;t>0;t--){var i=e[t];if(i!==" ")return i==="="?t:-1}}function nPe(e){return e[0]==='"'&&e[e.length-1]==='"'||e[0]==="'"&&e[e.length-1]==="'"}function kZ(e){return nPe(e)?e.substr(1,e.length-2):e}pF.parseTag=ePe;pF.parseAttr=iPe;var oPe=XC.exports.FilterCSS,Ch=hs,She=pF,aPe=She.parseTag,lPe=She.parseAttr,RI=Zj;function PM(e){return e==null}function cPe(e){var t=RI.spaceIndex(e);if(t===-1)return{html:"",closing:e[e.length-2]==="/"};e=RI.trim(e.slice(t+1,-1));var i=e[e.length-1]==="/";return i&&(e=RI.trim(e.slice(0,-1))),{html:e,closing:i}}function uPe(e){var t={};for(var i in e)t[i]=e[i];return t}function Ehe(e){e=uPe(e||{}),e.stripIgnoreTag&&(e.onIgnoreTag&&console.error('Notes: cannot use these two options "stripIgnoreTag" and "onIgnoreTag" at the same time'),e.onIgnoreTag=Ch.onIgnoreTagStripAll),e.whiteList=e.whiteList||Ch.whiteList,e.onTag=e.onTag||Ch.onTag,e.onTagAttr=e.onTagAttr||Ch.onTagAttr,e.onIgnoreTag=e.onIgnoreTag||Ch.onIgnoreTag,e.onIgnoreTagAttr=e.onIgnoreTagAttr||Ch.onIgnoreTagAttr,e.safeAttrValue=e.safeAttrValue||Ch.safeAttrValue,e.escapeHtml=e.escapeHtml||Ch.escapeHtml,this.options=e,e.css===!1?this.cssFilter=!1:(e.css=e.css||{},this.cssFilter=new oPe(e.css))}Ehe.prototype.process=function(e){if(e=e||"",e=e.toString(),!e)return"";var t=this,i=t.options,r=i.whiteList,s=i.onTag,n=i.onIgnoreTag,o=i.onTagAttr,a=i.onIgnoreTagAttr,l=i.safeAttrValue,c=i.escapeHtml,h=t.cssFilter;i.stripBlankChar&&(e=Ch.stripBlankChar(e)),i.allowCommentTag||(e=Ch.stripCommentTag(e));var p=!1;if(i.stripIgnoreTagBody){var p=Ch.StripTagBody(i.stripIgnoreTagBody,n);n=p.onIgnoreTag}var f=aPe(e,function(g,y,v,b,w){var S={sourcePosition:g,position:y,isClosing:w,isWhite:r.hasOwnProperty(v)},T=s(v,b,S);if(!PM(T))return T;if(S.isWhite){if(S.isClosing)return"</"+v+">";var A=cPe(b),C=r[v],O=lPe(A.html,function(U,N){var z=RI.indexOf(C,U)!==-1,V=o(v,U,N,z);if(!PM(V))return V;if(z)return N=l(v,U,N,h),N?U+'="'+N+'"':U;var V=a(v,U,N,z);return PM(V)?void 0:V}),b="<"+v;return O&&(b+=" "+O),A.closing&&(b+=" /"),b+=">",b}else{var T=n(v,b,S);return PM(T)?c(b):T}},c);return p&&(f=p.remove(f)),f};var hPe=Ehe;(function(e,t){var i=hs,r=pF,s=hPe;function n(l,c){var h=new s(c);return h.process(l)}t=e.exports=n,t.filterXSS=n,t.FilterXSS=s;for(var o in i)t[o]=i[o];for(var o in r)t[o]=r[o];function a(){return typeof self!="undefined"&&typeof DedicatedWorkerGlobalScope!="undefined"&&self instanceof DedicatedWorkerGlobalScope}a()&&(self.filterXSS=e.exports)})(Cx,Cx.exports);var dPe=function(){function e(t,i){var r=this;this.arcgisWhiteList={a:["href","style","target"],abbr:["title"],audio:["autoplay","controls","loop","muted","preload"],b:[],br:[],dd:["style"],div:["align","style"],dl:["style"],dt:["style"],em:[],figcaption:["style"],figure:["style"],font:["color","face","size","style"],h1:["style"],h2:["style"],h3:["style"],h4:["style"],h5:["style"],h6:["style"],hr:[],i:[],img:["alt","border","height","src","style","width"],li:[],ol:[],p:["style"],source:["media","src","type"],span:["style"],strong:[],sub:["style"],sup:["style"],table:["border","cellpadding","cellspacing","height","style","width"],tbody:[],tr:["align","height","style","valign"],td:["align","colspan","height","nowrap","rowspan","style","valign","width"],th:["align","colspan","height","nowrap","rowspan","style","valign","width"],u:[],ul:[],video:["autoplay","controls","height","loop","muted","poster","preload","width"]},this.allowedProtocols=["http","https","mailto","iform","tel","flow","lfmobile","arcgis-navigator","arcgis-appstudio-player","arcgis-survey123","arcgis-collector","arcgis-workforce","arcgis-explorer","arcgis-trek2there","arcgis-quickcapture","mspbi","comgooglemaps","pdfefile","pdfehttp","pdfehttps","boxapp","boxemm","awb","awbs","gropen","radarscope"],this.arcgisFilterOptions={allowCommentTag:!0,safeAttrValue:function(n,o,a,l){return n==="a"&&o==="href"||(n==="img"||n==="source")&&o==="src"?r.sanitizeUrl(a):Cx.exports.safeAttrValue(n,o,a,l)}};var s;t&&!i?s=t:t&&i?(s=Object.create(this.arcgisFilterOptions),Object.keys(t).forEach(function(n){n==="whiteList"?s.whiteList=r._extendObjectOfArrays([r.arcgisWhiteList,t.whiteList||{}]):s[n]=t[n]})):(s=Object.create(this.arcgisFilterOptions),s.whiteList=this.arcgisWhiteList),this.xssFilterOptions=s,this._xssFilter=new Cx.exports.FilterXSS(s)}return e.prototype.sanitize=function(t,i){switch(i===void 0&&(i={}),typeof t){case"number":return isNaN(t)||!isFinite(t)?null:t;case"boolean":return t;case"string":return this._xssFilter.process(t);case"object":return this._iterateOverObject(t,i);default:return i.allowUndefined&&typeof t=="undefined"?void 0:null}},e.prototype.sanitizeUrl=function(t){var i=this._trim(t.substring(0,t.indexOf(":")));return t==="/"||t==="#"||t[0]==="#"||this.allowedProtocols.indexOf(i.toLowerCase())>-1?Cx.exports.escapeAttrValue(t):""},e.prototype.sanitizeHTMLAttribute=function(t,i,r,s){return typeof this.xssFilterOptions.safeAttrValue=="function"?this.xssFilterOptions.safeAttrValue(t,i,r,s):Cx.exports.safeAttrValue(t,i,r,s)},e.prototype.validate=function(t,i){i===void 0&&(i={});var r=this.sanitize(t,i);return{isValid:t===r,sanitized:r}},e.prototype._extendObjectOfArrays=function(t){var i={};return t.forEach(function(r){Object.keys(r).forEach(function(s){Array.isArray(r[s])&&Array.isArray(i[s])?i[s]=i[s].concat(r[s]):i[s]=r[s]})}),i},e.prototype._iterateOverObject=function(t,i){var r=this;i===void 0&&(i={});try{var s=!1,n=void 0;if(Array.isArray(t))n=t.reduce(function(a,l){var c=r.validate(l,i);return c.isValid?a.concat([l]):(s=!0,a.concat([c.sanitized]))},[]);else if(T3e(t)){var o=Object.keys(t);n=o.reduce(function(a,l){var c=t[l],h=r.validate(c,i);return h.isValid?a[l]=c:(s=!0,a[l]=h.sanitized),a},{})}else return i.allowUndefined&&typeof t=="undefined"?void 0:null;return s?n:t}catch{return null}},e.prototype._trim=function(t){return String.prototype.trim?t.trim():t.replace(/(^\s*)|(\s*$)/g,"")},e}();const fF=new Map;function Ahe(){fF.clear()}function pPe(e){return fF.get(e)}function fPe(e,t){fF.set(e,t)}function j5(e){fF.delete(e)}var $1,ZT,mPe=function(e){if("WebkitTransition"in e.style)$1="webkitTransitionEnd",ZT="webkitAnimationEnd";else{if(!("transition"in e.style))throw new Error("Your browser is not supported!");$1="transitionend",ZT="animationend"}},Che=function(e){$1||mPe(e)},gPe=function(e,t){return t===void 0&&(t=e+"-active"),function(i){Che(i);var r=!1,s=function(n){r||(r=!0,i.removeEventListener($1,s),i.removeEventListener(ZT,s),i.classList.remove(e),i.classList.remove(t))};i.classList.add(e),i.addEventListener($1,s),i.addEventListener(ZT,s),requestAnimationFrame(function(){i.classList.add(t)})}},yPe=function(e,t){return t===void 0&&(t=e+"-active"),function(i,r){Che(i);var s=!1,n=function(o){s||(s=!0,i.removeEventListener($1,n),i.removeEventListener(ZT,n),r())};i.classList.add(e),i.addEventListener($1,n),i.addEventListener(ZT,n),requestAnimationFrame(function(){i.classList.add(t)})}};const vPe=he.getLogger("esri.widgets.support.widgetUtils");function Rhe(e){const t=il.acquire();for(let r=0;r<arguments.length;r++){const s=arguments[r],n=typeof s;if(n==="string")t.push(s);else if(Array.isArray(s))t.push.apply(t,s);else if(n==="object")for(const o in s)s[o]&&t.push(o)}const i=t.join(" ");return il.release(t),i}(()=>{const e=new Map,t=new ResizeObserver(i=>{Ahe();for(const r of i)e.get(r.target)(r)});return(i,r,s)=>(e.has(i)&&vPe.error("Already observing element",i),e.set(i,r),t.observe(i,s),km(()=>{t.unobserve(i),e.delete(i)}))})();function qy(e){const t=e==null?void 0:e.closest("[dir]");return t!==null&&t instanceof HTMLElement&&t.dir==="rtl"||document.dir==="rtl"}function zZ(e){const t="data-node-ref";this[e.getAttribute(t)]=null}function yV(e){const t="data-node-ref";this[e.getAttribute(t)]=e}function _Pe(e,t){return(e==="enter"?gPe:yPe)(t)}const bPe=["dd","dl","dt","h1","h2","h3","h4","h5","h6","sub","sup","animate","animatetransform","circle","clippath","defs","ellipse","g","image","line","lineargradient","marker","mask","path","pattern","polygon","polyline","radialgradient","rect","stop","svg","switch","symbol","text","textpath","tspan","use"],wPe=bPe.reduce((e,t)=>(e[t]=[],e),{}),xPe=["align","alink","alt","bgcolor","border","cellpadding","cellspacing","class","color","cols","colspan","coords","d","dir","face","height","hspace","ismap","lang","marginheight","marginwidth","multiple","nohref","noresize","noshade","nowrap","ref","rel","rev","rows","rowspan","scrolling","shape","span","summary","tabindex","title","usemap","valign","value","vlink","vspace","width"],Ohe=new dPe({whiteList:wPe,onTagAttr:(e,t,i)=>{const r=`${t}="${i}"`;if(xPe.includes(t))return r},stripIgnoreTag:!0,stripIgnoreTagBody:["script","style"]},!0);function TPe(e){return e==="Enter"||e===" "}const Mhe="http://www.w3.org/",mF=`${Mhe}2000/svg`,Phe=`${Mhe}1999/xlink`;let jD,BZ=[],Qj=(e,t)=>{let i={};return Object.keys(e).forEach(r=>{i[r]=e[r]}),t&&Object.keys(t).forEach(r=>{i[r]=t[r]}),i},Jj=(e,t)=>e.vnodeSelector===t.vnodeSelector&&(e.properties&&t.properties?e.properties.key===t.properties.key&&e.properties.bind===t.properties.bind:!e.properties&&!t.properties),Ihe=e=>{if(typeof e!="string")throw new Error("Style values must be strings")},SPe=(e,t,i)=>{if(t.vnodeSelector!==""){for(let r=i;r<e.length;r++)if(Jj(e[r],t))return r}return-1},H5=(e,t,i,r)=>{let s=e[t];if(s.vnodeSelector==="")return;let n=s.properties;if(!(n?n.key===void 0?n.bind:n.key:void 0)){for(let o=0;o<e.length;o++)if(o!==t){let a=e[o];if(Jj(a,s))throw new Error(`${i.vnodeSelector} had a ${s.vnodeSelector} child ${r==="added"?r:"removed"}, but there is now more than one. You must add unique key properties to make them distinguishable.`)}}},EPe=e=>{if(e.properties){let t=e.properties.enterAnimation;t&&t(e.domNode,e.properties)}},vV=[],_V=!1,$he=e=>{(e.children||[]).forEach($he),e.properties&&e.properties.afterRemoved&&e.properties.afterRemoved.apply(e.properties.bind||e.properties,[e.domNode])},VZ=()=>{_V=!1,vV.forEach($he),vV.length=0},GZ=e=>{vV.push(e),_V||(_V=!0,typeof window!="undefined"&&"requestIdleCallback"in window?window.requestIdleCallback(VZ,{timeout:16}):setTimeout(VZ,16))},jZ=e=>{let t=e.domNode;if(e.properties){let i=e.properties.exitAnimation;if(i)return t.style.pointerEvents="none",void i(t,()=>{t.parentNode&&(t.parentNode.removeChild(t),GZ(e))},e.properties)}t.parentNode&&(t.parentNode.removeChild(t),GZ(e))},APe=(e,t,i)=>{if(!t)return;let r=i.eventHandlerInterceptor,s=Object.keys(t),n=s.length;for(let o=0;o<n;o++){let a=s[o],l=t[a];if(a==="className")throw new Error('Property "className" is not supported, use "class".');if(a==="class")bV(e,l,!0);else if(a==="classes"){let c=Object.keys(l),h=c.length;for(let p=0;p<h;p++){let f=c[p];l[f]&&e.classList.add(f)}}else if(a==="styles"){let c=Object.keys(l),h=c.length;for(let p=0;p<h;p++){let f=c[p],g=l[f];g&&(Ihe(g),i.styleApplyer(e,f,g))}}else if(a!=="key"&&l!=null){let c=typeof l;c==="function"?(a.lastIndexOf("on",0)===0&&(r&&(l=r(a,l,e,t)),a==="oninput"&&function(){let h=l;l=function(p){h.apply(this,[p]),p.target["oninput-value"]=p.target.value}}()),e[a]=l):i.namespace===mF?a==="href"?e.setAttributeNS(Phe,a,l):e.setAttribute(a,l):c==="string"&&a!=="value"?a==="innerHTML"?e[a]=Ohe.sanitize(l):e.setAttribute(a,l):e[a]=l}}},CPe=(e,t,i)=>{if(t)for(let r of t)Rx(r,e,void 0,i)},Dhe=(e,t,i)=>{CPe(e,t.children,i),t.text&&(e.textContent=t.text),APe(e,t.properties,i),t.properties&&t.properties.afterCreate&&t.properties.afterCreate.apply(t.properties.bind||t.properties,[e,i,t.vnodeSelector,t.properties,t.children])},Rx=(e,t,i,r)=>{let s,n=0,o=e.vnodeSelector,a=t.ownerDocument;if(o==="")s=e.domNode=a.createTextNode(e.text),i!==void 0?t.insertBefore(s,i):t.appendChild(s);else{for(let l=0;l<=o.length;++l){let c=o.charAt(l);if(l===o.length||c==="."||c==="#"){let h=o.charAt(n-1),p=o.slice(n,l);h==="."?s.classList.add(p):h==="#"?s.id=p:(p==="svg"&&(r=Qj(r,{namespace:mF})),r.namespace!==void 0?s=e.domNode=a.createElementNS(r.namespace,p):(s=e.domNode=e.domNode||a.createElement(p),p==="input"&&e.properties&&e.properties.type!==void 0&&s.setAttribute("type",e.properties.type)),i!==void 0?t.insertBefore(s,i):s.parentNode!==t&&t.appendChild(s)),n=l+1}}Dhe(s,e,r)}},bV=(e,t,i)=>{t&&t.split(" ").forEach(r=>{r&&e.classList.toggle(r,i)})},RPe=(e,t,i,r)=>{if(!i)return;let s=!1,n=Object.keys(i),o=n.length;for(let a=0;a<o;a++){let l=n[a],c=i[l],h=t[l];if(l==="class")h!==c&&(bV(e,h,!1),bV(e,c,!0));else if(l==="classes"){let p=e.classList,f=Object.keys(c),g=f.length;for(let y=0;y<g;y++){let v=f[y],b=!!c[v];b!==!!h[v]&&(s=!0,b?p.add(v):p.remove(v))}}else if(l==="styles"){let p=Object.keys(c),f=p.length;for(let g=0;g<f;g++){let y=p[g],v=c[y];v!==h[y]&&(s=!0,v?(Ihe(v),r.styleApplyer(e,y,v)):r.styleApplyer(e,y,""))}}else if(c||typeof h!="string"||(c=""),l==="value"){let p=e[l];p!==c&&(e["oninput-value"]?p===e["oninput-value"]:c!==h)&&(e[l]=c,e["oninput-value"]=void 0),c!==h&&(s=!0)}else if(c!==h){let p=typeof c;p==="function"&&r.eventHandlerInterceptor||(r.namespace===mF?l==="href"?e.setAttributeNS(Phe,l,c):e.setAttribute(l,c):p==="string"?l==="innerHTML"?e[l]=Ohe.sanitize(c):l==="role"&&c===""?e.removeAttribute(l):e.setAttribute(l,c):e[l]!==c&&(e[l]=c),s=!0)}}return s},OPe=(e,t,i,r,s)=>{if(i===r)return!1;r=r||BZ;let n,o=(i=i||BZ).length,a=r.length,l=0,c=0,h=!1;for(;c<a;){let p=l<o?i[l]:void 0,f=r[c];if(p!==void 0&&Jj(p,f))h=jD(p,f,s)||h,l++;else{let g=SPe(i,f,l+1);if(g>=0){for(n=l;n<g;n++)jZ(i[n]),H5(i,n,e,"removed");h=jD(i[g],f,s)||h,l=g+1}else Rx(f,t,l<o?i[l].domNode:void 0,s),EPe(f),H5(r,c,e,"added")}c++}if(o>l)for(n=l;n<o;n++)jZ(i[n]),H5(i,n,e,"removed");return h};jD=(e,t,i)=>{let r=e.domNode,s=!1;if(e===t)return!1;let n=!1;if(t.vnodeSelector===""){if(t.text!==e.text){let o=r.ownerDocument.createTextNode(t.text);return r.parentNode.replaceChild(o,r),t.domNode=o,s=!0,s}t.domNode=r}else t.vnodeSelector.lastIndexOf("svg",0)===0&&(i=Qj(i,{namespace:mF})),e.text!==t.text&&(n=!0,t.text===void 0?r.removeChild(r.firstChild):r.textContent=t.text),t.domNode=r,n=OPe(t,r,e.children,t.children,i)||n,n=RPe(r,e.properties,t.properties,i)||n,t.properties&&t.properties.afterUpdate&&t.properties.afterUpdate.apply(t.properties.bind||t.properties,[r,i,t.vnodeSelector,t.properties,t.children]);return n&&t.properties&&t.properties.updateAnimation&&t.properties.updateAnimation(r,t.properties,e.properties),s};let x2=(e,t)=>({getLastRender:()=>e,update:i=>{if(e.vnodeSelector!==i.vnodeSelector)throw new Error("The selector for the root VNode may not be changed. (consider using dom.merge and add one extra level to the virtual DOM)");let r=e;e=i,jD(r,i,t)},domNode:e.domNode});const MPe={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(e,t,i)=>{t.charAt(0)==="-"?e.style.setProperty(t,i):e.style[t]=i}};let Cw=e=>Qj(MPe,e),Wy={create:(e,t)=>(t=Cw(t),Rx(e,document.createElement("div"),void 0,t),x2(e,t)),append:(e,t,i)=>(i=Cw(i),Rx(t,e,void 0,i),x2(t,i)),insertBefore:(e,t,i)=>(i=Cw(i),Rx(t,e.parentNode,e,i),x2(t,i)),merge:(e,t,i)=>(i=Cw(i),t.domNode=e,Dhe(e,t,i),x2(t,i)),replace:(e,t,i)=>(i=Cw(i),Rx(t,e.parentNode,e,i),e.parentNode.removeChild(e),x2(t,i))},Lhe,PPe=(e,t)=>{let i=[];for(;e&&e!==t;)i.push(e),e=e.parentNode;return i};Lhe=Array.prototype.find?(e,t)=>e.find(t):(e,t)=>e.filter(t)[0];let IPe=(e,t)=>{let i=e;return t.forEach(r=>{i=i&&i.children?Lhe(i.children,s=>s.domNode===r):void 0}),i},$Pe=(e,t,i)=>{let r=function(s){i("domEvent",s);let n=t(),o=PPe(s.currentTarget,n.domNode);o.reverse();let a,l=IPe(n.getLastRender(),o);return e.scheduleRender(),l&&(a=l.properties[`on${s.type}`].apply(l.properties.bind||this,arguments)),i("domEventProcessed",s),a};return(s,n,o,a)=>r},HZ=e=>{let t,i,r=Cw(e),s=r.performanceLogger,n=!0,o=!1,a=[],l=[],c=(p,f,g)=>{let y,v=()=>y;r.eventHandlerInterceptor=$Pe(t,v,s),y=p(f,g(),r),a.push(y),l.push(g)},h=()=>{if(i=void 0,n){n=!1,s("renderStart",void 0);for(let p=0;p<a.length;p++){let f=l[p]();s("rendered",void 0),a[p].update(f),s("patched",void 0)}s("renderDone",void 0),n=!0}};return t={renderNow:h,scheduleRender:()=>{i||o||(i=requestAnimationFrame(h))},stop:()=>{i&&(cancelAnimationFrame(i),i=void 0),o=!0},resume:()=>{o=!1,n=!0,t.scheduleRender()},append:(p,f)=>{c(Wy.append,p,f)},insertBefore:(p,f)=>{c(Wy.insertBefore,p,f)},merge:(p,f)=>{c(Wy.merge,p,f)},replace:(p,f)=>{c(Wy.replace,p,f)},detach:p=>{for(let f=0;f<l.length;f++)if(l[f]===p)return l.splice(f,1),a.splice(f,1)[0];throw new Error("renderFunction was not found")}},t},Xg=class extends we{constructor(){super(...arguments),this.items=new it,this._watchUpdatingTracking=new fp,this._callbacks=new Map,this._projector=HZ(),this._hiddenProjector=HZ()}get needsRender(){return this.items.length>0}initialize(){const e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange(()=>this.items,t=>{for(const i of t.added){const r=()=>i.render();this._callbacks.set(i,r),this._projector.append(this.surface,r)}for(const i of t.removed){const r=this._projector.detach(this._callbacks.get(i));this.surface.removeChild(r.domNode),this._callbacks.delete(i)}})}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach(e=>this._projector.detach(e)),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){const t=this._hiddenSurface,i=this._hiddenProjector;let r=null;const s=()=>(r=e.render(),r);i.append(t,s),i.renderNow();const n={left:0,top:0,right:0,bottom:0};if(r&&r.domNode){const o=r.domNode.getBoundingClientRect();n.left=o.left,n.top=o.top,n.right=o.right,n.bottom=o.bottom}for(i.detach(s);t.firstChild;)t.removeChild(t.firstChild);return n}overlaps(e,t){const i=this.computeBoundingRect(e),r=this.computeBoundingRect(t);return Math.max(i.left,r.left)<=Math.min(i.right,r.right)&&Math.max(i.top,r.top)<=Math.min(i.bottom,r.bottom)}get hasVisibleItems(){return this.items.some(e=>e.visible)}renderCanvas(e){if(!this.items.some(i=>i.visible))return;const t=e.getContext("2d");t.save(),t.font=`10px ${getComputedStyle(this.surface).fontFamily}`,this.items.forEach(i=>{t.save(),i.renderCanvas(t),t.restore()}),t.restore()}};u([d({readOnly:!0})],Xg.prototype,"surface",void 0),u([d({readOnly:!0})],Xg.prototype,"items",void 0),u([d({readOnly:!0})],Xg.prototype,"needsRender",null),u([d({readOnly:!0})],Xg.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0,aliasOf:"_watchUpdatingTracking.updating"})],Xg.prototype,"updating",void 0),Xg=u([P("esri.views.overlay.ViewOverlay")],Xg);const qZ=Xg;function Kj(e,t,i,r){let s=null,n=1e3;typeof t=="number"?(n=t,r=i):(s=t!=null?t:null,n=i);let o,a=0;const l=()=>{a=0,e.apply(r,o)},c=(...h)=>{s&&s.apply(r,h),o=h,n?a||(a=setTimeout(l,n)):l()};return c.remove=()=>{a&&(clearTimeout(a),a=0)},c.forceUpdate=()=>{a&&(clearTimeout(a),l())},c.hasPendingUpdates=()=>!!a,c}const DPe=/\?(\.|$)/g;function Wt(e,t,i,r){const s=Array.isArray(t)?t:t.indexOf(",")>-1?t.split(","):[t],n=nr(e,t,i,r);for(const o of s){const a=o.trim().replace(DPe,"$1"),l=e.get(a);i.call(e,l,l,a,e)}return n}function nr(e,t,i,r){return e.watch(t,i,r)}function LPe(e,t,i,r){return yF(e,t,null,i,r)}function eH(e,t,i,r){return gF(e,t,Uhe,i,r)}function Nhe(e,t,i,r){return yF(e,t,Uhe,i,r)}function qmt(e,t,i,r){return yF(e,t,UPe,i,r)}function NPe(e,t,i,r){return gF(e,t,khe,i,r)}function Fhe(e,t,i,r){return yF(e,t,khe,i,r)}function HD(e,t,i,r){return gF(e,t,kPe,i,r)}function FPe(e,t,i,r){let s=!1;const n=e.watch(t,(o,a,l,c)=>{s||i.call(e,o,a,l,c)},r);return{remove(){n.remove()},pause(){s=!0},resume(){s=!1}}}function Rp(e,t,i,r,s,n,o){const a={};function l(h){const p=a[h];p&&(n&&n(p.target,h,e,i),p.handle.remove(),delete a[h])}const c=Wt(e,t,(h,p,f)=>{l(f),CN(h)&&(a[f]={handle:eO(h,i,r),target:h},s&&s(h,f,e,i))},o);return{remove(){c.remove();for(const h in a)l(h)}}}function gF(e,t,i,r,s){const n=e.watch(t,(o,a,l,c)=>{i&&!i(o)||r==null||r.call(e,o,a,l,c)},s);if(Array.isArray(t))for(const o of t){const a=e.get(o);i&&i(a)&&(r==null||r.call(e,a,a,t,e))}else{const o=e.get(t);i&&i(o)&&(r==null||r.call(e,o,o,t,e))}return n}function yF(e,t,i,r,s){const n=typeof r=="function"?r:null,o=typeof r=="object"?r:null;typeof r=="boolean"&&(s=r);let a,l=!1;function c(){a&&(a.remove(),a=null)}const h=f0();go(o,()=>{c(),h.reject(pi())});const p={then:h.promise.then.bind(h.promise),catch:h.promise.catch.bind(h.promise),remove:c};return Object.freeze(p),a=gF(e,t,i,(f,g,y,v)=>{l=!0,c(),n&&n.call(e,f,g,y,v),h.resolve({value:f,oldValue:g,propertyName:y,target:v})},s),l&&c(),p}function Uhe(e){return!!e}function UPe(e){return!e}function khe(e){return e===!0}function kPe(e){return e===!1}function mt(e,t){const i=t?me(I({},t),{source:e}):e;return d({aliasOf:i})}function zhe(){const e=crypto.getRandomValues(new Uint16Array(8));e[3]=4095&e[3]|16384,e[4]=16383&e[4]|32768;const t=i=>e[i].toString(16);return t(0)+t(1)+"-"+t(2)+"-"+t(3)+"-"+t(4)+"-"+t(5)+t(6)+t(7)}const zPe={handleInterceptedEvent:(e,t,i,r)=>(e.scheduleRender(),t.properties[`on${r.type}`].apply(t.properties.bind||i,[r]))},BPe={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(e,t,i)=>{e.style[t]=i}},VPe=e=>I(I({},BPe),e),GPe=(e,t)=>{const i=[];for(;e&&e!==t;)i.push(e),e=e.parentNode;return i},jPe=(e,t)=>e.find(t),WZ=(e,t,i=!1)=>{let r=e;return t.forEach((s,n)=>{var o;const a=(o=r)!=null&&o.children?jPe(r.children,l=>l.domNode===s):void 0;i&&!a&&n!==t.length-1||(r=a)}),r},HPe=e=>{let t;const i=I(I({},zPe),e),r=VPe(i),s=r.performanceLogger;let n,o=!0,a=!1;const l=[],c=[],h=(f,g,y)=>{let v;r.eventHandlerInterceptor=(w,S,T,A)=>function(C){let O;s("domEvent",C);const L=GPe(C.currentTarget,v.domNode),U=L.some(z=>{var V;return customElements.get(z==null||(V=z.tagName)==null?void 0:V.toLowerCase())});if(C.eventPhase===Event.CAPTURING_PHASE||!U)L.reverse(),O=WZ(v.getLastRender(),L);else{const z=C.composedPath(),V=z.slice(z.indexOf(C.currentTarget),z.indexOf(v.domNode)).filter(B=>B.getRootNode()===B.ownerDocument).reverse();O=WZ(v.getLastRender(),V,!0)}let N;return O&&(N=i.handleInterceptedEvent(t,O,this,C)),s("domEventProcessed",C),N},i.postProcessProjectionOptions==null||i.postProcessProjectionOptions(r);const b=y();v=f(g,b,r),l.push(v),c.push(y),i.afterFirstVNodeRendered&&i.afterFirstVNodeRendered(v,b)};let p=()=>{if(n=void 0,o){o=!1,s("renderStart",void 0);for(let f=0;f<l.length;f++){const g=c[f]();s("rendered",void 0),l[f].update(g),s("patched",void 0)}s("renderDone",void 0),o=!0}};return i.modifyDoRenderImplementation&&(p=i.modifyDoRenderImplementation(p,l,c)),t={renderNow:p,scheduleRender:()=>{n||a||(n=requestAnimationFrame(p))},stop:()=>{n&&(cancelAnimationFrame(n),n=void 0),a=!0},resume:()=>{a=!1,o=!0,t.scheduleRender()},append:(f,g)=>{h(Wy.append,f,g)},insertBefore:(f,g)=>{h(Wy.insertBefore,f,g)},merge:(f,g)=>{h(Wy.merge,f,g)},replace:(f,g)=>{h(Wy.replace,f,g)},detach:f=>{for(let g=0;g<c.length;g++)if(c[g]===f)return c.splice(g,1),l.splice(g,1)[0];throw new Error("renderFunction was not found")}},t},yr={allRenderFn:!1,cmpDidLoad:!0,cmpDidUnload:!1,cmpDidUpdate:!0,cmpDidRender:!0,cmpWillLoad:!0,cmpWillUpdate:!0,cmpWillRender:!0,connectedCallback:!0,disconnectedCallback:!0,element:!0,event:!0,hasRenderFn:!0,lifecycle:!0,hostListener:!0,hostListenerTargetWindow:!0,hostListenerTargetDocument:!0,hostListenerTargetBody:!0,hostListenerTargetParent:!1,hostListenerTarget:!0,member:!0,method:!0,mode:!0,observeAttribute:!0,prop:!0,propMutable:!0,reflect:!0,scoped:!0,shadowDom:!0,slot:!0,cssAnnotations:!0,state:!0,style:!0,svg:!0,updatable:!0,vdomAttribute:!0,vdomXlink:!0,vdomClass:!0,vdomFunctional:!0,vdomKey:!0,vdomListener:!0,vdomRef:!0,vdomPropOrAttr:!0,vdomRender:!0,vdomStyle:!0,vdomText:!0,watchCallback:!0,taskQueue:!0,hotModuleReplacement:!1,isDebug:!1,isDev:!1,isTesting:!1,hydrateServerSide:!1,hydrateClientSide:!1,lifecycleDOMEvents:!1,lazyLoad:!1,profile:!1,slotRelocation:!0,appendChildSlotFix:!1,cloneNodeFix:!1,hydratedAttribute:!1,hydratedClass:!0,safari10:!1,scriptDataOpts:!1,scopedSlotTextContentFix:!1,shadowDomShim:!1,slotChildNodesFix:!1,invisiblePrehydration:!0,propBoolean:!0,propNumber:!0,propString:!0,cssVarShim:!1,constructableCSS:!0,cmpShouldUpdate:!0,devTools:!1,dynamicImportShim:!1,shadowDelegatesFocus:!0,initializeNextTick:!1,asyncLoading:!1,asyncQueue:!1,transformTagName:!1,attachStyles:!0};let Rw,Bhe,vF,Vhe=!1,qD=!1,tH=!1,Xl=!1,XZ=null,wV=!1;const qS=typeof window!="undefined"?window:{};yr.cssVarShim&&qS.CSS;const jh=qS.document||{head:{}},Wmt=qS.HTMLElement||class{},yo={$flags$:0,$resourcesUrl$:"",jmp:e=>e(),raf:e=>requestAnimationFrame(e),ael:(e,t,i,r)=>e.addEventListener(t,i,r),rel:(e,t,i,r)=>e.removeEventListener(t,i,r),ce:(e,t)=>new CustomEvent(e,t)},WD=yr.shadowDomShim&&yr.shadowDom?(()=>(jh.head.attachShadow+"").indexOf("[native")>-1)():!0,qPe=(()=>{let e=!1;try{jh.addEventListener("e",null,Object.defineProperty({},"passive",{get(){e=!0}}))}catch{}return e})(),WPe=e=>Promise.resolve(e),XPe=yr.constructableCSS?(()=>{try{return new CSSStyleSheet,typeof new CSSStyleSheet().replace=="function"}catch{}return!1})():!1,Ghe=(e,t,i,r)=>{i&&i.map(([s,n,o])=>{const a=ZPe(e,s),l=YPe(t,o),c=QPe(s);yo.ael(a,n,l,c),(t.$rmListeners$=t.$rmListeners$||[]).push(()=>yo.rel(a,n,l,c))})},YPe=(e,t)=>i=>{try{yr.lazyLoad||e.$hostElement$[t](i)}catch(r){fO(r)}},ZPe=(e,t)=>t&4?jh:t&8?qS:t&16?jh.body:e,QPe=e=>qPe?{passive:(e&1)!==0,capture:(e&2)!==0}:(e&2)!==0,YZ="http://www.w3.org/1999/xlink",D1=(e,t="")=>()=>{},ZZ=new WeakMap,JPe=(e,t,i)=>{let r=ZD.get(e);XPe&&i?(r=r||new CSSStyleSheet,r.replace(t)):r=t,ZD.set(e,r)},KPe=(e,t,i,r)=>{let s=jhe(t,i),n=ZD.get(s);if(e=e.nodeType===11?e:jh,n)if(typeof n=="string"){e=e.head||e;let o=ZZ.get(e),a;o||ZZ.set(e,o=new Set),o.has(s)||(a=jh.createElement("style"),a.innerHTML=n,e.insertBefore(a,e.querySelector("link")),o&&o.add(s))}else e.adoptedStyleSheets.includes(n)||(e.adoptedStyleSheets=[...e.adoptedStyleSheets,n]);return s},eIe=e=>{const t=e.$cmpMeta$,i=e.$hostElement$,r=t.$flags$,s=D1("attachStyles",t.$tagName$),n=KPe(WD&&i.shadowRoot?i.shadowRoot:i.getRootNode(),t,e.$modeName$);r&10&&(i["s-sc"]=n,i.classList.add(n+"-h"),r&2&&i.classList.add(n+"-s")),s()},jhe=(e,t)=>"sc-"+(t&&e.$flags$&32?e.$tagName$+"-"+t:e.$tagName$),tIe=e=>PIe.map(t=>t(e)).find(t=>!!t),QZ={},iIe="http://www.w3.org/2000/svg",rIe="http://www.w3.org/1999/xhtml",sIe=e=>e!=null,iH=e=>(e=typeof e,e==="object"||e==="function"),Hhe=(e,t,...i)=>{let r=null,s=null,n=null,o=!1,a=!1,l=[];const c=p=>{for(let f=0;f<p.length;f++)r=p[f],Array.isArray(r)?c(r):r!=null&&typeof r!="boolean"&&((o=typeof e!="function"&&!iH(r))&&(r=String(r)),o&&a?l[l.length-1].$text$+=r:l.push(o?XD(null,r):r),a=o)};if(c(i),t&&(yr.isDev&&e==="input"&&lIe(t),yr.vdomKey&&t.key&&(s=t.key),yr.slotRelocation&&t.name&&(n=t.name),yr.vdomClass)){const p=t.className||t.class;p&&(t.class=typeof p!="object"?p:Object.keys(p).filter(f=>p[f]).join(" "))}if(yr.isDev&&l.some(qhe)&&MIe(`The <Host> must be the single root component. Make sure:
- You are NOT using hostData() and <Host> in the same component.
- <Host> is used once, and it's the single root component of the render() function.`),yr.vdomFunctional&&typeof e=="function")return e(t===null?{}:t,l,oIe);const h=XD(e,null);return h.$attrs$=t,l.length>0&&(h.$children$=l),yr.vdomKey&&(h.$key$=s),yr.slotRelocation&&(h.$name$=n),h},XD=(e,t)=>{const i={$flags$:0,$tag$:e,$text$:t,$elm$:null,$children$:null};return yr.vdomAttribute&&(i.$attrs$=null),yr.vdomKey&&(i.$key$=null),yr.slotRelocation&&(i.$name$=null),i},nIe={},qhe=e=>e&&e.$tag$===nIe,oIe={forEach:(e,t)=>e.map(JZ).forEach(t),map:(e,t)=>e.map(JZ).map(t).map(aIe)},JZ=e=>({vattrs:e.$attrs$,vchildren:e.$children$,vkey:e.$key$,vname:e.$name$,vtag:e.$tag$,vtext:e.$text$}),aIe=e=>{if(typeof e.vtag=="function"){const i=Object.assign({},e.vattrs);return e.vkey&&(i.key=e.vkey),e.vname&&(i.name=e.vname),Hhe(e.vtag,i,...e.vchildren||[])}const t=XD(e.vtag,e.vtext);return t.$attrs$=e.vattrs,t.$children$=e.vchildren,t.$key$=e.vkey,t.$name$=e.vname,t},lIe=e=>{const t=Object.keys(e),i=t.indexOf("value");if(i===-1)return;const r=t.indexOf("type"),s=t.indexOf("min"),n=t.indexOf("max"),o=t.indexOf("step");(i<r||i<s||i<n||i<o)&&ide('The "value" prop of <input> should be set after "min", "max", "type" and "step"')},KZ=(e,t,i,r,s,n)=>{if(i!==r){let o=rQ(e,t),a=t.toLowerCase();if(t==="class"){const l=e.classList,c=eQ(i),h=eQ(r);l.remove(...c.filter(p=>p&&!h.includes(p))),l.add(...h.filter(p=>p&&!c.includes(p)))}else if(t==="style"){for(const l in i)(!r||r[l]==null)&&(l.includes("-")?e.style.removeProperty(l):e.style[l]="");for(const l in r)(!i||r[l]!==i[l])&&(l.includes("-")?e.style.setProperty(l,r[l]):e.style[l]=r[l])}else if(t!=="key")if(t==="ref")r&&r(e);else if(!e.__lookupSetter__(t)&&t[0]==="o"&&t[1]==="n")t[2]==="-"?t=t.slice(3):rQ(qS,a)?t=a.slice(2):t=a[2]+t.slice(3),i&&yo.rel(e,t,i,!1),r&&yo.ael(e,t,r,!1);else{const l=iH(r);if((o||l&&r!==null)&&!s)try{if(e.tagName.includes("-"))e[t]=r;else{let h=r==null?"":r;t==="list"?o=!1:(i==null||e[t]!=h)&&(e[t]=h)}}catch{}let c=!1;a!==(a=a.replace(/^xlink\:?/,""))&&(t=a,c=!0),r==null||r===!1?(r!==!1||e.getAttribute(t)==="")&&(c?e.removeAttributeNS(YZ,t):e.removeAttribute(t)):(!o||n&4||s)&&!l&&(r=r===!0?"":r,c?e.setAttributeNS(YZ,t,r):e.setAttribute(t,r))}}},cIe=/\s/,eQ=e=>e?e.split(cIe):[],Whe=(e,t,i,r)=>{const s=t.$elm$.nodeType===11&&t.$elm$.host?t.$elm$.host:t.$elm$,n=e&&e.$attrs$||QZ,o=t.$attrs$||QZ;for(r in n)r in o||KZ(s,r,n[r],void 0,i,t.$flags$);for(r in o)KZ(s,r,n[r],o[r],i,t.$flags$)},YD=(e,t,i,r)=>{let s=t.$children$[i],n=0,o,a,l;if(Vhe||(tH=!0,s.$tag$==="slot"&&(Rw&&r.classList.add(Rw+"-s"),s.$flags$|=s.$children$?2:1)),s.$text$!==null)o=s.$elm$=jh.createTextNode(s.$text$);else if(s.$flags$&1)o=s.$elm$=jh.createTextNode("");else{if(Xl||(Xl=s.$tag$==="svg"),o=s.$elm$=jh.createElementNS(Xl?iIe:rIe,s.$flags$&2?"slot-fb":s.$tag$),Xl&&s.$tag$==="foreignObject"&&(Xl=!1),Whe(null,s,Xl),sIe(Rw)&&o["s-si"]!==Rw&&o.classList.add(o["s-si"]=Rw),s.$children$)for(n=0;n<s.$children$.length;++n)a=YD(e,s,n,o),a&&o.appendChild(a);s.$tag$==="svg"?Xl=!1:o.tagName==="foreignObject"&&(Xl=!0)}return o["s-hn"]=vF,s.$flags$&3&&(o["s-sr"]=!0,o["s-cr"]=Bhe,o["s-sn"]=s.$name$||"",l=e&&e.$children$&&e.$children$[i],l&&l.$tag$===s.$tag$&&e.$elm$&&YC(e.$elm$,!1)),o},YC=(e,t)=>{yo.$flags$|=1;const i=e.childNodes;for(let r=i.length-1;r>=0;r--){const s=i[r];s["s-hn"]!==vF&&s["s-ol"]&&(Zhe(s).insertBefore(s,rH(s)),s["s-ol"].remove(),s["s-ol"]=void 0,tH=!0),t&&YC(s,t)}yo.$flags$&=-2},Xhe=(e,t,i,r,s,n)=>{let o=e["s-cr"]&&e["s-cr"].parentNode||e,a;for(o.shadowRoot&&o.tagName===vF&&(o=o.shadowRoot);s<=n;++s)r[s]&&(a=YD(null,i,s,e),a&&(r[s].$elm$=a,o.insertBefore(a,rH(t))))},Yhe=(e,t,i,r,s)=>{for(;t<=i;++t)(r=e[t])&&(s=r.$elm$,Khe(r),qD=!0,s["s-ol"]?s["s-ol"].remove():YC(s,!0),s.remove())},uIe=(e,t,i,r)=>{let s=0,n=0,o=0,a=0,l=t.length-1,c=t[0],h=t[l],p=r.length-1,f=r[0],g=r[p],y,v;for(;s<=l&&n<=p;)if(c==null)c=t[++s];else if(h==null)h=t[--l];else if(f==null)f=r[++n];else if(g==null)g=r[--p];else if(IM(c,f))Ow(c,f),c=t[++s],f=r[++n];else if(IM(h,g))Ow(h,g),h=t[--l],g=r[--p];else if(IM(c,g))(c.$tag$==="slot"||g.$tag$==="slot")&&YC(c.$elm$.parentNode,!1),Ow(c,g),e.insertBefore(c.$elm$,h.$elm$.nextSibling),c=t[++s],g=r[--p];else if(IM(h,f))(c.$tag$==="slot"||g.$tag$==="slot")&&YC(h.$elm$.parentNode,!1),Ow(h,f),e.insertBefore(h.$elm$,c.$elm$),h=t[--l],f=r[++n];else{for(o=-1,a=s;a<=l;++a)if(t[a]&&t[a].$key$!==null&&t[a].$key$===f.$key$){o=a;break}o>=0?(v=t[o],v.$tag$!==f.$tag$?y=YD(t&&t[n],i,o,e):(Ow(v,f),t[o]=void 0,y=v.$elm$),f=r[++n]):(y=YD(t&&t[n],i,n,e),f=r[++n]),y&&Zhe(c.$elm$).insertBefore(y,rH(c.$elm$))}s>l?Xhe(e,r[p+1]==null?null:r[p+1].$elm$,i,r,n,p):n>p&&Yhe(t,s,l)},IM=(e,t)=>e.$tag$===t.$tag$?e.$tag$==="slot"?e.$name$===t.$name$:e.$key$===t.$key$:!1,rH=e=>e&&e["s-ol"]||e,Zhe=e=>(e["s-ol"]?e["s-ol"]:e).parentNode,Ow=(e,t)=>{const i=t.$elm$=e.$elm$,r=e.$children$,s=t.$children$,n=t.$tag$,o=t.$text$;let a;o===null?(Xl=n==="svg"?!0:n==="foreignObject"?!1:Xl,n==="slot"||Whe(e,t,Xl),r!==null&&s!==null?uIe(i,r,t,s):s!==null?(e.$text$!==null&&(i.textContent=""),Xhe(i,null,t,s,0,s.length-1)):r!==null&&Yhe(r,0,r.length-1),Xl&&n==="svg"&&(Xl=!1)):(a=i["s-cr"])?a.parentNode.textContent=o:e.$text$!==o&&(i.data=o)},Qhe=e=>{let t=e.childNodes,i,r,s,n,o,a;for(r=0,s=t.length;r<s;r++)if(i=t[r],i.nodeType===1){if(i["s-sr"]){for(o=i["s-sn"],i.hidden=!1,n=0;n<s;n++)if(a=t[n].nodeType,t[n]["s-hn"]!==i["s-hn"]||o!==""){if(a===1&&o===t[n].getAttribute("slot")){i.hidden=!0;break}}else if(a===1||a===3&&t[n].textContent.trim()!==""){i.hidden=!0;break}}Qhe(i)}},Ph=[],Jhe=e=>{let t,i,r,s,n,o,a=0,l=e.childNodes,c=l.length;for(;a<c;a++){if(t=l[a],t["s-sr"]&&(i=t["s-cr"])&&i.parentNode)for(r=i.parentNode.childNodes,s=t["s-sn"],o=r.length-1;o>=0;o--)i=r[o],!i["s-cn"]&&!i["s-nr"]&&i["s-hn"]!==t["s-hn"]&&(tQ(i,s)?(n=Ph.find(h=>h.$nodeToRelocate$===i),qD=!0,i["s-sn"]=i["s-sn"]||s,n?n.$slotRefNode$=t:Ph.push({$slotRefNode$:t,$nodeToRelocate$:i}),i["s-sr"]&&Ph.map(h=>{tQ(h.$nodeToRelocate$,i["s-sn"])&&(n=Ph.find(p=>p.$nodeToRelocate$===i),n&&!h.$slotRefNode$&&(h.$slotRefNode$=n.$slotRefNode$))})):Ph.some(h=>h.$nodeToRelocate$===i)||Ph.push({$nodeToRelocate$:i}));t.nodeType===1&&Jhe(t)}},tQ=(e,t)=>e.nodeType===1?e.getAttribute("slot")===null&&t===""||e.getAttribute("slot")===t:e["s-sn"]===t?!0:t==="",Khe=e=>{e.$attrs$&&e.$attrs$.ref&&e.$attrs$.ref(null),e.$children$&&e.$children$.map(Khe)},hIe=(e,t)=>{const i=e.$hostElement$,r=e.$cmpMeta$,s=e.$vnode$||XD(null,null),n=qhe(t)?t:Hhe(null,null,t);vF=i.tagName,r.$attrsToReflect$&&(n.$attrs$=n.$attrs$||{},r.$attrsToReflect$.map(([o,a])=>n.$attrs$[a]=i[o])),n.$tag$=null,n.$flags$|=4,e.$vnode$=n,n.$elm$=s.$elm$=i.shadowRoot||i,Rw=i["s-sc"],Bhe=i["s-cr"],Vhe=WD&&(r.$flags$&1)!==0,qD=!1,Ow(s,n);{if(yo.$flags$|=1,tH){Jhe(n.$elm$);let o,a,l,c,h,p,f=0;for(;f<Ph.length;f++)o=Ph[f],a=o.$nodeToRelocate$,a["s-ol"]||(l=jh.createTextNode(""),l["s-nr"]=a,a.parentNode.insertBefore(a["s-ol"]=l,a));for(f=0;f<Ph.length;f++)if(o=Ph[f],a=o.$nodeToRelocate$,o.$slotRefNode$){for(c=o.$slotRefNode$.parentNode,h=o.$slotRefNode$.nextSibling,l=a["s-ol"];l=l.previousSibling;)if(p=l["s-nr"],p&&p["s-sn"]===a["s-sn"]&&c===p.parentNode&&(p=p.nextSibling,!p||!p["s-nr"])){h=p;break}(!h&&c!==a.parentNode||a.nextSibling!==h)&&a!==h&&(!a["s-hn"]&&a["s-ol"]&&(a["s-hn"]=a["s-ol"].parentNode.nodeName),c.insertBefore(a,h))}else a.nodeType===1&&(a.hidden=!0)}qD&&Qhe(n.$elm$),yo.$flags$&=-2,Ph.length=0}},dIe=e=>yr.lazyLoad?WS(e).$hostElement$:e,Xmt=(e,t,i)=>{const r=dIe(e);return{emit:s=>(yr.isDev&&!r.isConnected&&ide(`The "${t}" event was emitted, but the dispatcher node is no longer connected to the dom.`),pIe(r,t,{bubbles:!!(i&4),composed:!!(i&2),cancelable:!!(i&1),detail:s}))}},pIe=(e,t,i)=>{const r=yo.ce(t,i);return e.dispatchEvent(r),r},fIe=(e,t)=>{},sH=(e,t)=>(e.$flags$|=16,fIe(e,e.$ancestorComponent$),DIe(()=>mIe(e,t))),mIe=(e,t)=>{const i=e.$hostElement$,r=D1("scheduleUpdate",e.$cmpMeta$.$tagName$),s=i;let n;return t?n=eT(s,"componentWillLoad"):n=eT(s,"componentWillUpdate"),n=iQ(n,()=>eT(s,"componentWillRender")),r(),iQ(n,()=>gIe(e,s,t))},gIe=async(e,t,i)=>{const r=e.$hostElement$,s=D1("update",e.$cmpMeta$.$tagName$);r["s-rc"],i&&eIe(e);const n=D1("render",e.$cmpMeta$.$tagName$);yIe(e,t,r),n(),s(),vIe(e)},yIe=(e,t,i)=>{try{XZ=t,t=t.render&&t.render(),e.$flags$&=-17,e.$flags$|=2,(yr.hasRenderFn||yr.reflect)&&(yr.vdomRender||yr.reflect)&&(yr.hydrateServerSide||hIe(e,t))}catch(a){fO(a,e.$hostElement$)}return XZ=null,null},vIe=e=>{const t=e.$cmpMeta$.$tagName$,i=e.$hostElement$,r=D1("postUpdate",t),s=i;e.$ancestorComponent$,eT(s,"componentDidRender"),e.$flags$&64?(eT(s,"componentDidUpdate"),r()):(e.$flags$|=64,eT(s,"componentDidLoad"),r())},Ymt=e=>{if(yr.updatable){const t=WS(e),i=t.$hostElement$.isConnected;return i&&(t.$flags$&18)===2&&sH(t,!1),i}return!1},eT=(e,t,i)=>{if(e&&e[t])try{return e[t](i)}catch(r){fO(r)}},iQ=(e,t)=>e&&e.then?e.then(t):t(),_Ie=(e,t)=>e!=null&&!iH(e)?t&4?e==="false"?!1:e===""||!!e:t&2?parseFloat(e):t&1?String(e):e:e,bIe=(e,t)=>WS(e).$instanceValues$.get(t),wIe=(e,t,i,r)=>{const s=WS(e),n=e,o=s.$instanceValues$.get(t),a=s.$flags$,l=n;if(i=_Ie(i,r.$members$[t][0]),i!==o){s.$instanceValues$.set(t,i);{if(r.$watchers$&&a&128){const c=r.$watchers$[t];c&&c.map(h=>{try{l[h](i,o,t)}catch(p){fO(p,n)}})}if((a&18)===2){if(l.componentShouldUpdate&&l.componentShouldUpdate(i,o,t)===!1)return;sH(s,!1)}}}},xIe=(e,t,i)=>{if(t.$members$){e.watchers&&(t.$watchers$=e.watchers);const r=Object.entries(t.$members$),s=e.prototype;r.map(([n,[o]])=>{(o&31||o&32)&&Object.defineProperty(s,n,{get(){return bIe(this,n)},set(a){wIe(this,n,a,t)},configurable:!0,enumerable:!0})});{const n=new Map;s.attributeChangedCallback=function(o,a,l){yo.jmp(()=>{const c=n.get(o);if(this.hasOwnProperty(c))l=this[c],delete this[c];else if(s.hasOwnProperty(c)&&typeof this[c]=="number"&&this[c]==l)return;this[c]=l===null&&typeof this[c]=="boolean"?!1:l})},e.observedAttributes=r.filter(([o,a])=>a[0]&15).map(([o,a])=>{const l=a[1]||o;return n.set(l,o),a[0]&512&&t.$attrsToReflect$.push([o,l]),l})}}return e},TIe=async(e,t,i,r,s)=>{if((t.$flags$&32)===0&&(s=e.constructor,t.$flags$|=32,customElements.whenDefined(i.$tagName$).then(()=>t.$flags$|=128),s.style)){let o=s.style;typeof o!="string"&&(o=o[t.$modeName$=tIe(e)]);const a=jhe(i,t.$modeName$);if(!ZD.has(a)){const l=D1("registerStyles",i.$tagName$);JPe(a,o,!!(i.$flags$&1)),l()}}t.$ancestorComponent$,(()=>sH(t,!0))()},SIe=e=>{},EIe=e=>{if((yo.$flags$&1)===0){const t=WS(e),i=t.$cmpMeta$,r=D1("connectedCallback",i.$tagName$);t.$flags$&1?(Ghe(e,t,i.$listeners$),SIe(t.$lazyInstance$)):(t.$flags$|=1,i.$flags$&12&&AIe(e),i.$members$&&Object.entries(i.$members$).map(([s,[n]])=>{if(n&31&&e.hasOwnProperty(s)){const o=e[s];delete e[s],e[s]=o}}),TIe(e,t,i)),r()}},AIe=e=>{const t=e["s-cr"]=jh.createComment("");t["s-cn"]=!0,e.insertBefore(t,e.firstChild)},CIe=e=>{if((yo.$flags$&1)===0){const t=WS(e);t.$rmListeners$&&(t.$rmListeners$.map(i=>i()),t.$rmListeners$=void 0)}},Zmt=(e,t)=>{const i={$flags$:t[0],$tagName$:t[1]};i.$members$=t[2],i.$listeners$=t[3],i.$watchers$=e.$watchers$,i.$attrsToReflect$=[],!WD&&i.$flags$&1&&(i.$flags$|=8);const r=e.prototype.connectedCallback,s=e.prototype.disconnectedCallback;return Object.assign(e.prototype,{__registerHost(){OIe(this,i)},connectedCallback(){EIe(this),r&&r.call(this)},disconnectedCallback(){CIe(this),s&&s.call(this)},__attachShadow(){WD?this.attachShadow({mode:"open",delegatesFocus:!!(i.$flags$&16)}):this.shadowRoot=this}}),e.is=i.$tagName$,xIe(e,i)},Qmt=e=>{const t=new URL(e,yo.$resourcesUrl$);return t.origin!==qS.location.origin?t.href:t.pathname},RIe=e=>yo.$resourcesUrl$=e,ede=new WeakMap,WS=e=>ede.get(e),OIe=(e,t)=>{const i={$flags$:0,$hostElement$:e,$cmpMeta$:t,$instanceValues$:new Map};return Ghe(e,i,t.$listeners$),ede.set(e,i)},rQ=(e,t)=>t in e,fO=(e,t)=>(0,console.error)(e,t),tde=yr.isTesting?["STENCIL:"]:["%cstencil","color: white;background:#4c47ff;font-weight: bold; font-size:10px; padding:2px 6px; border-radius: 5px"],MIe=(...e)=>console.error(...tde,...e),ide=(...e)=>console.warn(...tde,...e),ZD=new Map,PIe=[],sQ=[],rde=[],IIe=(e,t)=>i=>{e.push(i),wV||(wV=!0,t&&yo.$flags$&4?$Ie(xV):yo.raf(xV))},nQ=e=>{for(let t=0;t<e.length;t++)try{e[t](performance.now())}catch(i){fO(i)}e.length=0},xV=()=>{nQ(sQ),nQ(rde),(wV=sQ.length>0)&&yo.raf(xV)},$Ie=e=>WPe().then(e),DIe=IIe(rde,!0),Jmt={isDev:!!yr.isDev,isBrowser:!0,isServer:!1,isTesting:!!yr.isTesting};let sde;function LIe(){RIe(Au(ui(sde)))}sde="components/assets";const nde=Symbol("widget"),NIe=[],FIe={},QD=new WeakMap;function ode(e,t){let i=t.children;if(i&&i.length)for(let s=0;s<i.length;++s)i[s]=ode(e,i[s]);else i=NIe;const r=t.vnodeSelector;if(nH(r)){const s=t.properties||FIe,n=s.key||r;return{vnodeSelector:"div",properties:{key:n,afterCreate:UIe,afterUpdate:kIe,afterRemoved:ade,parentWidget:e,widgetConstructor:r,widgetProperties:me(I({},s),{key:n,children:i})},children:void 0,text:void 0,domNode:null}}return t}function UIe(e,t,i,{parentWidget:r,widgetConstructor:s,widgetProperties:n}){const o=new s(n);o.container=e,QD.set(e,o),o.afterCreate==null||o.afterCreate(o,e),r._internalHandles.add(km(()=>ade(e)))}function kIe(e,t,i,{widgetProperties:r}){const s=QD.get(e);s&&(s.set(r),s.afterUpdate==null||s.afterUpdate(s,e))}function ade(e){const t=QD.get(e);t&&(t.destroy(),QD.delete(e))}function nH(e){return typeof e=="function"&&e[nde]}function lde(){return getComputedStyle(document.body).getPropertyValue("--esri-calcite-theme-name").replace(/\s|'|"/g,"")}function cde(){return lde().startsWith("dark")}function zIe(){return"calcite-theme-"+(cde()?"dark":"light")}const ude="esri.widgets.Widget",oQ=he.getLogger(ude);let BIe=0;const VIe={widgetIcon:"esri-icon-checkbox-unchecked"};function hde(e,t){for(const i in t)e[i]!=null&&(typeof e[i]=="object"&&typeof t[i]=="object"?hde(e[i],t[i]):e[i]=t[i]);return e}const GIe=HPe({postProcessProjectionOptions(e){const t=e.eventHandlerInterceptor,i=/capture$/i;e.eventHandlerInterceptor=(r,s,n,o)=>{const a=t(r,s,n,o),l=i.test(r);if(!((r=r.replace(i,"")).toLowerCase()in n)||l){const c=r[2].toLowerCase()+r.slice(3),h=g=>a.call(n,g);n.addEventListener(c,h,l);const p=()=>n.removeEventListener(c,h,l),f=o.afterRemoved;o.afterRemoved=g=>{f==null||f(g),p()}}return a}},handleInterceptedEvent(e,t,i,r){const{eventPhase:s,type:n}=r,o=s===Event.CAPTURING_PHASE;let a=`on${n}${o?"capture":""}`;const l=t.properties;(a in l||(a=`on${n[0].toUpperCase()}${n.slice(1)}${o?"Capture":""}`,a in l))&&(Ahe(),e.scheduleRender(),l[a].call(l.bind||i,r))}});let q5=!1,Vs=class extends kS(xr.EventedAccessor){constructor(e,t){super(e,t),this._attached=!1,this._internalHandles=new Ut,this._projector=GIe,this._readyForTrueRender=!1,this.domNode=null,this.iconClass=VIe.widgetIcon,this.label=this.declaredClass.split(".").pop(),this.visible=!0,this.key=this,this._loadLocale=w7(async()=>{if(this._messageBundleProps&&this._messageBundleProps.length){const a=await Ks(this._messageBundleProps.map(async({bundlePath:l,propertyName:c})=>{let h=await Rce(l);this.uiStrings&&Object.keys(this.uiStrings)&&(h=hde(se(h),this.uiStrings)),this[c]=h}));for(const l of a)l.error&&oQ.error("widget-intl:locale-error",this.declaredClass,l.error)}await this.loadLocale()}),LIe();const i=["light","dark"],r=lde()||"light";i.includes(r)||RT(oQ,"The following themes are deprecated: light-blue, dark-blue, light-green, dark-green, light-purple, dark-purple, light-red, and dark-red.",{version:"4.19",warnOnce:!0,see:"https://developers.arcgis.com/javascript/latest/styling/"});const s="esri-widget-uid-"+zhe(),n=this.render.bind(this);this._trackingTarget=new PN(()=>this.scheduleRender());const o=()=>{var a;if(!this._readyForTrueRender||this.destroyed)return null;if(!this.visible)return{vnodeSelector:"div",properties:{key:s,class:"",styles:{display:"none"}},domNode:void 0,children:void 0,text:void 0};const l=n();let{properties:c}=l;c||(l.properties=c={});let{key:h,styles:p}=c;h||(c.key=s),p||(c.styles=p={}),p.display||(p.display="");let f=0;return(a=l.children)==null||a.forEach(g=>{if(nH(g.vnodeSelector))return;let{properties:y}=g;y||(g.properties=y={}),y.key||(y.key=`${this.id}--${f++}`)}),ode(this,l)};this.render=()=>{if(q5)return o();let a=pPe(this);if(a)return a;this._trackingTarget.clear(),q5=!0;try{a=Em(this._trackingTarget,o)}finally{q5=!1}return fPe(this,a),a},this.addResolvingPromise(this._resourcesFetch=this.beforeFirstRender().then(()=>{this._readyForTrueRender=!0,this._postInitialize()}))}normalizeCtorArgs(e,t){const i=I({},e);return t&&(i.container=t),i}postInitialize(){}beforeFirstRender(){return Promise.all([this.loadDependencies(),this._loadLocale()]).then(()=>{}).catch(a6)}async loadDependencies(){}async loadLocale(){}destroy(){this.destroyed||(this._trackingTarget=rt(this._trackingTarget),this.viewModel=rt(this.viewModel),this._detach(this.container),this._set("container",null),this._internalHandles.destroy(),this._emitter.clear(),this.render=()=>null,this._projector=null,j5(this))}set container(e){this._get("container")||this._set("container",e)}castContainer(e){return KN(e)}get id(){return this._get("id")||this.get("container.id")||Date.now().toString(16)+"-widget-"+BIe++}set id(e){e&&this._set("id",e)}get renderable(){return this._resourcesFetch}get test(){return{projector:this._projector,handles:this._internalHandles}}render(){throw new Error("not implemented")}scheduleRender(){this.destroyed||(j5(this),this._projector.scheduleRender())}classes(...e){return Rhe.apply(this,e)}own(e){arguments.length>1&&(e=Array.prototype.slice.call(arguments)),this._internalHandles.add(e)}renderNow(){j5(this),this._projector.renderNow()}_postInitialize(){var e;if(this.destroyed)return;this.scheduleRender(),(e=this._delegatedEventNames)!=null&&e.length&&this._internalHandles.add(Nt(()=>this.viewModel,(i,r)=>{r&&this._internalHandles.remove("delegated-events"),i&&this._internalHandles.add(this._delegatedEventNames.map(s=>i.on(s,n=>{this.emit(s,n)})),"delegated-events")},fn)),this.postInitialize();const t=async()=>{await this._loadLocale().catch(a6),this.scheduleRender()};this._internalHandles.add([uEe(t),Nt(()=>this.uiStrings,t),IN(()=>this.container,i=>{this.destroyed||this._attach(i)},{initial:!0,once:!0})])}_attach(e){e&&(this._projector.merge(e,this.render),this._attached=!0)}_detach(e){e&&this._attached&&(this._projector.detach(this.render),e.parentNode&&e.parentNode.removeChild(e),this._attached=!1)}};Vs[nde]=!0,u([d()],Vs.prototype,"_readyForTrueRender",void 0),u([d({value:null})],Vs.prototype,"container",null),u([At("container")],Vs.prototype,"castContainer",null),u([d({aliasOf:"container"})],Vs.prototype,"domNode",void 0),u([d()],Vs.prototype,"iconClass",void 0),u([d()],Vs.prototype,"id",null),u([d()],Vs.prototype,"label",void 0),u([d()],Vs.prototype,"renderable",null),u([d()],Vs.prototype,"uiStrings",void 0),u([d()],Vs.prototype,"viewModel",void 0),u([d()],Vs.prototype,"visible",void 0),u([d()],Vs.prototype,"key",void 0),u([d()],Vs.prototype,"children",void 0),u([d()],Vs.prototype,"afterCreate",void 0),u([d()],Vs.prototype,"afterUpdate",void 0),u([d()],Vs.prototype,"afterRemoved",void 0),Vs=u([P(ude)],Vs);const Ia=Vs;function jIe(e,t,i){return e.units[t][i]}function _F(e,t,i,r=2,s="abbr"){return`${Rm(t,{minimumFractionDigits:r,maximumFractionDigits:r})} ${jIe(e,i,s)}`}function Kmt(e,t,i,r=2,s="abbr"){const n=FRe(t,i);return _F(e,_s(t,i,n),n,r,s)}function egt(e,t,i,r=2,s="abbr"){const n=URe(t,i);return _F(e,_s(t,i,n),n,r,s)}function tgt(e,t,i,r=2,s="abbr"){const n=kRe(t,i);return _F(e,_s(t,i,n),n,r,s)}function igt(e,t,i,r=2,s="abbr"){const n=zRe(t,i);return _F(e,_s(t,i,n),n,r,s)}const aQ=["B","kB","MB","GB","TB"];function HIe(e,t){let i=t===0?0:Math.floor(Math.log(t)/Math.log(HT.KILOBYTES));i=Be(i,0,aQ.length-1);const r=Rm(t/HT.KILOBYTES**i,{maximumFractionDigits:2});return _p(e.units.bytes[aQ[i]],{fileSize:r})}function qIe(e){const{exifInfo:t,exifName:i,tagName:r}=e;if(!t||!i||!r)return null;const s=t.find(n=>n.name===i);return s?WIe({tagName:r,tags:s.tags}):null}function WIe(e){const{tagName:t,tags:i}=e;if(!i||!t)return null;const r=i.find(s=>s.name===t);return r&&r.value||null}var TV;const XIe={1:{id:1,rotation:0,mirrored:!1},2:{id:2,rotation:0,mirrored:!0},3:{id:3,rotation:180,mirrored:!1},4:{id:4,rotation:180,mirrored:!0},5:{id:5,rotation:-90,mirrored:!0},6:{id:6,rotation:90,mirrored:!1},7:{id:7,rotation:90,mirrored:!0},8:{id:8,rotation:-90,mirrored:!1}};let Ba=TV=class extends fe{constructor(e){super(e),this.contentType=null,this.exifInfo=null,this.id=null,this.globalId=null,this.keywords=null,this.name=null,this.parentGlobalId=null,this.parentObjectId=null,this.size=null,this.url=null}get orientationInfo(){const{exifInfo:e}=this,t=qIe({exifName:"Exif IFD0",tagName:"Orientation",exifInfo:e});return XIe[t]||null}clone(){return new TV({contentType:this.contentType,exifInfo:this.exifInfo,id:this.id,globalId:this.globalId,keywords:this.keywords,name:this.name,parentGlobalId:this.parentGlobalId,parentObjectId:this.parentObjectId,size:this.size,url:this.url})}};u([d({type:String})],Ba.prototype,"contentType",void 0),u([d()],Ba.prototype,"exifInfo",void 0),u([d({readOnly:!0})],Ba.prototype,"orientationInfo",null),u([d({type:ir})],Ba.prototype,"id",void 0),u([d({type:String})],Ba.prototype,"globalId",void 0),u([d({type:String})],Ba.prototype,"keywords",void 0),u([d({type:String})],Ba.prototype,"name",void 0),u([d({json:{read:!1}})],Ba.prototype,"parentGlobalId",void 0),u([d({json:{read:!1}})],Ba.prototype,"parentObjectId",void 0),u([d({type:ir})],Ba.prototype,"size",void 0),u([d({json:{read:!1}})],Ba.prototype,"url",void 0),Ba=TV=u([P("esri.layers.support.AttachmentInfo")],Ba);const dde=Ba;var SV;let io=SV=class extends fe{constructor(e){super(e),this.attachmentTypes=null,this.attachmentsWhere=null,this.keywords=null,this.globalIds=null,this.name=null,this.num=null,this.objectIds=null,this.returnMetadata=!1,this.size=null,this.start=null,this.where=null}writeStart(e,t){t.resultOffset=this.start,t.resultRecordCount=this.num||10}clone(){return new SV(se({attachmentTypes:this.attachmentTypes,attachmentsWhere:this.attachmentsWhere,keywords:this.keywords,where:this.where,globalIds:this.globalIds,name:this.name,num:this.num,objectIds:this.objectIds,returnMetadata:this.returnMetadata,size:this.size,start:this.start}))}};u([d({type:[String],json:{write:!0}})],io.prototype,"attachmentTypes",void 0),u([d({type:String,json:{read:{source:"attachmentsDefinitionExpression"},write:{target:"attachmentsDefinitionExpression"}}})],io.prototype,"attachmentsWhere",void 0),u([d({type:[String],json:{write:!0}})],io.prototype,"keywords",void 0),u([d({type:[Number],json:{write:!0}})],io.prototype,"globalIds",void 0),u([d({json:{write:!0}})],io.prototype,"name",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],io.prototype,"num",void 0),u([d({type:[Number],json:{write:!0}})],io.prototype,"objectIds",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],io.prototype,"returnMetadata",void 0),u([d({type:[Number],json:{write:!0}})],io.prototype,"size",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],io.prototype,"start",void 0),u([Fe("start"),Fe("num")],io.prototype,"writeStart",null),u([d({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],io.prototype,"where",void 0),io=SV=u([P("esri.rest.support.AttachmentQuery")],io),io.from=Ir(io);const JD=io,YIe="esri.widgets.Feature.support.featureUtils",lQ=he.getLogger(YIe),ZIe=/href=(""|'')/gi,QIe=/(\{([^\{\r\n]+)\})/g,JIe=/\'/g,pde=/^\s*expression\//i,KIe=/(\n)/gi,e$e=/[\u00A0-\u9999<>\&]/gim,t$e=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,i$e=/^(?:mailto:|tel:)/,fde="relationships/",EV=X7("short-date-short-time");function mde(e){if(!R(e))return e.get("sourceLayer")||e.get("layer")}async function KD(e,t){return typeof e=="function"?e.call(null,t):e}function gde(e=""){if(e)return!i$e.test(e.trim().toLowerCase())}function yde(e){return!!e&&pde.test(e)}function r$e(e,t){if(!yde(t)||!e)return null;const i=t.replace(pde,"").toLowerCase();let r;return e.some(s=>s.name.toLowerCase()===i&&(r=s,!0)),r}function vde(e,t){const i=r$e(t,e==null?void 0:e.fieldName);return i?i.title||null:e?e.label||e.fieldName:null}function s$e(e,t){const i=t.get(e.toLowerCase());return`{${i&&i.fieldName||e}}`}function n$e(e){return e.replace(ZIe,"")}function eL(e,t){const i=oH(t,e);return i?i.name:e}function o$e(e,t){return e&&e.map(i=>eL(i,t))}function oH(e,t){return e&&typeof e.getField=="function"?e.getField(t):null}function _de(e){return`${e}`.trim()}function q_({attributes:e,globalAttributes:t,layer:i,text:r,expressionAttributes:s,fieldInfoMap:n}){return r?AV({formattedAttributes:t,template:u$e(r,I(I(I({},t),s),e),i),fieldInfoMap:n}):""}function AV({formattedAttributes:e,template:t,fieldInfoMap:i}){return _de(n$e(_p(_p(t,r=>s$e(r,i)),e)))}function a$e(e,t,i=!1){const r=t[e];if(typeof r=="string"){const s="%27",n=(i?encodeURIComponent(r):r).replace(JIe,s);t[e]=n}}function l$e(e,t=!1){const i=I({},e);return Object.keys(i).forEach(r=>a$e(r,i,t)),i}function c$e(e,t,i){const r=(t=_de(t))&&t[0]!=="{";return _p(e,l$e(i,r))}function CV(e,t){return e.replace(QIe,(i,r,s)=>{const n=oH(t,s);return n?`{${n.name}}`:r})}function u$e(e,t,i){const r=CV(e,i);return r&&r.replace(t$e,(s,n,o)=>c$e(s,n||o,t))}function h$e(e,t){if(typeof e=="string"&&t&&t.dateFormat==null&&(t.places!=null||t.digitSeparator!=null)){const i=Number(e);if(!isNaN(i))return i}return e}function d$e(e){return(e==null?void 0:e.type)==="feature"}function p$e(e){return(e==null?void 0:e.type)==="map-image"}function f$e(e){return!(e==null||!e.layer)}function bde(e,t){const i=t.fieldInfos,r=t.fieldName,s=wde(i,r),n=s==null?void 0:s.clone(),o=t.preventPlacesFormatting,a=t.layer,l=oH(a,r);if(n&&(l==null?void 0:l.type)==="date"){const h=n.format||new GA;h.dateFormat=h.dateFormat||"short-date-short-time",h.dateTimeFormatOptions=d$e(a)&&a.datesInUnknownTimezone||f$e(a)&&p$e(a.layer)&&a.layer.datesInUnknownTimezone?{timeZone:"UTC"}:null,n.format=h}const c=n&&n.format;return typeof(e=h$e(e,c))=="string"||e==null||c==null?mO(e):o?Rm(e,me(I({},hle(c)),{minimumFractionDigits:0,maximumFractionDigits:20})):c.format(e)}function wde(e,t){if(!e||!e.length||!t)return;const i=t.toLowerCase();let r;return e.some(s=>!(!s.fieldName||s.fieldName.toLowerCase()!==i)&&(r=s,!0)),r}function m$e({fieldName:e,graphic:t,layer:i}){if(am(e)||!i||typeof i.getFeatureType!="function")return null;const{typeIdField:r}=i;if(!r||e!==r)return null;const s=i.getFeatureType(t);return s?s.name:null}function g$e({fieldName:e,value:t,graphic:i,layer:r}){if(am(e)||!r||typeof r.getFieldDomain!="function")return null;const s=r.getFieldDomain(e,{feature:i});return s&&s.type==="coded-value"?s.getName(t):null}function y$e(e,t){const{creatorField:i,creationDateField:r,editorField:s,editDateField:n}=e;if(!t)return;const o=t[n];if(typeof o=="number"){const l=t[s];return{type:"edit",date:Cm(o,EV),user:l}}const a=t[r];if(typeof a=="number"){const l=t[i];return{type:"create",date:Cm(a,EV),user:l}}return null}function v$e(e,t){const i=new Map;return e&&e.forEach(r=>{const s=eL(r.fieldName,t);r.fieldName=s,i.set(s.toLowerCase(),r)}),i}function cQ(e){const t=[];if(!e)return t;const{fieldInfos:i,content:r}=e;return i&&t.push(...i),r&&Array.isArray(r)&&r.forEach(s=>{if(s.type==="fields"){const n=s&&s.fieldInfos;n&&t.push(...n)}}),t}function aH(e){return e.replace(e$e,t=>`&#${t.charCodeAt(0)};`)}function mO(e){return typeof e=="string"?e.replace(KIe,'<br class="esri-text-new-line" />'):e}function _$e(e){const{value:t,fieldName:i,fieldInfos:r,fieldInfoMap:s,layer:n,graphic:o}=e;if(t==null)return"";const a=g$e({fieldName:i,value:t,graphic:o,layer:n});if(a)return a;const l=m$e({fieldName:i,graphic:o,layer:n});if(l)return l;if(s.get(i.toLowerCase()))return bde(t,{fieldInfos:r,fieldName:i,layer:n});const c=n&&n.fieldsIndex;return c&&c.isDateField(i)?Cm(t,EV):mO(t)}function W5({fieldInfos:e,attributes:t,layer:i,graphic:r,fieldInfoMap:s,relatedInfos:n}){const o={};return n==null||n.forEach(a=>S$e(o,a)),Object.keys(t).forEach(a=>{const l=t[a];o[a]=_$e({fieldName:a,fieldInfos:e,fieldInfoMap:s,layer:i,value:l,graphic:r})}),o}async function b$e(e,t){var i,r;const{layer:s,graphic:n,outFields:o,objectIds:a,returnGeometry:l,spatialReference:c}=e,h=a[0];if(typeof h!="number"&&typeof h!="string"){const f="Could not query required fields for the specified feature. The feature's ID is invalid.",g={layer:s,graphic:n,objectId:h,requiredFields:o};return lQ.warn(f,g),null}if((i=s.capabilities)==null||(r=i.operations)==null||!r.supportsQuery){const f="The specified layer cannot be queried. The following fields will not be available.",g={layer:s,graphic:n,requiredFields:o,returnGeometry:l};return lQ.warn(f,g),null}const p=s.createQuery();return p.objectIds=a,p.outFields=o!=null&&o.length?o:[s.objectIdField],p.returnGeometry=!!l,p.returnZ=!!l,p.returnM=!!l,p.outSpatialReference=c,(await s.queryFeatures(p,t)).features[0]}async function w$e(e){var t;if((t=e.expressionInfos)==null||!t.length)return!1;const i=await wp(),{arcadeUtils:{hasGeometryFunctions:r}}=i;return r(e)}async function x$e({graphic:e,popupTemplate:t,layer:i,spatialReference:r},s){if(!i||!t||(typeof i.load=="function"&&await i.load(s),!e.attributes))return;const n=e.attributes[i.objectIdField];if(n==null)return;const o=[n],a=await t.getRequiredFields(i.fieldsIndex),l=oEe(a,e),c=l?[]:a,h=t.returnGeometry||await w$e(t);if(l&&!h)return;const p=await b$e({layer:i,graphic:e,outFields:c,objectIds:o,returnGeometry:h,spatialReference:r},s);p&&(p.geometry&&(e.geometry=p.geometry),p.attributes&&(e.attributes=I(I({},e.attributes),p.attributes)))}function am(e=""){return!!e&&e.indexOf(fde)!==-1}function T$e(e){return e?`${fde}${e.layerId}/${e.fieldName}`:""}function uQ({attributes:e,graphic:t,relatedInfo:i}){e&&t&&i&&Object.keys(t.attributes).forEach(r=>{const s=T$e({layerId:i.relation.id.toString(),fieldName:r});e[s]=t.attributes[r]})}function S$e(e,t){e&&t&&(t.relatedFeatures&&t.relatedFeatures&&t.relatedFeatures.forEach(i=>uQ({attributes:e,graphic:i,relatedInfo:t})),t.relatedStatsFeatures&&t.relatedStatsFeatures&&t.relatedStatsFeatures.forEach(i=>uQ({attributes:e,graphic:i,relatedInfo:t})))}const hQ=e=>{if(!e)return!1;const t=e.toUpperCase();return t.indexOf("CURRENT_TIMESTAMP")>-1||t.indexOf("CURRENT_DATE")>-1||t.indexOf("CURRENT_TIME")>-1},xde=({layer:e,method:t,query:i,definitionExpression:r})=>{var s,n;if((s=e.capabilities)==null||(n=s.query)==null||!n.supportsCacheHint||t==="attachments")return;const o=_(i.where)&&i.where,a=_(i.geometry)&&i.geometry;hQ(r)||hQ(o)||(a==null?void 0:a.type)==="extent"||i.resultType==="tile"||(i.cacheHint=!0)},E$e=({query:e,layer:t,method:i})=>{xde({layer:t,method:i,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})},A$e=({queryPayload:e,layer:t,method:i})=>{xde({layer:t,method:i,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})},dQ={editing:!1,operations:{add:!0,update:!0,delete:!0}},Tde=it.ofType(dde),C$e="graphic.layer.capabilities.operations.supportsResizeAttachments";let lh=class extends zT{constructor(e){super(e),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.abilities=I({},dQ),this.activeAttachmentInfo=null,this.attachmentInfos=new Tde,this.graphic=null,this.mode="view",this.handles.add([Wt(this,"graphic",()=>this._graphicChanged())])}destroy(){this._attachmentLayer=null,this.graphic=null}castAbilities(e){return I(I({},dQ),e)}get state(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"}get supportsResizeAttachments(){return this.get(C$e)||!1}async getAttachments(){const{_attachmentLayer:e,attachmentInfos:t}=this;if(!e||typeof e.queryAttachments!="function")throw new q("invalid-layer","getAttachments(): A valid layer is required.");const i=this._getFeatureId(),r=new JD({objectIds:[i],returnMetadata:!0}),s=[],n=e.queryAttachments(r).then(a=>a[i]||s).catch(()=>s);this._getAttachmentsPromise=n,this.notifyChange("state");const o=await n;return t.removeAll(),o.length&&t.addMany(o),this._getAttachmentsPromise=null,this.notifyChange("state"),o}async addAttachment(e){const{_attachmentLayer:t,attachmentInfos:i,graphic:r,abilities:s}=this;if(!e)throw new q("invalid-attachment","addAttachment(): An attachment is required.",{attachment:e});if(!s.operations.add)throw new q("invalid-abilities","addAttachment(): add abilities are required.");if(!t||typeof t.addAttachment!="function")throw new q("invalid-layer","addAttachment(): A valid layer is required.");const n=t.addAttachment(r,e).then(a=>this._queryAttachment(a.objectId)),o=await n;return i.add(o),o}async deleteAttachment(e){const{_attachmentLayer:t,attachmentInfos:i,graphic:r,abilities:s}=this;if(!e)throw new q("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!s.operations.delete)throw new q("invalid-abilities","deleteAttachment(): delete abilities are required.");if(!t||typeof t.deleteAttachments!="function")throw new q("invalid-layer","deleteAttachment(): A valid layer is required.");const n=t.deleteAttachments(r,[e.id]).then(()=>e),o=await n;return i.remove(o),o}async updateAttachment(e,t=this.activeAttachmentInfo){const{_attachmentLayer:i,attachmentInfos:r,graphic:s,abilities:n}=this;if(!e)throw new q("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:e});if(!t)throw new q("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:t});if(!n.operations.update)throw new q("invalid-abilities","updateAttachment(): Update abilities are required.");const o=r.findIndex(c=>c===t);if(!i||typeof i.updateAttachment!="function")throw new q("invalid-layer","updateAttachment(): A valid layer is required.");const a=i.updateAttachment(s,t.id,e).then(c=>this._queryAttachment(c.objectId)),l=await a;return r.splice(o,1,l),l}async _queryAttachment(e){if(!e)throw new q("invalid-attachment-id","Could not query attachment.");const{_attachmentLayer:t}=this,i=this._getFeatureId(),r=new JD({objectIds:[i],attachmentsWhere:`AttachmentId=${e}`,returnMetadata:!0});return t.queryAttachments(r).then(s=>s[i][0])}_getFeatureId(){const{_attachmentLayer:e,graphic:t}=this;if(!e||!t)return null;const{objectIdField:i}=e,{attributes:r}=t;return r&&r[i]}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch(()=>{}))}_setAttachmentLayer(){const{graphic:e}=this,t=mde(e);this._attachmentLayer=t?t.type==="scene"&&_(t.associatedLayer)?t.associatedLayer:t:null}};u([d()],lh.prototype,"abilities",void 0),u([At("abilities")],lh.prototype,"castAbilities",null),u([d()],lh.prototype,"activeAttachmentInfo",void 0),u([d({readOnly:!0,type:Tde})],lh.prototype,"attachmentInfos",void 0),u([d({type:qo})],lh.prototype,"graphic",void 0),u([d()],lh.prototype,"mode",void 0),u([d({readOnly:!0})],lh.prototype,"state",null),u([d({readOnly:!0})],lh.prototype,"supportsResizeAttachments",null),lh=u([P("esri.widgets.Attachments.AttachmentsViewModel")],lh);const lH=lh;function R$e(e){const t=e.toLowerCase();return t==="image/bmp"||t==="image/emf"||t==="image/exif"||t==="image/gif"||t==="image/x-icon"||t==="image/jpeg"||t==="image/png"||t==="image/tiff"||t==="image/x-wmf"}function O$e(e){const t=ui("esri/themes/base/images/files/");return e?e==="text/plain"?`${t}text-32.svg`:e==="application/pdf"?`${t}pdf-32.svg`:e==="text/csv"?`${t}csv-32.svg`:e==="application/gpx+xml"?`${t}gpx-32.svg`:e==="application/x-dwf"?`${t}cad-32.svg`:e==="application/postscript"||e==="application/json"||e==="text/xml"||e==="model/vrml"?`${t}code-32.svg`:e==="application/x-zip-compressed"||e==="application/x-7z-compressed"||e==="application/x-gzip"||e==="application/x-tar"||e==="application/x-gtar"||e==="application/x-bzip2"||e==="application/gzip"||e==="application/x-compress"||e==="application/x-apple-diskimage"||e==="application/x-rar-compressed"||e==="application/zip"?`${t}zip-32.svg`:e.indexOf("image/")!==-1?`${t}image-32.svg`:e.indexOf("audio/")!==-1?`${t}sound-32.svg`:e.indexOf("video/")!==-1?`${t}video-32.svg`:e.indexOf("msexcel")!==-1||e.indexOf("ms-excel")!==-1||e.indexOf("spreadsheetml")!==-1?`${t}excel-32.svg`:e.indexOf("msword")!==-1||e.indexOf("ms-word")!==-1||e.indexOf("wordprocessingml")!==-1?`${t}word-32.svg`:e.indexOf("powerpoint")!==-1||e.indexOf("presentationml")!==-1?`${t}report-32.svg`:`${t}generic-32.svg`:`${t}generic-32.svg`}function fl(e){return function(t,i){t.hasOwnProperty("_messageBundleProps")||(t._messageBundleProps=t._messageBundleProps?t._messageBundleProps.slice():[]),t._messageBundleProps.push({bundlePath:e,propertyName:i})}}var M$e=function(e){return{vnodeSelector:"",properties:void 0,children:void 0,text:e.toString(),domNode:null}},Sde=function(e,t){for(var i=0,r=e.length;i<r;i++){var s=e[i];Array.isArray(s)?Sde(s,t):s!=null&&s!==!1&&(s.hasOwnProperty("vnodeSelector")||(s=M$e(s)),t.push(s))}},P$e=function(e,t){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];if(i.length===1&&typeof i[0]=="string")return{vnodeSelector:e,properties:t||void 0,children:void 0,text:i[0],domNode:null};var s=[];return Sde(i,s),{vnodeSelector:e,properties:t||void 0,children:s,text:void 0,domNode:null}};function le(e,t,...i){return typeof e!="function"||nH(e)?P$e(e,t,...i):e(t,...i)}const pQ={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},Ze={base:"esri-attachments",loaderContainer:"esri-attachments__loader-container",loader:"esri-attachments__loader",fadeIn:"esri-attachments--fade-in",container:"esri-attachments__container",containerList:"esri-attachments__container--list",containerPreview:"esri-attachments__container--preview",actions:"esri-attachments__actions",deleteButton:"esri-attachments__delete-button",addAttachmentButton:"esri-attachments__add-attachment-button",errorMessage:"esri-attachments__error-message",items:"esri-attachments__items",item:"esri-attachments__item",itemButton:"esri-attachments__item-button",itemMask:"esri-attachments__item-mask",itemMaskIcon:"esri-attachments__item-mask--icon",itemImage:"esri-attachments__image",itemImageResizable:"esri-attachments__image--resizable",itemLabel:"esri-attachments__label",itemFilename:"esri-attachments__filename",itemChevronIcon:"esri-attachments__item-chevron-icon",itemLink:"esri-attachments__item-link",itemLinkOverlay:"esri-attachments__item-link-overlay",itemLinkOverlayIcon:"esri-attachments__item-link-overlay-icon",itemEditIcon:"esri-attachments__item-edit-icon",itemAddIcon:"esri-attachments__item-add-icon",itemAddButton:"esri-attachments__item-add-button",formNode:"esri-attachments__form-node",fileFieldset:"esri-attachments__file-fieldset",fileLabel:"esri-attachments__file-label",fileName:"esri-attachments__file-name",fileInput:"esri-attachments__file-input",metadata:"esri-attachments__metadata",metadataFieldset:"esri-attachments__metadata-fieldset",progressBar:"esri-attachments__progress-bar",esriWidget:"esri-widget",esriButton:"esri-button",buttonDisabled:"esri-button--disabled",esriButtonSecondary:"esri-button--secondary",esriButtonTertiary:"esri-button--tertiary",esriButtonThird:"esri-button--third",esriButtonSmall:"esri-button--small",esriButtonHalf:"esri-button--half",empty:"esri-widget__content--empty",iconExternalLink:"esri-icon-link-external",iconEdit:"esri-icon-edit",iconRight:"esri-icon-right",iconLeft:"esri-icon-left",iconPlus:"esri-icon-plus"},X5=window.CSS;let Ao=class extends Ia{constructor(e,t){super(e,t),this.abilities=null,this.displayType="auto",this.graphic=null,this.label=void 0,this.messages=null,this.messagesUnits=null,this.selectedFile=null,this.submitting=!1,this.viewModel=new lH,this.visibleElements=I({},pQ),this._supportsImageOrientation=X5&&X5.supports&&X5.supports("image-orientation","from-image"),this._addAttachmentForm=null,this._updateAttachmentForm=null}initialize(){this.own(Rp(this,"viewModel.attachmentInfos","change",()=>this.scheduleRender()),Wt(this,"viewModel.mode",()=>this._modeChanged()))}get effectiveDisplayType(){const{displayType:e}=this;return e&&e!=="auto"?e:this.viewModel.supportsResizeAttachments?"preview":"list"}castVisibleElements(e){return I(I({},pQ),e)}addAttachment(){const{_addAttachmentForm:e,viewModel:t}=this;return this._set("submitting",!0),this._set("error",null),t.addAttachment(e).then(i=>(this._set("submitting",!1),this._set("error",null),t.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new q("attachments:add-attachment",this.messages.addErrorMessage,i)),i})}deleteAttachment(e){const{viewModel:t}=this;return this._set("submitting",!0),this._set("error",null),t.deleteAttachment(e).then(i=>(this._set("submitting",!1),this._set("error",null),t.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new q("attachments:delete-attachment",this.messages.deleteErrorMessage,i)),i})}updateAttachment(){const{viewModel:e}=this,{_updateAttachmentForm:t}=this;return this._set("submitting",!0),this._set("error",null),e.updateAttachment(t).then(i=>(this._set("submitting",!1),this._set("error",null),e.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new q("attachments:update-attachment",this.messages.updateErrorMessage,i)),i})}render(){const{submitting:e,viewModel:t}=this,{state:i}=t;return le("div",{class:this.classes(Ze.base,Ze.esriWidget)},e?this.renderProgressBar():null,i==="loading"?this.renderLoading():this.renderAttachments(),this.renderErrorMessage())}renderErrorMessage(){const{error:e,visibleElements:t}=this;return e&&t.errorMessage?le("div",{key:"error-message",class:Ze.errorMessage},e.message):null}renderAttachments(){const{mode:e,activeAttachmentInfo:t}=this.viewModel;return e==="add"?this.renderAddForm():e==="edit"?this.renderDetailsForm(t):this.renderAttachmentContainer()}renderLoading(){return le("div",{class:Ze.loaderContainer,key:"loader"},le("div",{class:Ze.loader}))}renderProgressBar(){return this.visibleElements.progressBar?le("div",{class:Ze.progressBar,key:"progress-bar"}):null}renderAddForm(){const{submitting:e,selectedFile:t}=this,i=e||!t,r=this.visibleElements.cancelAddButton?le("button",{type:"button",bind:this,disabled:e,onclick:this._cancelForm,class:this.classes(Ze.esriButton,Ze.esriButtonTertiary,Ze.esriButtonSmall,Ze.esriButtonHalf,e&&Ze.buttonDisabled)},this.messages.cancel):null,s=this.visibleElements.addSubmitButton?le("button",{type:"submit",disabled:i,class:this.classes(Ze.esriButton,Ze.esriButtonSecondary,Ze.esriButtonSmall,Ze.esriButtonHalf,{[Ze.buttonDisabled]:i})},this.messages.add):null,n=t?le("span",{key:"file-name",class:Ze.fileName},t.name):null,o=le("form",{bind:this,afterCreate:yV,afterRemoved:zZ,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},le("fieldset",{class:Ze.fileFieldset},n,le("label",{class:this.classes(Ze.fileLabel,Ze.esriButton,Ze.esriButtonSecondary)},t?this.messages.changeFile:this.messages.selectFile,le("input",{class:Ze.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))),s,r);return le("div",{key:"add-form-container",class:Ze.formNode},o)}renderDetailsForm(e){const{visibleElements:t,viewModel:i,selectedFile:r,submitting:s}=this,{contentType:n,size:o,url:a}=e,{abilities:l}=i,c=s||!r,h=l.editing&&l.operations.delete&&t.deleteButton?le("button",{key:"delete-button",type:"button",disabled:s,bind:this,onclick:S=>this._submitDeleteAttachment(S,e),class:this.classes(Ze.esriButton,Ze.esriButtonSmall,Ze.esriButtonTertiary,Ze.deleteButton,{[Ze.buttonDisabled]:s})},this.messages.delete):null,p=l.editing&&l.operations.update&&t.updateButton?le("button",{disabled:c,key:"update-button",type:"submit",class:this.classes(Ze.esriButton,Ze.esriButtonSmall,Ze.esriButtonThird,{[Ze.buttonDisabled]:c})},this.messages.update):null,f=this.visibleElements.cancelUpdateButton?le("button",{disabled:s,key:"cancel-button",type:"button",bind:this,onclick:this._cancelForm,class:this.classes(Ze.esriButton,Ze.esriButtonSmall,Ze.esriButtonTertiary,Ze.esriButtonThird,{[Ze.buttonDisabled]:s})},this.messages.cancel):null,g=r?le("span",{key:"file-name",class:Ze.fileName},r.name):null,y=l.editing&&l.operations.update?le("fieldset",{key:"file",class:Ze.fileFieldset},g,le("label",{class:this.classes(Ze.fileLabel,Ze.esriButton,Ze.esriButtonSecondary)},this.messages.changeFile,le("input",{class:Ze.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))):null,v=le("fieldset",{key:"size",class:Ze.metadataFieldset},le("label",null,HIe(this.messagesUnits,o))),b=le("fieldset",{key:"content-type",class:Ze.metadataFieldset},le("label",null,n)),w=le("form",{bind:this,afterCreate:yV,afterRemoved:zZ,"data-node-ref":"_updateAttachmentForm",onsubmit:this._submitUpdateAttachment},le("div",{class:Ze.metadata},v,b),y,le("div",{class:Ze.actions},h,f,p));return le("div",{key:"edit-form-container",class:Ze.formNode},le("a",{class:Ze.itemLink,href:a,rel:"noreferrer",target:"_blank"},this.renderImageMask({attachmentInfo:e,size:400}),le("div",{class:Ze.itemLinkOverlay},le("span",{class:Ze.itemLinkOverlayIcon},le("svg",{xmlns:"http://www.w3.org/2000/svg",width:"32",height:"32",viewBox:"0 0 32 32"},le("path",{d:"M28 13h1v16H3V3h16v1H4v24h24zm-5-9h4.293L15.646 15.638l.707.707L28 4.707V9h1V3h-6z"}),le("path",{fill:"none",d:"M0 0h32v32H0z"}))))),w)}renderImageMask({attachmentInfo:e,size:t}){const{supportsResizeAttachments:i}=this.viewModel,{contentType:r,name:s,url:n}=e,o=i&&R$e(r),a=this._getCSSTransform(e,o),l=a?{transform:a,"image-orientation":"none"}:{},c=n.indexOf("?")===-1?"?":"&",h=o?`${n}${c}w=${t}`:O$e(r),p={[Ze.itemMaskIcon]:!o},f={[Ze.itemImageResizable]:i};return le("div",{class:this.classes(p,Ze.itemMask)},le("img",{styles:l,alt:s,src:h,class:this.classes(f,Ze.itemImage)}))}renderAttachmentInfo({attachmentInfo:e,displayType:t}){const{viewModel:i}=this,{abilities:r}=i,{name:s,url:n}=e,o=this.renderImageMask({attachmentInfo:e,size:t==="list"?48:400}),a=r.editing?le("span",{"aria-hidden":"true",class:this.classes(Ze.itemChevronIcon,qy(this.container)?Ze.iconLeft:Ze.iconRight)}):null,l=[o,le("label",{class:Ze.itemLabel},le("span",{class:Ze.itemFilename},s||this.messages.noTitle),a)],c=r.editing?le("button",{key:"details-button",bind:this,class:Ze.itemButton,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,"data-attachment-info-id":e.id,onclick:()=>this._startEditAttachment(e),type:"button"},l):le("a",{key:"details-link",class:Ze.itemButton,href:n,target:"_blank"},l);return le("li",{class:Ze.item,key:e},c)}renderAttachmentContainer(){const{effectiveDisplayType:e,viewModel:t,visibleElements:i}=this,{attachmentInfos:r,abilities:s}=t,n=r&&r.length,o={[Ze.containerList]:e!=="preview",[Ze.containerPreview]:e==="preview"},a=s.editing&&s.operations.add&&i.addButton?le("button",{bind:this,onclick:()=>this._startAddAttachment(),class:this.classes(Ze.esriButton,Ze.esriButtonTertiary,Ze.addAttachmentButton),type:"button"},le("span",{"aria-hidden":"true",class:this.classes(Ze.itemAddIcon,Ze.iconPlus)}),this.messages.add):null,l=n?le("ul",{class:Ze.items},r.toArray().map(c=>this.renderAttachmentInfo({attachmentInfo:c,displayType:e}))):le("div",{class:Ze.empty},this.messages.noAttachments);return le("div",{key:"attachments-container",class:this.classes(Ze.container,o)},l,a)}_modeChanged(){this._set("error",null),this._set("selectedFile",null)}_handleFileInputChange(e){const t=e.target,i=t&&t.files&&t.files.item(0);this._set("selectedFile",i)}_submitDeleteAttachment(e,t){e.preventDefault(),this.deleteAttachment(t)}_submitAddAttachment(e){e.preventDefault(),this.addAttachment()}_submitUpdateAttachment(e){e.preventDefault(),this.updateAttachment()}_startEditAttachment(e){const{viewModel:t}=this;t.activeAttachmentInfo=e,t.mode="edit"}_startAddAttachment(){this.viewModel.mode="add"}_cancelForm(e){e.preventDefault(),this.viewModel.mode="view"}_getCSSTransform(e,t){const{orientationInfo:i}=e;return!this._supportsImageOrientation&&t&&i?[i.rotation?`rotate(${i.rotation}deg)`:"",i.mirrored?"scaleX(-1)":""].join(" "):""}};u([mt("viewModel.abilities")],Ao.prototype,"abilities",void 0),u([d()],Ao.prototype,"displayType",void 0),u([d({readOnly:!0})],Ao.prototype,"effectiveDisplayType",null),u([mt("viewModel.graphic")],Ao.prototype,"graphic",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Ao.prototype,"label",void 0),u([d(),fl("esri/widgets/Attachments/t9n/Attachments")],Ao.prototype,"messages",void 0),u([d(),fl("esri/core/t9n/Units")],Ao.prototype,"messagesUnits",void 0),u([d({readOnly:!0})],Ao.prototype,"selectedFile",void 0),u([d({readOnly:!0})],Ao.prototype,"submitting",void 0),u([d({readOnly:!0})],Ao.prototype,"error",void 0),u([d({type:lH})],Ao.prototype,"viewModel",void 0),u([d()],Ao.prototype,"visibleElements",void 0),u([At("visibleElements")],Ao.prototype,"castVisibleElements",null),Ao=u([P("esri.widgets.Attachments")],Ao);const I$e=Ao;let XE=class extends lH{constructor(e){super(e),this.description=null,this.title=null}};u([d()],XE.prototype,"description",void 0),u([d()],XE.prototype,"title",void 0),XE=u([P("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],XE);const cH=XE,$$e={heading:"esri-widget__heading"};function uH(e,t){const i=D$e(e.level),r=`h${i}`;return delete e.level,le(r,me(I({},e),{class:Rhe($$e.heading,e.class),role:"heading","aria-level":String(i)}),t)}function D$e(e){return Be(Math.ceil(e),1,6)}const Y5={base:"esri-feature-element-info",title:"esri-feature-element-info__title",description:"esri-feature-element-info__description"};let Mw=class extends Ia{constructor(e,t){super(e,t),this.description=null,this.headingLevel=2,this.title=null}render(){return le("div",{class:Y5.base},this.renderTitle(),this.renderDescription())}renderTitle(){const{title:e}=this;return e?le(uH,{level:this.headingLevel,class:Y5.title},e):null}renderDescription(){const{description:e}=this;return e?le("div",{key:"description",class:Y5.description},e):null}};u([d()],Mw.prototype,"description",void 0),u([d()],Mw.prototype,"headingLevel",void 0),u([d()],Mw.prototype,"title",void 0),Mw=u([P("esri.widgets.Feature.support.FeatureElementInfo")],Mw);const hH=Mw,L$e={base:"esri-feature-attachments"};let Fd=class extends Ia{constructor(e,t){super(e,t),this._featureElementInfo=null,this.attachmentsWidget=new I$e,this.description=null,this.displayType=null,this.graphic=null,this.headingLevel=2,this.title=null,this.viewModel=new cH}initialize(){this._featureElementInfo=new hH,Wt(this,["viewModel.description","viewModel.title","headingLevel"],()=>this._setupFeatureElementInfo()),Wt(this,"viewModel.graphic",e=>this.attachmentsWidget.graphic=e)}destroy(){this.attachmentsWidget.destroy(),this._featureElementInfo.destroy()}render(){var e;const{attachmentsWidget:t}=this;return le("div",{class:L$e.base},(e=this._featureElementInfo)==null?void 0:e.render(),t==null?void 0:t.render())}_setupFeatureElementInfo(){const{description:e,title:t,headingLevel:i}=this;this._featureElementInfo.set({description:e,title:t,headingLevel:i})}};u([d({readOnly:!0})],Fd.prototype,"attachmentsWidget",void 0),u([mt("viewModel.description")],Fd.prototype,"description",void 0),u([mt("attachmentsWidget.displayType")],Fd.prototype,"displayType",void 0),u([mt("viewModel.graphic")],Fd.prototype,"graphic",void 0),u([d()],Fd.prototype,"headingLevel",void 0),u([mt("viewModel.title")],Fd.prototype,"title",void 0),u([d({type:cH})],Fd.prototype,"viewModel",void 0),Fd=u([P("esri.widgets.Feature.FeatureAttachments")],Fd);const N$e=Fd;let Yg=class extends Vm(we){constructor(e){super(e),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.handles.add(Wt(this,"creator",t=>{this._destroyContent(),this._createContent(t)}))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:e,graphic:t,destroyer:i}=this;e&&(KD(i,{graphic:t}).catch(()=>null),this._set("created",null))}async _createContent(e){const{graphic:t}=this,i=KD(e,{graphic:t}).catch(()=>null);this._loadingPromise=i,this.notifyChange("state");const r=await i;i===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",r))}};u([d({readOnly:!0})],Yg.prototype,"created",void 0),u([d()],Yg.prototype,"creator",void 0),u([d()],Yg.prototype,"destroyer",void 0),u([d({type:qo})],Yg.prototype,"graphic",void 0),u([d({readOnly:!0})],Yg.prototype,"state",null),Yg=u([P("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],Yg);const tL=Yg;function lu(){return function(e,t){if(!e[t])throw new TypeError(`Cannot auto bind undefined function '${t}'`);return{value:U$e(e[t])}}}function F$e(e){const{type:t}=e;return e instanceof KeyboardEvent||t==="keyup"||t==="keydown"||t==="keypress"}function U$e(e){return function(t,...i){F$e(t)?TPe(t.key)&&(t.preventDefault(),t.stopPropagation(),t.target.click()):e.call(this,t,...i)}}function k$e(e){return e.split(",").map(t=>t.trim())}function z$e(e){return t=>{t.hasOwnProperty("_delegatedEventNames")||(t._delegatedEventNames=t._delegatedEventNames?t._delegatedEventNames.slice():[]);const i=t._delegatedEventNames,r=Array.isArray(e)?e:k$e(e);i.push(...r)}}function Ede(e){return e&&typeof e.render=="function"}function B$e(e){return e&&typeof e.postMixInProperties=="function"&&typeof e.buildRendering=="function"&&typeof e.postCreate=="function"&&typeof e.startup=="function"}const Z5={base:"esri-feature-content",loaderContainer:"esri-feature-content__loader-container",loader:"esri-feature-content__loader"};let Pw=class extends Ia{constructor(e,t){super(e,t),this.creator=null,this.graphic=null,this.viewModel=null,this._addTargetToAnchors=i=>{Array.from(i.querySelectorAll("a")).forEach(r=>{gde(r.href)&&!r.hasAttribute("target")&&r.setAttribute("target","_blank")})}}renderLoading(){return le("div",{class:Z5.loaderContainer,key:"loader"},le("div",{class:Z5.loader}))}renderCreated(){var e;const t=(e=this.viewModel)==null?void 0:e.created;return t?t instanceof HTMLElement?le("div",{key:t,bind:t,afterCreate:this._attachToNode}):Ede(t)?le("div",{key:t},!t.destroyed&&t.render()):le("div",{key:t,innerHTML:t,afterCreate:this._addTargetToAnchors}):null}render(){var e;const t=(e=this.viewModel)==null?void 0:e.state;return le("div",{class:Z5.base},t==="loading"?this.renderLoading():this.renderCreated())}_attachToNode(e){const t=this;e.appendChild(t)}};u([mt("viewModel.creator")],Pw.prototype,"creator",void 0),u([mt("viewModel.graphic")],Pw.prototype,"graphic",void 0),u([d({type:tL})],Pw.prototype,"viewModel",void 0),Pw=u([P("esri.widgets.Feature.FeatureContent")],Pw);const OI=Pw;let Tf=class extends we{constructor(e){super(e),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.title=null}get formattedFieldInfos(){const{expressionInfos:e,fieldInfos:t}=this,i=[];return t==null||t.forEach(r=>{if(!(!r.hasOwnProperty("visible")||r.visible))return;const s=r.clone();s.label=vde(s,e),i.push(s)}),i}};u([d()],Tf.prototype,"attributes",void 0),u([d({type:[_le]})],Tf.prototype,"expressionInfos",void 0),u([d()],Tf.prototype,"description",void 0),u([d({type:[cO]})],Tf.prototype,"fieldInfos",void 0),u([d({readOnly:!0})],Tf.prototype,"formattedFieldInfos",null),u([d()],Tf.prototype,"title",void 0),Tf=u([P("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],Tf);const bF=Tf,V$e=[{pattern:/^\s*(https?:\/\/([^\s]+))\s*$/i,target:"_blank",label:"{messages.view}"},{pattern:/^\s*(tel:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(mailto:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(arcgis-appstudio-player:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"App Studio Player"},{pattern:/^\s*(arcgis-collector:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Collector"},{pattern:/^\s*(arcgis-explorer:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Explorer"},{pattern:/^\s*(arcgis-navigator:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Navigator"},{pattern:/^\s*(arcgis-survey123:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Survey123"},{pattern:/^\s*(arcgis-trek2there:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Trek2There"},{pattern:/^\s*(arcgis-workforce:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Workforce"},{pattern:/^\s*(iform:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"iForm"},{pattern:/^\s*(flow:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"FlowFinity"},{pattern:/^\s*(lfmobile:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Laserfische"},{pattern:/^\s*(mspbi:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Microsoft Power Bi"}];function G$e(e){let t=null;return V$e.some(i=>(i.pattern.test(e)&&(t=i),!!t)),t}function j$e(e,t){if(typeof t!="string"||!t)return t;const i=G$e(t);if(!i)return t;const r=t.match(i.pattern),s=r&&r[2],n=_p(_p(i.label,{messages:e,hierPart:s}),{appName:i.appName}),o=i.target?` target="${i.target}"`:"",a=i.target==="_blank"?' rel="noreferrer"':"";return t.replace(i.pattern,`<a${o} href="$1"${a}>${n}</a>`)}const T2={base:"esri-feature-fields",fieldHeader:"esri-feature-fields__field-header",fieldData:"esri-feature-fields__field-data",fieldDataDate:"esri-feature-fields__field-data--date",esriTable:"esri-widget__table"};let ch=class extends Ia{constructor(e,t){super(e,t),this._featureElementInfo=null,this.attributes=null,this.description=null,this.expressionInfos=null,this.fieldInfos=null,this.title=null,this.viewModel=new bF,this.messages=null,this.messagesURIUtils=null}initialize(){this._featureElementInfo=new hH,Wt(this,["viewModel.description","viewModel.title"],()=>this._setupFeatureElementInfo())}destroy(){this._featureElementInfo.destroy()}renderFieldInfo(e,t){const{attributes:i}=this.viewModel,r=e.fieldName,s=e.label||r,n=i?i[r]==null?"":i[r]:"",o=!(!e.format||!e.format.dateFormat),a=typeof n=="number"&&!o?this._forceLTR(n):j$e(this.messagesURIUtils,n),l={[T2.fieldDataDate]:o};return le("tr",{key:`fields-element-info-row-${r}-${t}`},le("th",{key:`fields-element-info-row-header-${r}-${t}`,class:T2.fieldHeader,innerHTML:s}),le("td",{key:`fields-element-info-row-data-${r}-${t}`,class:this.classes(T2.fieldData,l),innerHTML:a}))}renderFields(){const{formattedFieldInfos:e}=this.viewModel;return e!=null&&e.length?le("table",{class:T2.esriTable,summary:this.messages.fieldsSummary},le("tbody",null,e.map((t,i)=>this.renderFieldInfo(t,i)))):null}render(){var e;return le("div",{class:T2.base},(e=this._featureElementInfo)==null?void 0:e.render(),this.renderFields())}_setupFeatureElementInfo(){const{description:e,title:t}=this;this._featureElementInfo.set({description:e,title:t})}_forceLTR(e){return`&lrm;${e}`}};u([mt("viewModel.attributes")],ch.prototype,"attributes",void 0),u([mt("viewModel.description")],ch.prototype,"description",void 0),u([mt("viewModel.expressionInfos")],ch.prototype,"expressionInfos",void 0),u([mt("viewModel.fieldInfos")],ch.prototype,"fieldInfos",void 0),u([mt("viewModel.title")],ch.prototype,"title",void 0),u([d({type:bF})],ch.prototype,"viewModel",void 0),u([d(),fl("esri/widgets/Feature/t9n/Feature")],ch.prototype,"messages",void 0),u([d(),fl("esri/widgets/support/t9n/uriUtils")],ch.prototype,"messagesURIUtils",void 0),ch=u([P("esri.widgets.Feature.FeatureFields")],ch);const Ade=ch,fQ={milliseconds:1,seconds:1e3,minutes:6e4,hours:36e5,days:864e5,weeks:6048e5,months:26784e5,years:31536e6,decades:31536e7,centuries:31536e8},H$e={milliseconds:{getter:"getMilliseconds",setter:"setMilliseconds",multiplier:1},seconds:{getter:"getSeconds",setter:"setSeconds",multiplier:1},minutes:{getter:"getMinutes",setter:"setMinutes",multiplier:1},hours:{getter:"getHours",setter:"setHours",multiplier:1},days:{getter:"getDate",setter:"setDate",multiplier:1},weeks:{getter:"getDate",setter:"setDate",multiplier:7},months:{getter:"getMonth",setter:"setMonth",multiplier:1},years:{getter:"getFullYear",setter:"setFullYear",multiplier:1},decades:{getter:"getFullYear",setter:"setFullYear",multiplier:10},centuries:{getter:"getFullYear",setter:"setFullYear",multiplier:100}};function q$e(e,t){const i=new Date(e,t+1,1);return i.setDate(0),i.getDate()}function h1(e,t,i){const r=new Date(e.getTime());if(t&&i){const s=H$e[i],{getter:n,setter:o,multiplier:a}=s;if(i==="months"){const l=q$e(r.getFullYear(),r.getMonth()+t);r.getDate()>l&&r.setDate(l)}r[o](r[n]()+t*a)}return r}function mQ(e,t){switch(t){case"milliseconds":return new Date(e.getTime());case"seconds":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds());case"minutes":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes());case"hours":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours());case"days":return new Date(e.getFullYear(),e.getMonth(),e.getDate());case"weeks":return new Date(e.getFullYear(),e.getMonth(),e.getDate()-e.getDay());case"months":return new Date(e.getFullYear(),e.getMonth(),1);case"years":return new Date(e.getFullYear(),0,1);case"decades":return new Date(e.getFullYear()-e.getFullYear()%10,0,1);case"centuries":return new Date(e.getFullYear()-e.getFullYear()%100,0,1);default:return new Date}}function W$e(e,t,i){return e===0?0:e*fQ[t]/fQ[i]}var uh;let Wl=uh=class extends fe{constructor(e){super(e),this.end=null,this.start=null}static get allTime(){return gQ}static get empty(){return X$e}readEnd(e,t){return t.end!=null?new Date(t.end):null}writeEnd(e,t){t.end=e?e.getTime():null}get isAllTime(){return this.equals(uh.allTime)}get isEmpty(){return this.equals(uh.empty)}readStart(e,t){return t.start!=null?new Date(t.start):null}writeStart(e,t){t.start=e?e.getTime():null}clone(){return new uh({end:this.end,start:this.start})}equals(e){if(!e)return!1;const t=_(this.start)?this.start.getTime():this.start,i=_(this.end)?this.end.getTime():this.end,r=_(e.start)?e.start.getTime():e.start,s=_(e.end)?e.end.getTime():e.end;return t===r&&i===s}expandTo(e){if(this.isEmpty||this.isAllTime)return this.clone();const t=po(this.start,r=>mQ(r,e)),i=po(this.end,r=>h1(mQ(r,e),1,e));return new uh({start:t,end:i})}intersection(e){if(!e)return this.clone();if(this.isEmpty||e.isEmpty)return uh.empty;if(this.isAllTime)return e.clone();if(e.isAllTime)return this.clone();const t=tl(this.start,-1/0,a=>a.getTime()),i=tl(this.end,1/0,a=>a.getTime()),r=tl(e.start,-1/0,a=>a.getTime()),s=tl(e.end,1/0,a=>a.getTime());let n,o;if(r>=t&&r<=i?n=r:t>=r&&t<=s&&(n=t),i>=r&&i<=s?o=i:s>=t&&s<=i&&(o=s),!isNaN(n)&&!isNaN(o)){const a=new uh;return a.start=n===-1/0?null:new Date(n),a.end=o===1/0?null:new Date(o),a}return uh.empty}offset(e,t){if(this.isEmpty||this.isAllTime)return this.clone();const i=new uh,{start:r,end:s}=this;return _(r)&&(i.start=h1(r,e,t)),_(s)&&(i.end=h1(s,e,t)),i}union(e){if(!e||e.isEmpty)return this.clone();if(this.isEmpty)return e.clone();if(this.isAllTime||e.isAllTime)return gQ.clone();const t=_(this.start)&&_(e.start)?new Date(Math.min(this.start.getTime(),e.start.getTime())):null,i=_(this.end)&&_(e.end)?new Date(Math.max(this.end.getTime(),e.end.getTime())):null;return new uh({start:t,end:i})}};u([d({type:Date,json:{write:{allowNull:!0}}})],Wl.prototype,"end",void 0),u([De("end")],Wl.prototype,"readEnd",null),u([Fe("end")],Wl.prototype,"writeEnd",null),u([d({readOnly:!0,json:{read:!1}})],Wl.prototype,"isAllTime",null),u([d({readOnly:!0,json:{read:!1}})],Wl.prototype,"isEmpty",null),u([d({type:Date,json:{write:{allowNull:!0}}})],Wl.prototype,"start",void 0),u([De("start")],Wl.prototype,"readStart",null),u([Fe("start")],Wl.prototype,"writeStart",null),Wl=uh=u([P("esri.TimeExtent")],Wl);const gQ=new Wl,X$e=new Wl({start:void 0,end:void 0}),zp=Wl;var RV;let YE=RV=class extends fe{constructor(e){super(e),this.name=null,this.code=null}clone(){return new RV({name:this.name,code:this.code})}};u([d({type:String,json:{write:!0}})],YE.prototype,"name",void 0),u([d({type:[String,Number],json:{write:!0}})],YE.prototype,"code",void 0),YE=RV=u([P("esri.layers.support.CodedValue")],YE);const Y$e=YE,Z$e=new si({inherited:"inherited",codedValue:"coded-value",range:"range"});let ZE=class extends fe{constructor(e){super(e),this.name=null,this.type=null}};u([d({type:String,json:{write:!0}})],ZE.prototype,"name",void 0),u([ut(Z$e)],ZE.prototype,"type",void 0),ZE=u([P("esri.layers.support.Domain")],ZE);const wF=ZE;var OV;let QE=OV=class extends wF{constructor(e){super(e),this.codedValues=null,this.type="coded-value"}getName(e){let t=null;if(this.codedValues){const i=String(e);this.codedValues.some(r=>(String(r.code)===i&&(t=r.name),!!t))}return t}clone(){return new OV({codedValues:se(this.codedValues),name:this.name})}};u([d({type:[Y$e],json:{write:!0}})],QE.prototype,"codedValues",void 0),u([ut({codedValue:"coded-value"})],QE.prototype,"type",void 0),QE=OV=u([P("esri.layers.support.CodedValueDomain")],QE);const Cde=QE;var MV;let MI=MV=class extends wF{constructor(e){super(e),this.type="inherited"}clone(){return new MV}};u([ut({inherited:"inherited"})],MI.prototype,"type",void 0),MI=MV=u([P("esri.layers.support.InheritedDomain")],MI);const Rde=MI;var PV;let Iw=PV=class extends wF{constructor(e){super(e),this.maxValue=null,this.minValue=null,this.type="range"}clone(){return new PV({maxValue:this.maxValue,minValue:this.minValue,name:this.name})}};u([d({type:Number,json:{type:[Number],read:{source:"range",reader:(e,t)=>t.range&&t.range[1]},write:{enabled:!1,overridePolicy(){return{enabled:this.maxValue!=null&&this.minValue==null}},target:"range",writer(e,t,i){t[i]=[this.minValue||0,e]}}}})],Iw.prototype,"maxValue",void 0),u([d({type:Number,json:{type:[Number],read:{source:"range",reader:(e,t)=>t.range&&t.range[0]},write:{target:"range",writer(e,t,i){t[i]=[e,this.maxValue||0]}}}})],Iw.prototype,"minValue",void 0),u([ut({range:"range"})],Iw.prototype,"type",void 0),Iw=PV=u([P("esri.layers.support.RangeDomain")],Iw);const Ode=Iw,Mde={key:"type",base:wF,typeMap:{range:Ode,"coded-value":Cde,inherited:Rde}};function dH(e){if(!e||!e.type)return null;switch(e.type){case"range":return Ode.fromJSON(e);case"codedValue":return Cde.fromJSON(e);case"inherited":return Rde.fromJSON(e)}return null}const pH=new si({esriFieldTypeSmallInteger:"small-integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"single",esriFieldTypeDouble:"double",esriFieldTypeLong:"long",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"oid",esriFieldTypeGeometry:"geometry",esriFieldTypeBlob:"blob",esriFieldTypeRaster:"raster",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"global-id",esriFieldTypeXML:"xml"});var IV;const Q$e=new si({binary:"binary",coordinate:"coordinate",countOrAmount:"count-or-amount",dateAndTime:"date-and-time",description:"description",locationOrPlaceName:"location-or-place-name",measurement:"measurement",nameOrTitle:"name-or-title",none:"none",orderedOrRanked:"ordered-or-ranked",percentageOrRatio:"percentage-or-ratio",typeOrCategory:"type-or-category",uniqueIdentifier:"unique-identifier"});let sa=IV=class extends fe{constructor(e){super(e),this.alias=null,this.defaultValue=void 0,this.description=null,this.domain=null,this.editable=!0,this.length=-1,this.name=null,this.nullable=!0,this.type=null,this.valueType=null}readDescription(e,{description:t}){let i;try{i=JSON.parse(t)}catch{}return i?i.value:null}readValueType(e,{description:t}){let i;try{i=JSON.parse(t)}catch{}return i?Q$e.fromJSON(i.fieldValueType):null}clone(){return new IV({alias:this.alias,defaultValue:this.defaultValue,description:this.description,domain:this.domain&&this.domain.clone()||null,editable:this.editable,length:this.length,name:this.name,nullable:this.nullable,type:this.type,valueType:this.valueType})}};u([d({type:String,json:{write:!0}})],sa.prototype,"alias",void 0),u([d({type:[String,Number],json:{write:{allowNull:!0}}})],sa.prototype,"defaultValue",void 0),u([d()],sa.prototype,"description",void 0),u([De("description")],sa.prototype,"readDescription",null),u([d({types:Mde,json:{read:{reader:dH},write:!0}})],sa.prototype,"domain",void 0),u([d({type:Boolean,json:{write:!0}})],sa.prototype,"editable",void 0),u([d({type:ir,json:{write:!0}})],sa.prototype,"length",void 0),u([d({type:String,json:{write:!0}})],sa.prototype,"name",void 0),u([d({type:Boolean,json:{write:!0}})],sa.prototype,"nullable",void 0),u([ut(pH)],sa.prototype,"type",void 0),u([d()],sa.prototype,"valueType",void 0),u([De("valueType",["description"])],sa.prototype,"readValueType",null),sa=IV=u([P("esri.layers.support.Field")],sa);const gO=sa;var $V;let $w=$V=class extends fe{constructor(e){super(e),this.type="map-layer"}clone(){const{mapLayerId:e,gdbVersion:t}=this;return new $V({mapLayerId:e,gdbVersion:t})}};u([ut({mapLayer:"map-layer"})],$w.prototype,"type",void 0),u([d({type:ir,json:{write:!0}})],$w.prototype,"mapLayerId",void 0),u([d({type:String,json:{write:!0}})],$w.prototype,"gdbVersion",void 0),$w=$V=u([P("esri.layers.support.source.MapLayerSource")],$w);var DV;let Sf=DV=class extends fe{constructor(e){super(e),this.type="query-table"}clone(){var e;const{workspaceId:t,query:i,oidFields:r,spatialReference:s,geometryType:n}=this,o={workspaceId:t,query:i,oidFields:r,spatialReference:(e=s==null?void 0:s.clone())!=null?e:void 0,geometryType:n};return new DV(o)}};u([ut({queryTable:"query-table"})],Sf.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Sf.prototype,"workspaceId",void 0),u([d({type:String,json:{write:!0}})],Sf.prototype,"query",void 0),u([d({type:String,json:{write:!0}})],Sf.prototype,"oidFields",void 0),u([d({type:He,json:{write:!0}})],Sf.prototype,"spatialReference",void 0),u([ut(Zae)],Sf.prototype,"geometryType",void 0),Sf=DV=u([P("esri.layers.support.source.QueryTableDataSource")],Sf);var LV;let Dw=LV=class extends fe{constructor(e){super(e),this.type="raster"}clone(){const{workspaceId:e,dataSourceName:t}=this;return new LV({workspaceId:e,dataSourceName:t})}};u([ut({raster:"raster"})],Dw.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Dw.prototype,"dataSourceName",void 0),u([d({type:String,json:{write:!0}})],Dw.prototype,"workspaceId",void 0),Dw=LV=u([P("esri.layers.support.source.RasterDataSource")],Dw);var NV;let jv=NV=class extends fe{constructor(e){super(e),this.type="table"}clone(){const{workspaceId:e,gdbVersion:t,dataSourceName:i}=this;return new NV({workspaceId:e,gdbVersion:t,dataSourceName:i})}};u([ut({table:"table"})],jv.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],jv.prototype,"workspaceId",void 0),u([d({type:String,json:{write:!0}})],jv.prototype,"gdbVersion",void 0),u([d({type:String,json:{write:!0}})],jv.prototype,"dataSourceName",void 0),jv=NV=u([P("esri.layers.support.source.TableDataSource")],jv);var FV,UV;const J$e=_o()({esriLeftInnerJoin:"left-inner-join",esriLeftOuterJoin:"left-outer-join"});let Ul=FV=class extends fe{constructor(e){super(e),this.type="join-table"}readLeftTableSource(e,t,i){return yQ()(e,t,i)}castLeftTableSource(e){return Zh(kV(),e)}readRightTableSource(e,t,i){return yQ()(e,t,i)}castRightTableSource(e){return Zh(kV(),e)}clone(){var e,t;const{leftTableKey:i,rightTableKey:r,leftTableSource:s,rightTableSource:n,joinType:o}=this,a={leftTableKey:i,rightTableKey:r,leftTableSource:(e=s==null?void 0:s.clone())!=null?e:void 0,rightTableSource:(t=n==null?void 0:n.clone())!=null?t:void 0,joinType:o};return new FV(a)}};u([ut({joinTable:"join-table"})],Ul.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Ul.prototype,"leftTableKey",void 0),u([d({type:String,json:{write:!0}})],Ul.prototype,"rightTableKey",void 0),u([d({json:{write:!0}})],Ul.prototype,"leftTableSource",void 0),u([De("leftTableSource")],Ul.prototype,"readLeftTableSource",null),u([At("leftTableSource")],Ul.prototype,"castLeftTableSource",null),u([d({json:{write:!0}})],Ul.prototype,"rightTableSource",void 0),u([De("rightTableSource")],Ul.prototype,"readRightTableSource",null),u([At("rightTableSource")],Ul.prototype,"castRightTableSource",null),u([ut(J$e)],Ul.prototype,"joinType",void 0),Ul=FV=u([P("esri.layers.support.source.JoinTableDataSource")],Ul);let Q5=null;function yQ(){return Q5||(Q5=PS({types:kV()})),Q5}let J5=null;function kV(){return J5||(J5={key:"type",base:null,typeMap:{"data-layer":ec,"map-layer":$w}}),J5}const K$e={key:"type",base:null,typeMap:{"join-table":Ul,"query-table":Sf,raster:Dw,table:jv}};let ec=UV=class extends fe{constructor(e){super(e),this.type="data-layer"}clone(){const{fields:e,dataSource:t}=this;return new UV({fields:e,dataSource:t})}};u([ut({dataLayer:"data-layer"})],ec.prototype,"type",void 0),u([d({type:[gO],json:{write:!0}})],ec.prototype,"fields",void 0),u([d({types:K$e,json:{write:!0}})],ec.prototype,"dataSource",void 0),ec=UV=u([P("esri.layers.support.source.DataLayerSource")],ec),ec.from=Ir(ec);var zV;const vQ=new si({upperLeft:"upper-left",lowerLeft:"lower-left"});let Hv=zV=class extends fe{constructor(e){super(e),this.extent=null,this.mode="view",this.originPosition="upper-left",this.tolerance=1}clone(){return new zV(se({extent:this.extent,mode:this.mode,originPosition:this.originPosition,tolerance:this.tolerance}))}};u([d({type:Xt,json:{write:{overridePolicy(){return{enabled:this.mode==="view"}}}}})],Hv.prototype,"extent",void 0),u([d({type:["view","edit"],json:{write:!0}})],Hv.prototype,"mode",void 0),u([d({type:String,json:{read:vQ.read,write:vQ.write}})],Hv.prototype,"originPosition",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.mode==="view"}}}}})],Hv.prototype,"tolerance",void 0),Hv=zV=u([P("esri.rest.support.QuantizationParameters")],Hv);const eDe=Hv;var BV;const _Q=new si({count:"count",sum:"sum",min:"min",max:"max",avg:"avg",stddev:"stddev",var:"var",exceedslimit:"exceedslimit",percentile_cont:"percentile-continuous",percentile_disc:"percentile-discrete",EnvelopeAggregate:"envelope-aggregate",CentroidAggregate:"centroid-aggregate",ConvexHullAggregate:"convex-hull-aggregate"});let hh=BV=class extends fe{constructor(e){super(e),this.maxPointCount=void 0,this.maxRecordCount=void 0,this.maxVertexCount=void 0,this.onStatisticField=null,this.outStatisticFieldName=null,this.statisticType=null,this.statisticParameters=null}writeStatisticParameters(e,t){this.statisticType!=="percentile-continuous"&&this.statisticType!=="percentile-discrete"||(t.statisticParameters=se(e))}clone(){return new BV({maxPointCount:this.maxPointCount,maxRecordCount:this.maxRecordCount,maxVertexCount:this.maxVertexCount,onStatisticField:this.onStatisticField,outStatisticFieldName:this.outStatisticFieldName,statisticType:this.statisticType,statisticParameters:se(this.statisticParameters)})}};u([d({type:Number,json:{write:!0}})],hh.prototype,"maxPointCount",void 0),u([d({type:Number,json:{write:!0}})],hh.prototype,"maxRecordCount",void 0),u([d({type:Number,json:{write:!0}})],hh.prototype,"maxVertexCount",void 0),u([d({type:String,json:{write:!0}})],hh.prototype,"onStatisticField",void 0),u([d({type:String,json:{write:!0}})],hh.prototype,"outStatisticFieldName",void 0),u([d({type:String,json:{read:{source:"statisticType",reader:_Q.read},write:{target:"statisticType",writer:_Q.write}}})],hh.prototype,"statisticType",void 0),u([d({type:Object})],hh.prototype,"statisticParameters",void 0),u([Fe("statisticParameters")],hh.prototype,"writeStatisticParameters",null),hh=BV=u([P("esri.rest.support.StatisticDefinition")],hh);const Pde=hh;var tT;const tDe=new si({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),iDe=new si({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let St=tT=class extends fe{constructor(e){super(e),this.aggregateIds=null,this.cacheHint=void 0,this.compactGeometryEnabled=!1,this.datumTransformation=null,this.defaultSpatialReferenceEnabled=!1,this.distance=void 0,this.dynamicDataSource=void 0,this.formatOf3DObjects=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=void 0,this.groupByFieldsForStatistics=null,this.having=null,this.historicMoment=null,this.maxAllowableOffset=void 0,this.maxRecordCountFactor=1,this.multipatchOption=null,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.outStatistics=null,this.parameterValues=null,this.pixelSize=null,this.quantizationParameters=null,this.rangeValues=null,this.relationParameter=null,this.resultType=null,this.returnCentroid=!1,this.returnDistinctValues=!1,this.returnExceededLimitFeatures=!0,this.returnGeometry=!1,this.returnQueryGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.sourceSpatialReference=null,this.spatialRelationship="intersects",this.start=void 0,this.sqlFormat=null,this.text=null,this.timeExtent=null,this.timeReferenceUnknownClient=!1,this.units=null,this.where=null}static from(e){return ST(tT,e)}castDatumTransformation(e){return typeof e=="number"||typeof e=="object"?e:null}writeHistoricMoment(e,t){t.historicMoment=e&&e.getTime()}writeParameterValues(e,t){if(e){const i={};for(const r in e){const s=e[r];Array.isArray(s)?i[r]=s.map(n=>n instanceof Date?n.getTime():n):s instanceof Date?i[r]=s.getTime():i[r]=s}t.parameterValues=i}}writeStart(e,t){t.resultOffset=this.start,t.resultRecordCount=this.num||10,t.where="1=1"}writeWhere(e,t){t.where=e||"1=1"}clone(){return new tT(se({aggregateIds:this.aggregateIds,cacheHint:this.cacheHint,compactGeometryEnabled:this.compactGeometryEnabled,datumTransformation:this.datumTransformation,defaultSpatialReferenceEnabled:this.defaultSpatialReferenceEnabled,distance:this.distance,gdbVersion:this.gdbVersion,geometry:this.geometry,geometryPrecision:this.geometryPrecision,groupByFieldsForStatistics:this.groupByFieldsForStatistics,having:this.having,historicMoment:_(this.historicMoment)?new Date(this.historicMoment.getTime()):null,maxAllowableOffset:this.maxAllowableOffset,maxRecordCountFactor:this.maxRecordCountFactor,multipatchOption:this.multipatchOption,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,outStatistics:this.outStatistics,parameterValues:this.parameterValues,pixelSize:this.pixelSize,quantizationParameters:this.quantizationParameters,rangeValues:this.rangeValues,relationParameter:this.relationParameter,resultType:this.resultType,returnDistinctValues:this.returnDistinctValues,returnGeometry:this.returnGeometry,returnCentroid:this.returnCentroid,returnExceededLimitFeatures:this.returnExceededLimitFeatures,returnQueryGeometry:this.returnQueryGeometry,returnM:this.returnM,returnZ:this.returnZ,dynamicDataSource:this.dynamicDataSource,sourceSpatialReference:this.sourceSpatialReference,spatialRelationship:this.spatialRelationship,start:this.start,sqlFormat:this.sqlFormat,text:this.text,timeExtent:this.timeExtent,timeReferenceUnknownClient:this.timeReferenceUnknownClient,units:this.units,where:this.where}))}};St.MAX_MAX_RECORD_COUNT_FACTOR=5,u([d({json:{write:!0}})],St.prototype,"aggregateIds",void 0),u([d({type:Boolean,json:{write:!0}})],St.prototype,"cacheHint",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],St.prototype,"compactGeometryEnabled",void 0),u([d({json:{write:!0}})],St.prototype,"datumTransformation",void 0),u([At("datumTransformation")],St.prototype,"castDatumTransformation",null),u([d({type:Boolean,json:{default:!1,write:!0}})],St.prototype,"defaultSpatialReferenceEnabled",void 0),u([d({type:Number,json:{write:{overridePolicy:e=>({enabled:e>0})}}})],St.prototype,"distance",void 0),u([d({type:ec,json:{write:!0}})],St.prototype,"dynamicDataSource",void 0),u([d({type:String,json:{write:!0}})],St.prototype,"formatOf3DObjects",void 0),u([d({type:String,json:{write:!0}})],St.prototype,"gdbVersion",void 0),u([d({types:ob,json:{read:bp,write:!0}})],St.prototype,"geometry",void 0),u([d({type:Number,json:{write:!0}})],St.prototype,"geometryPrecision",void 0),u([d({type:[String],json:{write:!0}})],St.prototype,"groupByFieldsForStatistics",void 0),u([d({type:String,json:{write:!0}})],St.prototype,"having",void 0),u([d({type:Date})],St.prototype,"historicMoment",void 0),u([Fe("historicMoment")],St.prototype,"writeHistoricMoment",null),u([d({type:Number,json:{write:!0}})],St.prototype,"maxAllowableOffset",void 0),u([d({type:Number,cast:e=>e<1?1:e>tT.MAX_MAX_RECORD_COUNT_FACTOR?tT.MAX_MAX_RECORD_COUNT_FACTOR:e,json:{write:{overridePolicy:e=>({enabled:e>1})}}})],St.prototype,"maxRecordCountFactor",void 0),u([d({type:["xyFootprint"],json:{write:!0}})],St.prototype,"multipatchOption",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],St.prototype,"num",void 0),u([d({json:{write:!0}})],St.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],St.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],St.prototype,"outFields",void 0),u([d({type:He,json:{name:"outSR",write:!0}})],St.prototype,"outSpatialReference",void 0),u([d({type:[Pde],json:{write:{enabled:!0,overridePolicy(){return{enabled:_(this.outStatistics)&&this.outStatistics.length>0}}}}})],St.prototype,"outStatistics",void 0),u([d({json:{write:!0}})],St.prototype,"parameterValues",void 0),u([Fe("parameterValues")],St.prototype,"writeParameterValues",null),u([d({type:et,json:{write:!0}})],St.prototype,"pixelSize",void 0),u([d({type:eDe,json:{write:!0}})],St.prototype,"quantizationParameters",void 0),u([d({type:[Object],json:{write:!0}})],St.prototype,"rangeValues",void 0),u([d({type:String,json:{read:{source:"relationParam"},write:{target:"relationParam",overridePolicy(){return{enabled:this.spatialRelationship==="relation"}}}}})],St.prototype,"relationParameter",void 0),u([d({type:String,json:{write:!0}})],St.prototype,"resultType",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],St.prototype,"returnCentroid",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],St.prototype,"returnDistinctValues",void 0),u([d({type:Boolean,json:{default:!0,write:!0}})],St.prototype,"returnExceededLimitFeatures",void 0),u([d({type:Boolean,json:{write:!0}})],St.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],St.prototype,"returnQueryGeometry",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],St.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],St.prototype,"returnZ",void 0),u([d({type:He,json:{write:!0}})],St.prototype,"sourceSpatialReference",void 0),u([ut(tDe,{ignoreUnknown:!1,name:"spatialRel"})],St.prototype,"spatialRelationship",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],St.prototype,"start",void 0),u([Fe("start"),Fe("num")],St.prototype,"writeStart",null),u([d({type:String,json:{write:!0}})],St.prototype,"sqlFormat",void 0),u([d({type:String,json:{write:!0}})],St.prototype,"text",void 0),u([d({type:zp,json:{write:!0}})],St.prototype,"timeExtent",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],St.prototype,"timeReferenceUnknownClient",void 0),u([ut(iDe,{ignoreUnknown:!1}),d({json:{write:{overridePolicy(e){return{enabled:e&&this.distance>0}}}}})],St.prototype,"units",void 0),u([d({type:String,json:{write:{overridePolicy(e){return{enabled:e!=null||this.start>0}}}}})],St.prototype,"where",void 0),u([Fe("where")],St.prototype,"writeWhere",null),St=tT=u([P("esri.rest.support.Query")],St);const va=St;var VV;let Jr=VV=class extends fe{constructor(e){super(e),this.dynamicDataSource=void 0,this.gdbVersion=null,this.geometryPrecision=void 0,this.historicMoment=null,this.maxAllowableOffset=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.relationshipId=void 0,this.start=void 0,this.num=void 0,this.returnGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.where=null}_writeHistoricMoment(e,t){t.historicMoment=e&&e.getTime()}writeStart(e,t){t.resultOffset=this.start,t.resultRecordCount=this.num||10,this.start>0&&this.where==null&&(t.definitionExpression="1=1")}clone(){return new VV(se({dynamicDataSource:this.dynamicDataSource,gdbVersion:this.gdbVersion,geometryPrecision:this.geometryPrecision,historicMoment:this.historicMoment&&new Date(this.historicMoment.getTime()),maxAllowableOffset:this.maxAllowableOffset,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,relationshipId:this.relationshipId,start:this.start,num:this.num,returnGeometry:this.returnGeometry,where:this.where,returnZ:this.returnZ,returnM:this.returnM}))}};u([d({type:ec,json:{write:!0}})],Jr.prototype,"dynamicDataSource",void 0),u([d({type:String,json:{write:!0}})],Jr.prototype,"gdbVersion",void 0),u([d({type:Number,json:{write:!0}})],Jr.prototype,"geometryPrecision",void 0),u([d({type:Date})],Jr.prototype,"historicMoment",void 0),u([Fe("historicMoment")],Jr.prototype,"_writeHistoricMoment",null),u([d({type:Number,json:{write:!0}})],Jr.prototype,"maxAllowableOffset",void 0),u([d({type:[Number],json:{write:!0}})],Jr.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],Jr.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],Jr.prototype,"outFields",void 0),u([d({type:He,json:{read:{source:"outSR"},write:{target:"outSR"}}})],Jr.prototype,"outSpatialReference",void 0),u([d({json:{write:!0}})],Jr.prototype,"relationshipId",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],Jr.prototype,"start",void 0),u([Fe("start"),Fe("num")],Jr.prototype,"writeStart",null),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],Jr.prototype,"num",void 0),u([d({json:{write:!0}})],Jr.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],Jr.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],Jr.prototype,"returnZ",void 0),u([d({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],Jr.prototype,"where",void 0),Jr=VV=u([P("esri.rest.support.RelationshipQuery")],Jr),Jr.from=Ir(Jr);const L1=Jr;function rgt(e){var t;const i=e.layer;return"floorInfo"in i&&(t=i.floorInfo)!=null&&t.floorField&&"floors"in e.view?Ide(e.view.floors,i.floorInfo.floorField):null}function sgt(e,t){var i;return"floorInfo"in t&&(i=t.floorInfo)!=null&&i.floorField?Ide(e,t.floorInfo.floorField):null}function ngt(e,t){const{definitionExpression:i}=t;return e?i?`(${i}) AND (${e})`:e:i}function Ide(e,t){if(e==null||!e.length)return null;const i=e.filter(r=>r!=="").map(r=>`'${r}'`);return i.push("''"),`${t} IN (${i.join(",")}) OR ${t} IS NULL`}function rDe(e,t){return t?me(I({},t),{query:I(I({},e),t.query)}):{query:e}}function Oc(e){return typeof e=="string"?Ts(e):e}function sDe(e,t,i){const r={};for(const s in e){if(s==="declaredClass")continue;const n=e[s];if(n!=null&&typeof n!="function")if(Array.isArray(n)){r[s]=[];for(let o=0;o<n.length;o++)r[s][o]=sDe(n[o])}else if(typeof n=="object")if(n.toJSON){const o=n.toJSON(i&&i[s]);r[s]=t?o:JSON.stringify(o)}else r[s]=t?n:JSON.stringify(n);else r[s]=n}return r}function yO(e){const t={};for(const i in e){if(i==="declaredClass")continue;const r=e[i];if(r!=null&&typeof r!="function")if(Array.isArray(r)){t[i]=[];for(let s=0;s<r.length;s++)t[i][s]=yO(r[s])}else typeof r=="object"?r.toJSON&&(t[i]=JSON.stringify(r)):t[i]=r}return t}function nDe(e){const t=e.toJSON();return t.attachmentTypes&&(t.attachmentTypes=t.attachmentTypes.join(",")),t.keywords&&(t.keywords=t.keywords.join(",")),t.globalIds&&(t.globalIds=t.globalIds.join(",")),t.objectIds&&(t.objectIds=t.objectIds.join(",")),t.size&&(t.size=t.size.join(",")),t}function oDe(e,t){const i={};for(const r of e){const{parentObjectId:s,parentGlobalId:n,attachmentInfos:o}=r;for(const a of o){const{id:l}=a,c=CAe(rCe(`${t}/${s}/attachments/${l}`)),h=dde.fromJSON(a);h.set({url:c,parentObjectId:s,parentGlobalId:n}),i[s]?i[s].push(h):i[s]=[h]}}return i}function aDe(e,t,i){let r={query:yO(I(me(I({},e.query),{f:"json"}),nDe(t)))};return i&&(r=me(I(I({},i),r),{query:I(I({},i.query),r.query)})),Ti(e.path+"/queryAttachments",r)}async function lDe(e,t,i){const r=Oc(e);return aDe(r,JD.from(t),I({},i)).then(s=>oDe(s.data.attachmentGroups,r.path))}const $M={102100:{maxX:20037508342788905e-9,minX:-20037508342788905e-9,plus180Line:new cc({paths:[[[20037508342788905e-9,-20037508342788905e-9],[20037508342788905e-9,20037508342788905e-9]]],spatialReference:He.WebMercator}),minus180Line:new cc({paths:[[[-20037508342788905e-9,-20037508342788905e-9],[-20037508342788905e-9,20037508342788905e-9]]],spatialReference:He.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new cc({paths:[[[180,-180],[180,180]]],spatialReference:He.WGS84}),minus180Line:new cc({paths:[[[-180,-180],[-180,180]]],spatialReference:He.WGS84})}};function W_(e,t){return Math.ceil((e-t)/(2*t))}function $de(e,t){const i=tC(e);for(const r of i)for(const s of r)s[0]+=t;return e}function tC(e){return r1(e)?e.rings:e.paths}async function cDe(e,t,i,r){const s=typeof e=="string"?Ts(e):e,n=t[0].spatialReference,o=me(I({},r),{query:me(I({},s.query),{f:"json",sr:JSON.stringify(n),target:JSON.stringify({geometryType:F0(t[0]),geometries:t}),cutter:JSON.stringify(i)})}),a=await Ti(s.path+"/cut",o),{cutIndexes:l,geometries:c=[]}=a.data;return{cutIndexes:l,geometries:c.map(h=>{const p=bp(h);return p.spatialReference=n,p})}}async function uDe(e,t,i){const r=typeof e=="string"?Ts(e):e,s=t[0].spatialReference,n=F0(t[0]),o=me(I({},i),{query:me(I({},r.query),{f:"json",sr:s.wkid?s.wkid:JSON.stringify(s),geometries:JSON.stringify(hDe(t))})});return dDe((await Ti(r.path+"/simplify",o)).data,n,s)}function hDe(e){return{geometryType:F0(e[0]),geometries:e.map(t=>t.toJSON())}}function dDe(e,t,i){const r=Jae(t);return e.map(s=>{const n=r.fromJSON(s);return n.spatialReference=i,n})}const pDe=he.getLogger("esri.geometry.support.normalizeUtils");function fDe(e){return e.type==="polygon"}function mDe(e){return e[0].type==="polygon"}function gDe(e){return e[0].type==="polyline"}function yDe(e,t){if(!(e instanceof cc||e instanceof bc)){const s="straightLineDensify: the input geometry is neither polyline nor polygon";throw pDe.error(s),new q(s)}const i=tC(e),r=[];for(const s of i){const n=[];r.push(n),n.push([s[0][0],s[0][1]]);for(let o=0;o<s.length-1;o++){const a=s[o][0],l=s[o][1],c=s[o+1][0],h=s[o+1][1],p=Math.sqrt((c-a)*(c-a)+(h-l)*(h-l)),f=(h-l)/p,g=(c-a)/p,y=p/t;if(y>1){for(let S=1;S<=y-1;S++){const T=S*t,A=g*T+a,C=f*T+l;n.push([A,C])}const v=(p+Math.floor(y-1)*t)/2,b=g*v+a,w=f*v+l;n.push([b,w])}n.push([c,h])}}return fDe(e)?new bc({rings:r,spatialReference:e.spatialReference}):new cc({paths:r,spatialReference:e.spatialReference})}function bQ(e,t,i){if(t){const r=yDe(e,1e6);e=SE(r,!0)}return i&&(e=$de(e,i)),e}function wQ(e,t,i){if(Array.isArray(e)){const r=e[0];if(r>t){const s=W_(r,t);e[0]=r+s*(-2*t)}else if(r<i){const s=W_(r,i);e[0]=r+s*(-2*i)}}else{const r=e.x;if(r>t){const s=W_(r,t);e=e.clone().offset(s*(-2*t),0)}else if(r<i){const s=W_(r,i);e=e.clone().offset(s*(-2*i),0)}}return e}function vDe(e,t){let i=-1;for(let r=0;r<t.cutIndexes.length;r++){const s=t.cutIndexes[r],n=t.geometries[r],o=tC(n);for(let a=0;a<o.length;a++){const l=o[a];l.some(c=>{if(c[0]<180)return!0;{let h=0;for(let f=0;f<l.length;f++){const g=l[f][0];h=g>h?g:h}h=Number(h.toFixed(9));const p=-360*W_(h,180);for(let f=0;f<l.length;f++){const g=n.getPoint(a,f);n.setPoint(a,f,g.clone().offset(p,0))}return!0}})}if(s===i){if(mDe(e))for(const a of tC(n))e[s]=e[s].addRing(a);else if(gDe(e))for(const a of tC(n))e[s]=e[s].addPath(a)}else i=s,e[s]=n}return e}async function fH(e,t,i){var r;if(!Array.isArray(e))return fH([e],t);const s=(r=t==null?void 0:t.url)!=null?r:Bi.geometryServiceUrl;let n,o,a,l,c,h,p,f,g=0;const y=[],v=[];for(const C of e)if(R(C))v.push(C);else if(n||(n=C.spatialReference,o=s0(n),a=n.isWebMercator,h=a?102100:4326,l=$M[h].maxX,c=$M[h].minX,p=$M[h].plus180Line,f=$M[h].minus180Line),o)if(C.type==="mesh")v.push(C);else if(C.type==="point")v.push(wQ(C.clone(),l,c));else if(C.type==="multipoint"){const O=C.clone();O.points=O.points.map(L=>wQ(L,l,c)),v.push(O)}else if(C.type==="extent"){const O=C.clone()._normalize(!1,!1,o);v.push(O.rings?new bc(O):O)}else if(C.extent){const O=C.extent,L=W_(O.xmin,c)*(2*l);let U=L===0?C.clone():$de(C.clone(),L);O.offset(L,0),O.intersects(p)&&O.xmax!==l?(g=O.xmax>g?O.xmax:g,U=bQ(U,a),y.push(U),v.push("cut")):O.intersects(f)&&O.xmin!==c?(g=O.xmax*(2*l)>g?O.xmax*(2*l):g,U=bQ(U,a,360),y.push(U),v.push("cut")):v.push(U)}else v.push(C.clone());else v.push(C);let b=W_(g,l),w=-90;const S=b,T=new cc;for(;b>0;){const C=360*b-180;T.addPath([[C,w],[C,-1*w]]),w*=-1,b--}if(y.length>0&&S>0){const C=vDe(y,await cDe(s,y,T,i)),O=[],L=[];for(let z=0;z<v.length;z++){const V=v[z];if(V!=="cut")L.push(V);else{const B=C.shift(),J=e[z];_(J)&&J.type==="polygon"&&J.rings&&J.rings.length>1&&B.rings.length>=J.rings.length?(O.push(B),L.push("simplify")):L.push(a?fm(B):B)}}if(!O.length)return L;const U=await uDe(s,O,i),N=[];for(let z=0;z<L.length;z++){const V=L[z];V!=="simplify"?N.push(V):N.push(a?fm(U.shift()):U.shift())}return N}const A=[];for(let C=0;C<v.length;C++){const O=v[C];if(O!=="cut")A.push(O);else{const L=y.shift();A.push(a===!0?fm(L):L)}}return Promise.resolve(A)}var vy;(function(e){e[e.varint=0]="varint",e[e.fixed64=1]="fixed64",e[e.delimited=2]="delimited",e[e.fixed32=5]="fixed32",e[e.unknown=99]="unknown"})(vy||(vy={}));const xQ=4294967296,_De=new TextDecoder("utf-8"),bDe=ue("safari")||ue("ios")?6:ue("ff")?12:32;class d1{constructor(t,i,r=0,s=t?t.byteLength:0){this._tag=0,this._dataType=vy.unknown,this._init(t,i,r,s)}_init(t,i,r,s){this._data=t,this._dataView=i,this._pos=r,this._end=s}clone(){return new d1(this._data,this._dataView,this._pos,this._end)}pos(){return this._pos}move(t){this._pos=t}nextTag(t){for(;;){if(this._pos===this._end)return!1;const i=this._decodeVarint();if(this._tag=i>>3,this._dataType=7&i,!t||t===this._tag)break;this.skip()}return!0}next(){if(this._pos===this._end)return!1;const t=this._decodeVarint();return this._tag=t>>3,this._dataType=7&t,!0}empty(){return this._pos>=this._end}tag(){return this._tag}getInt32(){return this._decodeVarint()}getInt64(){return this._decodeVarint()}getUInt32(){let t=4294967295;return t=(127&this._data[this._pos])>>>0,this._data[this._pos++]<128?t:(t=(t|(127&this._data[this._pos])<<7)>>>0,this._data[this._pos++]<128?t:(t=(t|(127&this._data[this._pos])<<14)>>>0,this._data[this._pos++]<128?t:(t=(t|(127&this._data[this._pos])<<21)>>>0,this._data[this._pos++]<128?t:(t=(t|(15&this._data[this._pos])<<28)>>>0,this._data[this._pos++]<128?t:void 0))))}getUInt64(){return this._decodeVarint()}getSInt32(){const t=this.getUInt32();return t>>>1^-(1&t)|0}getSInt64(){return this._decodeSVarint()}getBool(){const t=this._data[this._pos]!==0;return this._skip(1),t}getEnum(){return this._decodeVarint()}getFixed64(){const t=this._dataView,i=this._pos,r=t.getUint32(i,!0)+t.getUint32(i+4,!0)*xQ;return this._skip(8),r}getSFixed64(){const t=this._dataView,i=this._pos,r=t.getUint32(i,!0)+t.getInt32(i+4,!0)*xQ;return this._skip(8),r}getDouble(){const t=this._dataView.getFloat64(this._pos,!0);return this._skip(8),t}getFixed32(){const t=this._dataView.getUint32(this._pos,!0);return this._skip(4),t}getSFixed32(){const t=this._dataView.getInt32(this._pos,!0);return this._skip(4),t}getFloat(){const t=this._dataView.getFloat32(this._pos,!0);return this._skip(4),t}getString(){const t=this._getLength(),i=this._pos,r=this._toString(this._data,i,i+t);return this._skip(t),r}getBytes(){const t=this._getLength(),i=this._pos,r=this._toBytes(this._data,i,i+t);return this._skip(t),r}getLength(){return this._getLengthUnsafe()}processMessageWithArgs(t,i,r,s){const n=this.getMessage(),o=t(n,i,r,s);return n.release(),o}processMessage(t){const i=this.getMessage(),r=t(i);return i.release(),r}getMessage(){const t=this._getLength(),i=d1.pool.acquire();return i._init(this._data,this._dataView,this._pos,this._pos+t),this._skip(t),i}release(){d1.pool.release(this)}dataType(){return this._dataType}skip(){switch(this._dataType){case vy.varint:this._decodeVarint();break;case vy.fixed64:this._skip(8);break;case vy.delimited:this._skip(this._getLength());break;case vy.fixed32:this._skip(4);break;default:throw new Error("Invalid data type!")}}skipLen(t){this._skip(t)}_skip(t){if(this._pos+t>this._end)throw new Error("Attempt to skip past the end of buffer!");this._pos+=t}_decodeVarint(){const t=this._data;let i,r=this._pos,s=0;if(this._end-r>=10)do{if(i=t[r++],s|=127&i,(128&i)==0||(i=t[r++],s|=(127&i)<<7,(128&i)==0)||(i=t[r++],s|=(127&i)<<14,(128&i)==0)||(i=t[r++],s|=(127&i)<<21,(128&i)==0)||(i=t[r++],s+=268435456*(127&i),(128&i)==0)||(i=t[r++],s+=34359738368*(127&i),(128&i)==0)||(i=t[r++],s+=4398046511104*(127&i),(128&i)==0)||(i=t[r++],s+=562949953421312*(127&i),(128&i)==0)||(i=t[r++],s+=72057594037927940*(127&i),(128&i)==0)||(i=t[r++],s+=9223372036854776e3*(127&i),(128&i)==0))break;throw new Error("Varint too long!")}while(0);else{let n=1;for(;r!==this._end&&(i=t[r],(128&i)!=0);)++r,s+=(127&i)*n,n*=128;if(r===this._end)throw new Error("Varint overrun!");++r,s+=i*n}return this._pos=r,s}_decodeSVarint(){const t=this._decodeVarint();return t%2?-(t+1)/2:t/2}_getLength(){if(this._dataType!==vy.delimited)throw new Error("Not a delimited data type!");return this._decodeVarint()}_getLengthUnsafe(){return this.getUInt32()}_toString(t,i,r){if((r=Math.min(this._end,r))-i>bDe){const o=t.subarray(i,r);return _De.decode(o)}let s="",n="";for(let o=i;o<r;++o){const a=t[o];128&a?n+="%"+a.toString(16):(s+=decodeURIComponent(n)+String.fromCharCode(a),n="")}return n.length&&(s+=decodeURIComponent(n)),s}_toBytes(t,i,r){return r=Math.min(this._end,r),new Uint8Array(t.buffer,i,r-i)}}d1.pool=new Wr(d1,null,e=>{e._data=null,e._dataView=null});class Sl{constructor(t=[],i=[],r=!1){this.lengths=t!=null?t:[],this.coords=i!=null?i:[],this.hasIndeterminateRingOrder=r}get isPoint(){return this.lengths.length===0}get maxLength(){return Math.max(...this.lengths)}get size(){return this.lengths.reduce((t,i)=>t+i)}forEachVertex(t){let i=0;this.lengths.length||t(this.coords[0],this.coords[1]);for(let r=0;r<this.lengths.length;r++){const s=this.lengths[r];for(let n=0;n<s;n++)t(this.coords[2*(n+i)],this.coords[2*(n+i)+1]);i+=s}}clone(t){return t?(t.set(this.coords),new Sl(this.lengths.slice(),t,this.hasIndeterminateRingOrder)):new Sl(this.lengths.slice(),this.coords.slice(),this.hasIndeterminateRingOrder)}}class Op{constructor(t=null,i={},r,s){this.geometry=t,this.attributes=i,this.centroid=r,this.objectId=s,this.displayId=0,this.geohashX=0,this.geohashY=0}weakClone(){const t=new Op(this.geometry,this.attributes,this.centroid,this.objectId);return t.displayId=this.displayId,t.geohashX=this.geohashX,t.geohashY=this.geohashY,t}}function wDe(e){return!(R(e.geometry)||!e.geometry.coords||!e.geometry.coords.length)}class ogt extends Op{}class xF{constructor(){this.objectIdFieldName=null,this.globalIdFieldName=null,this.geohashFieldName=null,this.geometryProperties=null,this.geometryType=null,this.spatialReference=null,this.hasZ=!1,this.hasM=!1,this.features=[],this.fields=[],this.transform=null,this.exceededTransferLimit=!1,this.uniqueIdField=null,this.queryGeometryType=null,this.queryGeometry=null}weakClone(){const t=new xF;return t.objectIdFieldName=this.objectIdFieldName,t.globalIdFieldName=this.globalIdFieldName,t.geohashFieldName=this.geohashFieldName,t.geometryProperties=this.geometryProperties,t.geometryType=this.geometryType,t.spatialReference=this.spatialReference,t.hasZ=this.hasZ,t.hasM=this.hasM,t.features=this.features,t.fields=this.fields,t.transform=this.transform,t.exceededTransferLimit=this.exceededTransferLimit,t.uniqueIdField=this.uniqueIdField,t.queryGeometry=this.queryGeometry,t.queryGeometryType=this.queryGeometryType,t}}const Dde=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"];class agt{constructor(t){this.options=t,this.geometryTypes=Dde,this._coordinatePtr=0,this._vertexDimension=0}createFeatureResult(){return new xF}prepareFeatures(t){this._vertexDimension=2,t.hasZ&&this._vertexDimension++,t.hasM&&this._vertexDimension++}finishFeatureResult(t){if(!t||!t.features||!t.hasZ||!this.options.sourceSpatialReference||!t.spatialReference||Rc(t.spatialReference,this.options.sourceSpatialReference)||t.spatialReference.vcsWkid)return;const i=BT(this.options.sourceSpatialReference)/BT(t.spatialReference);if(i!==1)for(const r of t.features){if(!wDe(r))continue;const s=r.geometry.coords;for(let n=2;n<s.length;n+=3)s[n]*=i}}addFeature(t,i){t.features.push(i)}createFeature(){return new Op}createSpatialReference(){return{wkid:0}}createGeometry(){return new Sl}addField(t,i){t.fields.push(i)}allocateCoordinates(t){t.coords.length=t.lengths.reduce((i,r)=>i+r,0)*this._vertexDimension,this._coordinatePtr=0}addCoordinate(t,i){t.coords[this._coordinatePtr++]=i}addCoordinatePoint(t,i){t.coords.push(i)}addLength(t,i){t.lengths.push(i)}addQueryGeometry(t,i){t.queryGeometry=i.queryGeometry,t.queryGeometryType=i.queryGeometryType}createPointGeometry(){return new Sl}}const TQ=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML"],SQ=["sqlTypeBigInt","sqlTypeBinary","sqlTypeBit","sqlTypeChar","sqlTypeDate","sqlTypeDecimal","sqlTypeDouble","sqlTypeFloat","sqlTypeGeometry","sqlTypeGUID","sqlTypeInteger","sqlTypeLongNVarchar","sqlTypeLongVarbinary","sqlTypeLongVarchar","sqlTypeNChar","sqlTypeNVarchar","sqlTypeOther","sqlTypeReal","sqlTypeSmallInt","sqlTypeSqlXml","sqlTypeTime","sqlTypeTimestamp","sqlTypeTimestamp2","sqlTypeTinyInt","sqlTypeVarbinary","sqlTypeVarchar"],EQ=["upperLeft","lowerLeft"];function AQ(e){return e>=TQ.length?null:TQ[e]}function xDe(e){return e>=SQ.length?null:SQ[e]}function CQ(e){return e>=EQ.length?null:EQ[e]}function RQ(e,t){return t>=e.geometryTypes.length?null:e.geometryTypes[t]}function TDe(e,t,i){const s=t.createPointGeometry(i);for(;e.next();)switch(e.tag()){case 3:{const n=e.getUInt32(),o=e.pos()+n;let a=0;for(;e.pos()<o;)t.addCoordinatePoint(s,e.getSInt64(),a++);break}default:e.skip()}return s}function SDe(e,t,i){const n=t.createGeometry(i),o=2+(i.hasZ?1:0)+(i.hasM?1:0);for(;e.next();)switch(e.tag()){case 2:{const a=e.getUInt32(),l=e.pos()+a;let c=0;for(;e.pos()<l;)t.addLength(n,e.getUInt32(),c++);break}case 3:{const a=e.getUInt32(),l=e.pos()+a;let c=0;for(t.allocateCoordinates(n);e.pos()<l;)t.addCoordinate(n,e.getSInt64(),c),c++,c===o&&(c=0);break}default:e.skip()}return n}function EDe(e){const s=new Sl;let n="esriGeometryPoint";for(;e.next();)switch(e.tag()){case 2:{const o=e.getUInt32(),a=e.pos()+o;for(;e.pos()<a;)s.lengths.push(e.getUInt32());break}case 3:{const o=e.getUInt32(),a=e.pos()+o;for(;e.pos()<a;)s.coords.push(e.getSInt64());break}case 1:n=Dde[e.getEnum()];break;default:e.skip()}return{queryGeometry:s,queryGeometryType:n}}function ADe(e){for(;e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}function CDe(e){const a={type:AQ(0)};for(;e.next();)switch(e.tag()){case 1:a.name=e.getString();break;case 2:a.type=AQ(e.getEnum());break;case 3:a.alias=e.getString();break;case 4:a.sqlType=xDe(e.getEnum());break;case 5:e.skip();break;case 6:a.defaultValue=e.getString();break;default:e.skip()}return a}function RDe(e){const r={};for(;e.next();)switch(e.tag()){case 1:r.name=e.getString();break;case 2:r.isSystemMaintained=e.getBool();break;default:e.skip()}return r}function ODe(e,t,i,r){const a=t.createFeature(i);let l=0;for(;e.next();)switch(e.tag()){case 1:{const c=r[l++].name;a.attributes[c]=e.processMessage(ADe);break}case 2:a.geometry=e.processMessageWithArgs(SDe,t,i);break;case 4:a.centroid=e.processMessageWithArgs(TDe,t,i);break;default:e.skip()}return a}function MDe(e){const n=[1,1,1,1];for(;e.next();)switch(e.tag()){case 1:n[0]=e.getDouble();break;case 2:n[1]=e.getDouble();break;case 4:n[2]=e.getDouble();break;case 3:n[3]=e.getDouble();break;default:e.skip()}return n}function PDe(e){const n=[0,0,0,0];for(;e.next();)switch(e.tag()){case 1:n[0]=e.getDouble();break;case 2:n[1]=e.getDouble();break;case 4:n[2]=e.getDouble();break;case 3:n[3]=e.getDouble();break;default:e.skip()}return n}function IDe(e){const s={originPosition:CQ(0)};for(;e.next();)switch(e.tag()){case 1:s.originPosition=CQ(e.getEnum());break;case 2:s.scale=e.processMessage(MDe);break;case 3:s.translate=e.processMessage(PDe);break;default:e.skip()}return s}function $De(e){const s={};for(;e.next();)switch(e.tag()){case 1:s.shapeAreaFieldName=e.getString();break;case 2:s.shapeLengthFieldName=e.getString();break;case 3:s.units=e.getString();break;default:e.skip()}return s}function DDe(e,t){const a=t.createSpatialReference();for(;e.next();)switch(e.tag()){case 1:a.wkid=e.getUInt32();break;case 5:a.wkt=e.getString();break;case 2:a.latestWkid=e.getUInt32();break;case 3:a.vcsWkid=e.getUInt32();break;case 4:a.latestVcsWkid=e.getUInt32();break;default:e.skip()}return a}function LDe(e,t){const v=t.createFeatureResult();v.geometryType=RQ(t,0);let b=!1;for(;e.next();)switch(e.tag()){case 1:v.objectIdFieldName=e.getString();break;case 3:v.globalIdFieldName=e.getString();break;case 4:v.geohashFieldName=e.getString();break;case 5:v.geometryProperties=e.processMessage($De);break;case 7:v.geometryType=RQ(t,e.getEnum());break;case 8:v.spatialReference=e.processMessageWithArgs(DDe,t);break;case 10:v.hasZ=e.getBool();break;case 11:v.hasM=e.getBool();break;case 12:v.transform=e.processMessage(IDe);break;case 9:{const w=e.getBool();v.exceededTransferLimit=w;break}case 13:t.addField(v,e.processMessage(CDe));break;case 15:b||(t.prepareFeatures(v),b=!0),t.addFeature(v,e.processMessageWithArgs(ODe,t,v,v.fields));break;case 2:v.uniqueIdField=e.processMessage(RDe);break;default:e.skip()}return t.finishFeatureResult(v),v}function NDe(e,t){const s={};let n=null;for(;e.next();)switch(e.tag()){case 4:n=e.processMessageWithArgs(EDe);break;case 1:s.featureResult=e.processMessageWithArgs(LDe,t);break;default:e.skip()}return _(n)&&s.featureResult&&t.addQueryGeometry(s,n),s}function FDe(e,t){try{const r=new d1(new Uint8Array(e),new DataView(e)),s={};for(;r.next();)r.tag()===2?s.queryResult=r.processMessageWithArgs(NDe,t):r.skip();return s}catch(i){throw new q("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:i})}}function UDe(e,t){const i=FDe(e,t),r=i.queryResult.featureResult,s=i.queryResult.queryGeometry,n=i.queryResult.queryGeometryType;if(r&&r.features&&r.features.length&&r.objectIdFieldName){const o=r.objectIdFieldName;for(const a of r.features)a.attributes&&(a.objectId=a.attributes[o])}return r&&(r.queryGeometry=s,r.queryGeometryType=n),r}function iL(e,t,i){if(!i||!i.features||!i.hasZ)return;const r=Oj(i.geometryType,t,e.outSpatialReference);if(!R(r))for(const s of i.features)r(s.geometry)}const OQ="Layer does not support extent calculation.";function Lde(e,t){if(t&&e.type==="extent")return`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`;if(t&&e.type==="point")return`${e.x},${e.y}`;const i=e.toJSON();return delete i.spatialReference,JSON.stringify(i)}function Nde(e,t){const i=e.geometry,r=e.toJSON();delete r.compactGeometryEnabled,delete r.defaultSpatialReferenceEnabled;const s=r,n=e.outSpatialReference;let o,a;if(_(i)&&(o=i.spatialReference,a=i.spatialReference.wkid||JSON.stringify(i.spatialReference),s.geometryType=F0(i),s.geometry=Lde(i,e.compactGeometryEnabled),s.inSR=a),r.groupByFieldsForStatistics&&(s.groupByFieldsForStatistics=r.groupByFieldsForStatistics.join(",")),r.objectIds&&(s.objectIds=r.objectIds.join(",")),r.orderByFields&&(s.orderByFields=r.orderByFields.join(",")),!r.outFields||!r.returnDistinctValues&&(t!=null&&t.returnCountOnly||t!=null&&t.returnExtentOnly||t!=null&&t.returnIdsOnly)?delete s.outFields:r.outFields.indexOf("*")!==-1?s.outFields="*":s.outFields=r.outFields.join(","),r.outSR?s.outSR=r.outSR.wkid||JSON.stringify(r.outSR):i&&(r.returnGeometry||r.returnCentroid)&&(s.outSR=s.inSR),r.returnGeometry&&delete r.returnGeometry,r.outStatistics&&(s.outStatistics=JSON.stringify(r.outStatistics)),r.pixelSize&&(s.pixelSize=JSON.stringify(r.pixelSize)),r.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&_(o)&&_(e.quantizationParameters)&&_(e.quantizationParameters.extent)&&o.equals(e.quantizationParameters.extent.spatialReference)&&delete r.quantizationParameters.extent.spatialReference,s.quantizationParameters=JSON.stringify(r.quantizationParameters)),r.parameterValues&&(s.parameterValues=JSON.stringify(r.parameterValues)),r.rangeValues&&(s.rangeValues=JSON.stringify(r.rangeValues)),r.dynamicDataSource&&(s.layer=JSON.stringify({source:r.dynamicDataSource}),delete r.dynamicDataSource),r.timeExtent){const l=r.timeExtent,{start:c,end:h}=l;c==null&&h==null||(s.time=c===h?c:`${c==null?"null":c},${h==null?"null":h}`),delete r.timeExtent}return e.defaultSpatialReferenceEnabled&&_(o)&&_(n)&&o.equals(n)&&(s.defaultSR=s.inSR,delete s.inSR,delete s.outSR),s}async function Fde(e,t,i,r){const s=_(t.timeExtent)&&t.timeExtent.isEmpty?{data:{features:[]}}:await XS(e,t,"json",r);return iL(t,i,s.data),s}async function Ude(e,t,i,r){if(_(t.timeExtent)&&t.timeExtent.isEmpty)return Promise.resolve({data:i.createFeatureResult()});const s=await kde(e,t,r),n=s;return n.data=UDe(s.data,i),n}function kde(e,t,i){return XS(e,t,"pbf",i)}function zde(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):XS(e,t,"json",i,{returnIdsOnly:!0})}function Bde(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):XS(e,t,"json",i,{returnIdsOnly:!0,returnCountOnly:!0})}function Vde(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):XS(e,t,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}).then(r=>{const s=r.data;if(s.hasOwnProperty("extent"))return r;if(s.features)throw new Error(OQ);if(s.hasOwnProperty("count"))throw new Error(OQ);return r})}function XS(e,t,i,r={},s={}){const n=typeof e=="string"?Ts(e):e,o=t.geometry?[t.geometry]:[];return r.responseType=i==="pbf"?"array-buffer":"json",fH(o,null,r).then(a=>{const l=a&&a[0];_(l)&&((t=t.clone()).geometry=l);const c=yO(I(I(me(I({},n.query),{f:i}),s),Nde(t,s)));return Ti(bl(n.path,"query"),me(I({},r),{query:I(I({},c),r.query)}))})}var lgt=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",encodeGeometry:Lde,executeQuery:Fde,executeQueryForCount:Bde,executeQueryForExtent:Vde,executeQueryForIds:zde,executeQueryPBF:Ude,executeQueryPBFBuffer:kde,queryToQueryStringParameters:Nde,runQuery:XS});async function kDe(e,t,i){const r=Oc(e);return Bde(r,va.from(t),I({},i)).then(s=>s.data.count)}async function zDe(e,t,i){const r=Oc(e);return Vde(r,va.from(t),I({},i)).then(s=>({count:s.data.count,extent:Xt.fromJSON(s.data.extent)}))}async function BDe(e,t,i){const r=Oc(e);return zde(r,va.from(t),I({},i)).then(s=>s.data.objectIds)}var GV;const jV=new si({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh","":null});let On=GV=class extends fe{constructor(e){super(e),this.displayFieldName=null,this.exceededTransferLimit=!1,this.features=[],this.fields=null,this.geometryType=null,this.hasM=!1,this.hasZ=!1,this.queryGeometry=null,this.spatialReference=null}readFeatures(e,t){const i=He.fromJSON(t.spatialReference),r=[];for(let s=0;s<e.length;s++){const n=e[s],o=qo.fromJSON(n),a=n.geometry&&n.geometry.spatialReference;_(o.geometry)&&!a&&(o.geometry.spatialReference=i);const l=n.aggregateGeometries,c=o.aggregateGeometries;if(l&&_(c))for(const h in c){const p=c[h],f=l[h],g=f==null?void 0:f.spatialReference;_(p)&&!g&&(p.spatialReference=i)}r.push(o)}return r}writeGeometryType(e,t,i,r){if(e)return void jV.write(e,t,i,r);const{features:s}=this;if(s){for(const n of s)if(n&&_(n.geometry))return void jV.write(n.geometry.type,t,i,r)}}readQueryGeometry(e,t){if(!e)return null;const i=!!e.spatialReference,r=bp(e);return!i&&t.spatialReference&&(r.spatialReference=He.fromJSON(t.spatialReference)),r}writeSpatialReference(e,t){if(e)return void(t.spatialReference=e.toJSON());const{features:i}=this;if(i){for(const r of i)if(r&&_(r.geometry)&&r.geometry.spatialReference)return void(t.spatialReference=r.geometry.spatialReference.toJSON())}}clone(){return new GV(this.cloneProperties())}cloneProperties(){return se({displayFieldName:this.displayFieldName,exceededTransferLimit:this.exceededTransferLimit,features:this.features,fields:this.fields,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,queryGeometry:this.queryGeometry,spatialReference:this.spatialReference,transform:this.transform})}toJSON(e){const t=this.write();if(t.features&&Array.isArray(e)&&e.length>0)for(let i=0;i<t.features.length;i++){const r=t.features[i];if(r.geometry){const s=e&&e[i];r.geometry=s&&s.toJSON()||r.geometry}}return t}quantize(e){const{scale:[t,i],translate:[r,s]}=e,n=c=>Math.round((c-r)/t),o=c=>Math.round((s-c)/i),a=this.features,l=this._getQuantizationFunction(this.geometryType,n,o);for(let c=0,h=a.length;c<h;c++)l(a[c].geometry)||(a.splice(c,1),c--,h--);return this.transform=e,this}unquantize(){const{geometryType:e,features:t,transform:i}=this;if(!i)return this;const{translate:[r,s],scale:[n,o]}=i,a=h=>h*n+r,l=h=>s-h*o,c=this._getHydrationFunction(e,a,l);for(const{geometry:h}of t)_(h)&&c(h);return this.transform=null,this}_quantizePoints(e,t,i){let r,s;const n=[];for(let o=0,a=e.length;o<a;o++){const l=e[o];if(o>0){const c=t(l[0]),h=i(l[1]);c===r&&h===s||(n.push([c-r,h-s]),r=c,s=h)}else r=t(l[0]),s=i(l[1]),n.push([r,s])}return n.length>0?n:null}_getQuantizationFunction(e,t,i){return e==="point"?r=>(r.x=t(r.x),r.y=i(r.y),r):e==="polyline"||e==="polygon"?r=>{const s=r1(r)?r.rings:r.paths,n=[];for(let o=0,a=s.length;o<a;o++){const l=s[o],c=this._quantizePoints(l,t,i);c&&n.push(c)}return n.length>0?(r1(r)?r.rings=n:r.paths=n,r):null}:e==="multipoint"?r=>{const s=this._quantizePoints(r.points,t,i);return s.length>0?(r.points=s,r):null}:e==="extent"?r=>r:null}_getHydrationFunction(e,t,i){return e==="point"?r=>{r.x=t(r.x),r.y=i(r.y)}:e==="polyline"||e==="polygon"?r=>{const s=r1(r)?r.rings:r.paths;let n,o;for(let a=0,l=s.length;a<l;a++){const c=s[a];for(let h=0,p=c.length;h<p;h++){const f=c[h];h>0?(n+=f[0],o+=f[1]):(n=f[0],o=f[1]),f[0]=t(n),f[1]=i(o)}}}:e==="extent"?r=>{r.xmin=t(r.xmin),r.ymin=i(r.ymin),r.xmax=t(r.xmax),r.ymax=i(r.ymax)}:e==="multipoint"?r=>{const s=r.points;let n,o;for(let a=0,l=s.length;a<l;a++){const c=s[a];a>0?(n+=c[0],o+=c[1]):(n=c[0],o=c[1]),c[0]=t(n),c[1]=i(o)}}:void 0}};u([d({type:String,json:{write:!0}})],On.prototype,"displayFieldName",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],On.prototype,"exceededTransferLimit",void 0),u([d({type:[qo],json:{write:!0}})],On.prototype,"features",void 0),u([De("features")],On.prototype,"readFeatures",null),u([d({type:[gO],json:{write:!0}})],On.prototype,"fields",void 0),u([d({type:["point","multipoint","polyline","polygon","extent","mesh"],json:{read:{reader:jV.read}}})],On.prototype,"geometryType",void 0),u([Fe("geometryType")],On.prototype,"writeGeometryType",null),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],On.prototype,"hasM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],On.prototype,"hasZ",void 0),u([d({types:ob,json:{write:!0}})],On.prototype,"queryGeometry",void 0),u([De("queryGeometry")],On.prototype,"readQueryGeometry",null),u([d({type:He,json:{write:!0}})],On.prototype,"spatialReference",void 0),u([Fe("spatialReference")],On.prototype,"writeSpatialReference",null),u([d({json:{write:!0}})],On.prototype,"transform",void 0),On=GV=u([P("esri.rest.support.FeatureSet")],On),On.prototype.toJSON.isDefaultToJSON=!0;const mb=On;var cgt=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:mb});async function ugt(e,t,i){const r=await Gde(e,t,i);return mb.fromJSON(r)}async function Gde(e,t,i){const r=Oc(e),s=I({},i),n=va.from(t),{data:o}=await Fde(r,n,n.sourceSpatialReference,s);return o}function vo(e,t){return e?t?4:3:t?3:2}const vO=he.getLogger("esri.layers.graphics.featureConversionUtils"),jde={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},Hde=(e,t,i,r,s,n)=>{e[i]=s,e[i+1]=n},rL=(e,t,i,r,s,n)=>{e[i]=s,e[i+1]=n,e[i+2]=t[r+2]},VDe=(e,t,i,r,s,n)=>{e[i]=s,e[i+1]=n,e[i+2]=t[r+3]},qde=(e,t,i,r,s,n)=>{e[i]=s,e[i+1]=n,e[i+2]=t[r+2],e[i+3]=t[r+3]};function mH(e,t,i,r){if(e){if(i)return t&&r?qde:rL;if(t&&r)return VDe}else if(t&&r)return rL;return Hde}function K5({scale:e,translate:t},i){return Math.round((i-t[0])/e[0])}function eU({scale:e,translate:t},i){return Math.round((t[1]-i)/e[1])}function MQ({scale:e,translate:t},i){return i*e[0]+t[0]}function PQ({scale:e,translate:t},i){return t[1]-i*e[1]}function hgt(e,t,i){return e?t?i?vH(e):gH(e):i?yH(e):TF(e):null}function TF(e){const t=e.coords;return{x:t[0],y:t[1]}}function Wde(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e}function gH(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2]}}function GDe(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e}function yH(e){const t=e.coords;return{x:t[0],y:t[1],m:t[2]}}function jDe(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.m,e}function vH(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2],m:t[3]}}function HDe(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e.coords[3]=t.m,e}function qDe(e,t,i,r){let s=TF;i&&r?s=vH:i?s=gH:r&&(s=yH);for(const n of t){const{geometry:o,attributes:a}=n,l=_(o)?s(o):null;e.push({attributes:a,geometry:l})}return e}function _H(e,t){return e&&t?HDe:e?GDe:t?jDe:Wde}function WDe(e,t,i,r,s){const n=_H(i,r);for(const o of t){const{geometry:a,attributes:l}=o;let c;a&&(c=n(new Sl,a)),e.push(new Op(c,l,null,l[s]))}return e}function dgt(e,t,i=_H(t.z!=null,t.m!=null)){return i(e,t)}function XDe(e,t,i,r){for(const s of t){const{geometry:n,attributes:o}=s;let a;n&&(a=Xde(n,i,r)),e.push({attributes:o,geometry:a})}return e}function Xde(e,t,i){if(R(e))return null;const r=vo(t,i),s=[];for(let n=0;n<e.coords.length;n+=r){const o=[];for(let a=0;a<r;a++)o.push(e.coords[n+a]);s.push(o)}return t?i?{points:s,hasZ:t,hasM:i}:{points:s,hasZ:t}:i?{points:s,hasM:i}:{points:s}}function YDe(e,t,i,r,s){const n=vo(i,r);for(const o of t){const a=o.geometry,l=o.attributes;let c;a&&(c=Yde(new Sl,a,n)),e.push(new Op(c,l,null,l[s]))}return e}function Yde(e,t,i=vo(t.hasZ,t.hasM)){e.lengths[0]=t.points.length;const r=e.coords;let s=0;for(const n of t.points)for(let o=0;o<i;o++)r[s++]=n[o];return e}function ZDe(e,t,i,r){for(const s of t){const{geometry:n,attributes:o}=s;let a;_(n)&&(a=Zde(n,i,r)),e.push({attributes:o,geometry:a})}return e}function Zde(e,t,i){if(!e)return null;const r=vo(t,i),{coords:s,lengths:n}=e,o=[];let a=0;for(const l of n){const c=[];for(let h=0;h<l;h++){const p=[];for(let f=0;f<r;f++)p.push(s[a++]);c.push(p)}o.push(c)}return t?i?{paths:o,hasZ:t,hasM:i}:{paths:o,hasZ:t}:i?{paths:o,hasM:i}:{paths:o}}function QDe(e,t,i,r,s){const n=vo(i,r);for(const o of t){const a=o.geometry,l=o.attributes;let c;a&&(c=Qde(new Sl,a,n)),e.push(new Op(c,l,null,l[s]))}return e}function Qde(e,t,i=vo(t.hasZ,t.hasM)){const{lengths:r,coords:s}=e;let n=0;for(const o of t.paths){for(const a of o)for(let l=0;l<i;l++)s[n++]=a[l];r.push(o.length)}return e}function JDe(e,t,i,r){for(const s of t){const{geometry:n,attributes:o,centroid:a}=s;let l;if(_(n)&&(l=Jde(n,i,r)),_(a)){const c=TF(a);e.push({attributes:o,centroid:c,geometry:l})}else e.push({attributes:o,geometry:l})}return e}function Jde(e,t,i){if(!e)return null;const r=vo(t,i),{coords:s,lengths:n}=e,o=[];let a=0;for(const l of n){const c=[];for(let h=0;h<l;h++){const p=[];for(let f=0;f<r;f++)p.push(s[a++]);c.push(p)}o.push(c)}return t?i?{rings:o,hasZ:t,hasM:i}:{rings:o,hasZ:t}:i?{rings:o,hasM:i}:{rings:o}}function KDe(e,t,i,r,s){for(const n of t){const o=n.geometry,a=n.centroid,l=n.attributes;let c;o&&(c=Kde(new Sl,o,i,r)),_(a)?e.push(new Op(c,l,Wde(new Sl,a),l[s])):e.push(new Op(c,l,null,l[s]))}return e}function Kde(e,t,i=t.hasZ,r=t.hasM){return eLe(e,t.rings,i,r),e}function eLe(e,t,i,r){const s=vo(i,r),{lengths:n,coords:o}=e;let a=0;n.length=o.length=0;for(const l of t){for(const c of l)for(let h=0;h<s;h++)o[a++]=c[h];n.push(l.length)}return e}const iT=[],iC=[];function pgt(e,t,i,r,s){iT[0]=e;const[n]=epe(iC,iT,t,i,r,s);return iT.length=iC.length=0,n}function epe(e,t,i,r,s,n){if(e.length=0,!i){for(const o of t){const a=o.attributes[n];e.push(new Op(null,o.attributes,null,a))}return e}switch(i){case"esriGeometryPoint":return WDe(e,t,r,s,n);case"esriGeometryMultipoint":return YDe(e,t,r,s,n);case"esriGeometryPolyline":return QDe(e,t,r,s,n);case"esriGeometryPolygon":return KDe(e,t,r,s,n);default:vO.error("convertToFeatureSet:unknown-geometry",new q(`Unable to parse unknown geometry type '${i}'`)),e.length=0}return e}function fgt(e,t,i,r){iC[0]=e,ipe(iT,iC,t,i,r);const s=iT[0];return iT.length=iC.length=0,s}function tLe(e,t,i){if(R(e))return null;const r=new Sl;return"hasZ"in e&&t==null&&(t=e.hasZ),"hasM"in e&&i==null&&(i=e.hasM),B7(e)?_H(t!=null?t:e.z!=null,i!=null?i:e.m!=null)(r,e):r1(e)?Kde(r,e,t,i):V7(e)?Qde(r,e,vo(t,i)):z7(e)?Yde(r,e,vo(t,i)):void vO.error("convertFromGeometry:unknown-geometry",new q(`Unable to parse unknown geometry type '${e}'`))}function tpe(e,t,i,r){const s=e&&("coords"in e?e:e.geometry);if(R(s))return null;switch(t){case"esriGeometryPoint":{let n=TF;return i&&r?n=vH:i?n=gH:r&&(n=yH),n(s)}case"esriGeometryMultipoint":return Xde(s,i,r);case"esriGeometryPolyline":return Zde(s,i,r);case"esriGeometryPolygon":return Jde(s,i,r);default:return void vO.error("convertToGeometry:unknown-geometry",new q(`Unable to parse unknown geometry type '${t}'`))}}function iLe(e,t){for(const i of t)e.push({attributes:i.attributes});return e}function ipe(e,t,i,r,s){if(e.length=0,R(i))return iLe(e,t);switch(i){case"esriGeometryPoint":return qDe(e,t,r,s);case"esriGeometryMultipoint":return XDe(e,t,r,s);case"esriGeometryPolyline":return ZDe(e,t,r,s);case"esriGeometryPolygon":return JDe(e,t,r,s);default:vO.error("convertToFeatureSet:unknown-geometry",new q(`Unable to parse unknown geometry type '${i}'`))}return e}function mgt(e){const{objectIdFieldName:t,spatialReference:i,transform:r,fields:s,hasM:n,hasZ:o,features:a,geometryType:l,exceededTransferLimit:c,uniqueIdField:h,queryGeometry:p,queryGeometryType:f}=e,g={features:ipe([],a,l,o,n),fields:s,geometryType:l,objectIdFieldName:t,spatialReference:i,uniqueIdField:h,queryGeometry:tpe(p,f,!1,!1)};return r&&(g.transform=r),c&&(g.exceededTransferLimit=c),n&&(g.hasM=n),o&&(g.hasZ=o),g}function ggt(e,t){const i=new xF,{hasM:r,hasZ:s,features:n,objectIdFieldName:o,spatialReference:a,geometryType:l,exceededTransferLimit:c,transform:h,fields:p}=e;return p&&(i.fields=p),i.geometryType=l,i.objectIdFieldName=o||t,i.spatialReference=a,i.objectIdFieldName?(n&&epe(i.features,n,l,s,r,i.objectIdFieldName),c&&(i.exceededTransferLimit=c),r&&(i.hasM=r),s&&(i.hasZ=s),h&&(i.transform=h),i):(vO.error(new q("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),i)}function ygt(e){const{transform:t,features:i,hasM:r,hasZ:s}=e;if(!t)return e;for(const n of i)_(n.geometry)&&qV(n.geometry,n.geometry,r,s,t),_(n.centroid)&&qV(n.centroid,n.centroid,r,s,t);return e.transform=null,e}function vgt(e,t){const{geometryType:i,features:r,hasM:s,hasZ:n}=t;if(!e)return t;for(let o=0;o<r.length;o++){const a=r[o],l=a.weakClone();l.geometry=new Sl,IQ(l.geometry,a.geometry,s,n,i,e),a.centroid&&(l.centroid=new Sl,IQ(l.centroid,a.centroid,s,n,"esriGeometryPoint",e)),r[o]=l}return t.transform=e,t}function IQ(e,t,i,r,s,n,o=i,a=r){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),R(t)||!t.coords.length)return null;const l=jde[s],{coords:c,lengths:h}=t,p=vo(i,r),f=vo(i&&o,r&&a),g=mH(i,r,o,a);if(!h.length)return g(e.coords,c,0,0,K5(n,c[0]),eU(n,c[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=p,e;let y,v,b,w,S=0,T=0,A=T;for(const C of h){if(C<l)continue;let O=0;T=A,b=y=K5(n,c[S]),w=v=eU(n,c[S+1]),g(e.coords,c,T,S,b,w),O++,S+=p,T+=f;for(let L=1;L<C;L++,S+=p)b=K5(n,c[S]),w=eU(n,c[S+1]),b===y&&w===v||(g(e.coords,c,T,S,b-y,w-v),T+=f,O++,y=b,v=w);O>=l&&(e.lengths.push(O),A=T)}return e.coords.length=A,e.coords.length?e:null}function _gt(e,t,i,r,s,n,o=i,a=r){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!t||!t.coords.length)return null;const l=jde[s],{coords:c,lengths:h}=t,p=vo(i,r),f=vo(i&&o,r&&a),g=mH(i,r,o,a);if(!h.length)return g(e.coords,c,0,0,c[0],c[1]),e.lengths.length&&(e.lengths.length=0),e.coords.length=p,e;let y=0;const v=n*n;for(const b of h){if(b<l){y+=b*p;continue}const w=e.coords.length/f,S=y,T=y+(b-1)*p;g(e.coords,c,e.coords.length,S,c[S],c[S+1]),HV(e.coords,c,p,v,g,S,T),g(e.coords,c,e.coords.length,T,c[T],c[T+1]);const A=e.coords.length/f-w;A>=l?e.lengths.push(A):e.coords.length=w*f,y+=b*p}return e.coords.length?e:null}function rLe(e,t,i,r){const s=e[t],n=e[t+1],o=e[i],a=e[i+1],l=e[r],c=e[r+1];let h=o,p=a,f=l-h,g=c-p;if(f!==0||g!==0){const y=((s-h)*f+(n-p)*g)/(f*f+g*g);y>1?(h=l,p=c):y>0&&(h+=f*y,p+=g*y)}return f=s-h,g=n-p,f*f+g*g}function HV(e,t,i,r,s,n,o){let a,l=r,c=0;for(let h=n+i;h<o;h+=i)a=rLe(t,h,n,o),a>l&&(c=h,l=a);l>r&&(c-n>i&&HV(e,t,i,r,s,n,c),s(e,t,e.length,c,t[c],t[c+1]),o-c>i&&HV(e,t,i,r,s,c,o))}function bgt(e,t,i,r){if(R(t)||!t.coords||!t.coords.length)return null;const s=vo(i,r);let n=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;if(t&&t.coords){const c=t.coords;for(let h=0;h<c.length;h+=s){const p=c[h],f=c[h+1];n=Math.min(n,p),a=Math.max(a,p),o=Math.min(o,f),l=Math.max(l,f)}}return e[0]=n,e[1]=o,e[2]=a,e[3]=l,e}function qV(e,t,i,r,s){const{coords:n,lengths:o}=t,a=i?r?qde:rL:r?rL:Hde,l=vo(i,r);if(!n.length)return e!==t&&(e.lengths.length=0,e.coords.length=0),e;if(!o.length)return a(e.coords,n,0,0,MQ(s,n[0]),PQ(s,n[1])),e!==t&&(e.lengths.length=0,e.coords.length=l),e;const[c,h]=s.scale;let p=0;for(let f=0;f<o.length;f++){const g=o[f];e.lengths[f]=g;let y=MQ(s,n[p]),v=PQ(s,n[p+1]);a(e.coords,n,p,p,y,v),p+=l;for(let b=1;b<g;b++,p+=l)y+=n[p]*c,v-=n[p+1]*h,a(e.coords,n,p,p,y,v)}return e!==t&&(e.lengths.length=o.length,e.coords.length=n.length),e}function wgt(e,t,i,r,s,n){const o=vo(i,r),a=mH(i,r,s,n),l=t.coords;e.coords.length=0,e.lengths.length=0,e.lengths.push(...t.lengths);for(let c=0;c<l.length;c+=o)a(e.coords,l,e.coords.length,c,l[c],l[c+1]);return e}function sLe(e,t,i,r){let s=0,n=e[r*t],o=e[r*(t+1)];for(let a=1;a<i;a++){const l=n+e[r*(t+a)],c=o+e[r*(t+a)+1],h=(l-n)*(c+o);n=l,o=c,s+=h}return .5*s}function xgt(e,t){const{coords:i,lengths:r}=e;let s=0,n=0;for(let o=0;o<r.length;o++)n+=sLe(i,s,r[o],t),s+=o;return Math.abs(n)}function Tgt(e,t){if(R(e))return null;const i=e.clone(),r=e.coords,s=e.lengths;let n=0;for(let o=0;o<s.length;o++){const a=s[o];let l=r[t*n],c=r[t*n+1];for(let h=1;h<a;h++){const p=l+r[t*(n+h)],f=c+r[t*(n+h)+1];i.coords[t*(n+h)]=p,i.coords[t*(n+h)+1]=f,l=p,c=f}n+=a}return i}function nLe(e,t){return t}function bH(e,t,i,r){switch(i){case 0:return ZC(e,t+r,0);case 1:return e.originPosition==="lowerLeft"?ZC(e,t+r,1):lLe(e,t+r,1)}}function rpe(e,t,i,r){return i===2?ZC(e,t,2):bH(e,t,i,r)}function oLe(e,t,i,r){return i===2?ZC(e,t,3):bH(e,t,i,r)}function aLe(e,t,i,r){return i===3?ZC(e,t,3):rpe(e,t,i,r)}function ZC({translate:e,scale:t},i,r){return e[r]+i*t[r]}function lLe({translate:e,scale:t},i,r){return e[r]-i*t[r]}class cLe{constructor(t){this.options=t,this.geometryTypes=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"],this.previousCoordinate=[0,0],this.transform=null,this.applyTransform=nLe,this.lengths=[],this.currentLengthIndex=0,this.toAddInCurrentPath=0,this.vertexDimension=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,this._attributesConstructor=function(){}}createFeatureResult(){return{fields:[],features:[]}}finishFeatureResult(t){if(this.options.applyTransform&&(t.transform=null),this._attributesConstructor=function(){},this.coordinateBuffer=null,this.lengths.length=0,!t.hasZ)return;const i=Oj(t.geometryType,this.options.sourceSpatialReference,t.spatialReference);if(!R(i))for(const r of t.features)i(r.geometry)}createSpatialReference(){return{}}addField(t,i){t.fields.push(i);const r=t.fields.map(s=>s.name);this._attributesConstructor=function(){for(const s of r)this[s]=null}}addFeature(t,i){t.features.push(i)}prepareFeatures(t){switch(this.transform=t.transform,this.options.applyTransform&&t.transform&&(this.applyTransform=this._deriveApplyTransform(t)),this.vertexDimension=2,t.hasZ&&this.vertexDimension++,t.hasM&&this.vertexDimension++,t.geometryType){case"esriGeometryPoint":this.addCoordinate=(i,r,s)=>this.addCoordinatePoint(i,r,s),this.createGeometry=i=>this.createPointGeometry(i);break;case"esriGeometryPolygon":this.addCoordinate=(i,r,s)=>this._addCoordinatePolygon(i,r,s),this.createGeometry=i=>this._createPolygonGeometry(i);break;case"esriGeometryPolyline":this.addCoordinate=(i,r,s)=>this._addCoordinatePolyline(i,r,s),this.createGeometry=i=>this._createPolylineGeometry(i);break;case"esriGeometryMultipoint":this.addCoordinate=(i,r,s)=>this._addCoordinateMultipoint(i,r,s),this.createGeometry=i=>this._createMultipointGeometry(i);break;default:t.geometryType}}createFeature(){return this.lengths.length=0,this.currentLengthIndex=0,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,{attributes:new this._attributesConstructor}}allocateCoordinates(){}addLength(t,i,r){this.lengths.length===0&&(this.toAddInCurrentPath=i),this.lengths.push(i)}addQueryGeometry(t,i){const{queryGeometry:r,queryGeometryType:s}=i,n=qV(r.clone(),r,!1,!1,this.transform),o=tpe(n,s,!1,!1);t.queryGeometryType=s,t.queryGeometry=I({},o)}createPointGeometry(t){const i={x:0,y:0,spatialReference:t.spatialReference};return t.hasZ&&(i.z=0),t.hasM&&(i.m=0),i}addCoordinatePoint(t,i,r){switch(i=this.applyTransform(this.transform,i,r,0),r){case 0:t.x=i;break;case 1:t.y=i;break;case 2:"z"in t?t.z=i:t.m=i;break;case 3:t.m=i}}_transformPathLikeValue(t,i){let r=0;return i<=1&&(r=this.previousCoordinate[i],this.previousCoordinate[i]+=t),this.applyTransform(this.transform,t,i,r)}_addCoordinatePolyline(t,i,r){this._dehydratedAddPointsCoordinate(t.paths,i,r)}_addCoordinatePolygon(t,i,r){this._dehydratedAddPointsCoordinate(t.rings,i,r)}_addCoordinateMultipoint(t,i,r){r===0&&t.points.push([]);const s=this._transformPathLikeValue(i,r);t.points[t.points.length-1].push(s)}_createPolygonGeometry(t){return{rings:[[]],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}_createPolylineGeometry(t){return{paths:[[]],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}_createMultipointGeometry(t){return{points:[],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}_dehydratedAddPointsCoordinate(t,i,r){r===0&&this.toAddInCurrentPath--==0&&(t.push([]),this.toAddInCurrentPath=this.lengths[++this.currentLengthIndex]-1,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0);const s=this._transformPathLikeValue(i,r),n=t[t.length-1];r===0&&(this.coordinateBufferPtr=0,this.coordinateBuffer=new Array(this.vertexDimension),n.push(this.coordinateBuffer)),this.coordinateBuffer[this.coordinateBufferPtr++]=s}_deriveApplyTransform(t){const{hasZ:i,hasM:r}=t;return i&&r?aLe:i?rpe:r?oLe:bH}}async function uLe(e,t,i){const r=Oc(e),s=I({},i),n=va.from(t),o=!n.quantizationParameters,{data:a}=await Ude(r,n,new cLe({sourceSpatialReference:n.sourceSpatialReference,applyTransform:o}),s);return a}function hLe(e,t){const i=e.toJSON();return i.objectIds&&(i.objectIds=i.objectIds.join(",")),i.orderByFields&&(i.orderByFields=i.orderByFields.join(",")),!i.outFields||t!=null&&t.returnCountOnly?delete i.outFields:i.outFields.indexOf("*")!==-1?i.outFields="*":i.outFields=i.outFields.join(","),i.outSpatialReference&&(i.outSR=i.outSR.wkid||JSON.stringify(i.outSR.toJSON()),delete i.outSpatialReference),i.dynamicDataSource&&(i.layer=JSON.stringify({source:i.dynamicDataSource}),delete i.dynamicDataSource),i}async function dLe(e,t,i){const r=await spe(e,t,i),s=r.data,n=s.geometryType,o=s.spatialReference,a={};for(const l of s.relatedRecordGroups){const c={fields:void 0,objectIdFieldName:void 0,geometryType:n,spatialReference:o,hasZ:!!s.hasZ,hasM:!!s.hasM,features:l.relatedRecords};if(l.objectId!=null)a[l.objectId]=c;else for(const h in l)l.hasOwnProperty(h)&&h!=="relatedRecords"&&(a[l[h]]=c)}return me(I({},r),{data:a})}async function pLe(e,t,i){const r=await spe(e,t,i,{returnCountOnly:!0}),s=r.data,n={};for(const o of s.relatedRecordGroups)o.objectId!=null&&(n[o.objectId]=o.count);return me(I({},r),{data:n})}async function spe(e,t,i={},r){const s=yO(I(I(me(I({},e.query),{f:"json"}),r),hLe(t,r)));return Ti(e.path+"/queryRelatedRecords",me(I({},i),{query:I(I({},i.query),s)}))}async function fLe(e,t,i){t=L1.from(t);const r=Oc(e);return dLe(r,t,i).then(s=>{const n=s.data,o={};return Object.keys(n).forEach(a=>o[a]=mb.fromJSON(n[a])),o})}async function mLe(e,t,i){t=L1.from(t);const r=Oc(e);return pLe(r,t,I({},i)).then(s=>s.data)}const $Q="Layer does not support extent calculation.";function gLe(e,t){var i,r;const s=e.geometry,n=e.toJSON(),o=n;if(_(s)&&(o.geometry=JSON.stringify(s),o.geometryType=F0(s),o.inSR=s.spatialReference.wkid||JSON.stringify(s.spatialReference)),(i=n.topFilter)!=null&&i.groupByFields&&(o.topFilter.groupByFields=n.topFilter.groupByFields.join(",")),(r=n.topFilter)!=null&&r.orderByFields&&(o.topFilter.orderByFields=n.topFilter.orderByFields.join(",")),n.topFilter&&(o.topFilter=JSON.stringify(o.topFilter)),n.objectIds&&(o.objectIds=n.objectIds.join(",")),n.orderByFields&&(o.orderByFields=n.orderByFields.join(",")),n.outFields&&!(t!=null&&t.returnCountOnly||t!=null&&t.returnExtentOnly||t!=null&&t.returnIdsOnly)?n.outFields.indexOf("*")!==-1?o.outFields="*":o.outFields=n.outFields.join(","):delete o.outFields,n.outSR?o.outSR=n.outSR.wkid||JSON.stringify(n.outSR):s&&n.returnGeometry&&(o.outSR=o.inSR),n.returnGeometry&&delete n.returnGeometry,n.timeExtent){const a=n.timeExtent,{start:l,end:c}=a;l==null&&c==null||(o.time=l===c?l:`${l==null?"null":l},${c==null?"null":c}`),delete n.timeExtent}return o}async function yLe(e,t,i,r){const s=await SF(e,t,"json",r);return iL(t,i,s.data),s}async function vLe(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):SF(e,t,"json",i,{returnIdsOnly:!0})}async function _Le(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):SF(e,t,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}).then(r=>{const s=r.data;if(s.hasOwnProperty("extent"))return r;if(s.features)throw new Error($Q);if(s.hasOwnProperty("count"))throw new Error($Q);return r})}function bLe(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):SF(e,t,"json",i,{returnIdsOnly:!0,returnCountOnly:!0})}function SF(e,t,i,r={},s={}){const n=typeof e=="string"?Ts(e):e,o=t.geometry?[t.geometry]:[];return r.responseType=i==="pbf"?"array-buffer":"json",fH(o,null,r).then(a=>{const l=a&&a[0];_(l)&&((t=t.clone()).geometry=l);const c=yO(I(I(me(I({},n.query),{f:i}),s),gLe(t,s)));return Ti(bl(n.path,"queryTopFeatures"),me(I({},r),{query:I(I({},c),r.query)}))})}var WV;let Lw=WV=class extends fe{constructor(e){super(e),this.groupByFields=void 0,this.topCount=void 0,this.orderByFields=void 0}clone(){return new WV({groupByFields:this.groupByFields,topCount:this.topCount,orderByFields:this.orderByFields})}};u([d({type:[String],json:{write:!0}})],Lw.prototype,"groupByFields",void 0),u([d({type:Number,json:{write:!0}})],Lw.prototype,"topCount",void 0),u([d({type:[String],json:{write:!0}})],Lw.prototype,"orderByFields",void 0),Lw=WV=u([P("esri.rest.support.TopFilter")],Lw);const wLe=Lw;var XV;const DQ=new si({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),LQ=new si({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let Sr=XV=class extends fe{constructor(e){super(e),this.cacheHint=void 0,this.distance=void 0,this.geometry=null,this.geometryPrecision=void 0,this.maxAllowableOffset=void 0,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.resultType=null,this.returnGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.start=void 0,this.spatialRelationship="intersects",this.timeExtent=null,this.topFilter=void 0,this.units=null,this.where="1=1"}writeStart(e,t){t.resultOffset=this.start,t.resultRecordCount=this.num||10}clone(){return new XV(se({cacheHint:this.cacheHint,distance:this.distance,geometry:this.geometry,geometryPrecision:this.geometryPrecision,maxAllowableOffset:this.maxAllowableOffset,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,resultType:this.resultType,returnGeometry:this.returnGeometry,returnZ:this.returnZ,returnM:this.returnM,start:this.start,spatialRelationship:this.spatialRelationship,timeExtent:this.timeExtent,topFilter:this.topFilter,units:this.units,where:this.where}))}};u([d({type:Boolean,json:{write:!0}})],Sr.prototype,"cacheHint",void 0),u([d({type:Number,json:{write:{overridePolicy:e=>({enabled:e>0})}}})],Sr.prototype,"distance",void 0),u([d({types:ob,json:{read:bp,write:!0}})],Sr.prototype,"geometry",void 0),u([d({type:Number,json:{write:!0}})],Sr.prototype,"geometryPrecision",void 0),u([d({type:Number,json:{write:!0}})],Sr.prototype,"maxAllowableOffset",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],Sr.prototype,"num",void 0),u([d({json:{write:!0}})],Sr.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],Sr.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],Sr.prototype,"outFields",void 0),u([d({type:He,json:{read:{source:"outSR"},write:{target:"outSR"}}})],Sr.prototype,"outSpatialReference",void 0),u([d({type:String,json:{write:!0}})],Sr.prototype,"resultType",void 0),u([d({json:{write:!0}})],Sr.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],Sr.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],Sr.prototype,"returnZ",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],Sr.prototype,"start",void 0),u([Fe("start"),Fe("num")],Sr.prototype,"writeStart",null),u([d({type:String,json:{read:{source:"spatialRel",reader:DQ.read},write:{target:"spatialRel",writer:DQ.write}}})],Sr.prototype,"spatialRelationship",void 0),u([d({type:zp,json:{write:!0}})],Sr.prototype,"timeExtent",void 0),u([d({type:wLe,json:{write:!0}})],Sr.prototype,"topFilter",void 0),u([d({type:String,json:{read:LQ.read,write:{writer:LQ.write,overridePolicy(e){return{enabled:e&&this.distance>0}}}}})],Sr.prototype,"units",void 0),u([d({type:String,json:{write:!0}})],Sr.prototype,"where",void 0),Sr=XV=u([P("esri.rest.support.TopFeaturesQuery")],Sr),Sr.from=Ir(Sr);const Xy=Sr;async function xLe(e,t,i,r){const s=Oc(e),n=I({},r),{data:o}=await yLe(s,Xy.from(t),i,n);return mb.fromJSON(o)}async function TLe(e,t,i){const r=Oc(e);return(await vLe(r,Xy.from(t),I({},i))).data.objectIds}async function SLe(e,t,i){const r=Oc(e),s=await _Le(r,Xy.from(t),I({},i));return{count:s.data.count,extent:Xt.fromJSON(s.data.extent)}}async function ELe(e,t,i){const r=Oc(e);return(await bLe(r,Xy.from(t),I({},i))).data.count}let Nw=class extends we{constructor(...e){super(...e),this.requestOptions=null,this.url=null}normalizeCtorArgs(e,t){return typeof e!="string"?e:I({url:e},t)}get parsedUrl(){return this._parseUrl(this.url)}_parseUrl(e){return e?Ts(e):null}_encode(e,t,i){const r={};for(const s in e){if(s==="declaredClass")continue;const n=e[s];if(n!=null&&typeof n!="function")if(Array.isArray(n)){r[s]=[];for(let o=0;o<n.length;o++)r[s][o]=this._encode(n[o])}else if(typeof n=="object")if(n.toJSON){const o=n.toJSON(i&&i[s]);r[s]=t?o:JSON.stringify(o)}else r[s]=t?n:JSON.stringify(n);else r[s]=n}return r}};u([d({readOnly:!0})],Nw.prototype,"parsedUrl",null),u([d()],Nw.prototype,"requestOptions",void 0),u([d({type:String})],Nw.prototype,"url",void 0),Nw=u([P("esri.tasks.Task")],Nw);const ALe=Nw;let Ef=class extends ALe{constructor(e){super(e),this.dynamicDataSource=null,this.fieldsIndex=null,this.format="json",this.gdbVersion=null,this.infoFor3D=null,this.sourceSpatialReference=null}execute(e,t){return this.executeJSON(e,t).then(i=>this.featureSetFromJSON(e,i,t))}async executeJSON(e,t){var i;const r=I(I({},this.requestOptions),t),s=this._normalizeQuery(e),n=((i=e.outStatistics)==null?void 0:i[0])!=null,o=ue("featurelayer-pbf-statistics"),a=!n||o;let l;if(this.format==="pbf"&&a)try{l=await uLe(this.url,s,r)}catch(c){if(c.name!=="query:parsing-pbf")throw c;this.format="json"}return this.format!=="json"&&a||(l=await Gde(this.url,s,r)),this._normalizeFields(l.fields),l}async featureSetFromJSON(e,t,i){if(!(this._queryIs3DObjectFormat(e)&&_(this.infoFor3D)&&t.features&&t.features.length))return mb.fromJSON(t);const{meshFeatureSetFromJSON:r}=await zoe(import("./meshFeatureSet.322d6940.js"),i);return r(e,this.infoFor3D,t)}executeForCount(e,t){const i=I(I({},this.requestOptions),t),r=this._normalizeQuery(e);return kDe(this.url,r,i)}executeForExtent(e,t){const i=I(I({},this.requestOptions),t),r=this._normalizeQuery(e);return zDe(this.url,r,i)}executeForIds(e,t){const i=I(I({},this.requestOptions),t),r=this._normalizeQuery(e);return BDe(this.url,r,i)}executeRelationshipQuery(e,t){e=L1.from(e);const i=I(I({},this.requestOptions),t);return(this.gdbVersion||this.dynamicDataSource)&&((e=e.clone()).gdbVersion=e.gdbVersion||this.gdbVersion,e.dynamicDataSource=e.dynamicDataSource||this.dynamicDataSource),fLe(this.url,e,i)}executeRelationshipQueryForCount(e,t){e=L1.from(e);const i=I(I({},this.requestOptions),t);return(this.gdbVersion||this.dynamicDataSource)&&((e=e.clone()).gdbVersion=e.gdbVersion||this.gdbVersion,e.dynamicDataSource=e.dynamicDataSource||this.dynamicDataSource),mLe(this.url,e,i)}executeAttachmentQuery(e,t){const i=I(I({},this.requestOptions),t);return lDe(this.url,e,i)}executeTopFeaturesQuery(e,t){const i=I(I({},this.requestOptions),t);return xLe(this.parsedUrl,e,this.sourceSpatialReference,i)}executeForTopIds(e,t){const i=I(I({},this.requestOptions),t);return TLe(this.parsedUrl,e,i)}executeForTopExtents(e,t){const i=I(I({},this.requestOptions),t);return SLe(this.parsedUrl,e,i)}executeForTopCount(e,t){const i=I(I({},this.requestOptions),t);return ELe(this.parsedUrl,e,i)}_normalizeQuery(e){let t=va.from(e);if(t.sourceSpatialReference=t.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(t=t===e?t.clone():t,t.gdbVersion=e.gdbVersion||this.gdbVersion,t.dynamicDataSource=e.dynamicDataSource?ec.from(e.dynamicDataSource):this.dynamicDataSource),_(this.infoFor3D)&&this._queryIs3DObjectFormat(e)){t=t===e?t.clone():t,t.formatOf3DObjects=null;for(const i of this.infoFor3D.queryFormats){if(i.id==="3D_glb"){t.formatOf3DObjects=i.id;break}i.id!=="3D_gltf"||t.formatOf3DObjects||(t.formatOf3DObjects=i.id)}if(!t.formatOf3DObjects)throw new q("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(R(t.outFields)||!t.outFields.includes("*")){t=t===e?t.clone():t,R(t.outFields)&&(t.outFields=[]);const{originX:i,originY:r,originZ:s,translationX:n,translationY:o,translationZ:a,scaleX:l,scaleY:c,scaleZ:h,rotationX:p,rotationY:f,rotationZ:g,rotationDeg:y}=this.infoFor3D.transformFieldRoles;t.outFields.push(i,r,s,n,o,a,l,c,h,p,f,g,y)}}return t}_normalizeFields(e){if(_(this.fieldsIndex)&&_(e))for(const t of e){const i=this.fieldsIndex.get(t.name);i&&Object.assign(t,i.toJSON())}}_queryIs3DObjectFormat(e){return _(this.infoFor3D)&&e.returnGeometry&&e.multipatchOption!=="xyFootprint"&&!e.outStatistics}};u([d({type:ec})],Ef.prototype,"dynamicDataSource",void 0),u([d()],Ef.prototype,"fieldsIndex",void 0),u([d()],Ef.prototype,"format",void 0),u([d()],Ef.prototype,"gdbVersion",void 0),u([d()],Ef.prototype,"infoFor3D",void 0),u([d()],Ef.prototype,"sourceSpatialReference",void 0),Ef=u([P("esri.tasks.QueryTask")],Ef);const CLe=Ef,RLe="esri.widgets.Feature.support.relatedFeatureUtils",NQ=he.getLogger(RLe),FQ=new Map;function JE(e){if(!am(e))return null;const[t,i]=e.split("/").slice(1);return{layerId:t,fieldName:i}}function OLe(e,t){if(!t.relationships)return null;let i=null;const{relationships:r}=t;return r.some(s=>s.id===parseInt(e,10)&&(i=s,!0)),i}function MLe({originRelationship:e,relationships:t,layerId:i}){let r;return t&&t.some(s=>(`${s.relatedTableId}`===i&&s.id===e.id&&(r=s),!!r)),r}function PLe(e,t){const i=t.toLowerCase();for(const r in e)if(r.toLowerCase()===i)return e[r];return null}function ILe(e,t){const i=OLe(e,t);if(!i)return;const r=`${t.url}/${i.relatedTableId}`;return{url:r,queryTask:new CLe({url:r,sourceSpatialReference:t.spatialReference}),relation:i,relatedFields:[],outStatistics:[]}}function $Le(e,t){if(!t||!e)return;const{features:i,statsFeatures:r}=e,s=i&&i.value;t.relatedFeatures=s?s.features:[];const n=r&&r.value;t.relatedStatsFeatures=n?n.features:[]}function DLe(e,t,i,r){const s=new L1;return s.outFields=["*"],s.relationshipId=typeof t.id=="number"?t.id:parseInt(t.id,10),s.objectIds=[e.attributes[i.objectIdField]],i.queryRelatedFeatures(s,r)}function LLe(e,t,i){let r=0;const s=[];for(;r<t.length;)s.push(`${e} IN (${t.slice(r,i+r)})`),r+=i;return s.join(" OR ")}async function NLe(e,t,i,r){const s=i.layerId.toString(),{layerInfo:n,queryTask:o,relation:a,relatedFields:l,outStatistics:c}=t,h=MLe({originRelationship:a,relationships:n.relationships,layerId:s});if(h.relationshipTableId&&h.keyFieldInRelationshipTable){const f=(await DLe(e,h,i,r))[e.attributes[i.objectIdField]];if(!f)return null;const g=f.features.map(y=>y.attributes[n.objectIdField]);if((c==null?void 0:c.length)>0&&n.supportsStatistics){const y=new va;y.where=LLe(n.objectIdField,g,1e3),y.outFields=l,y.outStatistics=c;const v={features:Promise.resolve(f),statsFeatures:o.execute(y)};return Ks(v)}}const p=h==null?void 0:h.keyField;if(p){const f=DN(BLe(n.fields,p)),g=PLe(e.attributes,a.keyField),y=f?`${p}=${g}`:`${p}='${g}'`,v=o.execute(new va({where:y,outFields:t.relatedFields}),r),b=t.outStatistics&&t.outStatistics.length>0&&n.supportsStatistics?o.execute(new va({where:y,outFields:t.relatedFields,outStatistics:t.outStatistics}),r):null,w={features:v};return b&&(w.statsFeatures=b),Ks(w)}return null}function FLe(e,t){return Ti(e,{query:{f:"json"},signal:t&&t.signal})}function ULe({relatedInfos:e,layer:t},i){const r={};return e.forEach((s,n)=>{const{relation:o}=s;if(!o){const p=new q("relation-required","A relation is required on a layer to retrieve related records.");throw NQ.error(p),p}const{relatedTableId:a}=o;if(typeof a!="number"){const p=new q("A related table ID is required on a layer to retrieve related records.");throw NQ.error(p),p}const l=`${t.url}/${a}`,c=FQ.get(l),h=c||FLe(l,i);c||FQ.set(l,h),r[n]=h}),Ks(r)}function kLe({graphic:e,relatedInfos:t,layer:i},r){const s={};return t.forEach((n,o)=>{n.layerInfo&&(s[o]=NLe(e,n,i,r))}),Ks(s)}function zLe({relatedInfo:e,fieldName:t,fieldInfo:i}){if(e.relatedFields.push(t),i.statisticType){const r=new Pde({statisticType:i.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics.push(r)}}function BLe(e,t){if(e!=null){t=t.toLowerCase();for(const i of e)if(i&&i.name.toLowerCase()===t)return i}return null}const UQ={chartAnimation:!0};let ln=class extends we{constructor(e){super(e),this.abilities=I({},UQ),this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(e){return I(I({},UQ),e)}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(e){this._setContentElementMedia(e)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(e){const{formattedMediaInfoCount:t}=this,i=(e+t)%t;this.activeMediaInfoIndex=i}_pageContentElementMedia(e){const{activeMediaInfoIndex:t}=this,i=t+e;this._setContentElementMedia(i)}_formatMediaInfos(){const{attributes:e,mediaInfos:t,formattedAttributes:i,expressionAttributes:r,fieldInfoMap:s,layer:n}=this;return t==null?void 0:t.map(o=>{const a=o==null?void 0:o.clone();if(!a)return null;if(a.title=q_({attributes:e,fieldInfoMap:s,globalAttributes:i,expressionAttributes:r,layer:n,text:a.title}),a.caption=q_({attributes:e,fieldInfoMap:s,globalAttributes:i,expressionAttributes:r,layer:n,text:a.caption}),a.altText=q_({attributes:e,fieldInfoMap:s,globalAttributes:i,expressionAttributes:r,layer:n,text:a.altText}),a.type==="image"){const{value:l}=a;return this._setImageValue({value:l,formattedAttributes:i,layer:n}),a.value.sourceURL?a:void 0}if(a.type==="pie-chart"||a.type==="line-chart"||a.type==="column-chart"||a.type==="bar-chart"){const{value:l}=a;return this._setChartValue({value:l,chartType:a.type,attributes:e,formattedAttributes:i,layer:n}),a}return null}).filter(Boolean)}_setImageValue(e){const{fieldInfoMap:t}=this,{value:i,formattedAttributes:r,layer:s}=e,{linkURL:n,sourceURL:o}=i;if(o){const a=CV(o,s);i.sourceURL=AV({formattedAttributes:r,template:a,fieldInfoMap:t})}if(n){const a=CV(n,s);i.linkURL=AV({formattedAttributes:r,template:a,fieldInfoMap:t})}}_setChartValue(e){const{value:t,attributes:i,formattedAttributes:r,chartType:s,layer:n}=e,{popupTemplate:o,relatedInfos:a}=this,{fields:l,normalizeField:c}=t;if(t.fields=o$e(l,n),c&&(t.normalizeField=eL(c,n)),!l.some(p=>!!(r[p]!=null||am(p)&&a.size)))return;const h=o==null?void 0:o.fieldInfos;l.forEach(p=>{if(am(p))return void(t.series=[...t.series,...this._getRelatedChartInfos({fieldInfos:h,fieldName:p,formattedAttributes:r,chartType:s,value:t})]);const f=this._getChartOption({value:t,attributes:i,chartType:s,formattedAttributes:r,fieldName:p,fieldInfos:h});t.series.push(f)})}_getRelatedChartInfos(e){var t;const{fieldInfos:i,fieldName:r,formattedAttributes:s,chartType:n,value:o}=e,a=[],l=JE(r),{layerId:c,fieldName:h}=l,p=(t=this.relatedInfos)==null?void 0:t.get(c.toString());if(!p)return a;const{relatedFeatures:f,relation:g}=p;if(!g||!f)return a;const{cardinality:y}=g;return f.forEach(v=>{const{attributes:b}=v;b&&Object.keys(b).forEach(w=>{w===h&&a.push(this._getChartOption({value:o,attributes:b,formattedAttributes:s,fieldName:r,chartType:n,relatedFieldName:w,fieldInfos:i}))})}),y==="one-to-many"||y==="many-to-many"?a:[a[0]]}_getTooltip({label:e,value:t,chartType:i}){return i==="pie-chart"?e:`${e}: ${t}`}_getChartOption(e){var t;const{value:i,attributes:r,formattedAttributes:s,fieldName:n,relatedFieldName:o,fieldInfos:a,chartType:l}=e,{layer:c}=this,{normalizeField:h,tooltipField:p}=i,f=h?am(h)?r[JE(h).fieldName]:r[h]:null,g=o&&r[o]!==void 0?r[o]:r[n]!==void 0?r[n]:s[n],y=g===void 0?null:g&&f?g/f:g,v=new dle({value:y});if(am(n)){const A=JE(n),C=JE(p),O=C?C.fieldName:null,L=bde(y,{fieldInfos:a,fieldName:o,layer:c,preventPlacesFormatting:!!f}),U=A?A.label||A.fieldName:o,N=O&&r[O]!==void 0?r[O]:U;return v.tooltip=this._getTooltip({label:N,value:L,chartType:l}),v}const b=wde(a,n),w=eL(n,c),S=p&&s[p]!==void 0?s[p]:vde(b||new cO({fieldName:w}),(t=this.popupTemplate)==null?void 0:t.expressionInfos),T=s[w];return v.tooltip=this._getTooltip({label:S,value:T,chartType:l}),v}};u([d()],ln.prototype,"abilities",void 0),u([At("abilities")],ln.prototype,"castAbilities",null),u([d()],ln.prototype,"activeMediaInfoIndex",void 0),u([d({readOnly:!0})],ln.prototype,"activeMediaInfo",null),u([d()],ln.prototype,"attributes",void 0),u([d()],ln.prototype,"description",void 0),u([d()],ln.prototype,"fieldInfoMap",void 0),u([d()],ln.prototype,"formattedAttributes",void 0),u([d()],ln.prototype,"expressionAttributes",void 0),u([d({readOnly:!0})],ln.prototype,"formattedMediaInfos",null),u([d()],ln.prototype,"layer",void 0),u([d({readOnly:!0})],ln.prototype,"formattedMediaInfoCount",null),u([d()],ln.prototype,"mediaInfos",void 0),u([d()],ln.prototype,"popupTemplate",void 0),u([d()],ln.prototype,"relatedInfos",void 0),u([d()],ln.prototype,"title",void 0),ln=u([P("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],ln);const X_=ln;var kQ=["#ffffff","#858585","#ffbebe","#ffebbe","#ffebaf","#ffffbe","#e9ffbe","#d3ffbe","#beffe8","#bee8ff","#bed2ff","#e8beff","#ffbee8","#ebebeb","#707070","#ff7f7f","#ffa77f","#ffd37f","#ffff73","#d1ff73","#a3ff73","#73ffdf","#73dfff","#73b2ff","#df73ff","#ff73df","#d6d6d6","#5c5c5c","#ff0000","#ff5500","#ffaa00","#ffff00","#aaff00","#55ff00","#00ffc5","#00c5ff","#0070ff","#c500ff","#ff00c5","#c2c2c2","#474747","#e60000","#e64c00","#e69800","#e6e600","#98e600","#4ce600","#00e6a9","#00a9e6","#005ce6","#a900e6","#e600a9","#adadad","#242424","#a80000","#a83800","#a87000","#a8a800","#70a800","#38a800","#00a884","#0084a8","#004da8","#8400a8","#a80084","#999999","#1a1a1a","#730000","#732600","#734c00","#737300","#4c7300","#267300","#00734c","#004c73","#002673","#4c0073","#73004"],VLe=[].concat(kQ.slice(30,39),kQ.slice(28,30).reverse()),GLe=[{name:"default",colors:VLe},{name:"cat-dark",colors:["#ed5151","#149ece","#a7c636","#9e559c","#fc921f","#ffde3e","#f789d8","#b7814a","#3caf99","#6b6bd6","#b54779","#7f7f7f"]},{name:"tropical-bliss",colors:["#fce138","#ff9399","#fcd27e","#f1983c","#a553b7","#b1a9d0","#6ecffc","#4c81cd","#fc6f84","#fc3e5a","#6af689","#48885c"]},{name:"desert-blooms",colors:["#102432","#144d59","#ffc730","#ed9310","#a64f1b","#661510","#d9351a","#b31515","#4a0932","#8c213f","#18382e","#2c6954"]},{name:"under-the-sea",colors:["#bf9727","#607100","#00734c","#704489","#01acca","#024e76","#f09100","#ea311f","#c6004b","#7570b3","#666666","#333333"]},{name:"vibrant-rainbow",colors:["#fffb00","#f5cb11","#9fd40c","#46e39c","#32b8a6","#7ff2fa","#ac08cc","#dd33ff","#eb7200","#e8a784","#bf2e2e","#6c7000"]},{name:"ocean-bay",colors:["#191921","#11495c","#78b1c2","#454f4b","#8f8f82","#9be0c0","#87b051","#f7ec88","#ebdcc1","#dbb658","#c43541","#75351e"]},{name:"prairie-summer",colors:["#332424","#751555","#d47013","#d68989","#211173","#82aad6","#7bfaeb","#6ec9a8","#6b6408","#eada40","#ccc54a","#1fc235"]},{name:"pastel-chalk",colors:["#fffd99","#f5e6a4","#c1d48c","#b8e3d0","#a0b8b5","#cbf7fa","#d791f2","#dfc1eb","#f2b983","#e8c4b2","#bf8e8e","#94995c"]},{name:"seq-yellow-orange-red-bright",colors:["#910000","#b1260b","#c0370f","#e05919","#ef6a1d","#ff7b22","#ffa143","#ffb454","#ffda74","#ffed85"]},{name:"seq-reds-bright",colors:["#57453b","#7b4238","#9f4036","#c23d33","#d7483c","#ec5244","#f3696c","#f9816c","#ffc4ae","#fff0dc"]},{name:"seq-purples-bright",colors:["#4e465c","#5a4a78","#695291","#775baa","#8663c3","#946bdc","#aa89e8","#c1a6f3","#d7c4ff","#e6e1ff"]},{name:"seq-blues-bright",colors:["#404d54","#435c6c","#48799d","#4b88b6","#4d96ce","#50a5e7","#74bbed","#98d0f3","#bce6f9","#e6faff"]},{name:"seq-greens-bright",colors:["#39544c","#386757","#368165","#359b73","#33b581","#4bc392","#64d2a2","#7ce0b3","#cbf6d9","#f4ffea"]},{name:"seq-browns-bright",colors:["#524834","#715b38","#8f6e3c","#ae8140","#cc9444","#eba748","#eeb664","#f0c47f","#f9e0b7","#fff8eb"]}];const zQ="en-us",wH=new Map([["ar",()=>import("./ar.593f6838.js").then(e=>e.a)],["bg-bg",()=>import("./bg_BG.5b5fcc71.js").then(e=>e.b)],["bs-ba",()=>import("./bs_BA.40366753.js").then(e=>e.b)],["ca-es",()=>import("./ca_ES.ec537f99.js").then(e=>e.c)],["cs-cz",()=>import("./cs_CZ.4e2bef95.js").then(e=>e.c)],["da-dk",()=>import("./da_DK.80e7e516.js").then(e=>e.d)],["de-de",()=>import("./de_DE.15902e03.js").then(e=>e.d)],["de-ch",()=>import("./de_CH.17df406d.js").then(e=>e.d)],["el-gr",()=>import("./el_GR.c53bacf5.js").then(e=>e.e)],["en-us",()=>import("./en_US.47af2ad1.js").then(e=>e.e)],["en-ca",()=>import("./en_CA.a4100e50.js").then(e=>e.e)],["es-es",()=>import("./es_ES.447b64d4.js").then(e=>e.e)],["et-ee",()=>import("./et_EE.62d26aa0.js").then(e=>e.e)],["fi-fi",()=>import("./fi_FI.536f0283.js").then(e=>e.f)],["fr-fr",()=>import("./fr_FR.e6adefe2.js").then(e=>e.f)],["he-il",()=>import("./he_IL.d6cb72de.js").then(e=>e.h)],["hr-hr",()=>import("./hr_HR.f20fe601.js").then(e=>e.h)],["hu-hu",()=>import("./hu_HU.5988d2a6.js").then(e=>e.h)],["id-id",()=>import("./id_ID.6f407b80.js").then(e=>e.i)],["it-it",()=>import("./it_IT.44a0dd3b.js").then(e=>e.i)],["ja-jp",()=>import("./ja_JP.49e79e89.js").then(e=>e.j)],["ko-kr",()=>import("./ko_KR.76772075.js").then(e=>e.k)],["lt-lt",()=>import("./lt_LT.54d4ae0e.js").then(e=>e.l)],["lv-lv",()=>import("./lv_LV.157c3478.js").then(e=>e.l)],["nb-no",()=>import("./nb_NO.cce4c4b9.js").then(e=>e.n)],["nl-nl",()=>import("./nl_NL.a1b33f89.js").then(e=>e.n)],["pl-pl",()=>import("./pl_PL.1e55dde1.js").then(e=>e.p)],["pt-br",()=>import("./pt_BR.d1ce787b.js").then(e=>e.p)],["pt-pt",()=>import("./pt_PT.792d171b.js").then(e=>e.p)],["ro-ro",()=>import("./ro_RO.53014442.js").then(e=>e.r)],["ru-ru",()=>import("./ru_RU.9918a089.js").then(e=>e.r)],["sk-sk",()=>import("./sk_SK.3dd23762.js").then(e=>e.s)],["sl-sl",()=>import("./sl_SL.1eb25087.js").then(e=>e.s)],["sr-rs",()=>import("./sr_RS.6f05981a.js").then(e=>e.s)],["sv-se",()=>import("./sv_SE.19714d39.js").then(e=>e.s)],["th-th",()=>import("./th_TH.03cabbb0.js").then(e=>e.t)],["tr-tr",()=>import("./tr_TR.36b82d26.js").then(e=>e.t)],["uk-ua",()=>import("./uk_UA.9fdeb0ed.js").then(e=>e.u)],["vi-vn",()=>import("./vi_VN.a1658f55.js").then(e=>e.v)],["zh-cn",()=>import("./zh_Hans.55f90f13.js").then(e=>e.z)],["zh-hk",()=>import("./zh_Hant.8eae5737.js").then(e=>e.z)],["zh-tw",()=>import("./zh_Hant.8eae5737.js").then(e=>e.z)]]);function jLe(e){const t=e.split("-")[0].toLowerCase();let i=null;for(const r of wH.keys())if(r.startsWith(t)){i=r;break}return i}function HLe(e){return e?wH.has(e.toLowerCase())?e.toLowerCase():jLe(e)||zQ:zQ}let Rb,S2;async function qLe(e=dc()){if(e=HLe(e),Rb&&e===S2)return Rb;Rb=import("./index.627a3a3d.js").then(t=>t.i),S2=e;try{const[t,i]=await Promise.all([Rb,wH.get(S2)()]);S2===e&&(t.am4core.options.defaultLocale=i.default),t.am4core.options.suppressWarnings=!0,t.am4core.options.autoDispose=!0}catch{return Rb=null,S2=null,null}return Rb}function WLe(e,t="default"){const i=GLe.find(r=>r.name===t);return i?i.colors.map(r=>e.color(r)):null}const Qr={base:"esri-feature-media",mediaContainer:"esri-feature-media__container",mediaItemContainer:"esri-feature-media__item-container",mediaItem:"esri-feature-media__item",mediaItemTitle:"esri-feature-media__item-title",mediaItemCaption:"esri-feature-media__item-caption",mediaPrevious:"esri-feature-media__previous",mediaPreviousIconLTR:"esri-feature-media__previous-icon",mediaPreviousIconRTL:"esri-feature-media__previous-icon--rtl",mediaNext:"esri-feature-media__next",mediaNextIconLTR:"esri-feature-media__next-icon",mediaNextIconRTL:"esri-feature-media__next-icon--rtl",mediaChart:"esri-feature-media__chart",mediaButton:"esri-feature-media__button",mediaIcon:"esri-feature-media__icon",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow"},tU=.05,iU=.95,rU=15;let Va=class extends Ia{constructor(e,t){super(e,t),this._refreshTimer=null,this._refreshIntervalInfo=null,this._featureElementInfo=null,this.attributes=null,this.activeMediaInfoIndex=null,this.description=null,this.fieldInfoMap=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null,this.viewModel=new X_,this.messages=null,this._getChartDependencies=async i=>{const r=await qLe(),{destroyed:s,viewModel:n}=this;if(s||!n||!i)return;const{activeMediaInfo:o}=n;this._renderChart({chartDiv:i,mediaInfo:o,chartsModule:r})}}initialize(){this._featureElementInfo=new hH,this.own(Wt(this,["viewModel.activeMediaInfo","viewModel.activeMediaInfoIndex"],()=>this._setupMediaRefreshTimer()),Wt(this,["viewModel.description","viewModel.title"],()=>this._setupFeatureElementInfo()))}destroy(){this._clearMediaRefreshTimer(),this._featureElementInfo.destroy()}render(){var e;return le("div",{bind:this,class:Qr.base,onkeyup:this._handleMediaKeyup},(e=this._featureElementInfo)==null?void 0:e.render(),this.renderMedia())}renderMedia(){const{formattedMediaInfoCount:e}=this.viewModel;return e?le("div",{key:"media-element-container",class:Qr.mediaContainer},this.renderMediaPageButton("previous"),this.renderMediaInfo(),this.renderMediaPageButton("next")):null}renderImageMediaInfo(e){const{_refreshIntervalInfo:t}=this,{activeMediaInfoIndex:i,formattedMediaInfoCount:r}=this.viewModel,{value:s,refreshInterval:n,altText:o,title:a,type:l}=e,{sourceURL:c,linkURL:h}=s,p=gde(h)?"_blank":"_self",f=p==="_blank"?"noreferrer":"",g=n?t:null,y=g?g.timestamp:0,v=g?g.sourceURL:c,b=le("img",{alt:o||a,key:`media-${l}-${i}-${r}-${y}`,src:v});return(h?le("a",{title:a,href:h,rel:f,target:p},b):null)||b}renderChartMediaInfo(e){const{activeMediaInfoIndex:t,formattedMediaInfoCount:i}=this.viewModel;return le("div",{key:`media-${e.type}-${t}-${i}`,bind:this,class:Qr.mediaChart,afterCreate:this._getChartDependencies})}renderMediaInfoType(){const{activeMediaInfo:e}=this.viewModel;return e?e.type==="image"?this.renderImageMediaInfo(e):e.type.indexOf("chart")!==-1?this.renderChartMediaInfo(e):null:null}renderMediaInfo(){const{activeMediaInfo:e}=this.viewModel;if(!e)return null;const t=e.title?le("div",{key:"media-title",class:Qr.mediaItemTitle,innerHTML:e.title}):null,i=e.caption?le("div",{key:"media-caption",class:Qr.mediaItemCaption,innerHTML:e.caption}):null;return le("div",{key:"media-container",class:Qr.mediaItemContainer},le("div",{key:"media-item-container",class:Qr.mediaItem},this.renderMediaInfoType()),t,i)}renderMediaPageButton(e){if(this.viewModel.formattedMediaInfoCount<2)return null;const t=e==="previous",i=t?this.messages.previous:this.messages.next,r=t?this.classes(Qr.mediaButton,Qr.mediaPrevious):this.classes(Qr.mediaButton,Qr.mediaNext),s=t?this.classes(Qr.mediaIcon,Qr.mediaPreviousIconLTR,Qr.iconLeftTriangleArrow):this.classes(Qr.mediaIcon,Qr.mediaNextIconLTR,Qr.iconRightTriangleArrow),n=t?this.classes(Qr.mediaIcon,Qr.mediaPreviousIconRTL,Qr.iconRightTriangleArrow):this.classes(Qr.mediaIcon,Qr.mediaNextIconRTL,Qr.iconLeftTriangleArrow),o=t?"media-previous":"media-next",a=t?this._previous:this._next;return le("button",{type:"button",key:o,title:i,"aria-label":i,tabIndex:0,class:r,bind:this,onclick:a},le("span",{"aria-hidden":"true",class:s}),le("span",{"aria-hidden":"true",class:n}))}_setupFeatureElementInfo(){const{description:e,title:t}=this;this._featureElementInfo.set({description:e,title:t})}_next(){this.viewModel.next()}_previous(){this.viewModel.previous()}_handleMediaKeyup(e){const t=A_(e);t==="ArrowLeft"&&(e.stopPropagation(),this.viewModel.previous()),t==="ArrowRight"&&(e.stopPropagation(),this.viewModel.next())}_renderChart(e){const{abilities:t}=this.viewModel,{chartsModule:i,chartDiv:r,mediaInfo:s}=e,{value:n,type:o}=s,{am4core:a}=i,l=WLe(a);function c(f){f instanceof a.ColorSet&&l&&(f.list=l)}cde()&&a.useTheme(i.am4themes_dark);const h=window.matchMedia("(prefers-reduced-motion: reduce)");t.chartAnimation&&!h.matches?a.useTheme(i.am4themes_animated):a.unuseTheme(i.am4themes_animated),a.useTheme(c);const p=o==="pie-chart"?this._createPieChart(e):this._createXYChart(e);r.setAttribute("aria-label",s.altText||s.title),p.data=n.series.map(f=>({tooltip:f.tooltip,value:f.value})).filter(f=>o!=="pie-chart"||f.value>0)}_customizeChartTooltip(e,t){e.label.wrap=!0,e.label.maxWidth=200,e.autoTextColor=!1,e.getFillFromObject=!1,e.label.fill=t.color("#ffffff"),e.background.fill=t.color({r:0,g:0,b:0,a:.7})}_createPieChart(e){const{chartDiv:t,chartsModule:i}=e,{am4core:r,am4charts:s}=i,n=r.create(t,s.PieChart);n.rtl=qy(this.container);const o=n.series.push(new s.PieSeries);return o.labels.template.disabled=!0,o.ticks.template.disabled=!0,o.dataFields.value="value",o.dataFields.category="tooltip",this._customizeChartTooltip(o.tooltip,r),o.slices.template.tooltipText=n.rtl?"{category}: %{value.percent.formatNumber('#.0')}":"{category}: {value.percent.formatNumber('#.0')}%",n}_getMinSeriesValue(e){let t=0;return e.forEach(i=>t=Math.min(i.value,t)),t}_createColumnChart(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:s}=r,{am4core:n,am4charts:o}=i,a=e.xAxes.push(new o.CategoryAxis);a.dataFields.category="tooltip",a.renderer.labels.template.disabled=!0,this._customizeChartTooltip(a.tooltip,n),a.tooltip.events.on("sizechanged",()=>{a.tooltip.dy=-a.tooltip.contentHeight});const l=e.yAxes.push(new o.ValueAxis),c=l.renderer.labels.template;l.renderer.minLabelPosition=tU,l.renderer.maxLabelPosition=iU,l.min=this._getMinSeriesValue(s.series),this._customizeChartTooltip(l.tooltip,n),c.wrap=!0;const h=e.series.push(new o.ColumnSeries);h.dataFields.valueY="value",h.dataFields.categoryX="tooltip",e.cursor=new o.XYCursor,s.series.length>rU&&(e.scrollbarX=new n.Scrollbar)}_createBarChart(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:s}=r,{am4core:n,am4charts:o}=i,a=e.yAxes.push(new o.CategoryAxis);a.dataFields.category="tooltip",a.renderer.inversed=!0,a.renderer.labels.template.disabled=!0,this._customizeChartTooltip(a.tooltip,n),a.tooltip.events.on("sizechanged",()=>{a.tooltip.dx=a.tooltip.contentWidth});const l=e.xAxes.push(new o.ValueAxis),c=l.renderer.labels.template;l.renderer.minLabelPosition=tU,l.renderer.maxLabelPosition=iU,l.min=this._getMinSeriesValue(s.series),this._customizeChartTooltip(l.tooltip,n),c.wrap=!0;const h=e.series.push(new o.ColumnSeries);h.dataFields.valueX="value",h.dataFields.categoryY="tooltip",e.cursor=new o.XYCursor,s.series.length>rU&&(e.scrollbarY=new n.Scrollbar)}_createLineChart(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:s}=r,{am4core:n,am4charts:o}=i,a=e.xAxes.push(new o.CategoryAxis);a.dataFields.category="tooltip",a.renderer.labels.template.disabled=!0,this._customizeChartTooltip(a.tooltip,n),a.tooltip.events.on("sizechanged",()=>{a.tooltip.dy=-a.tooltip.contentHeight});const l=e.yAxes.push(new o.ValueAxis),c=l.renderer.labels.template;l.renderer.minLabelPosition=tU,l.renderer.maxLabelPosition=iU,l.min=this._getMinSeriesValue(s.series),this._customizeChartTooltip(l.tooltip,n),c.wrap=!0;const h=e.series.push(new o.LineSeries);h.dataFields.categoryX="tooltip",h.dataFields.valueY="value",e.cursor=new o.XYCursor,s.series.length>rU&&(e.scrollbarX=new n.Scrollbar)}_createXYChart(e){const{chartDiv:t,chartsModule:i,mediaInfo:r}=e,{type:s}=r,{am4core:n,am4charts:o}=i,a=n.create(t,o.XYChart);return a.rtl=qy(this.container),s==="column-chart"&&this._createColumnChart(a,e),s==="bar-chart"&&this._createBarChart(a,e),s==="line-chart"&&this._createLineChart(a,e),a}_clearMediaRefreshTimer(){const{_refreshTimer:e}=this;e&&(clearTimeout(e),this._refreshTimer=null)}_updateMediaInfoTimestamp(e){const t=Date.now();this._refreshIntervalInfo={timestamp:t,sourceURL:this._getImageSource(e,t)},this.scheduleRender()}_setupMediaRefreshTimer(){this._clearMediaRefreshTimer();const{activeMediaInfo:e}=this.viewModel;e&&e.type==="image"&&e.refreshInterval&&this._setRefreshTimeout(e)}_setRefreshTimeout(e){const{refreshInterval:t,value:i}=e;if(!t)return;const r=6e4*t;this._updateMediaInfoTimestamp(i.sourceURL);const s=setInterval(()=>{this._updateMediaInfoTimestamp(i.sourceURL)},r);this._refreshTimer=s}_getImageSource(e,t){const i=e.indexOf("?")!==-1?"&":"?",[r,s=""]=e.split("#");return`${r}${i}timestamp=${t}${s?"#":""}${s}`}};u([mt("viewModel.attributes")],Va.prototype,"attributes",void 0),u([mt("viewModel.activeMediaInfoIndex")],Va.prototype,"activeMediaInfoIndex",void 0),u([mt("viewModel.description")],Va.prototype,"description",void 0),u([mt("viewModel.fieldInfoMap")],Va.prototype,"fieldInfoMap",void 0),u([mt("viewModel.layer")],Va.prototype,"layer",void 0),u([mt("viewModel.mediaInfos")],Va.prototype,"mediaInfos",void 0),u([mt("viewModel.popupTemplate")],Va.prototype,"popupTemplate",void 0),u([mt("viewModel.relatedInfos")],Va.prototype,"relatedInfos",void 0),u([mt("viewModel.title")],Va.prototype,"title",void 0),u([d({type:X_})],Va.prototype,"viewModel",void 0),u([d(),fl("esri/widgets/Feature/t9n/Feature")],Va.prototype,"messages",void 0),Va=u([P("esri.widgets.Feature.FeatureMedia")],Va);const npe=Va;class XLe{constructor(t,i){this.definition=null,this.context=null,this.definition=t,this.context=i}}class Bp{constructor(t=[]){this._elements=t}length(){return this._elements.length}get(t){return this._elements[t]}toArray(){const t=[];for(let i=0;i<this.length();i++)t.push(this.get(i));return t}}class gb extends Bp{constructor(t,i,r,s,n,o){super(t),this._lazyPt=[],this._hasZ=!1,this._hasM=!1,this._spRef=i,this._hasZ=r,this._hasM=s,this._cacheId=n,this._partId=o}get(t){if(this._lazyPt[t]===void 0){const i=this._elements[t];if(i===void 0)return;const r=this._hasZ,s=this._hasM;let n=null;n=r&&!s?new et(i[0],i[1],i[2],void 0,this._spRef):s&&!r?new et(i[0],i[1],void 0,i[2],this._spRef):r&&s?new et(i[0],i[1],i[2],i[3],this._spRef):new et(i[0],i[1],this._spRef),n.cache._arcadeCacheId=this._cacheId.toString()+"-"+this._partId.toString()+"-"+t.toString(),this._lazyPt[t]=n}return this._lazyPt[t]}equalityTest(t){return t===this||t!==null&&t instanceof gb&&t.getUniqueHash()===this.getUniqueHash()}getUniqueHash(){return this._cacheId.toString()+"-"+this._partId.toString()}}class xH extends Bp{constructor(t,i,r,s,n){super(t),this._lazyPath=[],this._hasZ=!1,this._hasM=!1,this._hasZ=r,this._hasM=s,this._spRef=i,this._cacheId=n}get(t){if(this._lazyPath[t]===void 0){const i=this._elements[t];if(i===void 0)return;this._lazyPath[t]=new gb(i,this._spRef,this._hasZ,this._hasM,this._cacheId,t)}return this._lazyPath[t]}equalityTest(t){return t===this||t!==null&&t instanceof xH&&t.getUniqueHash()===this.getUniqueHash()}getUniqueHash(){return this._cacheId.toString()}}class yb extends Error{}class YLe extends yb{constructor(t){super(`Invalid DateTime: ${t.toMessage()}`)}}class ZLe extends yb{constructor(t){super(`Invalid Interval: ${t.toMessage()}`)}}class QLe extends yb{constructor(t){super(`Invalid Duration: ${t.toMessage()}`)}}class KE extends yb{}class ope extends yb{constructor(t){super(`Invalid unit ${t}`)}}class gu extends yb{}class ug extends yb{constructor(){super("Zone is an abstract class")}}const qe="numeric",ed="short",gc="long",YV={year:qe,month:qe,day:qe},ape={year:qe,month:ed,day:qe},JLe={year:qe,month:ed,day:qe,weekday:ed},lpe={year:qe,month:gc,day:qe},cpe={year:qe,month:gc,day:qe,weekday:gc},upe={hour:qe,minute:qe},hpe={hour:qe,minute:qe,second:qe},dpe={hour:qe,minute:qe,second:qe,timeZoneName:ed},ppe={hour:qe,minute:qe,second:qe,timeZoneName:gc},fpe={hour:qe,minute:qe,hourCycle:"h23"},mpe={hour:qe,minute:qe,second:qe,hourCycle:"h23"},gpe={hour:qe,minute:qe,second:qe,hourCycle:"h23",timeZoneName:ed},ype={hour:qe,minute:qe,second:qe,hourCycle:"h23",timeZoneName:gc},vpe={year:qe,month:qe,day:qe,hour:qe,minute:qe},_pe={year:qe,month:qe,day:qe,hour:qe,minute:qe,second:qe},bpe={year:qe,month:ed,day:qe,hour:qe,minute:qe},wpe={year:qe,month:ed,day:qe,hour:qe,minute:qe,second:qe},KLe={year:qe,month:ed,day:qe,weekday:ed,hour:qe,minute:qe},xpe={year:qe,month:gc,day:qe,hour:qe,minute:qe,timeZoneName:ed},Tpe={year:qe,month:gc,day:qe,hour:qe,minute:qe,second:qe,timeZoneName:ed},Spe={year:qe,month:gc,day:qe,weekday:gc,hour:qe,minute:qe,timeZoneName:gc},Epe={year:qe,month:gc,day:qe,weekday:gc,hour:qe,minute:qe,second:qe,timeZoneName:gc};function Ci(e){return typeof e=="undefined"}function p1(e){return typeof e=="number"}function EF(e){return typeof e=="number"&&e%1===0}function eNe(e){return typeof e=="string"}function tNe(e){return Object.prototype.toString.call(e)==="[object Date]"}function Ape(){try{return typeof Intl!="undefined"&&!!Intl.RelativeTimeFormat}catch{return!1}}function iNe(e){return Array.isArray(e)?e:[e]}function BQ(e,t,i){if(e.length!==0)return e.reduce((r,s)=>{const n=[t(s),s];return r&&i(r[0],n[0])===r[0]?r:n},null)[1]}function rNe(e,t){return t.reduce((i,r)=>(i[r]=e[r],i),{})}function QT(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function lm(e,t,i){return EF(e)&&e>=t&&e<=i}function sNe(e,t){return e-t*Math.floor(e/t)}function Ys(e,t=2){const i=e<0;let r;return i?r="-"+(""+-e).padStart(t,"0"):r=(""+e).padStart(t,"0"),r}function _y(e){if(!(Ci(e)||e===null||e===""))return parseInt(e,10)}function X0(e){if(!(Ci(e)||e===null||e===""))return parseFloat(e)}function TH(e){if(!(Ci(e)||e===null||e==="")){const t=parseFloat("0."+e)*1e3;return Math.floor(t)}}function SH(e,t,i=!1){const r=10**t;return(i?Math.trunc:Math.round)(e*r)/r}function _O(e){return e%4===0&&(e%100!==0||e%400===0)}function rC(e){return _O(e)?366:365}function sL(e,t){const i=sNe(t-1,12)+1,r=e+(t-i)/12;return i===2?_O(r)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][i-1]}function EH(e){let t=Date.UTC(e.year,e.month-1,e.day,e.hour,e.minute,e.second,e.millisecond);return e.year<100&&e.year>=0&&(t=new Date(t),t.setUTCFullYear(t.getUTCFullYear()-1900)),+t}function nL(e){const t=(e+Math.floor(e/4)-Math.floor(e/100)+Math.floor(e/400))%7,i=e-1,r=(i+Math.floor(i/4)-Math.floor(i/100)+Math.floor(i/400))%7;return t===4||r===3?53:52}function ZV(e){return e>99?e:e>60?1900+e:2e3+e}function Cpe(e,t,i,r=null){const s=new Date(e),n={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};r&&(n.timeZone=r);const o=I({timeZoneName:t},n),a=new Intl.DateTimeFormat(i,o).formatToParts(s).find(l=>l.type.toLowerCase()==="timezonename");return a?a.value:null}function AF(e,t){let i=parseInt(e,10);Number.isNaN(i)&&(i=0);const r=parseInt(t,10)||0,s=i<0||Object.is(i,-0)?-r:r;return i*60+s}function Rpe(e){const t=Number(e);if(typeof e=="boolean"||e===""||Number.isNaN(t))throw new gu(`Invalid unit value ${e}`);return t}function oL(e,t){const i={};for(const r in e)if(QT(e,r)){const s=e[r];if(s==null)continue;i[t(r)]=Rpe(s)}return i}function aL(e,t){const i=Math.trunc(Math.abs(e/60)),r=Math.trunc(Math.abs(e%60)),s=e>=0?"+":"-";switch(t){case"short":return`${s}${Ys(i,2)}:${Ys(r,2)}`;case"narrow":return`${s}${i}${r>0?`:${r}`:""}`;case"techie":return`${s}${Ys(i,2)}${Ys(r,2)}`;default:throw new RangeError(`Value format ${t} is out of range for property format`)}}function CF(e){return rNe(e,["hour","minute","second","millisecond"])}const nNe=/[A-Za-z_+-]{1,256}(:?\/[A-Za-z0-9_+-]{1,256}(\/[A-Za-z0-9_+-]{1,256})?)?/,oNe=["January","February","March","April","May","June","July","August","September","October","November","December"],Ope=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],aNe=["J","F","M","A","M","J","J","A","S","O","N","D"];function Mpe(e){switch(e){case"narrow":return[...aNe];case"short":return[...Ope];case"long":return[...oNe];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const Ppe=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],Ipe=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],lNe=["M","T","W","T","F","S","S"];function $pe(e){switch(e){case"narrow":return[...lNe];case"short":return[...Ipe];case"long":return[...Ppe];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const Dpe=["AM","PM"],cNe=["Before Christ","Anno Domini"],uNe=["BC","AD"],hNe=["B","A"];function Lpe(e){switch(e){case"narrow":return[...hNe];case"short":return[...uNe];case"long":return[...cNe];default:return null}}function dNe(e){return Dpe[e.hour<12?0:1]}function pNe(e,t){return $pe(t)[e.weekday-1]}function fNe(e,t){return Mpe(t)[e.month-1]}function mNe(e,t){return Lpe(t)[e.year<0?0:1]}function gNe(e,t,i="always",r=!1){const s={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},n=["hours","minutes","seconds"].indexOf(e)===-1;if(i==="auto"&&n){const p=e==="days";switch(t){case 1:return p?"tomorrow":`next ${s[e][0]}`;case-1:return p?"yesterday":`last ${s[e][0]}`;case 0:return p?"today":`this ${s[e][0]}`}}const o=Object.is(t,-0)||t<0,a=Math.abs(t),l=a===1,c=s[e],h=r?l?c[1]:c[2]||c[1]:l?s[e][0]:e;return o?`${a} ${h} ago`:`in ${a} ${h}`}function VQ(e,t){let i="";for(const r of e)r.literal?i+=r.val:i+=t(r.val);return i}const yNe={D:YV,DD:ape,DDD:lpe,DDDD:cpe,t:upe,tt:hpe,ttt:dpe,tttt:ppe,T:fpe,TT:mpe,TTT:gpe,TTTT:ype,f:vpe,ff:bpe,fff:xpe,ffff:Spe,F:_pe,FF:wpe,FFF:Tpe,FFFF:Epe};class ul{static create(t,i={}){return new ul(t,i)}static parseFormat(t){let i=null,r="",s=!1;const n=[];for(let o=0;o<t.length;o++){const a=t.charAt(o);a==="'"?(r.length>0&&n.push({literal:s,val:r}),i=null,r="",s=!s):s||a===i?r+=a:(r.length>0&&n.push({literal:!1,val:r}),r=a,i=a)}return r.length>0&&n.push({literal:s,val:r}),n}static macroTokenToFormatOpts(t){return yNe[t]}constructor(t,i){this.opts=i,this.loc=t,this.systemLoc=null}formatWithSystemDefault(t,i){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(t,I(I({},this.opts),i)).format()}formatDateTime(t,i={}){return this.loc.dtFormatter(t,I(I({},this.opts),i)).format()}formatDateTimeParts(t,i={}){return this.loc.dtFormatter(t,I(I({},this.opts),i)).formatToParts()}resolvedOptions(t,i={}){return this.loc.dtFormatter(t,I(I({},this.opts),i)).resolvedOptions()}num(t,i=0){if(this.opts.forceSimple)return Ys(t,i);const r=I({},this.opts);return i>0&&(r.padTo=i),this.loc.numberFormatter(r).format(t)}formatDateTimeFromString(t,i){const r=this.loc.listingMode()==="en",s=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",n=(g,y)=>this.loc.extract(t,g,y),o=g=>t.isOffsetFixed&&t.offset===0&&g.allowZ?"Z":t.isValid?t.zone.formatOffset(t.ts,g.format):"",a=()=>r?dNe(t):n({hour:"numeric",hourCycle:"h12"},"dayperiod"),l=(g,y)=>r?fNe(t,g):n(y?{month:g}:{month:g,day:"numeric"},"month"),c=(g,y)=>r?pNe(t,g):n(y?{weekday:g}:{weekday:g,month:"long",day:"numeric"},"weekday"),h=g=>{const y=ul.macroTokenToFormatOpts(g);return y?this.formatWithSystemDefault(t,y):g},p=g=>r?mNe(t,g):n({era:g},"era"),f=g=>{switch(g){case"S":return this.num(t.millisecond);case"u":case"SSS":return this.num(t.millisecond,3);case"s":return this.num(t.second);case"ss":return this.num(t.second,2);case"uu":return this.num(Math.floor(t.millisecond/10),2);case"uuu":return this.num(Math.floor(t.millisecond/100));case"m":return this.num(t.minute);case"mm":return this.num(t.minute,2);case"h":return this.num(t.hour%12===0?12:t.hour%12);case"hh":return this.num(t.hour%12===0?12:t.hour%12,2);case"H":return this.num(t.hour);case"HH":return this.num(t.hour,2);case"Z":return o({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return o({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return o({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return t.zone.offsetName(t.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return t.zone.offsetName(t.ts,{format:"long",locale:this.loc.locale});case"z":return t.zoneName;case"a":return a();case"d":return s?n({day:"numeric"},"day"):this.num(t.day);case"dd":return s?n({day:"2-digit"},"day"):this.num(t.day,2);case"c":return this.num(t.weekday);case"ccc":return c("short",!0);case"cccc":return c("long",!0);case"ccccc":return c("narrow",!0);case"E":return this.num(t.weekday);case"EEE":return c("short",!1);case"EEEE":return c("long",!1);case"EEEEE":return c("narrow",!1);case"L":return s?n({month:"numeric",day:"numeric"},"month"):this.num(t.month);case"LL":return s?n({month:"2-digit",day:"numeric"},"month"):this.num(t.month,2);case"LLL":return l("short",!0);case"LLLL":return l("long",!0);case"LLLLL":return l("narrow",!0);case"M":return s?n({month:"numeric"},"month"):this.num(t.month);case"MM":return s?n({month:"2-digit"},"month"):this.num(t.month,2);case"MMM":return l("short",!1);case"MMMM":return l("long",!1);case"MMMMM":return l("narrow",!1);case"y":return s?n({year:"numeric"},"year"):this.num(t.year);case"yy":return s?n({year:"2-digit"},"year"):this.num(t.year.toString().slice(-2),2);case"yyyy":return s?n({year:"numeric"},"year"):this.num(t.year,4);case"yyyyyy":return s?n({year:"numeric"},"year"):this.num(t.year,6);case"G":return p("short");case"GG":return p("long");case"GGGGG":return p("narrow");case"kk":return this.num(t.weekYear.toString().slice(-2),2);case"kkkk":return this.num(t.weekYear,4);case"W":return this.num(t.weekNumber);case"WW":return this.num(t.weekNumber,2);case"o":return this.num(t.ordinal);case"ooo":return this.num(t.ordinal,3);case"q":return this.num(t.quarter);case"qq":return this.num(t.quarter,2);case"X":return this.num(Math.floor(t.ts/1e3));case"x":return this.num(t.ts);default:return h(g)}};return VQ(ul.parseFormat(i),f)}formatDurationFromString(t,i){const r=l=>{switch(l[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"M":return"month";case"y":return"year";default:return null}},s=l=>c=>{const h=r(c);return h?this.num(l.get(h),c.length):c},n=ul.parseFormat(i),o=n.reduce((l,{literal:c,val:h})=>c?l:l.concat(h),[]),a=t.shiftTo(...o.map(r).filter(l=>l));return VQ(n,s(a))}}class Bh{constructor(t,i){this.reason=t,this.explanation=i}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}class bO{get type(){throw new ug}get name(){throw new ug}get isUniversal(){throw new ug}offsetName(t,i){throw new ug}formatOffset(t,i){throw new ug}offset(t){throw new ug}equals(t){throw new ug}get isValid(){throw new ug}}let sU=null;class AH extends bO{static get instance(){return sU===null&&(sU=new AH),sU}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(t,{format:i,locale:r}){return Cpe(t,i,r)}formatOffset(t,i){return aL(this.offset(t),i)}offset(t){return-new Date(t).getTimezoneOffset()}equals(t){return t.type==="system"}get isValid(){return!0}}let PI={};function vNe(e){return PI[e]||(PI[e]=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:e,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})),PI[e]}const _Ne={year:0,month:1,day:2,hour:3,minute:4,second:5};function bNe(e,t){const i=e.format(t).replace(/\u200E/g,""),r=/(\d+)\/(\d+)\/(\d+),? (\d+):(\d+):(\d+)/.exec(i),[,s,n,o,a,l,c]=r;return[o,s,n,a,l,c]}function wNe(e,t){const i=e.formatToParts(t),r=[];for(let s=0;s<i.length;s++){const{type:n,value:o}=i[s],a=_Ne[n];Ci(a)||(r[a]=parseInt(o,10))}return r}let DM={};class Pm extends bO{static create(t){return DM[t]||(DM[t]=new Pm(t)),DM[t]}static resetCache(){DM={},PI={}}static isValidSpecifier(t){return this.isValidZone(t)}static isValidZone(t){if(!t)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:t}).format(),!0}catch{return!1}}constructor(t){super();this.zoneName=t,this.valid=Pm.isValidZone(t)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(t,{format:i,locale:r}){return Cpe(t,i,r,this.name)}formatOffset(t,i){return aL(this.offset(t),i)}offset(t){const i=new Date(t);if(isNaN(i))return NaN;const r=vNe(this.name),[s,n,o,a,l,c]=r.formatToParts?wNe(r,i):bNe(r,i),p=EH({year:s,month:n,day:o,hour:a===24?0:a,minute:l,second:c,millisecond:0});let f=+i;const g=f%1e3;return f-=g>=0?g:1e3+g,(p-f)/(60*1e3)}equals(t){return t.type==="iana"&&t.name===this.name}get isValid(){return this.valid}}let nU=null;class wa extends bO{static get utcInstance(){return nU===null&&(nU=new wa(0)),nU}static instance(t){return t===0?wa.utcInstance:new wa(t)}static parseSpecifier(t){if(t){const i=t.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(i)return new wa(AF(i[1],i[2]))}return null}constructor(t){super();this.fixed=t}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${aL(this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(t,i){return aL(this.fixed,i)}get isUniversal(){return!0}offset(){return this.fixed}equals(t){return t.type==="fixed"&&t.fixed===this.fixed}get isValid(){return!0}}class xNe extends bO{constructor(t){super();this.zoneName=t}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function My(e,t){if(Ci(e)||e===null)return t;if(e instanceof bO)return e;if(eNe(e)){const i=e.toLowerCase();return i==="local"||i==="system"?t:i==="utc"||i==="gmt"?wa.utcInstance:wa.parseSpecifier(i)||Pm.create(e)}else return p1(e)?wa.instance(e):typeof e=="object"&&e.offset&&typeof e.offset=="number"?e:new xNe(e)}let GQ=()=>Date.now(),jQ="system",HQ=null,qQ=null,WQ=null,XQ;class hn{static get now(){return GQ}static set now(t){GQ=t}static set defaultZone(t){jQ=t}static get defaultZone(){return My(jQ,AH.instance)}static get defaultLocale(){return HQ}static set defaultLocale(t){HQ=t}static get defaultNumberingSystem(){return qQ}static set defaultNumberingSystem(t){qQ=t}static get defaultOutputCalendar(){return WQ}static set defaultOutputCalendar(t){WQ=t}static get throwOnInvalid(){return XQ}static set throwOnInvalid(t){XQ=t}static resetCaches(){ss.resetCache(),Pm.resetCache()}}let YQ={};function TNe(e,t={}){const i=JSON.stringify([e,t]);let r=YQ[i];return r||(r=new Intl.ListFormat(e,t),YQ[i]=r),r}let QV={};function JV(e,t={}){const i=JSON.stringify([e,t]);let r=QV[i];return r||(r=new Intl.DateTimeFormat(e,t),QV[i]=r),r}let KV={};function SNe(e,t={}){const i=JSON.stringify([e,t]);let r=KV[i];return r||(r=new Intl.NumberFormat(e,t),KV[i]=r),r}let e8={};function ENe(e,t={}){const o=t,{base:i}=o,r=c5(o,["base"]),s=JSON.stringify([e,r]);let n=e8[s];return n||(n=new Intl.RelativeTimeFormat(e,t),e8[s]=n),n}let eA=null;function ANe(){return eA||(eA=new Intl.DateTimeFormat().resolvedOptions().locale,eA)}function CNe(e){const t=e.indexOf("-u-");if(t===-1)return[e];{let i;const r=e.substring(0,t);try{i=JV(e).resolvedOptions()}catch{i=JV(r).resolvedOptions()}const{numberingSystem:s,calendar:n}=i;return[r,s,n]}}function RNe(e,t,i){return(i||t)&&(e+="-u",i&&(e+=`-ca-${i}`),t&&(e+=`-nu-${t}`)),e}function ONe(e){const t=[];for(let i=1;i<=12;i++){const r=Bt.utc(2016,i,1);t.push(e(r))}return t}function MNe(e){const t=[];for(let i=1;i<=7;i++){const r=Bt.utc(2016,11,13+i);t.push(e(r))}return t}function LM(e,t,i,r,s){const n=e.listingMode(i);return n==="error"?null:n==="en"?r(t):s(t)}function PNe(e){return e.numberingSystem&&e.numberingSystem!=="latn"?!1:e.numberingSystem==="latn"||!e.locale||e.locale.startsWith("en")||new Intl.DateTimeFormat(e.intl).resolvedOptions().numberingSystem==="latn"}class INe{constructor(t,i,r){this.padTo=r.padTo||0,this.floor=r.floor||!1;const a=r,{padTo:s,floor:n}=a,o=c5(a,["padTo","floor"]);if(!i||Object.keys(o).length>0){const l=I({useGrouping:!1},r);r.padTo>0&&(l.minimumIntegerDigits=r.padTo),this.inf=SNe(t,l)}}format(t){if(this.inf){const i=this.floor?Math.floor(t):t;return this.inf.format(i)}else{const i=this.floor?Math.floor(t):SH(t,3);return Ys(i,this.padTo)}}}class $Ne{constructor(t,i,r){this.opts=r;let s;if(t.zone.isUniversal){const o=-1*(t.offset/60),a=o>=0?`Etc/GMT+${o}`:`Etc/GMT${o}`;t.offset!==0&&Pm.create(a).valid?(s=a,this.dt=t):(s="UTC",r.timeZoneName?this.dt=t:this.dt=t.offset===0?t:Bt.fromMillis(t.ts+t.offset*60*1e3))}else t.zone.type==="system"?this.dt=t:(this.dt=t,s=t.zone.name);const n=I({},this.opts);s&&(n.timeZone=s),this.dtf=JV(i,n)}format(){return this.dtf.format(this.dt.toJSDate())}formatToParts(){return this.dtf.formatToParts(this.dt.toJSDate())}resolvedOptions(){return this.dtf.resolvedOptions()}}class DNe{constructor(t,i,r){this.opts=I({style:"long"},r),!i&&Ape()&&(this.rtf=ENe(t,r))}format(t,i){return this.rtf?this.rtf.format(t,i):gNe(i,t,this.opts.numeric,this.opts.style!=="long")}formatToParts(t,i){return this.rtf?this.rtf.formatToParts(t,i):[]}}class ss{static fromOpts(t){return ss.create(t.locale,t.numberingSystem,t.outputCalendar,t.defaultToEN)}static create(t,i,r,s=!1){const n=t||hn.defaultLocale,o=n||(s?"en-US":ANe()),a=i||hn.defaultNumberingSystem,l=r||hn.defaultOutputCalendar;return new ss(o,a,l,n)}static resetCache(){eA=null,QV={},KV={},e8={}}static fromObject({locale:t,numberingSystem:i,outputCalendar:r}={}){return ss.create(t,i,r)}constructor(t,i,r,s){const[n,o,a]=CNe(t);this.locale=n,this.numberingSystem=i||o||null,this.outputCalendar=r||a||null,this.intl=RNe(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=s,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=PNe(this)),this.fastNumbersCached}listingMode(){const t=this.isEnglish(),i=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return t&&i?"en":"intl"}clone(t){return!t||Object.getOwnPropertyNames(t).length===0?this:ss.create(t.locale||this.specifiedLocale,t.numberingSystem||this.numberingSystem,t.outputCalendar||this.outputCalendar,t.defaultToEN||!1)}redefaultToEN(t={}){return this.clone(me(I({},t),{defaultToEN:!0}))}redefaultToSystem(t={}){return this.clone(me(I({},t),{defaultToEN:!1}))}months(t,i=!1,r=!0){return LM(this,t,r,Mpe,()=>{const s=i?{month:t,day:"numeric"}:{month:t},n=i?"format":"standalone";return this.monthsCache[n][t]||(this.monthsCache[n][t]=ONe(o=>this.extract(o,s,"month"))),this.monthsCache[n][t]})}weekdays(t,i=!1,r=!0){return LM(this,t,r,$pe,()=>{const s=i?{weekday:t,year:"numeric",month:"long",day:"numeric"}:{weekday:t},n=i?"format":"standalone";return this.weekdaysCache[n][t]||(this.weekdaysCache[n][t]=MNe(o=>this.extract(o,s,"weekday"))),this.weekdaysCache[n][t]})}meridiems(t=!0){return LM(this,void 0,t,()=>Dpe,()=>{if(!this.meridiemCache){const i={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[Bt.utc(2016,11,13,9),Bt.utc(2016,11,13,19)].map(r=>this.extract(r,i,"dayperiod"))}return this.meridiemCache})}eras(t,i=!0){return LM(this,t,i,Lpe,()=>{const r={era:t};return this.eraCache[t]||(this.eraCache[t]=[Bt.utc(-40,1,1),Bt.utc(2017,1,1)].map(s=>this.extract(s,r,"era"))),this.eraCache[t]})}extract(t,i,r){const s=this.dtFormatter(t,i),n=s.formatToParts(),o=n.find(a=>a.type.toLowerCase()===r);return o?o.value:null}numberFormatter(t={}){return new INe(this.intl,t.forceSimple||this.fastNumbers,t)}dtFormatter(t,i={}){return new $Ne(t,this.intl,i)}relFormatter(t={}){return new DNe(this.intl,this.isEnglish(),t)}listFormatter(t={}){return TNe(this.intl,t)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||new Intl.DateTimeFormat(this.intl).resolvedOptions().locale.startsWith("en-us")}equals(t){return this.locale===t.locale&&this.numberingSystem===t.numberingSystem&&this.outputCalendar===t.outputCalendar}}function YS(...e){const t=e.reduce((i,r)=>i+r.source,"");return RegExp(`^${t}$`)}function vb(...e){return t=>e.reduce(([i,r,s],n)=>{const[o,a,l]=n(t,s);return[I(I({},i),o),r||a,l]},[{},null,1]).slice(0,2)}function ZS(e,...t){if(e==null)return[null,null];for(const[i,r]of t){const s=i.exec(e);if(s)return r(s)}return[null,null]}function Npe(...e){return(t,i)=>{const r={};let s;for(s=0;s<e.length;s++)r[e[s]]=_y(t[i+s]);return[r,null,i+s]}}const Fpe=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,CH=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,Upe=RegExp(`${CH.source}${Fpe.source}?`),RH=RegExp(`(?:T${Upe.source})?`),LNe=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,NNe=/(\d{4})-?W(\d\d)(?:-?(\d))?/,FNe=/(\d{4})-?(\d{3})/,UNe=Npe("weekYear","weekNumber","weekDay"),kNe=Npe("year","ordinal"),zNe=/(\d{4})-(\d\d)-(\d\d)/,kpe=RegExp(`${CH.source} ?(?:${Fpe.source}|(${nNe.source}))?`),BNe=RegExp(`(?: ${kpe.source})?`);function rT(e,t,i){const r=e[t];return Ci(r)?i:_y(r)}function zpe(e,t){return[{year:rT(e,t),month:rT(e,t+1,1),day:rT(e,t+2,1)},null,t+3]}function _b(e,t){return[{hours:rT(e,t,0),minutes:rT(e,t+1,0),seconds:rT(e,t+2,0),milliseconds:TH(e[t+3])},null,t+4]}function QS(e,t){const i=!e[t]&&!e[t+1],r=AF(e[t+1],e[t+2]),s=i?null:wa.instance(r);return[{},s,t+3]}function Bpe(e,t){const i=e[t]?Pm.create(e[t]):null;return[{},i,t+1]}const VNe=RegExp(`^T?${CH.source}$`),GNe=/^-?P(?:(?:(-?\d{1,9}(?:\.\d{1,9})?)Y)?(?:(-?\d{1,9}(?:\.\d{1,9})?)M)?(?:(-?\d{1,9}(?:\.\d{1,9})?)W)?(?:(-?\d{1,9}(?:\.\d{1,9})?)D)?(?:T(?:(-?\d{1,9}(?:\.\d{1,9})?)H)?(?:(-?\d{1,9}(?:\.\d{1,9})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,9}))?S)?)?)$/;function jNe(e){const[t,i,r,s,n,o,a,l,c]=e,h=t[0]==="-",p=l&&l[0]==="-",f=(g,y=!1)=>g!==void 0&&(y||g&&h)?-g:g;return[{years:f(X0(i)),months:f(X0(r)),weeks:f(X0(s)),days:f(X0(n)),hours:f(X0(o)),minutes:f(X0(a)),seconds:f(X0(l),l==="-0"),milliseconds:f(TH(c),p)}]}const HNe={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function OH(e,t,i,r,s,n,o){const a={year:t.length===2?ZV(_y(t)):_y(t),month:Ope.indexOf(i)+1,day:_y(r),hour:_y(s),minute:_y(n)};return o&&(a.second=_y(o)),e&&(a.weekday=e.length>3?Ppe.indexOf(e)+1:Ipe.indexOf(e)+1),a}const qNe=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function WNe(e){const[,t,i,r,s,n,o,a,l,c,h,p]=e,f=OH(t,s,r,i,n,o,a);let g;return l?g=HNe[l]:c?g=0:g=AF(h,p),[f,new wa(g)]}function XNe(e){return e.replace(/\([^)]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const YNe=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,ZNe=/^(Monday|Tuesday|Wedsday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,QNe=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function ZQ(e){const[,t,i,r,s,n,o,a]=e;return[OH(t,s,r,i,n,o,a),wa.utcInstance]}function JNe(e){const[,t,i,r,s,n,o,a]=e;return[OH(t,a,i,r,s,n,o),wa.utcInstance]}const KNe=YS(LNe,RH),eFe=YS(NNe,RH),tFe=YS(FNe,RH),iFe=YS(Upe),rFe=vb(zpe,_b,QS),sFe=vb(UNe,_b,QS),nFe=vb(kNe,_b,QS),oFe=vb(_b,QS);function aFe(e){return ZS(e,[KNe,rFe],[eFe,sFe],[tFe,nFe],[iFe,oFe])}function lFe(e){return ZS(XNe(e),[qNe,WNe])}function cFe(e){return ZS(e,[YNe,ZQ],[ZNe,ZQ],[QNe,JNe])}function uFe(e){return ZS(e,[GNe,jNe])}const hFe=vb(_b);function dFe(e){return ZS(e,[VNe,hFe])}const pFe=YS(zNe,BNe),fFe=YS(kpe),mFe=vb(zpe,_b,QS,Bpe),gFe=vb(_b,QS,Bpe);function yFe(e){return ZS(e,[pFe,mFe],[fFe,gFe])}const vFe="Invalid Duration",Vpe={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1e3},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1e3},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},_Fe=I({years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1e3},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1e3}},Vpe),Dc=146097/400,Ob=146097/4800,bFe=I({years:{quarters:4,months:12,weeks:Dc/7,days:Dc,hours:Dc*24,minutes:Dc*24*60,seconds:Dc*24*60*60,milliseconds:Dc*24*60*60*1e3},quarters:{months:3,weeks:Dc/28,days:Dc/4,hours:Dc*24/4,minutes:Dc*24*60/4,seconds:Dc*24*60*60/4,milliseconds:Dc*24*60*60*1e3/4},months:{weeks:Ob/7,days:Ob,hours:Ob*24,minutes:Ob*24*60,seconds:Ob*24*60*60,milliseconds:Ob*24*60*60*1e3}},Vpe),qv=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],wFe=qv.slice(0).reverse();function Y0(e,t,i=!1){const r={values:i?t.values:I(I({},e.values),t.values||{}),loc:e.loc.clone(t.loc),conversionAccuracy:t.conversionAccuracy||e.conversionAccuracy};return new $i(r)}function xFe(e){return e<0?Math.floor(e):Math.ceil(e)}function Gpe(e,t,i,r,s){const n=e[s][i],o=t[i]/n,a=Math.sign(o)===Math.sign(r[s]),l=!a&&r[s]!==0&&Math.abs(o)<=1?xFe(o):Math.trunc(o);r[s]+=l,t[i]-=l*n}function TFe(e,t){wFe.reduce((i,r)=>Ci(t[r])?i:(i&&Gpe(e,t,i,t,r),r),null)}class $i{constructor(t){const i=t.conversionAccuracy==="longterm"||!1;this.values=t.values,this.loc=t.loc||ss.create(),this.conversionAccuracy=i?"longterm":"casual",this.invalid=t.invalid||null,this.matrix=i?bFe:_Fe,this.isLuxonDuration=!0}static fromMillis(t,i){return $i.fromObject({milliseconds:t},i)}static fromObject(t,i={}){if(t==null||typeof t!="object")throw new gu(`Duration.fromObject: argument expected to be an object, got ${t===null?"null":typeof t}`);return new $i({values:oL(t,$i.normalizeUnit),loc:ss.fromObject(i),conversionAccuracy:i.conversionAccuracy})}static fromDurationLike(t){if(p1(t))return $i.fromMillis(t);if($i.isDuration(t))return t;if(typeof t=="object")return $i.fromObject(t);throw new gu(`Unknown duration argument ${t} of type ${typeof t}`)}static fromISO(t,i){const[r]=uFe(t);return r?$i.fromObject(r,i):$i.invalid("unparsable",`the input "${t}" can't be parsed as ISO 8601`)}static fromISOTime(t,i){const[r]=dFe(t);return r?$i.fromObject(r,i):$i.invalid("unparsable",`the input "${t}" can't be parsed as ISO 8601`)}static invalid(t,i=null){if(!t)throw new gu("need to specify a reason the Duration is invalid");const r=t instanceof Bh?t:new Bh(t,i);if(hn.throwOnInvalid)throw new QLe(r);return new $i({invalid:r})}static normalizeUnit(t){const i={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[t&&t.toLowerCase()];if(!i)throw new ope(t);return i}static isDuration(t){return t&&t.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(t,i={}){const r=me(I({},i),{floor:i.round!==!1&&i.floor!==!1});return this.isValid?ul.create(this.loc,r).formatDurationFromString(this,t):vFe}toHuman(t={}){const i=qv.map(r=>{const s=this.values[r];return Ci(s)?null:this.loc.numberFormatter(me(I({style:"unit",unitDisplay:"long"},t),{unit:r.slice(0,-1)})).format(s)}).filter(r=>r);return this.loc.listFormatter(I({type:"conjunction",style:t.listStyle||"narrow"},t)).format(i)}toObject(){return this.isValid?I({},this.values):{}}toISO(){if(!this.isValid)return null;let t="P";return this.years!==0&&(t+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(t+=this.months+this.quarters*3+"M"),this.weeks!==0&&(t+=this.weeks+"W"),this.days!==0&&(t+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(t+="T"),this.hours!==0&&(t+=this.hours+"H"),this.minutes!==0&&(t+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(t+=SH(this.seconds+this.milliseconds/1e3,3)+"S"),t==="P"&&(t+="T0S"),t}toISOTime(t={}){if(!this.isValid)return null;const i=this.toMillis();if(i<0||i>=864e5)return null;t=I({suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended"},t);const r=this.shiftTo("hours","minutes","seconds","milliseconds");let s=t.format==="basic"?"hhmm":"hh:mm";(!t.suppressSeconds||r.seconds!==0||r.milliseconds!==0)&&(s+=t.format==="basic"?"ss":":ss",(!t.suppressMilliseconds||r.milliseconds!==0)&&(s+=".SSS"));let n=r.toFormat(s);return t.includePrefix&&(n="T"+n),n}toJSON(){return this.toISO()}toString(){return this.toISO()}toMillis(){return this.as("milliseconds")}valueOf(){return this.toMillis()}plus(t){if(!this.isValid)return this;const i=$i.fromDurationLike(t),r={};for(const s of qv)(QT(i.values,s)||QT(this.values,s))&&(r[s]=i.get(s)+this.get(s));return Y0(this,{values:r},!0)}minus(t){if(!this.isValid)return this;const i=$i.fromDurationLike(t);return this.plus(i.negate())}mapUnits(t){if(!this.isValid)return this;const i={};for(const r of Object.keys(this.values))i[r]=Rpe(t(this.values[r],r));return Y0(this,{values:i},!0)}get(t){return this[$i.normalizeUnit(t)]}set(t){if(!this.isValid)return this;const i=I(I({},this.values),oL(t,$i.normalizeUnit));return Y0(this,{values:i})}reconfigure({locale:t,numberingSystem:i,conversionAccuracy:r}={}){const s=this.loc.clone({locale:t,numberingSystem:i}),n={loc:s};return r&&(n.conversionAccuracy=r),Y0(this,n)}as(t){return this.isValid?this.shiftTo(t).get(t):NaN}normalize(){if(!this.isValid)return this;const t=this.toObject();return TFe(this.matrix,t),Y0(this,{values:t},!0)}shiftTo(...t){if(!this.isValid)return this;if(t.length===0)return this;t=t.map(o=>$i.normalizeUnit(o));const i={},r={},s=this.toObject();let n;for(const o of qv)if(t.indexOf(o)>=0){n=o;let a=0;for(const c in r)a+=this.matrix[c][o]*r[c],r[c]=0;p1(s[o])&&(a+=s[o]);const l=Math.trunc(a);i[o]=l,r[o]=(a*1e3-l*1e3)/1e3;for(const c in s)qv.indexOf(c)>qv.indexOf(o)&&Gpe(this.matrix,s,c,i,o)}else p1(s[o])&&(r[o]=s[o]);for(const o in r)r[o]!==0&&(i[n]+=o===n?r[o]:r[o]/this.matrix[n][o]);return Y0(this,{values:i},!0).normalize()}negate(){if(!this.isValid)return this;const t={};for(const i of Object.keys(this.values))t[i]=this.values[i]===0?0:-this.values[i];return Y0(this,{values:t},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(t){if(!this.isValid||!t.isValid||!this.loc.equals(t.loc))return!1;function i(r,s){return r===void 0||r===0?s===void 0||s===0:r===s}for(const r of qv)if(!i(this.values[r],t.values[r]))return!1;return!0}}const E2="Invalid Interval";function SFe(e,t){return!e||!e.isValid?ms.invalid("missing or invalid start"):!t||!t.isValid?ms.invalid("missing or invalid end"):t<e?ms.invalid("end before start",`The end of an interval must be after its start, but you had start=${e.toISO()} and end=${t.toISO()}`):null}class ms{constructor(t){this.s=t.start,this.e=t.end,this.invalid=t.invalid||null,this.isLuxonInterval=!0}static invalid(t,i=null){if(!t)throw new gu("need to specify a reason the Interval is invalid");const r=t instanceof Bh?t:new Bh(t,i);if(hn.throwOnInvalid)throw new ZLe(r);return new ms({invalid:r})}static fromDateTimes(t,i){const r=R2(t),s=R2(i),n=SFe(r,s);return n==null?new ms({start:r,end:s}):n}static after(t,i){const r=$i.fromDurationLike(i),s=R2(t);return ms.fromDateTimes(s,s.plus(r))}static before(t,i){const r=$i.fromDurationLike(i),s=R2(t);return ms.fromDateTimes(s.minus(r),s)}static fromISO(t,i){const[r,s]=(t||"").split("/",2);if(r&&s){let n,o;try{n=Bt.fromISO(r,i),o=n.isValid}catch{o=!1}let a,l;try{a=Bt.fromISO(s,i),l=a.isValid}catch{l=!1}if(o&&l)return ms.fromDateTimes(n,a);if(o){const c=$i.fromISO(s,i);if(c.isValid)return ms.after(n,c)}else if(l){const c=$i.fromISO(r,i);if(c.isValid)return ms.before(a,c)}}return ms.invalid("unparsable",`the input "${t}" can't be parsed as ISO 8601`)}static isInterval(t){return t&&t.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(t="milliseconds"){return this.isValid?this.toDuration(t).get(t):NaN}count(t="milliseconds"){if(!this.isValid)return NaN;const i=this.start.startOf(t),r=this.end.startOf(t);return Math.floor(r.diff(i,t).get(t))+1}hasSame(t){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,t):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(t){return this.isValid?this.s>t:!1}isBefore(t){return this.isValid?this.e<=t:!1}contains(t){return this.isValid?this.s<=t&&this.e>t:!1}set({start:t,end:i}={}){return this.isValid?ms.fromDateTimes(t||this.s,i||this.e):this}splitAt(...t){if(!this.isValid)return[];const i=t.map(R2).filter(o=>this.contains(o)).sort(),r=[];let{s}=this,n=0;for(;s<this.e;){const o=i[n]||this.e,a=+o>+this.e?this.e:o;r.push(ms.fromDateTimes(s,a)),s=a,n+=1}return r}splitBy(t){const i=$i.fromDurationLike(t);if(!this.isValid||!i.isValid||i.as("milliseconds")===0)return[];let{s:r}=this,s=1,n;const o=[];for(;r<this.e;){const a=this.start.plus(i.mapUnits(l=>l*s));n=+a>+this.e?this.e:a,o.push(ms.fromDateTimes(r,n)),r=n,s+=1}return o}divideEqually(t){return this.isValid?this.splitBy(this.length()/t).slice(0,t):[]}overlaps(t){return this.e>t.s&&this.s<t.e}abutsStart(t){return this.isValid?+this.e==+t.s:!1}abutsEnd(t){return this.isValid?+t.e==+this.s:!1}engulfs(t){return this.isValid?this.s<=t.s&&this.e>=t.e:!1}equals(t){return!this.isValid||!t.isValid?!1:this.s.equals(t.s)&&this.e.equals(t.e)}intersection(t){if(!this.isValid)return this;const i=this.s>t.s?this.s:t.s,r=this.e<t.e?this.e:t.e;return i>=r?null:ms.fromDateTimes(i,r)}union(t){if(!this.isValid)return this;const i=this.s<t.s?this.s:t.s,r=this.e>t.e?this.e:t.e;return ms.fromDateTimes(i,r)}static merge(t){const[i,r]=t.sort((s,n)=>s.s-n.s).reduce(([s,n],o)=>n?n.overlaps(o)||n.abutsStart(o)?[s,n.union(o)]:[s.concat([n]),o]:[s,o],[[],null]);return r&&i.push(r),i}static xor(t){let i=null,r=0;const s=[],n=t.map(l=>[{time:l.s,type:"s"},{time:l.e,type:"e"}]),o=Array.prototype.concat(...n),a=o.sort((l,c)=>l.time-c.time);for(const l of a)r+=l.type==="s"?1:-1,r===1?i=l.time:(i&&+i!=+l.time&&s.push(ms.fromDateTimes(i,l.time)),i=null);return ms.merge(s)}difference(...t){return ms.xor([this].concat(t)).map(i=>this.intersection(i)).filter(i=>i&&!i.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()} \u2013 ${this.e.toISO()})`:E2}toISO(t){return this.isValid?`${this.s.toISO(t)}/${this.e.toISO(t)}`:E2}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:E2}toISOTime(t){return this.isValid?`${this.s.toISOTime(t)}/${this.e.toISOTime(t)}`:E2}toFormat(t,{separator:i=" \u2013 "}={}){return this.isValid?`${this.s.toFormat(t)}${i}${this.e.toFormat(t)}`:E2}toDuration(t,i){return this.isValid?this.e.diff(this.s,t,i):$i.invalid(this.invalidReason)}mapEndpoints(t){return ms.fromDateTimes(t(this.s),t(this.e))}}class NM{static hasDST(t=hn.defaultZone){const i=Bt.now().setZone(t).set({month:12});return!t.isUniversal&&i.offset!==i.set({month:6}).offset}static isValidIANAZone(t){return Pm.isValidZone(t)}static normalizeZone(t){return My(t,hn.defaultZone)}static months(t="long",{locale:i=null,numberingSystem:r=null,locObj:s=null,outputCalendar:n="gregory"}={}){return(s||ss.create(i,r,n)).months(t)}static monthsFormat(t="long",{locale:i=null,numberingSystem:r=null,locObj:s=null,outputCalendar:n="gregory"}={}){return(s||ss.create(i,r,n)).months(t,!0)}static weekdays(t="long",{locale:i=null,numberingSystem:r=null,locObj:s=null}={}){return(s||ss.create(i,r,null)).weekdays(t)}static weekdaysFormat(t="long",{locale:i=null,numberingSystem:r=null,locObj:s=null}={}){return(s||ss.create(i,r,null)).weekdays(t,!0)}static meridiems({locale:t=null}={}){return ss.create(t).meridiems()}static eras(t="short",{locale:i=null}={}){return ss.create(i,null,"gregory").eras(t)}static features(){return{relative:Ape()}}}function QQ(e,t){const i=s=>s.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),r=i(t)-i(e);return Math.floor($i.fromMillis(r).as("days"))}function EFe(e,t,i){const r=[["years",(a,l)=>l.year-a.year],["quarters",(a,l)=>l.quarter-a.quarter],["months",(a,l)=>l.month-a.month+(l.year-a.year)*12],["weeks",(a,l)=>{const c=QQ(a,l);return(c-c%7)/7}],["days",QQ]],s={};let n,o;for(const[a,l]of r)if(i.indexOf(a)>=0){n=a;let c=l(e,t);o=e.plus({[a]:c}),o>t?(e=e.plus({[a]:c-1}),c-=1):e=o,s[a]=c}return[e,s,o,n]}function AFe(e,t,i,r){let[s,n,o,a]=EFe(e,t,i);const l=t-s,c=i.filter(p=>["hours","minutes","seconds","milliseconds"].indexOf(p)>=0);c.length===0&&(o<t&&(o=s.plus({[a]:1})),o!==s&&(n[a]=(n[a]||0)+l/(o-s)));const h=$i.fromObject(n,r);return c.length>0?$i.fromMillis(l,r).shiftTo(...c).plus(h):h}const MH={arab:"[\u0660-\u0669]",arabext:"[\u06F0-\u06F9]",bali:"[\u1B50-\u1B59]",beng:"[\u09E6-\u09EF]",deva:"[\u0966-\u096F]",fullwide:"[\uFF10-\uFF19]",gujr:"[\u0AE6-\u0AEF]",hanidec:"[\u3007|\u4E00|\u4E8C|\u4E09|\u56DB|\u4E94|\u516D|\u4E03|\u516B|\u4E5D]",khmr:"[\u17E0-\u17E9]",knda:"[\u0CE6-\u0CEF]",laoo:"[\u0ED0-\u0ED9]",limb:"[\u1946-\u194F]",mlym:"[\u0D66-\u0D6F]",mong:"[\u1810-\u1819]",mymr:"[\u1040-\u1049]",orya:"[\u0B66-\u0B6F]",tamldec:"[\u0BE6-\u0BEF]",telu:"[\u0C66-\u0C6F]",thai:"[\u0E50-\u0E59]",tibt:"[\u0F20-\u0F29]",latn:"\\d"},JQ={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},CFe=MH.hanidec.replace(/[\[|\]]/g,"").split("");function RFe(e){let t=parseInt(e,10);if(isNaN(t)){t="";for(let i=0;i<e.length;i++){const r=e.charCodeAt(i);if(e[i].search(MH.hanidec)!==-1)t+=CFe.indexOf(e[i]);else for(const s in JQ){const[n,o]=JQ[s];r>=n&&r<=o&&(t+=r-n)}}return parseInt(t,10)}else return t}function Xu({numberingSystem:e},t=""){return new RegExp(`${MH[e||"latn"]}${t}`)}const OFe="missing Intl.DateTimeFormat.formatToParts support";function Hi(e,t=i=>i){return{regex:e,deser:([i])=>t(RFe(i))}}const MFe=String.fromCharCode(160),jpe=`( |${MFe})`,Hpe=new RegExp(jpe,"g");function PFe(e){return e.replace(/\./g,"\\.?").replace(Hpe,jpe)}function KQ(e){return e.replace(/\./g,"").replace(Hpe," ").toLowerCase()}function Yu(e,t){return e===null?null:{regex:RegExp(e.map(PFe).join("|")),deser:([i])=>e.findIndex(r=>KQ(i)===KQ(r))+t}}function eJ(e,t){return{regex:e,deser:([,i,r])=>AF(i,r),groups:t}}function oU(e){return{regex:e,deser:([t])=>t}}function IFe(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function $Fe(e,t){const i=Xu(t),r=Xu(t,"{2}"),s=Xu(t,"{3}"),n=Xu(t,"{4}"),o=Xu(t,"{6}"),a=Xu(t,"{1,2}"),l=Xu(t,"{1,3}"),c=Xu(t,"{1,6}"),h=Xu(t,"{1,9}"),p=Xu(t,"{2,4}"),f=Xu(t,"{4,6}"),g=b=>({regex:RegExp(IFe(b.val)),deser:([w])=>w,literal:!0}),v=(b=>{if(e.literal)return g(b);switch(b.val){case"G":return Yu(t.eras("short",!1),0);case"GG":return Yu(t.eras("long",!1),0);case"y":return Hi(c);case"yy":return Hi(p,ZV);case"yyyy":return Hi(n);case"yyyyy":return Hi(f);case"yyyyyy":return Hi(o);case"M":return Hi(a);case"MM":return Hi(r);case"MMM":return Yu(t.months("short",!0,!1),1);case"MMMM":return Yu(t.months("long",!0,!1),1);case"L":return Hi(a);case"LL":return Hi(r);case"LLL":return Yu(t.months("short",!1,!1),1);case"LLLL":return Yu(t.months("long",!1,!1),1);case"d":return Hi(a);case"dd":return Hi(r);case"o":return Hi(l);case"ooo":return Hi(s);case"HH":return Hi(r);case"H":return Hi(a);case"hh":return Hi(r);case"h":return Hi(a);case"mm":return Hi(r);case"m":return Hi(a);case"q":return Hi(a);case"qq":return Hi(r);case"s":return Hi(a);case"ss":return Hi(r);case"S":return Hi(l);case"SSS":return Hi(s);case"u":return oU(h);case"uu":return oU(a);case"uuu":return Hi(i);case"a":return Yu(t.meridiems(),0);case"kkkk":return Hi(n);case"kk":return Hi(p,ZV);case"W":return Hi(a);case"WW":return Hi(r);case"E":case"c":return Hi(i);case"EEE":return Yu(t.weekdays("short",!1,!1),1);case"EEEE":return Yu(t.weekdays("long",!1,!1),1);case"ccc":return Yu(t.weekdays("short",!0,!1),1);case"cccc":return Yu(t.weekdays("long",!0,!1),1);case"Z":case"ZZ":return eJ(new RegExp(`([+-]${a.source})(?::(${r.source}))?`),2);case"ZZZ":return eJ(new RegExp(`([+-]${a.source})(${r.source})?`),2);case"z":return oU(/[a-z_+-/]{1,256}?/i);default:return g(b)}})(e)||{invalidReason:OFe};return v.token=e,v}const DFe={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour:{numeric:"h","2-digit":"hh"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"}};function LFe(e,t,i){const{type:r,value:s}=e;if(r==="literal")return{literal:!0,val:s};const n=i[r];let o=DFe[r];if(typeof o=="object"&&(o=o[n]),o)return{literal:!1,val:o}}function NFe(e){return[`^${e.map(i=>i.regex).reduce((i,r)=>`${i}(${r.source})`,"")}$`,e]}function FFe(e,t,i){const r=e.match(t);if(r){const s={};let n=1;for(const o in i)if(QT(i,o)){const a=i[o],l=a.groups?a.groups+1:1;!a.literal&&a.token&&(s[a.token.val[0]]=a.deser(r.slice(n,n+l))),n+=l}return[r,s]}else return[r,{}]}function UFe(e){const t=n=>{switch(n){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let i=null,r;return Ci(e.z)||(i=Pm.create(e.z)),Ci(e.Z)||(i||(i=new wa(e.Z)),r=e.Z),Ci(e.q)||(e.M=(e.q-1)*3+1),Ci(e.h)||(e.h<12&&e.a===1?e.h+=12:e.h===12&&e.a===0&&(e.h=0)),e.G===0&&e.y&&(e.y=-e.y),Ci(e.u)||(e.S=TH(e.u)),[Object.keys(e).reduce((n,o)=>{const a=t(o);return a&&(n[a]=e[o]),n},{}),i,r]}let aU=null;function kFe(){return aU||(aU=Bt.fromMillis(1555555555555)),aU}function zFe(e,t){if(e.literal)return e;const i=ul.macroTokenToFormatOpts(e.val);if(!i)return e;const n=ul.create(t,i).formatDateTimeParts(kFe()).map(o=>LFe(o,t,i));return n.includes(void 0)?e:n}function BFe(e,t){return Array.prototype.concat(...e.map(i=>zFe(i,t)))}function qpe(e,t,i){const r=BFe(ul.parseFormat(i),e),s=r.map(o=>$Fe(o,e)),n=s.find(o=>o.invalidReason);if(n)return{input:t,tokens:r,invalidReason:n.invalidReason};{const[o,a]=NFe(s),l=RegExp(o,"i"),[c,h]=FFe(t,l,a),[p,f,g]=h?UFe(h):[null,null,void 0];if(QT(h,"a")&&QT(h,"H"))throw new KE("Can't include meridiem when specifying 24-hour format");return{input:t,tokens:r,regex:l,rawMatches:c,matches:h,result:p,zone:f,specificOffset:g}}}function VFe(e,t,i){const{result:r,zone:s,specificOffset:n,invalidReason:o}=qpe(e,t,i);return[r,s,n,o]}const Wpe=[0,31,59,90,120,151,181,212,243,273,304,334],Xpe=[0,31,60,91,121,152,182,213,244,274,305,335];function Cu(e,t){return new Bh("unit out of range",`you specified ${t} (of type ${typeof t}) as a ${e}, which is invalid`)}function Ype(e,t,i){const r=new Date(Date.UTC(e,t-1,i)).getUTCDay();return r===0?7:r}function Zpe(e,t,i){return i+(_O(e)?Xpe:Wpe)[t-1]}function Qpe(e,t){const i=_O(e)?Xpe:Wpe,r=i.findIndex(n=>n<t),s=t-i[r];return{month:r+1,day:s}}function t8(e){const{year:t,month:i,day:r}=e,s=Zpe(t,i,r),n=Ype(t,i,r);let o=Math.floor((s-n+10)/7),a;return o<1?(a=t-1,o=nL(a)):o>nL(t)?(a=t+1,o=1):a=t,I({weekYear:a,weekNumber:o,weekday:n},CF(e))}function tJ(e){const{weekYear:t,weekNumber:i,weekday:r}=e,s=Ype(t,1,4),n=rC(t);let o=i*7+r-s-3,a;o<1?(a=t-1,o+=rC(a)):o>n?(a=t+1,o-=rC(t)):a=t;const{month:l,day:c}=Qpe(a,o);return I({year:a,month:l,day:c},CF(e))}function lU(e){const{year:t,month:i,day:r}=e,s=Zpe(t,i,r);return I({year:t,ordinal:s},CF(e))}function iJ(e){const{year:t,ordinal:i}=e,{month:r,day:s}=Qpe(t,i);return I({year:t,month:r,day:s},CF(e))}function GFe(e){const t=EF(e.weekYear),i=lm(e.weekNumber,1,nL(e.weekYear)),r=lm(e.weekday,1,7);return t?i?r?!1:Cu("weekday",e.weekday):Cu("week",e.week):Cu("weekYear",e.weekYear)}function jFe(e){const t=EF(e.year),i=lm(e.ordinal,1,rC(e.year));return t?i?!1:Cu("ordinal",e.ordinal):Cu("year",e.year)}function Jpe(e){const t=EF(e.year),i=lm(e.month,1,12),r=lm(e.day,1,sL(e.year,e.month));return t?i?r?!1:Cu("day",e.day):Cu("month",e.month):Cu("year",e.year)}function Kpe(e){const{hour:t,minute:i,second:r,millisecond:s}=e,n=lm(t,0,23)||t===24&&i===0&&r===0&&s===0,o=lm(i,0,59),a=lm(r,0,59),l=lm(s,0,999);return n?o?a?l?!1:Cu("millisecond",s):Cu("second",r):Cu("minute",i):Cu("hour",t)}const cU="Invalid DateTime",rJ=864e13;function FM(e){return new Bh("unsupported zone",`the zone "${e.name}" is not supported`)}function uU(e){return e.weekData===null&&(e.weekData=t8(e.c)),e.weekData}function A2(e,t){const i={ts:e.ts,zone:e.zone,c:e.c,o:e.o,loc:e.loc,invalid:e.invalid};return new Bt(me(I(I({},i),t),{old:i}))}function efe(e,t,i){let r=e-t*60*1e3;const s=i.offset(r);if(t===s)return[r,t];r-=(s-t)*60*1e3;const n=i.offset(r);return s===n?[r,s]:[e-Math.min(s,n)*60*1e3,Math.max(s,n)]}function sJ(e,t){e+=t*60*1e3;const i=new Date(e);return{year:i.getUTCFullYear(),month:i.getUTCMonth()+1,day:i.getUTCDate(),hour:i.getUTCHours(),minute:i.getUTCMinutes(),second:i.getUTCSeconds(),millisecond:i.getUTCMilliseconds()}}function II(e,t,i){return efe(EH(e),t,i)}function nJ(e,t){const i=e.o,r=e.c.year+Math.trunc(t.years),s=e.c.month+Math.trunc(t.months)+Math.trunc(t.quarters)*3,n=me(I({},e.c),{year:r,month:s,day:Math.min(e.c.day,sL(r,s))+Math.trunc(t.days)+Math.trunc(t.weeks)*7}),o=$i.fromObject({years:t.years-Math.trunc(t.years),quarters:t.quarters-Math.trunc(t.quarters),months:t.months-Math.trunc(t.months),weeks:t.weeks-Math.trunc(t.weeks),days:t.days-Math.trunc(t.days),hours:t.hours,minutes:t.minutes,seconds:t.seconds,milliseconds:t.milliseconds}).as("milliseconds"),a=EH(n);let[l,c]=efe(a,i,e.zone);return o!==0&&(l+=o,c=e.zone.offset(l)),{ts:l,o:c}}function C2(e,t,i,r,s,n){const{setZone:o,zone:a}=i;if(e&&Object.keys(e).length!==0){const l=t||a,c=Bt.fromObject(e,me(I({},i),{zone:l,specificOffset:n}));return o?c:c.setZone(a)}else return Bt.invalid(new Bh("unparsable",`the input "${s}" can't be parsed as ${r}`))}function UM(e,t,i=!0){return e.isValid?ul.create(ss.create("en-US"),{allowZ:i,forceSimple:!0}).formatDateTimeFromString(e,t):null}function hU(e,t){const i=e.c.year>9999||e.c.year<0;let r="";return i&&e.c.year>=0&&(r+="+"),r+=Ys(e.c.year,i?6:4),t?(r+="-",r+=Ys(e.c.month),r+="-",r+=Ys(e.c.day)):(r+=Ys(e.c.month),r+=Ys(e.c.day)),r}function oJ(e,t,i,r,s){let n=Ys(e.c.hour);return t?(n+=":",n+=Ys(e.c.minute),(e.c.second!==0||!i)&&(n+=":")):n+=Ys(e.c.minute),(e.c.second!==0||!i)&&(n+=Ys(e.c.second),(e.c.millisecond!==0||!r)&&(n+=".",n+=Ys(e.c.millisecond,3))),s&&(e.isOffsetFixed&&e.offset===0?n+="Z":e.o<0?(n+="-",n+=Ys(Math.trunc(-e.o/60)),n+=":",n+=Ys(Math.trunc(-e.o%60))):(n+="+",n+=Ys(Math.trunc(e.o/60)),n+=":",n+=Ys(Math.trunc(e.o%60)))),n}const tfe={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},HFe={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},qFe={ordinal:1,hour:0,minute:0,second:0,millisecond:0},ife=["year","month","day","hour","minute","second","millisecond"],WFe=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],XFe=["year","ordinal","hour","minute","second","millisecond"];function aJ(e){const t={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[e.toLowerCase()];if(!t)throw new ope(e);return t}function lJ(e,t){const i=My(t.zone,hn.defaultZone),r=ss.fromObject(t),s=hn.now();let n,o;if(Ci(e.year))n=s;else{for(const c of ife)Ci(e[c])&&(e[c]=tfe[c]);const a=Jpe(e)||Kpe(e);if(a)return Bt.invalid(a);const l=i.offset(s);[n,o]=II(e,l,i)}return new Bt({ts:n,zone:i,loc:r,o})}function cJ(e,t,i){const r=Ci(i.round)?!0:i.round,s=(o,a)=>(o=SH(o,r||i.calendary?0:2,!0),t.loc.clone(i).relFormatter(i).format(o,a)),n=o=>i.calendary?t.hasSame(e,o)?0:t.startOf(o).diff(e.startOf(o),o).get(o):t.diff(e,o).get(o);if(i.unit)return s(n(i.unit),i.unit);for(const o of i.units){const a=n(o);if(Math.abs(a)>=1)return s(a,o)}return s(e>t?-0:0,i.units[i.units.length-1])}function uJ(e){let t={},i;return e.length>0&&typeof e[e.length-1]=="object"?(t=e[e.length-1],i=Array.from(e).slice(0,e.length-1)):i=Array.from(e),[t,i]}class Bt{constructor(t){const i=t.zone||hn.defaultZone;let r=t.invalid||(Number.isNaN(t.ts)?new Bh("invalid input"):null)||(i.isValid?null:FM(i));this.ts=Ci(t.ts)?hn.now():t.ts;let s=null,n=null;if(!r)if(t.old&&t.old.ts===this.ts&&t.old.zone.equals(i))[s,n]=[t.old.c,t.old.o];else{const a=i.offset(this.ts);s=sJ(this.ts,a),r=Number.isNaN(s.year)?new Bh("invalid input"):null,s=r?null:s,n=r?null:a}this._zone=i,this.loc=t.loc||ss.create(),this.invalid=r,this.weekData=null,this.c=s,this.o=n,this.isLuxonDateTime=!0}static now(){return new Bt({})}static local(){const[t,i]=uJ(arguments),[r,s,n,o,a,l,c]=i;return lJ({year:r,month:s,day:n,hour:o,minute:a,second:l,millisecond:c},t)}static utc(){const[t,i]=uJ(arguments),[r,s,n,o,a,l,c]=i;return t.zone=wa.utcInstance,lJ({year:r,month:s,day:n,hour:o,minute:a,second:l,millisecond:c},t)}static fromJSDate(t,i={}){const r=tNe(t)?t.valueOf():NaN;if(Number.isNaN(r))return Bt.invalid("invalid input");const s=My(i.zone,hn.defaultZone);return s.isValid?new Bt({ts:r,zone:s,loc:ss.fromObject(i)}):Bt.invalid(FM(s))}static fromMillis(t,i={}){if(p1(t))return t<-rJ||t>rJ?Bt.invalid("Timestamp out of range"):new Bt({ts:t,zone:My(i.zone,hn.defaultZone),loc:ss.fromObject(i)});throw new gu(`fromMillis requires a numerical input, but received a ${typeof t} with value ${t}`)}static fromSeconds(t,i={}){if(p1(t))return new Bt({ts:t*1e3,zone:My(i.zone,hn.defaultZone),loc:ss.fromObject(i)});throw new gu("fromSeconds requires a numerical input")}static fromObject(t,i={}){t=t||{};const r=My(i.zone,hn.defaultZone);if(!r.isValid)return Bt.invalid(FM(r));const s=hn.now(),n=Ci(i.specificOffset)?r.offset(s):i.specificOffset,o=oL(t,aJ),a=!Ci(o.ordinal),l=!Ci(o.year),c=!Ci(o.month)||!Ci(o.day),h=l||c,p=o.weekYear||o.weekNumber,f=ss.fromObject(i);if((h||a)&&p)throw new KE("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(c&&a)throw new KE("Can't mix ordinal dates with month/day");const g=p||o.weekday&&!h;let y,v,b=sJ(s,n);g?(y=WFe,v=HFe,b=t8(b)):a?(y=XFe,v=qFe,b=lU(b)):(y=ife,v=tfe);let w=!1;for(const U of y){const N=o[U];Ci(N)?w?o[U]=v[U]:o[U]=b[U]:w=!0}const S=g?GFe(o):a?jFe(o):Jpe(o),T=S||Kpe(o);if(T)return Bt.invalid(T);const A=g?tJ(o):a?iJ(o):o,[C,O]=II(A,n,r),L=new Bt({ts:C,zone:r,o:O,loc:f});return o.weekday&&h&&t.weekday!==L.weekday?Bt.invalid("mismatched weekday",`you can't specify both a weekday of ${o.weekday} and a date of ${L.toISO()}`):L}static fromISO(t,i={}){const[r,s]=aFe(t);return C2(r,s,i,"ISO 8601",t)}static fromRFC2822(t,i={}){const[r,s]=lFe(t);return C2(r,s,i,"RFC 2822",t)}static fromHTTP(t,i={}){const[r,s]=cFe(t);return C2(r,s,i,"HTTP",i)}static fromFormat(t,i,r={}){if(Ci(t)||Ci(i))throw new gu("fromFormat requires an input string and a format");const{locale:s=null,numberingSystem:n=null}=r,o=ss.fromOpts({locale:s,numberingSystem:n,defaultToEN:!0}),[a,l,c,h]=VFe(o,t,i);return h?Bt.invalid(h):C2(a,l,r,`format ${i}`,t,c)}static fromString(t,i,r={}){return Bt.fromFormat(t,i,r)}static fromSQL(t,i={}){const[r,s]=yFe(t);return C2(r,s,i,"SQL",t)}static invalid(t,i=null){if(!t)throw new gu("need to specify a reason the DateTime is invalid");const r=t instanceof Bh?t:new Bh(t,i);if(hn.throwOnInvalid)throw new YLe(r);return new Bt({invalid:r})}static isDateTime(t){return t&&t.isLuxonDateTime||!1}get(t){return this[t]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?uU(this).weekYear:NaN}get weekNumber(){return this.isValid?uU(this).weekNumber:NaN}get weekday(){return this.isValid?uU(this).weekday:NaN}get ordinal(){return this.isValid?lU(this.c).ordinal:NaN}get monthShort(){return this.isValid?NM.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?NM.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?NM.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?NM.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1}).offset||this.offset>this.set({month:5}).offset}get isInLeapYear(){return _O(this.year)}get daysInMonth(){return sL(this.year,this.month)}get daysInYear(){return this.isValid?rC(this.year):NaN}get weeksInWeekYear(){return this.isValid?nL(this.weekYear):NaN}resolvedLocaleOptions(t={}){const{locale:i,numberingSystem:r,calendar:s}=ul.create(this.loc.clone(t),t).resolvedOptions(this);return{locale:i,numberingSystem:r,outputCalendar:s}}toUTC(t=0,i={}){return this.setZone(wa.instance(t),i)}toLocal(){return this.setZone(hn.defaultZone)}setZone(t,{keepLocalTime:i=!1,keepCalendarTime:r=!1}={}){if(t=My(t,hn.defaultZone),t.equals(this.zone))return this;if(t.isValid){let s=this.ts;if(i||r){const n=t.offset(this.ts),o=this.toObject();[s]=II(o,n,t)}return A2(this,{ts:s,zone:t})}else return Bt.invalid(FM(t))}reconfigure({locale:t,numberingSystem:i,outputCalendar:r}={}){const s=this.loc.clone({locale:t,numberingSystem:i,outputCalendar:r});return A2(this,{loc:s})}setLocale(t){return this.reconfigure({locale:t})}set(t){if(!this.isValid)return this;const i=oL(t,aJ),r=!Ci(i.weekYear)||!Ci(i.weekNumber)||!Ci(i.weekday),s=!Ci(i.ordinal),n=!Ci(i.year),o=!Ci(i.month)||!Ci(i.day),a=n||o,l=i.weekYear||i.weekNumber;if((a||s)&&l)throw new KE("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(o&&s)throw new KE("Can't mix ordinal dates with month/day");let c;r?c=tJ(I(I({},t8(this.c)),i)):Ci(i.ordinal)?(c=I(I({},this.toObject()),i),Ci(i.day)&&(c.day=Math.min(sL(c.year,c.month),c.day))):c=iJ(I(I({},lU(this.c)),i));const[h,p]=II(c,this.o,this.zone);return A2(this,{ts:h,o:p})}plus(t){if(!this.isValid)return this;const i=$i.fromDurationLike(t);return A2(this,nJ(this,i))}minus(t){if(!this.isValid)return this;const i=$i.fromDurationLike(t).negate();return A2(this,nJ(this,i))}startOf(t){if(!this.isValid)return this;const i={},r=$i.normalizeUnit(t);switch(r){case"years":i.month=1;case"quarters":case"months":i.day=1;case"weeks":case"days":i.hour=0;case"hours":i.minute=0;case"minutes":i.second=0;case"seconds":i.millisecond=0;break}if(r==="weeks"&&(i.weekday=1),r==="quarters"){const s=Math.ceil(this.month/3);i.month=(s-1)*3+1}return this.set(i)}endOf(t){return this.isValid?this.plus({[t]:1}).startOf(t).minus(1):this}toFormat(t,i={}){return this.isValid?ul.create(this.loc.redefaultToEN(i)).formatDateTimeFromString(this,t):cU}toLocaleString(t=YV,i={}){return this.isValid?ul.create(this.loc.clone(i),t).formatDateTime(this):cU}toLocaleParts(t={}){return this.isValid?ul.create(this.loc.clone(t),t).formatDateTimeParts(this):[]}toISO({format:t="extended",suppressSeconds:i=!1,suppressMilliseconds:r=!1,includeOffset:s=!0}={}){if(!this.isValid)return null;const n=t==="extended";let o=hU(this,n);return o+="T",o+=oJ(this,n,i,r,s),o}toISODate({format:t="extended"}={}){return this.isValid?hU(this,t==="extended"):null}toISOWeekDate(){return UM(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:t=!1,suppressSeconds:i=!1,includeOffset:r=!0,includePrefix:s=!1,format:n="extended"}={}){return this.isValid?(s?"T":"")+oJ(this,n==="extended",i,t,r):null}toRFC2822(){return UM(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return UM(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?hU(this,!0):null}toSQLTime({includeOffset:t=!0,includeZone:i=!1,includeOffsetSpace:r=!0}={}){let s="HH:mm:ss.SSS";return(i||t)&&(r&&(s+=" "),i?s+="z":t&&(s+="ZZ")),UM(this,s,!0)}toSQL(t={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(t)}`:null}toString(){return this.isValid?this.toISO():cU}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(t={}){if(!this.isValid)return{};const i=I({},this.c);return t.includeConfig&&(i.outputCalendar=this.outputCalendar,i.numberingSystem=this.loc.numberingSystem,i.locale=this.loc.locale),i}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(t,i="milliseconds",r={}){if(!this.isValid||!t.isValid)return $i.invalid("created by diffing an invalid DateTime");const s=I({locale:this.locale,numberingSystem:this.numberingSystem},r),n=iNe(i).map($i.normalizeUnit),o=t.valueOf()>this.valueOf(),a=o?this:t,l=o?t:this,c=AFe(a,l,n,s);return o?c.negate():c}diffNow(t="milliseconds",i={}){return this.diff(Bt.now(),t,i)}until(t){return this.isValid?ms.fromDateTimes(this,t):this}hasSame(t,i){if(!this.isValid)return!1;const r=t.valueOf(),s=this.setZone(t.zone,{keepLocalTime:!0});return s.startOf(i)<=r&&r<=s.endOf(i)}equals(t){return this.isValid&&t.isValid&&this.valueOf()===t.valueOf()&&this.zone.equals(t.zone)&&this.loc.equals(t.loc)}toRelative(t={}){if(!this.isValid)return null;const i=t.base||Bt.fromObject({},{zone:this.zone}),r=t.padding?this<i?-t.padding:t.padding:0;let s=["years","months","days","hours","minutes","seconds"],n=t.unit;return Array.isArray(t.unit)&&(s=t.unit,n=void 0),cJ(i,this.plus(r),me(I({},t),{numeric:"always",units:s,unit:n}))}toRelativeCalendar(t={}){return this.isValid?cJ(t.base||Bt.fromObject({},{zone:this.zone}),this,me(I({},t),{numeric:"auto",units:["years","months","days"],calendary:!0})):null}static min(...t){if(!t.every(Bt.isDateTime))throw new gu("min requires all arguments be DateTimes");return BQ(t,i=>i.valueOf(),Math.min)}static max(...t){if(!t.every(Bt.isDateTime))throw new gu("max requires all arguments be DateTimes");return BQ(t,i=>i.valueOf(),Math.max)}static fromFormatExplain(t,i,r={}){const{locale:s=null,numberingSystem:n=null}=r,o=ss.fromOpts({locale:s,numberingSystem:n,defaultToEN:!0});return qpe(o,t,i)}static fromStringExplain(t,i,r={}){return Bt.fromFormatExplain(t,i,r)}static get DATE_SHORT(){return YV}static get DATE_MED(){return ape}static get DATE_MED_WITH_WEEKDAY(){return JLe}static get DATE_FULL(){return lpe}static get DATE_HUGE(){return cpe}static get TIME_SIMPLE(){return upe}static get TIME_WITH_SECONDS(){return hpe}static get TIME_WITH_SHORT_OFFSET(){return dpe}static get TIME_WITH_LONG_OFFSET(){return ppe}static get TIME_24_SIMPLE(){return fpe}static get TIME_24_WITH_SECONDS(){return mpe}static get TIME_24_WITH_SHORT_OFFSET(){return gpe}static get TIME_24_WITH_LONG_OFFSET(){return ype}static get DATETIME_SHORT(){return vpe}static get DATETIME_SHORT_WITH_SECONDS(){return _pe}static get DATETIME_MED(){return bpe}static get DATETIME_MED_WITH_SECONDS(){return wpe}static get DATETIME_MED_WITH_WEEKDAY(){return KLe}static get DATETIME_FULL(){return xpe}static get DATETIME_FULL_WITH_SECONDS(){return Tpe}static get DATETIME_HUGE(){return Spe}static get DATETIME_HUGE_WITH_SECONDS(){return Epe}}function R2(e){if(Bt.isDateTime(e))return e;if(e&&e.valueOf&&p1(e.valueOf()))return Bt.fromJSDate(e);if(e&&typeof e=="object")return Bt.fromObject(e);throw new gu(`Unknown datetime argument: ${e}, of type ${typeof e}`)}const dU={ar:[".",","],bg:[",","\xA0"],bs:[",","."],ca:[",","."],cs:[",","\xA0"],da:[",","."],de:[",","."],"de-ch":[".","\u2019"],el:[",","."],en:[".",","],"en-au":[".",","],es:[",","."],"es-mx":[".",","],et:[",","\xA0"],fi:[",","\xA0"],fr:[",","\u202F"],"fr-ch":[",","\u202F"],he:[".",","],hi:[".",",","#,##,##0.###"],hr:[",","."],hu:[",","\xA0"],id:[",","."],it:[",","."],"it-ch":[".","\u2019"],ja:[".",","],ko:[".",","],lt:[",","\xA0"],lv:[",","\xA0"],mk:[",","."],nb:[",","\xA0"],nl:[",","."],pl:[",","\xA0"],pt:[",","."],"pt-pt":[",","\xA0"],ro:[",","."],ru:[",","\xA0"],sk:[",","\xA0"],sl:[",","."],sr:[",","."],sv:[",","\xA0"],th:[".",","],tr:[",","."],uk:[",","\xA0"],vi:[",","."],zh:[".",","]};function rfe(e){e||(e=dc());let t=e in dU;if(!t){const n=e.split("-");n.length>1&&n[0]in dU&&(e=n[0],t=!0),t||(e="en")}const[i,r,s="#,##0.###"]=dU[e];return{decimal:i,group:r,pattern:s}}function YFe(e,t){const i=rfe((t=I({},t)).locale);t.customs=i;const r=t.pattern||i.pattern;return isNaN(e)||Math.abs(e)===1/0?null:ZFe(e,r,t)}const sfe=/[#0,]*[#0](?:\.0*#*)?/;function ZFe(e,t,i){const r=(i=i||{}).customs.group,s=i.customs.decimal,n=t.split(";"),o=n[0];if((t=n[e<0?1:0]||"-"+o).indexOf("%")!==-1)e*=100;else if(t.indexOf("\u2030")!==-1)e*=1e3;else{if(t.indexOf("\xA4")!==-1)throw new Error("currency notation not supported");if(t.indexOf("E")!==-1)throw new Error("exponential notation not supported")}const a=sfe,l=o.match(a);if(!l)throw new Error("unable to find a number expression in pattern: "+t);return i.fractional===!1&&(i.places=0),t.replace(a,QFe(e,l[0],{decimal:s,group:r,places:i.places,round:i.round}))}function QFe(e,t,i){(i=i||{}).places===!0&&(i.places=0),i.places===1/0&&(i.places=6);const r=t.split("."),s=typeof i.places=="string"&&i.places.indexOf(",");let n=i.places;s?n=i.places.substring(s+1):n>=0||(n=(r[1]||[]).length),i.round<0||(e=Number(e.toFixed(Number(n))));const o=String(Math.abs(e)).split("."),a=o[1]||"";if(r[1]||i.places){s&&(i.places=i.places.substring(0,s));const y=i.places!==void 0?i.places:r[1]&&r[1].lastIndexOf("0")+1;y>a.length&&(o[1]=a.padEnd(Number(y),"0")),n<a.length&&(o[1]=a.substr(0,Number(n)))}else o[1]&&o.pop();const l=r[0].replace(",","");let c=l.indexOf("0");c!==-1&&(c=l.length-c,c>o[0].length&&(o[0]=o[0].padStart(c,"0")),l.indexOf("#")===-1&&(o[0]=o[0].substr(o[0].length-c)));let h,p,f=r[0].lastIndexOf(",");if(f!==-1){h=r[0].length-f-1;const y=r[0].substr(0,f);f=y.lastIndexOf(","),f!==-1&&(p=y.length-f-1)}const g=[];for(let y=o[0];y;){const v=y.length-h;g.push(v>0?y.substr(v):y),y=v>0?y.slice(0,v):"",p&&(h=p,p=void 0)}return o[0]=g.reverse().join(i.group||","),o.join(i.decimal||".")}function JFe(e){const t=rfe((e=e||{}).locale),i=e.pattern||t.pattern,r=t.group,s=t.decimal;let n=1;if(i.indexOf("%")!==-1)n/=100;else if(i.indexOf("\u2030")!==-1)n/=1e3;else if(i.indexOf("\xA4")!==-1)throw new Error("currency notation not supported");const o=i.split(";");return o.length===1&&o.push("-"+o[0]),{regexp:QC(o,function(l){return(l="(?:"+Ioe(l,".")+")").replace(sfe,function(c){const h={signed:!1,separator:e.strict?r:[r,""],fractional:e.fractional,decimal:s,exponent:!1},p=c.split(".");let f=e.places;p.length===1&&n!==1&&(p[1]="###"),p.length===1||f===0?h.fractional=!1:(f===void 0&&(f=e.pattern?p[1].lastIndexOf("0")+1:1/0),f&&e.fractional==null&&(h.fractional=!0),!e.places&&f<p[1].length&&(f+=","+p[1].length),h.places=f);const g=p[0].split(",");return g.length>1&&(h.groupSize=g.pop().length,g.length>1&&(h.groupSize2=g.pop().length)),"("+e4e(h)+")"})},!0).replace(/[\xa0 ]/g,"[\\s\\xa0]"),group:r,decimal:s,factor:n}}function KFe(e,t){const i=JFe(t),r=new RegExp("^"+i.regexp+"$").exec(e);if(!r)return NaN;let s=r[1];if(!r[1]){if(!r[2])return NaN;s=r[2],i.factor*=-1}return s=s.replace(new RegExp("["+i.group+"\\s\\xa0]","g"),"").replace(i.decimal,"."),Number(s)*i.factor}function e4e(e){"places"in(e=e||{})||(e.places=1/0),typeof e.decimal!="string"&&(e.decimal="."),"fractional"in e&&!/^0/.test(String(e.places))||(e.fractional=[!0,!1]),"exponent"in e||(e.exponent=[!0,!1]),"eSigned"in e||(e.eSigned=[!0,!1]);const t=hJ(e),i=QC(e.fractional,function(s){let n="";return s&&e.places!==0&&(n="\\"+e.decimal,e.places===1/0?n="(?:"+n+"\\d+)?":n+="\\d{"+e.places+"}"),n},!0);let r=t+i;return i&&(r="(?:(?:"+r+")|(?:"+i+"))"),r+QC(e.exponent,function(s){return s?"([eE]"+hJ({signed:e.eSigned})+")":""})}function hJ(e){return"signed"in(e=e||{})||(e.signed=[!0,!1]),"separator"in e?"groupSize"in e||(e.groupSize=3):e.separator="",QC(e.signed,function(t){return t?"[-+]":""},!0)+QC(e.separator,function(t){if(!t)return"(?:\\d+)";(t=Ioe(t))===" "?t="\\s":t==="\xA0"&&(t="\\s\\xa0");const i=e.groupSize,r=e.groupSize2;if(r){const s="(?:0|[1-9]\\d{0,"+(r-1)+"}(?:["+t+"]\\d{"+r+"})*["+t+"]\\d{"+i+"})";return i-r>0?"(?:"+s+"|(?:0|[1-9]\\d{0,"+(i-1)+"}))":s}return"(?:0|[1-9]\\d{0,"+(i-1)+"}(?:["+t+"]\\d{"+i+"})*)"},!0)}const QC=function(e,t,i){if(!(e instanceof Array))return t(e);const r=[];for(let s=0;s<e.length;s++)r.push(t(e[s]));return t4e(r.join("|"),i)},t4e=function(e,t){return"("+(t?"?:":"")+e+")"};var dJ,pJ;function Sgt(e){return gO.fromJSON(e.toJSON())}function i4e(e){return e.toJSON?e.toJSON():e}function Egt(e){return typeof e=="string"||e instanceof String}function Agt(e){return typeof e=="number"}function fJ(e){return e instanceof Date}function Cgt(e,t){return e===t||!(!fJ(e)||!fJ(t))&&e.getTime()===t.getTime()}function Rgt(e){if(e===void 0)return null;if(typeof e=="number")return e;switch(e.toLowerCase()){case"meters":case"meter":return 109404;case"miles":case"mile":return 109413;case"kilometers":case"kilometer":case"km":return 109414}return null}function Ogt(e){if(e===null)return null;switch(e.type){case"polygon":case"multipoint":case"polyline":return e.extent;case"point":return new Xt({xmin:e.x,ymin:e.y,xmax:e.x,ymax:e.y,spatialReference:e.spatialReference});case"extent":return e}return null}function Mgt(e){if(e===void 0)return null;if(typeof e=="number"||typeof e=="number")return e;switch(e.toLowerCase()){case"meters":case"meter":return 9001;case"miles":case"mile":return 9035;case"kilometers":case"kilometer":case"km":return 9036}return null}(function(e){e[e.Standardised=0]="Standardised",e[e.StandardisedNoInterval=1]="StandardisedNoInterval",e[e.SqlServer=2]="SqlServer",e[e.Oracle=3]="Oracle",e[e.Postgres=4]="Postgres",e[e.PGDB=5]="PGDB",e[e.FILEGDB=6]="FILEGDB",e[e.NotEvaluated=7]="NotEvaluated"})(dJ||(dJ={})),function(e){e[e.InFeatureSet=0]="InFeatureSet",e[e.NotInFeatureSet=1]="NotInFeatureSet",e[e.Unknown=2]="Unknown"}(pJ||(pJ={}));const Pgt=1e3,Igt={point:"point",polygon:"polygon",polyline:"polyline",multipoint:"multipoint",extent:"extent",esriGeometryPoint:"point",esriGeometryPolygon:"polygon",esriGeometryPolyline:"polyline",esriGeometryMultipoint:"multipoint",esriGeometryEnvelope:"extent",envelope:"extent"},mJ={point:"esriGeometryPoint",polygon:"esriGeometryPolygon",polyline:"esriGeometryPolyline",multipoint:"esriGeometryMultipoint",extent:"esriGeometryEnvelope",esriGeometryPoint:"esriGeometryPoint",esriGeometryPolygon:"esriGeometryPolygon",esriGeometryPolyline:"esriGeometryPolyline",esriGeometryMultipoint:"esriGeometryMultipoint",esriGeometryEnvelope:"esriGeometryEnvelope",envelope:"esriGeometryEnvelope"},$gt={"small-integer":"esriFieldTypeSmallInteger",integer:"esriFieldTypeInteger",long:"esriFieldTypeLong",single:"esriFieldTypeSingle",double:"esriFieldTypeDouble",string:"esriFieldTypeString",date:"esriFieldTypeDate",oid:"esriFieldTypeOID",geometry:"esriFieldTypeGeometry",blob:"esriFieldTypeBlob",raster:"esriFieldTypeRaster",guid:"esriFieldTypeGUID","global-id":"esriFieldTypeGlobalID",xml:"eesriFieldTypeXML",esriFieldTypeSmallInteger:"esriFieldTypeSmallInteger",esriFieldTypeInteger:"esriFieldTypeInteger",esriFieldTypeLong:"esriFieldTypeLong",esriFieldTypeSingle:"esriFieldTypeSingle",esriFieldTypeDouble:"esriFieldTypeDouble",esriFieldTypeString:"esriFieldTypeString",esriFieldTypeDate:"esriFieldTypeDate",esriFieldTypeOID:"esriFieldTypeOID",esriFieldTypeGeometry:"esriFieldTypeGeometry",esriFieldTypeBlob:"esriFieldTypeBlob",esriFieldTypeRaster:"esriFieldTypeRaster",esriFieldTypeGUID:"esriFieldTypeGUID",esriFieldTypeGlobalID:"esriFieldTypeGlobalID",esriFieldTypeXML:"eesriFieldTypeXML"};function Dgt(e,t){return b7((i,r)=>{const s=xx(!0);e.reduce((n,o,a,l)=>n.then(c=>{try{return t(c,o,a,l)}catch(h){return WX(h)}},c=>WX(c)),s).then(i,r)})}function Lgt(e){return e===void 0?"":e=(e=(e=e.replace(/\/featureserver\/[0-9]*/i,"/FeatureServer")).replace(/\/mapserver\/[0-9]*/i,"/MapServer")).split("?")[0]}function Ngt(e,t){t||(t={}),typeof t=="function"&&(t={cmp:t});const i=typeof t.cycles=="boolean"&&t.cycles,r=t.cmp&&(s=t.cmp,function(o){return function(a,l){const c={key:a,value:o[a]},h={key:l,value:o[l]};return s(c,h)}});var s;const n=[];return function o(a){if(a&&a.toJSON&&typeof a.toJSON=="function"&&(a=a.toJSON()),a===void 0)return;if(typeof a=="number")return isFinite(a)?""+a:"null";if(typeof a!="object")return JSON.stringify(a);let l,c;if(Array.isArray(a)){for(c="[",l=0;l<a.length;l++)l&&(c+=","),c+=o(a[l])||"null";return c+"]"}if(a===null)return"null";if(n.indexOf(a)!==-1){if(i)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}const h=n.push(a)-1,p=Object.keys(a).sort(r&&r(a));for(c="",l=0;l<p.length;l++){const f=p[l],g=o(a[f]);g&&(c&&(c+=","),c+=JSON.stringify(f)+":"+g)}return n.splice(h,1),"{"+c+"}"}(e)}class nfe{constructor(t){this.value=t}}class ofe{constructor(t){this.value=t}}class PH{constructor(t){this.fn=t}}class IH{constructor(t,i){this.paramCount=i,this.fn=t}}const r4e=PH,s4e=ofe,n4e=nfe,o4e=IH,tc={type:"VOID"},a4e={type:"BREAK"},l4e={type:"CONTINUE"};function JC(e,t,i){return t===""||t==null||t===i||t===i?e:e=e.split(t).join(i)}function $H(e){return e instanceof PH||e instanceof XLe||e instanceof IH}function lL(e){return!!lo(e)||!!fa(e)||!!Vo(e)||!!pa(e)||e===null||e===tc||typeof e=="number"}function c4e(e,t){return e===void 0?t:e}function lo(e){return typeof e=="string"||e instanceof String}function pa(e){return typeof e=="boolean"}function fa(e){return typeof e=="number"}function u4e(e){return typeof e=="number"&&isFinite(e)&&Math.floor(e)===e}function Du(e){return e instanceof Array}function h4e(e){return(e==null?void 0:e.arcadeDeclaredClass)==="esri.arcade.Feature"}function d4e(e){return(e&&e.declaredRootClass&&e.declaredRootClass==="esri.arcade.featureset.support.FeatureSet")===!0}function p4e(e){return(e&&e.declaredRootClass&&e.declaredRootClass==="esri.arcade.featureSetCollection")===!0}function N1(e){return e instanceof Bp}function Vo(e){return e instanceof Date}function f4e(e,t,i){if(e.length<t||e.length>i)throw new Error("Function called with wrong number of Parameters")}function m4e(e){return e<0?-Math.round(-e):Math.round(e)}function g4e(){let e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),(t==="x"?i:3&i|8).toString(16)})}function DH(e,t){return isNaN(e)===!1?t==null||t===""?e.toString():(t=JC(t,"\u2030",""),t=JC(t,"\xA4",""),YFe(e,{pattern:t})):e.toString()}function RF(e,t){const i=Bt.fromJSDate(e);return t==null||t===""?i.toISO({suppressMilliseconds:!0}):i.toFormat(afe(t),{locale:dc(),numberingSystem:"latn"})}function afe(e){e=e.replace(/LTS|LT|LL?L?L?|l{1,4}/g,"[$&]");let t="";const i=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|N{1,5}|YYYYYY|YYYYY|YYYY|YY|y{2,4}|yo?|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g;for(const r of e.match(i))switch(r){case"D":t+="d";break;case"DD":t+="dd";break;case"DDD":t+="o";break;case"d":t+="c";break;case"ddd":t+="ccc";break;case"dddd":t+="cccc";break;case"M":t+="L";break;case"MM":t+="LL";break;case"MMM":t+="LLL";break;case"MMMM":t+="LLLL";break;case"YY":t+="yy";break;case"Y":case"YYYY":t+="yyyy";break;case"Q":t+="q";break;case"Z":t+="ZZ";break;case"ZZ":t+="ZZZ";break;case"S":t+="'S'";break;case"SS":t+="'SS'";break;case"SSS":t+="u";break;case"A":case"a":t+="a";break;case"m":case"mm":case"h":case"hh":case"H":case"HH":case"s":case"ss":case"X":case"x":t+=r;break;default:r.length>=2&&r.slice(0,1)==="["&&r.slice(-1)==="]"?t+=`'${r.slice(1,-1)}'`:t+=`'${r}'`}return t}function Zi(e,t,i){switch(i){case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t}return!1}function y4e(e,t,i){if(e===null){if(t===null||t===tc)return Zi(null,null,i);if(fa(t))return Zi(0,t,i);if(lo(t)||pa(t))return Zi(0,ts(t),i);if(Vo(t))return Zi(0,t.getTime(),i)}if(e===tc){if(t===null||t===tc)return Zi(null,null,i);if(fa(t))return Zi(0,t,i);if(lo(t)||pa(t))return Zi(0,ts(t),i);if(Vo(t))return Zi(0,t.getTime(),i)}else if(fa(e)){if(fa(t))return Zi(e,t,i);if(pa(t))return Zi(e,ts(t),i);if(t===null||t===tc)return Zi(e,0,i);if(lo(t))return Zi(e,ts(t),i);if(Vo(t))return Zi(e,t.getTime(),i)}else if(lo(e)){if(lo(t))return Zi(o0(e),o0(t),i);if(Vo(t))return Zi(ts(e),t.getTime(),i);if(fa(t))return Zi(ts(e),t,i);if(t===null||t===tc)return Zi(ts(e),0,i);if(pa(t))return Zi(ts(e),ts(t),i)}else if(Vo(e)){if(Vo(t))return Zi(e,t,i);if(t===null||t===tc)return Zi(e.getTime(),0,i);if(fa(t))return Zi(e.getTime(),t,i);if(pa(t)||lo(t))return Zi(e.getTime(),ts(t),i)}else if(pa(e)){if(pa(t))return Zi(e,t,i);if(fa(t))return Zi(ts(e),ts(t),i);if(Vo(t))return Zi(ts(e),t.getTime(),i);if(t===null||t===tc)return Zi(ts(e),0,i);if(lo(t))return Zi(ts(e),ts(t),i)}return!!lfe(e,t)&&(i==="<="||i===">=")}function lfe(e,t){if(e===t||e===null&&t===tc||t===null&&e===tc)return!0;if(Vo(e)&&Vo(t))return e.getTime()===t.getTime();if(e instanceof xH||e instanceof gb)return e.equalityTest(t);if(e instanceof et&&t instanceof et){const i=e.cache._arcadeCacheId,r=t.cache._arcadeCacheId;if(i!=null)return i===r}return e!==void 0&&t!==void 0&&e!==null&&t!==null&&typeof e=="object"&&typeof t=="object"&&(e._arcadeCacheId===t._arcadeCacheId&&e._arcadeCacheId!==void 0&&e._arcadeCacheId!==null||e._underlyingGraphic===t._underlyingGraphic&&e._underlyingGraphic!==void 0&&e._underlyingGraphic!==null)}function o0(e,t){if(lo(e))return e;if(e===null)return"";if(fa(e))return DH(e,t);if(pa(e))return e.toString();if(Vo(e))return RF(e,t);if(e instanceof vl)return JSON.stringify(e.toJSON());if(Du(e)){const i=[];for(let r=0;r<e.length;r++)i[r]=cL(e[r]);return"["+i.join(",")+"]"}if(e instanceof Bp){const i=[];for(let r=0;r<e.length();r++)i[r]=cL(e.get(r));return"["+i.join(",")+"]"}return e!==null&&typeof e=="object"&&e.castToText!==void 0?e.castToText():$H(e)?"object, Function":""}function v4e(e){const t=[];if(Du(e)===!1)return null;if(e instanceof Bp){for(let i=0;i<e.length();i++)t[i]=ts(e.get(i));return t}for(let i=0;i<e.length;i++)t[i]=ts(e[i]);return t}function $I(e,t){if(lo(e))return e;if(e===null)return"";if(fa(e))return DH(e,t);if(pa(e))return e.toString();if(Vo(e))return RF(e,t);if(e instanceof vl)return e instanceof Xt?'{"xmin":'+e.xmin.toString()+',"ymin":'+e.ymin.toString()+","+(e.hasZ?'"zmin":'+e.zmin.toString()+",":"")+(e.hasM?'"mmin":'+e.mmin.toString()+",":"")+'"xmax":'+e.xmax.toString()+',"ymax":'+e.ymax.toString()+","+(e.hasZ?'"zmax":'+e.zmax.toString()+",":"")+(e.hasM?'"mmax":'+e.mmax.toString()+",":"")+'"spatialReference":'+i8(e.spatialReference)+"}":i8(e.toJSON(),(i,r)=>i.key===r.key?0:i.key==="spatialReference"?1:r.key==="spatialReference"||i.key<r.key?-1:i.key>r.key?1:0);if(Du(e)){const i=[];for(let r=0;r<e.length;r++)i[r]=cL(e[r]);return"["+i.join(",")+"]"}if(e instanceof Bp){const i=[];for(let r=0;r<e.length();r++)i[r]=cL(e.get(r));return"["+i.join(",")+"]"}return e!==null&&typeof e=="object"&&e.castToText!==void 0?e.castToText():$H(e)?"object, Function":""}function cL(e){if(e===null)return"null";if(pa(e)||fa(e)||lo(e))return JSON.stringify(e);if(e instanceof vl||e instanceof Bp||e instanceof Array)return $I(e);if(e instanceof Date)return JSON.stringify(RF(e,""));if(e!==null&&typeof e=="object"){if(e.castToText!==void 0)return e.castToText()}else if(e===tc)return"null";return"null"}function ts(e,t){return fa(e)?e:e===null||e===""?0:Vo(e)?NaN:pa(e)?e?1:0:Du(e)||e===""||e===void 0?NaN:t!==void 0&&lo(e)?(t=JC(t,"\u2030",""),t=JC(t,"\xA4",""),KFe(e,{pattern:t})):e===tc?0:Number(e)}function _4e(e){if(Vo(e))return e;if(lo(e)){const t=cfe(e);if(t)return t.toJSDate()}return null}function b4e(e){return Vo(e)?Bt.fromJSDate(e):lo(e)?cfe(e):null}function cfe(e){const t=/ (\d\d)/;let i=Bt.fromISO(e);return i.isValid||t.test(e)&&(e=e.replace(t,"T$1"),i=Bt.fromISO(e),i.isValid)?i:null}function w4e(e){return pa(e)?e:lo(e)?(e=e.toLowerCase())==="true":!!fa(e)&&e!==0&&!isNaN(e)}function x4e(e,t){return R(e)?null:(e.spatialReference!==null&&e.spatialReference!==void 0||(e.spatialReference=t),e)}function T4e(e){if(e===null)return null;if(e instanceof et)return e.x==="NaN"||e.x===null||isNaN(e.x)?null:e;if(e instanceof bc){if(e.rings.length===0)return null;for(const t of e.rings)if(t.length>0)return e;return null}if(e instanceof cc){if(e.paths.length===0)return null;for(const t of e.paths)if(t.length>0)return e;return null}return e instanceof nb?e.points.length===0?null:e:e instanceof Xt?e.xmin==="NaN"||e.xmin===null||isNaN(e.xmin)?null:e:null}function ufe(e,t){if(!e||!e.domain)return t;let i=null;if(e.field.type==="string"||e.field.type==="esriFieldTypeString")t=o0(t);else{if(t==null)return null;if(t==="")return t;t=ts(t)}for(let r=0;r<e.domain.codedValues.length;r++){const s=e.domain.codedValues[r];s.code===t&&(i=s)}return i===null?t:i.name}function hfe(e,t){if(!e||!e.domain)return t;let i=null;t=o0(t);for(let r=0;r<e.domain.codedValues.length;r++){const s=e.domain.codedValues[r];s.name===t&&(i=s)}return i===null?t:i.code}function OF(e,t,i=null,r=null){if(!t||!t.fields)return null;let s,n,o=null;for(let a=0;a<t.fields.length;a++){const l=t.fields[a];l.name.toLowerCase()===e.toString().toLowerCase()&&(o=l)}if(o===null)throw new Error("Field not found");return r===null&&i&&t.typeIdField&&(r=i.hasField(t.typeIdField)?i.field(t.typeIdField):null),r!=null&&t.types.some(function(a){return a.id===r&&(s=a.domains&&a.domains[o.name],s&&s.type==="inherited"&&(s=gJ(o.name,t),n=!0),!0)}),n||s||(s=gJ(e,t)),{field:o,domain:s}}function gJ(e,t){let i;return t.fields.some(function(r){return r.name.toLowerCase()===e.toLowerCase()&&(i=r.domain),!!i}),i}function i8(e,t){t||(t={}),typeof t=="function"&&(t={cmp:t});const i=typeof t.cycles=="boolean"&&t.cycles,r=t.cmp&&(s=t.cmp,function(o){return function(a,l){const c={key:a,value:o[a]},h={key:l,value:o[l]};return s(c,h)}});var s;const n=[];return function o(a){if(a&&a.toJSON&&typeof a.toJSON=="function"&&(a=a.toJSON()),a===void 0)return;if(typeof a=="number")return isFinite(a)?""+a:"null";if(typeof a!="object")return JSON.stringify(a);let l,c;if(Array.isArray(a)){for(c="[",l=0;l<a.length;l++)l&&(c+=","),c+=o(a[l])||"null";return c+"]"}if(a===null)return"null";if(n.indexOf(a)!==-1){if(i)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}const h=n.push(a)-1,p=Object.keys(a).sort(r&&r(a));for(c="",l=0;l<p.length;l++){const f=p[l],g=o(a[f]);g&&(c&&(c+=","),c+=JSON.stringify(f)+":"+g)}return n.splice(h,1),"{"+c+"}"}(e)}function S4e(e){if(e===null)return null;const t=[];for(const i of e)i&&i.arcadeDeclaredClass&&i.arcadeDeclaredClass==="esri.arcade.Feature"?t.push(i.geometry()):t.push(i);return t}function JT(e,t){if(!(t instanceof et))throw new Error("Invalid Argument");e.push(t.hasZ?t.hasM?[t.x,t.y,t.z,t.m]:[t.x,t.y,t.z]:[t.x,t.y])}function E4e(e,t){if(Du(e)||N1(e)){let i=!1,r=!1,s=[],n=t;if(Du(e)){for(const o of e)JT(s,o);s.length>0&&(n=e[0].spatialReference,i=e[0].hasZ,r=e[0].hasM)}else if(e instanceof gb)s=e._elements,s.length>0&&(i=e._hasZ,r=e._hasM,n=e.get(0).spatialReference);else{if(!N1(e))throw new Error("Invalid Argument");for(const o of e.toArray())JT(s,o);s.length>0&&(n=e.get(0).spatialReference,i=e.get(0).hasZ===!0,r=e.get(0).hasM===!0)}return s.length===0?null:(N7(s,r,i)===!1&&(s=s.slice(0).reverse()),new bc({rings:[s],spatialReference:n,hasZ:i,hasM:r}))}return e}function A4e(e,t){if(Du(e)||N1(e)){let i=!1,r=!1,s=[],n=t;if(Du(e)){for(const o of e)JT(s,o);s.length>0&&(n=e[0].spatialReference,i=e[0].hasZ===!0,r=e[0].hasM===!0)}else if(e instanceof gb)s=e._elements,s.length>0&&(i=e._hasZ,r=e._hasM,n=e.get(0).spatialReference);else if(N1(e)){for(const o of e.toArray())JT(s,o);s.length>0&&(n=e.get(0).spatialReference,i=e.get(0).hasZ===!0,r=e.get(0).hasM===!0)}return s.length===0?null:new cc({paths:[s],spatialReference:n,hasZ:i,hasM:r})}return e}function C4e(e,t){if(Du(e)||N1(e)){let i=!1,r=!1,s=[],n=t;if(Du(e)){for(const o of e)JT(s,o);s.length>0&&(n=e[0].spatialReference,i=e[0].hasZ===!0,r=e[0].hasM===!0)}else if(e instanceof gb)s=e._elements,s.length>0&&(i=e._hasZ,r=e._hasM,n=e.get(0).spatialReference);else if(N1(e)){for(const o of e.toArray())JT(s,o);s.length>0&&(n=e.get(0).spatialReference,i=e.get(0).hasZ===!0,r=e.get(0).hasM===!0)}return s.length===0?null:new nb({points:s,spatialReference:n,hasZ:i,hasM:r})}return e}function R4e(e,t=!1){const i=[];if(e===null)return i;if(Du(e)===!0){for(let r=0;r<e.length;r++){const s=o0(e[r]);s===""&&t!==!0||i.push(s)}return i}if(e instanceof Bp){for(let r=0;r<e.length();r++){const s=o0(e.get(r));s===""&&t!==!0||i.push(s)}return i}if(lL(e)){const r=o0(e);return r===""&&t!==!0||i.push(r),i}return[]}let pU=0;function O4e(e){return pU++,pU%100==0?(pU=0,b7(t=>{setTimeout(()=>{t(e)},0)})):e}function M4e(e,t,i){switch(i){case"&":return e&t;case"|":return e|t;case"^":return e^t;case"<<":return e<<t;case">>":return e>>t;case">>>":return e>>>t}}function KC(e,t=null){return e==null?null:pa(e)||fa(e)||lo(e)?e:e instanceof vl?(t==null?void 0:t.keepGeometryType)===!0?e:e.toJSON():e instanceof Bp?e.toArray().map(i=>KC(i,t)):e instanceof Array?e.map(i=>KC(i,t)):e instanceof Date?e:e!==null&&typeof e=="object"&&e.castAsJson!==void 0?e.castAsJson(t):null}function P4e(e,t,i,r,s){return LH(e,t,i).then(n=>{s[r]=n})}function LH(e,t=null,i=null){if(e instanceof Bp&&(e=e.toArray()),e==null)return xx(null);if(lL(e)||e instanceof vl||e instanceof Date)return xx(KC(e,i));if(e instanceof Array){const r=[],s=[];for(const n of e)n===null||lL(n)||n instanceof vl||n instanceof Date?s.push(KC(n,i)):(s.push(null),r.push(P4e(n,t,i,s.length-1,s)));return r.length>0?$C(r).then(()=>s):xx(s)}return e!==null&&typeof e=="object"&&e.castAsJsonAsync!==void 0?e.castAsJsonAsync(t,i):xx(null)}function I4e(e,t,i){const r=e.fullSchema();return r===null||!r.fields?null:OF(t,r,e,i)}function $4e(e){const t=e.fullSchema();return t===null?null:t.fields&&t.typeIdField?{subtypeField:t.typeIdField,subtypes:t.types?t.types.map(i=>({name:i.name,code:i.id})):[]}:null}function D4e(e,t,i,r){const s=e.fullSchema();if(s===null||!s.fields)return null;const n=OF(t,s,e,r);if(i===void 0)try{i=e.field(t)}catch{return null}return ufe(n,i)}function L4e(e,t,i,r){const s=e.fullSchema();if(s===null||!s.fields)return null;if(i===void 0){try{i=e.field(t)}catch{return null}return i}return hfe(OF(t,s,e,r),i)}function N4e(e){const t=e.fullSchema();if(t===null||!t.fields)return null;const i=[];for(const r of t.fields)i.push(i4e(r));return{objectIdField:t.objectIdField,globalIdField:t.globalIdField,geometryType:mJ[t.geometryType]===void 0?"":mJ[t.geometryType],fields:i}}const Fgt=Object.freeze({__proto__:null,ReturnResultE:nfe,ImplicitResultE:ofe,NativeFunctionE:PH,SizzleFunctionE:IH,NativeFunction:r4e,ImplicitResult:s4e,ReturnResult:n4e,SizzleFunction:o4e,voidOperation:tc,breakResult:a4e,continueResult:l4e,multiReplace:JC,isFunctionParameter:$H,isSimpleType:lL,defaultUndefined:c4e,isString:lo,isBoolean:pa,isNumber:fa,isInteger:u4e,isArray:Du,isFeature:h4e,isFeatureSet:d4e,isFeatureSetCollection:p4e,isImmutableArray:N1,isDate:Vo,pcCheck:f4e,absRound:m4e,generateUUID:g4e,formatNumber:DH,formatDate:RF,standardiseDateFormat:afe,greaterThanLessThan:y4e,equalityTest:lfe,toString:o0,toNumberArray:v4e,toStringExplicit:$I,toNumber:ts,toDate:_4e,toDateTime:b4e,toBoolean:w4e,fixSpatialReference:x4e,fixNullGeometry:T4e,getDomainValue:ufe,getDomainCode:hfe,getDomain:OF,stableStringify:i8,autoCastFeatureToGeometry:S4e,autoCastArrayOfPointsToPolygon:E4e,autoCastArrayOfPointsToPolyline:A4e,autoCastArrayOfPointsToMultiPoint:C4e,toStringArray:R4e,tick:O4e,binaryOperator:M4e,castAsJson:KC,castAsJsonAsync:LH,featureFullDomain:I4e,featureSubtypes:$4e,featureDomainValueLookup:D4e,featureDomainCodeLookup:L4e,featureSchema:N4e});var r8;let tA=r8=class extends fe{constructor(e){super(e),this.minValue=0,this.maxValue=0}clone(){return new r8({minValue:this.minValue,maxValue:this.maxValue})}};u([d({type:Number,json:{write:!0}})],tA.prototype,"minValue",void 0),u([d({type:Number,json:{write:!0}})],tA.prototype,"maxValue",void 0),tA=r8=u([P("esri.renderer.support.AuthoringInfoClassBreakInfo")],tA);const F4e=tA;var s8;let Wv=s8=class extends fe{constructor(e){super(e),this.field="",this.normalizationField="",this.label="",this.classBreakInfos=[]}clone(){return new s8({field:this.field,normalizationField:this.normalizationField,label:this.label,classBreakInfos:se(this.classBreakInfos)})}};u([d({type:String,json:{write:!0}})],Wv.prototype,"field",void 0),u([d({type:String,json:{write:!0}})],Wv.prototype,"normalizationField",void 0),u([d({type:String,json:{write:!0}})],Wv.prototype,"label",void 0),u([d({type:[F4e],json:{write:!0}})],Wv.prototype,"classBreakInfos",void 0),Wv=s8=u([P("esri.renderers.support.AuthoringInfoFieldInfo")],Wv);const yJ=Wv;var n8;const kM=new si({percentTotal:"percent-of-total",ratio:"ratio",percent:"percent"}),zM=new si({sizeInfo:"size",colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation"}),vJ={key:e=>typeof e=="number"?"number":"string",typeMap:{number:Number,string:String},base:null},_J=["high-to-low","above-and-below","centered-on","extremes"],bJ=[...new Set(["high-to-low","above-and-below","centered-on","extremes","90-10","above","below","high-to-low","above-and-below","90-10","above","below"])],wJ=["seconds","minutes","hours","days","months","years"];let Ga=n8=class extends fe{constructor(e){super(e),this.endTime=null,this.field=null,this.maxSliderValue=null,this.minSliderValue=null,this.startTime=null,this.type=null,this.units=null}castEndTime(e){return typeof e=="string"||typeof e=="number"?e:null}castStartTime(e){return typeof e=="string"||typeof e=="number"?e:null}get style(){return this.type==="color"?this._get("style"):null}set style(e){this._set("style",e)}get theme(){return this.type==="color"||this.type==="size"?this._get("theme")||"high-to-low":null}set theme(e){this._set("theme",e)}clone(){return new n8({endTime:this.endTime,field:this.field,maxSliderValue:this.maxSliderValue,minSliderValue:this.minSliderValue,startTime:this.startTime,style:this.style,theme:this.theme,type:this.type,units:this.units})}};u([d({types:vJ,json:{write:!0}})],Ga.prototype,"endTime",void 0),u([At("endTime")],Ga.prototype,"castEndTime",null),u([d({type:String,json:{write:!0}})],Ga.prototype,"field",void 0),u([d({type:Number,json:{write:!0}})],Ga.prototype,"maxSliderValue",void 0),u([d({type:Number,json:{write:!0}})],Ga.prototype,"minSliderValue",void 0),u([d({types:vJ,json:{write:!0}})],Ga.prototype,"startTime",void 0),u([At("startTime")],Ga.prototype,"castStartTime",null),u([d({type:kM.apiValues,value:null,json:{type:kM.jsonValues,read:kM.read,write:kM.write}})],Ga.prototype,"style",null),u([d({type:bJ,value:null,json:{type:bJ,origins:{"web-scene":{type:_J,write:{writer:(e,t)=>{_J.indexOf(e)>-1&&(t.theme=e)}}}},write:!0}})],Ga.prototype,"theme",null),u([d({type:zM.apiValues,json:{type:zM.jsonValues,read:zM.read,write:zM.write}})],Ga.prototype,"type",void 0),u([d({type:wJ,json:{type:wJ,write:!0}})],Ga.prototype,"units",void 0),Ga=n8=u([P("esri.renderers.support.AuthoringInfoVisualVariable")],Ga);const U4e=Ga;let DI=class extends fe{constructor(e){super(e),this.type=null}};u([d({readOnly:!0,json:{read:!1,write:!0}})],DI.prototype,"type",void 0),DI=u([P("esri.rest.support.ColorRamp")],DI);const NH=DI;var o8;let Xv=o8=class extends NH{constructor(e){super(e),this.algorithm=null,this.fromColor=null,this.toColor=null,this.type="algorithmic"}clone(){return new o8({fromColor:se(this.fromColor),toColor:se(this.toColor),algorithm:this.algorithm})}};u([ut({esriCIELabAlgorithm:"cie-lab",esriHSVAlgorithm:"hsv",esriLabLChAlgorithm:"lab-lch"})],Xv.prototype,"algorithm",void 0),u([d({type:Je,json:{type:[ir],write:!0}})],Xv.prototype,"fromColor",void 0),u([d({type:Je,json:{type:[ir],write:!0}})],Xv.prototype,"toColor",void 0),u([d({type:["algorithmic"]})],Xv.prototype,"type",void 0),Xv=o8=u([P("esri.rest.support.AlgorithmicColorRamp")],Xv);const FH=Xv;var a8;let iA=a8=class extends NH{constructor(e){super(e),this.colorRamps=null,this.type="multipart"}clone(){return new a8({colorRamps:se(this.colorRamps)})}};u([d({type:[FH],json:{write:!0}})],iA.prototype,"colorRamps",void 0),u([d({type:["multipart"]})],iA.prototype,"type",void 0),iA=a8=u([P("esri.rest.support.MultipartColorRamp")],iA);const dfe=iA,k4e={key:"type",base:NH,typeMap:{algorithmic:FH,multipart:dfe}};function z4e(e){return e&&e.type?e.type==="algorithmic"?FH.fromJSON(e):e.type==="multipart"?dfe.fromJSON(e):null:null}var l8;const Z0=new si({esriClassifyDefinedInterval:"defined-interval",esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation"}),BM=new si({classedSize:"class-breaks-size",classedColor:"class-breaks-color",univariateColorSize:"univariate-color-size",relationship:"relationship",predominance:"predominance",dotDensity:"dot-density",flow:"flow"}),xJ=new si({classedSize:"class-breaks-size",classedColor:"class-breaks-color",univariateColorSize:"univariate-color-size",relationship:"relationship",predominance:"predominance",dotDensity:"dot-density"}),TJ=["inches","feet","yards","miles","nautical-miles","millimeters","centimeters","decimeters","meters","kilometers","decimal-degrees"],B4e=["high-to-low","above-and-below","above","below","90-10"],V4e=["flow-line","wave-front"],G4e=["caret","circle-caret","arrow","circle-arrow","plus-minus","circle-plus-minus","square","circle","triangle","happy-sad","thumb","custom"];let Ls=l8=class extends fe{constructor(e){super(e),this.colorRamp=null,this.lengthUnit=null,this.maxSliderValue=null,this.minSliderValue=null,this.visualVariables=null}get classificationMethod(){const e=this._get("classificationMethod"),t=this.type;return t&&t!=="relationship"?t==="class-breaks-size"||t==="class-breaks-color"?e||"manual":null:e}set classificationMethod(e){this._set("classificationMethod",e)}readColorRamp(e){if(e)return z4e(e)}get fields(){return this.type&&this.type!=="predominance"?null:this._get("fields")}set fields(e){this._set("fields",e)}get field1(){return this.type&&this.type!=="relationship"?null:this._get("field1")}set field1(e){this._set("field1",e)}get field2(){return this.type&&this.type!=="relationship"?null:this._get("field2")}set field2(e){this._set("field2",e)}get flowTheme(){return this.type==="flow"?this._get("flowTheme"):null}set flowTheme(e){this._set("flowTheme",e)}get focus(){return this.type&&this.type!=="relationship"?null:this._get("focus")}set focus(e){this._set("focus",e)}get numClasses(){return this.type&&this.type!=="relationship"?null:this._get("numClasses")}set numClasses(e){this._set("numClasses",e)}get statistics(){return this.type==="univariate-color-size"&&this.univariateTheme==="above-and-below"?this._get("statistics"):null}set statistics(e){this._set("statistics",e)}get standardDeviationInterval(){const e=this.type;return e&&e!=="relationship"&&e!=="class-breaks-size"&&e!=="class-breaks-color"||this.classificationMethod&&this.classificationMethod!=="standard-deviation"?null:this._get("standardDeviationInterval")}set standardDeviationInterval(e){this._set("standardDeviationInterval",e)}get type(){return this._get("type")}set type(e){let t=e;e==="classed-size"?t="class-breaks-size":e==="classed-color"&&(t="class-breaks-color"),this._set("type",t)}get univariateSymbolStyle(){return this.type==="univariate-color-size"&&this.univariateTheme==="above-and-below"?this._get("univariateSymbolStyle"):null}set univariateSymbolStyle(e){this._set("univariateSymbolStyle",e)}get univariateTheme(){return this.type==="univariate-color-size"?this._get("univariateTheme"):null}set univariateTheme(e){this._set("univariateTheme",e)}clone(){return new l8({classificationMethod:this.classificationMethod,colorRamp:se(this.colorRamp),fields:this.fields&&this.fields.slice(0),field1:se(this.field1),field2:se(this.field2),focus:this.focus,numClasses:this.numClasses,maxSliderValue:this.maxSliderValue,minSliderValue:this.minSliderValue,lengthUnit:this.lengthUnit,statistics:this.statistics,standardDeviationInterval:this.standardDeviationInterval,type:this.type,visualVariables:this.visualVariables&&this.visualVariables.map(e=>e.clone()),univariateSymbolStyle:this.univariateSymbolStyle,univariateTheme:this.univariateTheme,flowTheme:this.flowTheme})}};u([d({type:Z0.apiValues,value:null,json:{type:Z0.jsonValues,read:Z0.read,write:Z0.write,origins:{"web-document":{default:"manual",type:Z0.jsonValues,read:Z0.read,write:Z0.write}}}})],Ls.prototype,"classificationMethod",null),u([d({types:k4e,json:{write:!0}})],Ls.prototype,"colorRamp",void 0),u([De("colorRamp")],Ls.prototype,"readColorRamp",null),u([d({type:[String],value:null,json:{write:!0}})],Ls.prototype,"fields",null),u([d({type:yJ,value:null,json:{write:!0}})],Ls.prototype,"field1",null),u([d({type:yJ,value:null,json:{write:!0}})],Ls.prototype,"field2",null),u([d({type:V4e,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],Ls.prototype,"flowTheme",null),u([d({type:["HH","HL","LH","LL"],value:null,json:{write:!0}})],Ls.prototype,"focus",null),u([d({type:Number,value:null,json:{type:ir,write:!0}})],Ls.prototype,"numClasses",null),u([d({type:TJ,json:{type:TJ,read:!1,write:!1,origins:{"web-scene":{read:!0,write:!0}}}})],Ls.prototype,"lengthUnit",void 0),u([d({type:Number,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],Ls.prototype,"maxSliderValue",void 0),u([d({type:Number,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],Ls.prototype,"minSliderValue",void 0),u([d({type:Object,value:null,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],Ls.prototype,"statistics",null),u([d({type:[.25,.33,.5,1],value:null,json:{type:[.25,.33,.5,1],write:!0}})],Ls.prototype,"standardDeviationInterval",null),u([d({type:BM.apiValues,value:null,json:{type:BM.jsonValues,read:BM.read,write:BM.write,origins:{"web-scene":{type:xJ.jsonValues,write:{writer:xJ.write,overridePolicy:e=>({enabled:e!=="flow"})}}}}})],Ls.prototype,"type",null),u([d({type:[U4e],json:{write:!0}})],Ls.prototype,"visualVariables",void 0),u([d({type:G4e,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],Ls.prototype,"univariateSymbolStyle",null),u([d({type:B4e,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],Ls.prototype,"univariateTheme",null),Ls=l8=u([P("esri.renderers.support.AuthoringInfo")],Ls);const j4e=Ls,fU=new si({simple:"simple",uniqueValue:"unique-value",classBreaks:"class-breaks",heatmap:"heatmap",dotDensity:"dot-density",dictionary:"dictionary"},{ignoreUnknown:!0});let rA=class extends fe{constructor(e){super(e),this.authoringInfo=null,this.type=null}async getRequiredFields(e){if(!this.collectRequiredFields)return[];const t=new Set;return await this.collectRequiredFields(t,e),Array.from(t).sort()}getSymbol(e,t){}async getSymbolAsync(e,t){}getSymbols(){return[]}getAttributeHash(){return JSON.stringify(this)}getMeshHash(){return JSON.stringify(this)}};u([d({type:j4e,json:{write:!0}})],rA.prototype,"authoringInfo",void 0),u([d({type:fU.apiValues,readOnly:!0,json:{type:fU.jsonValues,read:!1,write:{writer:fU.write,ignoreOrigin:!0}}})],rA.prototype,"type",void 0),rA=u([P("esri.renderers.Renderer")],rA);const V0=rA;var c8;let LI=c8=class extends fe{constructor(){super(...arguments),this.title=null}clone(){return new c8({title:this.title})}};u([d({type:String,json:{write:!0}})],LI.prototype,"title",void 0),LI=c8=u([P("esri.renderers.support.LegendOptions")],LI);const UH=LI;var u8;let NI=u8=class extends UH{constructor(){super(...arguments),this.showLegend=null}clone(){return new u8({title:this.title,showLegend:this.showLegend})}};u([d({type:Boolean,json:{write:!0}})],NI.prototype,"showLegend",void 0),NI=u8=u([P("esri.renderers.visualVariables.support.VisualVariableLegendOptions")],NI);const pfe=NI,H4e=he.getLogger("esri.renderers.visualVariables.VisualVariable"),mU=new si({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"});let dh=class extends fe{constructor(e){super(e),this.index=null,this.type=null,this.field=null,this.valueExpression=null,this.valueExpressionTitle=null,this.legendOptions=null}castField(e){return e==null?e:typeof e=="function"?(H4e.error(".field: field must be a string value"),null):KR(e)}get arcadeRequired(){return!!this.valueExpression}clone(){}getAttributeHash(){return`${this.type}-${this.field}-${this.valueExpression}`}};u([d()],dh.prototype,"index",void 0),u([d({type:mU.apiValues,readOnly:!0,json:{read:mU.read,write:mU.write}})],dh.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],dh.prototype,"field",void 0),u([At("field")],dh.prototype,"castField",null),u([d({type:String,json:{write:!0}})],dh.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],dh.prototype,"valueExpressionTitle",void 0),u([d({readOnly:!0})],dh.prototype,"arcadeRequired",null),u([d({type:pfe,json:{write:!0}})],dh.prototype,"legendOptions",void 0),dh=u([P("esri.renderers.visualVariables.VisualVariable")],dh);const wO=dh;var h8;let Yv=h8=class extends fe{constructor(e){super(e),this.color=null,this.label=null,this.value=null}writeValue(e,t,i){t[i]=e==null?0:e}clone(){return new h8({color:this.color&&this.color.clone(),label:this.label,value:this.value})}};u([d({type:Je,json:{type:[ir],write:!0}})],Yv.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],Yv.prototype,"label",void 0),u([d({type:Number,json:{write:{writerEnsuresNonNull:!0}}})],Yv.prototype,"value",void 0),u([Fe("value")],Yv.prototype,"writeValue",null),Yv=h8=u([P("esri.renderers.visualVariables.support.ColorStop")],Yv);const q4e=Yv;var d8;let Zv=d8=class extends wO{constructor(e){super(e),this.type="color",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(e){e&&Array.isArray(e)&&(e=e.filter(t=>!!t)).sort((t,i)=>t.value-i.value),this._set("stops",e)}clone(){return new d8({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(e=>e.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(e=>e.value||0)}};u([d({readOnly:!0})],Zv.prototype,"cache",null),u([d({type:["color"],json:{type:["colorInfo"]}})],Zv.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Zv.prototype,"normalizationField",void 0),u([d({type:[q4e],json:{write:!0}})],Zv.prototype,"stops",null),Zv=d8=u([P("esri.renderers.visualVariables.ColorVariable")],Zv);const ffe=Zv;var p8;let Zg=p8=class extends fe{constructor(e){super(e),this.label=null,this.opacity=null,this.value=null}readOpacity(e,t){return NT(t.transparency)}writeOpacity(e,t,i){t[i]=zN(e)}clone(){return new p8({label:this.label,opacity:this.opacity,value:this.value})}};u([d({type:String,json:{write:!0}})],Zg.prototype,"label",void 0),u([d({type:Number,json:{type:ir,write:{target:"transparency"}}})],Zg.prototype,"opacity",void 0),u([De("opacity",["transparency"])],Zg.prototype,"readOpacity",null),u([Fe("opacity")],Zg.prototype,"writeOpacity",null),u([d({type:Number,json:{write:!0}})],Zg.prototype,"value",void 0),Zg=p8=u([P("esri.renderers.visualVariables.support.OpacityStop")],Zg);const W4e=Zg;var f8;let Qv=f8=class extends wO{constructor(e){super(e),this.type="opacity",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(e){e&&Array.isArray(e)&&(e=e.filter(t=>!!t)).sort((t,i)=>t.value-i.value),this._set("stops",e)}clone(){return new f8({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(e=>e.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(e=>e.value||0)}};u([d({readOnly:!0})],Qv.prototype,"cache",null),u([d({type:["opacity"],json:{type:["transparencyInfo"]}})],Qv.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Qv.prototype,"normalizationField",void 0),u([d({type:[W4e],json:{write:!0}})],Qv.prototype,"stops",null),Qv=f8=u([P("esri.renderers.visualVariables.OpacityVariable")],Qv);const mfe=Qv;var m8;let Af=m8=class extends wO{constructor(e){super(e),this.axis=null,this.type="rotation",this.rotationType="geographic",this.valueExpressionTitle=null}get cache(){return{hasExpression:!!this.valueExpression,compiledFunc:null}}writeValueExpressionTitleWebScene(e,t,i,r){if(r&&r.messages){const s=`visualVariables[${this.index}]`;r.messages.push(new q("property:unsupported",this.type+"VisualVariable.valueExpressionTitle is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:s+".valueExpressionTitle",context:r}))}}clone(){return new m8({axis:this.axis,rotationType:this.rotationType,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,legendOptions:this.legendOptions&&this.legendOptions.clone()})}};u([d({readOnly:!0})],Af.prototype,"cache",null),u([d({type:["heading","tilt","roll"],json:{origins:{"web-scene":{default:"heading",write:!0}}}})],Af.prototype,"axis",void 0),u([d({type:["rotation"],json:{type:["rotationInfo"]}})],Af.prototype,"type",void 0),u([d({type:["geographic","arithmetic"],json:{write:!0,origins:{"web-document":{write:!0,default:"geographic"}}}})],Af.prototype,"rotationType",void 0),u([d({type:String,json:{write:!0}})],Af.prototype,"valueExpressionTitle",void 0),u([Fe("web-scene","valueExpressionTitle")],Af.prototype,"writeValueExpressionTitleWebScene",null),Af=m8=u([P("esri.renderers.visualVariables.RotationVariable")],Af);const gfe=Af;var g8;let Fw=g8=class extends fe{constructor(e){super(e),this.label=null,this.size=null,this.value=null}clone(){return new g8({label:this.label,size:this.size,value:this.value})}};u([d({type:String,json:{write:!0}})],Fw.prototype,"label",void 0),u([d({type:Number,cast:Vi,json:{write:!0}})],Fw.prototype,"size",void 0),u([d({type:Number,json:{write:!0}})],Fw.prototype,"value",void 0),Fw=g8=u([P("esri.renderers.visualVariables.support.SizeStop")],Fw);const X4e=Fw;var y8;let FI=y8=class extends pfe{constructor(){super(...arguments),this.customValues=null}clone(){return new y8({title:this.title,showLegend:this.showLegend,customValues:this.customValues&&this.customValues.slice(0)})}};u([d({type:[Number],json:{write:!0}})],FI.prototype,"customValues",void 0),FI=y8=u([P("esri.renderers.visualVariables.support.SizeVariableLegendOptions")],FI);const Y4e=FI;var mm,pn;function Ox(e){return e&&e.declaredClass==="esri.renderers.visualVariables.SizeVariable"}function eR(e){return e!=null&&!isNaN(e)&&isFinite(e)}function yfe(e){return e.valueExpression?mm.Expression:e.field&&typeof e.field=="string"?mm.Field:mm.Unknown}function Z4e(e,t){const i=t||yfe(e),r=e.valueUnit||"unknown";return i===mm.Unknown?pn.Constant:e.stops?pn.Stops:e.minSize!=null&&e.maxSize!=null&&e.minDataValue!=null&&e.maxDataValue!=null?pn.ClampedLinear:r==="unknown"?e.minSize!=null&&e.minDataValue!=null?e.minSize&&e.minDataValue?pn.Proportional:pn.Additive:pn.Identity:pn.RealWorldSize}(function(e){e.Unknown="unknown",e.Expression="expression",e.Field="field"})(mm||(mm={})),function(e){e.Unknown="unknown",e.Stops="stops",e.ClampedLinear="clamped-linear",e.Proportional="proportional",e.Additive="additive",e.Constant="constant",e.Identity="identity",e.RealWorldSize="real-world-size"}(pn||(pn={}));const KT={inches:_s(1,"meters","inches"),feet:_s(1,"meters","feet"),"us-feet":_s(1,"meters","us-feet"),yards:_s(1,"meters","yards"),miles:_s(1,"meters","miles"),"nautical-miles":_s(1,"meters","nautical-miles"),millimeters:_s(1,"meters","millimeters"),centimeters:_s(1,"meters","centimeters"),decimeters:_s(1,"meters","decimeters"),meters:_s(1,"meters","meters"),kilometers:_s(1,"meters","kilometers"),"decimal-degrees":1/BRe(1,"meters",ai.radius)},w0=he.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),SJ=new qo,UI=Math.PI,vfe=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function _fe(e,t,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find(y=>y.type==="color"):e;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.ColorVariable")return void w0.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const s=typeof t=="number",n=s?null:t,o=n&&n.attributes;let a=s?t:null;const l=r.field,{ipData:c,hasExpression:h}=r.cache;let p=r.cache.compiledFunc;if(!l&&!h){const y=r.stops;return y&&y[0]&&y[0].color}if(typeof a!="number")if(h){if(!_(i)||!_(i.arcade))return void w0.error("Use of arcade expressions requires an arcade context");const y={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},v=i.arcade.arcadeUtils,b=v.getViewInfo(y),w=v.createExecContext(n,b);if(!p){const S=v.createSyntaxTree(r.valueExpression);p=v.createFunction(S),r.cache.compiledFunc=p}a=v.executeFunction(p,w)}else o&&(a=o[l]);const f=r.normalizationField,g=o?parseFloat(o[f]):void 0;if(a!=null&&(!f||s||!isNaN(g)&&g!==0)){isNaN(g)||s||(a/=g);const y=zH(a,c);if(y){const v=y[0],b=y[1],w=v===b?r.stops[v].color:Je.blendColors(r.stops[v].color,r.stops[b].color,y[2],_(i)?i.color:void 0);return new Je(w)}}}function bfe(e,t,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find(y=>y.type==="opacity"):e;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.OpacityVariable")return void w0.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const s=typeof t=="number",n=s?null:t,o=n&&n.attributes;let a=s?t:null;const l=r.field,{ipData:c,hasExpression:h}=r.cache;let p=r.cache.compiledFunc;if(!l&&!h){const y=r.stops;return y&&y[0]&&y[0].opacity}if(typeof a!="number")if(h){if(R(i)||R(i.arcade))return void w0.error("Use of arcade expressions requires an arcade context");const y={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},v=i.arcade.arcadeUtils,b=v.getViewInfo(y),w=v.createExecContext(n,b);if(!p){const S=v.createSyntaxTree(r.valueExpression);p=v.createFunction(S),r.cache.compiledFunc=p}a=v.executeFunction(p,w)}else o&&(a=o[l]);const f=r.normalizationField,g=o?parseFloat(o[f]):void 0;if(a!=null&&(!f||s||!isNaN(g)&&g!==0)){isNaN(g)||s||(a/=g);const y=zH(a,c);if(y){const v=y[0],b=y[1];if(v===b)return r.stops[v].opacity;{const w=r.stops[v].opacity;return w+(r.stops[b].opacity-w)*y[2]}}}}function wfe(e,t,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find(g=>g.type==="rotation"):e;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.RotationVariable")return void w0.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const s=r.axis||"heading",n=s==="heading"&&r.rotationType==="arithmetic"?90:0,o=s==="heading"&&r.rotationType==="arithmetic"?-1:1,a=typeof t=="number"?null:t,l=a&&a.attributes,c=r.field,{hasExpression:h}=r.cache;let p=r.cache.compiledFunc,f=0;if(!c&&!h)return f;if(h){if(R(i)||R(i.arcade))return void w0.error("Use of arcade expressions requires an arcade context");const g={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},y=i.arcade.arcadeUtils,v=y.getViewInfo(g),b=y.createExecContext(a,v);if(!p){const w=y.createSyntaxTree(r.valueExpression);p=y.createFunction(w),r.cache.compiledFunc=p}f=y.executeFunction(p,b)}else l&&(f=l[c]||0);return f=typeof f!="number"||isNaN(f)?null:n+o*f,f}function Q4e(e,t,i){const r=typeof t=="number",s=r?null:t,n=s&&s.attributes;let o=r?t:null;const{isScaleDriven:a}=e.cache;let l=e.cache.compiledFunc;if(a){const h=_(i)?i.scale:void 0,p=_(i)?i.view:void 0;o=h==null||p==="3d"?J4e(e):h}else if(!r)switch(e.inputValueType){case mm.Expression:{if(R(i)||R(i.arcade))return void w0.error("Use of arcade expressions requires an arcade context");const h={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},p=i.arcade.arcadeUtils,f=p.getViewInfo(h),g=p.createExecContext(s,f);if(!l){const y=p.createSyntaxTree(e.valueExpression);l=p.createFunction(y),e.cache.compiledFunc=l}o=p.executeFunction(l,g);break}case mm.Field:n&&(o=n[e.field]);break;case mm.Unknown:o=null}if(!eR(o))return null;if(r||!e.normalizationField)return o;const c=n?parseFloat(n[e.normalizationField]):null;return eR(c)&&c!==0?o/c:null}function J4e(e){let t=null,i=null;const r=e.stops;return r?(t=r[0].value,i=r[r.length-1].value):(t=e.minDataValue||0,i=e.maxDataValue||0),(t+i)/2}function MF(e,t,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find(n=>n.type==="size"):e;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.SizeVariable")return void w0.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const s=Tfe(Q4e(r,t,i),r,t,i,r.cache.ipData);return s==null||isNaN(s)?0:s}function ml(e,t,i){return e==null?null:Ox(e)?MF(e,t,i):eR(e)?e:null}function xfe(e,t,i){return eR(i)&&e>i?i:eR(t)&&e<t?t:e}function K4e(e,t,i,r){return e+(ml(t.minSize,i,r)||t.minDataValue)}function e5e(e,t,i){const r=e.stops;let s=r&&r.length&&r[0].size;return s==null&&(s=e.minSize),ml(s,t,i)}function t5e(e,t,i,r){const s=(e-t.minDataValue)/(t.maxDataValue-t.minDataValue),n=ml(t.minSize,i,r),o=ml(t.maxSize,i,r),a=_(r)?r.shape:void 0;if(e<=t.minDataValue)return n;if(e>=t.maxDataValue)return o;if(t.scaleBy==="area"&&a){const l=a==="circle",c=l?UI*(n/2)**2:n*n,h=c+s*((l?UI*(o/2)**2:o*o)-c);return l?2*Math.sqrt(h/UI):Math.sqrt(h)}return n+s*(o-n)}function i5e(e,t,i,r){const s=_(r)?r.shape:void 0,n=e/t.minDataValue,o=ml(t.minSize,i,r),a=ml(t.maxSize,i,r);let l=null;return l=s==="circle"?2*Math.sqrt(n*(o/2)**2):s==="square"||s==="diamond"||s==="image"?Math.sqrt(n*o**2):n*o,xfe(l,o,a)}function r5e(e,t,i,r,s){const[n,o,a]=zH(e,s);if(n===o)return ml(t.stops[n].size,i,r);{const l=ml(t.stops[n].size,i,r);return l+(ml(t.stops[o].size,i,r)-l)*a}}function s5e(e,t,i,r){const s=(_(r)&&r.resolution?r.resolution:1)*KT[t.valueUnit],n=ml(t.minSize,i,r),o=ml(t.maxSize,i,r),{valueRepresentation:a}=t;let l=null;return l=a==="area"?2*Math.sqrt(e/UI)/s:a==="radius"||a==="distance"?2*e/s:e/s,xfe(l,n,o)}function Tfe(e,t,i,r,s){switch(t.transformationType){case pn.Additive:return K4e(e,t,i,r);case pn.Constant:return e5e(t,i,r);case pn.ClampedLinear:return t5e(e,t,i,r);case pn.Proportional:return i5e(e,t,i,r);case pn.Stops:return r5e(e,t,i,r,s);case pn.RealWorldSize:return s5e(e,t,i,r);case pn.Identity:return e;case pn.Unknown:return null}}function n5e(e,t,i){const{isScaleDriven:r}=e.cache;if(!(r&&i==="3d"||t))return null;const s={scale:t,view:i};let n=ml(e.minSize,SJ,s),o=ml(e.maxSize,SJ,s);if(n!=null||o!=null){if(n>o){const a=o;o=n,n=a}return{minSize:n,maxSize:o}}}function kH(e,t,i){if(!e.visualVariables)return;const r=[],s=[],n=[],o=[],a=[];for(const l of e.visualVariables)switch(l.type){case"color":s.push(l);break;case"opacity":n.push(l);break;case"rotation":a.push(l);break;case"size":o.push(l)}return s.forEach(l=>{const c=_fe(l,t,i);r.push({variable:l,value:c})}),n.forEach(l=>{const c=bfe(l,t,i);r.push({variable:l,value:c})}),a.forEach(l=>{const c=wfe(l,t,i);r.push({variable:l,value:c})}),o.forEach(l=>{const c=MF(l,t,i);r.push({variable:l,value:c})}),r.filter(l=>l.value!=null)}function zH(e,t){if(!t)return;let i=0,r=t.length-1;return t.some((s,n)=>e<s?(r=n,!0):(i=n,!1)),[i,r,(e-t[i])/(t[r]-t[i])]}function o5e(e,t,i){const r=["proportional","proportional","proportional"];for(const s of e){const n=s.useSymbolValue?"symbol-value":MF(s,t,i);switch(s.axis){case"width":r[0]=n;break;case"depth":r[1]=n;break;case"height":r[2]=n;break;case"width-and-depth":r[0]=n,r[1]=n;break;case"all":case void 0:case null:r[0]=n,r[1]=n,r[2]=n;break;default:s.axis}}return r}var a5e=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",getAllSizes:o5e,getColor:_fe,getOpacity:bfe,getRotationAngle:wfe,getSize:MF,getSizeForValue:Tfe,getSizeFromNumberOrVariable:ml,getSizeRangeAtScale:n5e,getVisualVariableValues:kH,viewScaleRE:vfe}),v8;const Mb=he.getLogger("esri.renderers.visualVariables.SizeVariable"),VM=new si({width:"width",depth:"depth",height:"height",widthAndDepth:"width-and-depth",all:"all"}),_8=new si({unknown:"unknown",inch:"inches",foot:"feet",yard:"yards",mile:"miles","nautical-mile":"nautical-miles",millimeter:"millimeters",centimeter:"centimeters",decimeter:"decimeters",meter:"meters",kilometer:"kilometers","decimal-degree":"decimal-degrees"});function EJ(e){if(e!=null)return typeof e=="string"||typeof e=="number"?Vi(e):e.type==="size"?Ox(e)?e:(delete(e=I({},e)).type,new Ii(e)):void 0}function AJ(e,t,i){if(typeof e!="object")return e;const r=new Ii;return r.read(e,i),r}let Ii=v8=class extends wO{constructor(e){super(e),this.axis=null,this.legendOptions=null,this.normalizationField=null,this.scaleBy=null,this.target=null,this.type="size",this.useSymbolValue=null,this.valueExpression=null,this.valueRepresentation=null,this.valueUnit=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null,isScaleDriven:vfe.test(this.valueExpression)}}set expression(e){Mb.warn("'expression' is deprecated since version 4.2. Use 'valueExpression' instead. The only supported expression is 'view.scale'."),e==="view.scale"?(this.valueExpression="$view.scale",this._set("expression",e)):this._set("expression",null)}set index(e){Ox(this.maxSize)&&(this.maxSize.index=`visualVariables[${e}].maxSize`),Ox(this.minSize)&&(this.minSize.index=`visualVariables[${e}].minSize`),this._set("index",e)}get inputValueType(){return yfe(this)}set maxDataValue(e){e&&this.stops&&(Mb.warn("cannot set maxDataValue when stops is not null."),e=null),this._set("maxDataValue",e)}set maxSize(e){e&&this.stops&&(Mb.warn("cannot set maxSize when stops is not null."),e=null),this._set("maxSize",e)}castMaxSize(e){return EJ(e)}readMaxSize(e,t,i){return AJ(e,t,i)}set minDataValue(e){e&&this.stops&&(Mb.warn("cannot set minDataValue when stops is not null."),e=null),this._set("minDataValue",e)}set minSize(e){e&&this.stops&&(Mb.warn("cannot set minSize when stops is not null."),e=null),this._set("minSize",e)}castMinSize(e){return EJ(e)}readMinSize(e,t,i){return AJ(e,t,i)}get arcadeRequired(){return!!this.valueExpression||this.minSize&&typeof this.minSize=="object"&&this.minSize.arcadeRequired||this.maxSize&&typeof this.maxSize=="object"&&this.maxSize.arcadeRequired}set stops(e){this.minDataValue==null&&this.maxDataValue==null&&this.minSize==null&&this.maxSize==null?e&&Array.isArray(e)&&(e=e.filter(t=>!!t)).sort((t,i)=>t.value-i.value):e&&(Mb.warn("cannot set stops when one of minDataValue, maxDataValue, minSize or maxSize is not null."),e=null),this._set("stops",e)}get transformationType(){return Z4e(this,this.inputValueType)}readValueExpression(e,t){return e||t.expression&&"$view.scale"}writeValueExpressionWebScene(e,t,i,r){if(e==="$view.scale"){if(r&&r.messages){const s=this.index,n=typeof s=="string"?s:`visualVariables[${s}]`;r.messages.push(new q("property:unsupported",this.type+"VisualVariable.valueExpression = '$view.scale' is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:n+".valueExpression",context:r}))}}else t[i]=e}readValueUnit(e){return e?_8.read(e):null}clone(){return new v8({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:Ox(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:Ox(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map(e=>e.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone()})}flipSizes(){if(this.transformationType===pn.ClampedLinear){const{minSize:e,maxSize:t}=this;return this.minSize=t,this.maxSize=e,this}if(this.transformationType===pn.Stops){const e=this.stops,t=e.map(r=>r.size).reverse(),i=e.length;for(let r=0;r<i;r++)e[r].size=t[r];return this}return this}getAttributeHash(){return`${super.getAttributeHash()}-${this.target}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(e=>e.value||0)}};u([d({readOnly:!0})],Ii.prototype,"cache",null),u([d({type:VM.apiValues,json:{type:VM.jsonValues,origins:{"web-map":{read:!1}},read:VM.read,write:VM.write}})],Ii.prototype,"axis",void 0),u([d({type:String,value:null,json:{read:!1}})],Ii.prototype,"expression",null),u([d()],Ii.prototype,"index",null),u([d({type:String,readOnly:!0})],Ii.prototype,"inputValueType",null),u([d({type:Y4e,json:{write:!0}})],Ii.prototype,"legendOptions",void 0),u([d({type:Number,value:null,json:{write:!0}})],Ii.prototype,"maxDataValue",null),u([d({type:Number,value:null,json:{write:!0}})],Ii.prototype,"maxSize",null),u([At("maxSize")],Ii.prototype,"castMaxSize",null),u([De("maxSize")],Ii.prototype,"readMaxSize",null),u([d({type:Number,value:null,json:{write:!0}})],Ii.prototype,"minDataValue",null),u([d({type:Number,value:null,json:{write:!0}})],Ii.prototype,"minSize",null),u([At("minSize")],Ii.prototype,"castMinSize",null),u([De("minSize")],Ii.prototype,"readMinSize",null),u([d({type:String,json:{write:!0}})],Ii.prototype,"normalizationField",void 0),u([d({readOnly:!0})],Ii.prototype,"arcadeRequired",null),u([d({type:String})],Ii.prototype,"scaleBy",void 0),u([d({type:[X4e],value:null,json:{write:!0}})],Ii.prototype,"stops",null),u([d({type:["outline"],json:{write:!0}})],Ii.prototype,"target",void 0),u([d({type:String,readOnly:!0})],Ii.prototype,"transformationType",null),u([d({type:["size"],json:{type:["sizeInfo"]}})],Ii.prototype,"type",void 0),u([d({type:Boolean,json:{write:!0,origins:{"web-map":{read:!1}}}})],Ii.prototype,"useSymbolValue",void 0),u([d({type:String,json:{write:!0}})],Ii.prototype,"valueExpression",void 0),u([De("valueExpression",["valueExpression","expression"])],Ii.prototype,"readValueExpression",null),u([Fe("web-scene","valueExpression")],Ii.prototype,"writeValueExpressionWebScene",null),u([d({type:["radius","diameter","area","width","distance"],json:{write:!0}})],Ii.prototype,"valueRepresentation",void 0),u([d({type:_8.apiValues,json:{write:_8.write,origins:{"web-map":{read:!1},"web-scene":{write:!0}}}})],Ii.prototype,"valueUnit",void 0),u([De("valueUnit")],Ii.prototype,"readValueUnit",null),Ii=v8=u([P("esri.renderers.visualVariables.SizeVariable")],Ii);const Sfe=Ii,l5e=he.getLogger("esri.renderers.visualVariables.VisualVariableFactory"),c5e={color:ffe,size:Sfe,opacity:mfe,rotation:gfe},u5e=new si({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"}),h5e=/^\[([^\]]+)\]$/i;let kI=class extends we{constructor(){super(...arguments),this.colorVariables=null,this.opacityVariables=null,this.rotationVariables=null,this.sizeVariables=null}set visualVariables(e){if(this._resetVariables(),(e=e&&e.filter(t=>!!t))&&e.length){for(const t of e)switch(t.type){case"color":this.colorVariables.push(t);break;case"opacity":this.opacityVariables.push(t);break;case"rotation":this.rotationVariables.push(t);break;case"size":this.sizeVariables.push(t)}this.sizeVariables.length&&this.sizeVariables.some(t=>!!t.target)&&e.sort((t,i)=>{let r=null;return r=t.target===i.target?0:t.target?1:-1,r});for(let t=0;t<e.length;t++)e[t].index=t;this._set("visualVariables",e)}else this._set("visualVariables",e)}readVariables(e,t,i){const{rotationExpression:r,rotationType:s}=t,n=r&&r.match(h5e),o=n&&n[1];if(o&&(e||(e=[]),e.push({type:"rotationInfo",rotationType:s,field:o})),e)return e.map(a=>{const l=u5e.read(a.type),c=c5e[l];c||(l5e.warn(`Unknown variable type: ${l}`),i&&i.messages&&i.messages.push(new vc("visual-variable:unsupported",`visualVariable of type '${l}' is not supported`,{definition:a,context:i})));const h=new c;return h.read(a,i),h})}writeVariables(e,t){const i=[];for(const r of e){const s=r.toJSON(t);s&&i.push(s)}return i}_resetVariables(){this.colorVariables=[],this.opacityVariables=[],this.rotationVariables=[],this.sizeVariables=[]}};u([d()],kI.prototype,"visualVariables",null),kI=u([P("esri.renderers.visualVariables.VisualVariableFactory")],kI);const d5e=kI,p5e={base:wO,key:"type",typeMap:{opacity:mfe,color:ffe,rotation:gfe,size:Sfe}},xO=e=>{let t=class extends e{constructor(){super(...arguments),this._vvFactory=new d5e}set visualVariables(i){this._vvFactory.visualVariables=i,this._set("visualVariables",this._vvFactory.visualVariables)}readVisualVariables(i,r,s){return this._vvFactory.readVariables(i,r,s)}writeVisualVariables(i,r,s,n){r[s]=this._vvFactory.writeVariables(i,n)}get arcadeRequiredForVisualVariables(){if(!this.visualVariables)return!1;for(const i of this.visualVariables)if(i.arcadeRequired)return!0;return!1}hasVisualVariables(i,r){return i?this.getVisualVariablesForType(i,r).length>0:this.getVisualVariablesForType("size",r).length>0||this.getVisualVariablesForType("color",r).length>0||this.getVisualVariablesForType("opacity",r).length>0||this.getVisualVariablesForType("rotation",r).length>0}getVisualVariablesForType(i,r){const s=this.visualVariables;return s?s.filter(n=>n.type===i&&(typeof r=="string"?n.target===r:r!==!1||!n.target)):[]}async collectVVRequiredFields(i,r){let s=[];this.visualVariables&&(s=s.concat(this.visualVariables));for(const n of s)n&&(n.field&&Mu(i,r,n.field),n.normalizationField&&Mu(i,r,n.normalizationField),n.valueExpression&&await wc(i,r,n.valueExpression))}};return u([d({types:[p5e],value:null,json:{write:!0}})],t.prototype,"visualVariables",null),u([De("visualVariables",["visualVariables","rotationType","rotationExpression"])],t.prototype,"readVisualVariables",null),u([Fe("visualVariables")],t.prototype,"writeVisualVariables",null),t=u([P("esri.renderers.mixins.VisualVariablesMixin")],t),t},O2={retainId:!1,ignoreDrivers:!1,hasLabelingContext:!0};function f5e(e,t=O2){if(!e)return{symbol:null};const{retainId:i=O2.retainId,ignoreDrivers:r=O2.ignoreDrivers,hasLabelingContext:s=O2.hasLabelingContext,retainCIM:n=O2.retainCIM}=t;let o;if(jC(e)||e instanceof hb)o=e.clone();else if(e.type==="cim"){var a,l;const c=(a=e.data)==null||(l=a.symbol)==null?void 0:l.type;if(c!=="CIMPointSymbol")return{error:new q("symbol-conversion:unsupported-cim-symbol",`CIM symbol of type '${c||"unknown"}' is unsupported in 3D`,{symbol:e})};o=n?e.clone():ky.fromCIMSymbol(e)}else if(e instanceof sd)o=ZN.fromSimpleLineSymbol(e);else if(e instanceof VS)o=ky.fromSimpleMarkerSymbol(e);else if(e instanceof QN)o=ky.fromPictureMarkerSymbol(e);else if(e instanceof ub)o=hO.fromSimpleFillSymbol(e);else{if(!(e instanceof GS))return{error:new q("symbol-conversion:unsupported-2d-symbol",`2D symbol of type '${e.type||e.declaredClass}' is unsupported in 3D`,{symbol:e})};o=s?YN.fromTextSymbol(e):ky.fromTextSymbol(e)}if(i&&o.type!=="cim"&&(o.id=e.id),r&&jC(o))for(let c=0;c<o.symbolLayers.length;++c)o.symbolLayers.getItemAt(c)._ignoreDrivers=!0;return{symbol:o}}function uL(e,t,i,r){const s=Efe(e,{},{context:r,isLabelSymbol:!1});_(s)&&(t[i]=s)}function CJ(e,t,i,r){const s=Efe(e,{},{context:r,isLabelSymbol:!0});_(s)&&(t[i]=s)}function Efe(e,t,i){if(R(e))return null;const{context:r,isLabelSymbol:s}=i;if(r&&r.origin==="web-scene"&&!(e instanceof BS)&&!(e instanceof hb)){const n=f5e(e,{retainCIM:!0,hasLabelingContext:s});return _(n.symbol)?n.symbol.write(t,r):(r.messages&&r.messages.push(new q("symbol:unsupported",`Symbols of type '${e.declaredClass}' are not supported in scenes. Use 3D symbology instead when working with WebScene and SceneView`,{symbol:e,context:r,error:n.error})),null)}return r&&r.origin==="web-map"&&e.type==="web-style"?(r.messages&&r.messages.push(new q("symbol:unsupported",`Symbols of type '${e.declaredClass}' are not supported in webmaps. Use CIMSymbol instead when working with WebMap in MapView.`,{symbol:e,context:r})),null):e.write(t,r)}function Ugt(e,t){return kCe(e,null,t)}const TO={types:xce,json:{write:{writer:uL},origins:{"web-scene":{types:qY,write:{writer:uL},read:{reader:PS({types:qY})}}}}},Afe={types:{base:Al,key:"type",typeMap:{"simple-fill":n1.typeMap["simple-fill"],"picture-fill":n1.typeMap["picture-fill"],"polygon-3d":n1.typeMap["polygon-3d"]}},json:{write:{writer:uL},origins:{"web-scene":{type:hO,write:{writer:uL}}}}};var b8;let Qg=b8=class extends fe{constructor(e){super(e),this.description=null,this.label=null,this.minValue=null,this.maxValue=0,this.symbol=null}clone(){return new b8({description:this.description,label:this.label,minValue:this.minValue,maxValue:this.maxValue,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const e=JSON.stringify(this.symbol);return`${this.minValue}.${this.maxValue}.${e}`}};u([d({type:String,json:{write:!0}})],Qg.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Qg.prototype,"label",void 0),u([d({type:Number,json:{read:{source:"classMinValue"},write:{target:"classMinValue"}}})],Qg.prototype,"minValue",void 0),u([d({type:Number,json:{read:{source:"classMaxValue"},write:{target:"classMaxValue"}}})],Qg.prototype,"maxValue",void 0),u([d(TO)],Qg.prototype,"symbol",void 0),Qg=b8=u([P("esri.renderers.support.ClassBreakInfo")],Qg);const hL=Qg;var w8;const GM=he.getLogger("esri.renderers.ClassBreaksRenderer"),Cfe="log",zI="percent-of-total",BI="field",jM=new si({esriNormalizeByLog:Cfe,esriNormalizeByPercentOfTotal:zI,esriNormalizeByField:BI}),m5e=Ir(hL);let Gs=w8=class extends xO(V0){constructor(e){super(e),this._compiledValueExpression={valueExpression:null,compiledFunction:null},this.backgroundFillSymbol=null,this.classBreakInfos=null,this.defaultLabel=null,this.defaultSymbol=null,this.field=null,this.isMaxInclusive=!0,this.legendOptions=null,this.normalizationField=null,this.normalizationTotal=null,this.type="class-breaks",this.valueExpression=null,this.valueExpressionTitle=null,this._set("classBreakInfos",[])}readClassBreakInfos(e,t,i){if(!Array.isArray(e))return;let r=t.minValue;return e.map(s=>{const n=new hL;return n.read(s,i),n.minValue==null&&(n.minValue=r),n.maxValue==null&&(n.maxValue=n.minValue),r=n.maxValue,n})}writeClassBreakInfos(e,t,i,r){const s=e.map(n=>n.write({},r));this._areClassBreaksConsecutive()&&s.forEach(n=>delete n.classMinValue),t[i]=s}castField(e){return e==null?e:typeof e=="function"?(GM.error(".field: field must be a string value"),null):KR(e)}get minValue(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0}get normalizationType(){let e=this._get("normalizationType");const t=!!this.normalizationField,i=this.normalizationTotal!=null;return t||i?(e=t&&BI||i&&zI||null,t&&i&&GM.warn("warning: both normalizationField and normalizationTotal are set!")):e!==BI&&e!==zI||(e=null),e}set normalizationType(e){this._set("normalizationType",e)}addClassBreakInfo(e,t,i){let r=null;r=typeof e=="number"?new hL({minValue:e,maxValue:t,symbol:Tce(i)}):m5e(se(e)),this.classBreakInfos.push(r),this.classBreakInfos.length===1&&this.notifyChange("minValue")}removeClassBreakInfo(e,t){const i=this.classBreakInfos.length;for(let r=0;r<i;r++){const s=[this.classBreakInfos[r].minValue,this.classBreakInfos[r].maxValue];if(s[0]===e&&s[1]===t){this.classBreakInfos.splice(r,1);break}}}getBreakIndex(e,t){return this.valueExpression&&(R(t)||R(t.arcade))&&GM.warn(""),this.valueExpression?this._getBreakIndexForExpression(e,t):this._getBreakIndexForField(e)}async getClassBreakInfo(e,t){let i=t;this.valueExpression&&(R(t)||R(t.arcade))&&(i=me(I({},i),{arcade:await wp()}));const r=this.getBreakIndex(e,i);return r!==-1?this.classBreakInfos[r]:null}getSymbol(e,t){if(this.valueExpression&&(R(t)||R(t.arcade)))return void GM.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const i=this.getBreakIndex(e,t);return i>-1?this.classBreakInfos[i].symbol:this.defaultSymbol}async getSymbolAsync(e,t){let i=t;if(this.valueExpression&&(R(t)||R(t.arcade))){const s=await wp(),{arcadeUtils:n}=s;n.hasGeometryOperations(this.valueExpression)&&await n.enableGeometryOperations(),i=me(I({},i),{arcade:s})}const r=this.getBreakIndex(e,i);return r>-1?this.classBreakInfos[r].symbol:this.defaultSymbol}getSymbols(){const e=[];return this.classBreakInfos.forEach(t=>{t.symbol&&e.push(t.symbol)}),this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),i=`${this.normalizationField}.${this.normalizationType}.${this.normalizationTotal}`;return`${e}.${t}.${this.classBreakInfos.reduce((r,s)=>r+s.getMeshHash(),"")}.${i}.${this.field}.${this.valueExpression}`}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}clone(){return new w8({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:se(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:se(this.visualVariables),legendOptions:se(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}async collectRequiredFields(e,t){const i=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(i)}async collectSymbolFields(e,t){const i=[...this.getSymbols().map(r=>r.collectRequiredFields(e,t)),wc(e,t,this.valueExpression)];Mu(e,t,this.field),Mu(e,t,this.normalizationField),await Promise.all(i)}_getBreakIndexForExpression(e,t){const{viewingMode:i,scale:r,spatialReference:s,arcade:n}=gt(t,{});let o=this._compiledValueExpression.valueExpression===this.valueExpression?this._compiledValueExpression.compiledFunction:null;const a=n.arcadeUtils;if(!o){const c=a.createSyntaxTree(this.valueExpression);o=a.createFunction(c),this._compiledValueExpression.compiledFunction=o}this._compiledValueExpression.valueExpression=this.valueExpression;const l=a.executeFunction(o,a.createExecContext(e,a.getViewInfo({viewingMode:i,scale:r,spatialReference:s})));return this._getBreakIndexfromInfos(l)}_getBreakIndexForField(e){const t=this.field,i=e.attributes,r=this.normalizationType;let s=parseFloat(i[t]);if(r){const n=this.normalizationTotal,o=parseFloat(i[this.normalizationField]);if(r===Cfe)s=Math.log(s)*Math.LOG10E;else if(r!==zI||isNaN(n)){if(r===BI&&!isNaN(o)){if(isNaN(s)||isNaN(o))return-1;s/=o}}else s=s/n*100}return this._getBreakIndexfromInfos(s)}_getBreakIndexfromInfos(e){const t=this.isMaxInclusive;if(e!=null&&typeof e=="number"&&!isNaN(e))for(let i=0;i<this.classBreakInfos.length;i++){const r=[this.classBreakInfos[i].minValue,this.classBreakInfos[i].maxValue];if(r[0]<=e&&(t?e<=r[1]:e<r[1]))return i}return-1}_areClassBreaksConsecutive(){const e=this.classBreakInfos,t=e.length;for(let i=1;i<t;i++)if(e[i-1].maxValue!==e[i].minValue)return!1;return!0}};u([d(Afe)],Gs.prototype,"backgroundFillSymbol",void 0),u([d({type:[hL]})],Gs.prototype,"classBreakInfos",void 0),u([De("classBreakInfos")],Gs.prototype,"readClassBreakInfos",null),u([Fe("classBreakInfos")],Gs.prototype,"writeClassBreakInfos",null),u([d({type:String,json:{write:!0}})],Gs.prototype,"defaultLabel",void 0),u([d(TO)],Gs.prototype,"defaultSymbol",void 0),u([d({type:String,json:{write:!0}})],Gs.prototype,"field",void 0),u([At("field")],Gs.prototype,"castField",null),u([d({type:Boolean})],Gs.prototype,"isMaxInclusive",void 0),u([d({type:UH,json:{write:!0}})],Gs.prototype,"legendOptions",void 0),u([d({type:Number,readOnly:!0,value:null,json:{read:!1,write:{overridePolicy(){return this.classBreakInfos.length!==0&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],Gs.prototype,"minValue",null),u([d({type:String,json:{write:!0}})],Gs.prototype,"normalizationField",void 0),u([d({type:Number,cast:e=>mu(e),json:{write:!0}})],Gs.prototype,"normalizationTotal",void 0),u([d({type:jM.apiValues,value:null,json:{type:jM.jsonValues,read:jM.read,write:jM.write}})],Gs.prototype,"normalizationType",null),u([ut({classBreaks:"class-breaks"})],Gs.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Gs.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],Gs.prototype,"valueExpressionTitle",void 0),Gs=w8=u([P("esri.renderers.ClassBreaksRenderer")],Gs);const Rfe=Gs,VI=-3;var Jf;(function(e){e[e.ALL=0]="ALL",e[e.SOME=1]="SOME"})(Jf||(Jf={}));class g5e{constructor(t,i,r){this._namespace=t,this._storage=i,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),this._namespace+=":",r&&(this._storage.registerRemoveFunc(this._namespace,r),this._removeFunc=!0)}destroy(){this._storage.clear(this._namespace),this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace),this._storage.deregister(this),this._storage=null}get namespace(){return this._namespace.slice(0,-1)}get hitRate(){return this._hit/(this._hit+this._miss)}get size(){return this._storage.size}get maxSize(){return this._storage.maxSize}resetHitRate(){this._hit=this._miss=0}put(t,i,r,s=0){this._storage.put(this._namespace+t,i,r,s)}get(t){const i=this._storage.get(this._namespace+t);return i===void 0?++this._miss:++this._hit,i}pop(t){const i=this._storage.pop(this._namespace+t);return i===void 0?++this._miss:++this._hit,i}updateSize(t,i,r){this._storage.updateSize(this._namespace+t,i,r)}clear(){this._storage.clear(this._namespace)}clearAll(){this._storage.clearAll()}getStats(){return this._storage.getStats()}resetStats(){this._storage.resetStats()}}class BH{constructor(t=10485760){this._maxSize=t,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new $t,this._users=new $t}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(t){this._users.push(t)}deregister(t){this._users.removeUnordered(t)}registerRemoveFunc(t,i){this._removeFuncs.push([t,i])}deregisterRemoveFunc(t){this._removeFuncs.filterInPlace(i=>i[0]!==t)}get size(){return this._size}get maxSize(){return this._maxSize}set maxSize(t){this._maxSize=Math.max(t,0),this._checkSizeLimit()}put(t,i,r,s){const n=this._db.get(t);if(n&&(this._size-=n.size,this._db.delete(t),n.entry!==i&&this._notifyRemove(t,n.entry,Jf.ALL)),r>this._maxSize)return void this._notifyRemove(t,i,Jf.ALL);if(i===void 0)return void console.warn("Refusing to cache undefined entry ");if(!r||r<0)return void console.warn("Refusing to cache entry with invalid size "+r);const o=1+Math.max(s,VI)-VI;this._db.set(t,{entry:i,size:r,lifetime:o,lives:o}),this._size+=r,this._checkSizeLimit()}updateSize(t,i,r){const s=this._db.get(t);if(s&&s.entry===i){for(this._size-=s.size;r>this._maxSize;){const n=this._notifyRemove(t,i,Jf.SOME);if(!(_(n)&&n>0))return void this._db.delete(t);r=n}s.size=r,this._size+=r,this._checkSizeLimit()}}pop(t){const i=this._db.get(t);if(i)return this._size-=i.size,this._db.delete(t),++this._hit,i.entry;++this._miss}get(t){const i=this._db.get(t);if(i!==void 0)return this._db.delete(t),i.lives=i.lifetime,this._db.set(t,i),++this._hit,i.entry;++this._miss}getStats(){const t={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},i={},r=new Array;this._db.forEach((o,a)=>{const l=o.lifetime;r[l]=(r[l]||0)+o.size,this._users.forAll(c=>{const h=c.namespace;if(a.startsWith(h)){const p=i[h]||0;i[h]=p+o.size}})});const s={};this._users.forAll(o=>{const a=o.namespace;if(!isNaN(o.hitRate)&&o.hitRate>0){const l=i[a]||0;i[a]=l,s[a]=Math.round(100*o.hitRate)+"%"}else s[a]="0%"});const n=Object.keys(i);n.sort((o,a)=>i[a]-i[o]),n.forEach(o=>t[o]=Math.round(i[o]/2**20)+"MB / "+s[o]);for(let o=r.length-1;o>=0;--o){const a=r[o];a&&(t["Priority "+(o+VI-1)]=Math.round(a/this.size*100)+"%")}return t}resetStats(){this._hit=this._miss=0,this._users.forAll(t=>t.resetHitRate())}clear(t){this._db.forEach((i,r)=>{r.startsWith(t)&&(this._size-=i.size,this._db.delete(r),this._notifyRemove(r,i.entry,Jf.ALL))})}clearAll(){this._db.forEach((t,i)=>this._notifyRemove(i,t.entry,Jf.ALL)),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(t,i,r){let s;return this._removeFuncs.some(n=>{if(t.startsWith(n[0])){const o=n[1](i,r);return typeof o=="number"&&(s=o),!0}return!1}),s}_checkSizeLimit(){if(!(this._size<=this._maxSize))for(const[t,i]of this._db){if(this._db.delete(t),i.lives<=1){this._size-=i.size;const r=this._notifyRemove(t,i.entry,Jf.SOME);_(r)&&r>0&&(this._size+=r,i.lives=i.lifetime,i.size=r,this._db.set(t,i))}else--i.lives,this._db.set(t,i);if(this._size<=.9*this.maxSize)return}}}class y5e{constructor(t,i){this._storage=new BH,this._storage.maxSize=t,i&&this._storage.registerRemoveFunc("",i)}put(t,i,r){this._storage.put(t,i,r,1)}pop(t){return this._storage.pop(t)}get(t){return this._storage.get(t)}clear(){this._storage.clearAll()}destroy(){this._storage.destroy()}get maxSize(){return this._storage.maxSize}set maxSize(t){this._storage.maxSize=t}}const RJ=he.getLogger("esri.renderers.support.DictionaryLoader"),v5e={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};class VH{constructor(t,i,r){this.config=null,this.fieldMap=null,this.url=null,this._ongoingRequests=new Map,this._symbolCache=new y5e(100),this.url=t,this.config=i,this.fieldMap=r}getSymbolFields(){return this._symbolFields}async getSymbolAsync(t,i){let r;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(i));try{r=await this._dictionaryPromise}catch(g){if(pr(g))return this._dictionaryPromise=null,null}const s={};if(this.fieldMap)for(const g of this._symbolFields){const y=this.fieldMap[g];if(y&&t.attributes[y]!=null){const v=""+t.attributes[y];s[g]=v}else s[g]=""}const n=r(s,i);if(!n||typeof n!="string")return null;const o=v7(n).toString(),a=this._symbolCache.get(o);if(a)return a.catch(()=>{this._symbolCache.pop(o)}),a;const l=n.split(";"),c=[],h=[];for(const g of l)if(g)if(g.includes("po:")){const y=g.substr(3).split("|");if(y.length===3){const v=y[0],b=y[1];let w=y[2];if(b==="DashTemplate")w=w.split(" ").map(S=>Number(S));else if(b==="Color"){const S=new Je(w).toRgba();w=[S[0],S[1],S[2],255*S[3]]}else w=Number(w);h.push({primitiveName:v,propertyName:b,value:w})}}else if(g.includes("|")){for(const y of g.split("|"))if(this._itemNames.has(y)){c.push(y);break}}else this._itemNames.has(g)&&c.push(g);const p=!_(t.geometry)||!t.geometry.hasZ&&t.geometry.type==="point",f=this._cimPartsToCIMSymbol(c,h,p,i);return this._symbolCache.put(o,f,1),f}async fetchResources(t){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void RJ.error("no valid URL!");const i=_(t)?t.abortOptions:null,r=Ti(this.url+"/resources/styles/dictionary-info.json",I({responseType:"json",query:{f:"json"}},i)),[{data:s}]=await Promise.all([r,wp()]);if(!s)throw this._dictionaryPromise=null,new q("esri.renderers.DictionaryRenderer","Bad dictionary data!");const n=s.expression,o=s.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+s.cimRefTemplateUrl,this._itemNames=new Set(s.itemsNames),this._symbolFields=o.symbol;const a={};if(this.config){const c=this.config;for(const h in c)a[h]=c[h]}if(o.configuration)for(const c of o.configuration)a.hasOwnProperty(c.name)||(a[c.name]=c.value);const l=[];if(_(t)&&t.fields&&this.fieldMap)for(const c of this._symbolFields){const h=this.fieldMap[c],p=t.fields.filter(f=>f.name===h);p.length>0&&l.push(me(I({},p[0]),{name:c}))}return this._dictionaryPromise=z2e(n,_(t)?t.spatialReference:null,l,a).then(c=>{const h={scale:0};return(p,f)=>{const g=c.repurposeFeature({geometry:null,attributes:p});return h.scale=_(f)?f.scale:void 0,c.evaluate({$feature:g,$view:h})}}).catch(c=>(RJ.error("Creating dictinoary expression failed:",c),null)),this._dictionaryPromise}async _cimPartsToCIMSymbol(t,i,r,s){const n=new Array(t.length);for(let l=0;l<t.length;l++)n[l]=this._getSymbolPart(t[l],s);const o=await Promise.all(n),a=this.fieldMap;for(const l of o)Ofe(l,a);return new $S({data:this._combineSymbolParts(o,i,r)})}async _getSymbolPart(t,i){if(this._ongoingRequests.has(t))return this._ongoingRequests.get(t).then(n=>n.data);const r=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,t),s=Ti(r,I({responseType:"json",query:{f:"json"}},i));this._ongoingRequests.set(t,s);try{return(await s).data}catch(n){return this._ongoingRequests.delete(t),Promise.reject(n)}}_combineSymbolParts(t,i,r){if(!t||t.length===0)return null;const s=I({},t[0]);if(t.length>1){s.symbolLayers=[];for(const n of t){const o=n;s.symbolLayers.unshift(...o.symbolLayers)}}return r&&(s.callout=v5e),{type:"CIMSymbolReference",symbol:s,primitiveOverrides:i}}}function Ofe(e,t){if(!e)return;const i=e.symbolLayers;if(!i)return;let r=i.length;for(;r--;){const s=i[r];s&&s.enable!==!1&&s.type==="CIMVectorMarker"&&_5e(s,t)}}function _5e(e,t){const i=e.markerGraphics;if(i)for(const r of i){if(!r)continue;const s=r.symbol;if(s)switch(s.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":Ofe(s,t);break;case"CIMTextSymbol":s.fieldMap=t}}}var kgt=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",DictionaryLoader:VH}),x8;let ph=x8=class extends xO(V0){constructor(e){super(e),this.config=null,this.fieldMap=null,this.scaleExpression=null,this.scaleExpressionTitle=null,this.url=null,this.type="dictionary"}get _loader(){return new VH(this.url,this.config,this.fieldMap)}writeData(e,t){e&&(t.scalingExpressionInfo={expression:e,returnType:"number"})}writeVisualVariables(e,t,i,r){r!=null&&r.origin||super.writeVisualVariables(e,t,i,r)}clone(){return new x8({config:se(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:se(this.fieldMap),url:se(this.url),visualVariables:se(this.visualVariables)})}async getSymbolAsync(e,t){return this._loader.getSymbolAsync(e,t)}async collectRequiredFields(e,t){await this.collectVVRequiredFields(e,t),this.scaleExpression&&await wc(e,t,this.scaleExpression);for(const i in this.fieldMap){const r=this.fieldMap[i];t.has(r)&&e.add(r)}}get arcadeRequired(){return!0}getSymbol(){return null}getSymbols(){return[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){return`${this.url}-${JSON.stringify(this.fieldMap)}`}getSymbolFields(){return this._loader.getSymbolFields()}};u([d({type:VH})],ph.prototype,"_loader",null),u([d({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],ph.prototype,"config",void 0),u([d({type:Object,json:{write:!0}})],ph.prototype,"fieldMap",void 0),u([d({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],ph.prototype,"scaleExpression",void 0),u([Fe("scaleExpression")],ph.prototype,"writeData",null),u([d({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(e){return{enabled:!!e&&!!this.scaleExpression}}}}})],ph.prototype,"scaleExpressionTitle",void 0),u([d({type:String,json:{write:!0}})],ph.prototype,"url",void 0),u([Fe("visualVariables")],ph.prototype,"writeVisualVariables",null),ph=x8=u([P("esri.renderers.DictionaryRenderer")],ph);const b5e=ph;var T8;const w5e=he.getLogger("esri.renderers.support.AttributeColorInfo");let Cf=T8=class extends fe{constructor(e){super(e),this.color=null,this.field=null,this.label=null,this.valueExpression=null,this.valueExpressionTitle=null}castField(e){return e==null?e:typeof e=="function"?(w5e.error(".field: field must be a string value"),null):KR(e)}getAttributeHash(){return`${this.field}-${this.valueExpression}`}clone(){return new T8({color:this.color&&this.color.clone(),field:this.field,label:this.label,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};u([d({type:Je,json:{type:[Number],write:!0}})],Cf.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],Cf.prototype,"field",void 0),u([At("field")],Cf.prototype,"castField",null),u([d({type:String,json:{write:!0}})],Cf.prototype,"label",void 0),u([d({type:String,json:{write:!0}})],Cf.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],Cf.prototype,"valueExpressionTitle",void 0),Cf=T8=u([P("esri.renderers.support.AttributeColorInfo")],Cf);const x5e=Cf;var S8;let GI=S8=class extends fe{constructor(){super(...arguments),this.unit=null}clone(){return new S8({unit:this.unit})}};u([d({type:String,json:{write:!0}})],GI.prototype,"unit",void 0),GI=S8=u([P("esri.renderers.support.DotDensityLegendOptions")],GI);const T5e=GI;var E8;let Co=E8=class extends xO(V0){constructor(e){super(e),this.attributes=null,this.backgroundColor=new Je([0,0,0,0]),this.blendDots=!0,this.dotBlendingEnabled=!0,this.dotShape="square",this.dotSize=1,this.legendOptions=null,this.outline=new sd,this.dotValue=null,this.referenceDotValue=null,this.referenceScale=null,this.seed=1,this.type="dot-density"}calculateDotValue(e){if(this.referenceScale==null)return this.dotValue;const t=e/this.referenceScale*this.dotValue;return t<1?1:t}getSymbol(){return new ub({outline:this.outline})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}getAttributeHash(){return this.attributes&&this.attributes.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){return JSON.stringify(this.outline)}clone(){return new E8({attributes:se(this.attributes),backgroundColor:se(this.backgroundColor),dotBlendingEnabled:se(this.dotBlendingEnabled),dotShape:se(this.dotShape),dotSize:se(this.dotSize),dotValue:se(this.dotValue),legendOptions:se(this.legendOptions),outline:se(this.outline),referenceScale:se(this.referenceScale),visualVariables:se(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}getControllerHash(){return`${this.attributes.map(e=>e.field||e.valueExpression||"")}-${this.outline&&JSON.stringify(this.outline.toJSON())||""}`}async collectRequiredFields(e,t){await this.collectVVRequiredFields(e,t);for(const i of this.attributes)i.valueExpression&&await wc(e,t,i.valueExpression),i.field&&e.add(i.field)}};u([d({type:[x5e],json:{write:!0}})],Co.prototype,"attributes",void 0),u([d({type:Je,json:{write:!0}})],Co.prototype,"backgroundColor",void 0),u([d({type:Boolean}),mt("dotBlendingEnabled")],Co.prototype,"blendDots",void 0),u([d({type:Boolean,json:{write:!0}})],Co.prototype,"dotBlendingEnabled",void 0),u([d({type:String,json:{write:!1}})],Co.prototype,"dotShape",void 0),u([d({type:Number,json:{write:!0,origins:{"web-map":{write:!1},"web-scene":{write:!1}}}})],Co.prototype,"dotSize",void 0),u([d({type:T5e,json:{write:!0}})],Co.prototype,"legendOptions",void 0),u([d({type:sd,json:{default:null,write:!0}})],Co.prototype,"outline",void 0),u([d({type:Number,json:{write:!0}})],Co.prototype,"dotValue",void 0),u([d({type:Number}),mt("dotValue")],Co.prototype,"referenceDotValue",void 0),u([d({type:Number,json:{write:!0}})],Co.prototype,"referenceScale",void 0),u([d({type:Number,json:{write:!0}})],Co.prototype,"seed",void 0),u([ut({dotDensity:"dot-density"})],Co.prototype,"type",void 0),Co=E8=u([P("esri.renderers.DotDensityRenderer")],Co);const S5e=Co;var A8;let sA=A8=class extends fe{constructor(e){super(e),this.color=null,this.ratio=null}clone(){return new A8({color:this.color,ratio:this.ratio})}};u([d({type:Je,json:{write:!0}})],sA.prototype,"color",void 0),u([d({type:Number,json:{write:!0}})],sA.prototype,"ratio",void 0),sA=A8=u([P("esri.renderers.support.HeatmapColorStop")],sA);const jI=sA;var C8;let fh=C8=class extends V0{constructor(e){super(e),this.blurRadius=10,this.referenceScale=0,this.colorStops=[new jI({ratio:0,color:new Je("rgba(255, 140, 0, 0)")}),new jI({ratio:.75,color:new Je("rgba(255, 140, 0, 1)")}),new jI({ratio:.9,color:new Je("rgba(255, 0,   0, 1)")})],this.field=null,this.fieldOffset=0,this.maxPixelIntensity=100,this.minPixelIntensity=0,this.type="heatmap"}async collectRequiredFields(e,t){const i=this.field;i&&typeof i=="string"&&Mu(e,t,i)}getAttributeHash(){return null}getMeshHash(){return`${JSON.stringify(this.colorStops)}.${this.blurRadius}.${this.field}`}clone(){return new C8({blurRadius:this.blurRadius,referenceScale:this.referenceScale,colorStops:se(this.colorStops),field:this.field,maxPixelIntensity:this.maxPixelIntensity,minPixelIntensity:this.minPixelIntensity})}};u([d({type:Number,json:{write:!0}})],fh.prototype,"blurRadius",void 0),u([d({type:Number})],fh.prototype,"referenceScale",void 0),u([d({type:[jI],json:{write:!0}})],fh.prototype,"colorStops",void 0),u([d({type:String,json:{write:!0}})],fh.prototype,"field",void 0),u([d({type:Number,json:{write:{overridePolicy:(e,t,i)=>({enabled:i==null})}}})],fh.prototype,"fieldOffset",void 0),u([d({type:Number,json:{write:!0}})],fh.prototype,"maxPixelIntensity",void 0),u([d({type:Number,json:{write:!0}})],fh.prototype,"minPixelIntensity",void 0),u([ut({heatmap:"heatmap"})],fh.prototype,"type",void 0),fh=C8=u([P("esri.renderers.HeatmapRenderer")],fh);const E5e=fh;var R8;let Jv=R8=class extends xO(V0){constructor(e){super(e),this.description=null,this.label=null,this.symbol=null,this.type="simple"}async collectRequiredFields(e,t){await Promise.all([this.collectSymbolFields(e,t),this.collectVVRequiredFields(e,t)])}async collectSymbolFields(e,t){await Promise.all(this.getSymbols().map(i=>i.collectRequiredFields(e,t)))}getSymbol(e,t){return this.symbol}async getSymbolAsync(e,t){return this.symbol}getSymbols(){return this.symbol?[this.symbol]:[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){return this.getSymbols().reduce((e,t)=>e+JSON.stringify(t),"")}get arcadeRequired(){return this.arcadeRequiredForVisualVariables}clone(){return new R8({description:this.description,label:this.label,symbol:this.symbol&&this.symbol.clone(),visualVariables:se(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}};u([d({type:String,json:{write:!0}})],Jv.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Jv.prototype,"label",void 0),u([d(TO)],Jv.prototype,"symbol",void 0),u([ut({simple:"simple"})],Jv.prototype,"type",void 0),Jv=R8=u([P("esri.renderers.SimpleRenderer")],Jv);const GH=Jv,A5e=["esri.Color","esri.portal.Portal","esri.symbols.support.Symbol3DAnchorPosition2D","esri.symbols.support.Symbol3DAnchorPosition3D"];function O8(e){return e instanceof we}function OJ(e){return e instanceof it?Object.keys(e.items):O8(e)?Ra(e).keys():e?Object.keys(e):[]}function HM(e,t){return e instanceof it?e.items[t]:e[t]}function C5e(e,t){return!(!Array.isArray(e)||!Array.isArray(t))&&e.length!==t.length}function sC(e){return e?e.declaredClass:null}function Mfe(e,t){const i=e.diff;if(i&&typeof i=="function")return i(e,t);const r=OJ(e),s=OJ(t);if(r.length===0&&s.length===0)return;if(!r.length||!s.length||C5e(e,t))return{type:"complete",oldValue:e,newValue:t};const n=s.filter(p=>r.indexOf(p)===-1),o=r.filter(p=>s.indexOf(p)===-1),a=r.filter(p=>s.indexOf(p)>-1&&HM(e,p)!==HM(t,p)).concat(n,o).sort(),l=sC(e);if(l&&A5e.indexOf(l)>-1&&a.length)return{type:"complete",oldValue:e,newValue:t};let c;const h=O8(e)&&O8(t);for(const p of a){const f=HM(e,p),g=HM(t,p);let y;(h||typeof f!="function"&&typeof g!="function")&&f!==g&&(f==null&&g==null||(y=i&&i[p]&&typeof i[p]=="function"?i[p](f,g):typeof f=="object"&&typeof g=="object"&&sC(f)===sC(g)?Mfe(f,g):{type:"complete",oldValue:f,newValue:g},_(y)&&(_(c)?c.diff[p]=y:c={type:"partial",diff:{[p]:y}})))}return c}function R5e(e,t){if(R(e))return!1;const i=t.split(".");let r=e;for(const s of i){if(r.type==="complete")return!0;if(r.type!=="partial")return!1;{const n=r.diff[s];if(!n)return!1;r=n}}return!0}function zgt(e,t){for(const i of t)if(R5e(e,i))return!0;return!1}function O5e(e,t){if(!(typeof e=="function"||typeof t=="function"||R(e)&&R(t)))return R(e)||R(t)||typeof e=="object"&&typeof t=="object"&&sC(e)!==sC(t)?{type:"complete",oldValue:e,newValue:t}:Mfe(e,t)}function qM(e){if(R(e))return!0;switch(e.type){case"complete":return!1;case"collection":{const t=e;for(const i of t.added)if(!qM(i))return!1;for(const i of t.removed)if(!qM(i))return!1;for(const i of t.changed)if(!qM(i))return!1;return!0}case"partial":for(const t in e.diff)if(!qM(e.diff[t]))return!1;return!0}}var M8;let Jg=M8=class extends fe{constructor(e){super(e),this.description=null,this.label=null,this.symbol=null,this.value=null}castValue(e){return e==null||typeof e=="string"||typeof e=="number"?e:`${e}`}clone(){return new M8({value:this.value,description:this.description,label:this.label,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const e=JSON.stringify(this.symbol&&this.symbol.toJSON());return`${this.value}.${e}`}};u([d({type:String,json:{write:!0}})],Jg.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Jg.prototype,"label",void 0),u([d(TO)],Jg.prototype,"symbol",void 0),u([d({json:{type:String,write:{writer:(e,t)=>{t.value=e==null?void 0:e.toString()}}}})],Jg.prototype,"value",void 0),u([At("value")],Jg.prototype,"castValue",null),Jg=M8=u([P("esri.renderers.support.UniqueValueInfo")],Jg);const dL=Jg,M5e=()=>!!ue("enable-feature:force-wosr"),Bgt=()=>!!ue("enable-feature:direct-3d-object-feature-layer-display"),P5e=()=>!!ue("enable-feature:precipitation"),gU={};async function I5e(e,t){try{return{data:(await N5e(e,t)).data,baseUrl:UAe(e),styleUrl:e}}catch(i){return zm(i),null}}function $5e(e,t,i){const r=t&&t.portal||Bn.getDefault();let s;const n=`${r.url} - ${r.user&&r.user.username} - ${e}`;return gU[n]||(gU[n]=D5e(e,r,i).then(o=>(s=o,o.fetchData())).then(o=>({data:o,baseUrl:s.itemUrl,styleName:e}))),gU[n]}function D5e(e,t,i){return t.load(i).then(()=>{const r=new im({disableExtraQuery:!0,query:`owner:${MJ} AND type:${PJ} AND typekeywords:"${e}"`});return t.queryItems(r,i)}).then(({results:r})=>{let s=null;const n=e.toLowerCase();if(r&&Array.isArray(r)){for(const o of r)if(o.typeKeywords.some(a=>a.toLowerCase()===n)&&o.type===PJ&&o.owner===MJ){s=o;break}}if(!s)throw new q("symbolstyleutils:style-not-found",`The style '${e}' could not be found`,{styleName:e});return s.load(i)})}function L5e(e,t,i){return e.styleUrl?I5e(e.styleUrl,i):e.styleName?$5e(e.styleName,t,i):Promise.reject(new q("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function Vgt(e){return e===null||e.type==="CIMSymbolReference"?e:{type:"CIMSymbolReference",symbol:e}}function Ggt(e,t){if(t==="cimRef")return e.cimRef;if(e.formatInfos&&!M5e()){for(const i of e.formatInfos)if(i.type==="gltf")return i.href}return e.webRef}function N5e(e,t){const i=I({responseType:"json",query:{f:"json"}},t);return Ti(Pu(e),i)}const MJ="esri_en",PJ="Style",jgt="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";var nA;const Q0=he.getLogger("esri.renderers.UniqueValueRenderer"),F5e=Ir(dL);let Kr=nA=class extends xO(V0){constructor(e){super(e),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this.type="unique-value",this.backgroundFillSymbol=null,this.field=null,this.field2=null,this.field3=null,this.valueExpression=null,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.fieldDelimiter=null,this.portal=null,this.styleOrigin=null,this.diff={uniqueValueInfos(t,i){if(!t&&!i)return;if(!t||!i)return{type:"complete",oldValue:t,newValue:i};let r=!1;const s={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let n=0;n<i.length;n++){const o=t.find(a=>a.value===i[n].value);o?O5e(o,i[n])?(s.changed.push({type:"complete",oldValue:o,newValue:i[n]}),r=!0):s.unchanged.push({oldValue:o,newValue:i[n]}):(s.added.push(i[n]),r=!0)}for(let n=0;n<t.length;n++)i.find(o=>o.value===t[n].value)||(s.removed.push(t[n]),r=!0);return r?s:void 0}},this._set("uniqueValueInfos",[])}get _cache(){return{compiledFunc:null}}castField(e){return e==null||typeof e=="function"?e:KR(e)}writeField(e,t,i,r){typeof e=="string"?t[i]=e:r&&r.messages?r.messages.push(new q("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):Q0.error(".field: cannot write field to JSON since it's not a string value")}set defaultSymbol(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}readPortal(e,t,i){return i.portal||Bn.getDefault()}readStyleOrigin(e,t,i){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const r=US(t.styleUrl,i);return Object.freeze({styleUrl:r})}}writeStyleOrigin(e,t,i,r){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=R1(e.styleUrl,r))}set uniqueValueInfos(e){this.styleOrigin?Q0.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap())}addUniqueValueInfo(e,t){if(this.styleOrigin)return void Q0.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let i;i=typeof e=="object"?F5e(e):new dL({value:e,symbol:Tce(t)}),this.uniqueValueInfos.push(i),this._valueInfoMap[i.value]=i}removeUniqueValueInfo(e){if(this.styleOrigin)Q0.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");else for(let t=0;t<this.uniqueValueInfos.length;t++)if(this.uniqueValueInfos[t].value===e+""){delete this._valueInfoMap[e],this.uniqueValueInfos.splice(t,1);break}}async getUniqueValueInfo(e,t){let i=t;return this.valueExpression&&(R(t)||R(t.arcade))&&(i=me(I({},i),{arcade:await wp()})),this._getUniqueValueInfo(e,i)}getSymbol(e,t){if(this.valueExpression&&(R(t)||R(t.arcade)))return void Q0.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const i=this._getUniqueValueInfo(e,t);return i&&i.symbol||this.defaultSymbol}async getSymbolAsync(e,t){let i=t;if(this.valueExpression&&(R(i)||R(i.arcade))){const s=await wp(),{arcadeUtils:n}=s;n.hasGeometryOperations(this.valueExpression)&&await n.enableGeometryOperations(),i=me(I({},i),{arcade:s})}const r=this._getUniqueValueInfo(e,i);return r&&r.symbol||this.defaultSymbol}getSymbols(){const e=[];for(const t of this.uniqueValueInfos)t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){return`${JSON.stringify(this.backgroundFillSymbol)}.${JSON.stringify(this.defaultSymbol)}.${this.uniqueValueInfos.reduce((e,t)=>e+t.getMeshHash(),"")}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`}clone(){const e=new nA({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:se(this.defaultSymbol),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:se(this.visualVariables),legendOptions:se(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:se(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const t=se(this.uniqueValueInfos);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(se(this.styleOrigin))),Object.freeze(t)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}async collectRequiredFields(e,t){const i=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(i)}async collectSymbolFields(e,t){const i=[...this.getSymbols().map(r=>r.collectRequiredFields(e,t)),wc(e,t,this.valueExpression)];Mu(e,t,this.field),Mu(e,t,this.field2),Mu(e,t,this.field3),await Promise.all(i)}populateFromStyle(){return L5e(this.styleOrigin,{portal:this.portal}).then(e=>{const t=[];return this._valueInfoMap={},e&&e.data&&Array.isArray(e.data.items)&&e.data.items.forEach(i=>{const r=new hb({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:i.name});this.defaultSymbol||i.name!==e.data.defaultItem||(this.defaultSymbol=r,this._isDefaultSymbolDerived=!0);const s=new dL({value:i.name,symbol:r});t.push(s),this._valueInfoMap[i.name]=s}),this._set("uniqueValueInfos",Object.freeze(t)),!this.defaultSymbol&&this.uniqueValueInfos.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this})}_updateValueInfoMap(){this._valueInfoMap={},this.uniqueValueInfos.forEach(e=>this._valueInfoMap[e.value+""]=e)}_getUniqueValueInfo(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)}_getUnqiueValueInfoForExpression(e,t){const{viewingMode:i,scale:r,spatialReference:s,arcade:n}=gt(t,{});let o=this._cache.compiledFunc;const a=n.arcadeUtils;if(!o){const c=a.createSyntaxTree(this.valueExpression);o=a.createFunction(c),this._cache.compiledFunc=o}const l=a.executeFunction(o,a.createExecContext(e,a.getViewInfo({viewingMode:i,scale:r,spatialReference:s})));return this._valueInfoMap[l+""]}_getUnqiueValueInfoForFields(e){const t=this.field,i=e.attributes;let r;if(typeof t!="function"&&this.field2){const s=this.field2,n=this.field3,o=[];t&&o.push(i[t]),s&&o.push(i[s]),n&&o.push(i[n]),r=o.join(this.fieldDelimiter||"")}else typeof t=="function"?r=t(e):t&&(r=i[t]);return this._valueInfoMap[r+""]}static fromPortalStyle(e,t){const i=new nA(t&&t.properties);i._set("styleOrigin",Object.freeze({styleName:e})),i._set("portal",t&&t.portal||Bn.getDefault());const r=i.populateFromStyle();return r.catch(s=>{Q0.error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",s)}),r}static fromStyleUrl(e,t){const i=new nA(t&&t.properties);i._set("styleOrigin",Object.freeze({styleUrl:e}));const r=i.populateFromStyle();return r.catch(s=>{Q0.error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",s)}),r}};u([d({readOnly:!0})],Kr.prototype,"_cache",null),u([ut({uniqueValue:"unique-value"})],Kr.prototype,"type",void 0),u([d(Afe)],Kr.prototype,"backgroundFillSymbol",void 0),u([d({json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],Kr.prototype,"field",void 0),u([At("field")],Kr.prototype,"castField",null),u([Fe("field")],Kr.prototype,"writeField",null),u([d({type:String,json:{write:!0}})],Kr.prototype,"field2",void 0),u([d({type:String,json:{write:!0}})],Kr.prototype,"field3",void 0),u([d({type:String,json:{write:!0}})],Kr.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],Kr.prototype,"valueExpressionTitle",void 0),u([d({type:UH,json:{write:!0}})],Kr.prototype,"legendOptions",void 0),u([d({type:String,json:{write:!0}})],Kr.prototype,"defaultLabel",void 0),u([d(Ooe(I({},TO),{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],Kr.prototype,"defaultSymbol",null),u([d({type:String,json:{write:!0}})],Kr.prototype,"fieldDelimiter",void 0),u([d({type:Bn,readOnly:!0})],Kr.prototype,"portal",void 0),u([De("portal",["styleName"])],Kr.prototype,"readPortal",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],Kr.prototype,"styleOrigin",void 0),u([De("styleOrigin",["styleName","styleUrl"])],Kr.prototype,"readStyleOrigin",null),u([Fe("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],Kr.prototype,"writeStyleOrigin",null),u([d({type:[dL],json:{write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],Kr.prototype,"uniqueValueInfos",null),Kr=nA=u([P("esri.renderers.UniqueValueRenderer")],Kr);const jH=Kr,Pfe={key:"type",base:V0,typeMap:{heatmap:E5e,simple:GH,"unique-value":jH,"class-breaks":Rfe,"dot-density":S5e,dictionary:b5e},errorContext:"renderer"},U5e={key:"type",base:V0,typeMap:{simple:GH,"unique-value":jH,"class-breaks":Rfe},errorContext:"renderer"},k5e=PS({types:Pfe});function z5e(e,t,i){return e?e&&(e.styleName||e.styleUrl)&&e.type!=="uniqueValue"?(i&&i.messages&&i.messages.push(new vc("renderer:unsupported","Only UniqueValueRenderer can be referenced from a web style, but found '"+e.type+"'",{definition:e,context:i})),null):k5e(e,t,i):null}class HH{constructor(){this._propertyOriginMap=new Map,this._originStores=new Array(g6),this._values=new Map,this.multipleOriginsSupported=!0}clone(t){const i=new HH,r=this._originStores[oi.DEFAULTS];r&&r.forEach((s,n)=>{i.set(n,se(s),oi.DEFAULTS)});for(let s=oi.SERVICE;s<g6;s++){const n=this._originStores[s];n&&n.forEach((o,a)=>{t&&t.has(a)||i.set(a,se(o),s)})}return i}get(t,i){const r=i===void 0?this._values:this._originStores[i];return r?r.get(t):void 0}keys(t){const i=t==null?this._values:this._originStores[t];return i?[...i.keys()]:[]}set(t,i,r=oi.USER){let s=this._originStores[r];if(s||(s=new Map,this._originStores[r]=s),s.set(t,i),!this._values.has(t)||this._propertyOriginMap.get(t)<=r){const n=this._values.get(t);return this._values.set(t,i),this._propertyOriginMap.set(t,r),n!==i}return!1}delete(t,i=oi.USER){const r=this._originStores[i];if(!r)return;const s=r.get(t);if(r.delete(t),this._values.has(t)&&this._propertyOriginMap.get(t)===i){this._values.delete(t);for(let n=i-1;n>=0;n--){const o=this._originStores[n];if(o&&o.has(t)){this._values.set(t,o.get(t)),this._propertyOriginMap.set(t,n);break}}}return s}has(t,i){const r=i===void 0?this._values:this._originStores[i];return!!r&&r.has(t)}revert(t,i){for(;i>0&&!this.has(t,i);)--i;const r=this._originStores[i],s=r&&r.get(t),n=this._values.get(t);return this._values.set(t,s),this._propertyOriginMap.set(t,i),n!==s}originOf(t){return this._propertyOriginMap.get(t)||oi.DEFAULTS}forEach(t){this._values.forEach(t)}}const Ife=e=>{let t=class extends e{constructor(...i){super(...i);const r=Ra(this),s=r.store,n=new HH;r.store=n,bae(r,s,n)}read(i,r){xae(this,i,r)}getAtOrigin(i,r){const s=yU(this),n=Ny(r);if(typeof i=="string")return s.get(i,n);const o={};return i.forEach(a=>{o[a]=s.get(a,n)}),o}originOf(i){return gD(this.originIdOf(i))}originIdOf(i){return yU(this).originOf(i)}revert(i,r){const s=yU(this),n=Ny(r),o=Ra(this);let a;a=typeof i=="string"?i==="*"?s.keys(n):[i]:i,a.forEach(l=>{o.invalidate(l),s.revert(l,n),o.commit(l)})}};return t=u([P("esri.core.ReadOnlyMultiOriginJSONSupport")],t),t};function yU(e){return Ra(e).store}let IJ=class extends Ife(we){};IJ=u([P("esri.core.ReadOnlyMultiOriginJSONSupport")],IJ);const B5e=e=>{let t=class extends e{constructor(...i){super(...i)}clear(i,r="user"){return vU(this).delete(i,Ny(r))}write(i={},r){return Eae(this,i=i||{},r),i}setAtOrigin(i,r,s){Ra(this).setAtOrigin(i,r,Ny(s))}removeOrigin(i){const r=vU(this),s=Ny(i),n=r.keys(s);for(const o of n)r.originOf(o)===s&&r.set(o,r.get(o,s),oi.USER)}updateOrigin(i,r){const s=vU(this),n=Ny(r),o=this.get(i);for(let a=n+1;a<g6;++a)s.delete(i,a);s.set(i,o,n)}toJSON(i){return this.write({},i)}};return t=u([P("esri.core.WriteableMultiOriginJSONSupport")],t),t.prototype.toJSON.isDefaultToJSON=!0,t};function vU(e){return Ra(e).store}const qH=e=>{let t=class extends B5e(Ife(e)){constructor(...i){super(...i)}};return t=u([P("esri.core.MultiOriginJSONSupport")],t),t};let P8=class extends qH(we){};P8=u([P("esri.core.MultiOriginJSONSupport")],P8);async function V5e(e,t){const{WhereClause:i}=await import("./WhereClause.d621a470.js");return i.create(e,t)}var I8;let Kv=I8=class extends fe{constructor(e){super(e),this.expression=null,this.name=null,this.returnType="boolean",this.title=null}clone(){return new I8({name:this.name,title:this.title,expression:this.expression,returnType:this.returnType})}};u([d({type:String,json:{write:!0}})],Kv.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],Kv.prototype,"name",void 0),u([d({type:["boolean","date","number","string"],json:{write:!0}})],Kv.prototype,"returnType",void 0),u([d({type:String,json:{write:!0}})],Kv.prototype,"title",void 0),Kv=I8=u([P("esri.form.ExpressionInfo")],Kv);const G5e=Kv;let e_=class extends fe{constructor(e){super(e),this.description=null,this.label=null,this.type=null,this.visibilityExpression=null}};u([d({type:String,json:{write:!0}})],e_.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],e_.prototype,"label",void 0),u([d()],e_.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],e_.prototype,"visibilityExpression",void 0),e_=u([P("esri.form.elements.Element")],e_);const eS=e_;var $8;let HI=$8=class extends fe{constructor(e){super(e),this.type=null}clone(){return new $8({type:this.type})}};u([d({type:["attachment","audio","document","image","signature","video"],json:{write:!0}})],HI.prototype,"type",void 0),HI=$8=u([P("esri.form.elements.inputs.AttachmentInput")],HI);const j5e=HI;var D8;let t_=D8=class extends eS{constructor(e){super(e),this.attachmentKeyword=null,this.editable=!0,this.input=null,this.type="attachment"}clone(){return new D8({attachmentKeyword:this.attachmentKeyword,description:this.description,editable:this.editable,input:this.input,label:this.label,visibilityExpression:this.visibilityExpression})}};u([d({type:String,json:{write:!0}})],t_.prototype,"attachmentKeyword",void 0),u([d({type:Boolean,json:{write:!0}})],t_.prototype,"editable",void 0),u([d({type:j5e,json:{read:{source:"inputType"},write:{target:"inputType"}}})],t_.prototype,"input",void 0),u([d({type:["attachment"],json:{read:!1,write:!0}})],t_.prototype,"type",void 0),t_=D8=u([P("esri.form.elements.AttachmentElement")],t_);const $J=t_;let qI=class extends fe{constructor(e){super(e),this.type=null}};u([d()],qI.prototype,"type",void 0),qI=u([P("esri.form.elements.inputs.Input")],qI);const JS=qI;let oA=class extends JS{constructor(e){super(e),this.maxLength=null,this.minLength=0}};u([d({type:Number,json:{write:!0}})],oA.prototype,"maxLength",void 0),u([d({type:Number,json:{write:!0}})],oA.prototype,"minLength",void 0),oA=u([P("esri.form.elements.inputs.TextInput")],oA);const WH=oA;var L8;let WI=L8=class extends WH{constructor(e){super(e),this.type="barcode-scanner"}clone(){return new L8({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["barcode-scanner"],json:{read:!1,write:!0}})],WI.prototype,"type",void 0),WI=L8=u([P("esri.form.elements.inputs.BarcodeScannerInput")],WI);const H5e=WI;var N8;let Uw=N8=class extends JS{constructor(e){super(e),this.noValueOptionLabel=null,this.showNoValueOption=!1,this.type="combo-box"}clone(){return new N8({showNoValueOption:this.showNoValueOption,noValueOptionLabel:this.noValueOptionLabel})}};u([d({type:String,json:{write:!0}})],Uw.prototype,"noValueOptionLabel",void 0),u([d({type:Boolean,json:{write:!0}})],Uw.prototype,"showNoValueOption",void 0),u([d({type:["combo-box"],json:{read:!1,write:!0}})],Uw.prototype,"type",void 0),Uw=N8=u([P("esri.form.elements.inputs.ComboBoxInput")],Uw);const q5e=Uw;var F8;function DJ(e){return e!=null?new Date(e):null}function LJ(e){return e?e.getTime():null}let mh=F8=class extends JS{constructor(e){super(e),this.includeTime=!1,this.max=null,this.min=null,this.type="datetime-picker"}readMax(e,t){return DJ(t.max)}writeMax(e,t){t.max=LJ(e)}readMin(e,t){return DJ(t.min)}writeMin(e,t){t.min=LJ(e)}clone(){return new F8({includeTime:this.includeTime,max:this.max,min:this.min,type:this.type})}};u([d({type:Boolean,json:{write:!0}})],mh.prototype,"includeTime",void 0),u([d({type:Date,json:{type:Number,write:!0}})],mh.prototype,"max",void 0),u([De("max")],mh.prototype,"readMax",null),u([Fe("max")],mh.prototype,"writeMax",null),u([d({type:Date,json:{type:Number,write:!0}})],mh.prototype,"min",void 0),u([De("min")],mh.prototype,"readMin",null),u([Fe("min")],mh.prototype,"writeMin",null),u([d({type:["datetime-picker"],json:{read:!1,write:!0}})],mh.prototype,"type",void 0),mh=F8=u([P("esri.form.elements.inputs.DateTimePickerInput")],mh);const W5e=mh;var U8;let kw=U8=class extends JS{constructor(e){super(e),this.noValueOptionLabel=null,this.showNoValueOption=!1,this.type="radio-buttons"}clone(){return new U8({noValueOptionLabel:this.noValueOptionLabel,showNoValueOption:this.showNoValueOption})}};u([d({type:String,json:{write:!0}})],kw.prototype,"noValueOptionLabel",void 0),u([d({type:Boolean,json:{write:!0}})],kw.prototype,"showNoValueOption",void 0),u([d({type:["radio-buttons"],json:{read:!1,write:!0}})],kw.prototype,"type",void 0),kw=U8=u([P("esri.form.elements.inputs.RadioButtonsInput")],kw);const X5e=kw;var k8;let zw=k8=class extends JS{constructor(e){super(e),this.offValue=null,this.onValue=null,this.type="switch"}clone(){return new k8({offValue:this.offValue,onValue:this.onValue})}};u([d({type:[String,Number],json:{write:!0}})],zw.prototype,"offValue",void 0),u([d({type:[String,Number],json:{write:!0}})],zw.prototype,"onValue",void 0),u([d({type:["switch"],json:{read:!1,write:!0}})],zw.prototype,"type",void 0),zw=k8=u([P("esri.form.elements.inputs.SwitchInput")],zw);const Y5e=zw;var z8;let XI=z8=class extends WH{constructor(e){super(e),this.type="text-area"}clone(){return new z8({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["text-area"],json:{read:!1,write:!0}})],XI.prototype,"type",void 0),XI=z8=u([P("esri.form.elements.inputs.TextAreaInput")],XI);const Z5e=XI;var B8;let YI=B8=class extends WH{constructor(e){super(e),this.type="text-box"}clone(){return new B8({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["text-box"],json:{read:!1,write:!0}})],YI.prototype,"type",void 0),YI=B8=u([P("esri.form.elements.inputs.TextBoxInput")],YI);const Q5e=YI,J5e={base:JS,key:"type",typeMap:{"barcode-scanner":H5e,"combo-box":q5e,"datetime-picker":W5e,"radio-buttons":X5e,switch:Y5e,"text-area":Z5e,"text-box":Q5e}};var V8;let Zc=V8=class extends eS{constructor(e){super(e),this.domain=null,this.editable=!0,this.editableExpression=null,this.fieldName=null,this.hint=null,this.input=null,this.requiredExpression=null,this.type="field",this.valueExpression=null}clone(){return new V8({description:this.description,domain:this.domain,editable:this.editable,editableExpression:this.editableExpression,fieldName:this.fieldName,hint:this.hint,input:this.input,label:this.label,requiredExpression:this.requiredExpression,valueExpression:this.valueExpression,visibilityExpression:this.visibilityExpression})}};u([d({types:Mde,json:{read:{reader:dH},write:!0}})],Zc.prototype,"domain",void 0),u([d({type:Boolean,json:{write:!0}})],Zc.prototype,"editable",void 0),u([d({type:String,json:{write:!0}})],Zc.prototype,"editableExpression",void 0),u([d({type:String,json:{write:!0}})],Zc.prototype,"fieldName",void 0),u([d({type:String,json:{write:!0}})],Zc.prototype,"hint",void 0),u([d({types:J5e,json:{read:{source:"inputType"},write:{target:"inputType"}}})],Zc.prototype,"input",void 0),u([d({type:String,json:{write:!0}})],Zc.prototype,"requiredExpression",void 0),u([d({type:String,json:{read:!1,write:!0}})],Zc.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Zc.prototype,"valueExpression",void 0),Zc=V8=u([P("esri.form.elements.FieldElement")],Zc);const NJ=Zc;var G8;let Rf=G8=class extends eS{constructor(e){super(e),this.displayCount=null,this.displayType="list",this.editable=!0,this.orderByFields=null,this.relationshipId=null,this.type="relationship"}clone(){return new G8({description:this.description,displayCount:this.displayCount,displayType:this.displayType,editable:this.editable,label:this.label,orderByFields:se(this.orderByFields),relationshipId:this.relationshipId,visibilityExpression:this.visibilityExpression})}};u([d({type:Number,json:{write:!0}})],Rf.prototype,"displayCount",void 0),u([d({type:["list"],json:{write:!0}})],Rf.prototype,"displayType",void 0),u([d({type:Boolean,json:{write:!0}})],Rf.prototype,"editable",void 0),u([d({type:[ble],json:{write:!0}})],Rf.prototype,"orderByFields",void 0),u([d({type:Number,json:{write:!0}})],Rf.prototype,"relationshipId",void 0),u([d({type:["relationship"],json:{read:!1,write:!0}})],Rf.prototype,"type",void 0),Rf=G8=u([P("esri.form.elements.RelationshipElement")],Rf);const FJ=Rf;function $fe(e){return{typesWithGroup:{base:eS,key:"type",typeMap:{attachment:$J,field:NJ,group:e,relationship:FJ}},typesWithoutGroup:{base:eS,key:"type",typeMap:{attachment:$J,field:NJ,relationship:FJ}}}}function Dfe(e,t,i=!0){if(!e)return null;const r=i?t.typesWithGroup.typeMap:t.typesWithoutGroup.typeMap;return e.filter(s=>r[s.type]).map(s=>r[s.type].fromJSON(s))}function Lfe(e,t,i=!0){if(!e)return null;const r=i?t.typesWithGroup.typeMap:t.typesWithoutGroup.typeMap;return e.filter(s=>r[s.type]).map(s=>s.toJSON())}function Nfe(e,t,i=!0){return e?e.map(r=>Zh(i?t.typesWithGroup:t.typesWithoutGroup,r)):null}var j8;let Jd=j8=class extends eS{constructor(e){super(e),this.elements=null,this.initialState="expanded",this.type="group"}castElements(e){return Nfe(e,_U,!1)}readElements(e,t){return Dfe(t.formElements,_U,!1)}writeElements(e,t){t.formElements=Lfe(e,_U,!1)}clone(){return new j8({description:this.description,elements:se(this.elements),initialState:this.initialState,label:this.label,visibilityExpression:this.visibilityExpression})}};u([d({json:{write:!0}})],Jd.prototype,"elements",void 0),u([At("elements")],Jd.prototype,"castElements",null),u([De("elements",["formElements"])],Jd.prototype,"readElements",null),u([Fe("elements")],Jd.prototype,"writeElements",null),u([d({type:["collapsed","expanded"],json:{write:!0}})],Jd.prototype,"initialState",void 0),u([d({type:String,json:{read:!1,write:!0}})],Jd.prototype,"type",void 0),Jd=j8=u([P("esri.form.elements.GroupElement")],Jd);const _U=$fe(Jd),K5e=Jd;var H8;const bU=$fe(K5e);let Ud=H8=class extends fe{constructor(e){super(e),this.description=null,this.elements=null,this.expressionInfos=null,this.title=null}castElements(e){return Nfe(e,bU)}readElements(e,t){return Dfe(t.formElements,bU)}writeElements(e,t){t.formElements=Lfe(e,bU)}clone(){return new H8({description:this.description,expressionInfos:se(this.expressionInfos),elements:se(this.elements),title:this.title})}};u([d({type:String,json:{write:!0}})],Ud.prototype,"description",void 0),u([d({json:{write:!0}})],Ud.prototype,"elements",void 0),u([At("elements")],Ud.prototype,"castElements",null),u([De("elements",["formElements"])],Ud.prototype,"readElements",null),u([Fe("elements")],Ud.prototype,"writeElements",null),u([d({type:[G5e],json:{write:!0}})],Ud.prototype,"expressionInfos",void 0),u([d({type:String,json:{write:!0}})],Ud.prototype,"title",void 0),Ud=H8=u([P("esri.form.FormTemplate")],Ud);const eUe=Ud;let tUe=0;const UJ=he.getLogger("esri.layers.Layer");let cn=class extends xr.EventedMixin(FN(Ep)){constructor(){super(...arguments),this.attributionDataUrl=null,this.fullExtent=new Xt(-180,-90,180,90,He.WGS84),this.id=Date.now().toString(16)+"-layer-"+tUe++,this.legendEnabled=!0,this.listMode="show",this.opacity=1,this.parent=null,this.popupEnabled=!0,this.attributionVisible=!0,this.spatialReference=He.WGS84,this.title=null,this.type=null,this.url=null,this.visible=!0}static async fromArcGISServerUrl(e){const t=typeof e=="string"?{url:e}:e,i=await import("./arcgisLayers.ac3cbbd8.js");try{return await i.fromUrl(t)}catch(r){throw UJ.error("#fromArcGISServerUrl({ url: '"+t.url+"'})","Failed to create layer from arcgis server url",r),r}}static async fromPortalItem(e){const t="portalItem"in e?e:{portalItem:e},i=await import("./portalLayers.7f68601a.js");try{return await i.fromItem(t)}catch(r){const s=t&&t.portalItem,n=s&&s.id||"unset",o=s&&s.portal&&s.portal.url||Bi.portalUrl;throw UJ.error("#fromPortalItem()","Failed to create layer from portal item (portal: '"+o+"', id: '"+n+"')",r),r}}initialize(){this.when().catch(e=>{var t,i;pr(e)||he.getLogger(this.declaredClass).error("#load()",`Failed to load layer (title: '${(t=this.title)!=null?t:"no title"}', id: '${(i=this.id)!=null?i:"no id"}')`,{error:e})})}destroy(){if(this.parent){const e=this,t=this.parent;"layers"in t&&t.layers.includes(e)?t.layers.remove(e):"tables"in t&&t.tables.includes(e)?t.tables.remove(e):"baseLayers"in t&&t.baseLayers.includes(e)?t.baseLayers.remove(e):"baseLayers"in t&&t.referenceLayers.includes(e)&&t.referenceLayers.remove(e)}}get hasAttributionData(){return this.attributionDataUrl!=null}get parsedUrl(){const e=this.url;return e?Ts(e):null}async fetchAttributionData(){const e=this.attributionDataUrl;if(this.hasAttributionData&&e)return(await Ti(e,{query:{f:"json"},responseType:"json"})).data;throw new q("layer:no-attribution-data","Layer does not have attribution data")}};u([d({type:String})],cn.prototype,"attributionDataUrl",void 0),u([d({type:Xt})],cn.prototype,"fullExtent",void 0),u([d({readOnly:!0})],cn.prototype,"hasAttributionData",null),u([d({type:String,clonable:!1})],cn.prototype,"id",void 0),u([d({type:Boolean,nonNullable:!0})],cn.prototype,"legendEnabled",void 0),u([d({type:["show","hide","hide-children"]})],cn.prototype,"listMode",void 0),u([d({type:Number,range:{min:0,max:1},nonNullable:!0})],cn.prototype,"opacity",void 0),u([d({clonable:!1})],cn.prototype,"parent",void 0),u([d({readOnly:!0})],cn.prototype,"parsedUrl",null),u([d({type:Boolean})],cn.prototype,"popupEnabled",void 0),u([d({type:Boolean})],cn.prototype,"attributionVisible",void 0),u([d({type:He})],cn.prototype,"spatialReference",void 0),u([d({type:String})],cn.prototype,"title",void 0),u([d({type:String,readOnly:!0,json:{read:!1}})],cn.prototype,"type",void 0),u([d()],cn.prototype,"url",void 0),u([d({type:Boolean,nonNullable:!0})],cn.prototype,"visible",void 0),cn=u([P("esri.layers.Layer")],cn);const PF=cn;function kJ(e,t,i){if(e.hasM==null||e.hasZ)for(const r of t)for(const s of r)s.length>2&&(s[2]*=i)}function iUe(e,t,i){if(!e&&!t||!i)return;const r=BT(i);zJ(e,i,r),zJ(t,i,r)}function zJ(e,t,i){if(e)for(const r of e)rUe(r.geometry,t,i)}function rUe(e,t,i){if(R(e)||!e.spatialReference||Rc(e.spatialReference,t))return;const r=BT(e.spatialReference)/i;if(r!==1){if("x"in e)e.z!=null&&(e.z*=r);else if("rings"in e)kJ(e,e.rings,r);else if("paths"in e)kJ(e,e.paths,r);else if("points"in e&&(e.hasM==null||e.hasZ))for(const s of e.points)s.length>2&&(s[2]*=r)}}let sUe=0;const wU=he.getLogger("esri.layers.graphics.sources.MemorySource");let Kg=class extends Ep.LoadableMixin(kS(Vm(it))){constructor(e){super(e),this._idToClientGraphic=null,this.type="memory"}load(e){const t=_(e)?e.signal:null;return this.addResolvingPromise(this._startWorker(t)),Promise.resolve(this)}destroy(){var e;(e=this._connection)==null||e.close(),this._connection=null}get workerGeometryType(){var e;const t=(e=this.layer)==null?void 0:e.geometryType;return t?this._geometryTypeRequiresClientGraphicMapping(t)?"polygon":t:null}applyEdits(e){return this.load().then(()=>this._applyEdits(e))}openPorts(){return this.load().then(()=>this._connection.openPorts())}async queryFeatures(e,t={}){await this.load(t);const i=await this._connection.invoke("queryFeatures",e?e.toJSON():null,t);iL(e,this.layer.spatialReference,i);const r=mb.fromJSON(i);if(!this._requiresClientGraphicMapping())return r;const s=this.layer.objectIdField;for(const n of r.features){const o=n.attributes[s],a=this._idToClientGraphic.get(o);a&&(n.geometry=a.geometry)}return r.geometryType=this.layer.geometryType,r}async queryFeaturesJSON(e,t={}){if(this._requiresClientGraphicMapping())throw new q("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)");await this.load(t);const i=await this._connection.invoke("queryFeatures",e?e.toJSON():null,t);return iL(e,this.layer.spatialReference,i),i}queryFeatureCount(e,t={}){return this.load(t).then(()=>this._connection.invoke("queryFeatureCount",e?e.toJSON():null,t))}queryObjectIds(e,t={}){return this.load(t).then(()=>this._connection.invoke("queryObjectIds",e?e.toJSON():null,t))}queryExtent(e,t={}){return this.load(t).then(()=>this._connection.invoke("queryExtent",e?e.toJSON():null,t)).then(i=>({count:i.count,extent:Xt.fromJSON(i.extent)}))}querySnapping(e,t={}){return this.load(t).then(()=>this._connection.invoke("querySnapping",e,t))}async _applyEdits(e){if(!this._connection)throw new q("feature-layer-source:edit-failure","Memory source not loaded");const t=this.layer.objectIdField;let i=null;const r=[],s=[];await Promise.all([this._prepareClientMapping(e.addFeatures,null),this._prepareClientMapping(e.updateFeatures,null)]);const n=c=>"objectId"in c&&c.objectId!=null?c.objectId:"attributes"in c&&c.attributes[t]!=null?c.attributes[t]:null;if(e.addFeatures&&(i=this._prepareAddFeatures(e.addFeatures)),e.deleteFeatures)for(const c of e.deleteFeatures){const h=n(c);h!=null&&r.push(h)}const o=e.updateFeatures&&this._idToClientGraphic?new Map:null;if(e.updateFeatures){for(const c of e.updateFeatures)if(s.push(this._serializeFeature(c)),o){const h=n(c);h!=null&&o.set(h,c)}}iUe(i?i.features:null,s,this.layer.spatialReference);const{fullExtent:a,featureEditResults:l}=await this._connection.invoke("applyEdits",{adds:i?i.features:[],updates:s,deletes:r});return this.fullExtent=a,i&&i.finish(l.uidToObjectId),this._updateClientGraphicIds(o,l),this._createEditsResult(l)}async _prepareClientMapping(e,t){if(this.layerOrSourceGeometryType!=="mesh"||R(e))return;const i=[];for(const{geometry:r}of e)!_(r)||r.type!=="mesh"||r.hasExtent||r.loaded||i.push(r.load({signal:t}));i.length&&await Promise.all(i)}_updateClientGraphicIds(e,t){if(this._idToClientGraphic){if(e)for(const i of t.updateResults){if(!i.success)continue;const r=e.get(i.objectId);r!=null&&this._addIdToClientGraphic(r)}for(const i of t.deleteResults)i.success&&this._idToClientGraphic.delete(i.objectId)}}_createEditsResult(e){return{addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}}_createFeatureEditResult(e){const t=e.success===!0?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new q("feature-layer-source:edit-failure",t.description,{code:t.code}):null}}_prepareAddFeatures(e){const t=new Map,i=new Array(e.length);let r=null;for(let n=0;n<e.length;n++){const o=e[n],a=this._serializeFeature(o);!r&&_(o.geometry)&&(r=o.geometry.type),i[n]=a,t.set(`${a.uid}`,o)}const s=this;return{features:i,inferredGeometryType:r,finish(n){const o=s.sourceJSON.objectIdField;for(const a in n){const l=n[a],c=t.get(a);c&&(c.attributes||(c.attributes={}),l===-1?delete c.attributes[o]:c.attributes[o]=l,s._addIdToClientGraphic(c))}}}}_addIdToClientGraphic(e){if(!this._idToClientGraphic)return;const t=this.sourceJSON.objectIdField,i=e.attributes&&e.attributes[t];i!=null&&this._idToClientGraphic.set(i,e)}get layerOrSourceGeometryType(){var e,t,i;return(e=(t=this.layer)==null?void 0:t.geometryType)!=null?e:(i=this.sourceJSON)==null?void 0:i.geometryType}_requiresClientGraphicMapping(){return this._geometryTypeRequiresClientGraphicMapping(this.layerOrSourceGeometryType)}_geometryRequiresClientGraphicMapping(e){return this._geometryTypeRequiresClientGraphicMapping(e.type)}_geometryTypeRequiresClientGraphicMapping(e){return e==="mesh"||e==="multipatch"||e==="extent"}_serializeFeature(e){const{attributes:t}=e,i=this._geometryForSerialization(e),r=(sUe++).toString();return i?{uid:r,geometry:i.toJSON(),attributes:t}:{uid:r,attributes:t}}_geometryForSerialization(e){const{geometry:t}=e;return R(t)?null:this._geometryRequiresClientGraphicMapping(t)?t.extent?bc.fromExtent(t.extent):null:t}async _startWorker(e){this._connection=await Mce("MemorySourceWorker",{strategy:ue("feature-layers-workers")?"dedicated":"local",signal:e});const{fields:t,spatialReference:i,objectIdField:r,hasM:s,hasZ:n,timeInfo:o}=this.layer,a=this.layer.originOf("spatialReference")==="defaults";await this._prepareClientMapping(this.items,e);const l=this._prepareAddFeatures(this.items);this.handles.add(this.on("before-changes",f=>{wU.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead"),f.preventDefault()}));const c={features:l.features,fields:t&&t.map(f=>f.toJSON()),geometryType:wY.toJSON(this.workerGeometryType),hasM:this.layerOrSourceGeometryType!=="mesh"&&s,hasZ:this.layerOrSourceGeometryType==="mesh"||n,objectIdField:r,spatialReference:a?null:i&&i.toJSON(),timeInfo:o?o.toJSON():null},h=await this._connection.invoke("load",c,{signal:e});for(const f of h.warnings)wU.warn(f.message,{layer:this.layer,warning:f});h.featureErrors.length&&wU.warn(`Encountered ${h.featureErrors.length} validation errors while loading features`,h.featureErrors);const p=h.layerDefinition;this._geometryTypeRequiresClientGraphicMapping(l.inferredGeometryType)&&(p.geometryType=wY.toJSON(l.inferredGeometryType)),this.sourceJSON=p,this._requiresClientGraphicMapping()&&(this._idToClientGraphic=new Map),l.finish(h.assignedObjectIds)}};u([G7({Type:qo,ensureType:Ir(qo)})],Kg.prototype,"itemType",void 0),u([d()],Kg.prototype,"type",void 0),u([d({constructOnly:!0})],Kg.prototype,"layer",void 0),u([d({readOnly:!0})],Kg.prototype,"workerGeometryType",null),u([d()],Kg.prototype,"sourceJSON",void 0),Kg=u([P("esri.layers.graphics.sources.MemorySource")],Kg);const BJ=Kg;function nUe(e){return"portalItem"in e}const oUe=e=>{let t=class extends e{get apiKey(){var i;return this._isOverridden("apiKey")?this._get("apiKey"):nUe(this)?(i=this.portalItem)==null?void 0:i.apiKey:null}set apiKey(i){i!=null?this._override("apiKey",i):(this._clearOverride("apiKey"),this.clear("apiKey","user"))}};return u([d({type:String})],t.prototype,"apiKey",null),t=u([P("esri.layers.mixins.APIKeyMixin")],t),t},Ffe={mapserver:"MapServer",imageserver:"ImageServer",featureserver:"FeatureServer",sceneserver:"SceneServer",streamserver:"StreamServer",vectortileserver:"VectorTileServer"},Ufe=Object.values(Ffe),kfe=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/rest\\/services\\/(.+?)\\/(${Ufe.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),aUe=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/([^\\/\\n]+)\\/(${Ufe.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),lUe=/(.*?)\/(?:layers\/)?(\d+)\/?$/i;function Hgt(e){return!!kfe.test(e)}function SO(e){const t=Ts(e),i=t.path.match(kfe)||t.path.match(aUe);if(!i)return null;const[,r,s,n,o]=i,a=s.indexOf("/");return{title:XH(a!==-1?s.slice(a+1):s),serverType:Ffe[n.toLowerCase()],sublayer:o!=null&&o!==""?parseInt(o,10):null,url:{path:r}}}function cUe(e){const t=Ts(e).path.match(lUe);return t?{serviceUrl:t[1],sublayerId:Number(t[2])}:null}function XH(e){return(e=e.replace(/\s*[/_]+\s*/g," "))[0].toUpperCase()+e.slice(1)}function uUe(e,t){const i=[];if(e){const r=SO(e);_(r)&&r.title&&i.push(r.title)}if(t){const r=XH(t);i.push(r)}if(i.length===2){if(i[0].toLowerCase().indexOf(i[1].toLowerCase())!==-1)return i[0];if(i[1].toLowerCase().indexOf(i[0].toLowerCase())!==-1)return i[1]}return i.join(" - ")}function zfe(e){if(!e)return!1;const t=".arcgis.com/",i="//services",r="//tiles",s="//features",n=(e=e.toLowerCase()).indexOf(t)!==-1,o=e.indexOf(i)!==-1||e.indexOf(r)!==-1||e.indexOf(s)!==-1;return n&&o}function hUe(e,t){return e&&Zle(Qle(e,t))}function dUe(e){let{url:t}=e;if(!t)return{url:t};t=Qle(t,e.logger);const i=Ts(t),r=SO(i.path);let s;if(_(r))r.sublayer!=null&&e.layer.layerId==null&&(s=r.sublayer),t=r.url.path;else if(e.nonStandardUrlAllowed){const n=cUe(i.path);_(n)&&(t=n.serviceUrl,s=n.sublayerId)}return{url:Zle(t),layerId:s}}function pUe(e,t,i,r,s){v0(t,r,"url",s),r.url&&e.layerId!=null&&(r.url=bl(r.url,i,e.layerId.toString()))}function qgt(e){if(!e)return!1;const t=e.toLowerCase(),i=t.indexOf("/services/")!==-1,r=t.indexOf("/mapserver/wmsserver")!==-1,s=t.indexOf("/imageserver/wmsserver")!==-1,n=t.indexOf("/wmsserver")!==-1;return i&&(r||s||n)}const fUe=e=>{let t=class extends e{get title(){if(this._get("title")&&this.originOf("title")!=="defaults")return this._get("title");if(this.url){const i=SO(this.url);if(_(i)&&i.title)return i.title}return this._get("title")||""}set title(i){this._set("title",i)}set url(i){this._set("url",hUe(i,he.getLogger(this.declaredClass)))}};return u([d()],t.prototype,"title",null),u([d({type:String})],t.prototype,"url",null),t=u([P("esri.layers.mixins.ArcGISService")],t),t};function EO(){const e=new Float32Array(16);return e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function mUe(e){const t=new Float32Array(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function gUe(e,t,i,r,s,n,o,a,l,c,h,p,f,g,y,v){const b=new Float32Array(16);return b[0]=e,b[1]=t,b[2]=i,b[3]=r,b[4]=s,b[5]=n,b[6]=o,b[7]=a,b[8]=l,b[9]=c,b[10]=h,b[11]=p,b[12]=f,b[13]=g,b[14]=y,b[15]=v,b}function yUe(e,t){return new Float32Array(e,t,16)}const vUe=EO();Object.freeze({__proto__:null,create:EO,clone:mUe,fromValues:gUe,createView:yUe,IDENTITY:vUe});const _Ue=(e,t)=>{const i=kp(e,t,0,0,0,0,t,0,0,0,0,t,0,0,0,0,1);return Oa(i,i)},bUe=(e,t)=>{const i=kp(e,t,0,0,.5-.5*t,0,t,0,.5-.5*t,0,0,t,.5-.5*t,0,0,0,1);return Oa(i,i)},wUe=(e,t)=>{const i=1-t,r=kp(e,.2126+.7874*i,.7152-.7152*i,.0722-.0722*i,0,.2126-.2126*i,.7152+.2848*i,.0722-.0722*i,0,.2126-.2126*i,.7152-.7152*i,.0722+.9278*i,0,0,0,0,1);return Oa(r,r)},xUe=(e,t)=>{const i=Math.sin(t*Math.PI/180),r=Math.cos(t*Math.PI/180),s=kp(e,.213+.787*r-.213*i,.715-.715*r-.715*i,.072-.072*r+.928*i,0,.213-.213*r+.143*i,.715+.285*r+.14*i,.072-.072*r-.283*i,0,.213-.213*r-.787*i,.715-.715*r+.715*i,.072+.928*r+.072*i,0,0,0,0,1);return Oa(s,s)},TUe=(e,t)=>{const i=1-2*t,r=kp(e,i,0,0,t,0,i,0,t,0,0,i,t,0,0,0,1);return Oa(r,r)},SUe=(e,t)=>{const i=kp(e,.213+.787*t,.715-.715*t,.072-.072*t,0,.213-.213*t,.715+.285*t,.072-.072*t,0,.213-.213*t,.715-.715*t,.072+.928*t,0,0,0,0,1);return Oa(i,i)},EUe=(e,t)=>{const i=1-t,r=kp(e,.393+.607*i,.769-.769*i,.189-.189*i,0,.349-.349*i,.686+.314*i,.168-.168*i,0,.272-.272*i,.534-.534*i,.131+.869*i,0,0,0,0,1);return Oa(r,r)};class IF{constructor(t,i,r){this.strength=t,this.radius=i,this.threshold=r,this.type="bloom"}interpolate(t,i,r){this.strength=Ka(t.strength,i.strength,r),this.radius=Ka(t.radius,i.radius,r),this.threshold=Ka(t.threshold,i.threshold,r)}clone(){return new IF(this.strength,this.radius,this.threshold)}toJSON(){return{type:"bloom",radius:nC(this.radius),strength:this.strength,threshold:this.threshold}}}class $F{constructor(t){this.radius=t,this.type="blur"}interpolate(t,i,r){this.radius=Math.round(Ka(t.radius,i.radius,r))}clone(){return new $F(this.radius)}toJSON(){return{type:"blur",radius:nC(this.radius)}}}class tR{constructor(t,i){this.type=t,this.amount=i,this.type!=="invert"&&this.type!=="grayscale"&&this.type!=="sepia"||(this.amount=Math.min(this.amount,1))}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(t,i,r){this.amount=Ka(t.amount,i.amount,r),this._updateMatrix()}clone(){return new tR(this.type,this.amount)}toJSON(){return{type:this.type,amount:this.amount}}_updateMatrix(){const t=this._colorMatrix||EO();switch(this.type){case"brightness":this._colorMatrix=_Ue(t,this.amount);break;case"contrast":this._colorMatrix=bUe(t,this.amount);break;case"grayscale":this._colorMatrix=wUe(t,this.amount);break;case"invert":this._colorMatrix=TUe(t,this.amount);break;case"saturate":this._colorMatrix=SUe(t,this.amount);break;case"sepia":this._colorMatrix=EUe(t,this.amount)}}}class DF{constructor(t,i,r,s){this.offsetX=t,this.offsetY=i,this.blurRadius=r,this.color=s,this.type="drop-shadow"}interpolate(t,i,r){this.offsetX=Ka(t.offsetX,i.offsetX,r),this.offsetY=Ka(t.offsetY,i.offsetY,r),this.blurRadius=Ka(t.blurRadius,i.blurRadius,r),this.color[0]=Math.round(Ka(t.color[0],i.color[0],r)),this.color[1]=Math.round(Ka(t.color[1],i.color[1],r)),this.color[2]=Math.round(Ka(t.color[2],i.color[2],r)),this.color[3]=Ka(t.color[3],i.color[3],r)}clone(){return new DF(this.offsetX,this.offsetY,this.blurRadius,[...this.color])}toJSON(){const t=[...this.color];return t[3]*=255,{type:"drop-shadow",xoffset:nC(this.offsetX),yoffset:nC(this.offsetY),blurRadius:nC(this.blurRadius),color:t}}}class LF{constructor(t){this.angle=t,this.type="hue-rotate"}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(t,i,r){this.angle=Ka(t.angle,i.angle,r),this._updateMatrix()}clone(){return new LF(this.angle)}toJSON(){return{type:"hue-rotate",angle:this.angle}}_updateMatrix(){const t=this._colorMatrix||EO();this._colorMatrix=xUe(t,this.angle)}}class NF{constructor(t){this.amount=t,this.type="opacity",this.amount=Math.min(this.amount,1)}interpolate(t,i,r){this.amount=Ka(t.amount,i.amount,r)}clone(){return new NF(this.amount)}toJSON(){return{type:"opacity",amount:this.amount}}}function Ka(e,t,i){return e+(t-e)*i}function nC(e){return Math.round(1e3*Qh(e))/1e3}function AUe(e){switch(e.type){case"grayscale":case"sepia":case"invert":return new tR(e.type,0);case"saturate":case"brightness":case"contrast":return new tR(e.type,1);case"opacity":return new NF(1);case"hue-rotate":return new LF(0);case"blur":return new $F(0);case"drop-shadow":return new DF(0,0,0,[...n7("transparent")]);case"bloom":return new IF(0,0,1)}}var Wgt=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function Xgt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Ygt(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}function CUe(e,t){const i=e.length>t.length?e:t;return(e.length>t.length?t:e).every((r,s)=>r.type===i[s].type)}function RUe(e,t){const i=e.length>t.length?e:t,r=e.length>t.length?t:e;for(let s=r.length;s<i.length;s++)r.push(AUe(i[s]))}function OUe(e){const t=e[0];return!!t&&"type"in t}var VJ,GJ,Bfe={exports:{}};function Vfe(e){if(!e||e.length===0)return null;if(typeof e=="string"){const i=jJ(e);return i&&i.length!==0?i:null}const t=e.map(i=>{if(!Number.isFinite(i.scale)||i.scale<=0)throw new q("effect:invalid-scale","scale must be finite and greater than 0",{stop:i});return{scale:i.scale,effects:jJ(i.value)}});t.sort((i,r)=>r.effects.length-i.effects.length);for(let i=0;i<t.length-1;i++){if(!CUe(t[i].effects,t[i+1].effects))throw new q("effect:interpolation-impossible","Cannot interpolate by scale between 2 lists of mixed effects",{a:t[i].effects,b:t[i+1].effects});RUe(t[i].effects,t[i+1].effects)}return t.sort((i,r)=>r.scale-i.scale),t}function jJ(e){let t;if(!e)return[];try{t=Bfe.exports.parse(e)}catch(i){throw new q("effect:invalid-syntax","Invalid effect syntax",{value:e,error:i})}return t.map(i=>MUe(i))}function MUe(e){try{switch(e.name){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":return PUe(e);case"opacity":return IUe(e);case"hue-rotate":return $Ue(e);case"blur":return DUe(e);case"drop-shadow":return LUe(e);case"bloom":return NUe(e)}}catch(t){throw t.details.filter=e,t}throw new q("effect:unknown-effect",`Effect '${e.name}' is not supported`,{effect:e})}function PUe(e){let t=1;return KS(e.parameters,1),e.parameters.length===1&&(t=Oh(e.parameters[0])),new tR(e.name,t)}function IUe(e){let t=1;return KS(e.parameters,1),e.parameters.length===1&&(t=Oh(e.parameters[0])),new NF(t)}function $Ue(e){let t=0;return KS(e.parameters,1),e.parameters.length===1&&(t=VUe(e.parameters[0])),new LF(t)}function DUe(e){let t=0;return KS(e.parameters,1),e.parameters.length===1&&(t=QH(e.parameters[0]),AO(t,e.parameters[0])),new $F(t)}function LUe(e){const t=[];let i=null;for(const r of e.parameters)if(r.type==="color"){if(t.length&&Object.freeze(t),i)throw new q("effect:type-error","Accepts only one color",{});i=GUe(r)}else{const s=QH(r);if(Object.isFrozen(t))throw new q("effect:type-error","<length> parameters not consecutive",{lengths:t});t.push(s),t.length===3&&AO(s,r)}if(t.length<2||t.length>3)throw new q("effect:type-error",`Expected <length>{2,3}, Actual: <length>{${t.length}}`,{lengths:t});return new DF(t[0],t[1],t[2]||0,i||Gfe("black"))}function NUe(e){let t=1,i=0,r=0;return KS(e.parameters,3),e.parameters[0]&&(t=Oh(e.parameters[0])),e.parameters[1]&&(i=QH(e.parameters[1]),AO(i,e.parameters[1])),e.parameters[2]&&(r=Oh(e.parameters[2])),new IF(t,i,r)}function KS(e,t){if(e.length>t)throw new q("effect:type-error",`Function supports up to ${t} parameters, Actual: ${e.length}`,{parameters:e})}function FF(e){if(e.type==="color")return"<color>";if(e.unit){if(ZH[e.unit])return"<length>";if(YH[e.unit])return"<angle>";if(e.unit==="%")return"<percentage>"}return"<double>"}function AO(e,t){if(e<0)throw new q("effect:type-error",`Negative values are not allowed, Actual: ${e}`,{term:t})}function FUe(e){if(e.type!=="quantity"||e.unit!==null)throw new q("effect:type-error",`Expected <double>, Actual: ${FF(e)}`,{term:e})}function UUe(e){if(e.type!=="quantity"||e.unit!==null&&e.unit!=="%")throw new q("effect:type-error",`Expected <double> or <percentage>, Actual: ${FF(e)}`,{term:e})}GJ=function(){function e(s,n){function o(){this.constructor=s}o.prototype=n.prototype,s.prototype=new o}function t(s,n,o,a){var l=Error.call(this,s);return Object.setPrototypeOf&&Object.setPrototypeOf(l,t.prototype),l.expected=n,l.found=o,l.location=a,l.name="SyntaxError",l}function i(s,n,o){return o=o||" ",s.length>n?s:(n-=s.length,s+(o+=o.repeat(n)).slice(0,n))}function r(s,n){var o,a={},l=(n=n!==void 0?n:{}).grammarSource,c={start:MX},h=MX,p="none",f=")",g=",",y="(",v="%",b="px",w="cm",S="mm",T="in",A="pt",C="pc",O="deg",L="rad",U="grad",N="turn",z="#",V=".",B="e",J=/^[ \t\n\r]/,Q=/^[a-z\-]/,te=/^[0-9a-fA-F]/,ie=/^[+\-]/,$=/^[0-9]/,F=Xp("none"),k=Tn("none",!1),G=Tn(")",!1),W=Tn(",",!1),K=Xp("whitespace"),H=l2([" ","	",`
`,"\r"],!1,!1),ee=Xp("function"),ye=Tn("(",!1),Ae=Xp("identifier"),Ve=l2([["a","z"],"-"],!1,!1),Se=Xp("percentage"),xe=Tn("%",!1),Re=Xp("length"),ze=Tn("px",!1),ji=Tn("cm",!1),Yr=Tn("mm",!1),Ms=Tn("in",!1),Ps=Tn("pt",!1),ds=Tn("pc",!1),Is=Xp("angle"),Tb=Tn("deg",!1),n5=Tn("rad",!1),Pt=Tn("grad",!1),JO=Tn("turn",!1),ad=Xp("number"),o2=Xp("color"),a2=Tn("#",!1),AX=l2([["0","9"],["a","f"],["A","F"]],!1,!1),CX=l2(["+","-"],!1,!1),ig=l2([["0","9"]],!1,!1),dwe=Tn(".",!1),pwe=Tn("e",!1),fwe=function(){return[]},mwe=function(X,ge){return{type:"function",name:X,parameters:ge||[]}},gwe=function(X,ge){return ge.length>0?Ywe(X,ge,3):[X]},ywe=function(X){return{type:"quantity",value:X.value,unit:X.unit}},vwe=function(X){return{type:"color",colorType:X.type,value:X.value}},_we=function(X){return X},bwe=function(){return eM()},wwe=function(X){return{value:X,unit:"%"}},xwe=function(X){return{value:X,unit:"px"}},Twe=function(X){return{value:X,unit:"cm"}},Swe=function(X){return{value:X,unit:"mm"}},Ewe=function(X){return{value:X,unit:"in"}},Awe=function(X){return{value:X,unit:"pt"}},Cwe=function(X){return{value:X,unit:"pc"}},Rwe=function(X){return{value:X,unit:"deg"}},Owe=function(X){return{value:X,unit:"rad"}},Mwe=function(X){return{value:X,unit:"grad"}},Pwe=function(X){return{value:X,unit:"turn"}},Iwe=function(X){return{value:X,unit:null}},$we=function(){return{type:"hex",value:eM()}},Dwe=function(X){return{type:"function",value:X}},Lwe=function(){return{type:"named",value:eM()}},Nwe=function(){return parseFloat(eM())},ce=0,zr=0,KO=[{line:1,column:1}],ld=0,o5=[],dt=0;if("startRule"in n){if(!(n.startRule in c))throw new Error(`Can't start parsing from rule "`+n.startRule+'".');h=c[n.startRule]}function eM(){return s.substring(zr,ce)}function Tn(X,ge){return{type:"literal",text:X,ignoreCase:ge}}function l2(X,ge,Ce){return{type:"class",parts:X,inverted:ge,ignoreCase:Ce}}function Fwe(){return{type:"end"}}function Xp(X){return{type:"other",description:X}}function RX(X){var ge,Ce=KO[X];if(Ce)return Ce;for(ge=X-1;!KO[ge];)ge--;for(Ce={line:(Ce=KO[ge]).line,column:Ce.column};ge<X;)s.charCodeAt(ge)===10?(Ce.line++,Ce.column=1):Ce.column++,ge++;return KO[X]=Ce,Ce}function OX(X,ge){var Ce=RX(X),Jt=RX(ge);return{source:l,start:{offset:X,line:Ce.line,column:Ce.column},end:{offset:ge,line:Jt.line,column:Jt.column}}}function kt(X){ce<ld||(ce>ld&&(ld=ce,o5=[]),o5.push(X))}function Uwe(X,ge,Ce){return new t(t.buildMessage(X,ge),X,ge,Ce)}function MX(){var X;return(X=kwe())===a&&(X=zwe()),X}function kwe(){var X,ge;return dt++,X=ce,Sn(),s.substr(ce,4)===p?(ge=p,ce+=4):(ge=a,dt===0&&kt(k)),ge!==a?(Sn(),zr=X,X=fwe()):(ce=X,X=a),dt--,X===a&&dt===0&&kt(F),X}function zwe(){var X,ge;if(X=[],(ge=a5())!==a)for(;ge!==a;)X.push(ge),ge=a5();else X=a;return X}function a5(){var X,ge,Ce,Jt;return X=ce,Sn(),(ge=Vwe())!==a?(Sn(),(Ce=Bwe())===a&&(Ce=null),Sn(),s.charCodeAt(ce)===41?(Jt=f,ce++):(Jt=a,dt===0&&kt(G)),Jt!==a?(Sn(),zr=X,X=mwe(ge,Ce)):(ce=X,X=a)):(ce=X,X=a),X}function Bwe(){var X,ge,Ce,Jt,Zn,Zr,Ic,tM;if(X=ce,(ge=l5())!==a){for(Ce=[],Jt=ce,Zn=Sn(),s.charCodeAt(ce)===44?(Zr=g,ce++):(Zr=a,dt===0&&kt(W)),Zr===a&&(Zr=null),Ic=Sn(),(tM=l5())!==a?Jt=Zn=[Zn,Zr,Ic,tM]:(ce=Jt,Jt=a);Jt!==a;)Ce.push(Jt),Jt=ce,Zn=Sn(),s.charCodeAt(ce)===44?(Zr=g,ce++):(Zr=a,dt===0&&kt(W)),Zr===a&&(Zr=null),Ic=Sn(),(tM=l5())!==a?Jt=Zn=[Zn,Zr,Ic,tM]:(ce=Jt,Jt=a);zr=X,X=gwe(ge,Ce)}else ce=X,X=a;return X}function l5(){var X,ge;return X=ce,(ge=Gwe())===a&&(ge=jwe())===a&&(ge=Hwe())===a&&(ge=qwe()),ge!==a&&(zr=X,ge=ywe(ge)),(X=ge)===a&&(X=ce,(ge=Wwe())!==a&&(zr=X,ge=vwe(ge)),X=ge),X}function Sn(){var X,ge;for(dt++,X=[],J.test(s.charAt(ce))?(ge=s.charAt(ce),ce++):(ge=a,dt===0&&kt(H));ge!==a;)X.push(ge),J.test(s.charAt(ce))?(ge=s.charAt(ce),ce++):(ge=a,dt===0&&kt(H));return dt--,ge=a,dt===0&&kt(K),X}function Vwe(){var X,ge,Ce;return dt++,X=ce,(ge=PX())!==a?(s.charCodeAt(ce)===40?(Ce=y,ce++):(Ce=a,dt===0&&kt(ye)),Ce!==a?(zr=X,X=_we(ge)):(ce=X,X=a)):(ce=X,X=a),dt--,X===a&&(ge=a,dt===0&&kt(ee)),X}function PX(){var X,ge,Ce;if(dt++,X=ce,ge=[],Q.test(s.charAt(ce))?(Ce=s.charAt(ce),ce++):(Ce=a,dt===0&&kt(Ve)),Ce!==a)for(;Ce!==a;)ge.push(Ce),Q.test(s.charAt(ce))?(Ce=s.charAt(ce),ce++):(Ce=a,dt===0&&kt(Ve));else ge=a;return ge!==a&&(zr=X,ge=bwe()),dt--,(X=ge)===a&&(ge=a,dt===0&&kt(Ae)),X}function Gwe(){var X,ge,Ce;return dt++,X=ce,Sn(),(ge=Pc())!==a?(s.charCodeAt(ce)===37?(Ce=v,ce++):(Ce=a,dt===0&&kt(xe)),Ce!==a?(zr=X,X=wwe(ge)):(ce=X,X=a)):(ce=X,X=a),dt--,X===a&&dt===0&&kt(Se),X}function jwe(){var X,ge,Ce;return dt++,X=ce,Sn(),(ge=Pc())!==a?(s.substr(ce,2)===b?(Ce=b,ce+=2):(Ce=a,dt===0&&kt(ze)),Ce!==a?(zr=X,X=xwe(ge)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,Sn(),(ge=Pc())!==a?(s.substr(ce,2)===w?(Ce=w,ce+=2):(Ce=a,dt===0&&kt(ji)),Ce!==a?(zr=X,X=Twe(ge)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,Sn(),(ge=Pc())!==a?(s.substr(ce,2)===S?(Ce=S,ce+=2):(Ce=a,dt===0&&kt(Yr)),Ce!==a?(zr=X,X=Swe(ge)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,Sn(),(ge=Pc())!==a?(s.substr(ce,2)===T?(Ce=T,ce+=2):(Ce=a,dt===0&&kt(Ms)),Ce!==a?(zr=X,X=Ewe(ge)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,Sn(),(ge=Pc())!==a?(s.substr(ce,2)===A?(Ce=A,ce+=2):(Ce=a,dt===0&&kt(Ps)),Ce!==a?(zr=X,X=Awe(ge)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,Sn(),(ge=Pc())!==a?(s.substr(ce,2)===C?(Ce=C,ce+=2):(Ce=a,dt===0&&kt(ds)),Ce!==a?(zr=X,X=Cwe(ge)):(ce=X,X=a)):(ce=X,X=a)))))),dt--,X===a&&dt===0&&kt(Re),X}function Hwe(){var X,ge,Ce;return dt++,X=ce,(ge=Pc())!==a?(s.substr(ce,3)===O?(Ce=O,ce+=3):(Ce=a,dt===0&&kt(Tb)),Ce!==a?(zr=X,X=Rwe(ge)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,(ge=Pc())!==a?(s.substr(ce,3)===L?(Ce=L,ce+=3):(Ce=a,dt===0&&kt(n5)),Ce!==a?(zr=X,X=Owe(ge)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,(ge=Pc())!==a?(s.substr(ce,4)===U?(Ce=U,ce+=4):(Ce=a,dt===0&&kt(Pt)),Ce!==a?(zr=X,X=Mwe(ge)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,(ge=Pc())!==a?(s.substr(ce,4)===N?(Ce=N,ce+=4):(Ce=a,dt===0&&kt(JO)),Ce!==a?(zr=X,X=Pwe(ge)):(ce=X,X=a)):(ce=X,X=a)))),dt--,X===a&&(ge=a,dt===0&&kt(Is)),X}function qwe(){var X,ge;return dt++,X=ce,Sn(),(ge=Pc())!==a?(zr=X,X=Iwe(ge)):(ce=X,X=a),dt--,X===a&&dt===0&&kt(ad),X}function Wwe(){var X,ge,Ce,Jt;if(dt++,X=ce,s.charCodeAt(ce)===35?(ge=z,ce++):(ge=a,dt===0&&kt(a2)),ge!==a){if(Ce=[],te.test(s.charAt(ce))?(Jt=s.charAt(ce),ce++):(Jt=a,dt===0&&kt(AX)),Jt!==a)for(;Jt!==a;)Ce.push(Jt),te.test(s.charAt(ce))?(Jt=s.charAt(ce),ce++):(Jt=a,dt===0&&kt(AX));else Ce=a;Ce!==a?(zr=X,X=$we()):(ce=X,X=a)}else ce=X,X=a;return X===a&&(X=ce,(ge=a5())!==a&&(zr=X,ge=Dwe(ge)),(X=ge)===a&&(X=ce,(ge=PX())!==a&&(zr=X,ge=Lwe()),X=ge)),dt--,X===a&&(ge=a,dt===0&&kt(o2)),X}function Pc(){var X,ge,Ce,Jt,Zn,Zr,Ic;for(X=ce,ie.test(s.charAt(ce))?(s.charAt(ce),ce++):dt===0&&kt(CX),ge=ce,Ce=[],$.test(s.charAt(ce))?(Jt=s.charAt(ce),ce++):(Jt=a,dt===0&&kt(ig));Jt!==a;)Ce.push(Jt),$.test(s.charAt(ce))?(Jt=s.charAt(ce),ce++):(Jt=a,dt===0&&kt(ig));if(s.charCodeAt(ce)===46?(Jt=V,ce++):(Jt=a,dt===0&&kt(dwe)),Jt!==a){if(Zn=[],$.test(s.charAt(ce))?(Zr=s.charAt(ce),ce++):(Zr=a,dt===0&&kt(ig)),Zr!==a)for(;Zr!==a;)Zn.push(Zr),$.test(s.charAt(ce))?(Zr=s.charAt(ce),ce++):(Zr=a,dt===0&&kt(ig));else Zn=a;Zn!==a?ge=Ce=[Ce,Jt,Zn]:(ce=ge,ge=a)}else ce=ge,ge=a;if(ge===a)if(ge=[],$.test(s.charAt(ce))?(Ce=s.charAt(ce),ce++):(Ce=a,dt===0&&kt(ig)),Ce!==a)for(;Ce!==a;)ge.push(Ce),$.test(s.charAt(ce))?(Ce=s.charAt(ce),ce++):(Ce=a,dt===0&&kt(ig));else ge=a;if(ge!==a){if(Ce=ce,s.charCodeAt(ce)===101?(Jt=B,ce++):(Jt=a,dt===0&&kt(pwe)),Jt!==a){if(ie.test(s.charAt(ce))?(Zn=s.charAt(ce),ce++):(Zn=a,dt===0&&kt(CX)),Zn===a&&(Zn=null),Zr=[],$.test(s.charAt(ce))?(Ic=s.charAt(ce),ce++):(Ic=a,dt===0&&kt(ig)),Ic!==a)for(;Ic!==a;)Zr.push(Ic),$.test(s.charAt(ce))?(Ic=s.charAt(ce),ce++):(Ic=a,dt===0&&kt(ig));else Zr=a;Zr!==a?Ce=Jt=[Jt,Zn,Zr]:(ce=Ce,Ce=a)}else ce=Ce,Ce=a;Ce===a&&(Ce=null),zr=X,X=Nwe()}else ce=X,X=a;return X}function Xwe(X,ge){return X.map(function(Ce){return Ce[ge]})}function Ywe(X,ge,Ce){return[X].concat(Xwe(ge,Ce))}if((o=h())!==a&&ce===s.length)return o;throw o!==a&&ce<s.length&&kt(Fwe()),Uwe(o5,ld<s.length?s.charAt(ld):null,ld<s.length?OX(ld,ld+1):OX(ld,ld))}return e(t,Error),t.prototype.format=function(s){var n="Error: "+this.message;if(this.location){var o,a=null;for(o=0;o<s.length;o++)if(s[o].source===this.location.source){a=s[o].text.split(/\r\n|\n|\r/g);break}var l=this.location.start,c=this.location.source+":"+l.line+":"+l.column;if(a){var h=this.location.end,p=i("",l.line.toString().length),f=a[l.line-1],g=l.line===h.line?h.column:f.length+1;n+=`
 --> `+c+`
`+p+` |
`+l.line+" | "+f+`
`+p+" | "+i("",l.column-1)+i("",g-l.column,"^")}else n+=`
 at `+c}return n},t.buildMessage=function(s,n){var o={literal:function(g){return'"'+l(g.text)+'"'},class:function(g){var y=g.parts.map(function(v){return Array.isArray(v)?c(v[0])+"-"+c(v[1]):c(v)});return"["+(g.inverted?"^":"")+y+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(g){return g.description}};function a(g){return g.charCodeAt(0).toString(16).toUpperCase()}function l(g){return g.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(y){return"\\x0"+a(y)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(y){return"\\x"+a(y)})}function c(g){return g.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(y){return"\\x0"+a(y)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(y){return"\\x"+a(y)})}function h(g){return o[g.type](g)}function p(g){var y,v,b=g.map(h);if(b.sort(),b.length>0){for(y=1,v=1;y<b.length;y++)b[y-1]!==b[y]&&(b[v]=b[y],v++);b.length=v}switch(b.length){case 1:return b[0];case 2:return b[0]+" or "+b[1];default:return b.slice(0,-1).join(", ")+", or "+b[b.length-1]}}function f(g){return g?'"'+l(g)+'"':"end of input"}return"Expected "+p(s)+" but "+f(n)+" found."},{SyntaxError:t,parse:r}},(VJ=Bfe).exports&&(VJ.exports=GJ());const YH={deg:1,grad:.9,rad:180/Math.PI,turn:360};function kUe(e){if(e.type!=="quantity"||!(e.value===0&&e.unit===null||e.unit&&YH[e.unit]!=null))throw new q("effect:type-error",`Expected <angle>, Actual: ${FF(e)}`,{term:e})}const ZH={px:1,cm:96/2.54,mm:96/2.54/10,in:96,pc:16,pt:96/72};function zUe(e){if(e.type!=="quantity"||!(e.value===0&&e.unit===null||e.unit&&ZH[e.unit]!=null))throw new q("effect:type-error",`Expected <length>, Actual: ${FF(e)}`,{term:e})}function Oh(e){UUe(e);const t=e.value;return AO(t,e),e.unit==="%"?.01*t:t}function BUe(e){return FUe(e),AO(e.value,e),e.value}function VUe(e){return kUe(e),e.value*YH[e.unit]||0}function QH(e){return zUe(e),e.value*ZH[e.unit]||0}function GUe(e){switch(e.colorType){case"hex":return exe(e.value);case"named":return Gfe(e.value);case"function":return qUe(e.value)}}function Gfe(e){if(!toe(e))throw new q("effect:unknown-color",`color '${e}' isn't valid`,{namedColor:e});return Kwe(e)}const jUe=/^rgba?/i,HUe=/^hsla?/i;function qUe(e){if(KS(e.parameters,4),jUe.test(e.name))return[Oh(e.parameters[0]),Oh(e.parameters[1]),Oh(e.parameters[2]),e.parameters[3]?Oh(e.parameters[3]):1];if(HUe.test(e.name))return ioe(BUe(e.parameters[0]),Oh(e.parameters[1]),Oh(e.parameters[2]),e.parameters[3]?Oh(e.parameters[3]):1);throw new q("effect:syntax-error",`Invalid color function '${e.name}'`,{colorFunction:e})}function q8(e,t,i){try{return XUe(e)}catch(s){var r;i==null||(r=i.messages)==null||r.push(s)}return null}function W8(e,t,i,r){try{const s=WUe(e);yc(i,s,t)}catch(s){r.messages&&r.messages.push(s)}}function WUe(e){const t=Vfe(e);return t?OUe(t)?t.map(i=>i.toJSON()):t.map(({scale:i,effects:r})=>({scale:i,value:r.map(s=>s.toJSON())})):null}function XUe(e){if(!e||e.length===0)return null;if(YUe(e)){const t=[];for(const i of e)t.push({scale:i.scale,value:HJ(i.value)});return t}return HJ(e)}function YUe(e){const t=e[0];return!!t&&"scale"in t}function HJ(e){if(!e||!e.length)return"";const t=[];for(const i of e){let r=[];switch(i.type){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":case"opacity":r=[Zp(i,"amount")];break;case"blur":r=[Zp(i,"radius","pt")];break;case"hue-rotate":r=[Zp(i,"angle","deg")];break;case"drop-shadow":r=[Zp(i,"xoffset","pt"),Zp(i,"yoffset","pt"),Zp(i,"blurRadius","pt"),ZUe(i,"color")];break;case"bloom":r=[Zp(i,"strength"),Zp(i,"radius","pt"),Zp(i,"threshold")]}const s=`${i.type}(${r.filter(Boolean).join(" ")})`;Vfe(s),t.push(s)}return t.join(" ")}function Zp(e,t,i){if(e[t]==null)throw new q("effect:missing-parameter",`Missing parameter '${t}' in ${e.type} effect`,{effect:e});return i?e[t]+i:""+e[t]}function ZUe(e,t){if(e[t]==null)throw new q("effect:missing-parameter",`Missing parameter '${t}' in ${e.type} effect`,{effect:e});const i=e[t];return`rgba(${i[0]||0}, ${i[1]||0}, ${i[2]||0}, ${i[3]/255||0})`}const QUe=e=>{let t=class extends e{constructor(){super(...arguments),this.blendMode="normal",this.effect=null}};return u([d({type:["average","color-burn","color-dodge","color","darken","destination-atop","destination-in","destination-out","destination-over","difference","exclusion","hard-light","hue","invert","lighten","lighter","luminosity","minus","multiply","normal","overlay","plus","reflect","saturation","screen","soft-light","source-atop","source-in","source-out","vivid-light","xor"],nonNullable:!0,json:{read:!1,write:!1,origins:{"web-map":{read:!0,write:!0}}}})],t.prototype,"blendMode",void 0),u([d({json:{read:!1,write:!1,origins:{"web-map":{read:{reader:q8},write:{allowNull:!0,writer:W8}}}}})],t.prototype,"effect",void 0),t=u([P("esri.layers.mixins.BlendLayer")],t),t},JUe=e=>{let t=class extends e{constructor(){super(...arguments),this.customParameters=null}};return u([d({type:Object,json:{write:{overridePolicy:i=>({enabled:!!(i&&Object.keys(i).length>0)})}}})],t.prototype,"customParameters",void 0),t=u([P("esri.layers.mixins.CustomParametersMixin")],t),t};var X8;const xU=new si({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),TU=new si({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let kd=X8=class extends fe{constructor(e){super(e),this.where=null,this.geometry=null,this.spatialRelationship="intersects",this.distance=void 0,this.objectIds=null,this.units=null,this.timeExtent=null}createQuery(e={}){const{where:t,geometry:i,spatialRelationship:r,timeExtent:s,objectIds:n,units:o,distance:a}=this;return new va(I({geometry:se(i),objectIds:se(n),spatialRelationship:r,timeExtent:se(s),where:t,units:o,distance:a},e))}clone(){const{where:e,geometry:t,spatialRelationship:i,timeExtent:r,objectIds:s,units:n,distance:o}=this;return new X8({geometry:se(t),objectIds:se(s),spatialRelationship:i,timeExtent:se(r),where:e,units:n,distance:o})}};u([d({type:String,json:{write:!0}})],kd.prototype,"where",void 0),u([d({types:ob,json:{write:!0}})],kd.prototype,"geometry",void 0),u([d({type:xU.apiValues,json:{name:"spatialRel",read:{reader:xU.read},write:{allowNull:!1,writer:xU.write,overridePolicy(){return{enabled:_(this.geometry)}}}}})],kd.prototype,"spatialRelationship",void 0),u([d({type:Number,json:{write:{overridePolicy(e){return{enabled:e!=null&&this.geometry!=null}}}}})],kd.prototype,"distance",void 0),u([d({type:[Number],json:{write:!0}})],kd.prototype,"objectIds",void 0),u([d({type:TU.apiValues,json:{read:TU.read,write:{writer:TU.write,overridePolicy(e){return{enabled:e!=null&&this.geometry!=null}}}}})],kd.prototype,"units",void 0),u([d({type:zp,json:{write:!0}})],kd.prototype,"timeExtent",void 0),kd=X8=u([P("esri.layers.support.FeatureFilter")],kd);const KUe=kd;var Y8;let i_=Y8=class extends fe{constructor(e){super(e),this.filter=null,this.includedEffect=null,this.excludedEffect=null,this.excludedLabelsVisible=!1}write(e,t){const i=super.write(e,t);if(t!=null&&t.origin){if(i.filter){const n=Object.keys(i.filter);var r;if(n.length>1||n[0]!=="where")return(r=t.messages)==null||r.push(new q("web-document-write:unsupported-feature-effect","Invalid feature effect 'filter'. A filter can only contain a 'where' property",{layer:t.layer,effect:this})),null}var s;if("showExcludedLabels"in i)return(s=t.messages)==null||s.push(new q("web-document-write:unsupported-feature-effect","Invalid value for property 'excludedLabelsVisible' which should always be 'true'",{layer:t.layer,effect:this})),null}return i}clone(){return new Y8({filter:_(this.filter)&&this.filter.clone(),includedEffect:this.includedEffect,excludedEffect:this.excludedEffect,excludedLabelsVisible:this.excludedLabelsVisible})}};u([d({type:KUe,json:{write:{allowNull:!0,writer(e,t,i,r){const s=e==null?void 0:e.write({},r);s&&Object.keys(s).length!==0?yc(i,s,t):yc(i,null,t)}}}})],i_.prototype,"filter",void 0),u([d({json:{write:!0,origins:{"web-map":{read:{reader:q8},write:{writer:W8,overridePolicy(){return{allowNull:this.excludedEffect!=null,isRequired:this.excludedEffect==null}}}}}}})],i_.prototype,"includedEffect",void 0),u([d({json:{write:!0,origins:{"web-map":{read:{reader:q8},write:{writer:W8,overridePolicy(){return{allowNull:this.includedEffect!=null,isRequired:this.includedEffect==null}}}}}}})],i_.prototype,"excludedEffect",void 0),u([d({type:Boolean,json:{write:!0,name:"showExcludedLabels",origins:{"web-map":{name:"showExcludedLabels",default:!0}}}})],i_.prototype,"excludedLabelsVisible",void 0),i_=Y8=u([P("esri.layers.support.FeatureEffect")],i_);const eke=i_,tke=e=>{let t=class extends e{constructor(){super(...arguments),this.featureEffect=null}};return u([d({type:eke,json:{origins:{"web-map":{write:{allowNull:!0}}}}})],t.prototype,"featureEffect",void 0),t=u([P("esri.layers.mixins.FeatureEffectLayer")],t),t},ike={"web-scene/operational-layers":{ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISMapServiceLayer:!0,ArcGISSceneServiceLayer:!0,ArcGISTiledElevationServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BuildingSceneLayer:!0,GroupLayer:!0,IntegratedMeshLayer:!0,OGCFeatureLayer:!0,PointCloudLayer:!0,WebTiledLayer:!0,CSV:!0,GeoJSON:!0,VectorTileLayer:!0,WFS:!0,WMS:!0,KML:!0,RasterDataLayer:!0,Voxel:!0},"web-scene/basemap":{ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,WebTiledLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,ArcGISImageServiceLayer:!0,WMS:!0,ArcGISMapServiceLayer:!0},"web-scene/ground":{ArcGISTiledElevationServiceLayer:!0,RasterDataElevationLayer:!0},"web-map/operational-layers":{ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISStreamLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BingMapsAerial:!0,BingMapsHybrid:!0,BingMapsRoad:!0,CSV:!0,GeoRSS:!0,GeoJSON:!0,GroupLayer:!0,KML:!0,OGCFeatureLayer:!0,SubtypeGroupLayer:!0,VectorTileLayer:!0,WFS:!0,WMS:!0,WebTiledLayer:!0},"web-map/basemap":{ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,WMS:!0,WebTiledLayer:!0,BingMapsAerial:!0,BingMapsRoad:!0,BingMapsHybrid:!0},"web-map/tables":{ArcGISFeatureLayer:!0},"portal-item/operational-layers":{ArcGISFeatureLayer:!0,ArcGISSceneServiceLayer:!0,PointCloudLayer:!0,BuildingSceneLayer:!0,IntegratedMeshLayer:!0}};function rke(e){if(!e)return e;const{start:t,end:i}=e;return new zp({start:_(t)?h1(t,-t.getTimezoneOffset(),"minutes"):t,end:_(i)?h1(i,-i.getTimezoneOffset(),"minutes"):i})}function ske(e){if(!e)return e;const{start:t,end:i}=e;return new zp({start:_(t)?h1(t,t.getTimezoneOffset(),"minutes"):t,end:_(i)?h1(i,i.getTimezoneOffset(),"minutes"):i})}var Z8;let aA=Z8=class extends fe{async collectRequiredFields(e,t){return wc(e,t,this.expression)}clone(){return new Z8({expression:this.expression,title:this.title})}};u([d({type:String,json:{write:!0}})],aA.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],aA.prototype,"title",void 0),aA=Z8=u([P("esri.layers.support.FeatureExpressionInfo")],aA);const qJ=aA;function nke(e){return KT[e]!=null}function oke(e){return 1/(KT[e]||1)}function ake(){const e=Object.keys(KT);return e.sort(),e}const lke=ake();var Q8;const WM=_o()({onTheGround:"on-the-ground",relativeToGround:"relative-to-ground",relativeToScene:"relative-to-scene",absoluteHeight:"absolute-height"}),WJ=new si({foot:"feet",kilometer:"kilometers",meter:"meters",mile:"miles","us-foot":"us-feet",yard:"yards"});let Of=Q8=class extends fe{constructor(){super(...arguments),this.offset=null}readFeatureExpressionInfo(e,t){return e!=null?e:t.featureExpression&&t.featureExpression.value===0?{expression:"0"}:void 0}writeFeatureExpressionInfo(e,t,i,r){t[i]=e.write({},r),e.expression==="0"&&(t.featureExpression={value:0})}get mode(){const{offset:e,featureExpressionInfo:t}=this;return this._isOverridden("mode")?this._get("mode"):_(e)||t?"relative-to-ground":"on-the-ground"}set mode(e){this._override("mode",e)}set unit(e){this._set("unit",e)}write(e,t){return this.offset||this.mode||this.featureExpressionInfo||this.unit?super.write(e,t):null}clone(){return new Q8({mode:this.mode,offset:this.offset,featureExpressionInfo:this.featureExpressionInfo?this.featureExpressionInfo.clone():void 0,unit:this.unit})}};u([d({type:qJ,json:{write:!0}})],Of.prototype,"featureExpressionInfo",void 0),u([De("featureExpressionInfo",["featureExpressionInfo","featureExpression"])],Of.prototype,"readFeatureExpressionInfo",null),u([Fe("featureExpressionInfo",{featureExpressionInfo:{type:qJ},"featureExpression.value":{type:[0]}})],Of.prototype,"writeFeatureExpressionInfo",null),u([d({type:WM.apiValues,nonNullable:!0,json:{type:WM.jsonValues,read:WM.read,write:{writer:WM.write,isRequired:!0}}})],Of.prototype,"mode",null),u([d({type:Number,json:{write:!0}})],Of.prototype,"offset",void 0),u([d({type:lke,json:{type:String,read:WJ.read,write:WJ.write}})],Of.prototype,"unit",null),Of=Q8=u([P("esri.layers.support.ElevationInfo")],Of);const cke=Of,uke={type:Boolean,value:!0,json:{origins:{service:{read:!1,write:!1},"web-map":{read:!1,write:!1}},name:"screenSizePerspective",write:!0}},jfe={type:Boolean,value:!0,json:{name:"disablePopup",read:{reader:(e,t)=>!t.disablePopup},write:{enabled:!0,writer(e,t,i){t[i]=!e}}}},Hfe={type:Boolean,value:!0,json:{name:"showLabels",write:!0}},hke={type:String,json:{origins:{"portal-item":{write:!1}},write:{isRequired:!0,ignoreOrigin:!0,writer:v0}}},dke={type:Boolean,value:!0,json:{origins:{service:{read:{enabled:!1}}},name:"showLegend",write:!0}},pke={value:null,type:cke,json:{origins:{service:{name:"elevationInfo",write:!0}},name:"layerDefinition.elevationInfo",write:!0}};function Zgt(e){return{type:e,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}}}const ZI={type:Number,json:{origins:{"web-document":{write:!0,read:!0},"portal-item":{write:!0}}}},fke=me(I({},ZI),{json:me(I({},ZI.json),{origins:{"web-document":me(I({},ZI.json.origins["web-document"]),{write:{enabled:!0,target:{opacity:{type:Number},"layerDefinition.drawingInfo.transparency":{type:Number}}}})},read:{source:["layerDefinition.drawingInfo.transparency","drawingInfo.transparency"],reader:(e,t,i)=>i&&i.origin!=="service"||!t.drawingInfo||t.drawingInfo.transparency===void 0?t.layerDefinition&&t.layerDefinition.drawingInfo&&t.layerDefinition.drawingInfo.transparency!==void 0?NT(t.layerDefinition.drawingInfo.transparency):void 0:NT(t.drawingInfo.transparency)}})}),Qgt={type:zp,readOnly:!0,get(){var e,t;if((e=this.layer)==null||!e.timeInfo)return null;const{datesInUnknownTimezone:i,timeOffset:r,useViewTime:s}=this.layer,n=(t=this.view)==null?void 0:t.timeExtent;let o=this.layer.timeExtent;i&&(o=ske(o));let a=s?n&&o?n.intersection(o):n||o:o;if(!a||a.isEmpty||a.isAllTime)return a;r&&(a=a.offset(-r.value,r.unit)),i&&(a=rke(a));const l=this._get("timeExtent");return a.equals(l)?l:a}},Jgt={type:Xt,readOnly:!0,json:{origins:{service:{read:{source:["fullExtent","spatialReference"],reader:(e,t)=>{const i=Xt.fromJSON(e);return t.spatialReference!=null&&typeof t.spatialReference=="object"&&(i.spatialReference=He.fromJSON(t.spatialReference)),i}}}},read:!1}},mke={type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}}}},gke={type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.minScale"},write:{target:"layerDefinition.minScale"}}},yke={type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.maxScale"},write:{target:"layerDefinition.maxScale"}}},vke=e=>{let t=class extends e{constructor(){super(...arguments),this.title=null}writeListMode(i,r,s,n){(n&&n.layerContainerType==="ground"||i&&FSe(this,s,{},n))&&(r[s]=i)}writeOperationalLayerType(i,r,s,n){!i||n&&n.layerContainerType==="tables"||(r.layerType=i)}writeTitle(i,r){r.title=i||"Layer"}read(i,r){r&&(r.layer=this),Tae(this,i,s=>super.read(i,s),r)}write(i,r){if(r!=null&&r.origin){const l=`${r.origin}/${r.layerContainerType||"operational-layers"}`,c=ike[l];let h=c&&c[this.operationalLayerType];var s;if(this.operationalLayerType==="ArcGISTiledElevationServiceLayer"&&l==="web-scene/operational-layers"&&(h=!1),!h)return(s=r.messages)==null||s.push(new q("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${l}'`,{layer:this})),null}const n=super.write(i,me(I({},r),{layer:this})),o=!!r&&!!r.messages&&!!r.messages.filter(l=>l instanceof q&&l.name==="web-document-write:property-required").length;var a;return UT(n==null?void 0:n.url)?(r==null||(a=r.messages)==null||a.push(new q("layer:invalid-url",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using a Blob URL cannot be written to web scenes and web maps`,{layer:this})),null):!this.url&&o?null:n}beforeSave(){}};return u([d({type:String,json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0}},"portal-item":{write:!1}}}})],t.prototype,"id",void 0),u([d({json:{write:{ignoreOrigin:!0},origins:{"web-map":{read:!1,write:!1}}}})],t.prototype,"listMode",void 0),u([Fe("listMode")],t.prototype,"writeListMode",null),u([d({type:String,readOnly:!0,json:{read:!1,write:{target:"layerType",ignoreOrigin:!0},origins:{"portal-item":{write:!1}}}})],t.prototype,"operationalLayerType",void 0),u([Fe("operationalLayerType")],t.prototype,"writeOperationalLayerType",null),u([d(ZI)],t.prototype,"opacity",void 0),u([d({type:String,json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}},"portal-item":{write:!1}}},value:"Layer"})],t.prototype,"title",void 0),u([Fe("title")],t.prototype,"writeTitle",null),u([d({type:Boolean,json:{name:"visibility"}})],t.prototype,"visible",void 0),t=u([P("esri.layers.mixins.OperationalLayer")],t),t};function _ke(e){return"operationalLayerType"in e}var J8;const SU=new si({asc:"ascending",desc:"descending"});let Bw=J8=class extends fe{constructor(e){super(e),this.field=null,this.valueExpression=null,this.order="ascending"}clone(){return new J8({field:this.field,valueExpression:this.valueExpression,order:this.order})}};u([d({type:String,json:{write:!0}})],Bw.prototype,"field",void 0),u([d({type:String,json:{write:!0}})],Bw.prototype,"valueExpression",void 0),u([d({type:SU.apiValues,json:{read:SU.read,write:SU.write}})],Bw.prototype,"order",void 0),Bw=J8=u([P("esri.layers.support.OrderByInfo")],Bw);const qfe=Bw;function bke(e,t,i){if(!e)return null;const r=e.find(n=>!!n.field);if(!r)return null;const s=new qfe;return s.read(r,i),[s]}function wke(e,t,i,r){const s=e.find(n=>!!n.field);s&&yc(i,[s.toJSON()],t)}const xke=e=>{let t=class extends e{constructor(){super(...arguments),this.orderBy=null}};return u([d({type:[qfe],json:{origins:{"web-scene":{write:!1,read:!1}},read:{source:"layerDefinition.orderBy",reader:bke},write:{target:"layerDefinition.orderBy",writer:wke}}})],t.prototype,"orderBy",void 0),t=u([P("esri.layers.mixins.OrderedLayer")],t),t},Tke=he.getLogger("esri.portal.PortalItemResource");let ey=class extends we{constructor(e){super(e),this.portalItem=null}normalizeCtorArgs(e){return e&&e.portalItem&&e.path?me(I({},e),{path:this._normalizePath(e.path,e.portalItem)}):e}set path(e){_(e)&&fc(e)?Tke.error("portalitemresource:invalid-path","A portal item resource path must be relative"):this._set("path",e)}_castPath(e){return this._normalizePath(e,this.portalItem)}get url(){return this.portalItem&&this.path?`${this.portalItem.itemUrl}/resources/${this.path}`:null}get itemRelativeUrl(){return this.portalItem&&this.path?`./resources/${this.path}`:null}fetch(e="json",t){const i=this.url;if(R(i))throw new q("portal-item-resource:fetch","Portal item resource does not refer to a valid item or path");return this.portalItem.portal._request(i,{responseType:e,query:{token:this.portalItem.apiKey},signal:Pr(t,"signal")})}async update(e,t){return(await Promise.resolve().then(function(){return FA})).addOrUpdateResource(this,"update",e,t)}hasPath(){return _(this.path)}_normalizePath(e,t){return R(e)?e:(e=e.replace(/^\/+/,""),_(t)&&fc(e)&&(e=aj(e,t.itemUrl)),e.replace(/^\/+/,"").replace(/^(\.\/)?resources\//,""))}};u([d()],ey.prototype,"portalItem",void 0),u([d({type:String,value:null})],ey.prototype,"path",null),u([At("path")],ey.prototype,"_castPath",null),u([d({type:String,readOnly:!0})],ey.prototype,"url",null),u([d({type:String,readOnly:!0})],ey.prototype,"itemRelativeUrl",null),ey=u([P("esri.portal.PortalItemResource")],ey);const Ske=ey;let lA=class extends we{constructor(e){super(e),this.created=null,this.rating=null}};u([d()],lA.prototype,"created",void 0),u([d()],lA.prototype,"rating",void 0),lA=u([P("esri.portal.PortalRating")],lA);const EU=lA;var Vw;let Zt=Vw=class extends oO(Ep){constructor(e){super(e),this.access=null,this.accessInformation=null,this.apiKey=null,this.applicationProxies=null,this.avgRating=null,this.categories=null,this.created=null,this.culture=null,this.description=null,this.extent=null,this.groupCategories=null,this.id=null,this.itemControl=null,this.licenseInfo=null,this.modified=null,this.name=null,this.numComments=null,this.numRatings=null,this.numViews=null,this.owner=null,this.ownerFolder=null,this.portal=null,this.screenshots=null,this.size=null,this.snippet=null,this.sourceJSON=null,this.tags=null,this.title=null,this.type=null,this.typeKeywords=null,this.url=null}static from(e){return ST(Vw,e)}destroy(){this.portal=null}get displayName(){const e=this.type,t=this.typeKeywords||[];let i=e;return e==="Feature Service"||e==="Feature Collection"?i=t.indexOf("Table")>-1?"Table":t.indexOf("Route Layer")>-1?"Route Layer":t.indexOf("Markup")>-1?"Markup":"Feature Layer":e==="Image Service"?i=t.indexOf("Elevation 3D Layer")>-1?"Elevation Layer":t.indexOf("Tiled Imagery")>-1?"Tiled Imagery Layer":"Imagery Layer":e==="Scene Service"?i="Scene Layer":e==="Media Service"?i="Media Layer":e==="Scene Package"?i="Scene Layer Package":e==="Stream Service"?i="Feature Layer":e==="Geoprocessing Service"&&this.portal&&this.portal.isPortal?i=t.indexOf("Web Tool")>-1?"Tool":"Geoprocessing Service":e==="Geocoding Service"?i="Locator":e==="Geoenrichment Service"?i="GeoEnrichment Service":e==="Microsoft Powerpoint"?i="Microsoft PowerPoint":e==="GeoJson"?i="GeoJSON":e==="Globe Service"?i="Globe Layer":e==="Vector Tile Service"?i="Tile Layer":e==="netCDF"?i="NetCDF":e==="Map Service"?i=t.indexOf("Spatiotemporal")===-1&&(t.indexOf("Hosted Service")>-1||t.indexOf("Tiled")>-1)&&t.indexOf("Relational")===-1?"Tile Layer":"Map Image Layer":e&&e.toLowerCase().indexOf("add in")>-1?i=e.replace(/(add in)/gi,"Add-In"):e==="datastore catalog service"?i="Big Data File Share":e==="Compact Tile Package"?i="Tile Package (tpkx)":e==="OGCFeatureServer"?i="OGC Feature Layer":e==="web mapping application"&&t.indexOf("configurableApp")>-1&&(i="Instant App"),i}readExtent(e){return e&&e.length?new Xt(e[0][0],e[0][1],e[1][0],e[1][1]):null}get iconUrl(){const e=this.type&&this.type.toLowerCase()||"",t=this.typeKeywords||[],i="esri/images/portal/",r="16";let s,n=!1,o=!1,a=!1,l=!1,c=!1,h=!1;return e.indexOf("service")>0||e==="feature collection"||e==="kml"||e==="wms"||e==="wmts"||e==="wfs"?(n=t.indexOf("Hosted Service")>-1,e==="feature service"||e==="feature collection"||e==="kml"||e==="wfs"?(o=t.indexOf("Table")>-1,a=t.indexOf("Route Layer")>-1,l=t.indexOf("Markup")>-1,c=t.indexOf("Spatiotemporal")!==-1,h=t.indexOf("UtilityNetwork")!==-1,s=c&&o?"spatiotemporaltable":o?"table":a?"routelayer":l?"markup":c?"spatiotemporal":n?"featureshosted":h?"utilitynetwork":"features"):s=e==="map service"||e==="wms"||e==="wmts"?n||t.indexOf("Tiled")>-1||e==="wmts"?"maptiles":"mapimages":e==="scene service"?t.indexOf("Line")>-1?"sceneweblayerline":t.indexOf("3DObject")>-1?"sceneweblayermultipatch":t.indexOf("Point")>-1?"sceneweblayerpoint":t.indexOf("IntegratedMesh")>-1?"sceneweblayermesh":t.indexOf("PointCloud")>-1?"sceneweblayerpointcloud":t.indexOf("Polygon")>-1?"sceneweblayerpolygon":t.indexOf("Building")>-1?"sceneweblayerbuilding":t.indexOf("Voxel")>-1?"sceneweblayervoxel":"sceneweblayer":e==="image service"?t.indexOf("Elevation 3D Layer")>-1?"elevationlayer":t.indexOf("Tiled Imagery")>-1?"tiledimagerylayer":"imagery":e==="stream service"?"streamlayer":e==="media service"?"mediaservice":e==="vector tile service"?"vectortile":e==="datastore catalog service"?"datastorecollection":e==="geocoding service"?"geocodeservice":e==="geoprocessing service"&&t.indexOf("Web Tool")>-1&&this.portal&&this.portal.isPortal?"tool":"layers"):s=e==="web map"||e==="cityengine web scene"?"maps":e==="web scene"?t.indexOf("ViewingMode-Local")>-1?"webscenelocal":"websceneglobal":e==="web mapping application"&&t.indexOf("configurableApp")>-1?"instantapps":e==="web mapping application"||e==="mobile application"||e==="application"||e==="operation view"||e==="desktop application"?"apps":e==="map document"||e==="map package"||e==="published map"||e==="scene document"||e==="globe document"||e==="basemap package"||e==="mobile basemap package"||e==="mobile map package"||e==="project package"||e==="project template"||e==="pro map"||e==="layout"||e==="layer"&&t.indexOf("ArcGIS Pro")>-1||e==="explorer map"&&t.indexOf("Explorer Document")?"mapsgray":e==="service definition"||e==="csv"||e==="shapefile"||e==="cad drawing"||e==="geojson"||e==="360 vr experience"||e==="netcdf"||e==="administrative report"?"datafiles":e==="explorer add in"||e==="desktop add in"||e==="windows viewer add in"||e==="windows viewer configuration"?"appsgray":e==="arcgis pro add in"||e==="arcgis pro configuration"?"addindesktop":e==="rule package"||e==="file geodatabase"||e==="sqlite geodatabase"||e==="csv collection"||e==="kml collection"||e==="windows mobile package"||e==="map template"||e==="desktop application template"||e==="gml"||e==="arcpad package"||e==="code sample"||e==="form"||e==="document link"||e==="earth configuration"||e==="operations dashboard add in"||e==="rules package"||e==="image"||e==="workflow manager package"||e==="explorer map"&&t.indexOf("Explorer Mapping Application")>-1||t.indexOf("Document")>-1?"datafilesgray":e==="network analysis service"||e==="geoprocessing service"||e==="geodata service"||e==="geometry service"||e==="geoprocessing package"||e==="locator package"||e==="geoprocessing sample"||e==="workflow manager service"?"toolsgray":e==="layer"||e==="layer package"||e==="explorer layer"?"layersgray":e==="scene package"?"scenepackage":e==="mobile scene package"?"mobilescenepackage":e==="tile package"||e==="compact tile package"?"tilepackage":e==="task file"?"taskfile":e==="report template"?"report-template":e==="statistical data collection"?"statisticaldatacollection":e==="insights workbook"?"workbook":e==="insights model"?"insightsmodel":e==="insights page"?"insightspage":e==="insights theme"?"insightstheme":e==="hub initiative"?"hubinitiative":e==="hubpage"?"hubpage":e==="hub event"?"hubevent":e==="hub site application"?"hubsite":e==="hub project"?"hubproject":e==="relational database connection"?"relationaldatabaseconnection":e==="big data file share"?"datastorecollection":e==="image collection"?"imagecollection":e==="style"?"style":e==="desktop style"?"desktopstyle":e==="dashboard"?"dashboard":e==="raster function template"?"rasterprocessingtemplate":e==="vector tile package"?"vectortilepackage":e==="ortho mapping project"?"orthomappingproject":e==="ortho mapping template"?"orthomappingtemplate":e==="solution"?"solutions":e==="geopackage"?"geopackage":e==="deep learning package"?"deeplearningpackage":e==="real time analytic"?"realtimeanalytics":e==="big data analytic"?"bigdataanalytics":e==="feed"?"feed":e==="excalibur imagery project"?"excaliburimageryproject":e==="notebook"?"notebook":e==="storymap"?"storymap":e==="survey123 add in"?"survey123addin":e==="mission"?"mission":e==="mission report"?"missionreport":e==="quickcapture project"?"quickcaptureproject":e==="pro report"?"proreport":e==="urban model"?"urbanmodel":e==="web experience"?"experiencebuilder":e==="web experience template"?"webexperiencetemplate":e==="experience builder widget"?"experiencebuilderwidget":e==="experience builder widget package"?"experiencebuilderwidgetpackage":e==="workflow"?"workflow":e==="insights script"?"insightsscript":e==="kernel gateway connection"?"kernelgatewayconnection":e==="hub initiative template"?"hubinitiativetemplate":e==="storymap theme"?"storymaptheme":e==="knowledge graph"?"knowledgegraph":e==="native application"?"nativeapp":e==="native application installer"?"nativeappinstaller":e==="link chart"?"linkchart":e==="investigation"?"investigation":e==="ogcfeatureserver"?"features":e==="pro project"?"proproject":e==="insights workbook package"?"insightsworkbookpackage":e==="apache parquet"?"apacheparquet":"maps",s?ui(i+s+r+".png"):null}get isLayer(){return["Map Service","Feature Service","Feature Collection","Scene Service","Image Service","Stream Service","Vector Tile Service","WMTS","WMS"].indexOf(this.type)>-1}get itemUrl(){const e=this.get("portal.restUrl");return e?e+"/content/items/"+this.id:null}get thumbnailUrl(){const e=this.itemUrl,t=this.thumbnail;return e&&t?this.portal._normalizeUrl(`${e}/info/${t}?f=json`):null}get userItemUrl(){const e=this.get("portal.restUrl");if(!e)return null;const t=this.owner||this.get("portal.user.username");return t?`${e}/content/users/${this.ownerFolder?`${t}/${this.ownerFolder}`:t}/items/${this.id}`:null}load(e){this.portal||(this.portal=Bn.getDefault());const t=this.portal.load(e).then(()=>this.sourceJSON?this.sourceJSON:this.id&&this.itemUrl?this.portal._request(this.itemUrl,{signal:_(e)?e.signal:null,query:{token:this.apiKey}}):{}).then(i=>{this.sourceJSON=i,this.read(i)});return this.addResolvingPromise(t),Promise.resolve(this)}addRating(e){const t={method:"post",query:{}};return e instanceof EU&&(e=e.rating),isNaN(e)||typeof e!="number"||(t.query.rating=e),this.portal._request(this.itemUrl+"/addRating",t).then(()=>new EU({rating:e,created:new Date}))}clone(){const e={access:this.access,accessInformation:this.accessInformation,applicationProxies:se(this.applicationProxies),avgRating:this.avgRating,categories:se(this.categories),created:se(this.created),culture:this.culture,description:this.description,extent:se(this.extent),groupCategories:se(this.groupCategories),id:this.id,itemControl:this.itemControl,licenseInfo:this.licenseInfo,modified:se(this.modified),name:this.name,numComments:this.numComments,numRatings:this.numRatings,numViews:this.numViews,owner:this.owner,ownerFolder:this.ownerFolder,portal:this.portal,screenshots:se(this.screenshots),size:this.size,snippet:this.snippet,tags:se(this.tags),thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:se(this.typeKeywords),url:this.url};return this.loaded&&(e.loadStatus="loaded"),new Vw({sourceJSON:this.sourceJSON}).set(e)}createPostQuery(){const e=this.toJSON();for(const t in e)t==="tags"&&e[t]!==null&&(e[t]=e[t].join(", ")),t==="typeKeywords"&&e[t]!==null&&(e[t]=e[t].join(", ")),t==="extent"&&e[t]&&(e[t]=JSON.stringify(e[t]));return e}deleteRating(){return this.portal._request(this.itemUrl+"/deleteRating",{method:"post"}).then(()=>{})}fetchData(e="json",t){return this.portal._request(this.itemUrl+"/data",me(I({responseType:e},t),{query:{token:this.apiKey}}))}fetchRating(e){return this.portal._request(this.itemUrl+"/rating",I({query:{token:this.apiKey}},e)).then(t=>t.rating!=null?(t.created=new Date(t.created),new EU(t)):null)}fetchRelatedItems(e,t){return this.portal._requestToTypedArray(this.itemUrl+"/relatedItems",I({query:me(I({},e),{token:this.apiKey})},t),Vw)}getThumbnailUrl(e){let t=this.thumbnailUrl;return t&&e&&(t+=`&w=${e}`),t}reload(){return this.portal._request(this.itemUrl,{cacheBust:!0,query:{token:this.apiKey}}).then(e=>(this.sourceJSON=e,this.read(e),this))}update(e){return this.id?this.load().then(()=>this.portal._signIn()).then(()=>{const t=e&&e.data,i={method:"post"};i.query=this.createPostQuery();for(const r in i.query)i.query[r]===null&&(i.query[r]="");return i.query.clearEmptyFields=!0,t!=null&&(typeof t=="string"?i.query.text=t:typeof t=="object"&&(i.query.text=JSON.stringify(t))),this.portal._request(`${this.userItemUrl}/update`,i).then(()=>this.reload())}):Promise.reject(new q("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}updateThumbnail(e){return this.id?this.load().then(()=>this.portal._signIn()).then(()=>{const t=e.thumbnail,i=e.filename,r={method:"post"};if(typeof t=="string")Up(t)?r.query={data:t}:r.query={url:Au(t)},_(i)&&(r.query.filename=i);else{const s=new FormData;_(i)?s.append("file",t,i):s.append("file",t),r.body=s}return this.portal._request(`${this.userItemUrl}/updateThumbnail`,r).then(()=>this.reload())}):Promise.reject(new q("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}async fetchResources(e={},t){return(await Promise.resolve().then(function(){return FA})).fetchResources(this,e,t)}async addResource(e,t,i){const r=await Promise.resolve().then(function(){return FA});return e.portalItem=this,r.addOrUpdateResource(e,"add",t,i)}async removeResource(e,t){const i=await Promise.resolve().then(function(){return FA});if(e.portalItem&&e.portalItem.itemUrl!==this.itemUrl)throw new q("removeresource:portal-item-mismatch","The portal item associated with the provided resource does not match the item");return i.removeResource(this,e,t)}async removeAllResources(e){return(await Promise.resolve().then(function(){return FA})).removeAllResources(this,e)}resourceFromPath(e){return new Ske({portalItem:this,path:e})}toJSON(){const e=this.extent,t={created:this.created&&this.created.getTime(),description:this.description,extent:e&&[[e.xmin,e.ymin],[e.xmax,e.ymax]],id:this.id,modified:this.modified&&this.modified.getTime(),name:this.name,owner:this.owner,ownerFolder:this.ownerFolder,snippet:this.snippet,tags:this.tags,thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:this.typeKeywords,url:this.url};return Soe(t)}static fromJSON(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");return new Vw({sourceJSON:e})}_getPostQuery(){const e=this.toJSON();for(const t in e)t==="tags"&&e[t]!==null&&(e[t]=e[t].join(", ")),t==="typeKeywords"&&e[t]!==null&&(e[t]=e[t].join(", ")),t==="extent"&&e[t]&&(e[t]=JSON.stringify(e[t]));return e}};u([d({type:["private","shared","org","public"]})],Zt.prototype,"access",void 0),u([d()],Zt.prototype,"accessInformation",void 0),u([d({type:String})],Zt.prototype,"apiKey",void 0),u([d({json:{read:{source:"appProxies"}}})],Zt.prototype,"applicationProxies",void 0),u([d()],Zt.prototype,"avgRating",void 0),u([d()],Zt.prototype,"categories",void 0),u([d({type:Date})],Zt.prototype,"created",void 0),u([d()],Zt.prototype,"culture",void 0),u([d()],Zt.prototype,"description",void 0),u([d({readOnly:!0})],Zt.prototype,"displayName",null),u([d({type:Xt})],Zt.prototype,"extent",void 0),u([De("extent")],Zt.prototype,"readExtent",null),u([d()],Zt.prototype,"groupCategories",void 0),u([d({readOnly:!0})],Zt.prototype,"iconUrl",null),u([d()],Zt.prototype,"id",void 0),u([d({readOnly:!0})],Zt.prototype,"isLayer",null),u([d()],Zt.prototype,"itemControl",void 0),u([d({readOnly:!0})],Zt.prototype,"itemUrl",null),u([d()],Zt.prototype,"licenseInfo",void 0),u([d({type:Date})],Zt.prototype,"modified",void 0),u([d()],Zt.prototype,"name",void 0),u([d()],Zt.prototype,"numComments",void 0),u([d()],Zt.prototype,"numRatings",void 0),u([d()],Zt.prototype,"numViews",void 0),u([d()],Zt.prototype,"owner",void 0),u([d()],Zt.prototype,"ownerFolder",void 0),u([d({type:Bn})],Zt.prototype,"portal",void 0),u([d()],Zt.prototype,"screenshots",void 0),u([d()],Zt.prototype,"size",void 0),u([d()],Zt.prototype,"snippet",void 0),u([d()],Zt.prototype,"sourceJSON",void 0),u([d()],Zt.prototype,"tags",void 0),u([d()],Zt.prototype,"thumbnail",void 0),u([d({readOnly:!0})],Zt.prototype,"thumbnailUrl",null),u([d()],Zt.prototype,"title",void 0),u([d()],Zt.prototype,"type",void 0),u([d()],Zt.prototype,"typeKeywords",void 0),u([d()],Zt.prototype,"url",void 0),u([d({readOnly:!0})],Zt.prototype,"userItemUrl",null),Zt=Vw=u([P("esri.portal.PortalItem")],Zt);const tS=Zt;var Wfe=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:tS});const Eke=he.getLogger("esri.layers.mixins.PortalLayer"),Ake=e=>{let t=class extends e{constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0}destroy(){var i;(i=this.portalItem)==null||i.destroy(),this.portalItem=null}set portalItem(i){i!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",i))}readPortalItem(i,r,s){if(r.itemId)return new tS({id:r.itemId,portal:s&&s.portal})}writePortalItem(i,r){i&&i.id&&(r.itemId=i.id)}async loadFromPortal(i,r){if(this.portalItem&&this.portalItem.id)try{const s=await import("./layersLoader.0b81b3bd.js").then(function(n){return n.l});return Qt(r),await s.load({instance:this,supportedTypes:i.supportedTypes,validateItem:i.validateItem,supportsData:i.supportsData},r)}catch(s){throw pr(s)||Eke.warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})
  ${s}`),s}}async finishLoadEditablePortalLayer(i){this._set("userHasEditingPrivileges",await this._fetchUserHasEditingPrivileges(i).catch(r=>(zm(r),!0)))}async _fetchUserHasEditingPrivileges(i){const r=this.url?Ss==null?void 0:Ss.findCredential(this.url):null;if(!r)return!0;const s=XM.credential===r?XM.user:await this._fetchEditingUser(i);return XM.credential=r,XM.user=s,R(s)||s.privileges==null||s.privileges.includes("features:user:edit")}async _fetchEditingUser(i){var r,s;const n=(r=this.portalItem)==null||(s=r.portal)==null?void 0:s.user;if(n)return n;const o=Ss.findServerInfo(this.url);if(o==null||!o.owningSystemUrl)return null;const a=`${o.owningSystemUrl}/sharing/rest`,l=Bn.getDefault();if(l&&l.loaded&&Pu(l.restUrl)===Pu(a))return l.user;const c=`${a}/community/self`,h=_(i)?i.signal:null,p=await wl(Ti(c,{authMode:"no-prompt",query:{f:"json"},signal:h}));return p.ok?gj.fromJSON(p.value.data):null}read(i,r){r&&(r.layer=this),super.read(i,r)}write(i,r){const s=r&&r.portal,n=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||Bn.getDefault());return s&&n&&!qle(n.restUrl,s.restUrl)?(r.messages&&r.messages.push(new q("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save the scene, set the layer.portalItem to null or save the scene to the same portal as the item associated with the layer`,{layer:this})),null):super.write(i,me(I({},r),{layer:this}))}};return u([d({type:tS})],t.prototype,"portalItem",null),u([De("web-document","portalItem",["itemId"])],t.prototype,"readPortalItem",null),u([Fe("web-document","portalItem",{itemId:{type:String}})],t.prototype,"writePortalItem",null),u([d({clonable:!1})],t.prototype,"resourceReferences",void 0),u([d({readOnly:!0})],t.prototype,"userHasEditingPrivileges",void 0),t=u([P("esri.layers.mixins.PortalLayer")],t),t},XM={credential:null,user:null},iR=new it,oC=new WeakMap;function Cke(e){Xfe(e)&&iR.push(e)}function Rke(e){Xfe(e)&&iR.includes(e)&&iR.remove(e)}function Xfe(e){return e&&typeof e=="object"&&"refreshInterval"in e&&"refresh"in e}function Yfe(e,t){return Number.isFinite(e)&&Number.isFinite(t)?t<=0?e:Yfe(t,e%t):0}let AU=0,YM=0;function Oke(){const e=Date.now();for(const i of iR)if(i.refreshInterval){var t;e-((t=oC.get(i))!=null?t:0)+5>=6e4*i.refreshInterval&&(oC.set(i,e),i.refresh(e))}}sae(()=>{const e=Date.now();let t=0;for(const i of iR)t=Yfe(Math.round(6e4*i.refreshInterval),t),i.refreshInterval?oC.get(i)||oC.set(i,e):oC.delete(i);if(t!==YM){if(YM=t,clearInterval(AU),YM===0)return void(AU=0);AU=setInterval(Oke,YM)}});function Mke(e){return e&&typeof e=="object"&&"refreshTimestamp"in e&&"refresh"in e}const Pke=e=>{let t=class extends e{constructor(...i){super(...i),this.refreshInterval=0,this.refreshTimestamp=0,this._debounceHasDataChanged=w7(()=>this.hasDataChanged()),this.when().then(()=>{Cke(this)},()=>{})}destroy(){Rke(this)}get refreshParameters(){return{_ts:this.refreshTimestamp||null}}refresh(i=Date.now()){l6(this._debounceHasDataChanged()).then(r=>{r&&this._set("refreshTimestamp",i),this.emit("refresh",{dataChanged:r})},r=>{he.getLogger(this.declaredClass).error(r),this.emit("refresh",{dataChanged:!1,error:r})})}async hasDataChanged(){return!0}};return u([d({type:Number,cast:i=>i>=.1?i:i<=0?0:.1,json:{write:!0}})],t.prototype,"refreshInterval",void 0),u([d({readOnly:!0})],t.prototype,"refreshTimestamp",void 0),u([d()],t.prototype,"refreshParameters",null),t=u([P("esri.layers.mixins.RefreshableLayer")],t),t},Ike=e=>{let t=class extends e{constructor(){super(...arguments),this.minScale=0,this.maxScale=0}get effectiveScaleRange(){const i={minScale:this.minScale,maxScale:this.maxScale},r=this.parent;r&&"effectiveScaleRange"in r&&$ke(i,r.effectiveScaleRange);const s=this._get("effectiveScaleRange");return s&&s.minScale===i.minScale&&s.maxScale===i.maxScale?s:i}};return u([d({type:Number,nonNullable:!0,json:{write:!0}})],t.prototype,"minScale",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0}})],t.prototype,"maxScale",void 0),u([d({readOnly:!0})],t.prototype,"effectiveScaleRange",null),t=u([P("esri.layers.mixins.ScaleRangeLayer")],t),t};function $ke(e,t){return e.minScale=e.minScale>0?t.minScale>0?Math.min(e.minScale,t.minScale):e.minScale:t.minScale,e.maxScale=e.maxScale>0?t.maxScale>0?Math.max(e.maxScale,t.maxScale):e.maxScale:t.maxScale,e}const Y_=_o()({esriTimeUnitsMilliseconds:"milliseconds",esriTimeUnitsSeconds:"seconds",esriTimeUnitsMinutes:"minutes",esriTimeUnitsHours:"hours",esriTimeUnitsDays:"days",esriTimeUnitsWeeks:"weeks",esriTimeUnitsMonths:"months",esriTimeUnitsYears:"years",esriTimeUnitsDecades:"decades",esriTimeUnitsCenturies:"centuries",esriTimeUnitsUnknown:void 0});var K8;let cA=K8=class extends fe{constructor(e){super(e),this.value=0,this.unit="milliseconds"}toMilliseconds(){return W$e(this.value,this.unit,"milliseconds")}clone(){return new K8({value:this.value,unit:this.unit})}};u([d({type:Number,json:{write:!0},nonNullable:!0})],cA.prototype,"value",void 0),u([d({type:Y_.apiValues,json:{type:Y_.jsonValues,read:Y_.read,write:Y_.write},nonNullable:!0})],cA.prototype,"unit",void 0),cA=K8=u([P("esri.TimeInterval")],cA);const rR=cA;var e9;let Gw=e9=class extends fe{constructor(e){super(e),this.respectsDaylightSaving=!1,this.timezone=null}readRespectsDaylightSaving(e,t){return t.respectsDaylightSaving!==void 0?t.respectsDaylightSaving:t.respectDaylightSaving!==void 0&&t.respectDaylightSaving}clone(){const{respectsDaylightSaving:e,timezone:t}=this;return new e9({respectsDaylightSaving:e,timezone:t})}};u([d({type:Boolean,json:{write:!0}})],Gw.prototype,"respectsDaylightSaving",void 0),u([De("respectsDaylightSaving",["respectsDaylightSaving","respectDaylightSaving"])],Gw.prototype,"readRespectsDaylightSaving",null),u([d({type:String,json:{read:{source:"timeZone"},write:{target:"timeZone"}}})],Gw.prototype,"timezone",void 0),Gw=e9=u([P("esri.layers.support.TimeReference")],Gw);const Dke=Gw;var t9;let Ro=t9=class extends fe{constructor(e){super(e),this.cumulative=!1,this.endField=null,this.fullTimeExtent=null,this.hasLiveData=!1,this.interval=null,this.startField=null,this.timeReference=null,this.trackIdField=null,this.useTime=!0}readFullTimeExtent(e,t){if(!t.timeExtent||!Array.isArray(t.timeExtent)||t.timeExtent.length!==2)return null;const i=new Date(t.timeExtent[0]),r=new Date(t.timeExtent[1]);return new zp({start:i,end:r})}writeFullTimeExtent(e,t){e&&_(e.start)&&_(e.end)?t.timeExtent=[e.start.getTime(),e.end.getTime()]:t.timeExtent=null}readInterval(e,t){return t.timeInterval&&t.timeIntervalUnits?new rR({value:t.timeInterval,unit:Y_.fromJSON(t.timeIntervalUnits)}):t.defaultTimeInterval&&t.defaultTimeIntervalUnits?new rR({value:t.defaultTimeInterval,unit:Y_.fromJSON(t.defaultTimeIntervalUnits)}):null}writeInterval(e,t){if(e){const i=e.toJSON();t.timeInterval=i.value,t.timeIntervalUnits=i.unit}else t.timeInterval=null,t.timeIntervalUnits=null}clone(){const{cumulative:e,endField:t,hasLiveData:i,interval:r,startField:s,timeReference:n,fullTimeExtent:o,trackIdField:a,useTime:l}=this;return new t9({cumulative:e,endField:t,hasLiveData:i,interval:r,startField:s,timeReference:se(n),fullTimeExtent:se(o),trackIdField:a,useTime:l})}};u([d({type:Boolean,json:{read:{source:"exportOptions.timeDataCumulative"},write:{target:"exportOptions.timeDataCumulative"}}})],Ro.prototype,"cumulative",void 0),u([d({type:String,json:{read:{source:"endTimeField"},write:{target:"endTimeField",allowNull:!0}}})],Ro.prototype,"endField",void 0),u([d({type:zp,json:{write:{enabled:!0,allowNull:!0}}})],Ro.prototype,"fullTimeExtent",void 0),u([De("fullTimeExtent",["timeExtent"])],Ro.prototype,"readFullTimeExtent",null),u([Fe("fullTimeExtent")],Ro.prototype,"writeFullTimeExtent",null),u([d({type:Boolean,json:{write:!0}})],Ro.prototype,"hasLiveData",void 0),u([d({type:rR,json:{write:{enabled:!0,allowNull:!0}}})],Ro.prototype,"interval",void 0),u([De("interval",["timeInterval","timeIntervalUnits","defaultTimeInterval","defaultTimeIntervalUnits"])],Ro.prototype,"readInterval",null),u([Fe("interval")],Ro.prototype,"writeInterval",null),u([d({type:String,json:{read:{source:"startTimeField"},write:{target:"startTimeField",allowNull:!0}}})],Ro.prototype,"startField",void 0),u([d({type:Dke,json:{write:{enabled:!0,allowNull:!0}}})],Ro.prototype,"timeReference",void 0),u([d({type:String,json:{write:{enabled:!0,allowNull:!0}}})],Ro.prototype,"trackIdField",void 0),u([d({type:Boolean,json:{read:{source:"exportOptions.useTime"},write:{target:"exportOptions.useTime"}}})],Ro.prototype,"useTime",void 0),Ro=t9=u([P("esri.layers.support.TimeInfo")],Ro);const Zfe=Ro,Lke=e=>{let t=class extends e{constructor(){super(...arguments),this.timeExtent=null,this.timeOffset=null,this.useViewTime=!0}readOffset(i,r){const s=r.timeInfo.exportOptions;if(!s)return null;const n=s.timeOffset,o=Y_.fromJSON(s.timeOffsetUnits);return n&&o?new rR({value:n,unit:o}):null}set timeInfo(i){ele(i,this.fieldsIndex),this._set("timeInfo",i)}};return u([d({type:zp,json:{write:!1}})],t.prototype,"timeExtent",void 0),u([d({type:rR})],t.prototype,"timeOffset",void 0),u([De("service","timeOffset",["timeInfo.exportOptions"])],t.prototype,"readOffset",null),u([d({value:null,type:Zfe,json:{write:!0,origins:{"web-document":{read:!1,write:!1}}}})],t.prototype,"timeInfo",null),u([d({type:Boolean,json:{read:{source:"timeAnimation"},write:{target:"timeAnimation"},origins:{"web-scene":{read:!1,write:!1}}}})],t.prototype,"useViewTime",void 0),t=u([P("esri.layers.mixins.TemporalLayer")],t),t};var i9;let Wf=i9=class extends fe{constructor(e){super(e)}clone(){const{name:e,fields:t,isAscending:i,isUnique:r,description:s}=this;return new i9({name:e,fields:t,isAscending:i,isUnique:r,description:s})}};u([d({constructOnly:!0})],Wf.prototype,"name",void 0),u([d({constructOnly:!0})],Wf.prototype,"fields",void 0),u([d({constructOnly:!0})],Wf.prototype,"isAscending",void 0),u([d({constructOnly:!0})],Wf.prototype,"isUnique",void 0),u([d({constructOnly:!0})],Wf.prototype,"description",void 0),Wf=i9=u([P("esri.layers.support.FeatureIndex")],Wf);let QI=class extends fe{constructor(){super(...arguments),this.type=null}};u([d({type:["selection","cluster"],readOnly:!0,json:{read:!1,write:!0}})],QI.prototype,"type",void 0),QI=u([P("esri.layers.support.FeatureReduction")],QI);const JI=QI;var r9;let jw=r9=class extends fe{constructor(){super(...arguments),this.statisticType=null,this.onStatisticField=null,this.onStatisticValueExpression=null}clone(){return new r9({statisticType:this.statisticType,onStatisticField:this.onStatisticField,onStatisticValueExpression:this.onStatisticValueExpression})}};u([d({type:String,json:{write:!0}})],jw.prototype,"statisticType",void 0),u([d({type:String,json:{write:!0}})],jw.prototype,"onStatisticField",void 0),u([d({type:String,json:{write:!0}})],jw.prototype,"onStatisticValueExpression",void 0),jw=r9=u([P("esri.layers.support.OutStatistic")],jw);const Nke=jw;var s9;let uA=s9=class extends fe{constructor(){super(...arguments),this.name=null}clone(){return new s9({name:this.name,outStatistic:this.outStatistic.clone()})}};u([d({type:String,json:{write:!0}})],uA.prototype,"name",void 0),u([d({type:Nke,json:{write:!0}})],uA.prototype,"outStatistic",void 0),uA=s9=u([P("esri.layers.support.AggregateField")],uA);const Fke=uA,JH="__begin__",KH="__end__",Uke=new RegExp(JH,"ig"),kke=new RegExp(KH,"ig"),XJ=new RegExp("^"+JH,"i"),YJ=new RegExp(KH+"$","i"),pL='"',zke=pL+" + ",Bke=" + "+pL;function Vke(e){return e.replace(new RegExp("\\[","g"),"{").replace(new RegExp("\\]","g"),"}")}function Gke(e){return e.replace(new RegExp("\\{","g"),"[").replace(new RegExp("\\}","g"),"]")}function UF(e){const t={expression:"",type:"none"};return e.labelExpressionInfo?e.labelExpressionInfo.value?(t.expression=e.labelExpressionInfo.value,t.type="conventional"):e.labelExpressionInfo.expression&&(t.expression=e.labelExpressionInfo.expression,t.type="arcade"):e.labelExpression!=null&&(t.expression=Vke(e.labelExpression),t.type="conventional"),t}function jke(e){const t=UF(e);if(!t)return null;switch(t.type){case"conventional":return n9(t.expression);case"arcade":return t.expression}return null}function Hke(e){const t=UF(e);if(!t)return null;switch(t.type){case"conventional":return Wke(t.expression);case"arcade":return eq(t.expression)}return null}function n9(e){let t;return e?(t=_p(e,i=>JH+'$feature["'+i+'"]'+KH),t=XJ.test(t)?t.replace(XJ,""):pL+t,t=YJ.test(t)?t.replace(YJ,""):t+pL,t=t.replace(Uke,zke).replace(kke,Bke)):t='""',t}const qke=/^\s*\{([^}]+)\}\s*$/i;function Wke(e){const t=e.match(qke);return t&&t[1].trim()||null}const Xke=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*$/i,Yke=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])(\1|\3)(\5)\s*\));?\s*$/i,Zke=/^\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])([\w\s]+)(\1)\s*\));?\s*$/i;function eq(e){if(!e)return null;let t=Xke.exec(e)||Yke.exec(e);return t?t[1]||t[3]:(t=Zke.exec(e),t?t[2]:null)}var o9;let ty=o9=class extends fe{constructor(){super(...arguments),this.expression=null,this.title=null,this.value=null}readExpression(e,t){return t.value?n9(t.value):e}writeExpression(e,t,i){this.value!=null&&(e=n9(this.value)),e!=null&&(t[i]=e)}clone(){return new o9({expression:this.expression,title:this.title,value:this.value})}};u([d({type:String,json:{write:{writerEnsuresNonNull:!0}}})],ty.prototype,"expression",void 0),u([De("expression",["expression","value"])],ty.prototype,"readExpression",null),u([Fe("expression")],ty.prototype,"writeExpression",null),u([d({type:String,json:{write:!0,origins:{"web-scene":{write:!1}}}})],ty.prototype,"title",void 0),u([d({json:{read:!1,write:!1}})],ty.prototype,"value",void 0),ty=o9=u([P("esri.layers.support.LabelExpressionInfo")],ty);const Qfe=ty,Jfe=[252,146,31,255],Kgt=[153,153,153,255],Qke={type:"esriSMS",style:"esriSMSCircle",size:6,color:Jfe,outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[153,153,153,255]}},Jke={type:"esriSLS",style:"esriSLSSolid",width:.75,color:Jfe},Kke={type:"esriSFS",style:"esriSFSSolid",color:[252,146,31,196],outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[255,255,255,191]}},eze={type:"esriTS",color:[255,255,255,255],font:{family:"arial-unicode-ms",size:10,weight:"bold"},horizontalAlignment:"center",kerning:!0,haloColor:[0,0,0,255],haloSize:1,rotated:!1,text:"",xoffset:0,yoffset:0,angle:0},tze={type:"esriSMS",style:"esriSMSCircle",color:[0,0,0,255],outline:null,size:10.5},ize={type:"esriSLS",style:"esriSLSSolid",color:[0,0,0,255],width:1.5},rze={type:"esriSFS",style:"esriSFSSolid",color:[0,0,0,255],outline:null},eyt=VS.fromJSON(Qke),tyt=sd.fromJSON(Jke),iyt=ub.fromJSON(Kke),sze=GS.fromJSON(eze);VS.fromJSON(tze);sd.fromJSON(ize);ub.fromJSON(rze);var a9;const ZM=new si({esriServerPointLabelPlacementAboveCenter:"above-center",esriServerPointLabelPlacementAboveLeft:"above-left",esriServerPointLabelPlacementAboveRight:"above-right",esriServerPointLabelPlacementBelowCenter:"below-center",esriServerPointLabelPlacementBelowLeft:"below-left",esriServerPointLabelPlacementBelowRight:"below-right",esriServerPointLabelPlacementCenterCenter:"center-center",esriServerPointLabelPlacementCenterLeft:"center-left",esriServerPointLabelPlacementCenterRight:"center-right",esriServerLinePlacementAboveAfter:"above-after",esriServerLinePlacementAboveAlong:"above-along",esriServerLinePlacementAboveBefore:"above-before",esriServerLinePlacementAboveStart:"above-start",esriServerLinePlacementAboveEnd:"above-end",esriServerLinePlacementBelowAfter:"below-after",esriServerLinePlacementBelowAlong:"below-along",esriServerLinePlacementBelowBefore:"below-before",esriServerLinePlacementBelowStart:"below-start",esriServerLinePlacementBelowEnd:"below-end",esriServerLinePlacementCenterAfter:"center-after",esriServerLinePlacementCenterAlong:"center-along",esriServerLinePlacementCenterBefore:"center-before",esriServerLinePlacementCenterStart:"center-start",esriServerLinePlacementCenterEnd:"center-end",esriServerPolygonPlacementAlwaysHorizontal:"always-horizontal"},{ignoreUnknown:!0});function Kfe(e){return!e||e.origin!=="service"&&!eme(e.layer)}function eme(e){return(e==null?void 0:e.type)==="map-image"}function tme(e){var t,i;return!!eme(e)&&!((t=e.capabilities)==null||(i=t.exportMap)==null||!i.supportsArcadeExpressionForLabeling)}function nze(e){return Kfe(e)||tme(e.layer)}let fs=a9=class extends fe{constructor(e){super(e),this.type="label",this.name=null,this.allowOverrun=!1,this.deconflictionStrategy="static",this.labelExpression=null,this.labelExpressionInfo=null,this.labelPlacement=null,this.labelPosition="curved",this.maxScale=0,this.minScale=0,this.repeatLabel=!0,this.repeatLabelDistance=null,this.symbol=sze,this.useCodedValues=void 0,this.where=null}static evaluateWhere(e,t){const i=function(r,s,n){switch(s){case"=":return r==n;case"<>":return r!=n;case">":return r>n;case">=":return r>=n;case"<":return r<n;case"<=":return r<=n}return!1};try{if(e==null)return!0;const r=e.split(" ");if(r.length===3)return i(t[r[0]],r[1],r[2]);if(r.length===7){const s=i(t[r[0]],r[1],r[2]),n=r[3],o=i(t[r[4]],r[5],r[6]);switch(n){case"AND":return s&&o;case"OR":return s||o}}return!1}catch{console.log("Error.: can't parse = "+e)}}readLabelExpression(e,t){const i=t.labelExpressionInfo;if(!i||!i.value&&!i.expression)return e}writeLabelExpression(e,t,i){if(this.labelExpressionInfo){if(this.labelExpressionInfo.value!=null)e=Gke(this.labelExpressionInfo.value);else if(this.labelExpressionInfo.expression!=null){const r=eq(this.labelExpressionInfo.expression);r&&(e="["+r+"]")}}e!=null&&(t[i]=e)}writeLabelExpressionInfo(e,t,i,r){if(e==null&&this.labelExpression!=null&&Kfe(r))e=new Qfe({expression:this.getLabelExpressionArcade()});else if(!e)return;const s=e.toJSON(r);s.expression&&(t[i]=s)}writeMaxScale(e,t){(e||this.minScale)&&(t.maxScale=e)}writeMinScale(e,t){(e||this.maxScale)&&(t.minScale=e)}getLabelExpression(){return UF(this)}getLabelExpressionArcade(){return jke(this)}getLabelExpressionSingleField(){return Hke(this)}hash(){return JSON.stringify(this)}clone(){return new a9({allowOverrun:this.allowOverrun,deconflictionStrategy:this.deconflictionStrategy,labelExpression:this.labelExpression,labelExpressionInfo:se(this.labelExpressionInfo),labelPosition:this.labelPosition,labelPlacement:this.labelPlacement,maxScale:this.maxScale,minScale:this.minScale,name:this.name,repeatLabel:this.repeatLabel,repeatLabelDistance:this.repeatLabelDistance,symbol:se(this.symbol),where:this.where,useCodedValues:this.useCodedValues})}};u([d({type:String,json:{write:!0}})],fs.prototype,"name",void 0),u([d({type:Boolean,json:{write:!0,default:!1,origins:{"web-scene":{write:!1}}}})],fs.prototype,"allowOverrun",void 0),u([d({type:String,json:{write:!0,default:"static",origins:{"web-scene":{write:!1}}}})],fs.prototype,"deconflictionStrategy",void 0),u([d({type:String,json:{write:{overridePolicy(e,t,i){return this.labelExpressionInfo&&(i==null?void 0:i.origin)==="service"&&tme(i.layer)?{enabled:!1}:{allowNull:!0}}}}})],fs.prototype,"labelExpression",void 0),u([De("labelExpression")],fs.prototype,"readLabelExpression",null),u([Fe("labelExpression")],fs.prototype,"writeLabelExpression",null),u([d({type:Qfe,json:{write:{overridePolicy:(e,t,i)=>nze(i)?{allowNull:!0}:{enabled:!1}}}})],fs.prototype,"labelExpressionInfo",void 0),u([Fe("labelExpressionInfo")],fs.prototype,"writeLabelExpressionInfo",null),u([d({type:ZM.apiValues,json:{type:ZM.jsonValues,read:ZM.read,write:ZM.write}})],fs.prototype,"labelPlacement",void 0),u([d({type:["curved","parallel"],json:{write:!0,origins:{"web-map":{write:!1},"web-scene":{write:!1},"portal-item":{write:!1}}}})],fs.prototype,"labelPosition",void 0),u([d({type:Number})],fs.prototype,"maxScale",void 0),u([Fe("maxScale")],fs.prototype,"writeMaxScale",null),u([d({type:Number})],fs.prototype,"minScale",void 0),u([Fe("minScale")],fs.prototype,"writeMinScale",null),u([d({type:Boolean,json:{write:!0,origins:{"web-scene":{write:!1},"portal-item":{write:!1}}}})],fs.prototype,"repeatLabel",void 0),u([d({type:Number,cast:Vi,json:{write:!0,origins:{"web-scene":{write:!1}}}})],fs.prototype,"repeatLabelDistance",void 0),u([d({types:zCe,json:{origins:{"web-scene":{types:BCe,write:CJ,default:null}},write:CJ,default:null}})],fs.prototype,"symbol",void 0),u([d({type:Boolean,json:{write:!0}})],fs.prototype,"useCodedValues",void 0),u([d({type:String,json:{write:!0}})],fs.prototype,"where",void 0),fs=a9=u([P("esri.layers.support.LabelClass")],fs);const tq=fs;var l9;let kl=l9=class extends fe{constructor(e){super(e),this.type="cluster",this.clusterRadius=Vi("80px"),this.clusterMinSize=Vi("12px"),this.clusterMaxSize=Vi("50px"),this.popupEnabled=!0,this.popupTemplate=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=null}clone(){return new l9({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:se(this.labelingInfo),labelsVisible:this.labelsVisible,fields:se(this.fields),popupEnabled:this.popupEnabled,popupTemplate:se(this.popupTemplate)})}};u([d({type:["cluster"],readOnly:!0,json:{write:!0}})],kl.prototype,"type",void 0),u([d({type:Number,cast:e=>e==="auto"?e:Vi(e),json:{write:!0}})],kl.prototype,"clusterRadius",void 0),u([d({type:Number,cast:Vi,json:{write:!0}})],kl.prototype,"clusterMinSize",void 0),u([d({type:Number,cast:Vi,json:{write:!0}})],kl.prototype,"clusterMaxSize",void 0),u([d(jfe)],kl.prototype,"popupEnabled",void 0),u([d({type:kN,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],kl.prototype,"popupTemplate",void 0),u([d({types:UCe})],kl.prototype,"symbol",void 0),u([d({type:[tq],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],kl.prototype,"labelingInfo",void 0),u([d(Hfe)],kl.prototype,"labelsVisible",void 0),u([d({type:[Fke],json:{write:!0,origins:{"web-document":{write:!1},"portal-item":{write:!1}}}})],kl.prototype,"fields",void 0),kl=l9=u([P("esri.layers.support.FeatureReductionCluster")],kl);const ZJ=kl;var c9;let KI=c9=class extends JI{constructor(e){super(e),this.type="selection"}clone(){return new c9}};u([d({type:["selection"]})],KI.prototype,"type",void 0),KI=c9=u([P("esri.layers.support.FeatureReductionSelection")],KI);const QJ=KI,oze={types:{key:"type",base:JI,typeMap:{selection:QJ,cluster:ZJ}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:{key:"type",base:JI,typeMap:{selection:ZJ}}},"web-scene":{types:{key:"type",base:JI,typeMap:{selection:QJ}}}}}},JJ=new si({esriFeatureEditToolAutoCompletePolygon:"auto-complete-polygon",esriFeatureEditToolCircle:"circle",esriFeatureEditToolEllipse:"ellipse",esriFeatureEditToolFreehand:"freehand",esriFeatureEditToolLine:"line",esriFeatureEditToolNone:"none",esriFeatureEditToolPoint:"point",esriFeatureEditToolPolygon:"polygon",esriFeatureEditToolRectangle:"rectangle",esriFeatureEditToolArrow:"arrow",esriFeatureEditToolTriangle:"triangle",esriFeatureEditToolLeftArrow:"left-arrow",esriFeatureEditToolRightArrow:"right-arrow",esriFeatureEditToolUpArrow:"up-arrow",esriFeatureEditToolDownArrow:"down-arrow"});let iy=class extends Dp(fe){constructor(e){super(e),this.name=null,this.description=null,this.drawingTool=null,this.prototype=null,this.thumbnail=null}};u([d({json:{write:!0}})],iy.prototype,"name",void 0),u([d({json:{write:!0}})],iy.prototype,"description",void 0),u([d({json:{read:JJ.read,write:JJ.write}})],iy.prototype,"drawingTool",void 0),u([d({json:{write:!0}})],iy.prototype,"prototype",void 0),u([d({json:{write:!0}})],iy.prototype,"thumbnail",void 0),iy=u([P("esri.layers.support.FeatureTemplate")],iy);const iq=iy;let Mf=class extends Dp(fe){constructor(e){super(e),this.id=null,this.name=null,this.domains=null,this.templates=null}readDomains(e){const t={};for(const i of Object.keys(e))t[i]=dH(e[i]);return t}writeDomains(e,t){const i={};for(const s of Object.keys(e)){var r;e[s]&&(i[s]=(r=e[s])==null?void 0:r.toJSON())}t.domains=i}};u([d({json:{write:!0}})],Mf.prototype,"id",void 0),u([d({json:{write:!0}})],Mf.prototype,"name",void 0),u([d({json:{write:!0}})],Mf.prototype,"domains",void 0),u([De("domains")],Mf.prototype,"readDomains",null),u([Fe("domains")],Mf.prototype,"writeDomains",null),u([d({type:[iq],json:{write:!0}})],Mf.prototype,"templates",void 0),Mf=u([P("esri.layers.support.FeatureType")],Mf);const ime=Mf;function aze(e){return e.type==="date"||e.type==="esriFieldTypeDate"}function KJ(e){return e.type==="oid"||e.type==="esriFieldTypeOID"}function eK(e){return e.type==="global-id"||e.type==="esriFieldTypeGlobalID"}class lze{constructor(t){if(this.fields=t,this._fieldsMap=new Map,this._dateFieldsSet=new Set,this._numericFieldsSet=new Set,this.dateFields=[],this.numericFields=[],this._requiredFields=null,!t)return;const i=[];for(const r of t){const s=r&&r.name;if(s){const n=tK(s);this._fieldsMap.set(s,r),this._fieldsMap.set(n,r),i.push(n),aze(r)?(this.dateFields.push(r),this._dateFieldsSet.add(r)):DN(r)&&(this._numericFieldsSet.add(r),this.numericFields.push(r)),KJ(r)||eK(r)||(r.editable=r.editable==null||!!r.editable,r.nullable=r.nullable==null||!!r.nullable)}}i.sort(),this.uid=i.join(",")}destroy(){this._fieldsMap.clear()}get requiredFields(){if(!this._requiredFields){this._requiredFields=[];for(const t of this.fields)KJ(t)||eK(t)||t.nullable||X2e(t)!==void 0||this._requiredFields.push(t)}return this._requiredFields}has(t){return this.get(t)!=null}get(t){return t!=null?this._fieldsMap.get(t)||this._fieldsMap.get(tK(t)):void 0}isDateField(t){return this._dateFieldsSet.has(this.get(t))}isNumericField(t){return this._numericFieldsSet.has(this.get(t))}normalizeFieldName(t){const i=this.get(t);if(i)return i.name}}function tK(e){return e.toLowerCase().trim()}const cze=he.getLogger("esri.layers.support.fieldProperties");function uze(){return{fields:{type:[gO],value:null},fieldsIndex:{readOnly:!0,get(){return new lze(this.fields||[])}},outFields:{type:[String],json:{read:!1},set:function(e){this._userOutFields=e,this.notifyChange("outFields")},get:function(){const e=this._userOutFields;if(!e||!e.length)return null;if(e.includes("*"))return["*"];if(!this.fields)return e;for(const t of e)this.fieldsIndex.has(t)||cze.error("field-attributes-layer:invalid-field",`Invalid field ${t} found in outFields`,{layer:this,outFields:e});return tle(this.fieldsIndex,e)}}}}let Hw=class extends Dp(fe){constructor(e){super(e),this.shapeAreaField=null,this.shapeLengthField=null,this.units=null}};u([d({type:String,json:{read:{source:"shapeAreaFieldName"}}})],Hw.prototype,"shapeAreaField",void 0),u([d({type:String,json:{read:{source:"shapeLengthFieldName"}}})],Hw.prototype,"shapeLengthField",void 0),u([d({type:String,json:{read:e=>qRe.read(e)||WRe.read(e)}})],Hw.prototype,"units",void 0),Hw=u([P("esri.layers.support.GeometryFieldsInfo")],Hw);const hze=Hw,dze=/\[([^\[\]]+)\]/gi;function iK(e,t,i){return e?e.map(r=>{const s=new tq;if(s.read(r,i),s.labelExpression){const n=t.fields||t.layerDefinition&&t.layerDefinition.fields||this.fields;s.labelExpression=s.labelExpression.replace(dze,(o,a)=>`[${pze(a,n)}]`)}return s}):null}function pze(e,t){if(!t)return e;const i=e.toLowerCase();for(let r=0;r<t.length;r++){const s=t[r].name;if(s.toLowerCase()===i)return s}return e}var u9;let qw=u9=class extends fe{constructor(e){super(e),this.floorField=null,this.viewAllMode=!1,this.viewAllLevelIds=new it}clone(){return new u9({floorField:this.floorField,viewAllMode:this.viewAllMode,viewAllLevelIds:this.viewAllLevelIds})}};u([d({type:String,json:{write:!0}})],qw.prototype,"floorField",void 0),u([d({json:{read:!1,write:!1}})],qw.prototype,"viewAllMode",void 0),u([d({json:{read:!1,write:!1}})],qw.prototype,"viewAllLevelIds",void 0),qw=u9=u([P("esri.layers.support.LayerFloorInfo")],qw);const fze=qw,rK=new si({esriRelCardinalityOneToOne:"one-to-one",esriRelCardinalityOneToMany:"one-to-many",esriRelCardinalityManyToMany:"many-to-many"}),sK=new si({esriRelRoleOrigin:"origin",esriRelRoleDestination:"destination"});let Qc=class extends Dp(fe){constructor(e){super(e),this.cardinality=null,this.composite=null,this.id=null,this.keyField=null,this.keyFieldInRelationshipTable=null,this.name=null,this.relatedTableId=null,this.relationshipTableId=null,this.role=null}};u([d({json:{read:rK.read,write:rK.write}})],Qc.prototype,"cardinality",void 0),u([d({json:{read:!0,write:!0}})],Qc.prototype,"composite",void 0),u([d({json:{read:!0,write:!0}})],Qc.prototype,"id",void 0),u([d({json:{read:!0,write:!0}})],Qc.prototype,"keyField",void 0),u([d({json:{read:!0,write:!0}})],Qc.prototype,"keyFieldInRelationshipTable",void 0),u([d({json:{read:!0,write:!0}})],Qc.prototype,"name",void 0),u([d({json:{read:!0,write:!0}})],Qc.prototype,"relatedTableId",void 0),u([d({json:{read:!0,write:!0}})],Qc.prototype,"relationshipTableId",void 0),u([d({json:{read:sK.read,write:sK.write}})],Qc.prototype,"role",void 0),Qc=u([P("esri.layers.support.Relationship")],Qc);const mze=Qc,gh=[];function gze(e,t){if(zfe(e.url))return!0;const{wkid:i}=t;for(const r of gh){if(e.version>=r[0])return!0;if(typeof r[1]=="function"&&(r[1]=r[1]()),r[1].has(i))return!1}return!0}gh.push([10.91,()=>{const e=new Set([9709,9716,9741,9761,9766]);for(let t=9712;t<=9713;t++)e.add(t);for(let t=9748;t<=9749;t++)e.add(t);for(let t=20904;t<=20932;t++)e.add(t);for(let t=21004;t<=21032;t++)e.add(t);for(let t=21207;t<=21264;t++)e.add(t);for(let t=21307;t<=21364;t++)e.add(t);for(let t=102759;t<=102760;t++)e.add(t);for(let t=102901;t<=102960;t++)e.add(t);return e}]),gh.push([10.9,()=>{const e=new Set([9300,9354,9364,9367,9373,9377,9387,9456,9473,9498,9678,9680,29874,103599,103872,104028]);for(let t=9356;t<=9360;t++)e.add(t);for(let t=9404;t<=9407;t++)e.add(t);for(let t=9476;t<=9482;t++)e.add(t);for(let t=9487;t<=9494;t++)e.add(t);for(let t=9697;t<=9699;t++)e.add(t);return e}]),gh.push([10.81,()=>{const e=new Set([9265,9333,103598,103699]);for(let t=9248;t<=9254;t++)e.add(t);for(let t=9271;t<=9273;t++)e.add(t);for(let t=9284;t<=9285;t++)e.add(t);for(let t=21453;t<=21463;t++)e.add(t);return e}]),gh.push([10.8,()=>{const e=new Set([8088,8395,8428,8433,8531,8687,8692,8694,8699,8900,9003,9006,9009,9012,9017,9191]);for(let t=8035;t<=8036;t++)e.add(t);for(let t=8455;t<=8456;t++)e.add(t);for(let t=8518;t<=8529;t++)e.add(t);for(let t=8533;t<=8536;t++)e.add(t);for(let t=8538;t<=8540;t++)e.add(t);for(let t=8677;t<=8679;t++)e.add(t);for(let t=8902;t<=8903;t++)e.add(t);for(let t=8907;t<=8910;t++)e.add(t);for(let t=8949;t<=8951;t++)e.add(t);for(let t=8972;t<=8987;t++)e.add(t);for(let t=9039;t<=9040;t++)e.add(t);for(let t=9068;t<=9069;t++)e.add(t);for(let t=9140;t<=9141;t++)e.add(t);for(let t=9148;t<=9150;t++)e.add(t);for(let t=9153;t<=9159;t++)e.add(t);for(let t=9205;t<=9218;t++)e.add(t);for(let t=9221;t<=9222;t++)e.add(t);for(let t=54098;t<=54101;t++)e.add(t);return e}]),gh.push([10.71,()=>{const e=new Set([6316]);for(let t=8351;t<=8353;t++)e.add(t);for(let t=9294;t<=9297;t++)e.add(t);for(let t=103586;t<=103594;t++)e.add(t);for(let t=103696;t<=103698;t++)e.add(t);return e}]),gh.push([10.7,()=>{const e=new Set([8387,8391,8427,8545,8682,8685,8818,31370,104022,104024,104975]);for(let t=8065;t<=8068;t++)e.add(t);for(let t=8082;t<=8083;t++)e.add(t);for(let t=8379;t<=8385;t++)e.add(t);for(let t=8836;t<=8840;t++)e.add(t);for(let t=8857;t<=8860;t++)e.add(t);for(let t=53035;t<=53037;t++)e.add(t);for(let t=54090;t<=54091;t++)e.add(t);for(let t=102498;t<=102499;t++)e.add(t);return e}]),gh.push([10.61,()=>new Set([102497])]),gh.push([10.6,()=>{const e=new Set([7803,7805,7887,8086,8232,8237,8240,8246,8249,8252,8255,9019,9391]);for(let t=7755;t<=7787;t++)e.add(t);for(let t=7791;t<=7795;t++)e.add(t);for(let t=7799;t<=7801;t++)e.add(t);for(let t=7825;t<=7831;t++)e.add(t);for(let t=7877;t<=7878;t++)e.add(t);for(let t=7882;t<=7883;t++)e.add(t);for(let t=7991;t<=7992;t++)e.add(t);for(let t=8042;t<=8043;t++)e.add(t);for(let t=8058;t<=8059;t++)e.add(t);for(let t=8311;t<=8348;t++)e.add(t);for(let t=9060;t<=9067;t++)e.add(t);for(let t=102562;t<=102568;t++)e.add(t);for(let t=102799;t<=102900;t++)e.add(t);return e}]),gh.push([10.51,()=>{const e=new Set([7683,7881,7886,7899,8888,9e3]);for(let t=8013;t<=8032;t++)e.add(t);for(let t=9053;t<=9057;t++)e.add(t);for(let t=104017;t<=104018;t++)e.add(t);for(let t=104971;t<=104974;t++)e.add(t);return e}]),gh.push([10.5,()=>{const e=new Set([6962,7035,7037,7039,7041,7084,7086,7133,7798,102399]);for(let t=4087;t<=4088;t++)e.add(t);for(let t=5896;t<=5899;t++)e.add(t);for(let t=7005;t<=7007;t++)e.add(t);for(let t=7057;t<=7070;t++)e.add(t);for(let t=7073;t<=7082;t++)e.add(t);for(let t=7109;t<=7128;t++)e.add(t);for(let t=7844;t<=7859;t++)e.add(t);return e}]);async function yze(e,t,i){const r=e&&e.getAtOrigin&&e.getAtOrigin("renderer",t.origin);if(r&&r.type==="unique-value"&&r.styleOrigin){const s=await wl(r.populateFromStyle());if(Qt(i),s.ok===!1){const n=s.error;t&&t.messages&&t.messages.push(new vc("renderer:style-reference",`Failed to create unique value renderer from style reference: ${n.message}`,{error:n,context:t})),e.clear("renderer",t.origin)}}}const vze=["oid","global-id"],_ze=["oid","global-id","guid"];function bze({displayField:e,editFieldsInfo:t,fields:i,objectIdField:r,title:s},n){if(!i)return null;const o=Aze({editFieldsInfo:t,fields:i,objectIdField:r},n);if(!o.length)return null;const a=Oze({titleBase:s,fields:i,displayField:e}),l=Rze();return new kN({title:a,content:l,fieldInfos:o})}const wze=[/^fnode_$/i,/^tnode_$/i,/^lpoly_$/i,/^rpoly_$/i,/^poly_$/i,/^subclass$/i,/^subclass_$/i,/^rings_ok$/i,/^rings_nok$/i,/shape/i,/perimeter/i,/objectid/i,/_i$/i],xze=(e,{editFieldsInfo:t,objectIdField:i,visibleFieldNames:r})=>r?r.has(e.name):!rme(e.name,t)&&(!i||e.name!==i)&&!(vze.indexOf(e.type)>-1)&&!wze.some(s=>s.test(e.name));function Tze(e,t){const i=e;return t&&(e=e.filter(r=>t.indexOf(r.type)===-1)),e===i&&(e=e.slice()),e.sort(Sze),e}function Sze(e,t){return e.type==="oid"?-1:t.type==="oid"?1:nK(e)?-1:nK(t)?1:(e.alias||e.name).toLocaleLowerCase().localeCompare((t.alias||t.name).toLocaleLowerCase())}function rme(e,t){if(!e||!t)return!1;const{creationDateField:i,creatorField:r,editDateField:s,editorField:n}=t;return[i&&i.toLowerCase(),r&&r.toLowerCase(),s&&s.toLowerCase(),n&&n.toLowerCase()].indexOf(e.toLowerCase())!==-1}function Eze(e,t){return e.editable&&_ze.indexOf(e.type)===-1&&!rme(e.name,t)}function Aze({editFieldsInfo:e,fields:t,objectIdField:i},r){return Tze(t,(r==null?void 0:r.ignoreFieldTypes)||Mze).map(s=>new cO({fieldName:s.name,isEditable:Eze(s,e),label:s.alias,format:Cze(s),visible:xze(s,{editFieldsInfo:e,objectIdField:i,visibleFieldNames:r==null?void 0:r.visibleFieldNames})}))}function Cze(e){switch(e.type){case"small-integer":case"integer":case"single":return new GA({digitSeparator:!0,places:0});case"double":return new GA({digitSeparator:!0,places:2});case"date":return new GA({dateFormat:"long-month-day-year"});default:return null}}function Rze(){return[new DT,new UC]}function Oze(e){const t=G2e(e),{titleBase:i}=e;return t?`${i}: {${t.trim()}}`:i}function nK(e){return(e.name&&e.name.toLowerCase())==="name"?!0:(e.alias&&e.alias.toLowerCase())==="name"||void 0}const Mze=["geometry","blob","raster","guid","xml"],CU=new si({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),Pze={name:"supportsName",size:"supportsSize",contentType:"supportsContentType",keywords:"supportsKeywords",exifInfo:"supportsExifInfo"},ps="FeatureLayer",oK=he.getLogger("esri.layers.FeatureLayer");function aK(e){return e&&e instanceof it}function It(e,t,i){return!!(e&&e.hasOwnProperty(t)?e[t]:i)}function QM(e,t,i){return e&&e.hasOwnProperty(t)?e[t]:i}function Ize(e){var t;const i=e==null||(t=e.supportedSpatialAggregationStatistics)==null?void 0:t.map(r=>r.toLowerCase());return{envelope:!(i==null||!i.includes("envelopeaggregate")),centroid:!(i==null||!i.includes("centroidaggregate")),convexHull:!(i==null||!i.includes("convexhullaggregate"))}}const RU=uze();function OU(e,t,i){const r=!(i==null||!i.writeLayerSchema);return{enabled:r,ignoreOrigin:r}}let Me=class extends tke(QUe(xke(Lke(Ike(Pke(fUe(vke(Ake(qH(JUe(oUe(Dp(PF))))))))))))){constructor(...e){super(...e),this._handles=new Ut,this.capabilities=null,this.charts=null,this.copyright=null,this.datesInUnknownTimezone=!1,this.displayField=null,this.definitionExpression=null,this.dynamicDataSource=null,this.editFieldsInfo=null,this.editingInfo=null,this.elevationInfo=null,this.featureReduction=null,this.fields=null,this.fieldsIndex=null,this.floorInfo=null,this.formTemplate=null,this.fullExtent=null,this.gdbVersion=null,this.geometryFieldsInfo=null,this.geometryType=null,this.hasM=void 0,this.hasZ=void 0,this.heightModelInfo=null,this.historicMoment=null,this.infoFor3D=null,this.isTable=!1,this.labelsVisible=!0,this.labelingInfo=null,this.layerId=void 0,this.legendEnabled=!0,this.minScale=0,this.maxScale=0,this.globalIdField=null,this.objectIdField=null,this.outFields=null,this.path=null,this.popupEnabled=!0,this.popupTemplate=null,this.relationships=null,this.sourceJSON=null,this.returnM=void 0,this.returnZ=void 0,this.screenSizePerspectiveEnabled=!0,this.serviceDefinitionExpression=null,this.spatialReference=He.WGS84,this.subtypeCode=null,this.templates=null,this.timeInfo=null,this.title=null,this.sublayerTitleMode="item-title",this.trackIdField=null,this.type="feature",this.typeIdField=null,this.types=null,this.indexes=new(it.ofType(Wf)),this.userIsAdmin=!1,this.version=void 0,this.visible=!0}destroy(){var e;(e=this.source)==null||e.destroy(),this._handles=rt(this._handles)}normalizeCtorArgs(e,t){return typeof e=="string"?I({url:e},t):e}load(e){const t=_(e)?e.signal:null;if(this.portalItem&&this.portalItem.loaded&&this.source)return void this.addResolvingPromise(this.createGraphicsSource(t).then(r=>this._initLayerProperties(r)));const i=this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection"]},e).catch(zm).then(async()=>{if(this.url&&this.layerId==null&&/FeatureServer|MapServer\/*$/i.test(this.url)){const r=await this._fetchFirstLayerId(t);r!=null&&(this.layerId=r)}if(!this.url&&!this._hasMemorySource())throw new q("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return this._initLayerProperties(await this.createGraphicsSource(t))}).then(()=>this.finishLoadEditablePortalLayer(e));return this.addResolvingPromise(i),Promise.resolve(this)}readCapabilities(e,t){return t=t.layerDefinition||t,{attachment:this._readAttachmentCapabilities(t.attachmentProperties),data:this._readDataCapabilities(t),metadata:this._readMetadataCapabilities(t),operations:this._readOperationsCapabilities(t.capabilities||e,t),query:this._readQueryCapabilities(t),queryRelated:this._readQueryRelatedCapabilities(t),editing:this._readEditingCapabilities(t)}}get createQueryVersion(){return this.commitProperty("definitionExpression"),this.commitProperty("dynamicDataSource"),this.commitProperty("timeExtent"),this.commitProperty("timeOffset"),this.commitProperty("geometryType"),this.commitProperty("gdbVersion"),this.commitProperty("historicMoment"),this.commitProperty("returnZ"),this.commitProperty("capabilities"),this.commitProperty("returnM"),(this._get("createQueryVersion")||0)+1}get editingEnabled(){return!(this.loaded&&!this.capabilities.operations.supportsEditing)&&(this._isOverridden("editingEnabled")?this._get("editingEnabled"):this._hasMemorySource()||this.userHasEditingPrivileges)}set editingEnabled(e){e!=null?this._override("editingEnabled",e):this._clearOverride("editingEnabled")}readEditingEnabled(e,t){return this._readEditingEnabled(t,!1)}readEditingEnabledFromWebMap(e,t,i){return this._readEditingEnabled(t,!0,i)}writeEditingEnabled(e,t){this._writeEditingEnabled(e,t,!1)}writeEditingEnabledToWebMap(e,t,i,r){this._writeEditingEnabled(e,t,!0,r)}readEditingInfo(e,t){const{editingInfo:i}=t;return i?{lastEditDate:i.lastEditDate!=null?new Date(i.lastEditDate):null}:null}readIsTable(e,t){return(t=t&&t.layerDefinition||t).type==="Table"||!t.geometryType}writeIsTable(e,t,i,r){r!=null&&r.writeLayerSchema&&yc(i,e?"Table":"Feature Layer",t)}readMinScale(e,t){return t.effectiveMinScale||e||0}readMaxScale(e,t){return t.effectiveMaxScale||e||0}readGlobalIdFieldFromService(e,t){if((t=t.layerDefinition||t).globalIdField)return t.globalIdField;if(t.fields){for(const i of t.fields)if(i.type==="esriFieldTypeGlobalID")return i.name}}readObjectIdFieldFromService(e,t){if((t=t.layerDefinition||t).objectIdField)return t.objectIdField;if(t.fields){for(const i of t.fields)if(i.type==="esriFieldTypeOID")return i.name}}get parsedUrl(){const e=this.url?Ts(this.url):null;return e!=null&&(this.dynamicDataSource!=null?e.path=bl(e.path,"dynamicLayer"):this.layerId!=null&&(e.path=bl(e.path,this.layerId.toString()))),e}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){xY(e,this.fieldsIndex),this._set("renderer",e)}readRenderer(e,t,i){const r=(t=t.layerDefinition||t).drawingInfo&&t.drawingInfo.renderer||void 0;if(r){const s=z5e(r,t,i)||void 0;return s||oK.error("Failed to create renderer",{rendererDefinition:t.drawingInfo.renderer,layer:this,context:i}),s}if(t.defaultSymbol)return t.types&&t.types.length?new jH({defaultSymbol:MU(t.defaultSymbol,t,i),field:t.typeIdField,uniqueValueInfos:t.types.map(s=>({id:s.id,symbol:MU(s.symbol,s,i)}))}):new GH({symbol:MU(t.defaultSymbol,t,i)})}set source(e){const t=this._get("source");t!==e&&(aK(t)&&this._resetMemorySource(t),aK(e)&&this._initMemorySource(e),this._set("source",e))}castSource(e){return e?Array.isArray(e)||e instanceof it?new BJ({layer:this,items:e}):e:null}readSource(e,t){const i=mb.fromJSON(t.featureSet);return new BJ({layer:this,items:i&&i.features||[]})}readServiceDefinitionExpression(e,t){return t.definitionQuery||t.definitionExpression}readTemplates(e,t){const i=t.editFieldsInfo,r=i&&i.creatorField,s=i&&i.editorField;return e=e&&e.map(n=>iq.fromJSON(n)),this._fixTemplates(e,r),this._fixTemplates(e,s),e}readTitle(e,t){const i=t.layerDefinition&&t.layerDefinition.name||t.name,r=t.title||t.layerDefinition&&t.layerDefinition.title;if(i){const s=this.portalItem&&this.portalItem.title;if(this.sublayerTitleMode==="item-title")return this.url?uUe(this.url,i):i;let n=i;if(!n&&this.url){const o=SO(this.url);_(o)&&(n=o.title)}return n?(this.sublayerTitleMode==="item-title-and-service-name"&&s&&s!==n&&(n=s+" - "+n),XH(n)):void 0}if(this.sublayerTitleMode==="item-title"&&r)return r}readTitleFromWebMap(e,t){return t.title||t.layerDefinition&&t.layerDefinition.name}readTypeIdField(e,t){let i=(t=t.layerDefinition||t).typeIdField;if(i&&t.fields){i=i.toLowerCase();const r=t.fields.find(s=>s.name.toLowerCase()===i);r&&(i=r.name)}return i}readTypes(e,t){e=(t=t.layerDefinition||t).types;const i=t.editFieldsInfo,r=i&&i.creatorField,s=i&&i.editorField;return e&&e.map(n=>(n=ime.fromJSON(n),this._fixTemplates(n.templates,r),this._fixTemplates(n.templates,s),n))}set url(e){const t=dUe({layer:this,url:e,nonStandardUrlAllowed:!0,logger:oK});this._set("url",t.url),t.layerId!=null&&this._set("layerId",t.layerId)}writeUrl(e,t,i,r){pUe(this,e,null,t,r)}readVersion(e,t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}readVisible(e,t){return t.layerDefinition&&t.layerDefinition.defaultVisibility!=null?!!t.layerDefinition.defaultVisibility:t.visibility!=null?!!t.visibility:void 0}addAttachment(e,t){return this.load().then(()=>this._checkAttachmentSupport(e)).then(()=>{if(!("addAttachment"in this.source))throw new q(ps,"Layer source does not support addAttachment capability");return this.source.addAttachment(e,t)})}updateAttachment(e,t,i){return this.load().then(()=>this._checkAttachmentSupport(e)).then(()=>{if(!("updateAttachment"in this.source))throw new q(ps,"Layer source does not support updateAttachment capability");return this.source.updateAttachment(e,t,i)})}async applyEdits(e,t){const i=await import("./editingSupport.e8bace0a.js");return await this.load(),i.applyEdits(this,this.source,e,t)}on(e,t){return super.on(e,t)}createPopupTemplate(e){return bze(this,e)}async createGraphicsSource(e){if(this._hasMemorySource())return this.source.load({signal:e});const{default:t}=await zoe(import("./FeatureLayerSource.ea5b3547.js"),e);return new t({layer:this}).load({signal:e})}createQuery(){const e=new va,t=this.get("capabilities.data"),i=this.get("capabilities.query");e.dynamicDataSource=this.dynamicDataSource,e.historicMoment=this.historicMoment,e.gdbVersion=this.gdbVersion,e.returnGeometry=!0,i&&(e.compactGeometryEnabled=i.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=i.supportsDefaultSpatialReference),t&&(t.supportsZ&&this.returnZ!=null&&(e.returnZ=this.returnZ),t.supportsM&&this.returnM!=null&&(e.returnM=this.returnM)),e.outFields=["*"],e.where=this.definitionExpression||"1=1";const{timeOffset:r,timeExtent:s}=this;return e.timeExtent=r!=null&&s!=null?s.offset(-r.value,r.unit):s||null,e.multipatchOption=this.geometryType==="multipatch"?"xyFootprint":null,e}deleteAttachments(e,t){return this.load().then(()=>this._checkAttachmentSupport(e)).then(()=>{if(!("deleteAttachments"in this.source))throw new q(ps,"Layer source does not support deleteAttachments capability");return this.source.deleteAttachments(e,t)})}fetchRecomputedExtents(e){return this.load({signal:e==null?void 0:e.signal}).then(()=>{if(this.source.fetchRecomputedExtents)return this.source.fetchRecomputedExtents(e);throw new q(ps,"Layer source does not support fetchUpdates capability")})}getFeatureType(e){const{typeIdField:t,types:i}=this;if(!t||!e)return null;const r=e.attributes?e.attributes[t]:void 0;if(r==null)return null;let s=null;return i.some(n=>{const{id:o}=n;return o!=null&&(o.toString()===r.toString()&&(s=n),!!s)}),s}getFieldDomain(e,t){const i=t&&t.feature,r=this.getFeatureType(i);if(r){const s=r.domains&&r.domains[e];if(s&&s.type!=="inherited")return s}return this._getLayerDomain(e)}getField(e){return this.fieldsIndex.get(e)}queryAttachments(e,t){return e=JD.from(e),this.load().then(()=>{if(!this.get("capabilities.data.supportsAttachment"))throw new q(ps,"this layer doesn't support attachments");const{attachmentTypes:i,objectIds:r,globalIds:s,num:n,size:o,start:a,where:l}=e;if(!this.get("capabilities.operations.supportsQueryAttachments")){const c=r&&r.length>1,h=i&&i.length,p=s&&s.length,f=o&&o.length;if(c||h||p||f||n||a||l)throw new q(ps,"when 'supportsQueryAttachments' is false, only objectIds of length 1 are supported",e)}if(!(r&&r.length||l))throw new q(ps,"'objectIds' or 'where' are required to perform attachment query",e);if(!("queryAttachments"in this.source))throw new q(ps,"Layer source does not support queryAttachments capability",e);return this.source.queryAttachments(e)})}queryFeatures(e,t){return this.load().then(()=>this.source.queryFeatures(va.from(e)||this.createQuery(),t)).then(i=>{if(i!=null&&i.features)for(const r of i.features)r.layer=r.sourceLayer=this;return i})}queryObjectIds(e,t){return this.load().then(()=>{if(this.source.queryObjectIds)return this.source.queryObjectIds(va.from(e)||this.createQuery(),t);throw new q(ps,"Layer source does not support queryObjectIds capability")})}queryFeatureCount(e,t){return this.load().then(()=>{if(this.source.queryFeatureCount)return this.source.queryFeatureCount(va.from(e)||this.createQuery(),t);throw new q(ps,"Layer source does not support queryFeatureCount capability")})}queryExtent(e,t){return this.load().then(()=>{if(this.source.queryExtent)return this.source.queryExtent(va.from(e)||this.createQuery(),t);throw new q(ps,"Layer source does not support queryExtent capability")})}queryRelatedFeatures(e,t){return this.load().then(()=>{if("queryRelatedFeatures"in this.source)return this.source.queryRelatedFeatures(L1.from(e),t);throw new q(ps,"Layer source does not support queryRelatedFeatures capability")})}queryRelatedFeaturesCount(e,t){return this.load().then(()=>{if("queryRelatedFeaturesCount"in this.source)return this.source.queryRelatedFeaturesCount(L1.from(e),t);throw new q(ps,"Layer source does not support queryRelatedFeaturesCount capability")})}queryTopFeatures(e,t){return this.load().then(()=>{if("queryTopFeatures"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopFeatures(Xy.from(e),t).then(i=>{if(i!=null&&i.features)for(const r of i.features)r.layer=r.sourceLayer=this;return i});throw new q(ps,"Layer source does not support queryTopFeatures capability")})}queryTopObjectIds(e,t){return this.load().then(()=>{if("queryTopObjectIds"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopObjectIds(Xy.from(e),t);throw new q(ps,"Layer source does not support queryTopObjectIds capability")})}queryTopFeaturesExtent(e,t){return this.load().then(()=>{if("queryTopExtents"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopExtents(Xy.from(e),t);throw new q(ps,"Layer source does not support queryTopExtents capability")})}queryTopFeatureCount(e,t){return this.load().then(()=>{if("queryTopCount"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopCount(Xy.from(e),t);throw new q(ps,"Layer source does not support queryFeatureCount capability")})}read(e,t){const i=e.featureCollection;if(i){const r=i.layers;r&&r.length===1&&(super.read(r[0],t),i.showLegend!=null&&super.read({showLegend:i.showLegend},t))}super.read(e,t),t&&t.origin==="service"&&this.revert(["objectIdField","fields","timeInfo","spatialReference"],"service")}write(e,t){var i,r;const s=(t=me(I({},t),{writeLayerSchema:(i=(r=t)==null?void 0:r.writeLayerSchema)!=null?i:this._hasMemorySource()})).origin,n=t.layerContainerType,o=t.messages;if(this.isTable){if(s==="web-scene"||s==="web-map"&&n!=="tables")return o&&o.push(new q("layer:unsupported",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using a Table source cannot be written to web scenes and web maps`,{layer:this})),null;if(this._hasMemorySource())return o&&o.push(new q("layer:unsupported",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using an in-memory Table source cannot be written to web scenes and web maps`,{layer:this})),null}else if(this.loaded&&s==="web-map"&&n==="tables")return o&&o.push(new q("layer:unsupported",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using a non-table source cannot be written to tables in web maps`,{layer:this})),null;return super.write(e,t)}clone(){if(this._hasMemorySource())throw new q(ps,`FeatureLayer (title: ${this.title}, id: ${this.id}) created using in-memory source cannot be cloned`);return super.clone()}serviceSupportsSpatialReference(e){return!!this.loaded&&(this.source.type==="memory"||gze(this,e))}_readEditingEnabled(e,t,i){var r;let s=(r=e.layerDefinition)==null?void 0:r.capabilities;return s?this._hasEditingCapability(s):(s=e.capabilities,t&&(i==null?void 0:i.origin)==="web-map"&&!this._hasMemorySource()&&s?this._hasEditingCapability(s):void 0)}_hasEditingCapability(e){return e.toLowerCase().split(",").map(t=>t.trim()).includes("editing")}_writeEditingEnabled(e,t,i,r){if(!e){var s,n;const o=(s=this.capabilities)!=null&&(n=s.operations)!=null&&n.supportsSync?"Query,Sync":"Query";yc("layerDefinition.capabilities",o,t),!i||r!=null&&r.writeLayerSchema||(t.capabilities=o)}}_checkAttachmentSupport(e){const{attributes:t}=e,{objectIdField:i}=this;return this.get("capabilities.data.supportsAttachment")?e?t?t[i]?void 0:Promise.reject(new q(ps,`feature is missing the identifying attribute ${i}`)):Promise.reject(new q(ps,"'attributes' are required on a feature to query attachments")):Promise.reject(new q(ps,"A feature is required to add/delete/update attachments")):Promise.reject(new q(ps,"this layer doesn't support attachments"))}_getLayerDomain(e){const t=this.fieldsIndex.get(e);return t?t.domain:null}_fetchFirstLayerId(e){return Ti(this.url,{query:me(I({f:"json"},this.customParameters),{token:this.apiKey}),responseType:"json",signal:e}).then(t=>{const i=t.data;if(i)return Array.isArray(i.layers)&&i.layers.length>0?i.layers[0].id:Array.isArray(i.tables)&&i.tables.length>0?i.tables[0].id:void 0})}async _initLayerProperties(e){return this._set("source",e),e.sourceJSON&&(this.sourceJSON=e.sourceJSON,this.read(e.sourceJSON,{origin:"service",url:this.parsedUrl})),this._verifySource(),this._verifyFields(),xY(this.renderer,this.fieldsIndex),ele(this.timeInfo,this.fieldsIndex),yze(this,{origin:"service"})}async hasDataChanged(){var e;if((e=this.source)!=null&&e.refresh)try{var t;const{dataChanged:i,updates:r}=await((t=this.source)==null?void 0:t.refresh());if(_(r)&&(this.sourceJSON=I(I({},this.sourceJSON),r),this.read(r,{origin:"service",url:this.parsedUrl})),i)return!0}catch{}if(this.definitionExpression)try{return(await V5e(this.definitionExpression,this.fieldsIndex)).hasDateFunctions}catch{}return!1}_verifyFields(){const e=this.parsedUrl&&this.parsedUrl.path||"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+e+")"),this.isTable||this._hasMemorySource()||e.search(/\/FeatureServer\//i)!==-1||this.fields&&this.fields.some(function(t){return t.type==="geometry"})||console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+e+")")}_fixTemplates(e,t){e&&e.forEach(i=>{const r=i.prototype&&i.prototype.attributes;r&&t&&delete r[t]})}_verifySource(){if(this._hasMemorySource()){if(this.url)throw new q("feature-layer:mixed-source-and-url","FeatureLayer cannot be created with both an in-memory source and a url")}else if(!this.url)throw new q("feature-layer:source-or-url-required","FeatureLayer requires either a url, a valid portal item or a source")}_initMemorySource(e){e.forEach(t=>{t.layer=this,t.sourceLayer=this}),this._handles.add([e.on("after-add",t=>{t.item.layer=this,t.item.sourceLayer=this}),e.on("after-remove",t=>{t.item.layer=null,t.item.sourceLayer=null})],"fl-source")}_resetMemorySource(e){e.forEach(t=>{t.layer=null,t.sourceLayer=null}),this._handles.remove("fl-source")}_hasMemorySource(){return!(this.url||!this.source)}_readAttachmentCapabilities(e){const t={supportsName:!1,supportsSize:!1,supportsContentType:!1,supportsKeywords:!1,supportsExifInfo:!1};return e&&Array.isArray(e)&&e.forEach(i=>{const r=Pze[i.name];r&&(t[r]=!!i.isEnabled)}),t}_readDataCapabilities(e){return{isVersioned:It(e,"isDataVersioned",!1),supportsAttachment:It(e,"hasAttachments",!1),supportsM:It(e,"hasM",!1),supportsZ:It(e,"hasZ",!1)}}_readMetadataCapabilities(e){return{supportsAdvancedFieldProperties:It(e,"supportsFieldDescriptionProperty",!1)}}_readOperationsCapabilities(e,t){const i=e?e.toLowerCase().split(",").map(l=>l.trim()):[],r=i.includes("editing")&&!t.datesInUnknownTimezone;let s=r&&i.includes("create"),n=r&&i.includes("delete"),o=r&&i.includes("update");const a=i.includes("changetracking");return r&&!(s||n||o)&&(s=n=o=!0),{supportsCalculate:It(t,"supportsCalculate",!1),supportsTruncate:It(t,"supportsTruncate",!1),supportsValidateSql:It(t,"supportsValidateSql",!1),supportsAdd:s,supportsDelete:n,supportsEditing:r,supportsChangeTracking:a,supportsQuery:i.includes("query"),supportsQueryAttachments:It(t.advancedQueryCapabilities,"supportsQueryAttachments",!1),supportsResizeAttachments:It(t,"supportsAttachmentsResizing",!1),supportsSync:i.includes("sync"),supportsUpdate:o,supportsExceedsLimitStatistics:It(t,"supportsExceedsLimitStatistics",!1)}}_readQueryCapabilities(e){var t;const i=e.advancedQueryCapabilities,r=e.ownershipBasedAccessControlForFeatures,s=e.archivingInfo,n=(t=this.url)==null?void 0:t.includes("MapServer"),o=!ue("mapserver-pbf-enabled")&&n&&this.version<10.81,a=zfe(this.url),l=(e.supportedQueryFormats||"").split(",").reduce((c,h)=>{const p=h.toLowerCase().trim();return p&&c.add(p),c},new Set);return{supportsStatistics:It(i,"supportsStatistics",e.supportsStatistics),supportsPercentileStatistics:It(i,"supportsPercentileStatistics",!1),supportsSpatialAggregationStatistics:It(i,"supportsSpatialAggregationStatistics",!1),supportedSpatialAggregationStatistics:Ize(i),supportsCentroid:It(i,"supportsReturningGeometryCentroid",!1),supportsDistance:It(i,"supportsQueryWithDistance",!1),supportsDistinct:It(i,"supportsDistinct",e.supportsAdvancedQueries),supportsExtent:It(i,"supportsReturningQueryExtent",!1),supportsGeometryProperties:It(i,"supportsReturningGeometryProperties",!1),supportsHavingClause:It(i,"supportsHavingClause",!1),supportsOrderBy:It(i,"supportsOrderBy",e.supportsAdvancedQueries),supportsPagination:It(i,"supportsPagination",!1),supportsQuantization:It(e,"supportsCoordinatesQuantization",!1),supportsQuantizationEditMode:It(e,"supportsQuantizationEditMode",!1),supportsQueryGeometry:It(e,"supportsReturningQueryGeometry",!1),supportsResultType:It(i,"supportsQueryWithResultType",!1),supportsMaxRecordCountFactor:It(i,"supportsMaxRecordCountFactor",!1),supportsSqlExpression:It(i,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:It(e,"useStandardizedQueries",!1),supportsTopFeaturesQuery:It(i,"supportsTopFeaturesQuery",!1),supportsQueryByOthers:It(r,"allowOthersToQuery",!0),supportsHistoricMoment:It(s,"supportsQueryWithHistoricMoment",!1),supportsFormatPBF:!o&&l.has("pbf"),supportsDisjointSpatialRelationship:It(i,"supportsDisjointSpatialRel",!1),supportsCacheHint:It(i,"supportsQueryWithCacheHint",!1),supportsDefaultSpatialReference:It(i,"supportsDefaultSR",!1),supportsCompactGeometry:a,maxRecordCountFactor:QM(e,"maxRecordCountFactor",void 0),maxRecordCount:QM(e,"maxRecordCount",void 0),standardMaxRecordCount:QM(e,"standardMaxRecordCount",void 0),tileMaxRecordCount:QM(e,"tileMaxRecordCount",void 0)}}_readQueryRelatedCapabilities(e){const t=e.advancedQueryCapabilities,i=It(t,"supportsAdvancedQueryRelated",!1);return{supportsPagination:It(t,"supportsQueryRelatedPagination",!1),supportsCount:i,supportsOrderBy:i}}_readEditingCapabilities(e){const t=e.ownershipBasedAccessControlForFeatures;return{supportsGeometryUpdate:It(e,"allowGeometryUpdates",!0),supportsGlobalId:It(e,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:It(e,"supportsReturnServiceEditsInSourceSR",!1),supportsRollbackOnFailure:It(e,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:It(e,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:It(e,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:It(t,"allowAnonymousToDelete",!0),supportsDeleteByOthers:It(t,"allowOthersToDelete",!0),supportsUpdateByAnonymous:It(t,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:It(t,"allowOthersToUpdate",!0)}}};u([d({readOnly:!0,json:{read:!1}})],Me.prototype,"capabilities",void 0),u([De("service","capabilities",["advancedQueryCapabilities","allowGeometryUpdates","allowUpdateWithoutMValues","archivingInfo","capabilities","datesInUnknownTimezone","hasAttachments","hasM","hasZ","maxRecordCount","maxRecordCountFactor","ownershipBasedAccessControlForFeatures","standardMaxRecordCount","supportedQueryFormats","supportsAdvancedQueries","supportsApplyEditsWithGlobalIds","supportsAttachmentsByUploadId","supportsAttachmentsResizing","supportsCalculate","supportsCoordinatesQuantization","supportsExceedsLimitStatistics","supportsFieldDescriptionProperty","supportsQuantizationEditMode","supportsRollbackOnFailureParameter","supportsStatistics","supportsTruncate","supportsValidateSql","tileMaxRecordCount","useStandardizedQueries"])],Me.prototype,"readCapabilities",null),u([d({json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],Me.prototype,"charts",void 0),u([d({readOnly:!0})],Me.prototype,"createQueryVersion",null),u([d({type:String,json:{read:{source:"layerDefinition.copyrightText"},origins:{service:{read:{source:"copyrightText"}}}}})],Me.prototype,"copyright",void 0),u([d({type:Boolean})],Me.prototype,"datesInUnknownTimezone",void 0),u([d({type:String,json:{read:{source:"layerDefinition.displayField"},origins:{service:{read:{source:"displayField"}}}}})],Me.prototype,"displayField",void 0),u([d({type:String,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.definitionExpression",write:{enabled:!0,allowNull:!0}}})],Me.prototype,"definitionExpression",void 0),u([d({types:n1,readOnly:!0})],Me.prototype,"defaultSymbol",void 0),u([d({type:ec})],Me.prototype,"dynamicDataSource",void 0),u([d({readOnly:!0})],Me.prototype,"editFieldsInfo",void 0),u([d({type:Boolean})],Me.prototype,"editingEnabled",null),u([De(["portal-item","web-scene"],"editingEnabled",["layerDefinition.capabilities"])],Me.prototype,"readEditingEnabled",null),u([De("web-map","editingEnabled",["capabilities","layerDefinition.capabilities"])],Me.prototype,"readEditingEnabledFromWebMap",null),u([Fe(["portal-item","web-scene"],"editingEnabled",{"layerDefinition.capabilities":{type:String}})],Me.prototype,"writeEditingEnabled",null),u([Fe("web-map","editingEnabled",{capabilities:{type:String},"layerDefinition.capabilities":{type:String}})],Me.prototype,"writeEditingEnabledToWebMap",null),u([d({readOnly:!0})],Me.prototype,"editingInfo",void 0),u([De("editingInfo")],Me.prototype,"readEditingInfo",null),u([d(pke)],Me.prototype,"elevationInfo",void 0),u([d(oze)],Me.prototype,"featureReduction",void 0),u([d(me(I({},RU.fields),{json:{read:{source:"layerDefinition.fields"},origins:{service:{name:"fields"},"web-map":{write:{target:"layerDefinition.fields",overridePolicy:OU}}}}}))],Me.prototype,"fields",void 0),u([d(RU.fieldsIndex)],Me.prototype,"fieldsIndex",void 0),u([d({type:fze,json:{read:{source:"layerDefinition.floorInfo"},write:{target:"layerDefinition.floorInfo"}}})],Me.prototype,"floorInfo",void 0),u([d({type:eUe,json:{name:"formInfo",write:!0,origins:{"web-scene":{read:!1,write:!1}}}})],Me.prototype,"formTemplate",void 0),u([d({type:Xt,json:{origins:{service:{read:{source:"extent"}}},read:{source:"layerDefinition.extent"}}})],Me.prototype,"fullExtent",void 0),u([d()],Me.prototype,"gdbVersion",void 0),u([d({readOnly:!0,type:hze,json:{read:{source:"geometryProperties"}}})],Me.prototype,"geometryFieldsInfo",void 0),u([d({type:["point","polygon","polyline","multipoint","multipatch","mesh"],json:{origins:{service:{read:CU.read},"web-map":{write:{target:"layerDefinition.geometryType",overridePolicy:OU,writer(e,t,i){const r=e?CU.toJSON(e):null;r&&yc(i,r,t)}}}},read:{source:"layerDefinition.geometryType",reader:CU.read}}})],Me.prototype,"geometryType",void 0),u([d({type:Boolean,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasM"}}})],Me.prototype,"hasM",void 0),u([d({type:Boolean,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasZ"}}})],Me.prototype,"hasZ",void 0),u([d({readOnly:!0,type:U0})],Me.prototype,"heightModelInfo",void 0),u([d({type:Date})],Me.prototype,"historicMoment",void 0),u([d(mke)],Me.prototype,"id",void 0),u([d({readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],Me.prototype,"infoFor3D",void 0),u([d({readOnly:!0,json:{origins:{"web-map":{write:{target:"layerDefinition.type"}}}}})],Me.prototype,"isTable",void 0),u([De("service","isTable",["type","geometryType"]),De("isTable",["layerDefinition.type","layerDefinition.geometryType"])],Me.prototype,"readIsTable",null),u([Fe("web-map","isTable")],Me.prototype,"writeIsTable",null),u([d(Hfe)],Me.prototype,"labelsVisible",void 0),u([d({type:[tq],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:iK},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:iK},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],Me.prototype,"labelingInfo",void 0),u([d(fke)],Me.prototype,"opacity",void 0),u([d({type:Number,json:{origins:{service:{read:{source:"id"}}},read:!1}})],Me.prototype,"layerId",void 0),u([d(dke)],Me.prototype,"legendEnabled",void 0),u([d({type:["show","hide"]})],Me.prototype,"listMode",void 0),u([d(gke)],Me.prototype,"minScale",void 0),u([De("service","minScale",["minScale","effectiveMinScale"])],Me.prototype,"readMinScale",null),u([d(yke)],Me.prototype,"maxScale",void 0),u([De("service","maxScale",["maxScale","effectiveMaxScale"])],Me.prototype,"readMaxScale",null),u([d({type:String})],Me.prototype,"globalIdField",void 0),u([De("globalIdField",["layerDefinition.globalIdField","layerDefinition.fields"]),De("service","globalIdField",["globalIdField","fields"])],Me.prototype,"readGlobalIdFieldFromService",null),u([d({type:String,json:{origins:{"web-map":{write:{target:"layerDefinition.objectIdField",overridePolicy:OU}}}}})],Me.prototype,"objectIdField",void 0),u([De("objectIdField",["layerDefinition.objectIdField","layerDefinition.fields"]),De("service","objectIdField",["objectIdField","fields"])],Me.prototype,"readObjectIdFieldFromService",null),u([d({value:"ArcGISFeatureLayer",type:["ArcGISFeatureLayer"]})],Me.prototype,"operationalLayerType",void 0),u([d(RU.outFields)],Me.prototype,"outFields",void 0),u([d({readOnly:!0})],Me.prototype,"parsedUrl",null),u([d({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],Me.prototype,"path",void 0),u([d(jfe)],Me.prototype,"popupEnabled",void 0),u([d({type:kN,json:{name:"popupInfo",write:!0}})],Me.prototype,"popupTemplate",void 0),u([d({readOnly:!0})],Me.prototype,"defaultPopupTemplate",null),u([d({type:[mze],readOnly:!0})],Me.prototype,"relationships",void 0),u([d({types:Pfe,json:{origins:{service:{write:{target:"drawingInfo.renderer",enabled:!1}},"web-scene":{types:U5e,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:(e,t,i)=>({ignoreOrigin:i==null?void 0:i.writeLayerSchema})}}},write:{target:"layerDefinition.drawingInfo.renderer",overridePolicy:(e,t,i)=>({ignoreOrigin:i==null?void 0:i.writeLayerSchema})}}})],Me.prototype,"renderer",null),u([De("service","renderer",["drawingInfo.renderer","defaultSymbol"]),De("renderer",["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol"])],Me.prototype,"readRenderer",null),u([d()],Me.prototype,"sourceJSON",void 0),u([d({type:Boolean})],Me.prototype,"returnM",void 0),u([d({type:Boolean})],Me.prototype,"returnZ",void 0),u([d(uke)],Me.prototype,"screenSizePerspectiveEnabled",void 0),u([d({clonable:!1})],Me.prototype,"source",null),u([At("source")],Me.prototype,"castSource",null),u([De("portal-item","source",["featureSet"]),De("web-map","source",["featureSet"])],Me.prototype,"readSource",null),u([d({readOnly:!0})],Me.prototype,"serviceDefinitionExpression",void 0),u([De("service","serviceDefinitionExpression",["definitionQuery","definitionExpression"])],Me.prototype,"readServiceDefinitionExpression",null),u([d({type:He,json:{origins:{service:{read:{source:"extent.spatialReference"}}},read:{source:"layerDefinition.extent.spatialReference"}}})],Me.prototype,"spatialReference",void 0),u([d({type:Number})],Me.prototype,"subtypeCode",void 0),u([d({type:[iq]})],Me.prototype,"templates",void 0),u([De("templates",["editFieldsInfo","creatorField","editorField","templates"])],Me.prototype,"readTemplates",null),u([d({type:Zfe})],Me.prototype,"timeInfo",void 0),u([d()],Me.prototype,"title",void 0),u([De("service","title",["name"]),De("portal-item","title",["layerDefinition.title","layerDefinition.name","title"])],Me.prototype,"readTitle",null),u([De("web-map","title",["layerDefinition.name","title"])],Me.prototype,"readTitleFromWebMap",null),u([d({type:String})],Me.prototype,"sublayerTitleMode",void 0),u([d({type:String,json:{read:{source:"timeInfo.trackIdField"}}})],Me.prototype,"trackIdField",void 0),u([d({json:{read:!1}})],Me.prototype,"type",void 0),u([d({type:String})],Me.prototype,"typeIdField",void 0),u([De("service","typeIdField"),De("typeIdField",["layerDefinition.typeIdField"])],Me.prototype,"readTypeIdField",null),u([d({type:[ime]})],Me.prototype,"types",void 0),u([De("service","types",["types"]),De("types",["layerDefinition.types"])],Me.prototype,"readTypes",null),u([d({readOnly:!0,json:{write:!1}})],Me.prototype,"serverGens",void 0),u([d({type:it.ofType(Wf),readOnly:!0})],Me.prototype,"indexes",void 0),u([d(hke)],Me.prototype,"url",null),u([Fe("url")],Me.prototype,"writeUrl",null),u([d({readOnly:!0})],Me.prototype,"userIsAdmin",void 0),u([d({json:{origins:{service:{read:!0}},read:!1}})],Me.prototype,"version",void 0),u([De("service","version",["currentVersion","capabilities","drawingInfo","hasAttachments","htmlPopupType","relationships","timeInfo","typeIdField","types"])],Me.prototype,"readVersion",null),u([d({type:Boolean,json:{origins:{"portal-item":{write:{target:"layerDefinition.defaultVisibility"}}}}})],Me.prototype,"visible",void 0),u([De("portal-item","visible",["visibility","layerDefinition.defaultVisibility"])],Me.prototype,"readVisible",null),Me=u([P("esri.layers.FeatureLayer")],Me);const MU=PS({types:xce}),sme=Me;var ryt=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:sme});const $ze=["$datastore","$map","$layer","$aggregatedfeatures"],Dze="esri.widgets.Feature.support.arcadeFeatureUtils",Lze=he.getLogger(Dze);function Nze(e){return typeof e=="string"?mO(aH(e)):Array.isArray(e)?Fze(e):(e==null?void 0:e.declaredClass)==="esri.arcade.Dictionary"?Uze(e):e}function Fze(e){return`<ul class="esri-widget__list">${e.map(t=>`<li>${typeof t=="string"?mO(aH(t)):t}</li>`).join("")}</ul>`}function Uze(e){return`<table class="esri-widget__table">${e.keys().map(t=>{const i=e.field(t);return`<tr><th>${t}</th><td>${typeof i=="string"?mO(aH(i)):i}</td></tr>`}).join("")}</table>`}function kze({aggregatedFeatures:e,arcadeUtils:t,featureSetVars:i,context:r,viewInfo:s,map:n,graphic:o,interceptor:a}){i.forEach(l=>{const c=l.toLowerCase(),h={map:n,spatialReference:s.sr,interceptor:a};if(c==="$map"&&(r.vars[c]=t.convertMapToFeatureSetCollection(h)),c==="$layer"&&(r.vars[c]=t.convertFeatureLayerToFeatureSet({layer:o.sourceLayer,spatialReference:s.sr,interceptor:a})),c==="$datastore"&&(r.vars[c]=t.convertServiceUrlToWorkspace({url:o.sourceLayer.url,spatialReference:s.sr,interceptor:a})),c==="$aggregatedfeatures"){const p=o.layer,{fields:f,objectIdField:g,geometryType:y,spatialReference:v,displayField:b}=p,w=new sme(me(I({fields:f,objectIdField:g,geometryType:y,spatialReference:v,displayField:b},p.type==="feature"?{templates:p.templates,typeIdField:p.typeIdField,types:p.types}:null),{source:e}));r.vars[c]=t.convertFeatureLayerToFeatureSet({layer:w,spatialReference:s.sr,interceptor:a})}})}function nme(){return import("./arcadeUtils.1e20f716.js").then(function(e){return e.q})}async function zze({graphic:e,view:t}){const{isAggregate:i,layer:r}=e;if(!i||!r||(t==null?void 0:t.type)!=="2d")return[];const s=await t.whenLayerView(r);if(!s.createQuery||!s.queryFeatures)return[];const n=s.createQuery();n.aggregateIds=[e.getObjectId()];const{features:o}=await s.queryFeatures(n);return o}async function ome({expressionInfo:e,arcadeUtils:t,interceptor:i,spatialReference:r,map:s,graphic:n,view:o}){if(!e||!e.expression)return null;const a=t.createSyntaxTree(e.expression),l=$ze.filter(g=>t.hasVariable(a,g)),[c]=await $C([zze({graphic:n,view:o}),t.loadScriptDependencies(a,!0,l)]),h=t.getViewInfo({spatialReference:r}),p=t.createExecContext(n,h);p.interceptor=i,p.useAsync=!0,kze({aggregatedFeatures:c,arcadeUtils:t,featureSetVars:l,context:p,viewInfo:h,map:s,graphic:n,interceptor:i});const f=t.createFunction(a,p);return t.executeAsyncFunction(f,p).catch(g=>Lze.error("arcade-execution-error",{error:g,graphic:n,expressionInfo:e}))}async function Bze({expressionInfos:e,spatialReference:t,graphic:i,interceptor:r,map:s,view:n}){if(!e||!e.length)return{};const o=await nme(),a={};for(const h of e)a[`expression/${h.name}`]=ome({expressionInfo:h,arcadeUtils:o,interceptor:r,spatialReference:t,map:s,graphic:i,view:n});const l=await Ks(a),c={};for(const h in l)c[h]=Nze(l[h].value);return c}const Vze=1;let zl=class extends Vm(we){constructor(e){super(e),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.view=null,this._cancelQuery=()=>{const{_abortController:t}=this;t&&t.abort(),this._abortController=null},this._createVM=()=>{var t,i;const r=(t=this.contentElement)==null?void 0:t.type;(i=this.contentElementViewModel)==null||i.destroy();const s=r==="fields"?new bF:r==="media"?new X_:r==="text"?new tL:null;this._set("contentElementViewModel",s)},this._compile=async()=>{this._cancelQuery();const t=new AbortController;this._abortController=t,await this._compileExpression(),this._abortController===t&&(this._abortController=null)},this._compileThrottled=Kj(this._compile,Vze,this),this._compileExpression=async()=>{const{expressionInfo:t,graphic:i,interceptor:r,spatialReference:s,map:n,view:o,_abortController:a}=this;if(!(t&&i&&s&&n))return void this._set("contentElement",null);const l=await nme();if(a!==this._abortController)return;const c=await ome({arcadeUtils:l,expressionInfo:t,graphic:i,interceptor:r,map:n,spatialReference:s,view:o});if(!c||c.declaredClass!=="esri.arcade.Dictionary")return void this._set("contentElement",null);const h=await LH(c,a.signal),p=h==null?void 0:h.type,f=p==="media"?BC.fromJSON(h):p==="text"?LT.fromJSON(h):p==="fields"?DT.fromJSON(h):null;this._set("contentElement",f)},this.handles.add([Wt(this,["expressionInfo","graphic","map","spatialReference","view"],this._compileThrottled),Wt(this,"contentElement",this._createVM)])}destroy(){var e;this._cancelQuery(),(e=this.contentElementViewModel)==null||e.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){var e;return((e=this.view)==null?void 0:e.spatialReference)||null}set spatialReference(e){e!==void 0?this._override("spatialReference",e):this._clearOverride("spatialReference")}get state(){const{_abortController:e,contentElement:t,contentElementViewModel:i}=this;return e?"loading":t||i?"ready":"disabled"}get map(){var e;return((e=this.view)==null?void 0:e.map)||null}set map(e){e!==void 0?this._override("map",e):this._clearOverride("map")}};u([d()],zl.prototype,"_abortController",void 0),u([d({type:ale})],zl.prototype,"expressionInfo",void 0),u([d({type:qo})],zl.prototype,"graphic",void 0),u([d({readOnly:!0})],zl.prototype,"contentElement",void 0),u([d({readOnly:!0})],zl.prototype,"contentElementViewModel",void 0),u([d()],zl.prototype,"interceptor",void 0),u([d()],zl.prototype,"spatialReference",null),u([d({readOnly:!0})],zl.prototype,"state",null),u([d()],zl.prototype,"map",null),u([d()],zl.prototype,"view",void 0),zl=u([P("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],zl);const rq=zl,JM={iconLoading:"esri-icon-loading-indicator esri-rotating",base:"esri-feature-expression",loadingSpinnerContainer:"esri-feature__loading-container",spinner:"esri-feature__loading-spinner"};let e$=class extends Ia{constructor(e,t){super(e,t),this.viewModel=new rq}initialize(){Wt(this,"viewModel.contentElementViewModel",()=>this._setupExpressionWidget())}destroy(){this._destroyContentWidget()}renderLoading(){return le("div",{key:"loading-container",class:JM.loadingSpinnerContainer},le("span",{class:this.classes(JM.iconLoading,JM.spinner)}))}render(){var e;const{state:t}=this.viewModel;return le("div",{class:JM.base},t==="loading"?this.renderLoading():t==="disabled"?null:(e=this._contentWidget)==null?void 0:e.render())}_destroyContentWidget(){const{_contentWidget:e}=this;e&&(e.viewModel=null,e.destroy()),this._contentWidget=null}_setupExpressionWidget(){const{contentElementViewModel:e,contentElement:t}=this.viewModel,i=t==null?void 0:t.type;this._destroyContentWidget();const r=e?i==="fields"?new Ade({viewModel:e}):i==="media"?new npe({viewModel:e}):i==="text"?new OI({viewModel:e}):null:null;this._contentWidget=r,this.scheduleRender()}};u([d({type:rq})],e$.prototype,"viewModel",void 0),e$=u([P("esri.widgets.Feature.FeatureExpression")],e$);const Gze=e$;class jze{constructor(t,i){this.preLayerQueryCallback=t,this.preRequestCallback=i,this.preLayerQueryCallback||(this.preLayerQueryCallback=r=>{}),this.preRequestCallback||(this.preLayerQueryCallback=r=>{})}}var t$;const Hze=1,lK="content-view-models",ame="esri.widgets.FeatureViewModel",qze=he.getLogger(ame),cK={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0};let Br=t$=class extends we{constructor(e){super(e),this._handles=new Ut,this._error=null,this._featureAbortController=null,this.graphicChangedThrottled=Kj(this._graphicChanged,Hze,this),this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities=I({},cK),this.content=null,this.contentViewModels=[],this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.relatedInfos=new Map,this.title="",this.view=null,this._isAllowedContentType=t=>{const{abilities:i}=this;return t.type==="attachments"&&i.attachmentsContent||t.type==="custom"&&i.customContent||t.type==="fields"&&i.fieldsContent||t.type==="media"&&i.mediaContent||t.type==="text"&&i.textContent||t.type==="expression"&&i.expressionContent},this._handles.add(Wt(this,["graphic","_effectivePopupTemplate","abilities"],()=>this.graphicChangedThrottled()))}destroy(){this._clear(),this._cancelFeatureQuery(),this._error=null,this._handles.destroy(),this._handles=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return _(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return v$e(cQ(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return mde(this.graphic)}castAbilities(e){return I(I({},cK),e)}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(e){this._set("graphic",e?e.clone():null)}get spatialReference(){return this.get("view.spatialReference")||null}set spatialReference(e){e!==void 0?this._override("spatialReference",e):this._clearOverride("spatialReference")}get map(){return this.get("view.map")||null}set map(e){e!==void 0?this._override("map",e):this._clearOverride("map")}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(e,t){const i=this.contentViewModels[e];i instanceof X_&&i.setActiveMedia(t)}nextMedia(e){const t=this.contentViewModels[e];t instanceof X_&&t.next()}previousMedia(e){const t=this.contentViewModels[e];t instanceof X_&&t.previous()}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async _graphicChanged(){this._cancelFeatureQuery(),this._error=null,this._clear();const{graphic:e}=this;if(!e)return;const t=new AbortController;this._featureAbortController=t;try{await this._queryFeature({signal:t.signal})}catch(i){pr(i)||(this._error=i,qze.error("error","The popupTemplate could not be displayed for this feature.",{error:i,graphic:e,popupTemplate:this._effectivePopupTemplate}))}this._featureAbortController===t&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:e}=this;e&&e.abort(),this._featureAbortController=null}_compileContentElement(e,t){return e.type==="attachments"?this._compileAttachments(e,t):e.type==="custom"?this._compileCustom(e,t):e.type==="fields"?this._compileFields(e,t):e.type==="media"?this._compileMedia(e,t):e.type==="text"?this._compileText(e,t):e.type==="expression"?this._compileExpression(e,t):void 0}_compileContent(e){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.filter(this._isAllowedContentType).map((t,i)=>this._compileContentElement(t,i)):typeof e=="string"?this._compileText(new LT({text:e}),0).text:e}_destroyContentViewModels(){var e;(e=this._handles)==null||e.remove(lK),this.contentViewModels.forEach(t=>t&&!t.destroyed&&t.destroy()),this._set("contentViewModels",[])}_setExpressionContentVM(e,t){const{formattedAttributes:i}=this,{contentElement:r,contentElementViewModel:s}=e,n=r==null?void 0:r.type;s&&n&&(n==="fields"&&(this._createFieldsFormattedAttributes({contentElement:r,contentElementIndex:t,formattedAttributes:i}),s.set(this._createFieldsVMParams(r,t))),n==="media"&&(this._createMediaFormattedAttributes({contentElement:r,contentElementIndex:t,formattedAttributes:i}),s.set(this._createMediaVMParams(r,t))),n==="text"&&s.set(this._createTextVMParams(r)))}_compileExpression(e,t){const{expressionInfo:i}=e,{graphic:r,map:s,spatialReference:n,view:o}=this,a=new rq({expressionInfo:i,graphic:r,interceptor:t$.interceptor,map:s,spatialReference:n,view:o});return this.contentViewModels[t]=a,this._handles.add(Wt(a,"contentElementViewModel",()=>this._setExpressionContentVM(a,t)),lK),e}_compileAttachments(e,t){const{graphic:i}=this,{description:r,title:s}=e;return this.contentViewModels[t]=new cH(I({graphic:i},this._compileTitleAndDesc({title:s,description:r}))),e}_compileCustom(e,t){const{graphic:i}=this,{creator:r,destroyer:s}=e;return this.contentViewModels[t]=new tL({graphic:i,creator:r,destroyer:s}),e}_compileTitleAndDesc({title:e,description:t}){const{_fieldInfoMap:i,_sourceLayer:r,graphic:s,formattedAttributes:n,_expressionAttributes:o}=this,{attributes:a}=s,l=n.global;return{title:q_({attributes:a,fieldInfoMap:i,globalAttributes:l,expressionAttributes:o,layer:r,text:e}),description:q_({attributes:a,fieldInfoMap:i,globalAttributes:l,expressionAttributes:o,layer:r,text:t})}}_createFieldsVMParams(e,t){const{_effectivePopupTemplate:i,formattedAttributes:r}=this,s=I(I({},r.global),r.content[t]),n=(e==null?void 0:e.fieldInfos)||(i==null?void 0:i.fieldInfos),o=n==null?void 0:n.filter(({fieldName:h})=>yde(h)||am(h)||s.hasOwnProperty(h)),a=i==null?void 0:i.expressionInfos,{description:l,title:c}=e;return I({attributes:s,expressionInfos:a,fieldInfos:o},this._compileTitleAndDesc({title:c,description:l}))}_compileFields(e,t){const i=e.clone(),r=new bF(this._createFieldsVMParams(e,t));return this.contentViewModels[t]=r,i.fieldInfos=r.formattedFieldInfos.slice(0),i}_createMediaVMParams(e,t){const{abilities:i,graphic:r,_fieldInfoMap:s,formattedAttributes:n,_effectivePopupTemplate:o,relatedInfos:a,_sourceLayer:l,_expressionAttributes:c}=this,{attributes:h}=r,{description:p,mediaInfos:f,title:g}=e;return I({abilities:{chartAnimation:i.chartAnimation},activeMediaInfoIndex:e.activeMediaInfoIndex||0,attributes:h,layer:l,fieldInfoMap:s,formattedAttributes:I(I({},n.global),n.content[t]),expressionAttributes:c,mediaInfos:f,popupTemplate:o,relatedInfos:a},this._compileTitleAndDesc({title:g,description:p}))}_compileMedia(e,t){const i=e.clone(),r=new X_(this._createMediaVMParams(e,t));return i.mediaInfos=r.formattedMediaInfos.slice(0),this.contentViewModels[t]=r,i}_createTextVMParams(e){const{graphic:t,_fieldInfoMap:i,_sourceLayer:r,_expressionAttributes:s}=this;if(e&&e.text){const{attributes:n}=t,o=this.formattedAttributes.global;e.text=q_({attributes:n,fieldInfoMap:i,globalAttributes:o,expressionAttributes:s,layer:r,text:e.text})}return{graphic:t,creator:e.text}}_compileText(e,t){const i=e.clone();return this.contentViewModels[t]=new tL(this._createTextVMParams(i)),i}_compileLastEditInfo(){const{_effectivePopupTemplate:e,_sourceLayer:t,graphic:i}=this;if(!e)return;const{lastEditInfoEnabled:r}=e,s=t==null?void 0:t.editFieldsInfo;return r&&s?y$e(s,i.attributes):void 0}_compileTitle(e){const{_fieldInfoMap:t,_sourceLayer:i,graphic:r,_expressionAttributes:s}=this,{attributes:n}=r,o=this.formattedAttributes.global;return q_({attributes:n,fieldInfoMap:t,globalAttributes:o,expressionAttributes:s,layer:i,text:e})}async _getTitle(){const{_effectivePopupTemplate:e,graphic:t}=this,i=e==null?void 0:e.title;return KD(i,{graphic:t})}async _getContent(){const{_effectivePopupTemplate:e,graphic:t}=this,i=e==null?void 0:e.content;return KD(i,{graphic:t})}async _queryFeature(e){const{_featureAbortController:t,_sourceLayer:i,graphic:r,_effectivePopupTemplate:s,spatialReference:n,map:o,view:a}=this,{content:{value:l},title:{value:c}}=await Ks({content:this._getContent(),title:this._getTitle()});if(t!==this._featureAbortController||!r)return;await x$e({graphic:r,popupTemplate:s,layer:i,spatialReference:n},e);const{expressionAttributes:{value:h}}=await Ks({checkForRelatedFeatures:this._checkForRelatedFeatures(e),expressionAttributes:Bze({expressionInfos:s==null?void 0:s.expressionInfos,spatialReference:n,graphic:r,map:o,interceptor:t$.interceptor,view:a})});t===this._featureAbortController&&r&&(this._expressionAttributes=h,this._graphicExpressionAttributes=I(I({},r.attributes),h),this._set("formattedAttributes",this._createFormattedAttributes(l)),this._set("title",this._compileTitle(c)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(l)||null))}_createMediaFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:i}){const{_effectivePopupTemplate:r,graphic:s,relatedInfos:n,_sourceLayer:o,_fieldInfoMap:a,_graphicExpressionAttributes:l}=this;i.content[t]=W5({fieldInfos:r==null?void 0:r.fieldInfos,graphic:s,attributes:I(I({},l),e.attributes),layer:o,fieldInfoMap:a,relatedInfos:n})}_createFieldsFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:i}){if(e.fieldInfos){const{graphic:r,relatedInfos:s,_sourceLayer:n,_fieldInfoMap:o,_graphicExpressionAttributes:a}=this;i.content[t]=W5({fieldInfos:e.fieldInfos,graphic:r,attributes:I(I({},a),e.attributes),layer:n,fieldInfoMap:o,relatedInfos:s})}}_createFormattedAttributes(e){const{_effectivePopupTemplate:t,graphic:i,relatedInfos:r,_sourceLayer:s,_fieldInfoMap:n,_graphicExpressionAttributes:o}=this,a=t==null?void 0:t.fieldInfos,l={global:W5({fieldInfos:a,graphic:i,attributes:o,layer:s,fieldInfoMap:n,relatedInfos:r}),content:[]};return Array.isArray(e)&&e.forEach((c,h)=>{c.type==="fields"&&this._createFieldsFormattedAttributes({contentElement:c,contentElementIndex:h,formattedAttributes:l}),c.type==="media"&&this._createMediaFormattedAttributes({contentElement:c,contentElementIndex:h,formattedAttributes:l})}),l}_checkForRelatedFeatures(e){const{graphic:t,_effectivePopupTemplate:i}=this;return this._queryRelatedInfos(t,cQ(i),e)}async _queryRelatedInfos(e,t,i){const{relatedInfos:r,_sourceLayer:s}=this;r.clear();const n=_(s.associatedLayer)?await s.associatedLayer.load(i):s;if(!n)return;const o=t.filter(c=>c&&am(c.fieldName));if(!o||!o.length)return;t.forEach(c=>this._configureRelatedInfo(c,n));const a=await ULe({relatedInfos:r,layer:n},i);Object.keys(a).forEach(c=>{var h;const p=r.get(c.toString()),f=(h=a[c])==null?void 0:h.value;p&&f&&(p.layerInfo=f.data)});const l=await kLe({graphic:e,relatedInfos:r,layer:n},i);Object.keys(l).forEach(c=>{var h;$Le((h=l[c])==null?void 0:h.value,r.get(c.toString()))})}_configureRelatedInfo(e,t){const{relatedInfos:i}=this,r=JE(e.fieldName);if(!r)return;const{layerId:s,fieldName:n}=r;if(!s)return;const o=i.get(s.toString())||ILe(s,t);o&&(zLe({relatedInfo:o,fieldName:n,fieldInfo:e}),this.relatedInfos.set(s,o))}};Br.interceptor=new jze(E$e,A$e),u([d()],Br.prototype,"_error",void 0),u([d()],Br.prototype,"_featureAbortController",void 0),u([d({readOnly:!0})],Br.prototype,"_effectivePopupTemplate",null),u([d({readOnly:!0})],Br.prototype,"_fieldInfoMap",null),u([d({readOnly:!0})],Br.prototype,"_sourceLayer",null),u([d()],Br.prototype,"abilities",void 0),u([At("abilities")],Br.prototype,"castAbilities",null),u([d({readOnly:!0})],Br.prototype,"content",void 0),u([d({readOnly:!0})],Br.prototype,"contentViewModels",void 0),u([d({type:Boolean})],Br.prototype,"defaultPopupTemplateEnabled",void 0),u([d({readOnly:!0})],Br.prototype,"state",null),u([d({readOnly:!0})],Br.prototype,"formattedAttributes",void 0),u([d({type:qo,value:null})],Br.prototype,"graphic",null),u([d({readOnly:!0})],Br.prototype,"lastEditInfo",void 0),u([d({readOnly:!0})],Br.prototype,"relatedInfos",void 0),u([d()],Br.prototype,"spatialReference",null),u([d({readOnly:!0})],Br.prototype,"title",void 0),u([d()],Br.prototype,"map",null),u([d({readOnly:!0})],Br.prototype,"waitingForContent",null),u([d()],Br.prototype,"view",void 0),Br=t$=u([P(ame)],Br);const sq=Br,lme=e=>{let t=class extends e{constructor(){super(...arguments),this.renderNodeContent=i=>Ede(i)&&!i.destroyed?le("div",{key:i},i.render()):i instanceof HTMLElement?le("div",{key:i,bind:i,afterCreate:this._attachToNode}):B$e(i)?le("div",{key:i,bind:i.domNode,afterCreate:this._attachToNode}):null}_attachToNode(i){const r=this;i.appendChild(r)}};return t=u([P("esri.widgets.Feature.ContentMixin")],t),t},Qn={iconText:"esri-icon-font-fallback-text",iconLoading:"esri-icon-loading-indicator esri-rotating",esriTable:"esri-widget__table",esriWidget:"esri-widget",base:"esri-feature",container:"esri-feature__size-container",title:"esri-feature__title",main:"esri-feature__main-container",btn:"esri-feature__button",icon:"esri-feature__icon",content:"esri-feature__content",contentElement:"esri-feature__content-element",text:"esri-feature__text",lastEditedInfo:"esri-feature__last-edited-info",fields:"esri-feature__fields",fieldHeader:"esri-feature__field-header",fieldData:"esri-feature__field-data",fieldDataDate:"esri-feature__field-data--date",loadingSpinnerContainer:"esri-feature__loading-container",spinner:"esri-feature__loading-spinner"},uK={title:!0,content:!0,lastEditedInfo:!0};let ro=class extends lme(Ia){constructor(e,t){super(e,t),this._contentWidgets=[],this.graphic=null,this.defaultPopupTemplateEnabled=!1,this.headingLevel=2,this.label=void 0,this.messages=null,this.messagesCommon=null,this.messagesURIUtils=null,this.spatialReference=null,this.title=null,this.visibleElements=I({},uK),this.map=null,this.view=null,this.viewModel=new sq}initialize(){this.own(Wt(this,"viewModel.contentViewModels",()=>this._setupContentWidgets()))}loadDependencies(){return import("./calcite-notice.9c2847fd.js")}destroy(){this._destroyContentWidgets()}castVisibleElements(e){return I(I({},uK),e)}render(){const{state:e}=this.viewModel,t=le("div",{class:Qn.container,key:"container"},this.renderTitle(),e==="error"?this.renderError():e==="loading"?this.renderLoading():this.renderContentContainer());return le("div",{class:this.classes(Qn.base,Qn.esriWidget)},t)}setActiveMedia(e,t){this.viewModel.setActiveMedia(e,t)}nextMedia(e){this.viewModel.nextMedia(e)}previousMedia(e){this.viewModel.previousMedia(e)}renderError(){const{messagesCommon:e,messages:t,visibleElements:i}=this;return le("calcite-notice",{active:!0,color:"red",icon:"exclamation-mark-circle",scale:"s"},i.title?le("div",{key:"error-title",slot:"title"},e.errorMessage):null,le("div",{key:"error-message",slot:"message"},t.loadingError))}renderLoading(){return le("div",{key:"loading-container",class:Qn.loadingSpinnerContainer},le("span",{class:this.classes(Qn.iconLoading,Qn.spinner)}))}renderContentContainer(){const{visibleElements:e}=this;return e.content?le("div",{class:Qn.main},[this.renderContent(),this.renderLastEditInfo()]):null}renderTitle(){const{visibleElements:e,title:t}=this;return e.title?le(uH,{level:this.headingLevel,class:Qn.title,innerHTML:t}):null}renderContent(){const e=this.viewModel.content,t="content";if(!e)return null;if(Array.isArray(e))return e.length?le("div",{key:`${t}-content-elements`},e.map(this.renderContentElement,this)):null;if(typeof e=="string"){const i=this._contentWidgets[0];return!i||i.destroyed?null:le("div",{key:`${t}-content`},i.render())}return this.renderNodeContent(e)}renderContentElement(e,t){const{visibleElements:i}=this;if(typeof i.content!="boolean"&&!i.content[e.type])return null;switch(e.type){case"attachments":return this.renderAttachments(t);case"custom":return this.renderCustom(e,t);case"fields":return this.renderFields(t);case"media":return this.renderMedia(t);case"text":return this.renderText(e,t);case"expression":return this.renderExpression(t);default:return null}}renderAttachments(e){const t=this._contentWidgets[e];if(!t||t.destroyed)return null;const{state:i,attachmentInfos:r}=t.viewModel;return i==="loading"||r.length>0?le("div",{key:this._buildKey("attachments-element",e),class:this.classes(Qn.contentElement)},t.render()):null}renderExpression(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:le("div",{key:this._buildKey("expression-element",e),class:Qn.contentElement},t.render())}renderCustom(e,t){const{creator:i}=e,r=this._contentWidgets[t];return!r||r.destroyed?null:i?le("div",{key:this._buildKey("custom-element",t),class:Qn.contentElement},r.render()):null}renderFields(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:le("div",{key:this._buildKey("fields-element",e),class:Qn.contentElement},t.render())}renderMedia(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:le("div",{key:this._buildKey("media-element",e),class:Qn.contentElement},t.render())}renderLastEditInfo(){const{visibleElements:e,messages:t}=this,{lastEditInfo:i}=this.viewModel;if(!i||!e.lastEditedInfo)return null;const{date:r,user:s}=i,n=i.type==="edit"?s?t.lastEditedByUser:t.lastEdited:s?t.lastCreatedByUser:t.lastCreated,o=xf(n,{date:r,user:s});return le("div",{key:"edit-info-element",class:this.classes(Qn.lastEditedInfo,Qn.contentElement)},o)}renderText(e,t){const i=e.text,r=this._contentWidgets[t];return!r||r.destroyed?null:i?le("div",{key:this._buildKey("text-element",t),class:this.classes(Qn.contentElement,Qn.text)},r.render()):null}_buildKey(e,...t){return`${e}__${this.get("viewModel.graphic.uid")||"0"}-${t.join("-")}`}_destroyContentWidget(e){e&&(e.viewModel=null,!e.destroyed&&e.destroy())}_destroyContentWidgets(){this._contentWidgets.forEach(e=>this._destroyContentWidget(e)),this._contentWidgets=[]}_setupContentWidgets(){this._destroyContentWidgets();const{headingLevel:e,visibleElements:t}=this,i=this.get("viewModel.content"),{contentViewModels:r}=this.viewModel;if(Array.isArray(i))i.forEach((s,n)=>{s.type==="attachments"&&(this._contentWidgets[n]=new N$e({displayType:s.displayType,headingLevel:t.title?e+1:e,viewModel:r[n]})),s.type==="fields"&&(this._contentWidgets[n]=new Ade({viewModel:r[n]})),s.type==="media"&&(this._contentWidgets[n]=new npe({viewModel:r[n]})),s.type==="text"&&(this._contentWidgets[n]=new OI({viewModel:r[n]})),s.type==="custom"&&(this._contentWidgets[n]=new OI({viewModel:r[n]})),s.type==="expression"&&(this._contentWidgets[n]=new Gze({viewModel:r[n]}))},this);else{const s=r[0];s&&!s.destroyed&&(this._contentWidgets[0]=new OI({viewModel:s}))}this.scheduleRender()}};u([mt("viewModel.graphic")],ro.prototype,"graphic",void 0),u([mt("viewModel.defaultPopupTemplateEnabled")],ro.prototype,"defaultPopupTemplateEnabled",void 0),u([d()],ro.prototype,"headingLevel",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],ro.prototype,"label",void 0),u([d(),fl("esri/widgets/Feature/t9n/Feature")],ro.prototype,"messages",void 0),u([d(),fl("esri/t9n/common")],ro.prototype,"messagesCommon",void 0),u([d(),fl("esri/widgets/support/t9n/uriUtils")],ro.prototype,"messagesURIUtils",void 0),u([mt("viewModel.spatialReference")],ro.prototype,"spatialReference",void 0),u([mt("viewModel.title")],ro.prototype,"title",void 0),u([d()],ro.prototype,"visibleElements",void 0),u([At("visibleElements")],ro.prototype,"castVisibleElements",null),u([mt("viewModel.map")],ro.prototype,"map",void 0),u([mt("viewModel.view")],ro.prototype,"view",void 0),u([d({type:sq})],ro.prototype,"viewModel",void 0),ro=u([P("esri.widgets.Feature")],ro);const Wze=ro;let r_=class extends xr.EventedAccessor{constructor(e){super(e),this._anchorHandles=new Ut,this.location=null,this.screenLocation=null,this.screenLocationEnabled=!1,this.view=null,this._anchorHandles.add([nr(this,["screenLocationEnabled","location","view.size","view.stationary"],()=>this._updateScreenPointAndHandle()),nr(this,["view","view.ready"],()=>this._wireUpView())])}destroy(){this.view=null,this._anchorHandles&&this._anchorHandles.destroy(),this._anchorHandles=null,this._viewpointHandle=null}_wireUpView(){const e="view";if(this._anchorHandles.remove(e),this._viewpointHandle=null,!this.get("view.ready"))return;this._setScreenLocation();const{view:t}=this,i=t.type==="3d"?"camera":"viewpoint",r=FPe(t,i,()=>this._viewpointChange());this._anchorHandles.add(r,e),this._viewpointHandle=r,this._toggleWatchingViewpoint()}_viewpointChange(){this._setScreenLocation(),this.emit("view-change")}_updateScreenPointAndHandle(){this._setScreenLocation(),this._toggleWatchingViewpoint()}_toggleWatchingViewpoint(){const{_viewpointHandle:e,location:t,screenLocationEnabled:i}=this;!e||(t&&i?e.resume():e.pause())}_setScreenLocation(){const{location:e,view:t,screenLocationEnabled:i}=this,r=this.get("view.ready"),s=i&&r&&_(e)?t.toScreen(e):null;this._set("screenLocation",s)}};u([d()],r_.prototype,"location",void 0),u([d({readOnly:!0})],r_.prototype,"screenLocation",void 0),u([d()],r_.prototype,"screenLocationEnabled",void 0),u([d()],r_.prototype,"view",void 0),r_=u([P("esri.widgets.support.AnchorElementViewModel")],r_);const cme=r_,Xze="esri.widgets.CompassViewModel";let i$=class extends cme{constructor(e){super(e),this.visible=!1}};u([d()],i$.prototype,"visible",void 0),i$=u([P(Xze)],i$);const ume=i$,PU={base:"esri-spinner",spinnerStart:"esri-spinner--start",spinnerFinish:"esri-spinner--finish"};let s_=class extends Ia{constructor(e,t){super(e,t),this._animationDelay=500,this._animationPromise=null,this.location=null,this.view=null,this.viewModel=new ume,this.visible=!1}initialize(){this.own([nr(this,"visible",e=>this._visibleChange(e))])}destroy(){this._animationPromise=null}show(e){const{location:t,promise:i}=e;t&&(this.viewModel.location=t),this.visible=!0;const r=()=>this.hide();i&&i.catch(()=>{}).then(r)}hide(){this.visible=!1}render(){const{visible:e}=this,{screenLocation:t}=this.viewModel,i=!!t,r=e&&i,s=!e&&i,n={[PU.spinnerStart]:r,[PU.spinnerFinish]:s},o=this._getPositionStyles();return le("div",{class:this.classes(PU.base,n),styles:o})}_visibleChange(e){if(e)return void(this.viewModel.screenLocationEnabled=!0);const t=AT(this._animationDelay);this._animationPromise=t,t.catch(()=>{}).then(()=>{this._animationPromise===t&&(this.viewModel.screenLocationEnabled=!1,this._animationPromise=null)})}_getPositionStyles(){const{screenLocation:e,view:t}=this.viewModel;if(!t||R(e))return{};const{padding:i}=t;return{left:e.x-i.left+"px",top:e.y-i.top+"px"}}};u([mt("viewModel.location")],s_.prototype,"location",void 0),u([mt("viewModel.view")],s_.prototype,"view",void 0),u([d({type:ume})],s_.prototype,"viewModel",void 0),u([mt("viewModel.visible")],s_.prototype,"visible",void 0),s_=u([P("esri.widgets.Spinner")],s_);const Yze=s_;var hK;(function(e){e[e.size=22]="size",e[e.lineWidth=50]="lineWidth",e[e.maxSize=120]="maxSize",e[e.maxOutlineSize=80]="maxOutlineSize",e[e.tallSymbolWidth=20]="tallSymbolWidth"})(hK||(hK={}));class Zze{constructor(t,i){this._storage=new BH,this._storage.maxSize=t,i&&this._storage.registerRemoveFunc("",i)}put(t,i){this._storage.put(t,i,1,1)}pop(t){return this._storage.pop(t)}get(t){return this._storage.get(t)}clear(){this._storage.clearAll()}destroy(){this._storage.destroy()}}function Qze(e){return typeof e=="function"}function syt(e,t,i,r){return Qze(e)?e(t,i,r):e}function nyt(e){return[e.r,e.g,e.b,e.a]}function oyt(e,t,i){const r=` /-,
`,s=l=>{let c=l.length;for(;c--;)if(r.indexOf(l.charAt(c))===-1)return!1;return!0},n=[];let o=0,a=-1;do if(a=t.indexOf("[",o),a>=o){if(a>o){const l=t.substr(o,a-o);n.push([l,null,s(l)])}if(o=a+1,a=t.indexOf("]",o),a>=o){if(a>o){const l=e[t.substr(o,a-o)];l&&n.push([null,l,!1])}o=a+1}}while(a!==-1);if(o<t.length-1){const l=t.substr(o);n.push([l,null,s(l)])}return l=>{let c="",h=null;for(const p of n){const[f,g,y]=p;if(f)y?h=f:(h&&(c+=h,h=null),c+=f);else{const v=l.attributes[g];v&&(h&&(c+=h,h=null),c+=v)}}return Jze(c,i)}}function Jze(e,t){switch(typeof e!="string"&&(e=String(e)),t){case"LowerCase":return e.toLowerCase();case"Allcaps":return e.toUpperCase();default:return e}}function ayt(e,t,i,r,s,n,o=!0){const a=t/s,l=i/n,c=Math.ceil(a/2),h=Math.ceil(l/2);for(let p=0;p<n;p++)for(let f=0;f<s;f++){const g=4*(f+(o?n-p-1:p)*s);let y=0,v=0,b=0,w=0,S=0,T=0,A=0;const C=(p+.5)*l;for(let O=Math.floor(p*l);O<(p+1)*l;O++){const L=Math.abs(C-(O+.5))/h,U=(f+.5)*a,N=L*L;for(let z=Math.floor(f*a);z<(f+1)*a;z++){let V=Math.abs(U-(z+.5))/c;const B=Math.sqrt(N+V*V);B>=-1&&B<=1&&(y=2*B*B*B-3*B*B+1,y>0&&(V=4*(z+O*t),A+=y*e[V+3],b+=y,e[V+3]<255&&(y=y*e[V+3]/250),w+=y*e[V],S+=y*e[V+1],T+=y*e[V+2],v+=y))}}r[g]=w/v,r[g+1]=S/v,r[g+2]=T/v,r[g+3]=A/b}}function lyt(e){return e?{r:e[0],g:e[1],b:e[2],a:e[3]/255}:{r:0,g:0,b:0,a:0}}function Kze(e){return e.type==="CIMMarkerPlacementAlongLineRandomSize"||e.type==="CIMMarkerPlacementAlongLineSameSize"||e.type==="CIMMarkerPlacementAlongLineVariableSize"||e.type==="CIMMarkerPlacementAtExtremities"||e.type==="CIMMarkerPlacementAtMeasuredUnits"||e.type==="CIMMarkerPlacementAtRatioPositions"||e.type==="CIMMarkerPlacementOnLine"||e.type==="CIMMarkerPlacementOnVertices"}const cyt=e=>isNaN(e)||!e?0:e,uyt=e=>{if(!e)return!1;for(const t of e)switch(t.type){case"CIMGeometricEffectBuffer":case"CIMGeometricEffectOffset":return!0}return!1};function hyt(){return import("./geometryEngineJSON.1eda2436.js")}function hme(e,t,i,r){if(e.type!=="CIMTextSymbol"){if(i&&e.effects)for(const s of e.effects)i6e(s,t);if(e.symbolLayers)for(const s of e.symbolLayers)switch(s.type){case"CIMPictureMarker":case"CIMVectorMarker":e6e(s,t,r);break;case"CIMPictureStroke":case"CIMSolidStroke":r!=null&&r.preserveOutlineWidth||!s.width||(s.width*=t);break;case"CIMPictureFill":s.height&&(s.height*=t),s.offsetX&&(s.offsetX*=t),s.offsetY&&(s.offsetY*=t);break;case"CIMHatchFill":hme(s.lineSymbol,t,!0,me(I({},r),{preserveOutlineWidth:!1})),s.offsetX&&(s.offsetX*=t),s.offsetY&&(s.offsetY*=t),s.separation&&(s.separation*=t)}}else e.height*=t}function e6e(e,t,i){if(e.markerPlacement&&t6e(e.markerPlacement,t),e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t),e.anchorPoint&&e.anchorPointUnits==="Absolute"&&(e.anchorPoint={x:e.anchorPoint.x*t,y:e.anchorPoint.y*t}),e.size*=t,e.type==="CIMVectorMarker"&&e.markerGraphics)for(const r of e.markerGraphics)e.scaleSymbolsProportionally||hme(r.symbol,t,!0,i)}function t6e(e,t){switch(Kze(e)&&e.offset&&(e.offset*=t),e.type){case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineSameSize":if(e.customEndingOffset&&(e.customEndingOffset*=t),e.offsetAlongLine&&(e.offsetAlongLine*=t),e.placementTemplate&&e.placementTemplate.length){const i=e.placementTemplate.map(r=>r*t);e.placementTemplate=i}break;case"CIMMarkerPlacementAlongLineVariableSize":if(e.maxRandomOffset&&(e.maxRandomOffset*=t),e.placementTemplate&&e.placementTemplate.length){const i=e.placementTemplate.map(r=>r*t);e.placementTemplate=i}break;case"CIMMarkerPlacementOnLine":e.startPointOffset&&(e.startPointOffset*=t);break;case"CIMMarkerPlacementAtExtremities":e.offsetAlongLine&&(e.offsetAlongLine*=t);break;case"CIMMarkerPlacementAtMeasuredUnits":case"CIMMarkerPlacementOnVertices":break;case"CIMMarkerPlacementAtRatioPositions":e.beginPosition&&(e.beginPosition*=t),e.endPosition&&(e.endPosition*=t);break;case"CIMMarkerPlacementPolygonCenter":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t);break;case"CIMMarkerPlacementInsidePolygon":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t),e.stepX&&(e.stepX*=t),e.stepY&&(e.stepY*=t)}}function i6e(e,t){switch(e.type){case"CIMGeometricEffectArrow":case"CIMGeometricEffectDonut":e.width&&(e.width*=t);break;case"CIMGeometricEffectBuffer":e.size&&(e.size*=t);break;case"CIMGeometricEffectCut":e.beginCut&&(e.beginCut*=t),e.endCut&&(e.endCut*=t),e.middleCut&&(e.middleCut*=t);break;case"CIMGeometricEffectDashes":if(e.customEndingOffset&&(e.customEndingOffset*=t),e.offsetAlongLine&&(e.offsetAlongLine*=t),e.dashTemplate&&e.dashTemplate.length){const i=e.dashTemplate.map(r=>r*t);e.dashTemplate=i}break;case"CIMGeometricEffectExtension":case"CIMGeometricEffectJog":case"CIMGeometricEffectRadial":e.length&&(e.length*=t);break;case"CIMGeometricEffectMove":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t);break;case"CIMGeometricEffectOffset":case"CIMGeometricEffectOffsetTangent":e.offset&&(e.offset*=t);break;case"CIMGeometricEffectRegularPolygon":e.radius&&(e.radius*=t);break;case"CIMGeometricEffectTaperedPolygon":e.fromWidth&&(e.fromWidth*=t),e.length&&(e.length*=t),e.toWidth&&(e.toWidth*=t);break;case"CIMGeometricEffectWave":e.amplitude&&(e.amplitude*=t),e.period&&(e.period*=t)}}new Zze(1e3);new Je([128,128,128]);const dK=/\/resource\/(.*?)\.svg$/,r6e=new Je("white");function s6e(e,t){const i=t.resource.href;return!ue("esri-canvas-svg-support")&&e.styleOrigin&&dK.test(i)?i.replace(dK,"/resource/png/$1.png"):i}function fL(e,t){if(t==null)return e;const i=e.toRgba();return i[3]=i[3]*t,new Je(i)}function n6e(e,t,i){const r=e.symbolLayers;if(!r)return;const s=n=>{const o=_(n)?n:null;return fL(t=t||o||i!=null&&r6e,i)};r.forEach(n=>{if(n.type!=="object"||n.resource.href==null||t)if(n.type==="water")n.color=s(n.color);else{const o=_(n.material)?n.material.color:null,a=s(o);R(n.material)?n.material=new pc({color:a}):n.material.color=a,i!=null&&"outline"in n&&_(n.outline)&&_(n.outline.color)&&(n.outline.color=fL(n.outline.color,i))}})}function o6e(e,t,i){(t=t||e.color)&&(e.color=fL(t,i)),i!=null&&"outline"in e&&e.outline&&e.outline.color&&(e.outline.color=fL(e.outline.color,i))}function IU(e,t,i){e&&(t||i!=null)&&(t&&(t=new Je(t)),jC(e)?n6e(e,t,i):xj(e)&&o6e(e,t,i))}async function a6e(e,t){const i=e.symbolLayers;i&&await JN(i,async r=>l6e(r,t))}async function l6e(e,t){switch(e.type){case"extrude":u6e(e,t);break;case"icon":case"line":case"text":c6e(e,t);break;case"path":d6e(e,t);break;case"object":await h6e(e,t)}}function c6e(e,t){const i=dme(t);_(i)&&(e.size=i)}function dme(e){for(const t of e)if(typeof t=="number")return t;return null}function u6e(e,t){e.size=typeof t[2]=="number"?t[2]:0}async function h6e(e,t){const{resourceSize:i,symbolSize:r}=await p6e(e),s=pme(t,i,r);e.width=aC(t[0],r[0],i[0],s),e.depth=aC(t[1],r[1],i[1],s),e.height=aC(t[2],r[2],i[2],s)}function d6e(e,t){const i=pme(t,up,[e.width,void 0,e.height]);e.width=aC(t[0],e.width,1,i),e.height=aC(t[2],e.height,1,i)}function pme(e,t,i){for(let r=0;r<3;r++){const s=e[r];switch(s){case"symbol-value":return i[r]!=null?i[r]/t[r]:1;case"proportional":break;default:if(s&&t[r])return s/t[r]}}return 1}async function p6e(e){const t=await import("./symbolLayerUtils.45a6b0ac.js"),i=await t.computeObjectLayerResourceSize(e,10),{width:r,height:s,depth:n}=e,o=[r,n,s];let a=1;for(let l=0;l<3;l++)if(o[l]!=null){a=o[l]/i[l];break}for(let l=0;l<3;l++)o[l]==null&&(o[l]=i[l]*a);return{resourceSize:i,symbolSize:o}}function aC(e,t,i,r){switch(e){case"proportional":return i*r;case"symbol-value":return t!=null?t:i;default:return e}}function f6e(e,t){const i=dme(t);if(!R(i))switch(e.type){case"simple-marker":e.size=i;break;case"picture-marker":{const r=e.width/e.height;r>1?(e.width=i,e.height=i*r):(e.width=i*r,e.height=i);break}case"simple-line":e.width=i;break;case"text":e.font.size=i}}async function m6e(e,t){if(e&&t)return jC(e)?a6e(e,t):void(xj(e)&&f6e(e,t))}function g6e(e,t,i){if(e&&t!=null)if(jC(e)){const r=e.symbolLayers;r&&r.forEach(s=>{if(s&&s.type==="object")switch(i){case"tilt":s.tilt=t;break;case"roll":s.roll=t;break;default:s.heading=t}})}else xj(e)&&(e.type!=="simple-marker"&&e.type!=="picture-marker"&&e.type!=="text"||(e.angle=t))}function fme(e){return e&&"opacity"in e?e.opacity*fme(e.parent):1}async function y6e(e,t){var i,r;if(!e)return;const s=e.sourceLayer,n=(i=_(t)&&(r=t.useSourceLayer)!=null&&r?s:e.layer)!=null?i:s,o=fme(n);if(_(e.symbol)&&(!_(t)||t.ignoreGraphicSymbol!==!0)){const S=e.symbol.type==="web-style"?await e.symbol.fetchSymbol(_(t)?t.abortOptions:null):e.symbol.clone();return IU(S,null,o),S}const a=_(t)&&t.renderer||n&&"renderer"in n&&n.renderer;let l=a&&"getSymbolAsync"in a?await a.getSymbolAsync(e,t):null;if(!l)return;if(l=l.type==="web-style"?await l.fetchSymbol(_(t)?t.abortOptions:null):l.clone(),!("visualVariables"in a)||!a.visualVariables||!a.visualVariables.length)return IU(l,null,o),l;if("arcadeRequiredForVisualVariables"in a&&a.arcadeRequiredForVisualVariables&&(R(t)||R(t.arcade))){const S=I({},t);S.arcade=await wp(),t=S}const c=await Promise.resolve().then(function(){return a5e}),h=[],p=[],f=[],g=[];for(const S of a.visualVariables)switch(S.type){case"color":h.push(S);break;case"opacity":p.push(S);break;case"rotation":g.push(S);break;case"size":S.target||f.push(S)}const y=!!h.length&&h[h.length-1],v=y?c.getColor(y,e,t):null,b=!!p.length&&p[p.length-1];let w=b?c.getOpacity(b,e,t):null;if(o!=null&&(w=w!=null?w*o:o),IU(l,v,w),f.length){const S=c.getAllSizes(f,e,t);await m6e(l,S)}for(const S of g)g6e(l,c.getRotationAngle(S,e,t),S.axis);return l}class pK{constructor(t=i=>i.values().next().value){this._peeker=t,this._items=new Set}get length(){return this._items.size}clear(){this._items.clear()}last(){if(this._items.size===0)return;let t;for(t of this._items);return t}peek(){if(this._items.size!==0)return this._peeker(this._items)}push(t){this.contains(t)||this._items.add(t)}contains(t){return this._items.has(t)}pop(){if(this.length===0)return;const t=this.peek();return this._items.delete(t),t}popLast(){if(this.length===0)return;const t=this.last();return this._items.delete(t),t}remove(t){this._items.delete(t)}filter(t){return this._items.forEach(i=>{t(i)||this._items.delete(i)}),this}}const v6e=ue("mac")?"Meta":"Ctrl",kF={8:"Backspace",9:"Tab",13:"Enter",27:"Escape",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete"};for(let e=48;e<58;e++)kF[e]=String.fromCharCode(e);for(let e=1;e<25;e++)kF[111+e]=`F${e}`;for(let e=65;e<91;e++)kF[e]=[String.fromCharCode(e+32),String.fromCharCode(e)];function _6e(e){if(e.key!==void 0)return A_(e);const t=kF[e.keyCode];return Array.isArray(t)?e.shiftKey?t[1]:t[0]:t}function b6e(e){switch(e){case"Ctrl":case"Alt":case"Shift":case"Meta":case"Primary":return!0}return!1}class w6e{constructor(t,i=[]){this.eventType=t,this.keyModifiers=i}matches(t){if(t.type!==this.eventType)return!1;if(this.keyModifiers.length===0)return!0;const i=t.modifiers;for(const r of this.keyModifiers)if(!i.has(r))return!1;return!0}}const fK=he.getLogger("esri.views.input.InputHandler");class Yn{constructor(t){this._manager=null,this._incoming={},this._outgoing={},this._incomingEventMatches=null,this._incomingEventTypes=null,this._outgoingEventTypes=null,this._hasSideEffects=t}get incomingEventMatches(){if(!this._incomingEventMatches){this._incomingEventMatches=[];for(const t in this._incoming){const i=this._incoming[t];for(const r of i)this._incomingEventMatches.push(r.match)}}return this._incomingEventMatches}get incomingEventTypes(){return this._incomingEventTypes||(this._incomingEventTypes=this.incomingEventMatches.map(t=>t.eventType)),this._incomingEventTypes}get outgoingEventTypes(){return this._outgoingEventTypes||(this._outgoingEventTypes=Object.keys(this._outgoing)),this._outgoingEventTypes}get hasSideEffects(){return this._hasSideEffects}get hasPendingInputs(){return!1}onInstall(t){this._manager?fK.error("This InputHandler has already been registered with an InputManager"):(t.setEventCallback(i=>this._handleEvent(i)),t.setUninstallCallback(()=>this._onUninstall()),this._manager=t)}onUninstall(){}registerIncoming(t,i,r){let s;typeof i=="function"?(r=i,s=[]):s=i||[];const n=typeof t=="string"?new w6e(t,s):t,o=()=>{this._incomingEventTypes=null,this._incomingEventMatches=null},a=h=>{const p=this._incoming[h.match.eventType];if(p){const f=p.indexOf(h);p.splice(f,1),o(),this._manager&&this._manager.updateDependencies()}},l=new x6e(n,r,{onPause:a,onRemove:a,onResume:h=>{const p=this._incoming[h.match.eventType];p&&p.indexOf(h)===-1&&(p.push(h),o(),this._manager&&this._manager.updateDependencies())}});let c=this._incoming[n.eventType];return c||(c=[],this._incoming[n.eventType]=c),c.push(l),o(),this._manager&&this._manager.updateDependencies(),l}registerOutgoing(t){if(this._outgoing[t])throw Error("There is already a callback registered for this outgoing InputEvent: "+t);const i=new T6e(t,{onEmit:(r,s,n,o)=>{this._manager.emit(r.eventType,s,n,o)},onRemove:r=>{delete this._outgoing[r.eventType],this._manager.updateDependencies()}});return this._outgoing[t]=i,this._outgoingEventTypes=null,this._manager&&this._manager.updateDependencies(),i}startCapturingPointer(t){this._manager.setPointerCapture(t,!0)}stopCapturingPointer(t){this._manager.setPointerCapture(t,!1)}refreshHasPendingInputs(){this._manager.refreshHasPendingInputs()}_onUninstall(){this._manager?(this.onUninstall(),this._manager=null):fK.error("This InputHandler is not registered with an InputManager")}_handleEvent(t){const i=this._incoming[t.type];if(i){for(const r of i)if(r.match.matches(t)&&(r.callback(t),t.shouldStopPropagation()))break}}}class x6e{constructor(t,i,r){this.match=t,this._callback=i,this._handler=r}pause(){this._handler.onPause(this)}resume(){this._handler.onResume(this)}remove(){this._handler.onRemove(this)}get callback(){return this._callback}}class T6e{constructor(t,i){this.eventType=t,this._removed=!1,this._handler=i}emit(t,i,r){this._removed||this._handler.onEmit(this,t,i,r)}remove(){this._removed=!0,this._handler.onRemove(this)}}class S6e extends Yn{constructor(t){super(!0),this._onChange=t,this._value="mouse",this.registerIncoming("pointer-down",i=>{const r=i.data.native.pointerType==="touch";this._setValue(r?"touch":"mouse")}),this._moveHandler=this.registerIncoming("pointer-move",i=>{const r=i.data.native.pointerType==="touch";this._setValue(r?"touch":"mouse")}),this._moveHandler.pause()}_setValue(t){t!==this._value&&(t==="touch"?this._moveHandler.resume():this._moveHandler.pause(),this._value=t,this._onChange(t))}}const $U=he.getLogger("esri.views.input.InputManager");let n_=class extends we{constructor(e){super(e),this._pointerCaptures=new Map,this._nameToGroup={},this._handlers=[],this._currentPropagation=null,this._updateDependenciesAfterPropagation=!1,this._sourceEvents=new Set,this._keyModifiers=new Set,this._activeKeyModifiers=new Set,this._stoppedPropagationEventIds=new Set,this.primaryKey=v6e,this.latestPointerType="mouse",this.test={timestamp:void 0,hasCurrentPropagation:()=>!!this._currentPropagation}}initialize(){this.eventSource.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers()}destroy(){const e=Object.keys(this._nameToGroup);for(const t of e)this.uninstallHandlers(t);this.eventSource=null,this._currentPropagation=null}get hasPendingInputs(){return this._handlers.some(e=>e.handler.hasPendingInputs)}installHandlers(e,t,i=a0.INTERNAL){if(this._nameToGroup[e])return void $U.error("There is already an InputHandler group registered under the name `"+e+"`");if(t.length===0)return void $U.error("Can't register a group of zero handlers");const r={name:e,handlers:t.map(s=>({handler:s,active:!0,removed:!1,priorityIndex:0,groupPriority:i,eventCallback:null,uninstallCallback:null}))};this._nameToGroup[e]=r;for(let s=r.handlers.length-1;s>=0;s--){const n=r.handlers[s];this._handlers.push(n),n.handler.onInstall({updateDependencies:()=>{this.updateDependencies()},emit:(o,a,l,c,h)=>{this._emitInputEvent(n.priorityIndex+1,o,a,l,h,c)},setPointerCapture:(o,a)=>{this._setPointerCapture(r,n,o,a)},setEventCallback:o=>{n.eventCallback=o},setUninstallCallback:o=>{n.uninstallCallback=o},refreshHasPendingInputs:()=>{this.notifyChange("hasPendingInputs")}})}this.updateDependencies()}uninstallHandlers(e){const t=this._nameToGroup[e];t?(t.handlers.forEach(i=>{i.removed=!0,i.uninstallCallback()}),delete this._nameToGroup[e],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):$U.error("There is no InputHandler group registered under the name `"+e+"`")}hasHandlers(e){return this._nameToGroup[e]!==void 0}updateDependencies(){if(this._currentPropagation)return void(this._updateDependenciesAfterPropagation=!0);this._updateDependenciesAfterPropagation=!1;const e=new Set,t=new Set;this._handlersPriority=[];for(let i=this._handlers.length-1;i>=0;i--){const r=this._handlers[i];r.priorityIndex=i,this._handlersPriority.push(r)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(let i=this._handlersPriority.length-1;i>=0;i--){const r=this._handlersPriority[i];r.priorityIndex=i;let s=r.handler.hasSideEffects;if(!s){for(const n of r.handler.outgoingEventTypes)if(e.has(n)){s=!0;break}}if(s)for(const n of r.handler.incomingEventMatches){e.add(n.eventType);for(const o of n.keyModifiers)b6e(o)||t.add(o)}r.active=s}this._sourceEvents=e,this._keyModifiers=t,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)}_setLatestPointerType(e){this._set("latestPointerType",e)}_onEventReceived(e,t){if(e==="pointer-capture-lost"){const s=t;this._pointerCaptures.delete(s.native.pointerId)}this._updateKeyModifiers(e,t);const i=this.test.timestamp!=null?this.test.timestamp:t.native?t.native.timestamp:void 0,r=t.native?t.native.cancelable:void 0;this._emitInputEventFromSource(e,t,i,r)}_updateKeyModifiers(e,t){if(!t)return;let i=!1;const r=()=>{if(!i){const o=new Set;this._activeKeyModifiers.forEach(a=>{o.add(a)}),this._activeKeyModifiers=o,i=!0}},s=(o,a)=>{a&&!this._activeKeyModifiers.has(o)?(r(),this._activeKeyModifiers.add(o)):!a&&this._activeKeyModifiers.has(o)&&(r(),this._activeKeyModifiers.delete(o))};if(e==="key-down"||e==="key-up"){const o=t.key;this._keyModifiers.has(o)&&s(o,e==="key-down")}const n=t.native;s("Alt",!(!n||!n.altKey)),s("Ctrl",!(!n||!n.ctrlKey)),s("Shift",!(!n||!n.shiftKey)),s("Meta",!(!n||!n.metaKey)),s("Primary",this._activeKeyModifiers.has(this.primaryKey))}_installRecognizers(){this._latestPointerTypeHandler=new S6e(e=>this._setLatestPointerType(e)),this.recognizers.length>0&&this.installHandlers("default",this.recognizers,a0.INTERNAL),this.installHandlers("input-manager-logic",[this._latestPointerTypeHandler],a0.INTERNAL)}_setPointerCapture(e,t,i,r){const s=e.name+"-"+t.priorityIndex,n=this._pointerCaptures.get(i.pointerId)||new Set;this._pointerCaptures.set(i.pointerId,n),r?(n.add(s),n.size===1&&this.eventSource&&this.eventSource.setPointerCapture(i,!0)):n.has(s)&&(n.delete(s),n.size===0&&(this._pointerCaptures.delete(i.pointerId),this.eventSource&&this.eventSource.setPointerCapture(i,!1)))}_garbageCollectRemovedHandlers(){this._handlers=this._handlers.filter(e=>!e.removed),this.updateDependencies()}_emitInputEventFromSource(e,t,i,r){this._emitInputEvent(0,e,t,i,r)}_emitInputEvent(e,t,i,r,s,n){const o=r!==void 0?r:this._currentPropagation?this._currentPropagation.timestamp:performance.now(),a=s!==void 0&&s,l={event:new E6e(t,i,o,n||this._activeKeyModifiers,a),priorityIndex:e};this._currentPropagation?this._currentPropagation.events.push(l):this._doNewPropagation(l)}_doNewPropagation(e){this._currentPropagation={events:new pK,currentHandler:null,needsHandlerGarbageCollect:!1,timestamp:e.event.timestamp},this._currentPropagation.events.push(e),this._continuePropagation()}_continuePropagation(){const e=this._currentPropagation;if(e){for(;this._currentPropagation.events.length>0;){const{event:t,priorityIndex:i}=this._currentPropagation.events.pop(),r=t.data&&t.data.eventId;if(!(r!=null&&this._stoppedPropagationEventIds.has(r)))for(e.currentHandler=this._handlersPriority[i];e.currentHandler;){if(e.currentHandler.removed)e.needsHandlerGarbageCollect=!0;else{if(e.currentHandler.active&&!t.shouldStopPropagation()&&e.currentHandler.eventCallback(t),t.shouldStopPropagation()){r!=null&&this._stoppedPropagationEventIds.add(r);break}if(t.shouldPausePropagation(()=>this._continuePropagation()))return void this._pausePropagation({event:t,priorityIndex:e.currentHandler.priorityIndex+1})}e.currentHandler=this._handlersPriority[e.currentHandler.priorityIndex+1]}}e.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this.hasPendingInputs||this._stoppedPropagationEventIds.clear(),this._currentPropagation=null,this._updateDependenciesAfterPropagation&&this.updateDependencies()}}_pausePropagation(e){const t=new pK;for(t.push(e);this._currentPropagation.events.length;)t.push(this._currentPropagation.events.pop());this._currentPropagation.events=t,this._currentPropagation.currentHandler=null}_compareHandlerPriority(e,t){if(e.handler.hasSideEffects!==t.handler.hasSideEffects)return e.handler.hasSideEffects?1:-1;if(e.groupPriority!==t.groupPriority)return e.groupPriority>t.groupPriority?-1:1;for(const i of e.handler.incomingEventMatches)for(const r of t.handler.incomingEventMatches){if(i.eventType!==r.eventType)continue;const s=i.keyModifiers.filter(n=>r.keyModifiers.indexOf(n)!==-1);if(s.length===i.keyModifiers.length!=(s.length===r.keyModifiers.length))return i.keyModifiers.length>r.keyModifiers.length?-1:1}return e.priorityIndex>t.priorityIndex?-1:1}_sortHandlersPriority(e){const t=[];for(const i of e){let r=0;for(;r<t.length&&this._compareHandlerPriority(i,t[r])>=0;)r++;t.splice(r,0,i)}return t}get debug(){const e=t=>{const i=this._setPointerCapture;this._setPointerCapture=()=>{},t(),this._setPointerCapture=i};return{injectEvent:(t,i)=>{e(()=>{this._onEventReceived(t,i)})},disablePointerCapture:e}}};u([d({readOnly:!0})],n_.prototype,"hasPendingInputs",null),u([d()],n_.prototype,"eventSource",void 0),u([d()],n_.prototype,"recognizers",void 0),u([d({readOnly:!0})],n_.prototype,"latestPointerType",void 0),n_=u([P("esri.views.input.InputManager")],n_);class E6e{constructor(t,i,r,s,n){this.type=t,this.data=i,this.timestamp=r,this.modifiers=s,this.cancelable=n,this._propagationState=by.NONE,this._resumeCallback=null}stopPropagation(){this._propagationState|=by.STOPPED}shouldStopPropagation(){return(this._propagationState&by.STOPPED)!=0}async(t){this._propagationState|=by.PAUSED;const i=(r,s)=>{this._propagationState&=~by.PAUSED;const n=this._resumeCallback;if(this._resumeCallback=null,n&&n(),s)throw r;return r};return(typeof t=="function"?t():t).then(r=>i(r,!1),r=>i(r,!0))}shouldPausePropagation(t){return!!(this._propagationState&by.PAUSED)&&(this._resumeCallback=t,!0)}preventDefault(){this.data.native.preventDefault()}}var by;(function(e){e[e.NONE=0]="NONE",e[e.STOPPED=1]="STOPPED",e[e.PAUSED=2]="PAUSED"})(by||(by={}));const a0={DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3};function A6e(e){return e&&typeof e.highlight=="function"}function C6e(e){return e&&typeof e.maskOccludee=="function"}function dyt(e,t,i){return R(e)||e>i&&(t===0||e<t)}function pyt(e,t){return e>0||t>0}function fyt(e){var t,i;const r=e.effectiveScaleRange;return{minScale:(t=r==null?void 0:r.minScale)!=null?t:0,maxScale:(i=r==null?void 0:r.maxScale)!=null?i:0}}const zF={iconZoom:"esri-icon-zoom-in-magnifying-glass",iconTrash:"esri-icon-trash",iconBrowseClusteredFeatures:"esri-icon-table"},Z_=new IS({id:"zoom-to-feature",title:"{messages.zoom}",className:zF.iconZoom}),mK=new IS({id:"remove-selected-feature",title:"{messages.remove}",className:zF.iconTrash}),Mx=new IS({id:"zoom-to-clustered-features",title:"{messages.zoom}",className:zF.iconZoom}),Px=new IS({id:"browse-clustered-features",title:"{messages.browseClusteredFeatures}",className:zF.iconBrowseClusteredFeatures}),R6e="esri.widgets.Popup.PopupViewModel",x0=he.getLogger(R6e),O6e=function(e){const{event:t,view:i}=e,{action:r}=t,s=i&&i.popup;if(!r)return Promise.reject(new q("trigger-action:missing-arguments","Event has no action"));if(!s)return Promise.reject(new q("trigger-action:missing-arguments","view.popup is missing"));const{disabled:n,id:o}=r;if(!o)return Promise.reject(new q("trigger-action:invalid-action","action.id is missing"));if(n)return Promise.reject(new q("trigger-action:invalid-action","Action is disabled"));if(o===Z_.id)return P6e(s.viewModel).catch(a6);if(o===Mx.id)return I6e(s.viewModel);if(o===Px.id)return s.featureMenuOpen=!s.featureMenuOpen,s.viewModel.browseClusterEnabled=!s.viewModel.browseClusterEnabled,Promise.resolve();if(s.viewModel.browseClusterEnabled=!1,o===mK.id){s.close();const{selectedFeature:a}=s;if(!a)return Promise.reject(new q(`trigger-action:${mK.id}`,"selectedFeature is required",{selectedFeature:a}));const{sourceLayer:l}=a;return l?l.remove(a):i.graphics.remove(a),Promise.resolve()}return Promise.resolve()};function mme(e){const{selectedFeature:t,location:i,view:r}=e;return r?r.type==="3d"?t||i:e.get("selectedFeature.geometry")||i:null}function M6e(e,t){if((t==null?void 0:t.type)!=="3d"||!e||e.declaredClass!=="esri.Graphic")return!0;const i=t.getViewForGraphic(e);if(i&&"whenGraphicBounds"in i){let r=!1;return i.whenGraphicBounds(e,{useViewElevation:!0}).then(s=>{r=!s||!s.boundingBox||s.boundingBox[0]===s.boundingBox[3]&&s.boundingBox[1]===s.boundingBox[4]&&s.boundingBox[2]===s.boundingBox[5]}).catch(()=>{const s=new q("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:e});x0.error(s)}),r}return!0}async function P6e(e){const{location:t,selectedFeature:i,view:r,zoomFactor:s}=e,n=mme(e);if(!n){const c=new q("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:n,view:r});return x0.error(c),Promise.reject(c)}const o=r.scale/s,a=e.get("selectedFeature.geometry")||t,l=a&&a.type==="point"&&M6e(i,r);Z_.active=!0,Z_.disabled=!0;try{await e.view.goTo({target:n,scale:l?o:void 0})}finally{Z_.active=!1,Z_.disabled=!1,e.zoomToLocation=null,l&&(e.location=a)}}async function I6e(e){const{selectedFeature:t,view:i}=e;if((i==null?void 0:i.type)!=="2d"){const a=new q("zoomToCluster:invalid-view","View must be 2d MapView.",{view:i});throw x0.error(a),a}if(!t.isAggregate){const a=new q("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:t});throw x0.error(a),a}const r=t.sourceLayer,s=await i.whenLayerView(r),n=s.createQuery();n.aggregateIds=[t.getObjectId()],Mx.active=!0,Mx.disabled=!0;const{extent:o}=await s.queryExtent(n);await i.goTo({target:o}),Mx.active=!1,Mx.disabled=!1}async function $6e(e){const{selectedFeature:t,view:i}=e;if((i==null?void 0:i.type)!=="2d"){const a=new q("displayClusterExtent:invalid-view","View must be 2d MapView.",{view:i});throw x0.error(a),a}if(!t.isAggregate){const a=new q("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:t});throw x0.error(a),a}const r=t.sourceLayer,s=await i.whenLayerView(r),n=s.createQuery();n.aggregateIds=[t.getObjectId()];const{extent:o}=await s.queryExtent(n);e.selectedClusterBoundaryFeature.geometry=o,i.graphics.add(e.selectedClusterBoundaryFeature)}async function D6e(e){const{selectedFeature:t,view:i}=e;if((i==null?void 0:i.type)!=="2d"){const a=new q("browseAggregateFeatures:invalid-view","View must be 2d MapView.",{view:i});throw x0.error(a),a}if(!t.isAggregate){const a=new q("browseAggregateFeatures:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:t});throw x0.error(a),a}const r=t.sourceLayer,s=await i.whenLayerView(r),n=s.createQuery();n.aggregateIds=[t.getObjectId()],Px.active=!0,Px.disabled=!0;const{features:o}=await s.queryFeatures(n);Px.active=!1,Px.disabled=!1,i.popup.open({features:[t].concat(o),featureMenuOpen:!0})}function L6e(e){var t;(t=e.selectedFeature)!=null&&t.isAggregate&&(e.features=e.features.filter(i=>i.isAggregate))}const gme=e=>{let t=class extends e{constructor(...i){super(...i),this.goToOverride=null,this.view=null}callGoTo(i){const{view:r}=this;return this.goToOverride?this.goToOverride(r,i):r.goTo(i.target,i.options)}};return u([d()],t.prototype,"goToOverride",void 0),u([d()],t.prototype,"view",void 0),t=u([P("esri.widgets.support.GoTo")],t),t},lC=it.ofType({key:"type",defaultKeyValue:"button",base:UN,typeMap:{button:IS,toggle:wle}}),N6e=()=>[Z_.clone()],F6e=()=>[Mx.clone(),Px.clone()],yme="esri.widgets.Popup.PopupViewModel",gK=he.getLogger(yme);let li=class extends gme(cme){constructor(e){super(e),this._handles=new Ut,this._pendingPromises=new Set,this._fetchFeaturesController=null,this._selectedClusterFeature=null,this.featurePage=null,this.actions=new lC,this.defaultPopupTemplateEnabled=!1,this.autoCloseEnabled=!1,this.autoOpenEnabled=!0,this.browseClusterEnabled=!1,this.content=null,this.featuresPerPage=20,this.featureViewModelAbilities=null,this.featureViewModels=[],this.highlightEnabled=!0,this.includeDefaultActions=!0,this.selectedClusterBoundaryFeature=new qo({symbol:new ub({outline:{width:1.5,color:"cyan"},style:"none"})}),this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4,this.zoomToLocation=null}get isLoadingFeature(){return this.featureViewModels.some(e=>e.waitingForContent)}initialize(){this._handles.add([Wt(this,["autoOpenEnabled","view"],()=>this._autoOpenEnabledChange()),this.on("view-change",()=>this._autoClose()),nr(this,["highlightEnabled","selectedFeature","visible","view"],()=>this._highlightFeature()),nr(this,"view.animation.state",e=>this._animationStateChange(e)),nr(this,"location",e=>this._locationChange(e)),nr(this,"selectedFeature",e=>this._selectedFeatureChange(e)),nr(this,["selectedFeatureIndex","featureCount","featuresPerPage"],()=>this._selectedFeatureIndexChange()),nr(this,["featurePage","selectedFeatureIndex","featureCount","featuresPerPage, featureViewModels"],()=>this._setGraphicOnFeatureViewModels()),nr(this,"featureViewModels",()=>this._featureViewModelsChange()),this.on("trigger-action",e=>O6e({event:e,view:this.view})),HD(this,"waitingForResult",()=>this._waitingForResultChange(),!0),nr(this,["features","view","view.map","view.spatialReference"],()=>this._updateFeatureVMs()),nr(this,["view.scale"],this._viewScaleChange),HD(this,"visible",()=>this.browseClusterEnabled=!1),nr(this,"browseClusterEnabled",e=>e?this.enableClusterBrowsing():this.disableClusterBrowsing())])}destroy(){this._cancelFetchingFeatures(),this._handles.destroy(),this._handles=null,this._pendingPromises.clear(),this.browseClusterEnabled=!1,this.view=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const e=this._get("allActions")||new lC;e.removeAll();const{actions:t,defaultActions:i,defaultPopupTemplateEnabled:r,includeDefaultActions:s,selectedFeature:n}=this,o=s?i.concat(t):t,a=n&&(typeof n.getEffectivePopupTemplate=="function"&&n.getEffectivePopupTemplate(r)||n.popupTemplate),l=a&&a.actions,c=a&&a.overwriteActions?l:l?l.concat(o):o;return c&&c.filter(Boolean).forEach(h=>e.add(h)),e}get defaultActions(){var e;const t=this._get("defaultActions")||new lC;return t.removeAll(),t.addMany((e=this.selectedFeature)!=null&&e.isAggregate?F6e():N6e()),t}get featureCount(){return this.features.length}get features(){return this._get("features")||[]}set features(e){const t=e||[];this._set("features",t);const{pendingPromisesCount:i,promiseCount:r,selectedFeatureIndex:s}=this,n=r&&t.length;n&&i&&s===-1?this.selectedFeatureIndex=0:n&&s!==-1||(this.selectedFeatureIndex=t.length?0:-1)}get location(){return this._get("location")||null}set location(e){const t=this.get("view.spatialReference.isWebMercator");e&&e.get("spatialReference.isWGS84")&&t&&(e=fm(e)),this._set("location",e)}get pendingPromisesCount(){return this._pendingPromises.size}get waitingForResult(){return!(!(!!this._fetchFeaturesController||this.pendingPromisesCount>0)||this.featureCount!==0)}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(e){if(this._pendingPromises.clear(),this.features=[],!Array.isArray(e)||!e.length)return this._set("promises",[]),void this.notifyChange("pendingPromisesCount");this._set("promises",e),(e=e.slice(0)).forEach(t=>{this._pendingPromises.add(t);const i=s=>{this._pendingPromises.has(t)&&this._updateFeatures(s),this._updatePendingPromises(t)},r=()=>this._updatePendingPromises(t);t.then(i,r)}),this.notifyChange("pendingPromisesCount")}get selectedFeature(){const{features:e,selectedFeatureIndex:t}=this;return t===-1?null:e[t]||null}get selectedFeatureIndex(){const e=this._get("selectedFeatureIndex");return typeof e=="number"?e:-1}set selectedFeatureIndex(e){const{featureCount:t}=this;e=isNaN(e)||e<-1||!t?-1:(e+t)%t,this._set("selectedFeatureIndex",e)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get state(){return this.get("view.ready")?"ready":"disabled"}centerAtLocation(){const{view:e}=this,t=mme(this);if(!t){const i=new q("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:t,view:e});return gK.error(i),Promise.reject(i)}return this.callGoTo({target:{target:t,scale:e.scale}})}clear(){this.set({promises:[],features:[],content:null,title:null,location:null})}fetchFeatures(e,t){const{view:i}=this;if(!i||!e){const r=new q("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:e,view:i});return gK.error(r),Promise.reject(r)}return i.fetchPopupFeatures(e,{event:t&&t.event,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:t&&t.signal})}open(e){const t=me(I({updateLocationEnabled:!1,promises:[],fetchFeatures:!1},e),{visible:!0}),{fetchFeatures:i}=t;delete t.fetchFeatures,i&&this._setFetchFeaturesPromises(t.location);const r=["actionsMenuOpen","collapsed","featureMenuOpen"];for(const s of r)delete t[s];this.set(t)}triggerAction(e){const t=this.allActions.getItemAt(e);t&&!t.disabled&&this.emit("trigger-action",{action:t})}next(){return this.selectedFeatureIndex=this.selectedFeatureIndex+1,this}previous(){return this.selectedFeatureIndex=this.selectedFeatureIndex-1,this}disableClusterBrowsing(){L6e(this),this._clearBrowsedClusterGraphics()}async enableClusterBrowsing(){await $6e(this),await D6e(this)}_animationStateChange(e){this.zoomToLocation||(Z_.disabled=e==="waiting-for-target")}_clearBrowsedClusterGraphics(){var e;const t=(e=this.view)==null?void 0:e.graphics;t&&(t.remove(this.selectedClusterBoundaryFeature),t.remove(this._selectedClusterFeature)),this._selectedClusterFeature=null,this.selectedClusterBoundaryFeature.geometry=null}_viewScaleChange(){var e;if((e=this.selectedFeature)!=null&&e.isAggregate)return this.browseClusterEnabled=!1,this.visible=!1,void this.clear();this.browseClusterEnabled&&(this.browseClusterEnabled=!1,this.features=[this.selectedFeature])}_locationChange(e){const{selectedFeature:t,updateLocationEnabled:i}=this;i&&e&&(!t||t.geometry)&&this.centerAtLocation()}_selectedFeatureIndexChange(){this.featurePage=this.featureCount>1?Math.floor(this.selectedFeatureIndex/this.featuresPerPage)+1:null}_featureViewModelsChange(){this.featurePage=this.featureCount>1?1:null}_setGraphicOnFeatureViewModels(){const{features:e,featureCount:t,featurePage:i,featuresPerPage:r,featureViewModels:s}=this;if(i===null)return;const n=((i-1)*r+t)%t,o=n+r;s.slice(n,o).forEach((a,l)=>{a&&!a.graphic&&(a.graphic=e[n+l])})}async _selectedFeatureChange(e){if(!e)return;const{location:t,updateLocationEnabled:i,view:r}=this;if(this.browseClusterEnabled)return this._selectedClusterFeature&&(r.graphics.remove(this._selectedClusterFeature),this._selectedClusterFeature=null),e.isAggregate?void 0:(e.symbol=await y6e(e),this._selectedClusterFeature=e,void r.graphics.add(this._selectedClusterFeature));!i&&t||!e.geometry?i&&!e.geometry&&this.centerAtLocation().then(()=>{this.location=r.center.clone()}):this.location=this._getPointFromGeometry(e.geometry)}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}_setFetchFeaturesPromises(e){return this._fetchFeaturesWithController(this._getScreenPoint(e||this.location)).then(t=>{const{clientOnlyGraphics:i,promisesPerLayerView:r}=t,s=Promise.resolve(i),n=r.map(o=>o.promise);this.promises=[s,...n]})}_destroyFeatureVMs(){this.featureViewModels.forEach(e=>e&&!e.destroyed&&e.destroy()),this._set("featureViewModels",[])}_updateFeatureVMs(){const{selectedFeature:e,features:t,featureViewModels:i}=this;if(e!=null&&e.isAggregate||(this.browseClusterEnabled=!1),this._destroyFeatureVMs(),!t||!t.length)return;const r=i.slice(0),s=[];t.forEach((n,o)=>{if(!n)return;let a=null;if(r.some((h,p)=>(h&&h.graphic===n&&(a=h,r.splice(p,1)),!!a)),a)s[o]=a;else{var l,c;const h=new sq({abilities:this.featureViewModelAbilities,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,spatialReference:(l=this.view)==null?void 0:l.spatialReference,graphic:n===e?n:null,map:(c=this.view)==null?void 0:c.map,view:this.view});s[o]=h}}),r.forEach(n=>n&&!n.destroyed&&n.destroy()),this._set("featureViewModels",s)}_getScreenPoint(e){const{view:t}=this;return t&&e&&typeof t.toScreen=="function"?t.toScreen(e):null}_autoOpenEnabledChange(){const e="auto-fetch-features",{_handles:t,autoOpenEnabled:i}=this;if(t.remove(e),i&&this.view){const r=this.view.on("click",s=>{s.pointerType==="mouse"&&s.button!==0||this._fetchFeaturesAndOpen(s)},a0.WIDGET);t.add(r,e)}}_cancelFetchingFeatures(){const e=this._fetchFeaturesController;e&&e.abort(),this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}_fetchFeaturesWithController(e,t){this._cancelFetchingFeatures();const i=new AbortController,{signal:r}=i;this._fetchFeaturesController=i,this.notifyChange("waitingForResult");const s=this.fetchFeatures(e,{signal:r,event:t});return s.catch(()=>{}).then(()=>{this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}),s}_fetchFeaturesAndOpen(e){const{screenPoint:t,mapPoint:i}=e,{view:r}=this;this._fetchFeaturesWithController(t,e).then(s=>{const{clientOnlyGraphics:n,promisesPerLayerView:o,location:a}=s,l=[Promise.resolve(n),...o.map(c=>c.promise)];return r.popup.open({location:a||i,promises:l}),s})}_updatePendingPromises(e){e&&this._pendingPromises.has(e)&&(this._pendingPromises.delete(e),this.notifyChange("pendingPromisesCount"))}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}_getPointFromGeometry(e){return R(e)?null:e.type==="point"?e:e.type==="extent"?e.center:e.type==="polygon"?e.centroid:e.type==="multipoint"||e.type==="polyline"?e.extent.center:null}async _getLayerView(e,t){return await e.when(),e.whenLayerView(t)}async _highlightFeature(){const e="highlight";this._handles.remove(e);const{selectedFeature:t,highlightEnabled:i,view:r,visible:s}=this;if(!(t&&r&&i&&s))return;let{layer:n,sourceLayer:o}=t;if((o==null?void 0:o.type)!=="map-notes"&&(o==null?void 0:o.type)!=="subtype-group"||(n=o),!(n&&n instanceof PF))return;const a=this._getLayerView(r,n);this._highlightPromise=a;const l=await a;if(!(l&&A6e(l)&&this._highlightPromise===a&&this.selectedFeature&&this.highlightEnabled&&this.visible))return;const c=n.type==="imagery"?void 0:"objectIdField"in n&&n.objectIdField,h=t.attributes,p=h&&c&&h[c],f=l.highlight(p||t);this._handles.add(f,e)}_updateFeatures(e){const{features:t}=this;if(!e||!e.length)return;if(!t.length)return void(this.features=e);const i=e.filter(r=>t.indexOf(r)===-1);this.features=t.concat(i)}};u([d()],li.prototype,"featurePage",void 0),u([d()],li.prototype,"isLoadingFeature",null),u([d({type:lC})],li.prototype,"actions",void 0),u([d({readOnly:!0})],li.prototype,"active",null),u([d({readOnly:!0})],li.prototype,"allActions",null),u([d({type:Boolean})],li.prototype,"defaultPopupTemplateEnabled",void 0),u([d()],li.prototype,"autoCloseEnabled",void 0),u([d()],li.prototype,"autoOpenEnabled",void 0),u([d()],li.prototype,"browseClusterEnabled",void 0),u([d()],li.prototype,"content",void 0),u([d({type:lC,readOnly:!0})],li.prototype,"defaultActions",null),u([d({readOnly:!0})],li.prototype,"featureCount",null),u([d()],li.prototype,"features",null),u([d()],li.prototype,"featuresPerPage",void 0),u([d()],li.prototype,"featureViewModelAbilities",void 0),u([d({readOnly:!0})],li.prototype,"featureViewModels",void 0),u([d()],li.prototype,"highlightEnabled",void 0),u([d()],li.prototype,"includeDefaultActions",void 0),u([d({type:et})],li.prototype,"location",null),u([d({readOnly:!0})],li.prototype,"pendingPromisesCount",null),u([d({readOnly:!0})],li.prototype,"selectedClusterBoundaryFeature",void 0),u([d({readOnly:!0})],li.prototype,"waitingForResult",null),u([d({readOnly:!0})],li.prototype,"promiseCount",null),u([d()],li.prototype,"promises",null),u([d({value:null,readOnly:!0})],li.prototype,"selectedFeature",null),u([d({value:-1})],li.prototype,"selectedFeatureIndex",null),u([d({readOnly:!0})],li.prototype,"selectedFeatureViewModel",null),u([d({readOnly:!0})],li.prototype,"state",null),u([d()],li.prototype,"title",void 0),u([d()],li.prototype,"updateLocationEnabled",void 0),u([d()],li.prototype,"view",void 0),u([d()],li.prototype,"visible",void 0),u([d()],li.prototype,"zoomFactor",void 0),u([d()],li.prototype,"zoomToLocation",void 0),u([d()],li.prototype,"centerAtLocation",null),li=u([P(yme)],li);const vme=li,yK="selected-index",U6e=0,vK="popup-spinner",Oe={iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconDockToTop:"esri-icon-maximize",iconDockToBottom:"esri-icon-dock-bottom",iconDockToLeft:"esri-icon-dock-left",iconDockToRight:"esri-icon-dock-right",iconClose:"esri-icon-close",iconUndock:"esri-icon-minimize",iconCheckMark:"esri-icon-check-mark",iconLoading:"esri-icon-loading-indicator",iconDefaultAction:"esri-icon-default-action",iconActionsMenu:"esri-icon-handle-horizontal",rotating:"esri-rotating",base:"esri-popup",widget:"esri-widget",main:"esri-popup__main-container",loadingContainer:"esri-popup__loading-container",isCollapsible:"esri-popup--is-collapsible",isCollapsed:"esri-popup--is-collapsed",shadow:"esri-popup--shadow",isDocked:"esri-popup--is-docked",isDockedTopLeft:"esri-popup--is-docked-top-left",isDockedTopCenter:"esri-popup--is-docked-top-center",isDockedTopRight:"esri-popup--is-docked-top-right",isDockedBottomLeft:"esri-popup--is-docked-bottom-left",isDockedBottomCenter:"esri-popup--is-docked-bottom-center",isDockedBottomRight:"esri-popup--is-docked-bottom-right",alignTopCenter:"esri-popup--aligned-top-center",alignBottomCenter:"esri-popup--aligned-bottom-center",alignTopLeft:"esri-popup--aligned-top-left",alignBottomLeft:"esri-popup--aligned-bottom-left",alignTopRight:"esri-popup--aligned-top-right",alignBottomRight:"esri-popup--aligned-bottom-right",isFeatureMenuOpen:"esri-popup--feature-menu-open",isActionsMenuOpen:"esri-popup--actions-menu-open",hasFeatureUpdated:"esri-popup--feature-updated",header:"esri-popup__header",headerButtons:"esri-popup__header-buttons",headerContainer:"esri-popup__header-container",headerContainerButton:"esri-popup__header-container--button",headerTitle:"esri-popup__header-title",content:"esri-popup__content",footer:"esri-popup__footer",footerHasPagination:"esri-popup__footer--has-pagination",footerHasActions:"esri-popup__footer--has-actions",footerHasActionsMenu:"esri-popup__footer--has-actions-menu",button:"esri-popup__button",buttonDisabled:"esri-popup__button--disabled",buttonDock:"esri-popup__button--dock",icon:"esri-popup__icon",iconDock:"esri-popup__icon--dock-icon",inlineActionsContainer:"esri-popup__inline-actions-container",actionsMenuButton:"esri-popup__actions-menu-button",actions:"esri-popup__actions",action:"esri-popup__action",actionImage:"esri-popup__action-image",actionText:"esri-popup__action-text",actionToggle:"esri-popup__action-toggle",actionToggleOn:"esri-popup__action-toggle--on",pointer:"esri-popup__pointer",pointerDirection:"esri-popup__pointer-direction",navigation:"esri-popup__navigation",paginationPrevious:"esri-popup__pagination-previous",paginationNext:"esri-popup__pagination-next",paginationPreviousIconLTR:"esri-popup__pagination-previous-icon",paginationPreviousIconRTL:"esri-popup__pagination-previous-icon--rtl",paginationNextIconLTR:"esri-popup__pagination-next-icon",paginationNextIconRTL:"esri-popup__pagination-next-icon--rtl",featureMenu:"esri-popup__feature-menu",featureMenuList:"esri-popup__feature-menu-list",featureMenuItem:"esri-popup__feature-menu-item",featureMenuViewport:"esri-popup__feature-menu-viewport",featureMenuHeader:"esri-popup__feature-menu-header",featureMenuNote:"esri-popup__feature-menu-note",featureMenuSelected:"esri-popup__feature-menu-item--selected",featureMenuButton:"esri-popup__feature-menu-button",featureMenuTitle:"esri-popup__feature-menu-title",featureMenuObserver:"esri-popup__feature-menu-observer",featureMenuLoader:"esri-popup__feature-menu-loader",collapseButton:"esri-popup__collapse-button"},_K={buttonEnabled:!0,position:"auto",breakpoint:{width:544}},bK="esri-popup";function Qp(e,t){return t===void 0?`${bK}__${e}`:`${bK}__${e}-${t}`}const _me="esri.widgets.Popup",wK=he.getLogger(_me),xK={closeButton:!0,featureNavigation:!0};let _t=class extends lme(Ia){constructor(e,t){super(e,t),this._blurClose=!1,this._blurContainer=!1,this._containerNode=null,this._mainContainerNode=null,this._featureMenuNode=null,this._actionsMenuNode=null,this._focusClose=!1,this._focusContainer=!1,this._focusDockButton=!1,this._focusFeatureMenuButton=!1,this._focusActionsMenuButton=!1,this._focusFirstFeature=!1,this._focusFirstAction=!1,this._handles=new Ut,this._pointerOffsetInPx=16,this._spinner=null,this._feature=null,this._featureMenuIntersectionObserverCallback=([i])=>{i!=null&&i.isIntersecting&&this.viewModel.featurePage++},this._featureMenuIntersectionObserver=new IntersectionObserver(this._featureMenuIntersectionObserverCallback,{root:window.document}),this._displaySpinnerThrottled=Kj(()=>this._displaySpinner(),U6e),this.actions=null,this.alignment="auto",this.autoCloseEnabled=null,this.autoOpenEnabled=null,this.defaultPopupTemplateEnabled=null,this.content=null,this.collapsed=!1,this.collapseEnabled=!0,this.dockEnabled=!1,this.featureCount=null,this.featureMenuOpen=!1,this.features=null,this.goToOverride=null,this.headingLevel=2,this.highlightEnabled=null,this.location=null,this.label=void 0,this.maxInlineActions=3,this.messages=null,this.messagesCommon=null,this.promises=null,this.selectedFeature=null,this.selectedFeatureIndex=null,this.spinnerEnabled=!0,this.title=null,this.updateLocationEnabled=null,this.view=null,this.viewModel=new vme,this.visible=null,this.visibleElements=I({},xK),this._addSelectedFeatureIndexHandle(),this.own([nr(this,"viewModel.screenLocation",()=>this._positionContainer()),nr(this,["viewModel.active","dockEnabled"],()=>this._toggleScreenLocationEnabled()),nr(this,"viewModel.screenLocation",(i,r)=>{!!i!=!!r&&this.reposition()}),nr(this,["viewModel.view.padding","viewModel.view.size","viewModel.active","viewModel.location","alignment"],()=>this.reposition()),nr(this,"spinnerEnabled",i=>this._spinnerEnabledChange(i)),nr(this,"viewModel.view.size",(i,r)=>this._updateDockEnabledForViewSize(i,r)),nr(this,"viewModel.view",(i,r)=>this._viewChange(i,r)),nr(this,"viewModel.view.ready",(i,r)=>this._viewReadyChange(i,r)),nr(this,["viewModel.waitingForResult","viewModel.location"],()=>{this._hideSpinner(),this._displaySpinnerThrottled()}),nr(this,["selectedFeatureWidget.viewModel.title","selectedFeatureWidget.viewModel.state"],()=>this._setTitleFromFeatureWidget()),nr(this,["selectedFeatureWidget.viewModel.content","selectedFeatureWidget.viewModel.state"],()=>this._setContentFromFeatureWidget()),HD(this,"collapsed",()=>{var i,r;((i=this.viewModel)==null||(r=i.view)==null?void 0:r.widthBreakpoint)==="xsmall"&&this.viewModel.active&&this.collapseEnabled&&this.viewModel.centerAtLocation()}),Rp(this,"viewModel.allActions","change",()=>this._watchActions()),Wt(this,"viewModel.allActions",()=>this._watchActions()),nr(this,"viewModel.featureViewModels",()=>this._featureMenuViewportScrollTop())])}destroy(){var e,t;this._destroySelectedFeatureWidget(),this._destroySpinner(),(e=this._handles)==null||e.destroy(),this._unobserveFeatureMenuObserver(),(t=this._featureMenuIntersectionObserver)==null||t.disconnect(),this._handles=null}get actionsMenuId(){return`${this.id}-actions-menu`}get actionsMenuButtonId(){return`${this.id}-actions-menu-button`}get featureMenuId(){return`${this.id}-feature-menu`}get titleId(){return`${this.id}-popup-title`}get contentId(){return`${this.id}-popup-content`}get hasContent(){var e,t,i,r,s,n,o;return!!(this.selectedFeatureWidget?((e=this.selectedFeatureWidget)==null||(t=e.viewModel)==null?void 0:t.waitingForContent)||((i=this.selectedFeatureWidget)==null||(r=i.viewModel)==null?void 0:r.state)==="error"||((s=this.selectedFeatureWidget)==null||(n=s.viewModel)==null?void 0:n.content):(o=this.viewModel)==null?void 0:o.content)}get featureNavigationVisible(){return this.viewModel.active&&this.viewModel.featureCount>1&&this.visibleElements.featureNavigation}get collapsible(){return!!(this.collapseEnabled&&this.viewModel.title&&this.hasContent)}get featureMenuVisible(){return this.featureNavigationVisible&&this.featureMenuOpen}get contentCollapsed(){return this.collapsible&&!this.featureMenuVisible&&this.collapsed}get dividedActions(){return this._divideActions()}set actionsMenuOpen(e){this._set("actionsMenuOpen",!!e)}get actionsMenuOpen(){return!!this.viewModel.active&&this._get("actionsMenuOpen")}get currentAlignment(){return this._getCurrentAlignment()}get currentDockPosition(){return this._getCurrentDockPosition()}get dockOptions(){return this._get("dockOptions")||_K}set dockOptions(e){const t=I({},_K),i=this.get("viewModel.view.breakpoints"),r={};i&&(r.width=i.xsmall,r.height=i.xsmall);const s=I(I({},t),e),n=I(I({},t.breakpoint),r),{breakpoint:o}=s;o===!0?s.breakpoint=n:typeof o=="object"&&(s.breakpoint=I(I({},n),o)),this._set("dockOptions",s),this._setCurrentDockPosition(),this.reposition()}get selectedFeatureWidget(){const{_feature:e,visibleElements:t,headingLevel:i}=this,{selectedFeatureViewModel:r}=this.viewModel,s=me(I({},t),{title:!1});return r?(e?(e.viewModel=r,e.visibleElements=s):this._feature=new Wze({headingLevel:i+1,viewModel:r,visibleElements:s}),this._feature):null}castVisibleElements(e){return I(I({},xK),e)}blur(){const{active:e}=this.viewModel;e||wK.warn("Popup can only be blurred when currently active."),this.visibleElements.closeButton?this._blurClose=!0:this._blurContainer=!0,this.scheduleRender()}clear(){this.viewModel.clear()}close(){this.visible=!1}fetchFeatures(e,t){return this.viewModel.fetchFeatures(e,t)}focus(){const{active:e}=this.viewModel;e||wK.warn("Popup can only be focused when currently active."),this.visibleElements.closeButton?this._focusClose=!0:this._focusContainer=!0,this.scheduleRender()}next(){return this.viewModel.next()}open(e){var t,i;this._handles.remove(yK);const r=!!e&&!!e.featureMenuOpen,s=!!e&&!!e.actionsMenuOpen,n={collapsed:!!e&&!!e.collapsed,actionsMenuOpen:s,featureMenuOpen:r};((t=this.viewModel)==null||(i=t.view)==null?void 0:i.widthBreakpoint)==="xsmall"&&(n.collapsed=!0),this.set(n),this.viewModel.open(e),this._shouldFocus(e),this._addSelectedFeatureIndexHandle()}previous(){return this.viewModel.previous()}reposition(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()}triggerAction(e){this.viewModel.triggerAction(e)}render(){var e,t,i,r;const{actionsMenuOpen:s,dockEnabled:n,featureMenuVisible:o,dividedActions:a,currentAlignment:l,currentDockPosition:c}=this,{active:h}=this.viewModel,{menuActions:p}=a,f=h&&p.length>1&&s,g=h&&n,y=h&&!n,v=(e=this.selectedFeature)==null||(t=e.layer)==null?void 0:t.title,b=(i=this.selectedFeature)==null||(r=i.layer)==null?void 0:r.id,w={[Oe.alignTopCenter]:l==="top-center",[Oe.alignBottomCenter]:l==="bottom-center",[Oe.alignTopLeft]:l==="top-left",[Oe.alignBottomLeft]:l==="bottom-left",[Oe.alignTopRight]:l==="top-right",[Oe.alignBottomRight]:l==="bottom-right",[Oe.isDocked]:g,[Oe.shadow]:y,[Oe.isDockedTopLeft]:c==="top-left",[Oe.isDockedTopCenter]:c==="top-center",[Oe.isDockedTopRight]:c==="top-right",[Oe.isDockedBottomLeft]:c==="bottom-left",[Oe.isDockedBottomCenter]:c==="bottom-center",[Oe.isDockedBottomRight]:c==="bottom-right",[Oe.isFeatureMenuOpen]:o,[Oe.isActionsMenuOpen]:f};return le("div",{class:this.classes(Oe.base,w),role:"presentation","data-layer-title":v,"data-layer-id":b,bind:this,afterCreate:this._positionContainer,afterUpdate:this._positionContainer},h?[this.renderMainContainer(),this.renderPointer()]:null)}renderLoadingIcon(){return le("span",{"aria-hidden":"true",class:this.classes(Oe.icon,Oe.iconLoading,Oe.rotating)})}renderNavigationLoading(){const{messagesCommon:e}=this;return this.viewModel.pendingPromisesCount?le("div",{key:Qp("loading-container"),role:"presentation",class:Oe.loadingContainer,"aria-label":e.loading,title:e.loading},this.renderLoadingIcon()):null}renderPreviousIcon(){const e=qy(this.container),t={[Oe.iconRightTriangleArrow]:e,[Oe.paginationPreviousIconRTL]:e,[Oe.iconLeftTriangleArrow]:!e,[Oe.paginationPreviousIconLTR]:!e};return le("span",{"aria-hidden":"true",class:this.classes(Oe.icon,t)})}renderPreviousButton(){const{messages:e}=this;return le("div",{role:"button",tabIndex:0,bind:this,onclick:this._previous,onkeydown:this._previous,class:this.classes(Oe.button,Oe.paginationPrevious),"aria-label":e.previous,title:e.previous},this.renderPreviousIcon())}renderNextIcon(){const e=qy(this.container),t={[Oe.iconLeftTriangleArrow]:e,[Oe.paginationNextIconRTL]:e,[Oe.iconRightTriangleArrow]:!e,[Oe.paginationNextIconLTR]:!e};return le("span",{"aria-hidden":"true",class:this.classes(Oe.icon,t)})}renderNextButton(){const{messages:e}=this;return le("div",{role:"button",tabIndex:0,bind:this,onclick:this._next,onkeydown:this._next,class:this.classes(Oe.button,Oe.paginationNext),"aria-label":e.next,title:e.next},this.renderNextIcon())}renderFeatureMenuButton(){const{featureMenuOpen:e,featureMenuId:t,messagesCommon:i}=this,{featureCount:r,selectedFeatureIndex:s}=this.viewModel;return le("div",{role:"button",tabIndex:0,bind:this,onclick:this._toggleFeatureMenu,onkeydown:this._toggleFeatureMenu,afterCreate:this._focusFeatureMenuButtonNode,afterUpdate:this._focusFeatureMenuButtonNode,class:this.classes(Oe.button,Oe.featureMenuButton),"aria-haspopup":"true","aria-controls":t,"aria-expanded":e.toString(),"aria-label":i.menu,title:i.menu},this._getPageText(r,s))}renderNavigationButtons(){return this.featureNavigationVisible?[this.renderPreviousButton(),this.renderNavigationLoading()||this.renderFeatureMenuButton(),this.renderNextButton()]:null}renderDockIcon(){const{dockEnabled:e}=this,t=this._wouldDockTo(),i={[Oe.iconUndock]:e,[Oe.iconDock]:!e,[Oe.iconDockToRight]:!e&&(t==="top-right"||t==="bottom-right"),[Oe.iconDockToLeft]:!e&&(t==="top-left"||t==="bottom-left"),[Oe.iconDockToTop]:!e&&t==="top-center",[Oe.iconDockToBottom]:!e&&t==="bottom-center"};return le("span",{"aria-hidden":"true",class:this.classes(i,Oe.icon)})}renderDockButton(){var e,t,i;const{dockEnabled:r,messages:s}=this,n=(e=this.viewModel)==null||(t=e.view)==null?void 0:t.widthBreakpoint,o=r?s.undock:s.dock;return n!=="xsmall"&&(i=this.dockOptions)!=null&&i.buttonEnabled?le("div",{role:"button","aria-label":o,title:o,tabIndex:0,bind:this,onclick:this._toggleDockEnabled,onkeydown:this._toggleDockEnabled,afterCreate:this._focusDockButtonNode,afterUpdate:this._focusDockButtonNode,class:this.classes(Oe.button,Oe.buttonDock)},this.renderDockIcon()):null}renderTitle(){const{title:e}=this.viewModel,{titleId:t,collapsible:i,contentCollapsed:r,messagesCommon:s}=this,n={[Oe.headerContainerButton]:i},o=le(uH,{level:this.headingLevel,class:Oe.headerTitle,innerHTML:e}),a=i?le("button",{key:`${e}--collapsible`,id:t,title:r?s.expand:s.collapse,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(Oe.headerContainer,n),"aria-expanded":r?"false":"true",onclick:this._toggleCollapsed,type:"button"},o):le("div",{key:e,id:t,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(Oe.headerContainer,n)},o);return e?a:null}renderCloseIcon(){return le("span",{"aria-hidden":"true",class:this.classes(Oe.icon,Oe.iconClose)})}renderCloseButton(){const{visibleElements:e,messagesCommon:t}=this;return e.closeButton?le("div",{role:"button",tabIndex:0,bind:this,onclick:this._close,onkeydown:this._close,class:Oe.button,"aria-label":t.close,title:t.close,afterCreate:this._closeButtonNodeUpdated,afterUpdate:this._closeButtonNodeUpdated},this.renderCloseIcon()):null}renderHeader(){return le("header",{class:Oe.header},this.renderTitle(),le("div",{class:Oe.headerButtons},this.renderDockButton(),this.renderCloseButton()))}renderContentContainer(){const{contentId:e,hasContent:t,contentCollapsed:i}=this,{content:r}=this.viewModel;return t&&!i?le("article",{key:r,enterAnimation:this._createFeatureUpdatedAnimation(),id:e,class:Oe.content},this.renderContent()):null}renderActionsMenuButton(){const{actionsMenuId:e,actionsMenuButtonId:t,actionsMenuOpen:i,dividedActions:r,messagesCommon:s}=this,n=i?s.close:s.open,{menuActions:o}=r;return o.length?le("div",{key:Qp("actions-menu-button"),class:this.classes(Oe.button,Oe.actionsMenuButton),role:"button",id:t,"aria-haspopup":"true","aria-controls":i?e:null,tabIndex:0,bind:this,onclick:this._toggleActionsMenu,onkeydown:this._toggleActionsMenu,afterCreate:this._focusActionsMenuButtonNode,afterUpdate:this._focusActionsMenuButtonNode,"aria-label":n,title:n},le("span",{"aria-hidden":"true",class:Oe.iconActionsMenu})):null}renderMenuActions(){const{actionsMenuId:e,actionsMenuButtonId:t,actionsMenuOpen:i,dividedActions:r}=this,{menuActions:s}=r;return s.length&&i?le("ul",{id:e,role:"menu","aria-labelledby":t,key:Qp("actions"),class:Oe.actions,bind:this,onkeyup:this._handleActionMenuKeyup,afterCreate:this._actionsMenuNodeUpdated,afterUpdate:this._actionsMenuNodeUpdated},s.toArray().map(n=>this.renderAction({action:n,type:"menu-item"}))):null}renderInlineActions(){const{inlineActions:e}=this.dividedActions;return!!e.length&&e.toArray().map(t=>this.renderAction({action:t,type:"inline"}))}renderInlineActionsContainer(){const{inlineActions:e,menuActions:t}=this.dividedActions,i=!!e.length,r=!!t.length;return i||r?le("div",{key:"inline-actions-container","data-inline-actions":i.toString(),"data-menu-actions":r.toString(),class:Oe.inlineActionsContainer},this.renderInlineActions(),this.renderActionsMenuButton(),this.renderMenuActions()):null}renderNavigation(){return this.featureNavigationVisible?le("section",{key:Qp("navigation"),class:this.classes(Oe.navigation)},this.renderNavigationButtons()):null}renderFooter(){const{featureNavigationVisible:e,dividedActions:t}=this,{inlineActions:i,menuActions:r}=t,s=!!i.length,n=!!r.length,o={[Oe.footerHasPagination]:e,[Oe.footerHasActions]:s,[Oe.footerHasActionsMenu]:n};return e||s?le("div",{key:Qp("feature-buttons"),class:this.classes(Oe.footer,o)},this.renderInlineActionsContainer(),this.renderNavigation()):null}renderFeatureMenuContainer(){const{messages:e}=this,{featureViewModels:t,isLoadingFeature:i}=this.viewModel,r=xf(e.selectedFeatures,{total:t.length});return le("section",{key:Qp("menu"),class:Oe.featureMenu},le("strong",{class:Oe.featureMenuHeader},r),le("nav",{bind:this,class:Oe.featureMenuViewport,"data-node-ref":"_featureMenuViewportNode",afterCreate:yV},this.renderFeatureMenu(),le("div",{class:Oe.featureMenuObserver,bind:this,afterCreate:this._featureMenuIntersectionObserverCreated}),i?le("div",{class:Oe.featureMenuLoader},this.renderLoadingIcon()):null))}renderPointer(){return this.dockEnabled?null:le("div",{key:Qp("pointer"),class:Oe.pointer,role:"presentation"},le("div",{class:this.classes(Oe.pointerDirection,Oe.shadow)}))}renderMainContainer(){const{dockEnabled:e,currentAlignment:t,currentDockPosition:i,titleId:r,contentId:s,collapsible:n,hasContent:o,contentCollapsed:a,visibleElements:l}=this,{title:c}=this.viewModel,h=t==="bottom-left"||t==="bottom-center"||t==="bottom-right"||i==="top-left"||i==="top-center"||i==="top-right",p=t==="top-left"||t==="top-center"||t==="top-right"||i==="bottom-left"||i==="bottom-center"||i==="bottom-right",f={[Oe.shadow]:e,[Oe.isCollapsible]:n,[Oe.isCollapsed]:a};return le("div",{class:this.classes(Oe.main,Oe.widget,f),tabIndex:l.closeButton?null:-1,role:"dialog","aria-labelledby":c?r:"","aria-describedby":o&&!a?s:"",bind:this,onkeyup:this._handleMainKeyup,afterCreate:this._mainContainerNodeUpdated,afterUpdate:this._mainContainerNodeUpdated},h?this.renderFooter():null,h?this.renderFeatureMenuContainer():null,this.renderHeader(),this.renderContentContainer(),p?this.renderFooter():null,p?this.renderFeatureMenuContainer():null)}renderContent(){var e;const t=(e=this.viewModel)==null?void 0:e.content;return t?typeof t=="string"?le("div",{key:t,innerHTML:t}):this.renderNodeContent(t):null}renderActionText(e){return le("span",{key:"text",class:Oe.actionText},e)}renderActionIcon(e){const t=this._getActionClass(e),i=this._getActionImage(e),r={[Oe.iconLoading]:e.active,[Oe.rotating]:e.active,[Oe.icon]:!!t,[Oe.actionImage]:!e.active&&!!i};return t&&(r[t]=!e.active),le("span",{key:"icon","aria-hidden":"true",class:this.classes(Oe.icon,r),styles:this._getIconStyles(i)})}renderAction(e){const{action:t,type:i}=e,r=this._getActionTitle(t),s={[Oe.action]:t.type!=="toggle",[Oe.actionToggle]:t.type==="toggle",[Oe.actionToggleOn]:t.type==="toggle"&&t.value,[Oe.buttonDisabled]:t.disabled},n=[this.renderActionIcon(t),this.renderActionText(r)],o=i==="menu-item"?le("li",{key:t.uid,role:"menuitem",tabIndex:0,title:r,"aria-label":r,class:this.classes(Oe.button,s),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-uid":t.uid,onclick:this._triggerAction,onkeydown:this._triggerAction},n):le("div",{key:t.uid,role:"button",tabIndex:0,title:r,"aria-label":r,class:this.classes(Oe.button,s),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-uid":t.uid,onclick:this._triggerAction,onkeydown:this._triggerAction},n);return t.visible?o:null}renderFeatureMenuItem(e,t){const{messages:i,messagesCommon:r}=this,{selectedFeatureIndex:s,selectedFeatureViewModel:n}=this.viewModel,o=e===n,a={[Oe.featureMenuSelected]:o},l=o?le("span",{key:Qp(`feature-menu-selected-feature-${s}`),title:i.selectedFeature,"aria-label":i.selectedFeature,class:Oe.iconCheckMark}):null,c=le("span",{innerHTML:e.title||r.untitled});return le("li",{role:"menuitem",tabIndex:-1,key:Qp(`feature-menu-feature-${s}`),class:this.classes(a,Oe.featureMenuItem),bind:this,"data-feature-index":t,onkeyup:this._handleFeatureMenuItemKeyup,onclick:this._selectFeature,onkeydown:this._selectFeature},le("span",{class:Oe.featureMenuTitle},c,l))}renderFeatureMenu(){const{featureMenuId:e}=this,{featureViewModels:t}=this.viewModel;return t.length>1?le("ol",{class:Oe.featureMenuList,id:e,bind:this,afterCreate:this._featureMenuNodeUpdated,afterUpdate:this._featureMenuNodeUpdated,onkeyup:this._handleFeatureMenuKeyup,role:"menu"},t.filter(i=>!!i.graphic).map((i,r)=>this.renderFeatureMenuItem(i,r))):null}_getActionTitle(e){const{messages:t,selectedFeature:i,messagesCommon:r}=this,{id:s}=e,n=i==null?void 0:i.attributes,o=s==="zoom-to-feature"?xf(e.title,{messages:t}):s==="remove-selected-feature"?xf(e.title,{messages:r}):s==="zoom-to-clustered-features"||s==="browse-clustered-features"?xf(e.title,{messages:t}):e.title;return o&&n?xf(o,n):o}_getActionClass(e){const{selectedFeature:t}=this,i=t==null?void 0:t.attributes,{className:r,image:s}=e,n=s||r?r:Oe.iconDefaultAction;return n&&i?xf(n,i):n}_getActionImage(e){const{selectedFeature:t}=this,i=t==null?void 0:t.attributes,{image:r}=e;return r&&i?xf(r,i):r}_createFeatureUpdatedAnimation(){return _Pe("enter",Oe.hasFeatureUpdated)}_getInlineActionCount(){const{maxInlineActions:e,featureNavigationVisible:t}=this;if(typeof e!="number")return null;const i=Math.round(e);return Math.max(t?i-1:i,0)}_watchActions(){const{allActions:e}=this.viewModel;this.notifyChange("dividedActions");const t="actions";this._handles.remove(t),e&&e.forEach(i=>{this._handles.add(nr(i,["uid","active","className","disabled","id","title","image","visible"],()=>this.scheduleRender()),t)})}_divideActions(){const{allActions:e}=this.viewModel,t=e.filter(n=>n.visible),i=this._getInlineActionCount(),r=i===null,s=i===0;return{inlineActions:r?t.slice(0):s?new it:t.slice(0,i),menuActions:r?new it:s?t.slice(0):t.slice(i)}}_featureMenuOpenChanged(e){e?this._focusFirstFeature=!0:this._focusFeatureMenuButton=!0}_actionsMenuOpenChanged(e){e?this._focusFirstAction=!0:this._focusActionsMenuButton=!0}_setTitleFromFeatureWidget(){const{selectedFeatureWidget:e,messagesCommon:t}=this;var i,r;e&&(this.viewModel.title=((i=e.viewModel)==null?void 0:i.state)==="error"?t.errorMessage:((r=e.viewModel)==null?void 0:r.title)||"")}_setContentFromFeatureWidget(){const{selectedFeatureWidget:e}=this;e&&(this.viewModel.content=e)}_unobserveFeatureMenuObserver(){this._featureMenuIntersectionObserverNode&&this._featureMenuIntersectionObserver.unobserve(this._featureMenuIntersectionObserverNode)}_featureMenuIntersectionObserverCreated(e){this._unobserveFeatureMenuObserver(),this._featureMenuIntersectionObserver.observe(e),this._featureMenuIntersectionObserverNode=e}_handleFeatureMenuKeyup(e){A_(e)==="Escape"&&(e.stopPropagation(),this._focusFeatureMenuButton=!0,this.featureMenuOpen=!1,this.scheduleRender())}_handleActionMenuKeyup(e){A_(e)==="Escape"&&(e.stopPropagation(),this._focusActionsMenuButton=!0,this.actionsMenuOpen=!1,this.scheduleRender())}_handleFeatureMenuItemKeyup(e){const t=A_(e),{_featureMenuNode:i}=this,r=e.currentTarget["data-feature-index"];if(!i)return;const s=i.querySelectorAll("li"),n=s.length;t!=="ArrowUp"?t!=="ArrowDown"?t!=="Home"?t!=="End"||(e.stopPropagation(),s[s.length-1].focus()):(e.stopPropagation(),s[0].focus()):(e.stopPropagation(),s[(r+1+n)%n].focus()):(e.stopPropagation(),s[(r-1+n)%n].focus())}_handleActionMenuItemKeyup(e){const t=A_(e),{_actionsMenuNode:i}=this,r=e.currentTarget.dataset.actionUid,{menuActions:s}=this.dividedActions,n=s.findIndex(l=>l.uid===r);if(!i)return;const o=i.querySelectorAll("li"),a=o.length;t!=="ArrowUp"?t!=="ArrowDown"?t!=="Home"?t!=="End"||(e.stopPropagation(),o[o.length-1].focus()):(e.stopPropagation(),o[0].focus()):(e.stopPropagation(),o[(n+1+a)%a].focus()):(e.stopPropagation(),o[(n-1+a)%a].focus())}_handleMainKeyup(e){const t=A_(e);t==="ArrowLeft"&&(e.stopPropagation(),this.previous()),t==="ArrowRight"&&(e.stopPropagation(),this.next())}_spinnerEnabledChange(e){if(this._destroySpinner(),!e)return;const t=this.get("viewModel.view");this._createSpinner(t)}_hideSpinner(){const{_spinner:e}=this;e&&(e.location=null,e.hide())}_displaySpinner(){const{_spinner:e}=this;if(!e)return;const{location:t,waitingForResult:i}=this.viewModel;i?e.show({location:t}):e.hide()}_getIconStyles(e){return{"background-image":e?`url(${e})`:""}}async _shouldFocus(e){e.shouldFocus&&(await mD(()=>{var t;return((t=this.viewModel)==null?void 0:t.active)===!0}),this.focus())}_addSelectedFeatureIndexHandle(){const e=nr(this,"viewModel.selectedFeatureIndex",(t,i)=>this._selectedFeatureIndexUpdated(t,i));this._handles.add(e,yK)}_selectedFeatureIndexUpdated(e,t){const{featureCount:i}=this;i&&e!==t&&e!==-1&&(this.actionsMenuOpen=!1,this.featureMenuOpen=!1)}_destroySelectedFeatureWidget(){const{_feature:e}=this;e&&(e.viewModel=null,e&&!e.destroyed&&e.destroy()),this._feature=null}_isScreenLocationWithinView(e,t){return e.x>-1&&e.y>-1&&e.x<=t.width&&e.y<=t.height}_isOutsideView(e){const{popupHeight:t,popupWidth:i,screenLocation:r,side:s,view:n}=e;if(isNaN(i)||isNaN(t)||!n||!r)return!1;const o=n.padding;return s==="right"&&r.x+i/2>n.width-o.right||s==="left"&&r.x-i/2<o.left||s==="top"&&r.y-t<o.top||s==="bottom"&&r.y+t>n.height-o.bottom}_calculateAutoAlignment(e){if(e!=="auto")return e;const{_pointerOffsetInPx:t,_containerNode:i,_mainContainerNode:r,viewModel:s}=this,{screenLocation:n,view:o}=s;if(R(n)||!o||!i)return"top-center";if(!this._isScreenLocationWithinView(n,o))return this._get("currentAlignment")||"top-center";function a(T){return parseInt(T.replace(/[^-\d\.]/g,""),10)}const l=r?window.getComputedStyle(r,null):null,c=l?a(l.getPropertyValue("max-height")):0,h=l?a(l.getPropertyValue("height")):0,{height:p,width:f}=i.getBoundingClientRect(),g=f+t,y=Math.max(p,c,h)+t,v=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"right",view:o}),b=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"left",view:o}),w=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"top",view:o}),S=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"bottom",view:o});return b?w?"bottom-right":"top-right":v?w?"bottom-left":"top-left":w?S?"top-center":"bottom-center":"top-center"}_callCurrentAlignment(e){return typeof e=="function"?e.call(this):e}_getCurrentAlignment(){const{alignment:e,dockEnabled:t}=this;return t||!this.viewModel.active?null:this._calculatePositionResult(this._calculateAutoAlignment(this._callCurrentAlignment(e)))}_setCurrentAlignment(){this._set("currentAlignment",this._getCurrentAlignment())}_setCurrentDockPosition(){this._set("currentDockPosition",this._getCurrentDockPosition())}_calculatePositionResult(e){const t=["left","right"];return qy(this.container)&&t.reverse(),e.replace(/leading/gi,t[0]).replace(/trailing/gi,t[1])}_callDockPosition(e){return typeof e=="function"?e.call(this):e}_getDockPosition(){var e;return this._calculatePositionResult(this._calculateAutoDockPosition(this._callDockPosition((e=this.dockOptions)==null?void 0:e.position)))}_getCurrentDockPosition(){return this.dockEnabled&&this.viewModel.active?this._getDockPosition():null}_wouldDockTo(){return this.dockEnabled?null:this._getDockPosition()}_calculateAutoDockPosition(e){var t;if(e!=="auto")return e;const i=(t=this.viewModel)==null?void 0:t.view,r=qy(this.container)?"top-left":"top-right";if(!i)return r;const s=i.padding||{left:0,right:0,top:0,bottom:0},n=i.width-s.left-s.right,{breakpoints:o}=i;return o&&n<=o.xsmall?"bottom-center":r}_positionContainer(e=this._containerNode){if(e&&(this._containerNode=e),!e)return;const{screenLocation:t}=this.viewModel,{width:i}=e.getBoundingClientRect(),r=this._calculatePositionStyle(t,i);r&&(e.style.top=r.top,e.style.left=r.left,e.style.bottom=r.bottom,e.style.right=r.right)}_calculateFullWidth(e){const{currentAlignment:t,_pointerOffsetInPx:i}=this;return t==="top-left"||t==="bottom-left"||t==="top-right"||t==="bottom-right"?e+i:e}_calculateAlignmentPosition(e,t,i,r){const{currentAlignment:s,_pointerOffsetInPx:n}=this,o=r/2,a=i.height-t,l=i.width-e,{padding:c}=this.view;return s==="bottom-center"?{top:t+n-c.top,left:e-o-c.left}:s==="top-left"?{bottom:a+n-c.bottom,right:l+n-c.right}:s==="bottom-left"?{top:t+n-c.top,right:l+n-c.right}:s==="top-right"?{bottom:a+n-c.bottom,left:e+n-c.left}:s==="bottom-right"?{top:t+n-c.top,left:e+n-c.left}:s==="top-center"?{bottom:a+n-c.bottom,left:e-o-c.left}:void 0}_calculatePositionStyle(e,t){const{dockEnabled:i,view:r}=this;if(!r)return;if(i)return{left:"",top:"",right:"",bottom:""};if(R(e)||!t)return;const s=this._calculateFullWidth(t),n=this._calculateAlignmentPosition(e.x,e.y,r,s);return n?{top:n.top!==void 0?`${n.top}px`:"auto",left:n.left!==void 0?`${n.left}px`:"auto",bottom:n.bottom!==void 0?`${n.bottom}px`:"auto",right:n.right!==void 0?`${n.right}px`:"auto"}:void 0}_viewChange(e,t){e&&t&&(this.close(),this.clear())}_viewReadyChange(e,t){if(e){const i=this.get("viewModel.view");this._wireUpView(i)}else t&&(this.close(),this.clear())}_wireUpView(e){if(this._destroySpinner(),!e)return;const{spinnerEnabled:t}=this;t&&this._createSpinner(e),this._setDockEnabledForViewSize(this.dockOptions)}_dockingThresholdCrossed(e,t,i){const[r,s]=e,[n,o]=t,{width:a,height:l}=i;return r<=a&&n>a||r>a&&n<=a||s<=l&&o>l||s>l&&o<=l}_updateDockEnabledForViewSize(e,t){if(!e||!t)return;const i=this.get("viewModel.view.padding")||{left:0,right:0,top:0,bottom:0},r=i.left+i.right,s=i.top+i.bottom,n=[],o=[];n[0]=e[0]-r,n[1]=e[1]-s,o[0]=t[0]-r,o[1]=t[1]-s;const{dockOptions:a}=this,l=a.breakpoint;this._dockingThresholdCrossed(n,o,l)&&this._setDockEnabledForViewSize(a),this._setCurrentDockPosition()}_focusDockButtonNode(e){this._focusDockButton&&(this._focusDockButton=!1,e.focus())}_closeButtonNodeUpdated(e){return this._focusClose?(this._focusClose=!1,void e.focus()):this._blurClose?(this._blurClose=!1,void e.blur()):void 0}_mainContainerNodeUpdated(e){return this._mainContainerNode=e,this._focusContainer?(this._focusContainer=!1,void e.focus()):this._blurContainer?(this._blurContainer=!1,void e.blur()):void 0}_featureMenuNodeUpdated(e){if(this._featureMenuNode=e,!e||!this._focusFirstFeature)return;this._focusFirstFeature=!1;const t=e.querySelectorAll("li");t.length&&t[0].focus()}_actionsMenuNodeUpdated(e){if(this._actionsMenuNode=e,!e||!this._focusFirstAction)return;this._focusFirstAction=!1;const t=e.querySelectorAll("li");t.length&&t[0].focus()}_focusFeatureMenuButtonNode(e){this._focusFeatureMenuButton&&(this._focusFeatureMenuButton=!1,e.focus())}_focusActionsMenuButtonNode(e){this._focusActionsMenuButton&&(this._focusActionsMenuButton=!1,e.focus())}_featureMenuViewportScrollTop(){this._featureMenuViewportNode&&(this._featureMenuViewportNode.scrollTop=0)}_toggleScreenLocationEnabled(){const{dockEnabled:e,viewModel:t}=this;if(!t)return;const i=t.active&&!e;t.screenLocationEnabled=i}_shouldDockAtCurrentViewSize(e){var t,i;const r=e.breakpoint,s=(t=this.viewModel)==null||(i=t.view)==null?void 0:i.ui;if(!s)return!1;const{width:n,height:o}=s;if(isNaN(n)||isNaN(o))return!1;const a=r.hasOwnProperty("width")&&n<=r.width,l=r.hasOwnProperty("height")&&o<=r.height;return a||l}_setDockEnabledForViewSize(e){e.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(e))}_getPageText(e,t){return this.featureNavigationVisible?xf(this.messages.pageText,{index:t+1,total:e}):null}_destroySpinner(){const{_spinner:e,view:t}=this;e&&(t&&t.ui&&t.ui.remove(this._spinner,vK),e.destroy(),this._spinner=null)}_createSpinner(e){e&&(this._spinner=new Yze({view:e}),e.ui.add(this._spinner,{key:vK,position:"manual"}))}_toggleCollapsed(){this.collapsed=!this.collapsed}_close(){this.close(),this.view&&this.view.focus()}_toggleDockEnabled(){this.dockEnabled=!this.dockEnabled,this._focusDockButton=!0,this.scheduleRender()}_toggleFeatureMenu(){const e=!this.featureMenuOpen;this._featureMenuOpenChanged(e),this.actionsMenuOpen=!1,this.featureMenuOpen=e}_toggleActionsMenu(){const e=!this.actionsMenuOpen;this._actionsMenuOpenChanged(e),this.featureMenuOpen=!1,this.actionsMenuOpen=e}_triggerAction(e){const t=e.currentTarget.dataset.actionUid,{allActions:i}=this.viewModel,r=i.findIndex(n=>n.uid===t),s=i.getItemAt(r);s&&s.type==="toggle"&&(s.value=!s.value),this.actionsMenuOpen=!1,this.viewModel.triggerAction(r)}_selectFeature(e){const t=e.currentTarget["data-feature-index"];isNaN(t)||(this.viewModel.selectedFeatureIndex=t),this.featureMenuOpen=!1,this._focusFeatureMenuButton=!0,this.scheduleRender()}_next(){this.next()}_previous(){this.previous()}};u([d({readOnly:!0})],_t.prototype,"actionsMenuId",null),u([d({readOnly:!0})],_t.prototype,"actionsMenuButtonId",null),u([d({readOnly:!0})],_t.prototype,"featureMenuId",null),u([d({readOnly:!0})],_t.prototype,"titleId",null),u([d({readOnly:!0})],_t.prototype,"contentId",null),u([d({readOnly:!0})],_t.prototype,"hasContent",null),u([d({readOnly:!0})],_t.prototype,"featureNavigationVisible",null),u([d({readOnly:!0})],_t.prototype,"collapsible",null),u([d({readOnly:!0})],_t.prototype,"featureMenuVisible",null),u([d({readOnly:!0})],_t.prototype,"contentCollapsed",null),u([d({readOnly:!0})],_t.prototype,"dividedActions",null),u([mt("viewModel.actions")],_t.prototype,"actions",void 0),u([d()],_t.prototype,"actionsMenuOpen",null),u([d()],_t.prototype,"alignment",void 0),u([mt("viewModel.autoCloseEnabled")],_t.prototype,"autoCloseEnabled",void 0),u([mt("viewModel.autoOpenEnabled")],_t.prototype,"autoOpenEnabled",void 0),u([mt("viewModel.defaultPopupTemplateEnabled")],_t.prototype,"defaultPopupTemplateEnabled",void 0),u([mt("viewModel.content")],_t.prototype,"content",void 0),u([d()],_t.prototype,"collapsed",void 0),u([d()],_t.prototype,"collapseEnabled",void 0),u([d({readOnly:!0})],_t.prototype,"currentAlignment",null),u([d({readOnly:!0})],_t.prototype,"currentDockPosition",null),u([d()],_t.prototype,"dockOptions",null),u([d()],_t.prototype,"dockEnabled",void 0),u([mt("viewModel.featureCount")],_t.prototype,"featureCount",void 0),u([d()],_t.prototype,"featureMenuOpen",void 0),u([mt("viewModel.features")],_t.prototype,"features",void 0),u([mt("viewModel.goToOverride")],_t.prototype,"goToOverride",void 0),u([d()],_t.prototype,"headingLevel",void 0),u([mt("viewModel.highlightEnabled")],_t.prototype,"highlightEnabled",void 0),u([mt("viewModel.location")],_t.prototype,"location",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],_t.prototype,"label",void 0),u([d()],_t.prototype,"maxInlineActions",void 0),u([d(),fl("esri/widgets/Popup/t9n/Popup")],_t.prototype,"messages",void 0),u([d(),fl("esri/t9n/common")],_t.prototype,"messagesCommon",void 0),u([mt("viewModel.promises")],_t.prototype,"promises",void 0),u([mt("viewModel.selectedFeature")],_t.prototype,"selectedFeature",void 0),u([mt("viewModel.selectedFeatureIndex")],_t.prototype,"selectedFeatureIndex",void 0),u([d({readOnly:!0})],_t.prototype,"selectedFeatureWidget",null),u([d()],_t.prototype,"spinnerEnabled",void 0),u([mt("viewModel.title")],_t.prototype,"title",void 0),u([mt("viewModel.updateLocationEnabled")],_t.prototype,"updateLocationEnabled",void 0),u([mt("viewModel.view")],_t.prototype,"view",void 0),u([d({type:vme}),z$e(["triggerAction","trigger-action"])],_t.prototype,"viewModel",void 0),u([mt("viewModel.visible")],_t.prototype,"visible",void 0),u([d()],_t.prototype,"visibleElements",void 0),u([At("visibleElements")],_t.prototype,"castVisibleElements",null),u([lu()],_t.prototype,"_close",null),u([lu()],_t.prototype,"_toggleDockEnabled",null),u([lu()],_t.prototype,"_toggleFeatureMenu",null),u([lu()],_t.prototype,"_toggleActionsMenu",null),u([lu()],_t.prototype,"_triggerAction",null),u([lu()],_t.prototype,"_selectFeature",null),u([lu()],_t.prototype,"_next",null),u([lu()],_t.prototype,"_previous",null),_t=u([P(_me)],_t);const TK=_t,DU=[0,0];function k6e(e){const t=(e.ownerDocument||window.document).defaultView,i=e.getBoundingClientRect();return DU[0]=i.left+t.pageXOffset,DU[1]=i.top+t.pageYOffset,DU}function SK(e){e&&(Sce(e),e.parentNode&&e.parentNode.removeChild(e))}function z6e(e){const t=document.createElement("div");return e.appendChild(t),t}const M2=16,KM=750,B6e=512,V6e=2,G6e=e=>{let t=class extends e{constructor(...i){super(...i),this._freqInfo={freq:M2,time:KM},this._overlayRenderTaskHandle=null,this.height=0,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.ui=null,this.userContent=null,this.width=0,this.widthBreakpoint=null,this.handles.add([this.watch("cursor",r=>{const s=this.surface;s&&s.setAttribute("data-cursor",r)}),this.watch("interacting",r=>{const s=this.surface;s&&s.setAttribute("data-interacting",r.toString())})])}initialize(){this.handles.add(this.watch("ui",(i,r)=>this._handleUIChange(i,r))),this._wireUI(this.ui),this.handles.add([this.on("focus",()=>this.notifyChange("focused")),this.on("blur",()=>this.notifyChange("focused"))])}destroy(){this.destroyed||(this.ui&&(this.ui.destroy(),this.ui=null),this.popup&&!this.popup.destroyed&&this.popup.destroy(),this.container=null)}set container(i){const r=this._get("container");if(r===i)return;const s="dom-size";if(this.handles.remove(s),this._stopMeasuring(),r&&(r.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay.destroy(),this._set("overlay",null),SK(this.root),this._set("root",null),ZY(this.userContent,r),SK(this.userContent),this._set("userContent",null)),i){i.classList.add("esri-view");const n=document.createElement("div");n.className="esri-view-user-storage",ZY(i,n),i.appendChild(n),this._set("userContent",n);const o=document.createElement("div");o.className="esri-view-root",i.insertBefore(o,i.firstChild),this._set("root",o);const a=document.createElement("div");a.className="esri-view-surface",a.setAttribute("role","application"),a.tabIndex=0,o.appendChild(a),this._set("surface",a);const l=new qZ;o.appendChild(l.surface),this._set("overlay",l),l.watch("needsRender",c=>{c&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=_1({render:()=>{this.overlay.render()}}):this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null)}),this.forceDOMReadyCycle(),this.handles.add(Nt(()=>this.size,c=>{const[h,p]=c,f="esri-view-surface--inset-outline";h>=document.body.clientWidth||p>=document.body.clientHeight?a.classList.add(f):a.classList.remove(f)},fn),s),this._set("container",i),this._startMeasuring()}else this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),this._set("container",null)}get focused(){const i=document.activeElement===this.surface;return document.hasFocus()&&i}get popup(){return this._get("popup")||new TK({view:this})}set popup(i){const r=this._get("popup");r&&r!==i&&r.destroy(),this._set("popup",i)}get size(){return[this.width,this.height]}blur(){this.surface&&this.surface.blur()}focus(){this.surface&&this.surface.focus()}pageToContainer(i,r,s){const n=this.position;return i-=n[0],r-=n[1],s?(s[0]=i,s[1]=r):s=[i,r],s}containerToPage(i,r,s){const n=this.position;return i+=n[0],r+=n[1],s?(s[0]=i,s[1]=r):s=[i,r],s}_handleUIChange(i,r){r&&(this.handles.remove("ui"),r.destroy()),i&&this._wireUI(i),this._set("ui",i)}_wireUI(i){this.handles.remove("ui"),i&&(i.view=this,this.handles.add([Nt(()=>this.root,r=>{i.container=r?z6e(r):null},fn),Nt(()=>this.popup,(r,s)=>{const n="popup",o="manual";s&&i.remove(s,n),r&&(r.view=i.view,i.add(r,{key:n,position:o}))},fn)],"ui"))}_stopMeasuring(){this.handles.remove("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){const i=this._freqInfo;i.freq=M2,i.time=KM,this.handles.add([(()=>{const r=()=>{i.freq=M2,i.time=KM};return window.addEventListener("resize",r),{remove(){window.removeEventListener("resize",r)}}})(),_1({prepare:r=>{const s=this._measure(),n=this._freqInfo;if(n.time+=r.deltaTime,s&&(n.freq=M2,this._get("resizing")||this._set("resizing",!0)),n.time<n.freq)return;n.time=0;const o=this._position();n.freq=o||s?M2:Math.min(KM,n.freq*V6e),!s&&n.freq>=B6e&&this._get("resizing")&&this._set("resizing",!1)}})],"measuring"),this._measure(),this._position()}_measure(){const i=this.container,r=i?i.clientWidth:0,s=i?i.clientHeight:0;if(r===0||s===0)return this.suspended||this._set("suspended",!0),!1;const n=this.width,o=this.height;return r===n&&s===o?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",r),this._set("height",s),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:n,oldHeight:o,width:r,height:s}),!0)}_position(){const i=this.container,r=this.position,s=k6e(i);return(!r||s[0]!==r[0]||s[1]!==r[1])&&(this._set("position",[s[0],s[1]]),!0)}forceDOMReadyCycle(){}};return u([d({value:null,cast:i=>KN(i)})],t.prototype,"container",null),u([d({readOnly:!0})],t.prototype,"focused",null),u([d({readOnly:!0})],t.prototype,"height",void 0),u([d({type:TK})],t.prototype,"popup",null),u([d({type:qZ})],t.prototype,"overlay",void 0),u([d({readOnly:!0})],t.prototype,"position",void 0),u([d({readOnly:!0})],t.prototype,"resizing",void 0),u([d({readOnly:!0})],t.prototype,"root",void 0),u([d({value:null,readOnly:!0})],t.prototype,"size",null),u([d({readOnly:!0})],t.prototype,"surface",void 0),u([d({readOnly:!0})],t.prototype,"suspended",void 0),u([d()],t.prototype,"ui",void 0),u([d({readOnly:!0})],t.prototype,"userContent",void 0),u([d({readOnly:!0})],t.prototype,"width",void 0),u([d()],t.prototype,"widthBreakpoint",void 0),t=u([P("esri.views.DOMContainer")],t),t},nq=he.getLogger("esri.layers.support.ElevationSampler");class bme{queryElevation(t){return wme(t.clone(),this)}on(){return X6e}projectIfRequired(t,i){return xme(t,i)}}class j6e extends bme{constructor(t,i,r){super(),this.tile=t,this.noDataValue=r,this.extent=BN(t.tile.extent,i.spatialReference);const s=Cl(i.spatialReference),n=i.lodAt(t.tile.level).resolution*s;this.demResolution={min:n,max:n}}get spatialReference(){return this.extent.spatialReference}contains(t){const i=this.projectIfRequired(t,this.spatialReference);return aO(this.extent,i)}elevationAt(t){const i=this.projectIfRequired(t,this.spatialReference);if(R(i))return null;if(!this.contains(t)){const r=this.extent,s=`${r.xmin}, ${r.ymin}, ${r.xmax}, ${r.ymax}`;return nq.warn("#elevationAt()",`Point used to sample elevation (${t.x}, ${t.y}) is outside of the sampler extent (${s})`),this.noDataValue}return this.tile.sample(i.x,i.y)}}class myt extends bme{constructor(t,i,r){let s;super(),typeof i=="number"?(this.noDataValue=i,s=null):(s=i,this.noDataValue=r),this.samplers=s?t.map(o=>new j6e(o,s,this.noDataValue)):t;const n=this.samplers[0];if(n){this.extent=n.extent.clone();const{min:o,max:a}=n.demResolution;this.demResolution={min:o,max:a};for(let l=1;l<this.samplers.length;l++){const c=this.samplers[l];this.extent.union(c.extent),this.demResolution.min=Math.min(this.demResolution.min,c.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,c.demResolution.max)}}else this.extent=BN(Dt(),s.spatialReference),this.demResolution={min:0,max:0}}get spatialReference(){return this.extent.spatialReference}elevationAt(t){const i=this.projectIfRequired(t,this.spatialReference);if(!i)return null;for(const r of this.samplers)if(r.contains(i))return r.elevationAt(i);return nq.warn("#elevationAt()",`Point used to sample elevation (${t.x}, ${t.y}) is outside of the sampler`),this.noDataValue}}function wme(e,t){const i=xme(e,t.spatialReference);if(!i)return null;switch(e.type){case"point":H6e(e,i,t);break;case"polyline":q6e(e,i,t);break;case"multipoint":W6e(e,i,t)}return e}function xme(e,t){if(R(e))return null;const i=e.spatialReference;if(i.equals(t))return e;const r=sb(e,t);return r||nq.error(`Cannot project geometry spatial reference (wkid:${i.wkid}) to elevation sampler spatial reference (wkid:${t.wkid})`),r}function H6e(e,t,i){e.z=gt(i.elevationAt(t),0)}function q6e(e,t,i){Yy.spatialReference=t.spatialReference;const r=e.hasM&&!e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s],o=t.paths[s];for(let a=0;a<n.length;a++){const l=n[a],c=o[a];Yy.x=c[0],Yy.y=c[1],r&&(l[3]=l[2]),l[2]=gt(i.elevationAt(Yy),0)}}e.hasZ=!0}function W6e(e,t,i){Yy.spatialReference=t.spatialReference;const r=e.hasM&&!e.hasZ;for(let s=0;s<e.points.length;s++){const n=e.points[s],o=t.points[s];Yy.x=o[0],Yy.y=o[1],r&&(n[3]=n[2]),n[2]=gt(i.elevationAt(Yy),0)}e.hasZ=!0}const Yy=new et,X6e={remove(){}};function mL(e){return e.type==="point"}class Tme{constructor(t,i=null,r=0){this.array=t,this.spatialReference=i,this.offset=r}}function Sme(e){return"array"in e}function Vh(e,t,i="ground"){if(mL(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,i);if(Sme(t)){let r=t.offset;return e.getElevation(t.array[r++],t.array[r++],t.array[r]||0,gt(t.spatialReference,e.spatialReference),i)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,i)}var h9;let zd=h9=class extends fe{constructor(e){super(e),this.cols=null,this.level=0,this.levelValue=null,this.origin=null,this.resolution=0,this.rows=null,this.scale=0}clone(){return new h9({cols:this.cols,level:this.level,levelValue:this.levelValue,resolution:this.resolution,rows:this.rows,scale:this.scale})}};u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],zd.prototype,"cols",void 0),u([d({type:ir,json:{write:!0}})],zd.prototype,"level",void 0),u([d({type:String,json:{write:!0}})],zd.prototype,"levelValue",void 0),u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],zd.prototype,"origin",void 0),u([d({type:Number,json:{write:!0}})],zd.prototype,"resolution",void 0),u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],zd.prototype,"rows",void 0),u([d({type:Number,json:{write:!0}})],zd.prototype,"scale",void 0),zd=h9=u([P("esri.layers.support.LOD")],zd);const Eme=zd;var ry;const EK=new si({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc",LERC2D:"lerc2d",RAW:"raw",pbf:"pbf"});let un=ry=class extends fe{constructor(e){super(e),this.dpi=96,this.format=null,this.origin=null,this.minScale=0,this.maxScale=0,this.size=null,this.spatialReference=null}static create(e={}){const{resolutionFactor:t=1,scales:i,size:r=256,spatialReference:s=He.WebMercator,numLODs:n=24}=e;if(!_c(s)){const p=[];if(i)for(let f=0;f<i.length;f++){const g=i[f];p.push({level:f,scale:g,resolution:g})}else{let f=5e-4;for(let g=n-1;g>=0;g--)p.unshift({level:g,scale:f,resolution:f}),f*=2}return new ry({dpi:96,lods:p,origin:new et(0,0,s),size:[r,r],spatialReference:s})}const o=s0(s),a=e.origin?new et({x:e.origin.x,y:e.origin.y,spatialReference:s}):new et(o?{x:o.origin[0],y:o.origin[1],spatialReference:s}:{x:0,y:0,spatialReference:s}),l=96,c=1/(Cl(s)*39.37*l),h=[];if(i)for(let p=0;p<i.length;p++){const f=i[p],g=f*c;h.push({level:p,scale:f,resolution:g})}else{let p=Cae(s)?512/r*5916575275917094e-7:256/r*591657527591555e-6;const f=Math.ceil(n/t);h.push({level:0,scale:p,resolution:p*c});for(let g=1;g<f;g++){const y=p/2**t,v=y*c;h.push({level:g,scale:y,resolution:v}),p=y}}return new ry({dpi:l,lods:h,origin:a,size:[r,r],spatialReference:s})}get isWrappable(){const{spatialReference:e,origin:t}=this;if(e&&t){const i=s0(e);return e.isWrappable&&Math.abs(i.origin[0]-t.x)<=i.dx}return!1}readOrigin(e,t){return et.fromJSON(I({spatialReference:t.spatialReference},e))}set lods(e){let t=0,i=0;const r=[];this._levelToLOD={},e&&(t=-1/0,i=1/0,e.forEach(s=>{r.push(s.scale),t=s.scale>t?s.scale:t,i=s.scale<i?s.scale:i,this._levelToLOD[s.level]=s})),this._set("scales",r),this._set("minScale",t),this._set("maxScale",i),this._set("lods",e),this._initializeUpsampleLevels()}readSize(e,t){return[t.cols,t.rows]}writeSize(e,t){t.cols=e[0],t.rows=e[1]}zoomToScale(e){const t=this.scales;if(e<=0)return t[0];if(e>=t.length-1)return t[t.length-1];{const i=Math.floor(e),r=i+1;return t[i]/(t[i]/t[r])**(e-i)}}scaleToZoom(e){const t=this.scales,i=t.length-1;let r=0;for(;r<i;r++){const s=t[r],n=t[r+1];if(s<=e)return r;if(n===e)return r+1;if(s>e&&n<e)return r+Math.log(s/e)/Math.log(s/n)}return r}snapScale(e,t=.95){const i=this.scaleToZoom(e);return i%Math.floor(i)>=t?this.zoomToScale(Math.ceil(i)):this.zoomToScale(Math.floor(i))}tileAt(e,t,i,r){const s=this.lodAt(e);if(!s)return null;let n,o;if(typeof t=="number")n=t,o=i;else if(Rc(t.spatialReference,this.spatialReference))n=t.x,o=t.y,r=i;else{const c=sb(t,this.spatialReference);if(R(c))return null;n=c.x,o=c.y,r=i}const a=s.resolution*this.size[0],l=s.resolution*this.size[1];return r||(r={id:null,level:0,row:0,col:0,extent:Dt()}),r.level=e,r.row=Math.floor((this.origin.y-o)/l+.001),r.col=Math.floor((n-this.origin.x)/a+.001),this.updateTileInfo(r),r}updateTileInfo(e,t=ry.ExtrapolateOptions.NONE){let i=this.lodAt(e.level);if(!i&&t===ry.ExtrapolateOptions.POWER_OF_TWO){const o=this.lods[this.lods.length-1];o.level<e.level&&(i=o)}if(!i)return;const r=e.level-i.level,s=i.resolution*this.size[0]/2**r,n=i.resolution*this.size[1]/2**r;e.id=`${e.level}/${e.row}/${e.col}`,e.extent||(e.extent=Dt()),e.extent[0]=this.origin.x+e.col*s,e.extent[1]=this.origin.y-(e.row+1)*n,e.extent[2]=e.extent[0]+s,e.extent[3]=e.extent[1]+n}upsampleTile(e){const t=this._upsampleLevels[e.level];return!(!t||t.parentLevel===-1)&&(e.level=t.parentLevel,e.row=Math.floor(e.row/t.factor+.001),e.col=Math.floor(e.col/t.factor+.001),this.updateTileInfo(e),!0)}getTileBounds(e,t){const{resolution:i}=this.lodAt(t.level),r=i*this.size[0],s=i*this.size[1];return e[0]=this.origin.x+t.col*r,e[1]=this.origin.y-(t.row+1)*s,e[2]=e[0]+r,e[3]=e[1]+s,e}lodAt(e){return this._levelToLOD&&this._levelToLOD[e]||null}clone(){return ry.fromJSON(this.write({}))}getOrCreateCompatible(e,t){if(this.size[0]===256&&this.size[1]===256)return e===256?this:null;const i=[],r=this.lods.length;for(let s=0;s<r;s++){const n=this.lods[s],o=n.resolution*t;i.push(new Eme({level:n.level,scale:n.scale,resolution:o}))}return new ry({size:[e,e],dpi:this.dpi,format:this.format,compressionQuality:this.compressionQuality,origin:this.origin,spatialReference:this.spatialReference,lods:i})}_initializeUpsampleLevels(){const e=this.lods;this._upsampleLevels=[];let t=null;for(let i=0;i<e.length;i++){const r=e[i];this._upsampleLevels[r.level]={parentLevel:t?t.level:-1,factor:t?t.resolution/r.resolution:0},t=r}}};u([d({type:Number,json:{write:!0}})],un.prototype,"compressionQuality",void 0),u([d({type:Number,json:{write:!0}})],un.prototype,"dpi",void 0),u([d({type:String,json:{read:EK.read,write:EK.write,origins:{"web-scene":{read:!1,write:!1}}}})],un.prototype,"format",void 0),u([d({readOnly:!0})],un.prototype,"isWrappable",null),u([d({type:et,json:{write:!0}})],un.prototype,"origin",void 0),u([De("origin")],un.prototype,"readOrigin",null),u([d({type:[Eme],value:null,json:{write:!0}})],un.prototype,"lods",null),u([d({readOnly:!0})],un.prototype,"minScale",void 0),u([d({readOnly:!0})],un.prototype,"maxScale",void 0),u([d({readOnly:!0})],un.prototype,"scales",void 0),u([d({cast:e=>Array.isArray(e)?e:typeof e=="number"?[e,e]:[256,256]})],un.prototype,"size",void 0),u([De("size",["rows","cols"])],un.prototype,"readSize",null),u([Fe("size",{cols:{type:ir},rows:{type:ir}})],un.prototype,"writeSize",null),u([d({type:He,json:{write:!0}})],un.prototype,"spatialReference",void 0),un=ry=u([P("esri.layers.support.TileInfo")],un),function(e){var t;(t=e.ExtrapolateOptions||(e.ExtrapolateOptions={}))[t.NONE=0]="NONE",t[t.POWER_OF_TWO=1]="POWER_OF_TWO"}(un||(un={}));const r$=un,Y6e=12;class or{constructor(t){const i=or.checkUnsupported(t);if(_(i))throw i;const r=t;this.spatialReference=r.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=I1(this.spatialReference)||Lp(this.spatialReference)||Np(this.spatialReference),this.origin=[r.origin.x,r.origin.y],this.pixelSize=r.size[0],this.dpi=r.dpi;const s=r.lods.reduce(function(c,h,p){return h.level<c.min&&(c.min=h.level,c.minIndex=p),c.max=Math.max(c.max,h.level),c},{min:1/0,minIndex:0,max:-1/0}),n=r.lods[s.minIndex],o=2**n.level;let a=n.resolution*o,l=n.scale*o;this.levels=new Array(s.max+1);for(let c=0;c<this.levels.length;c++)this.levels[c]={resolution:a,scale:l,tileSize:[a*r.size[0],a*r.size[1]]},a/=2,l/=2}clone(){return new or(this.toTileInfo())}toTileInfo(){return new r$({dpi:this.dpi,origin:{x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference},size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((t,i)=>({level:i,scale:t.scale,resolution:t.resolution}))})}getExtent(t,i,r,s){const n=this.levels[t],o=n.tileSize[0],a=n.tileSize[1];s[0]=this.origin[0]+r*o,s[2]=s[0]+o,s[3]=this.origin[1]-i*a,s[1]=s[3]-a}convertExtentToRadians(t,i){this._isWebMercator?(i[0]=fY(t[0]),i[1]=bD(t[1]),i[2]=fY(t[2]),i[3]=bD(t[3])):this._isGCS&&(i[0]=Rt(t[0]),i[1]=Rt(t[1]),i[2]=Rt(t[2]),i[3]=Rt(t[3]))}getExtentGeometry(t,i,r,s=new Xt){return this.getExtent(t,i,r,hd),s.spatialReference=this.spatialReference,s.xmin=hd[0],s.ymin=hd[1],s.xmax=hd[2],s.ymax=hd[3],s.zmin=void 0,s.zmax=void 0,s}ensureMaxLod(t){if(t==null)return!1;let i=!1;for(;this.levels.length<=t;){const r=this.levels[this.levels.length-1],s=r.resolution/2;this.levels.push({resolution:s,scale:r.scale/2,tileSize:[s*this.pixelSize,s*this.pixelSize]}),i=!0}return i}capMaxLod(t){this.levels.length>t+1&&(this.levels.length=t+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(t){return this.levels[0].scale/2**t}levelAtScale(t){const i=this.levels[0].scale;return t>=i?0:Math.log(i/t)*Math.LOG2E}resolutionAtLevel(t){return this.levels[0].resolution/2**t}compatibleWith(t){if(!(t instanceof or)){if(or.checkUnsupported(t))return!1;t=new or(t)}if(!t.spatialReference.equals(this.spatialReference)||t.pixelSize!==this.pixelSize)return!1;const i=Math.min(this.levels.length,t.levels.length)-1,r=this.levels[i].resolution;let s=.5*r;return!h5(t.origin[0],this.origin[0],s)||!h5(t.origin[1],this.origin[1],s)?!1:(s=.5*r/2**i/this.pixelSize*Y6e,h5(r,t.levels[i].resolution,s))}rootTilesInExtent(t,i=null,r=1/0){const s=new Array,n=this.levels[0].tileSize;if(R(t)||n[0]===0||n[1]===0)return s;or.computeRowColExtent(t,n,this.origin,hd);let o=hd[1],a=hd[3],l=hd[0],c=hd[2];const h=c-l,p=a-o;if(h*p>r){const f=Math.floor(Math.sqrt(r));p>f&&(o=o+Math.floor(.5*p)-Math.floor(.5*f),a=o+f),h>f&&(l=l+Math.floor(.5*h)-Math.floor(.5*f),c=l+f)}for(let f=o;f<a;f++)for(let g=l;g<c;g++)s.push([0,f,g]);return _(i)&&(i[0]=this.origin[0]+l*n[0],i[1]=this.origin[1]-a*n[1],i[2]=this.origin[0]+c*n[0],i[3]=this.origin[1]-o*n[1]),s}static computeRowColExtent(t,i,r,s){const n=.001*(t[2]-t[0]+(t[3]-t[1]));s[0]=Math.max(0,Math.floor((t[0]+n-r[0])/i[0])),s[2]=Math.max(0,Math.ceil((t[2]-n-r[0])/i[0])),s[1]=Math.max(0,Math.floor((r[1]-t[3]+n)/i[1])),s[3]=Math.max(0,Math.ceil((r[1]-t[1]-n)/i[1]))}static isPowerOfTwo(t){const i=t.lods,r=i[0].resolution*2**i[0].level;return!i.some(function(s){return!kxe(s.resolution,r/2**s.level)})}static hasGapInLevels(t){const i=t.lods.map(function(r){return r.level});i.sort(function(r,s){return r-s});for(let r=1;r<i.length;r++)if(i[r]!==i[0]+r)return!0;return!1}static tileSizeSupported(t){const i=t.size[1];return i===t.size[0]&&(i&i-1)==0&&i>=128&&i<=512}static hasOriginPerLODs(t){const i=t.origin;return t.lods.some(r=>r.origin!=null&&(r.origin[0]!==i.x||r.origin[1]!==i.y))}static getMissingTileInfoError(){return new q("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(t){return R(t)?oq():t.lods.length<1?new q("tilingscheme:generic","Tiling scheme must have at least one level"):or.isPowerOfTwo(t)?or.hasGapInLevels(t)?new q("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):or.tileSizeSupported(t)?or.hasOriginPerLODs(t)?new q("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new q("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new q("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(t,i){const r=t[2]-t[0],s=t[3]-t[1],n=Cl(i),o=1.2*Math.max(r,s),a=256,l=96,c=.0254,h=new or(new r$({size:[a,a],origin:{x:t[0]-.5*(o-r),y:t[3]+.5*(o-s)},lods:[{level:0,resolution:o/a,scale:1/(a/l*c/(o*n))}],spatialReference:i}));return h.ensureMaxLod(20),h}static makeWebMercatorAuxiliarySphere(t){const i=new or(or.WebMercatorAuxiliarySphereTileInfo);return i.ensureMaxLod(t),i}static makeGCSWithTileSize(t,i=256,r=16){const s=256/i,n=new or(new r$({size:[i,i],origin:{x:-180,y:90,spatialReference:t},spatialReference:t,lods:[{level:0,resolution:.703125*s,scale:295497598570834e-6*s}]}));return n.ensureMaxLod(r),n}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}function oq(){return new q("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}or.WebMercatorAuxiliarySphereTileInfo=new r$({size:[256,256],origin:{x:-20037508342787e-6,y:20037508342787e-6,spatialReference:He.WebMercator},spatialReference:He.WebMercator,lods:[{level:0,resolution:156543.03392800014,scale:591657527591555e-6}]}),or.WebMercatorAuxiliarySphere=or.makeWebMercatorAuxiliarySphere(19);const hd=Dt(),Ix=64,CO=512,Z6e=2.5,sR=zxe(t6/10),Ame=4,Q6e=4,s$=e=>e<4?3:Q6e,Cme=Dt();or.WebMercatorAuxiliarySphere.getExtent(0,0,0,Cme);const J6e=Dt([-180,-90,180,90]),K6e="Cannot extend surface to encompass all layers because it would result in too many root tiles.",eBe="Surface extent is too large for tile resolution at level 0.",Rme="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAIAAADTED8xAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAA2JJREFUeNrs3d1O20AQgFFvRJInQLQBhHj/h0JVW34El1yQ2F73DVq3jTys55zrqUBbPrErZUSZ+vcOsto4AjK76Lqu1vr8+G3mPzjc3D/+eJj/Bcz/cd75R80fbu79BsAVCAQAAgABgABAACAAEAAIAAQAAgABQPOKfQAy83Ho+HnnHzXv49B4A4AAQAAgABAACAAEAAIAAYAAQAAgABAANM4+AKnZB4ifd/5R8/YB8AYAAYAAQAAgABAACAAEAAIAAYAAQAAgAGicfQBSsw8QP+/8o+btA+ANAAIAAYAAQAAgABAACAAEAAIAAYAAQADQOPsApGYfIH7e+UfN2wfAGwAEAAIAAYAAQAAgABAACAAEAAIAAXA201QdggAggH0AUrMPED8/jsPL03fns/y8fQC8AUAAIAAQAAgABAACAAGAAEAAIAAQAAgAGmcfgNTsA8TP2weImrcPgDcACAAEAAIAAYAAQAAgABAACAAEAAIAAUDj7AOQmn2A+Hn7AFHz9gHwBgABgABAACAAEAAIAAQAAgABgABgNS4cAf9pu9u3O1+m/n2aplKK/0j+TX86/tVP5+eZ3+729gFIfwWyDxA7bx8gat4+ANkJAAGAAEAAIAAQAAgABAACAAGAAEAAIABonn0AUrMPED9vHyBq3j4A3gAgABAACAAEAAIAAYAAQAAgABAA51VrdQgCAAHAsuwDkJp9gPj5vj+9vvx0PsvP2wfAGwAEAAIAAYAAQAAgABAACAAEAAIAAYAAoHH2AUjNPkD8vH2AqHn7AHgDgABAACAAEAAIAAQAAgABgABAACAAEAA0zj4AqdkHiJ+3DxA1bx8AbwAQACQ0DL0AyKuOowBwBYKUSikCIHUBAsAVCAQAAgABgABAALBy9gFIzT5A/Lx9gKj5y6trVyC8AUAAIAAQAAgAVq90Pg5N5gA2AsAVCAQAAgABgABAALB29gFIzT5A/Lx9gKj5q6+3rkB4A4AAQAAgABAACADWzB/IIHsCAsAVCARAlKlWhyAAEAAIABZjH4DU7APEz5+OH2+vT85n+fkvhztXILwBQAAgABAACAAEAGtWigBIHcBGALgCgQBAACAAyPMO9nHosxuHodZx5vB2t691HIdh/nx/Os7/Zsz/fvgXAAAA//8DAF1P1hM2ICMfAAAAAElFTkSuQmCC",gL=5,AK=he.getLogger("esri.views.support.GroundViewElevationSampler");let sy=class extends xr.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=sR}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get extent(){const e=this.view.basemapTerrain;return _(e.extent)&&e.spatialReference?BN(e.extent,e.spatialReference):null}elevationAt(e){const t=e.spatialReference,i=this.spatialReference;if(!pm(t,i)){const r=t?t.wkid:"unknown";return AK.error(`Cannot sample elevation at a location with spatial reference (${r}) different from the view (${i.wkid})`),null}if(R(this.extent)||!aO(this.extent,e)){const r=_(this.extent)?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return AK.warn("#elevationAt()",`Point used to sample elevation (${e.x}, ${e.y}) is outside of the sampler extent (${r})`),this.noDataValue}return Vh(this.view.elevationProvider,e)}queryElevation(e){return wme(e.clone(),this)}};u([d({readOnly:!0})],sy.prototype,"demResolution",void 0),u([d({readOnly:!0})],sy.prototype,"extent",null),u([d({readOnly:!0})],sy.prototype,"noDataValue",void 0),u([d({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],sy.prototype,"spatialReference",void 0),u([d({constructOnly:!0})],sy.prototype,"view",void 0),sy=u([P("esri.views.support.GroundViewElevationSampler")],sy);const tBe=sy;let ny=class extends we{constructor(e){super(e),this.handles=new Ut,this.view=null,this.layerViews=new it}initialize(){this.handles.add(eH(this,"view.map.ground",e=>e.load())),this.handles.add(this.layerViews.on("after-changes",()=>this._layerViewsAfterChangesHandler()))}destroy(){this._set("view",null),this.handles&&(this.handles.destroy(),this.handles=null)}get elevationSampler(){return this.view?this.view.type==="2d"?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new tBe({view:this.view}):null:null}get updating(){return!this.suspended&&this.layerViews.some(e=>e.updating)}get suspended(){return!this.view||this.view.suspended}_layerViewsAfterChangesHandler(){this.handles.remove("updating"),this.handles.add(this.layerViews.map(e=>e.watch("updating",()=>this._updateUpdating(),!0)).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};u([d({readOnly:!0})],ny.prototype,"elevationSampler",null),u([d({type:Boolean,readOnly:!0})],ny.prototype,"updating",null),u([d({constructOnly:!0})],ny.prototype,"view",void 0),u([d({type:it,readOnly:!0})],ny.prototype,"layerViews",void 0),u([d({readOnly:!0})],ny.prototype,"suspended",null),ny=u([P("esri.views.GroundView")],ny);const iBe=ny,rBe=e=>{let t=class extends e{async fetchPopupFeatures(i,r){await this.when();const{location:s,queryArea:n,layerViewsAndGraphics:o,clientOnlyGraphics:a}=await this._prepareFetchPopupFeatures(i,r),l=Promise.resolve(a),c=this._queryLayerPopupFeatures(n,o,r),h=c.map(p=>p.promise);return{location:s,clientOnlyGraphics:a,allGraphicsPromise:gTe([l,...h]).then(p=>Array.from(new Set(p.flat()))),promisesPerLayerView:c}}_queryLayerPopupFeatures(i,r,s){return r.map(({layerView:n,graphics:o})=>{const a={clientGraphics:o,event:_(s)?s.event:null,signal:_(s)?s.signal:null,defaultPopupTemplateEnabled:!!_(s)&&!!s.defaultPopupTemplateEnabled},l=n.fetchPopupFeatures(i,a);return{layerView:n,promise:l}})}_isValidPopupGraphic(i,r){return i&&!!i.getEffectivePopupTemplate(_(r)&&r.defaultPopupTemplateEnabled)}async _prepareFetchPopupFeatures(i,r){const{clientGraphics:s,queryArea:n,location:o}=await this._popupHitTestGraphics(i,r),a=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:l,clientOnlyGraphics:c}=this._graphicsPerFetchPopupLayerView(s,a);return{clientOnlyGraphics:c,layerViewsAndGraphics:l,queryArea:n,location:o}}async _popupHitTestGraphics(i,r){const{results:s,mapPoint:n}=await this.popupHitTest(i),o=s.filter(l=>this._isValidPopupGraphic(l.graphic,r)),a=o.length?o[0].mapPoint:null;return{clientGraphics:o.map(l=>l.graphic),queryArea:n,location:n||a}}_getFetchPopupLayerViews(){const i=[];return this.allLayerViews.forEach(r=>{this._isValidPopupLayerView(r)&&i.push(r)}),_(this.graphicsView)&&this._isValidPopupLayerView(this.graphicsView)&&i.push(this.graphicsView),i.reverse()}_isValidPopupLayerView(i){return _(i)&&(!("layer"in i)||!i.suspended)&&"fetchPopupFeatures"in i}_graphicsPerFetchPopupLayerView(i,r){const s=[],n=new Map,o=r.map(a=>{const l=[];return"layer"in a?n.set(a.layer,l):n.set(a.graphics,l),{layerView:a,graphics:l}});for(const a of i){const l=n.get(a.layer)||n.get(a.sourceLayer)||null;l?l.push(a):s.push(a)}return{layerViewsAndGraphics:o,clientOnlyGraphics:s}}};return t=u([P("esri.views.PopupView")],t),t};async function sBe(e){if(!e)return;const t=e.indexOf("-vector")>-1?e.slice(0,e.indexOf("-vector")):e,i=await Rce("esri/t9n/basemaps");return i[e]||i[t]}const d9={streets:{id:"streets",classic:!0,deprecated:!0,get thumbnailUrl(){return ui("esri/images/basemap/streets.jpg")},baseMapLayers:[{id:"streets-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Street Map",showLegend:!1,visibility:!0,opacity:1}]},satellite:{id:"satellite",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/satellite.jpg")},baseMapLayers:[{id:"satellite-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Imagery",showLegend:!1,visibility:!0,opacity:1}]},hybrid:{id:"hybrid",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/hybrid.jpg")},baseMapLayers:[{id:"hybrid-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Imagery",showLegend:!1,visibility:!0,opacity:1},{id:"hybrid-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Boundaries and Places",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},terrain:{id:"terrain",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/terrain.jpg")},baseMapLayers:[{id:"terrain-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Terrain Base",showLegend:!1,visibility:!0,opacity:1},{id:"terrain-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Reference Overlay",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},topo:{id:"topo",classic:!0,deprecated:!0,get thumbnailUrl(){return ui("esri/images/basemap/topo.jpg")},baseMapLayers:[{id:"topo-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Topo Map",showLegend:!1,visibility:!0,opacity:1}]},gray:{id:"gray",classic:!0,deprecated:!0,get thumbnailUrl(){return ui("esri/images/basemap/gray.jpg")},baseMapLayers:[{id:"gray-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Light Gray Base",showLegend:!1,visibility:!0,opacity:1},{id:"gray-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Light Gray Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},"dark-gray":{id:"dark-gray",classic:!0,deprecated:!0,get thumbnailUrl(){return ui("esri/images/basemap/dark-gray.jpg")},baseMapLayers:[{id:"dark-gray-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Dark Gray Base",showLegend:!1,visibility:!0,opacity:1},{id:"dark-gray-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Dark Gray Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},oceans:{id:"oceans",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/oceans.jpg")},baseMapLayers:[{id:"oceans-base-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Ocean Base",showLegend:!1,visibility:!0,opacity:1},{id:"oceans-reference-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Ocean Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},"national-geographic":{id:"national-geographic",classic:!0,deprecated:!0,get thumbnailUrl(){return ui("esri/images/basemap/national-geographic.jpg")},baseMapLayers:[{id:"national-geographic-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer",title:"NatGeo World Map",showLegend:!1,layerType:"ArcGISTiledMapServiceLayer",visibility:!0,opacity:1}]},osm:{id:"osm",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/osm.jpg")},baseMapLayers:[{id:"osm-base-layer",layerType:"OpenStreetMap",title:"Open Street Map",showLegend:!1,visibility:!0,opacity:1}]},"dark-gray-vector":{id:"dark-gray-vector",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/dark-gray-vector.jpg")},baseMapLayers:[{id:"dark-gray-base-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/5e9b3685f4c24d8781073dd928ebda50/resources/styles/root.json",layerType:"VectorTileLayer",title:"Dark Gray Base",visibility:!0,opacity:1},{id:"dark-gray-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/747cb7a5329c478cbe6981076cc879c5/resources/styles/root.json",layerType:"VectorTileLayer",title:"Dark Gray Reference",isReference:!0,visibility:!0,opacity:1}]},"gray-vector":{id:"gray-vector",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/gray-vector.jpg")},baseMapLayers:[{id:"gray-base-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/291da5eab3a0412593b66d384379f89f/resources/styles/root.json",layerType:"VectorTileLayer",title:"Light Gray Base",visibility:!0,opacity:1},{id:"gray-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/1768e8369a214dfab4e2167d5c5f2454/resources/styles/root.json",layerType:"VectorTileLayer",title:"Light Gray Reference",isReference:!0,visibility:!0,opacity:1}]},"streets-vector":{id:"streets-vector",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/streets-vector.jpg")},baseMapLayers:[{id:"streets-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/de26a3cf4cc9451298ea173c4b324736/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets",visibility:!0,opacity:1}]},"topo-vector":{id:"topo-vector",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/topo-vector.jpg")},baseMapLayers:[{id:"world-hillshade-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Hillshade",showLegend:!1,visibility:!0,opacity:1},{id:"topo-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/7dc6cea0b1764a1f9af2e679f642f0f5/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Topo",visibility:!0,opacity:1}]},"streets-night-vector":{id:"streets-night-vector",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/streets-night.jpg")},baseMapLayers:[{id:"streets-night-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/86f556a2d1fd468181855a35e344567f/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets Night",visibility:!0,opacity:1}]},"streets-relief-vector":{id:"streets-relief-vector",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/streets-relief.jpg")},baseMapLayers:[{id:"world-hillshade-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Hillshade",showLegend:!1,visibility:!0,opacity:1},{id:"streets-relief-vector-base-layer",styleUrl:"//www.arcgis.com/sharing/rest/content/items/b266e6d17fc345b498345613930fbd76/resources/styles/root.json",title:"World Streets Relief",layerType:"VectorTileLayer",visibility:!0,opacity:1}]},"streets-navigation-vector":{id:"streets-navigation-vector",classic:!0,get thumbnailUrl(){return ui("esri/images/basemap/streets-navigation.jpg")},baseMapLayers:[{id:"streets-navigation-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/63c47b7177f946b49902c24129b87252/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets Navigation",visibility:!0,opacity:1}]},"arcgis-imagery":{get thumbnailUrl(){return ui("esri/images/basemap/hybrid.jpg")},title:"Imagery Hybrid",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Imagery",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/World_Imagery/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Imagery:Labels",title:"Hybrid Reference Layer",isReference:!0}]},"arcgis-imagery-standard":{get thumbnailUrl(){return ui("esri/images/basemap/satellite.jpg")},title:"Imagery",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Imagery",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/World_Imagery/MapServer"}]},"arcgis-imagery-labels":{title:"Hybrid [Reference]",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Imagery:Labels",title:"Hybrid Reference Layer",isReference:!0}]},"arcgis-light-gray":{get thumbnailUrl(){return ui("esri/images/basemap/gray-vector.jpg")},title:"Light Gray Canvas",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:LightGray:Base",title:"Light Gray Canvas Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:LightGray:Labels",title:"Light Gray Canvas Labels",isReference:!0}]},"arcgis-dark-gray":{get thumbnailUrl(){return ui("esri/images/basemap/dark-gray.jpg")},title:"Dark Gray Canvas",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:DarkGray:Base",title:"Dark Gray Canvas Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:DarkGray:Labels",title:"Dark Gray Canvas Labels",isReference:!0}]},"arcgis-navigation":{get thumbnailUrl(){return ui("esri/images/basemap/streets-navigation.jpg")},title:"Navigation",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Navigation",title:"World Navigation Map"}]},"arcgis-navigation-night":{title:"Navigation (Dark Mode)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:NavigationNight",title:"World Navigation Map (Dark Mode)"}]},"arcgis-streets":{get thumbnailUrl(){return ui("esri/images/basemap/streets-vector.jpg")},title:"Streets",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Streets",title:"World Street Map"}]},"arcgis-streets-night":{get thumbnailUrl(){return ui("esri/images/basemap/streets-night.jpg")},title:"Streets (Night)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:StreetsNight",title:"World Street Map (Night)"}]},"arcgis-streets-relief":{get thumbnailUrl(){return ui("esri/images/basemap/streets-relief.jpg")},title:"Streets (with Relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:StreetsRelief:Base",title:"World Street Map (with Relief)"}]},"arcgis-topographic":{get thumbnailUrl(){return ui("esri/images/basemap/topo.jpg")},title:"Topographic",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Topographic:Base",title:"World Topographic Map"}]},"arcgis-oceans":{get thumbnailUrl(){return ui("esri/images/basemap/oceans.jpg")},title:"Oceans",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Ocean Base",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Oceans:Labels",title:"World Ocean Reference",isReference:!0}]},"osm-standard":{title:"OpenStreetMap",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:Standard",title:"OpenStreetMap"}]},"osm-standard-relief":{title:"OpenStreetMap (with relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:StandardRelief:Base",layerType:"VectorTileLayer",title:"OpenStreetMap Relief Base"}]},"osm-streets":{title:"OpenStreetMap (Streets)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:Streets",title:"OpenStreetMap (Streets)"}]},"osm-streets-relief":{title:"OpenStreetMap (Streets with relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:StreetsRelief:Base",layerType:"VectorTileLayer",title:"OpenStreetMap Relief Base"}]},"osm-light-gray":{title:"OpenStreetMap (Light Gray Canvas)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:LightGray:Base",title:"OSM (Light Gray Base)"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:LightGray:Labels",title:"OSM (Light Gray Reference)",isReference:!0}]},"osm-dark-gray":{title:"OpenStreetMap (Dark Gray Canvas)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:DarkGray:Base",title:"OSM (Dark Gray Base)"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:DarkGray:Labels",title:"OSM (Dark Gray Reference)",isReference:!0}]},"arcgis-terrain":{title:"Terrain with Labels",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Terrain:Base",title:"World Terrain Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Terrain:Detail",title:"World Terrain Reference",isReference:!0}]},"arcgis-community":{title:"Community",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Community",title:"Community"}]},"arcgis-charted-territory":{title:"Charted Territory",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ChartedTerritory:Base",title:"Charted Territory"}]},"arcgis-colored-pencil":{title:"Colored Pencil",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ColoredPencil",title:"Colored Pencil"}]},"arcgis-nova":{title:"Nova",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Nova",title:"Nova"}]},"arcgis-modern-antique":{title:"Modern Antique",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ModernAntique:Base",title:"Modern Antique"}]},"arcgis-midcentury":{title:"Mid-Century",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Midcentury",title:"Mid-Century"}]},"arcgis-newspaper":{title:"Newspaper",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Newspaper",title:"Newspaper"}]},"arcgis-hillshade-light":{title:"Hillshade",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"}]},"arcgis-hillshade-dark":{title:"Hillshade (Dark)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade (Dark)",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade_Dark/MapServer"}]}},nBe=new Set(["bing-maps","imagery","imagery-tile","map-image","open-street-map","tile","unknown","unsupported","vector-tile","web-tile","wms","wmts"]),oBe=new Set(["csv","feature","geo-rss","geojson","group","imagery","imagery-tile","kml","map-image","map-notes","ogc-feature","route","tile","unknown","unsupported","vector-tile","web-tile","wfs","wms","wmts"]);function aBe(e){return e.layerContainerType==="basemap"?nBe:e.layerContainerType==="operational-layers"?oBe:null}function aq(e){return!(e.type!=="feature"||e.url||!e.source||e.source.type!=="memory")}function lBe(e,t){if(t.restrictedWebMapWriting){const i=aBe(t);return!_(i)||i.has(e.type)&&!aq(e)}return!0}function cBe(e,t){if(aq(e)){const i=MS("featureCollection.layers",t),r=i&&i[0]&&i[0].layerDefinition;r&&LU(e,r)}else e.type==="stream"?LU(e,t.layerDefinition=t.layerDefinition||{}):e.type!=="group"&&LU(e,t)}function LU(e,t){"maxScale"in e&&(t.maxScale=_D(e.maxScale)),"minScale"in e&&(t.minScale=_D(e.minScale))}function uBe(e,t){if(cBe(e,t),"blendMode"in e&&(t.blendMode=e.blendMode,t.blendMode==="normal"&&delete t.blendMode),t.opacity=_D(e.opacity),t.title=e.title||"Layer",t.visibility=e.visible,"legendEnabled"in e&&e.type!=="wmts")if(aq(e)){const i=t.featureCollection;i&&(i.showLegend=e.legendEnabled)}else t.showLegend=e.legendEnabled}function CK(e,t,i){if(!("write"in e)||!e.write)return i&&i.messages&&i.messages.push(new q("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted`,{layer:e})),null;if(lBe(e,i)){const r={};return e.write(r,i)?r:null}return _(t)&&uBe(e,t=se(t)),t}var n$;let hBe=0;const NU=he.getLogger("esri.Basemap");let Jc=n$=class extends oO(Ep){constructor(e){super(e),this.id=null,this.portalItem=null,this.spatialReference=null,this.thumbnailUrl=null,this.title="Basemap",this.id=Date.now().toString(16)+"-basemap-"+hBe++,this.baseLayers=new it,this.referenceLayers=new it;const t=r=>{r.parent&&r.parent!==this&&"remove"in r.parent&&r.parent.remove(r),r.parent=this,r.type==="elevation"&&NU.error(`Layer '${r.title}, id:${r.id}' of type '${r.type}' is not supported as a basemap layer and will therefore be ignored.`)},i=r=>{r.parent=null};this.baseLayers.on("after-add",r=>t(r.item)),this.referenceLayers.on("after-add",r=>t(r.item)),this.baseLayers.on("after-remove",r=>i(r.item)),this.referenceLayers.on("after-remove",r=>i(r.item))}initialize(){this.when().catch(e=>{NU.error("#load()",`Failed to load basemap (title: '${this.title}', id: '${this.id}')`,e)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){var e;const t=this.baseLayers.removeAll();for(const r of t)r.destroy();const i=this.referenceLayers.removeAll();for(const r of i)r.destroy();this.baseLayers.destroy(),this.referenceLayers.destroy(),(e=this.portalItem)==null||e.destroy(),this.portalItem=null}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e=I({},e)).resourceInfo),e}set baseLayers(e){this._set("baseLayers",Om(e,this._get("baseLayers")))}_writeBaseLayers(e,t,i){const r=[];e&&(i=me(I({},i),{layerContainerType:"basemap"}),this.baseLayers.forEach(s=>{const n=CK(s,i.webmap?i.webmap.getLayerJSONFromResourceInfo(s):null,i);_(n)&&r.push(n)}),this.referenceLayers.forEach(s=>{const n=CK(s,i.webmap?i.webmap.getLayerJSONFromResourceInfo(s):null,i);_(n)&&(n.isReference=!0,r.push(n))})),t.baseMapLayers=r}set referenceLayers(e){this._set("referenceLayers",Om(e,this._get("referenceLayers")))}writeTitle(e,t){t.title=e||"Basemap"}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return Tj(this,e=>{e(this.baseLayers,this.referenceLayers)})}clone(){const e={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.slice(),referenceLayers:this.referenceLayers.slice()};return this.loaded&&(e.loadStatus="loaded"),new n$({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}write(e,t){return e=e||{},t&&t.origin||(t=I({origin:"web-map"},t)),super.write(e,t),!this.loaded&&this.resourceInfo&&this.resourceInfo.data.baseMapLayers&&(e.baseMapLayers=this.resourceInfo.data.baseMapLayers.map(i=>{const r=se(i);return r.url&&Sp(r.url)&&(r.url=`https:${r.url}`),r.templateUrl&&Sp(r.templateUrl)&&(r.templateUrl=`https:${r.templateUrl}`),r})),e}async _loadFromSource(e){const{resourceInfo:t,portalItem:i}=this;Qt(e);const r=[];if(t){const s=t.context?t.context.url:null;if(r.push(this._loadLayersFromJSON(t.data,s,e)),t.data.id&&!t.data.title){const n=t.data.id;r.push(sBe(n).then(o=>{o&&this.read({title:o},t.context)}))}}else i&&r.push(this._loadFromItem(i,e));await Promise.all(r)}async _loadLayersFromJSON(e,t,i){const r=this.resourceInfo&&this.resourceInfo.context,s=this.portalItem&&this.portalItem.portal||r&&r.portal||null,n=r&&r.origin==="web-scene"?"web-scene":"web-map",{populateOperationalLayers:o}=await import("./layersCreator.cc0b2319.js"),a=[];if(Qt(i),e.baseMapLayers&&Array.isArray(e.baseMapLayers)){const l={context:{origin:n,url:t,portal:s,layerContainerType:"basemap"},defaultLayerType:"DefaultTileLayer"},c=o(this.baseLayers,e.baseMapLayers.filter(p=>!p.isReference),l);a.push(c);const h=o(this.referenceLayers,e.baseMapLayers.filter(p=>p.isReference),l);a.push(h)}await Ks(a)}async _loadFromItem(e,t){const i=await e.load(t),r=await i.fetchData("json",t),s=Ts(e.itemUrl);return this._set("resourceInfo",{data:r.baseMap,context:{origin:"web-map",portal:e.portal||Bn.getDefault(),url:s}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:r.spatialReference},this.resourceInfo.context),this.read({title:e.title,thumbnailUrl:e.thumbnailUrl},{origin:"portal-item",portal:e.portal||Bn.getDefault(),url:s}),this._loadLayersFromJSON(this.resourceInfo.data,s,t)}static fromId(e){const t=d9[e];if(t){if(t.deprecated){let i=null;e==="dark-gray"?i="dark-gray-vector":e==="gray"?i="gray-vector":e==="streets"?i="streets-vector":e==="topo"&&(i="topo-vector"),RT(NU,`The ${e} basemap has entered mature support and is no longer being updated.`,{replacement:i,see:"https://arcg.is/1iq8aD",warnOnce:!0})}return n$.fromJSON(t)}return null}};u([d({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer(e,t,i,r){this._writeBaseLayers(e,t,r)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:it}},writer(e,t,i,r){this._writeBaseLayers(e,t,r)}}}}}})],Jc.prototype,"baseLayers",null),u([d({type:String,json:{origins:{"web-scene":{write:!0}}}})],Jc.prototype,"id",void 0),u([d({type:tS})],Jc.prototype,"portalItem",void 0),u([d()],Jc.prototype,"referenceLayers",null),u([d({readOnly:!0})],Jc.prototype,"resourceInfo",void 0),u([d({type:He})],Jc.prototype,"spatialReference",void 0),u([d()],Jc.prototype,"thumbnailUrl",void 0),u([d({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],Jc.prototype,"title",void 0),u([Fe("title")],Jc.prototype,"writeTitle",null),Jc=n$=u([P("esri.Basemap")],Jc);const iS=Jc;var dBe=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:iS});let Ww=class extends Vm(it){constructor(e){super(e),this.getCollections=null}initialize(){this.handles.add(sae(()=>this._refresh()))}destroy(){this.getCollections=null}_refresh(){const e=_(this.getCollections)?this.getCollections():null;if(R(e))return void this.removeAll();let t=0;for(const i of e)_(i)&&(t=this._processCollection(t,i));this.splice(t,this.length)}_createNewInstance(e){return new it(e)}_processCollection(e,t){if(!t)return e;const i=this.itemFilterFunction?this.itemFilterFunction:r=>!!r;for(const r of t)if(r){if(i(r)){const s=this.indexOf(r,e);s>=0?s!==e&&this.reorder(r,e):this.add(r,e),++e}if(this.getChildrenFunction){const s=this.getChildrenFunction(r);if(Array.isArray(s))for(const n of s)e=this._processCollection(e,n);else e=this._processCollection(e,s)}}return e}};u([d()],Ww.prototype,"getCollections",void 0),u([d()],Ww.prototype,"getChildrenFunction",void 0),u([d()],Ww.prototype,"itemFilterFunction",void 0),Ww=u([P("esri.core.CollectionFlattener")],Ww);const sT=Ww;function pBe(e){var t;return!!(e&&e.loaded&&"capabilities"in e&&e!=null&&(t=e.capabilities)!=null&&t.operations&&"supportsEditing"in e.capabilities.operations&&e.capabilities.operations.supportsEditing===!0)&&!("editingEnabled"in e&&!e.editingEnabled)}const RK=he.getLogger("esri.support.basemapUtils");function fBe(){return{}}function mBe(e){for(const t in e){const i=e[t];(i==null?void 0:i.destroyed)===!1&&i.destroy(),delete e[t]}}function lq(e,t){var i;let r;if(typeof e=="string"){if(!(e in d9)){const s=Object.entries(d9).filter(([n,o])=>Bi.apiKey&&!o.classic||!Bi.apiKey&&o.classic&&!o.deprecated).map(([n])=>`"${n}"`).join(", ");return RK.warn(`Unable to find basemap definition for: ${e}. Try one of these: ${s}`),null}t&&(r=t[e]),r||(r=iS.fromId(e),t&&(t[e]=r))}else r=Ir(iS,e);return(i=r)!=null&&i.destroyed&&(RK.warn("The provided basemap is already destroyed",{basemap:r}),r=null),r}function gBe(e,t=null){const i=lq(e);if(!i)return null;const r=new iS({id:i.id,title:i.title,baseLayers:i.baseLayers.slice(),referenceLayers:i.referenceLayers.slice()});return t&&(r.baseLayers=OK(r.baseLayers,t.baseLayers),r.referenceLayers=OK(r.referenceLayers,t.referenceLayers)),r.load().catch(()=>{}),r.portalItem=i.portalItem,r}function OK(e,t){const i=new it;return e.forEach(r=>{const s=t.find(n=>yBe(MK(r),MK(n)))||r;i.some(n=>n===s)?i.push(r):i.push(s)}),i}function MK(e){var t,i;return{type:e.type,url:vBe("urlTemplate"in e&&e.urlTemplate||e.url||"styleUrl"in e&&e.styleUrl),minScale:"minScale"in e&&e.minScale!=null?e.minScale:0,maxScale:"maxScale"in e&&e.maxScale!=null?e.maxScale:0,opacity:e.opacity!=null?e.opacity:1,visible:e.visible==null||!!e.visible,sublayers:e.type!=="map-image"&&e.type!=="wms"||!_(e.sublayers)||(t=e.sublayers)==null?void 0:t.map(r=>({id:r.id,visible:r.visible})),activeLayerId:e.type==="wmts"?(i=e.activeLayer)==null?void 0:i.id:void 0}}function yBe(e,t){if(e.type!==t.type||e.url!==t.url||e.minScale!==t.minScale||e.maxScale!==t.maxScale||e.visible!==t.visible||e.opacity!==t.opacity)return!1;if(_(e.activeLayerId)||_(t.activeLayerId))return e.activeLayerId===t.activeLayerId;if(_(e.sublayers)||_(t.sublayers)){if(R(e.sublayers)||R(t.sublayers)||e.sublayers.length!==t.sublayers.length)return!1;for(let i=0;i<e.sublayers.length;i++){const r=e.sublayers.at(i),s=t.sublayers.at(i);if(r.id!==s.id||r.visible!==s.visible)return!1}}return!0}function vBe(e){return e?Pu(e).replace(/^\s*https?:/i,"").toLowerCase():""}const _Be=he.getLogger("esri.support.groundUtils"),PK={"world-elevation":{id:"worldElevation",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"},"world-topobathymetry":{id:"worldTopoBathymetry",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/TopoBathy3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"}};function bBe(e){let t=null;if(typeof e=="string")if(e in PK){const i=PK[e];t=new kT({resourceInfo:{data:{layers:[i]}}})}else _Be.warn(`Unable to find ground definition for: ${e}. Try "world-elevation"`);else t=Ir(kT,e);return t}function wBe(e){return e&&e.type==="group"}function p9(e,t,i){let r,s;if(e)for(let n=0,o=e.length;n<o;n++){if(r=e.getItemAt(n),r[t]===i)return r;if(wBe(r)&&(s=p9(r.layers,t,i),s))return s}}const IK=he.getLogger("esri.support.LayersMixin"),xBe=e=>{let t=class extends e{constructor(...i){super(...i),this.layers=new it;const r=o=>{o.parent&&"remove"in o.parent&&o.parent.remove(o)},s=o=>{o.parent=this,this.layerAdded(o),o.type!=="elevation"&&o.type!=="base-elevation"||IK.error(`Layer 'title:${o.title}, id:${o.id}' of type '${o.type}' is not supported as an operational layer and will therefore be ignored.`)},n=o=>{o.parent=null,this.layerRemoved(o)};this.layers.on("before-add",o=>r(o.item)),this.layers.on("after-add",o=>s(o.item)),this.layers.on("after-remove",o=>n(o.item))}destroy(){const i=this.layers.removeAll();for(const r of i)this.layerRemoved(r),r.destroy();this.layers.destroy()}set layers(i){this._set("layers",Om(i,this._get("layers")))}add(i,r){const s=this.layers;if(r=s.getNextIndex(r),i instanceof PF){const n=i;n.parent===this?this.reorder(n,r):s.add(n,r)}else Cc(i)?i.then(n=>{this.destroyed||this.add(n,r)}):IK.error("#add()","The item being added is not a Layer or a Promise that resolves to a Layer.")}addMany(i,r){const s=this.layers;r=s.getNextIndex(r),i.slice().forEach(n=>{n.parent!==this?(s.add(n,r),r+=1):this.reorder(n,r)})}findLayerById(i){return p9(this.layers,"id",i)}findLayerByUid(i){return p9(this.layers,"uid",i)}remove(i){return this.layers.remove(i)}removeMany(i){return this.layers.removeMany(i)}removeAll(){return this.layers.removeAll()}reorder(i,r){return this.layers.reorder(i,r)}layerAdded(i){}layerRemoved(i){}};return u([d()],t.prototype,"layers",null),t=u([P("esri.support.LayersMixin")],t),t},Ome="esri.support.TablesMixin",TBe=he.getLogger(Ome);function SBe(e){return e&&e.type==="group"}function f9(e,t,i){if(e)for(let r=0,s=e.length;r<s;r++){const n=e.getItemAt(r);if(n[t]===i)return n;if(SBe(n)){const o=f9(n.tables,t,i);if(o)return o}}}const EBe=e=>{let t=class extends e{constructor(...i){super(...i),this.tables=new it,this.tables.on("after-add",r=>{const s=r.item;s.parent&&s.parent!==this&&"tables"in s.parent&&s.parent.tables.remove(s),s.parent=this,s.type!=="feature"&&TBe.error(`Layer 'title:${s.title}, id:${s.id}' of type '${s.type}' is not supported as a table and will therefore be ignored.`)}),this.tables.on("after-remove",r=>{r.item.parent=null})}destroy(){const i=this.tables.removeAll();for(const r of i)r.destroy();this.tables.destroy()}set tables(i){this._set("tables",Om(i,this._get("tables")))}findTableById(i){return f9(this.tables,"id",i)}findTableByUid(i){return f9(this.tables,"uid",i)}};return u([d()],t.prototype,"tables",null),t=u([P(Ome)],t),t};let Bd=class extends EBe(xBe(xr.EventedMixin(we))){constructor(e){super(e),this.allLayers=new sT({getCollections:()=>{var t,i,r;return[(t=this.basemap)==null?void 0:t.baseLayers,(i=this.ground)==null?void 0:i.layers,this.layers,(r=this.basemap)==null?void 0:r.referenceLayers]},getChildrenFunction:t=>"layers"in t?t.layers:null}),this.allTables=new sT({getCollections:()=>[this.tables,this.layers],getChildrenFunction:t=>{const i=[];return"tables"in t&&i.push(t.tables),"layers"in t&&i.push(t.layers),i},itemFilterFunction:t=>{const i=t.parent;return i&&"tables"in i&&i.tables.includes(t)}}),this.basemap=null,this.editableLayers=new sT({getCollections:()=>[this.allLayers],itemFilterFunction:pBe}),this.ground=new kT,this._basemapCache=fBe()}destroy(){var e,t;this.allLayers.destroy(),this.allTables.destroy(),this.editableLayers.destroy(),(e=this.ground)==null||e.destroy(),(t=this.basemap)==null||t.destroy(),mBe(this._basemapCache),this._basemapCache=null}castBasemap(e){return lq(e,this._basemapCache)}castGround(e){const t=bBe(e);return R(t)?this._get("ground"):t}findLayerById(e){return this.allLayers.find(t=>t.id===e)}findTableById(e){return this.allTables.find(t=>t.id===e)}};u([d({readOnly:!0,dependsOn:[]})],Bd.prototype,"allLayers",void 0),u([d({readOnly:!0})],Bd.prototype,"allTables",void 0),u([d({type:iS})],Bd.prototype,"basemap",void 0),u([At("basemap")],Bd.prototype,"castBasemap",null),u([d({readOnly:!0})],Bd.prototype,"editableLayers",void 0),u([d({type:kT,nonNullable:!0})],Bd.prototype,"ground",void 0),u([At("ground")],Bd.prototype,"castGround",null),Bd=u([P("esri.Map")],Bd);const Mme=Bd;let cC=class extends YA{_own(e){e.layer&&"remove"in e.layer&&e.layer!==this.owner&&e.layer.remove(e),e.layer=this.owner}_release(e){e.layer===this.owner&&(e.layer=null)}};u([G7({Type:qo,ensureType:Ir(qo)})],cC.prototype,"itemType",void 0),cC=u([P("esri.support.GraphicsCollection")],cC);let oy=class extends we{constructor(e){super(e),this.view=null,this.baseLayerViews=new it,this.referenceLayerViews=new it,this._loadingHandle=Wt(this,"view.map.basemap",t=>{t&&t.load().catch(()=>{})})}destroy(){this._set("view",null),this._loadingHandle&&(this._loadingHandle.remove(),this._loadingHandle=null)}get suspended(){return!this.view||this.view.suspended}get updating(){var e,t;if(this.view&&this.view.suspended)return!1;const i=(e=this.view)==null||(t=e.map)==null?void 0:t.basemap;return!!i&&!!i.loaded&&(this.baseLayerViews.some(r=>r.updating)||this.referenceLayerViews.some(r=>r.updating))}};u([d({constructOnly:!0})],oy.prototype,"view",void 0),u([d({readOnly:!0})],oy.prototype,"baseLayerViews",void 0),u([d({readOnly:!0})],oy.prototype,"referenceLayerViews",void 0),u([d({readOnly:!0})],oy.prototype,"suspended",null),u([d({type:Boolean,readOnly:!0})],oy.prototype,"updating",null),oy=u([P("esri.views.BasemapView")],oy);const ABe=he.getLogger("esri.views.LayerViewManager");class CBe{constructor(t,i,r){this.layer=t,this.view=i,this.layerViewImporter=r,this._controller=new AbortController,this._deferred=f0(),this._started=!1,this.done=!1,go(this._controller.signal,()=>{const s=new q("cancelled:layerview-create","layerview creation cancelled",{layer:t});this._deferred.reject(s)})}get promise(){return this._deferred.promise}destroy(){this._controller.abort();const{layerView:t}=this;if(!t)return;const{layer:i,view:r}=this;i.emit("layerview-destroy",{view:r,layerView:t}),r.emit("layerview-destroy",{layer:i,layerView:t}),this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null}async start(){if(this._started)return;this._started=!0;const{_controller:{signal:t},layer:i,view:r}=this;this._map=r.map;try{var s,n;let o,a;if(await i.load({signal:t}),"prefetchResources"in i&&await i.prefetchResources({signal:t}),i.createLayerView)o=await i.createLayerView(r,{signal:t});else{if(!this.layerViewImporter.hasLayerViewModule(i))throw new q("layer:view-not-supported","No layerview implementation was found");const c=await this.layerViewImporter.importLayerView(i);Qt(t),o="default"in c?new c.default({layer:i,view:r}):new c({layer:i,view:r})}const l=()=>{a=Js(a),o.destroyed||o.destroy(),o.layer=null,o.parent=null,o.view=null,this.done=!0};a=go(t,l),Qt(t);try{await o.when()}catch(c){throw l(),c}if(!((s=this._map)==null||(n=s.allLayers)==null?void 0:n.includes(i)))return l(),void this._deferred.reject(new q("view:no-layerview-for-layer","The layer has been removed from the map",{layer:i}));this.layerView=o,i.emit("layerview-create",{view:r,layerView:o}),r.emit("layerview-create",{layer:i,layerView:o}),this.done=!0,this._deferred.resolve(o)}catch(o){i.emit("layerview-create-error",{view:r,error:o}),r.emit("layerview-create-error",{layer:i,error:o}),this.done=!0,this._deferred.reject(new q("layerview:create-error","layerview creation failed",{layer:i,error:o}))}}}let Kc=class extends zT{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._watchUpdatingTracking=new fp,this.supportsGround=!0,this._preloadLayerViewModules=()=>{var t;const i=(t=this.view.map)==null?void 0:t.allLayers;if(i)for(const r of i)this.layerViewImporter.hasLayerViewModule(r)&&this.layerViewImporter.importLayerView(r)},this._reschedule=()=>(R(this._workPromise)&&(this._workPromise=f0()),this.handles.remove("reschedule"),this.handles.add(rO(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{var t,i,r;const s=this.view.map;if(this._map!==s&&(this.clear(),this._map=s),R(this._workPromise))return void this.notifyChange("updating");this.handles.remove("reschedule"),this.handles.remove("collection-change");const n=new sT({getCollections:()=>this._rootCollectionNames.map(l=>this.get(l)),getChildrenFunction:l=>l&&"layers"in l?l.layers:null});if(!n)return this._workPromise.resolve(),void(this._workPromise=null);for(const l of n)this._createLayerView(l);this._refreshCollections();for(const[l,c]of this._layerLayerViewInfoMap)n.includes(l)||(this._layerLayerViewInfoMap.delete(c.layer),c.destroy());const o=n.filter(l=>l.type==="group").map(l=>l.layers),a=[s==null||(t=s.ground)==null?void 0:t.layers,s==null||(i=s.basemap)==null?void 0:i.baseLayers,s==null||(r=s.basemap)==null?void 0:r.referenceLayers,s==null?void 0:s.layers,...o].filter(l=>!!l);this.handles.add(a.map(l=>this._watchUpdatingTracking.addOnCollectionChange(()=>l,this._reschedule)),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.handles.add([Yx(()=>{var e,t;return(e=this.view)==null||(t=e.map)==null?void 0:t.allLayers},"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),Nt(()=>{const e=this.view,t=e==null?void 0:e.map;return[t==null?void 0:t.basemap,t==null?void 0:t.ground,t==null?void 0:t.layers,e==null?void 0:e.ready]},()=>this._reschedule(),rc)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),this._watchUpdatingTracking.destroy(),this._map=null}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return _(this._workPromise)||this._watchUpdatingTracking.updating||qr(this._layerLayerViewInfoMap,e=>!e.done)}get updatingRemaining(){let e=0;for(const t of this._layerLayerViewInfoMap.values())t.done||++e;return e}clear(){if(!this.destroyed){for(const e of this._layerLayerViewInfoMap.values())e.destroy();this._layerLayerViewInfoMap.clear(),this._refreshCollections()}}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e))throw new q("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e});return this._layerLayerViewInfoMap.get(e).promise}_refreshCollections(){for(const[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(e),this.get(t),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void(t&&t.removeAll());let r=0;for(const s of e){const n=this._layerLayerViewInfoMap.get(s);if(!n||!n.layerView)continue;const o=n.layerView;o.layer=s,o.parent=i,t.getItemAt(r)!==o&&t.splice(r,0,o),s.layers&&this._populateLayerViewsOwners(s.layers,o.layerViews,o),r+=1}r<t.length&&t.splice(r,t.length)}_createLayerView(e){if(this._layerLayerViewInfoMap.has(e))return this.view.ready&&this._layerLayerViewInfoMap.get(e).start(),this.notifyChange("updating"),void this.notifyChange("updatingRemaining");e.load().catch(()=>{}),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const t=new CBe(e,this.view,this.layerViewImporter);t.promise.then(()=>this._refreshCollections(),i=>{var r,s;i&&(pr(i)||i.name==="cancelled:layerview-create")||ABe.error(`Failed to create layerview for layer title:'${(r=e.title)!=null?r:"no title"}', id:'${(s=e.id)!=null?s:"no id"}' of type '${e.type}'.`,{layer:e,error:i}),this._refreshCollections()}),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};u([d()],Kc.prototype,"_workPromise",void 0),u([d({readOnly:!0})],Kc.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0})],Kc.prototype,"_layersToLayerViews",null),u([d({readOnly:!0})],Kc.prototype,"_rootCollectionNames",null),u([d()],Kc.prototype,"layerViewImporter",void 0),u([d()],Kc.prototype,"supportsGround",void 0),u([d({readOnly:!0})],Kc.prototype,"updating",null),u([d({readOnly:!0})],Kc.prototype,"updatingRemaining",null),u([d({constructOnly:!0})],Kc.prototype,"view",void 0),Kc=u([P("esri.views.LayerViewManager")],Kc);const RBe=Kc;let Bl=class extends we{constructor(e){super(e),this.factor=1.5,this.offset=Jh(0,0),this.position=null,this.size=120,this.maskUrl=null,this.maskEnabled=!0,this.overlayUrl=null,this.overlayEnabled=!0,this.visible=!0}get version(){return this.commitProperty("factor"),this.commitProperty("offset"),this.commitProperty("position"),this.commitProperty("visible"),this.commitProperty("size"),this.commitProperty("maskUrl"),this.commitProperty("maskEnabled"),this.commitProperty("overlayUrl"),this.commitProperty("overlayEnabled"),(this._get("version")||0)+1}};u([d({type:Number})],Bl.prototype,"factor",void 0),u([d({nonNullable:!0})],Bl.prototype,"offset",void 0),u([d()],Bl.prototype,"position",void 0),u([d({type:Number,range:{min:0}})],Bl.prototype,"size",void 0),u([d()],Bl.prototype,"maskUrl",void 0),u([d()],Bl.prototype,"maskEnabled",void 0),u([d()],Bl.prototype,"overlayUrl",void 0),u([d()],Bl.prototype,"overlayEnabled",void 0),u([d({readOnly:!0})],Bl.prototype,"version",null),u([d({type:Boolean})],Bl.prototype,"visible",void 0),Bl=u([P("esri.views.Magnifier")],Bl);const Pme=Bl;let o$=class extends we{constructor(){super(...arguments),this._tasks=new Array,this.running=!1}get length(){return this._tasks.length}destroy(){this.cancelAll()}runTask(e){for(;!e.done&&this._process(e);)e.madeProgress()}push(e,t,i){return this.running=!0,new Promise((r,s)=>this._tasks.push(new $K(r,s,e,t,i)))}unshift(e,t,i){return this.running=!0,new Promise((r,s)=>this._tasks.unshift(new $K(r,s,e,t,i)))}_process(e){if(this._tasks.length===0)return!1;const t=this._tasks.shift();try{const i=Us(t.signal);if(i&&!t.abortCallback)t.reject(pi());else{const r=i?t.abortCallback(pi()):t.callback(e);Cc(r)?r.then(t.resolve,t.reject):t.resolve(r)}}catch(i){t.reject(i)}return this.running=this._tasks.length>0,!0}cancelAll(){const e=pi();for(const t of this._tasks)if(t.abortCallback){const i=t.abortCallback(e);t.resolve(i)}else t.reject(e);this._tasks.length=0,this.running=!1}};u([d()],o$.prototype,"running",void 0),o$=u([P("esri.layers.support.PromiseQueue")],o$);class $K{constructor(t,i,r,s,n){this.resolve=t,this.reject=i,this.callback=r,this.signal=s,this.abortCallback=n}}let hA=class extends we{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};u([d()],hA.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),u([d()],hA.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),hA=u([P("esri.views.support.DebugFlags")],hA);const OBe=new hA,MBe=he.getLogger("esri.views.support.Scheduler");function PBe(e){return new yL.Scheduler({nowFunc:e})}var ht;(function(e){e.RESOURCE_CONTROLLER="schedule",e.SLIDE="slide",e.STREAM_DATA_LOADER="stream loader",e.ELEVATION_QUERY="elevation query",e.TERRAIN_SURFACE="terrain",e.SURFACE_GEOMETRY_UPDATES="surface geometry updates",e.GRAPHICS_CORE="Graphics3D",e.I3S_CONTROLLER="I3S",e.POINT_CLOUD_LAYER="point cloud",e.FEATURE_TILE_FETCHER="feature fetcher",e.OVERLAY="overlay",e.STAGE="stage",e.GRAPHICS_DECONFLICTOR="graphics deconflictor",e.FILTER_VISIBILITY="Graphics3D filter visibility",e.SCALE_VISIBILITY="Graphics3D scale visibility",e.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",e.POINT_OF_INTEREST_FREQUENT="POI frequent",e.POINT_OF_INTEREST_INFREQUENT="POI infrequent",e.LABELER="labeler",e.FEATURE_QUERY_ENGINE="feature query",e.FEATURE_TILE_TREE="feature tile tree",e.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",e.ELEVATION_ALIGNMENT="elevation alignment",e.TEXT_TEXTURE_ATLAS="text texture atlas",e.TEXTURE_UNLOAD="texture unload",e.LINE_OF_SIGHT_TOOL="line of sight tool",e.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",e.ELEVATION_PROFILE="elevation profile",e.SNAPPING="snapping",e.SHADOW_ACCUMULATOR="shadow accumulator",e.CLOUDS_GENERATOR="cloud generator",e[e.TEST_PRIO=1]="TEST_PRIO"})(ht||(ht={}));const ip=0,DK=new Map([[ht.RESOURCE_CONTROLLER,ip],[ht.SLIDE,ip],[ht.STREAM_DATA_LOADER,ip],[ht.ELEVATION_QUERY,ip],[ht.TERRAIN_SURFACE,1],[ht.SURFACE_GEOMETRY_UPDATES,1],[ht.GRAPHICS_CORE,2],[ht.I3S_CONTROLLER,2],[ht.POINT_CLOUD_LAYER,2],[ht.FEATURE_TILE_FETCHER,2],[ht.OVERLAY,4],[ht.STAGE,4],[ht.GRAPHICS_DECONFLICTOR,4],[ht.FILTER_VISIBILITY,4],[ht.SCALE_VISIBILITY,4],[ht.FRUSTUM_VISIBILITY,4],[ht.POINT_OF_INTEREST_FREQUENT,6],[ht.POINT_OF_INTEREST_INFREQUENT,30],[ht.LABELER,8],[ht.FEATURE_QUERY_ENGINE,8],[ht.FEATURE_TILE_TREE,16],[ht.FEATURE_TILE_TREE_ACTIVE,ip],[ht.ELEVATION_ALIGNMENT,12],[ht.TEXT_TEXTURE_ATLAS,12],[ht.CLOUDS_GENERATOR,12],[ht.TEXTURE_UNLOAD,12],[ht.LINE_OF_SIGHT_TOOL,16],[ht.LINE_OF_SIGHT_TOOL_INTERACTIVE,ip],[ht.SNAPPING,ip],[ht.SHADOW_ACCUMULATOR,30]]);function LK(e){return DK.has(e)?DK.get(e):typeof e=="number"?e:1}var Ws;(function(e){e[e.ANIMATING=0]="ANIMATING",e[e.INTERACTING=1]="INTERACTING",e[e.IDLE=2]="IDLE"})(Ws||(Ws={}));const NK=6.5,FK=1,IBe=30,UK=1e3/30,kK=100,zK=.9;var yL,J0;(function(e){let t=class extends we{constructor(s){super(s),this.updating=!0,this._microTaskQueued=!1,this.performanceInfo={total:new r0("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=null,this._state=Ws.INTERACTING,this._tasks=new $t,this._runQueue=new $t,this._load=0,this._idleStateCallbacks=new $t,this._idleUpdatesStartFired=!1,this._maxReschedule=e3,this._forceTask=!1,this._debug=!1,this._debugHandle=Nt(()=>OBe.SCHEDULER_LOG_SLOW_TASKS,a=>this._debug=a,fn),this._budget=new r(s.nowFunc);for(const a of Object.keys(ht))this.performanceInfo.tasks.set(ht[a],new r0(ht[a]));let n;const o=this;this._test={get state(){return gt(n,o._state)},set state(a){n=a},FRAME_SAFETY_BUDGET:NK,INTERACTING_BUDGET:UK,IDLE_BUDGET:kK,get budget(){return o._budget.budget},usedBudget:0,setBudget:a=>o._budget=a,updateTask:a=>this._updateTask(a),getState:a=>this._getState(a),getRuntime:a=>this._getRuntime(a),frameTaskTimes:this._frameTaskTimes,resetRuntimes:()=>this._resetRuntimes(),getRunning:()=>this._getRunning()}}destroy(){this._tasks.toArray().forEach(s=>s.remove()),this._tasks.clear(),Js(this._debugHandle),this._microTaskQueued=!1,this.updating=!1}activate(){this._budget.done||this._microTaskQueued||(this._microTaskQueued=!0,queueMicrotask(()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.done||(this._maxReschedule=e3,this._schedule(),this.frame()))}))}registerTask(s,n){const o=LK(s),a=new i(this,s,n,o);return this._tasks.push(a),this.performanceInfo.tasks.has(s)||this.performanceInfo.tasks.set(s,new r0(s)),a}registerIdleStateCallbacks(s,n){const o={idleBegin:s,idleEnd:n};this._idleStateCallbacks.push(o),this.state===Ws.IDLE&&this._idleUpdatesStartFired&&o.idleBegin();const a=this;return{remove:()=>this._removeIdleStateCallbacks(o),set idleBegin(l){a._idleUpdatesStartFired&&(o.idleEnd(),a._state===Ws.IDLE&&l()),o.idleBegin=l},set idleEnd(l){o.idleEnd=l}}}get now(){return this.nowFunc()}get load(){return this._load}set state(s){this._state!==s&&(this._state=s,this.state!==Ws.IDLE&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll(n=>n.idleEnd())))}get state(){return R(this._test.state)?this._state:this._test.state}updateBudget(s){this._test.usedBudget=0;let n=NK,o=s.frameDuration,a=FK;switch(this.state){case Ws.IDLE:n=0,o=Math.max(kK,s.frameDuration),a=IBe;break;case Ws.INTERACTING:o=Math.max(UK,s.frameDuration);case Ws.ANIMATING:}return o=o-s.elapsedFrameTime-n,this.state!==Ws.IDLE&&o<FK&&!this._forceTask?(this._forceTask=!0,!1):(o=Math.max(o,a),this._budget.reset(o,this.state),this._maxReschedule=e3,this._updateLoad(),this._schedule())}frame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case Ws.IDLE:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll(s=>s.idleBegin())),this._runIdle();break;case Ws.INTERACTING:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed}stopFrame(){this._budget.reset(0,this._state),this._budget.madeProgress()}_removeIdleStateCallbacks(s){this._idleUpdatesStartFired&&s.idleEnd(),this._idleStateCallbacks.removeUnordered(s)}removeTask(s){this._tasks.removeUnordered(s),this._runQueue.removeUnordered(s)}_updateTask(s){this._tasks.forAll(n=>{n.name===s&&n.setPriority(s)})}_getState(s){if(this._runQueue.some(o=>o.name===s))return J0.SCHEDULED;let n=J0.IDLE;return this._tasks.forAll(o=>{o.name===s&&o.needsUpdate&&(o.schedulePriority<=1?n=J0.READY:n!==J0.READY&&(n=J0.WAITING))}),n}_getRuntime(s){let n=0;return this._tasks.forAll(o=>{o.name===s&&(n+=o.runtime)}),n}_resetRuntimes(){this._tasks.forAll(s=>s.runtime=0)}_getRunning(){const s=new Map;if(this._tasks.forAll(o=>{o.needsUpdate&&s.set(o.name,(s.get(o.name)||0)+1)}),s.size===0)return null;let n="";return s.forEach((o,a)=>{n+=o>1?` ${o}x ${a}`:` ${a}`}),n}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const s=this._tasks.reduce((n,o)=>o.needsUpdate?++n:n,0);this._load=this._load*zK+s*(1-zK)}_schedule(){if(this._maxReschedule<=0)return!1;for(this._runQueue.filterInPlace(s=>!!s.needsUpdate||(s.schedulePriority=s.basePriority,!1)),this._tasks.forAll(s=>{s.basePriority===ip&&s.needsUpdate&&!this._runQueue.some(n=>n===s)&&this._runQueue.unshift(s)});this._runQueue.length===0;){let s=!1,n=0;if(this._tasks.forAll(o=>{o.needsUpdate&&o.schedulePriority!==0&&o.basePriority!==ip&&(s=!0,n=Math.max(n,o.basePriority),o.schedulePriority===1?(o.schedulePriority=0,this._runQueue.push(o)):--o.schedulePriority)}),!s)return this.updating=!1,!1;this._maxReschedule===e3&&(this._maxReschedule=n),--this._maxReschedule}return this.updating=!0,!0}_run(){const s=this._budget.now();this._startFrameTaskTimes();do for(;this._runQueue.length>0;){const n=this._budget.now(),o=this._runQueue.pop();this._budget.resetProgress();try{o.task.runTask(this._budget)}catch(l){MBe.error(`Exception in task "${o.name}"`,l)}o.schedulePriority=o.basePriority;const a=this._budget.now()-n;if(o.runtime+=a,this._frameTaskTimes.set(o.priority,this._frameTaskTimes.get(o.priority)+a),this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",o.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return this.updating=this._tasks.some(l=>l.needsUpdate),void this._recordFrameTaskTimes(this._budget.now()-s)}while(this._schedule());this.updating=this._tasks.some(n=>n.needsUpdate),this._recordFrameTaskTimes(this._budget.now()-s)}_startFrameTaskTimes(){for(const s of Object.keys(ht))this._frameTaskTimes.set(ht[s],0)}_recordFrameTaskTimes(s){this._frameTaskTimes.forEach((n,o)=>this.performanceInfo.tasks.get(o).record(n)),this.performanceInfo.total.record(s)}get test(){return this._test}};u([d()],t.prototype,"updating",void 0),u([d()],t.prototype,"nowFunc",void 0),t=u([P("esri.views.support.Scheduler")],t),e.Scheduler=t;let i=class extends we{constructor(s,n,o,a){super({}),this._scheduler=s,this.name=n,this._basePriority=a,this.runtime=0,this._queue=new o$,this._handles=new Ut,this.schedulePriority=this._basePriority,this.task=_(o)?o:this._queue,this._handles.add(IN(()=>this.task.running,()=>s.activate()))}get updating(){return this._queue.running}normalizeCtorArgs(){return{}}remove(){this.processQueue(e2),this._scheduler.removeTask(this),this.schedule=rS.schedule,this.reschedule=rS.reschedule,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(s){this.name=s;const n=LK(s);this._basePriority!==ip&&this.schedulePriority===0||(this.schedulePriority=n),this._basePriority=n}get priority(){return this.name}set priority(s){this.setPriority(s)}get needsUpdate(){return this.updating||this.task.running}schedule(s,n,o){return this._queue.push(s,n,o)}reschedule(s,n,o){return this._queue.unshift(s,n,o)}processQueue(s){this._queue.runTask(s)}};u([d({constructOnly:!0})],i.prototype,"task",void 0),u([d({readOnly:!0})],i.prototype,"updating",null),i=u([P("esri.views.support.SchedulerTask")],i);class r{constructor(n){this.now=n,this._begin=0,this._budget=0,this._state=Ws.IDLE,this._didWork=!1,this._enabled=!0}run(n){return!this.done&&(n()===!0&&(this._didWork=!0),!0)}get done(){return this._didWork&&this.elapsed>=this._budget&&this._enabled}get budget(){return this._budget}madeProgress(){this._didWork=!0}get state(){return this._state}get enabled(){return this._enabled}set enabled(n){this._enabled=n}reset(n,o){this._begin=this.now(),this._budget=n,this._state=o,this._didWork=!1}get remaining(){return Math.max(this._budget-this.elapsed,0)}get elapsed(){return this.now()-this._begin}resetProgress(){this._didWork=!1}get hasProgressed(){return this._didWork}}e.Budget=r})(yL||(yL={})),function(e){e.SCHEDULED="s",e.READY="r",e.WAITING="w",e.IDLE="i"}(J0||(J0={}));const e2=(()=>{const e=new yL.Budget(()=>performance.now());return e.enabled=!1,e})();class $Be{remove(){}processQueue(){}schedule(t,i,r){try{if(Us(i)){const s=pi();return r?Promise.resolve(r(s)):Promise.reject(s)}return c6(t(e2))}catch(s){return Promise.reject(s)}}reschedule(t,i,r){return this.schedule(t,i,r)}}const rS=new $Be,e3=Number.MAX_SAFE_INTEGER;let $x=class extends we{constructor(e,t){var i;super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=(i=t==null?void 0:t.registerTask(ht.TEXTURE_UNLOAD))!=null?i:rS}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask.remove(),this._textureRequests.forEach(e=>this._releaseTextureRequest(e)),this._textureRequests.clear()}get updating(){return this._frameTask.updating}fromData(e,t,i){const r=this.makeUid(e);let s=this._textureRequests.get(r);return s||(s={referenceCount:0,texture:t(),textureAsync:null,abortController:null,onRemove:i},this._stage&&(this._stage.add(s.texture),this._stage.loadImmediate(s.texture)),this._textureRequests.set(r,s)),s.referenceCount++,{uid:r,texture:s.texture,release:()=>this._release(r)}}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}_releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){var t;e.onRemove&&e.onRemove(),e.texture?(t=this._stage)==null||t.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return _(t)?`${e}.${t}px`:e}};u([d()],$x.prototype,"_frameTask",void 0),u([d()],$x.prototype,"updating",null),$x=u([P("esri.views.3d.support.TextureCollection")],$x);var BK;(function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right"})(BK||(BK={}));const Ime=["click","double-click","immediate-click","immediate-double-click","hold","drag","key-down","key-up","pointer-down","pointer-move","pointer-up","pointer-drag","mouse-wheel","pointer-enter","pointer-leave","gamepad","focus","blur"],$me={};function Dme(e){return!!$me[e]}function DBe(e){for(const t of e)if(!Dme(t))return!1;return!0}Ime.forEach(e=>{$me[e]=!0});class LBe{constructor(t){this.handlers=new Map,this.counter=0,this.handlerCounts=new Map,this.view=t,this.inputManager=null}connect(t){t&&this.disconnect(),this.inputManager=t,this.handlers.forEach(({handler:i,priority:r},s)=>this.inputManager.installHandlers(s,[i],r))}disconnect(){this.inputManager&&this.handlers.forEach((t,i)=>this.inputManager.uninstallHandlers(i)),this.inputManager=null}destroy(){this.disconnect(),this.handlers.clear(),this.view=null}on(t,i,r,s){const n=Array.isArray(t)?t:t.split(",");if(!DBe(n))return n.some(Dme)&&console.error("Error: registering input events and other events on the view at the same time is not supported."),null;let o,a;Array.isArray(i)?a=i:(o=i,a=[]),typeof r=="function"?o=r:s=r,s=s!=null?s:a0.DEFAULT;const l=this._createUniqueGroupName(),c=new NBe(this.view,n,a,o);this.handlers.set(l,{handler:c,priority:s});for(const h of n){const p=this.handlerCounts.get(h)||0;this.handlerCounts.set(h,p+1)}return this.inputManager&&this.inputManager.installHandlers(l,[c],s),{remove:()=>this._removeHandler(l,n)}}hasHandler(t){return!!this.handlerCounts.get(t)}_removeHandler(t,i){if(this.handlers.has(t)){this.handlers.delete(t);for(const r of i){const s=this.handlerCounts.get(r);s===void 0?console.error("Trying to remove handler for event that has no handlers registered: ",r):s===1?this.handlerCounts.delete(r):this.handlerCounts.set(r,s-1)}}this.inputManager&&this.inputManager.uninstallHandlers(t)}_createUniqueGroupName(){return this.counter+=1,`viewEvents_${this.counter}`}}class NBe extends Yn{constructor(t,i,r,s){super(!0),this.view=t;for(const n of i)switch(n){case"click":this.registerIncoming("click",r,o=>s(this._wrapClick(o)));break;case"double-click":this.registerIncoming("double-click",r,o=>s(this._wrapDoubleClick(o)));break;case"immediate-click":this.registerIncoming("immediate-click",r,o=>s(this._wrapImmediateClick(o)));break;case"immediate-double-click":this.registerIncoming("immediate-double-click",r,o=>s(this._wrapImmediateDoubleClick(o)));break;case"hold":this.registerIncoming("hold",r,o=>s(this._wrapHold(o)));break;case"drag":this.registerIncoming("drag",r,o=>{const a=this._wrapDrag(o);a&&s(a)});break;case"key-down":this.registerIncoming("key-down",r,o=>s(this._wrapKeyDown(o)));break;case"key-up":this.registerIncoming("key-up",r,o=>s(this._wrapKeyUp(o)));break;case"pointer-down":this.registerIncoming("pointer-down",r,o=>s(this._wrapPointer(o,"pointer-down")));break;case"pointer-move":this.registerIncoming("pointer-move",r,o=>s(this._wrapPointer(o,"pointer-move")));break;case"pointer-up":this.registerIncoming("pointer-up",r,o=>s(this._wrapPointer(o,"pointer-up")));break;case"pointer-drag":this.registerIncoming("pointer-drag",r,o=>s(this._wrapPointerDrag(o)));break;case"mouse-wheel":this.registerIncoming("mouse-wheel",r,o=>s(this._wrapMouseWheel(o)));break;case"pointer-enter":this.registerIncoming("pointer-enter",r,o=>s(this._wrapPointer(o,"pointer-enter")));break;case"pointer-leave":this.registerIncoming("pointer-leave",r,o=>s(this._wrapPointer(o,"pointer-leave")));break;case"gamepad":this.registerIncoming("gamepad",r,o=>{s(this._wrapGamepad(o))});break;case"focus":this.registerIncoming("focus",r,o=>{s(this._wrapFocus(o))});break;case"blur":this.registerIncoming("blur",r,o=>{s(this._wrapBlur(o))})}}_wrapFocus(t){return{type:"focus",timestamp:t.timestamp,native:t.data.native,cancelable:t.cancelable,stopPropagation:()=>t.stopPropagation(),async:i=>t.async(i),preventDefault:()=>t.preventDefault()}}_wrapBlur(t){return{type:"blur",timestamp:t.timestamp,native:t.data.native,cancelable:t.cancelable,stopPropagation:()=>t.stopPropagation(),async:i=>t.async(i),preventDefault:()=>t.preventDefault()}}_wrapClick(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=t.data,{cancelable:c,timestamp:h}=t;return{type:"click",pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:h,screenPoint:Jh(n,o),mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:c,stopPropagation:()=>t.stopPropagation(),async:p=>t.async(p),preventDefault:()=>t.preventDefault()}}_wrapDoubleClick(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=t.data,{cancelable:c,timestamp:h}=t;return{type:"double-click",pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:h,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:c,stopPropagation:()=>t.stopPropagation(),async:p=>t.async(p),preventDefault:()=>t.preventDefault()}}_wrapImmediateClick(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=t.data,c=a.pointerId,{cancelable:h,timestamp:p}=t;return{type:"immediate-click",pointerId:c,pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:p,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:h,stopPropagation:()=>t.stopPropagation(),async:f=>t.async(f),preventDefault:()=>t.preventDefault()}}_wrapImmediateDoubleClick(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=t.data,c=a.pointerId,{cancelable:h,timestamp:p}=t;return{type:"immediate-double-click",pointerId:c,pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:p,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:h,stopPropagation:()=>t.stopPropagation(),async:f=>t.async(f),preventDefault:()=>t.preventDefault()}}_wrapHold(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a}=t.data,{cancelable:l,timestamp:c}=t;return{type:"hold",pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:c,mapPoint:this._getMapPoint(n,o),cancelable:l,stopPropagation:()=>t.stopPropagation(),async:h=>t.async(h),preventDefault:()=>t.preventDefault()}}_getMapPoint(t,i){return this.view.toMap(Jh(t,i),{exclude:[]})}_wrapDrag(t){const i=t.data,{x:r,y:s}=i.center,{action:n,pointerType:o,button:a}=i;if(n==="start"&&(this.latestDragStart=i),!this.latestDragStart)return;const l=i.pointer.native,c=i.buttons,{cancelable:h,timestamp:p}=t,f={x:this.latestDragStart.center.x,y:this.latestDragStart.center.y};return n==="end"&&(this.latestDragStart=void 0),{type:"drag",action:n,x:r,y:s,origin:f,pointerType:o,button:a,buttons:c,radius:i.radius,angle:yl(i.angle),native:l,timestamp:p,cancelable:h,stopPropagation:()=>t.stopPropagation(),async:g=>t.async(g),preventDefault:()=>t.preventDefault()}}_wrapKeyDown(t){const{key:i,repeat:r,native:s}=t.data,{cancelable:n,timestamp:o}=t;return{type:"key-down",key:i,repeat:r,native:s,timestamp:o,cancelable:n,stopPropagation:()=>t.stopPropagation(),async:a=>t.async(a),preventDefault:()=>t.preventDefault()}}_wrapKeyUp(t){const{key:i,native:r}=t.data,{cancelable:s,timestamp:n}=t;return{type:"key-up",key:i,native:r,timestamp:n,cancelable:s,stopPropagation:()=>t.stopPropagation(),async:o=>t.async(o),preventDefault:()=>t.preventDefault()}}_wrapPointer(t,i){const{x:r,y:s,button:n,buttons:o,native:a,eventId:l}=t.data,c=a.pointerId,h=a.pointerType,{cancelable:p,timestamp:f}=t;return{type:i,x:r,y:s,pointerId:c,pointerType:h,button:n,buttons:o,native:a,timestamp:f,eventId:l,cancelable:p,stopPropagation:()=>t.stopPropagation(),async:g=>t.async(g),preventDefault:()=>t.preventDefault()}}_wrapPointerDrag(t){const{x:i,y:r,buttons:s,native:n,eventId:o}=t.data.currentEvent,{button:a}=t.data.startEvent,l=t.data.startEvent.native.pointerId,c=t.data.startEvent.native.pointerType,h=t.data.action,p={x:t.data.startEvent.x,y:t.data.startEvent.y},{cancelable:f,timestamp:g}=t;return{type:"pointer-drag",x:i,y:r,pointerId:l,pointerType:c,button:a,buttons:s,action:h,origin:p,native:n,timestamp:g,eventId:o,cancelable:f,stopPropagation:()=>t.stopPropagation(),async:y=>t.async(y),preventDefault:()=>t.preventDefault()}}_wrapMouseWheel(t){const{cancelable:i,data:r,timestamp:s}=t,{x:n,y:o,deltaY:a,native:l}=r;return{type:"mouse-wheel",x:n,y:o,deltaY:a,native:l,timestamp:s,cancelable:i,stopPropagation:()=>t.stopPropagation(),async:c=>t.async(c),preventDefault:()=>t.preventDefault()}}_wrapGamepad(t){const{action:i,state:r,device:s}=t.data,{cancelable:n,timestamp:o}=t,{buttons:a,axes:l}=r;return{type:"gamepad",device:s,timestamp:o,action:i,buttons:a,axes:l,cancelable:n,stopPropagation:()=>t.stopPropagation(),async:c=>t.async(c),preventDefault:()=>t.preventDefault()}}}var nR,VK,GK;(function(e){e[e.USER=0]="USER",e[e.MANAGER=1]="MANAGER"})(nR||(nR={})),function(e){e[e.None=0]="None",e[e.Unfocused=1]="Unfocused",e[e.Focused=2]="Focused",e[e.Unselected=4]="Unselected",e[e.Selected=8]="Selected",e[e.All=15]="All"}(VK||(VK={})),function(e){e[e.None=0]="None",e[e.Custom1=16]="Custom1",e[e.Custom2=32]="Custom2",e[e.Custom3=64]="Custom3",e[e.Custom4=128]="Custom4",e[e.Custom5=256]="Custom5",e[e.Custom6=512]="Custom6",e[e.Custom7=1024]="Custom7",e[e.Custom8=2048]="Custom8",e[e.Custom9=4096]="Custom9",e[e.Custom10=8192]="Custom10",e[e.Custom11=16384]="Custom11",e[e.Custom12=32768]="Custom12",e[e.All=65520]="All"}(GK||(GK={}));const FBe=he.getLogger("esri.views.interactive.interactiveToolUtils");function UBe(e){return[e.on("before-add",t=>{const i=t.item;if(i==null||e.includes(i))return FBe.warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void t.preventDefault()}),e.on("after-remove",t=>{const i=t.item;i.visible=!1,i.active&&(i.view.activeTool=null),i.destroy()})]}function vL(e){return e.visible&&e.getEditableFlag(nR.USER)&&e.getEditableFlag(nR.MANAGER)}function Vd(e){return Jh(e.x,e.y)}function Lme(e,t){const i=(e instanceof HTMLElement?e:e.surface).getBoundingClientRect();return Jh(t.clientX-i.left,t.clientY-i.top)}function jK(e,t){return t instanceof Event?Lme(e,t):Vd(t)}function HK(e){if(e instanceof Event)return!0;if(typeof e=="object"&&"type"in e)switch(e.type){case"click":case"double-click":case"pointer-down":case"pointer-drag":case"pointer-enter":case"pointer-leave":case"pointer-up":case"pointer-move":case"immediate-click":case"immediate-double-click":case"hold":case"drag":case"mouse-wheel":return!0;default:return!1}return!1}class kBe{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._currentlyActiveTool=null,this._revertToActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}handleInputEvent(t,i){const r=()=>t.stopPropagation();switch(t.type){case"pointer-move":qK(t.pointerType)&&this._pointerLocations.set(t.pointerId,{x:t.x,y:t.y,pointerType:t.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(r(),t.action==="end"&&(this._stopDrag=!1));break;case"pointer-down":{if(!WK(t))break;const s=Vd(t),n=this._intersect(s,t.pointerType,i.forEachTool);if(R(n))break;const o=this._findToolAndManipulatorByKey(n,i.forEachTool,t3),a=po(o,c=>c.manipulator),l=po(o,c=>c.tool);!(_(a)&&_(l)&&a.interactive)||a.grabbable&&a.grabbableForEvent(t)||!a.grabbing||a.dragging||this._ungrabManipulatorBeforeDragging(a,l,t),_(a)&&a.interactive&&a.grabbable&&a.grabbableForEvent(t)&&!a.grabbing&&(this._grabbedManipulators.set(t.pointerId,{key:n,start:s,pointerType:t.pointerType}),this._grabbedManipulators.size===1&&i.activeTool!==n.tool&&(this._currentlyActiveTool=i.activeTool,this._revertToActiveTool=!0,i.setActiveTool(n.tool)),a.grabbing=!0,a.events.emit("grab-changed",{action:"start",pointerType:t.pointerType,screenPoint:s}),r());break}case"pointer-up":this._handlePointerEnd(t,i);break;case"pointer-drag":{if(!WK(t))break;const s=this._grabbedManipulators.get(t.pointerId),n=this._draggedManipulators.get(t.pointerId),o=po(s||n,({key:h})=>h),a=this._findManipulatorByKey(o,i.forEachTool);if(R(a))break;const l=Vd(t);l.x=Be(l.x,0,i.view.width),l.y=Be(l.y,0,i.view.height);const c=(s||n).start;switch(t.action){case"start":case"update":t.action!=="update"&&this._grabbedManipulators.size!==1||(a.dragging=!0,n?a.events.emit("drag",{action:"update",start:c,screenPoint:l}):a.events.emit("drag",{action:"start",start:c,screenPoint:l,pointerType:t.pointerType}),this._draggedManipulators.set(t.pointerId,{key:o,start:c}));break;case"end":a.dragging=!1,n&&a.events.emit("drag",{action:"end",start:c,screenPoint:l}),this._draggedManipulators.delete(t.pointerId),this._handlePointerEnd(t,i)}r();break}case"immediate-click":{const s=Vd(t),n=this._intersect(s,t.pointerType,i.forEachTool),o=this._findToolAndManipulatorByKey(n,i.forEachTool,t3);if(zBe(t)||i.forEachTool(h=>{if((!_(o)||o.tool!==h||h.automaticManipulatorSelection)&&h.manipulators){let p=!1;h.manipulators.forEach(({manipulator:f})=>{f.selected&&(f.selected=!1,p=!0)}),p&&h.manipulatorSelectionChanged&&h.manipulatorSelectionChanged()}}),R(o))break;const{manipulator:a,tool:l}=o;if(!a.interactive)break;a.selectable&&l.automaticManipulatorSelection&&(a.selected=!a.selected,l.manipulatorSelectionChanged&&l.manipulatorSelectionChanged());const c=t.native.shiftKey;a.events.emit("immediate-click",{screenPoint:s,button:t.button,pointerType:t.pointerType,shiftKey:c,stopPropagation:r});break}case"click":{const s=Vd(t),n=this._intersect(s,t.pointerType,i.forEachTool),o=this._findManipulatorByKey(n,i.forEachTool);if(R(o)||!o.interactive)break;const a=t.native.shiftKey;o.events.emit(t.type,{screenPoint:s,button:t.button,pointerType:t.pointerType,shiftKey:a}),r();break}case"double-click":{const s=Vd(t),n=this._intersect(s,t.pointerType,i.forEachTool),o=this._findManipulatorByKey(n,i.forEachTool);if(R(o)||!o.interactive)break;const a=t.native.shiftKey;o.events.emit("double-click",{screenPoint:s,button:t.button,pointerType:t.pointerType,shiftKey:a,stopPropagation:r});break}case"immediate-double-click":{const s=Vd(t),n=this._intersect(s,t.pointerType,i.forEachTool),o=this._findManipulatorByKey(n,i.forEachTool);if(R(o)||!o.interactive)break;const a=t.native.shiftKey;o.events.emit("immediate-double-click",{screenPoint:s,button:t.button,pointerType:t.pointerType,shiftKey:a,stopPropagation:r});break}}this._updateCursor(i.forEachTool)}_ungrabManipulatorBeforeDragging(t,i,r){t.grabbing=!1,t.events.emit("grab-changed",{action:"end",pointerType:r.pointerType,screenPoint:Vd(r)}),this._grabbedManipulators.forEach(({key:s},n)=>{s.tool===i&&i.manipulators.findById(s.manipulatorId)===t&&this._grabbedManipulators.delete(n)})}_handlePointerEnd(t,i){const r=po(this._grabbedManipulators.get(t.pointerId),({key:n})=>n),s=this._findManipulatorByKey(r,i.forEachTool);_(s)&&!s.dragging&&(this._grabbedManipulators.size===1&&this._draggedManipulators.size===0&&this._revertToActiveTool&&(i.setActiveTool(this._currentlyActiveTool),this._revertToActiveTool=!1,this._currentlyActiveTool=null),s.grabbing&&(s.grabbing=!1,s.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:Vd(t)})),this._grabbedManipulators.delete(t.pointerId))}_cursorFromMap(t,i){let r=null;return qr(t,({key:s})=>{const n=this._findManipulatorByKey(s,i);return!!(_(n)&&n.interactive&&"cursor"in n&&n.cursor)&&(r=n.cursor,!0)}),r}_updateCursor(t){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators,t)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators,t)||"pointer":this._cursor=null}clearPointers(t,i,r=!0,s){const n=o=>o.tool===t&&(R(s)||o.manipulatorId===s);this._grabbedManipulators.forEach(({key:o,pointerType:a},l)=>{if(n(o)){this._grabbedManipulators.delete(l);const c=this._findManipulatorByKey(o,i);_(c)&&(c.grabbing=!1,c.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:a}))}}),this._draggedManipulators.forEach(({key:o},a)=>{if(n(o)){this._draggedManipulators.delete(a);const l=this._findManipulatorByKey(o,i);_(l)&&(l.dragging=!1,l.events.emit("drag",{action:"cancel"}))}}),r&&this._hoveredManipulators.forEach(({key:o},a)=>{if(n(o)){this._hoveredManipulators.delete(a);const l=this._findManipulatorByKey(o,i);_(l)&&(l.hovering=!1)}}),this._updateCursor(i)}_intersect(t,i,r){let s=null;return r(n=>{if(n.manipulators==null||!vL(n))return!1;const o=n.manipulators.intersect(t,i);return!R(o)&&(s={manipulatorId:o.id,tool:n},!0)}),s}updateHoveredStateFromKnownPointers(t){this._pointerLocations.forEach((i,r)=>{this._updateHoveredStateForPointerAtScreenPosition(Jh(i.x,i.y),r,i.pointerType,t)})}handleHoverEvent(t,i){t.type!=="pointer-up"&&t.type!=="immediate-click"&&t.type!=="pointer-move"||!qK(t.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(Vd(t),t.pointerId,t.pointerType,i)}_updateHoveredStateForPointerAtScreenPosition(t,i,r,s){const n=this._intersect(t,r,s);let o=this._findManipulatorByKey(n,s);const a=po(this._hoveredManipulators.get(i),({key:c})=>c),l=this._findManipulatorByKey(a,s);_(o)&&!o.interactive&&(o=null),l!==o&&(_(l)&&(l.hovering=!1),_(o)?(o.hovering=!0,this._hoveredManipulators.set(i,{key:n})):this._hoveredManipulators.delete(i),this._updateCursor(s))}_findManipulatorByKey(t,i){return this._findToolAndManipulatorByKey(t,i,t3)?t3.manipulator:null}_findToolAndManipulatorByKey(t,i,r){return R(t)?null:(r.tool=null,r.manipulator=null,i(s=>{if(s!==t.tool||s.manipulators==null||!vL(s))return!1;const n=s.manipulators.findById(t.manipulatorId);return!!_(n)&&(r.manipulator=n,r.tool=s,!0)}),r.manipulator?r:null)}}function qK(e){return e==="mouse"}function WK(e){return e.pointerType!=="mouse"||e.button===0}function zBe(e){return!!e.native.shiftKey}const t3={manipulator:null,tool:null},XK=he.getLogger("esri.views.ToolViewManager"),YK="attached",FU="tools";let Pf=class extends zT{constructor(e){super(e),this._manipulatorState=new kBe,this.tools=new it,this.cursor=null,this._forEachTool=t=>{for(const i of this.tools.items)if(t(i))return}}initialize(){this.handles.add([this.view.on(Ime,e=>{this._handleInputEvent(e)},a0.TOOL),...UBe(this.tools),this.tools.on("before-remove",({item:e})=>{this._manipulatorState.clearPointers(e,this._forEachTool)}),this.tools.on("change",()=>{this._refreshToolWatchers()})])}destroy(){this.detach(),this.handles.removeAll()}set activeTool(e){if(_(e)&&!this.view.ready)return void XK.error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return void(_(e)&&XK.warn("Tool is already active - ignoring activation request."));const t=this.activeTool;this._set("activeTool",e),_(t)&&t.deactivate(),_(e)&&e.activate(),this._removeIncompleteTools(e);const i=R(this.activeTool);for(const r of this.tools){r.setEditableFlag(nR.MANAGER,i||r===this.activeTool);const s=vL(r);!i&&s||this._manipulatorState.clearPointers(r,this._forEachTool,!s)}this._updateCursor()}get updating(){var e,t;return this.updatingHandles.updating||this.tools.some(i=>i.updating)||(e=(t=this.textures)==null?void 0:t.updating)!=null&&e}attach(){this.view.type==="3d"?(this._set("textures",new $x(this.view._stage,this.view.resourceController.scheduler)),this.handles.add([this.view.state.watch("camera",()=>{this._forEachManipulator(e=>{e.onViewChange!=null&&e.onViewChange()})}),this.view.elevationProvider.on("elevation-change",e=>{this._forEachManipulator(t=>{t.onElevationChange!=null&&t.onElevationChange(e)})}),km(()=>this._set("textures",rt(this.textures)))],YK)):this.handles.add(this.view.watch("extent",()=>{this._forEachManipulator(e=>{e.onViewChange!=null&&e.onViewChange()})}))}detach(){_(this.activeTool)&&(this.activeTool=null),this.tools.removeAll(),this.handles.remove(YK)}_forEachManipulator(e){this._forEachTool(t=>{t.manipulators&&t.manipulators.forEach(({manipulator:i})=>e(i,t))})}_handleInputEvent(e){let t=!1;const i=me(I({},e),{stopPropagation:()=>{t=!0,e.stopPropagation()}});_(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool(r=>{!t&&r.visible&&r.handleInputEvent(i)}),!t&&e.type==="key-down"&&e.key==="Escape"&&this.activeTool&&(e.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:r=>{this.activeTool=r},view:this.view}),!t&&_(this.activeTool)&&this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor()}_refreshToolWatchers(){this.handles.remove(FU),this._forEachTool(e=>{if(e instanceof we){const t=nr(e,["cursor","visible","editable"],()=>{vL(e)||this._manipulatorState.clearPointers(e,this._forEachTool),this._updateCursor()});this.handles.add(t,FU)}e.manipulators&&this.handles.add(e.manipulators.on("change",t=>{t.removed.forEach(({id:i})=>{this._manipulatorState.clearPointers(e,this._forEachTool,!0,i)}),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}),FU)}),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateCursor(){let e=this._manipulatorState.cursor;this._forEachTool(t=>!(!_(t.cursor)||!t.visible)&&(e=t.cursor,!0)),this._get("cursor")!==e&&this._set("cursor",e)}_removeIncompleteTools(e){this.tools.filter(t=>(R(e)||t!==e)&&!t.created).forEach(t=>{this.tools.remove(t)})}};u([d({constructOnly:!0,nonNullable:!0})],Pf.prototype,"view",void 0),u([d({readOnly:!0,nonNullable:!0})],Pf.prototype,"textures",void 0),u([d({value:null})],Pf.prototype,"activeTool",null),u([d({readOnly:!0,type:it})],Pf.prototype,"tools",void 0),u([d({readOnly:!0})],Pf.prototype,"cursor",void 0),u([d({readOnly:!0})],Pf.prototype,"updating",null),Pf=u([P("esri.views.ToolViewManager")],Pf);const BBe=Pf;let Xw=class extends we{constructor(e){super(),this.nativeIndex=null,this._detectedDeviceType="unknown",e.mapping==="standard"?this._detectedDeviceType="standard":VBe.test(e.id)?this._detectedDeviceType="spacemouse":this._detectedDeviceType="unknown",this.nativeIndex=e.index}get native(){return(navigator.getGamepads?navigator.getGamepads():[])[this.nativeIndex]}get deviceType(){return this._detectedDeviceType}get axisThreshold(){return GBe[this.deviceType]}};u([d({nonNullable:!0,readOnly:!0})],Xw.prototype,"nativeIndex",void 0),u([d({type:String,readOnly:!0})],Xw.prototype,"deviceType",null),u([d({type:Number,readOnly:!0})],Xw.prototype,"axisThreshold",null),Xw=u([P("esri.views.input.gamepad.GamepadInputDevice")],Xw);const VBe=new RegExp("^(3dconnexion|space(mouse|navigator|pilot|explorer))","i"),GBe={standard:.15,spacemouse:.025,unknown:0},cq=Xw;let dA=class extends we{constructor(...e){super(...e),this.devices=new it,this.enabledFocusMode="document"}};u([d({type:it.ofType(cq),readOnly:!0})],dA.prototype,"devices",void 0),u([d({type:["document","view","none"]})],dA.prototype,"enabledFocusMode",void 0),dA=u([P("esri.views.input.gamepad.GamepadSettings")],dA);const jBe=dA;let a$=class extends we{constructor(){super(...arguments),this.gamepad=new jBe}};u([d({readOnly:!0})],a$.prototype,"gamepad",void 0),a$=u([P("esri.views.input.Input")],a$);const HBe=a$;let ay=class extends we{constructor(e){super(e),this.enabled=!0,this.device=null,this.mode="pan",this.tiltDirection="forward-down",this.velocityFactor=1}};u([d({type:Boolean,nonNullable:!0})],ay.prototype,"enabled",void 0),u([d({type:cq})],ay.prototype,"device",void 0),u([d({type:["pan","zoom"],nonNullable:!0})],ay.prototype,"mode",void 0),u([d({type:["forward-down","forward-up"],nonNullable:!0})],ay.prototype,"tiltDirection",void 0),u([d({type:Number,nonNullable:!0})],ay.prototype,"velocityFactor",void 0),ay=u([P("esri.views.navigation.gamepad.GamepadSettings")],ay);const Nme=ay;let o_=class extends we{constructor(e){super(e),this.browserTouchPanEnabled=!0,this.gamepad=new Nme,this.momentumEnabled=!0,this.mouseWheelZoomEnabled=!0}};u([d({type:Boolean})],o_.prototype,"browserTouchPanEnabled",void 0),u([d({type:Nme,nonNullable:!0})],o_.prototype,"gamepad",void 0),u([d({type:Boolean})],o_.prototype,"momentumEnabled",void 0),u([d({type:Boolean})],o_.prototype,"mouseWheelZoomEnabled",void 0),o_=u([P("esri.views.navigation.Navigation")],o_);const Fme=o_;function qBe(e,t){if(!e)return null;if(!m9(e))return new q("webscene:unsupported-height-model-info","The vertical coordinate system of the scene is not supported",{heightModelInfo:e});const i=e.heightUnit,r=U0.deriveUnitFromSR(e,t).heightUnit;return i!==r?new q("webscene:incompatible-height-unit",`The vertical units of the scene (${i}) must match the horizontal units of the scene (${r})`,{verticalUnit:i,horizontalUnit:r}):null}function WBe(e,t,i){const r=Ume(e),s=t,n=XBe(r,s,i);if(r){const o=U0.deriveUnitFromSR(r,e.spatialReference).heightUnit;if(!i&&o!==r.heightUnit){const a=new q("layerview:unmatched-height-unit",`The vertical units of the layer must match the horizontal units (${o})`,{horizontalUnit:o});return new q("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:r,error:a})}}if(!YBe(e)||n===Za.Unsupported)return new q("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:r});switch(n){case Za.Units:{const o=r.heightUnit||"unknown",a=s.heightUnit||"unknown",l=new q("layerview:incompatible-height-unit",`The vertical units of the layer (${o}) must match the vertical units of the scene (${a})`,{layerUnit:o,sceneUnit:a});return new q("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:r,sceneHeightModelInfo:s,error:l})}case Za.HeightModel:{const o=r.heightModel||"unknown",a=s.heightModel||"unknown",l=new q("layerview:incompatible-height-model",`The height model of the layer (${o}) must match the height model of the scene (${a})`,{layerHeightModel:o,sceneHeightModel:a});return new q("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:r,sceneHeightModelInfo:s,error:l})}case Za.CRS:{const o=r.vertCRS||"unknown",a=s.vertCRS||"unknown",l=new q("layerview:incompatible-vertical-datum",`The vertical datum of the layer (${o}) must match the vertical datum of the scene (${a})`,{layerDatum:o,sceneDatum:a});return new q("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:r,sceneHeightModelInfo:s,error:l})}}return null}function XBe(e,t,i){if(!m9(e)||!m9(t))return Za.Unsupported;if(e==null||t==null)return Za.Ok;if(!i&&e.heightUnit!==t.heightUnit)return Za.Units;if(e.heightModel!==t.heightModel)return Za.HeightModel;switch(e.heightModel){case"gravity-related-height":return Za.Ok;case"ellipsoidal":return e.vertCRS===t.vertCRS?Za.Ok:Za.CRS;default:return Za.Unsupported}}var Za;function m9(e){return e==null||e.heightModel!=null&&e.heightUnit!=null}function YBe(e){return"heightModelInfo"in e&&e.heightModelInfo!=null||e.spatialReference!=null||!Bme(e)}function Ume(e){const t=e.url&&SO(e.url);return!((e.spatialReference&&e.spatialReference.vcsWkid)==null&&_(t)&&t.serverType==="ImageServer")&&kme(e)&&e.heightModelInfo?e.heightModelInfo:Bme(e)?U0.deriveUnitFromSR(ZBe,e.spatialReference):null}function kme(e){return"heightModelInfo"in e}function zme(e){if(e.type==="unknown"||!("capabilities"in e))return!1;switch(e.type){case"csv":case"feature":case"geojson":case"subtype-group":case"ogc-feature":case"wfs":return!0;default:return!1}}function Bme(e){return zme(e)?!!(e.capabilities&&e.capabilities.data&&e.capabilities.data.supportsZ):Gme(e)}function Vme(e){return e.layers!=null||Gme(e)||zme(e)||kme(e)}function Gme(e){switch(e.type){case"building-scene":case"elevation":case"integrated-mesh":case"point-cloud":case"scene":case"voxel":return!0;case"analysis":case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"csv":case"geojson":case"feature":case"subtype-group":case"geo-rss":case"graphics":case"group":case"imagery":case"imagery-tile":case"kml":case"map-image":case"map-notes":case"ogc-feature":case"open-street-map":case"route":case"stream":case"tile":case"unknown":case"unsupported":case"vector-tile":case"wcs":case"web-tile":case"wfs":case"wms":case"wmts":case null:return!1}return!1}(function(e){e[e.Ok=0]="Ok",e[e.Units=1]="Units",e[e.HeightModel=2]="HeightModel",e[e.CRS=3]="CRS",e[e.Unsupported=4]="Unsupported"})(Za||(Za={}));const ZBe=new U0({heightModel:"gravity-related-height"});var Ie;function ZK(e){return e==="global"?Ie.Global:Ie.Local}function uC(e){return e===Ie.Global?"global":"local"}(function(e){e[e.Global=1]="Global",e[e.Local=2]="Local"})(Ie||(Ie={}));let g9,UU=null;async function QBe(e){UU||(UU=Promise.resolve().then(function(){return Sst}).then(t=>g9=t)),await UU,Qt(e)}async function jme(e,t,i,r){if(!e)return null;const s=e.spatialReference;return eue()||M1(s,t)?dO(e,t):g9?g9.projectGeometry(e,t,i,r):(await Promise.race([QBe(r),rV(r)]),jme(e,t,i,r))}const Hme=he.getLogger("esri.views.support.DefaultsFromMap");Hme.level="info";let Ji=class extends we{constructor(e){super(e),this.required={tileInfo:!1,heightModelInfo:!1,extent:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.logDebugInformation=!1,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._debug("Aborting project extent task"),this._projectExtentTask.task=Iu(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return _(this.userSpatialReference)?this.userSpatialReference:this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return R(this.userSpatialReference)||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){var e,t,i,r;const s=(e=this.map)==null?void 0:e.call(this),n=[];return _(this.priorityCollection)&&n.push(this.priorityCollection),n.push({parent:s==null?void 0:s.basemap,layers:s==null||(t=s.basemap)==null?void 0:t.baseLayers},{layers:s==null?void 0:s.layers},{parent:s==null?void 0:s.ground,layers:s==null||(i=s.ground)==null?void 0:i.layers},{parent:s==null?void 0:s.basemap,layers:s==null||(r=s.basemap)==null?void 0:r.referenceLayers}),n}get _allLayers(){var e,t;const i=this._collectLayers(this.mapCollections);return this._debug("Collected",(e=(t=i.layers)==null?void 0:t.length)!=null?e:0,"layers, updating",i.updating),i}get _spatialReferenceTask(){var e,t;if(this.suspended)return(t=this._get("_spatialReferenceTask"))!=null?t:{updating:!1};const{layers:i,updating:r}=this._allLayers,s={candidates:null};for(const o of i)if(this._processSpatialReferenceCandidates(o,s),s.candidates&&s.candidates.length===1)break;if(((e=s.candidates)==null?void 0:e.length)!==1&&r)return{updating:!0};const n=this._pickSpatialReferenceCandidate(s.candidates);return this._debug("Finished spatial reference",_(n)?`${n.spatialReference.wkid}:${_(n.viewingMode)?uC(n.viewingMode):"global/local"}`:"none available"),{spatialReference:_(n)?n.spatialReference:null,viewingMode:_(n)?n.viewingMode:null,updating:!1}}get _tileInfoTask(){var e,t,i,r,s,n,o,a;if(!this.required.tileInfo)return(a=this._get("_tileInfoTask"))!=null?a:{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:l,updating:c}=this._collectLayers([{parent:(e=this.map)==null||(t=e.call(this))==null?void 0:t.basemap,layers:(i=this.map)==null||(r=i.call(this))==null||(s=r.basemap)==null?void 0:s.baseLayers},{layers:(n=this.map)==null||(o=n.call(this))==null?void 0:o.layers}]);if(l&&l.length>0&&"tileInfo"in l[0]){const h=l[0].tileInfo;return{tileInfo:h&&h.spatialReference.equals(this.spatialReference)?h:null,updating:!1}}return{updating:c}}get _heightModelInfoTask(){var e,t;if(!this.required.heightModelInfo||this.suspended&&(e=this._get("_heightModelInfoTask"))!=null&&e.heightModelInfo)return(t=this._get("_heightModelInfoTask"))!=null?t:{updating:!1};const{layers:i,updating:r}=this._allLayers;for(const l of i){var s,n;if(this._debug("Considering",(s=(n=l.title)!=null?n:l.id)!=null?s:l.declaredClass,"for height model info"),Vme(l)){const c=Ume(l);var o,a;if(c)return this._debug("Derived height model info",c),{heightModelInfo:c,vcsWkid:(o=l.spatialReference)==null?void 0:o.vcsWkid,latestVcsWkid:(a=l.spatialReference)==null?void 0:a.latestVcsWkid,updating:!1}}this._debug("Layer does not support height models")}return this._debug("No height model info found,","updating",r),{updating:r}}get _extentCandidatesTask(){var e;if(this.suspended||!this.required.extent)return(e=this._get("_extentCandidatesTask"))!=null?e:{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const t=this._allLayers,i=t.updating,r=[];for(const n of t.layers){var s;const o="fullExtents"in n&&n.fullExtents||(_(n.fullExtent)?[n.fullExtent]:[]),a=this.requiresExtentInSpatialReference?null:o[0],l=(s=o.find(c=>c.spatialReference.equals(this.spatialReference)))!=null?s:a;if(l)return{candidates:[{extent:l,layer:n}],updating:!1};if(this._getSupportedSpatialReferences(n).length>0)for(const c of o)r.push({extent:c,layer:n})}return{candidates:r,updating:i}}get _extentTask(){const{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(R(e)||e.length===0)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const i=this._pickExtentCandidate(e),r=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&r.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:_(this._projectExtentTask.task)&&!this._projectExtentTask.task.finished}:(_(this._projectExtentTask.task)&&(this._debug("Aborting project extent task"),this._projectExtentTask.task=Iu(this._projectExtentTask.task)),this._debug("Starting project extent task for",i.extent),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:r.clone(),task:iO(async s=>{try{const n=await jme(i.extent,r,i.layer.portalItem,s);this._debug("Project extent task finished",n),this._projectExtentTask=me(I({},this._projectExtentTask),{task:null,output:n})}catch{if(Us(s))return;this._projectExtentTask=me(I({},this._projectExtentTask),{task:null})}})},{updating:!0})}_processSpatialReferenceCandidates(e,t){var i;const r=this._getSupportedSpatialReferences(e);if(r.length!==0)if(this._debug("Spatial reference candidates from",(i=e.title)!=null?i:e.id,":",r.map(s=>`${s.spatialReference.wkid}:${_(s.viewingMode)?uC(s.viewingMode):"global/local"}`).join(", ")),t.candidates){const s=[],n=(o,a)=>R(o.viewingMode)?a.viewingMode:(R(a.viewingMode)||o.viewingMode===a.viewingMode)&&o.viewingMode;for(const o of t.candidates)for(const a of r){if(!o.spatialReference.equals(a.spatialReference))continue;const l=n(o,a);if(l!==!1){s.push({spatialReference:o.spatialReference,viewingMode:l});break}}s.length>0&&(t.candidates=s)}else t.candidates=r}_pickSpatialReferenceCandidate(e){const t=this.defaultSpatialReference;return!e||e.length<1?_(t)?{spatialReference:t,viewingMode:null}:null:(_(t)&&e.length>1&&e.some(({spatialReference:i})=>i.equals(t))&&(e=e.filter(({spatialReference:i})=>i.equals(t))),e.length>1&&e.some(({viewingMode:i})=>i!==Ie.Local)&&(e=e.filter(({viewingMode:i})=>i!==Ie.Local)),e[0])}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(t.length===0)return[];const i=[];for(const r of t){const s=this.getSpatialReferenceSupport({spatialReference:r,layer:e});if(_(s)){const n=_(s.constraints)?s.constraints:[{spatialReference:r}];for(const{spatialReference:o,viewingMode:a}of n)(!this.requiresExtentInSpatialReference||R(this.userSpatialReference)||o.equals(this.userSpatialReference))&&i.push({spatialReference:o,viewingMode:a})}}return i}_pickExtentCandidate(e){const t=this.spatialReference;return e.find(({extent:i})=>t.equals(i.spatialReference))||e[0]}_collectLayers(e){var t;if(this._loadMaybe((t=this.map)==null?void 0:t.call(this))!=="loaded")return{layers:[],updating:!0};const i={layers:[],preloading:-1,updating:!1};for(const r of e)if(this._collectCollection(r,i),i.preloading===this.sourcePreloadCount)break;return{layers:i.layers,updating:i.updating}}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const s of e.layers){switch(this._loadMaybe(s)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":var i,r;t.updating||(this._debug("Considering layer",(i=(r=s.title)!=null?r:s.id)!=null?i:s.declaredClass),t.layers.push(s)),"layers"in s&&this._collectCollection({layers:s.layers},t)}if(t.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e?e.loadStatus==="not-loaded"?(this._debug("Triggering load",(t=(i=e.title)!=null?i:e.id)!=null?t:e.declaredClass),e.load(),"loading"):e.loadStatus:"loaded";var t,i}_debug(...e){this.logDebugInformation&&Hme.info(...e)}};u([d()],Ji.prototype,"required",void 0),u([d({constructOnly:!0})],Ji.prototype,"map",void 0),u([d({constructOnly:!0})],Ji.prototype,"getSpatialReferenceSupport",void 0),u([d()],Ji.prototype,"defaultSpatialReference",void 0),u([d()],Ji.prototype,"userSpatialReference",void 0),u([d()],Ji.prototype,"sourcePreloadCount",void 0),u([d()],Ji.prototype,"priorityCollection",void 0),u([d()],Ji.prototype,"logDebugInformation",void 0),u([d()],Ji.prototype,"requiresExtentInSpatialReference",void 0),u([d()],Ji.prototype,"suspended",void 0),u([d({readOnly:!0})],Ji.prototype,"ready",null),u([d({readOnly:!0})],Ji.prototype,"heightModelInfoReady",null),u([d({readOnly:!0})],Ji.prototype,"spatialReference",null),u([d({readOnly:!0})],Ji.prototype,"extent",null),u([d({readOnly:!0})],Ji.prototype,"heightModelInfo",null),u([d({readOnly:!0})],Ji.prototype,"vcsWkid",null),u([d({readOnly:!0})],Ji.prototype,"latestVcsWkid",null),u([d({readOnly:!0})],Ji.prototype,"viewingMode",null),u([d({readOnly:!0})],Ji.prototype,"tileInfo",null),u([d({readOnly:!0})],Ji.prototype,"mapCollections",null),u([d({readOnly:!0})],Ji.prototype,"_allLayers",null),u([d({readOnly:!0})],Ji.prototype,"_spatialReferenceTask",null),u([d({readOnly:!0})],Ji.prototype,"_tileInfoTask",null),u([d({readOnly:!0})],Ji.prototype,"_heightModelInfoTask",null),u([d({readOnly:!0})],Ji.prototype,"_extentCandidatesTask",null),u([d()],Ji.prototype,"_extentTask",null),u([d()],Ji.prototype,"_projectExtentTask",void 0),Ji=u([P("esri.views.support.DefaultsFromMap")],Ji);const JBe=Ji;var l$;const i3=he.getLogger("esri.views.View");let Et=l$=class extends Vm(xr.EventedMixin(kS(we))){constructor(e){super(e),this._userSpatialReference=null,this._cursor=null,this.allLayerViews=new sT({getCollections:()=>{var t,i,r;return[(t=this.basemapView)==null?void 0:t.baseLayerViews,(i=this.groundView)==null?void 0:i.layerViews,this.layerViews,(r=this.basemapView)==null?void 0:r.referenceLayerViews]},getChildrenFunction:t=>t.layerViews}),this.groundView=null,this.animation=null,this.basemapView=null,this.fatalError=null,this.extent=null,this.graphics=new cC,this.analyses=new YT,this.navigating=!1,this.typeSpecificPreconditionsReady=!0,this.layerViews=new it,this.magnifier=new Pme,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this.spatialReferenceWarningDelay=1e3,this.supportsGround=!0,this.timeExtent=null,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new HBe,this.navigation=new Fme,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new LBe(this),this.persistableViewModels=new it,this._isValid=!1,this._readyCycleForced=!1,this.handles.add(this.watch("preconditionsReady",t=>{var i,r;t?(this._currentSpatialReference=this.spatialReference,l$.views.add(this)):(this._currentSpatialReference=null,l$.views.remove(this)),this.notifyChange("spatialReference"),!t&&this.ready?((i=this.layerViewManager)==null||i.clear(),(r=this.toolViewManager)==null||r.detach(),_(this.analysisViewManager)&&this.analysisViewManager.detach(),this._teardown()):t&&!this.ready&&(_(this.analysisViewManager)&&this.analysisViewManager.attach(),this._startup(),this.toolViewManager.attach())},!0))}initialize(){this.addResolvingPromise(this.validate().then(()=>(this._isValid=!0,mD(()=>this.ready)))),this.basemapView=new oy({view:this}),this.layerViewManager=new RBe({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.toolViewManager=new BBe({view:this}),this._setupSpatialReferenceLogger(),this.handles.add([Nt(()=>this.initialExtentRequired,e=>this.defaultsFromMap.required=me(I({},this.defaultsFromMap.required),{extent:e}),{sync:!0,initial:!0}),Nt(()=>this.ready,e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)},{sync:!0}),Nt(()=>this._userSpatialReference,e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)},{sync:!0,initial:!0})])}_setupSpatialReferenceLogger(){let e=null;this.handles.add([Nt(()=>{var t;return(t=this.defaultsFromMap)==null?void 0:t.ready},t=>{var i;const r=((i=this.map)==null?void 0:i.allLayers.length)>0;if(t&&!this.spatialReference&&r){if(_(e))return;const s=km(()=>e=Iu(e));e=iO(async n=>{try{await AT(this.spatialReferenceWarningDelay,null,n)}catch{return}finally{e=null}i3.warn("#spatialReference","no spatial reference could be derived from the currently added map layers")}),this.handles.add(s,"spatial-reference-logger-task")}else this.handles.remove("spatial-reference-logger-task")},{sync:!0})])}destroy(){if(this.destroyed)return;this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=rt(this.graphics),this.analyses=rt(this.analyses),this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),this.toolViewManager=rt(this.toolViewManager),this.layerViewManager=rt(this.layerViewManager),this.basemapView=rt(this.basemapView),this.invalidate(),this._emitter.clear(),this.handles.removeAll();const e=this.map;this.map=null,e==null||e.destroy()}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return i3.error("#toMap()","Not implemented on this instance of View"),null}get _defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new JBe(I({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:e=>this.getSpatialReferenceSupport(e)},this._defaultsFromMapSettings))}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get interacting(){return this.navigating}get preconditionsReady(){var e;return!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||Ep.isLoadable(this.map)&&!this.map.loaded||this.width===0||this.height===0||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!(this._currentSpatialReference||(e=this.defaultsFromMap)!=null&&e.ready)||!this.typeSpecificPreconditionsReady)}set map(e){var t;e!==this._get("map")&&((t=e)!=null&&t.destroyed&&(i3.warn("#map","The provided map is already destroyed",{map:e}),e=null),Ep.isLoadable(e)&&e.load().catch(()=>{}),this.initialized&&(this.forceReadyCycle(),this._currentSpatialReference=null),this._set("map",e))}get spatialReference(){var e,t;let i=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return i&&(e=this.defaultsFromMap)!=null&&(t=e.required)!=null&&t.heightModelInfo&&(i=i.clone(),i.vcsWkid=this.defaultsFromMap.vcsWkid,i.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),i}set spatialReference(e){const t=!Rc(e,this._get("spatialReference"));this._set("_userSpatialReference",e),t&&(this._set("spatialReference",e),this._spatialReferenceChanged(e))}_spatialReferenceChanged(e){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get initialExtent(){var e;return(e=this.defaultsFromMap)==null?void 0:e.extent}get cursor(){const e=this.toolViewManager?this.toolViewManager.cursor:null;return _(e)?e:this._cursor||"default"}set cursor(e){this._cursor=e,this.notifyChange("cursor")}get size(){return[this.width,this.height]}whenLayerView(e){return this.layerViewManager.whenLayerView(e)}getDefaultSpatialReference(){var e;return(e=this.defaultsFromMap)==null?void 0:e.spatialReference}getDefaultHeightModelInfo(){var e,t,i;return(e=(t=this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)!=null?t:(i=this.defaultsFromMap)==null?void 0:i.heightModelInfo)!=null?e:null}importLayerView(e){throw new q("importLayerView() not implemented")}hasLayerViewModule(e){return!1}async validate(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{}}_validateSpatialReference(e){return _(this.getSpatialReferenceSupport({spatialReference:e}))}when(e,t){return this.isResolved()&&!this.ready&&i3.warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(e,t)}forceReadyCycle(){this.ready&&(IN(()=>this.preconditionsReady===!1,()=>this._readyCycleForced=!1,{once:!0}),this._readyCycleForced=!0)}addAndActivateTool(e){this.toolViewManager.tools.add(e),this.activeTool=e}tryFatalErrorRecovery(){this.fatalError=null}};Et.views=new it,u([d()],Et.prototype,"_userSpatialReference",void 0),u([mt("toolViewManager.activeTool")],Et.prototype,"activeTool",void 0),u([d({readOnly:!0})],Et.prototype,"allLayerViews",void 0),u([d()],Et.prototype,"groundView",void 0),u([d()],Et.prototype,"animation",void 0),u([d()],Et.prototype,"basemapView",void 0),u([d({readOnly:!0})],Et.prototype,"_defaultsFromMapSettings",null),u([d()],Et.prototype,"defaultsFromMap",null),u([d()],Et.prototype,"fatalError",void 0),u([d({type:Xt})],Et.prototype,"extent",void 0),u([d(WB(cC,"graphics"))],Et.prototype,"graphics",void 0),u([d(WB(YT,"analyses"))],Et.prototype,"analyses",void 0),u([d({readOnly:!0,type:U0})],Et.prototype,"heightModelInfo",null),u([d({readOnly:!0})],Et.prototype,"interacting",null),u([d({readOnly:!0})],Et.prototype,"navigating",void 0),u([d({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],Et.prototype,"preconditionsReady",null),u([d({readOnly:!0})],Et.prototype,"typeSpecificPreconditionsReady",void 0),u([d({type:it,readOnly:!0})],Et.prototype,"layerViews",void 0),u([d({type:Pme})],Et.prototype,"magnifier",void 0),u([d({value:null,type:Mme})],Et.prototype,"map",null),u([d()],Et.prototype,"padding",void 0),u([d({readOnly:!0})],Et.prototype,"ready",void 0),u([d({type:He})],Et.prototype,"spatialReference",null),u([d()],Et.prototype,"spatialReferenceWarningDelay",void 0),u([d()],Et.prototype,"stationary",null),u([d({readOnly:!0})],Et.prototype,"supportsGround",void 0),u([d({type:zp})],Et.prototype,"timeExtent",void 0),u([mt("toolViewManager.tools")],Et.prototype,"tools",void 0),u([d()],Et.prototype,"toolViewManager",void 0),u([d({readOnly:!0})],Et.prototype,"type",void 0),u([d({type:Number})],Et.prototype,"scale",void 0),u([d({readOnly:!0})],Et.prototype,"updating",void 0),u([d({readOnly:!0})],Et.prototype,"initialExtentRequired",void 0),u([d({readOnly:!0})],Et.prototype,"initialExtent",null),u([d()],Et.prototype,"cursor",null),u([d({readOnly:!0})],Et.prototype,"input",void 0),u([d({type:Fme,nonNullable:!0})],Et.prototype,"navigation",void 0),u([d()],Et.prototype,"layerViewManager",void 0),u([d()],Et.prototype,"analysisViewManager",void 0),u([d()],Et.prototype,"width",void 0),u([d()],Et.prototype,"height",void 0),u([d({readOnly:!0})],Et.prototype,"resizing",void 0),u([d({value:null,readOnly:!0})],Et.prototype,"size",null),u([d({readOnly:!0})],Et.prototype,"suspended",void 0),u([d({readOnly:!0})],Et.prototype,"viewEvents",void 0),u([d({readOnly:!0})],Et.prototype,"persistableViewModels",void 0),u([d()],Et.prototype,"_isValid",void 0),u([d()],Et.prototype,"_readyCycleForced",void 0),u([d()],Et.prototype,"_currentSpatialReference",void 0),Et=l$=u([P("esri.views.View")],Et);const KBe=Et;let ly=class extends RD{constructor(e){super(e),this.state="running",this.target=null}initialize(){this.addResolvingPromise(new Promise((e,t)=>this._dfd={resolve:e,reject:t}))}get done(){return this.state==="finished"||this.state==="stopped"}stop(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","stopped"),this._dfd.reject(new q("ViewAnimation stopped")))}finish(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","finished"),this._dfd.resolve())}update(e,t){t||(t=Cc(e)?"waiting-for-target":"running"),this._set("target",e),this._set("state",t)}};u([d({readOnly:!0})],ly.prototype,"done",null),u([d({readOnly:!0,type:String})],ly.prototype,"state",void 0),u([d()],ly.prototype,"target",void 0),ly=u([P("esri.views.ViewAnimation")],ly),function(e){e.State={RUNNING:"running",STOPPED:"stopped",FINISHED:"finished",WAITING_FOR_TARGET:"waiting-for-target"}}(ly||(ly={}));const sS=ly,P2=()=>import("./TileLayerView3D.c425ad15.js"),QK=()=>Promise.resolve().then(function(){return Ynt}),JK={analysis:()=>import("./AnalysisLayerView3D.585ea410.js"),"base-dynamic":()=>import("./BaseDynamicLayerView3D.55ad82df.js"),"base-elevation":QK,"base-tile":P2,"bing-maps":P2,"building-scene":()=>import("./BuildingSceneLayerView3D.5e70d9f2.js"),csv:()=>import("./CSVLayerView3D.ed6e580c.js"),elevation:QK,feature:()=>import("./FeatureLayerView3D.e7657c01.js"),geojson:()=>import("./GeoJSONLayerView3D.c0f1c74f.js"),graphics:()=>import("./GraphicsLayerView3D.7d81e956.js"),group:()=>import("./GroupLayerView.91150439.js"),imagery:()=>import("./ImageryLayerView3D.eca7f7df.js"),"integrated-mesh":()=>import("./IntegratedMeshLayerView3D.f52f7146.js"),"map-image":()=>import("./MapImageLayerView3D.44fa6758.js"),"ogc-feature":()=>import("./OGCFeatureLayerView3D.40368ed4.js"),"open-street-map":P2,"point-cloud":()=>import("./PointCloudLayerView3D.8b7633e6.js").then(function(e){return e.P}),voxel:()=>import("./VoxelLayerView3D.da5f16bc.js"),route:()=>import("./RouteLayerView3D.731d9b81.js"),scene:e=>e.profile==null||e.profile==="mesh-pyramids"?import("./SceneLayerView3D.7a81238d.js"):import("./SceneLayerGraphicsView3D.349f99b2.js"),stream:()=>import("./StreamLayerView3D.dcedac40.js"),tile:P2,"imagery-tile":()=>import("./ImageryTileLayerView3D.cb971c74.js"),"vector-tile":()=>import("./VectorTileLayerView3D.9e3c6b02.js"),wcs:()=>import("./ImageryTileLayerView3D.cb971c74.js"),"web-tile":P2,wfs:()=>import("./WFSLayerView3D.21391ca1.js"),wms:()=>import("./WMSLayerView3D.616b0ca1.js"),wmts:()=>import("./WMTSLayerView3D.bf1178b1.js"),"geo-rss":null,kml:null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null};function eVe(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new q(`${i}:view-not-supported`,`${t} is not supported in 3D`)}const KK={hasLayerViewModule:e=>_(JK[e.type]),importLayerView:e=>{const t=JK[e.type];if(!_(t))throw eVe(e);return t(e)}},tVe=he.getLogger("esri.views.3d.analysis.AnalysisViewManager3D"),eee="analyses-owner-handles";var Dx,$_;(function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"})(Dx||(Dx={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}($_||($_={}));let a_=class extends Vm(we){constructor(e){super(e),this._allAnalysisViews=new it,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._analysisModules={"area-measurement":{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}destroy(){this.detach()}attach(){this.handles.add(this._connectOwner(this.view),eee)}detach(){this.handles.remove(eee),this._update(),this._creatingViewCount=0}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){return{allAnalysisViews:this._allAnalysisViews}}whenAnalysisView(e){const t=this._items.get(e);if(R(t)||t.state.list===$_.REMOVED){const i=new q("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return Promise.reject(i)}return t.createAnalysisViewTask.promise}_connectOwner(e){return this._connectAnalysesCollection(e.analyses)}_connectAnalysesCollection(e){for(const r of e)this._addAnalysis(r);const t=e.on("after-add",r=>this._addAnalysis(r.item)),i=e.on("after-remove",r=>this._removeAnalysis(r.item));return{remove:()=>{t.remove(),i.remove();for(const r of e)this._removeAnalysis(r)}}}_addAnalysis(e){const t=this._items.get(e);if(t==null){const i={state:{view:Dx.PENDING,list:$_.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,i),i.createAnalysisViewTask=iO(r=>this._createAnalysisViewPromise(i,r))}else t.state.list=$_.ADDED}_removeAnalysis(e){const t=this._items.get(e);t!=null?(t.state.list=$_.REMOVED,this._scheduleUpdate()):tVe.error("Trying to remove analysis which was not added")}_scheduleUpdate(){_(this._scheduledUpdateHandle)||(this._scheduledUpdateHandle=rO(()=>this._update()))}_update(){this._scheduledUpdateHandle=Js(this._scheduledUpdateHandle),this._items.forEach(e=>{if(e.state.list===$_.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case Dx.PENDING:e.createAnalysisViewTask=Iu(e.createAnalysisViewTask);break;case Dx.CREATED:_(e.view)&&(this._allAnalysisViews.remove(e.view),e.view=rt(e.view),e.createAnalysisViewTask=null)}})}async _createAnalysisViewPromise(e,t){const i=e.analysis,r=i.type,s=this._analysisModules[r];if(this._creatingViewCount+=1,R(s.module))try{s.module=await this._loadAnalysisModule(r)}catch(o){throw this._creatingViewCount-=1,o}if(Us(t))throw this._creatingViewCount-=1,pi("AnalysisView creation aborted");const n=new s.module.default({analysis:i,view:this.view});try{await n.when()}catch(o){throw this._creatingViewCount-=1,o}if(Us(t))throw this._creatingViewCount-=1,n.destroy(),pi("AnalysisView creation aborted");return e.view=n,e.state.view=Dx.CREATED,this._allAnalysisViews.add(n),this._creatingViewCount-=1,n}_loadAnalysisModule(e){switch(e){case"area-measurement":return import("./AreaMeasurementAnalysisView3D.96e68bbf.js").then(function(t){return t.A});case"direct-line-measurement":return import("./DirectLineMeasurementAnalysisView3D.2bb373f8.js").then(function(t){return t.D});case"line-of-sight":return import("./LineOfSightAnalysisView3D.c9b7808e.js");case"slice":return import("./SliceAnalysisView3D.e1232d23.js").then(function(t){return t.S});default:return null}}};u([d()],a_.prototype,"updating",null),u([d({constructOnly:!0})],a_.prototype,"view",void 0),u([d()],a_.prototype,"_allAnalysisViews",void 0),u([d()],a_.prototype,"_creatingViewCount",void 0),a_=u([P("esri.views.3d.analysis.AnalysisViewManager3D")],a_);const iVe=a_,rVe=he.getLogger("esri.views.3d.state.Constraints");let If=class extends we{constructor(e){super(e),this.collision=new pA,this.distance=1/0,this.minimumPoiDistance=4}get altitude(){return this.mode===Ie.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==Ie.Local?this._set("altitude",e):rVe.warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?Be(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return Be(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===Ie.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=kU)=>(i.min=Fn.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?rI([[4e3,Fn.max],[1e4,Rt(88)],[6e6,Rt(88)]]):()=>Fn.max;return(t,i=kU)=>(i.min=Fn.min,i.max=e(t),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?rI([[4e3,Fn.max],[5e4,Rt(88)],[6e6,Rt(88)],[2e7,Fn.min]]):rI([[3e5,Fn.max],[3e6,Rt(88)],[6e6,Rt(88)],[2e7,Fn.min]]);return(t,i=kU)=>(i.min=Fn.min,i.max=e(t),i)}};function sVe(e){return{min:-2e5,max:4*e.radius}}u([d()],If.prototype,"altitude",null),u([d({readOnly:!0})],If.prototype,"collision",void 0),u([d()],If.prototype,"distance",void 0),u([d({readOnly:!0})],If.prototype,"minimumPoiDistance",void 0),u([d()],If.prototype,"tilt",void 0),u([d({constructOnly:!0})],If.prototype,"mode",void 0),If=u([P("esri.views.3d.state.Constraints")],If);const tee=sVe(ai),Fn={min:Rt(.5),max:Rt(179.5)},kU={min:0,max:0};let pA=class extends we{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};u([d({type:Boolean})],pA.prototype,"enabled",void 0),u([d({type:Number})],pA.prototype,"elevationMargin",void 0),pA=u([P("esri.views.3d.state.Constraints.CollisionConstraint")],pA);const nVe=If;let fA=class extends we{constructor(){super(...arguments),this.min=tee.min,this.max=tee.max}set mode(e){RT(he.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"})}get mode(){return RT(he.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"}),"manual"}};u([d({type:Number})],fA.prototype,"min",void 0),u([d({type:Number})],fA.prototype,"max",void 0),fA=u([P("esri.views.3d.constraints.AltitudeConstraint")],fA);const qme=fA;let cy=class extends we{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){this.mode==="auto"&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};u([d({type:Number,value:1e-8})],cy.prototype,"near",null),u([At("near")],cy.prototype,"castNear",null),u([d({type:Number,value:1e-8})],cy.prototype,"far",null),u([At("far")],cy.prototype,"castFar",null),u([d({type:["auto","manual"]})],cy.prototype,"mode",void 0),cy=u([P("esri.views.3d.constraints.ClipDistanceConstraint")],cy);const Wme=cy,y9={min:yl(Fn.min),max:yl(Fn.max)};let Yw=class extends we{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return Be(e,y9.min,y9.max)}autoUpdate(e){this.mode==="auto"&&this._get("max")!==e&&this._set("max",e)}};u([d({type:["auto","manual"]})],Yw.prototype,"mode",void 0),u([d({type:Number,value:y9.max})],Yw.prototype,"max",null),u([At("max")],Yw.prototype,"castMax",null),Yw=u([P("esri.views.3d.constraints.TiltConstraint")],Yw);const Xme=Yw;let Zw=class extends we{constructor(){super(...arguments),this.tilt=new Xme,this.altitude=new qme,this.clipDistance=new Wme}};u([d({type:Xme})],Zw.prototype,"tilt",void 0),u([d({type:qme})],Zw.prototype,"altitude",void 0),u([d({type:Wme})],Zw.prototype,"clipDistance",void 0),Zw=u([P("esri.views.3d.constraints.Constraints")],Zw);const Yme=Zw;var v9;let yh=v9=class extends fe{constructor(e){super(e),this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(e,t){return t.datetime!=null&&new Date(t.datetime)||null}writeDate(e,t,i){t[i]=e.getTime()}readDirectShadowsEnabled(e,t){return!!t.directShadows}writedirectShadowsEnabled(e,t,i){e&&(t[i]=e)}writeDisplayUTCOffset(e,t){e!=null&&(t.displayUTCOffset=e)}clone(){return new v9(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:this.displayUTCOffset!=null?this.displayUTCOffset:null};return this.date!=null&&(e.date=new Date(this.date.getTime())),e}};u([d({type:Date,json:{type:Number,write:{target:"datetime"}}})],yh.prototype,"date",void 0),u([De("date",["datetime"])],yh.prototype,"readDate",null),u([Fe("date")],yh.prototype,"writeDate",null),u([d({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],yh.prototype,"directShadowsEnabled",void 0),u([De("directShadowsEnabled",["directShadows"])],yh.prototype,"readDirectShadowsEnabled",null),u([Fe("directShadowsEnabled")],yh.prototype,"writedirectShadowsEnabled",null),u([d({type:Number,json:{write:!0}})],yh.prototype,"displayUTCOffset",void 0),u([Fe("displayUTCOffset")],yh.prototype,"writeDisplayUTCOffset",null),yh=v9=u([P("esri.webscene.Lighting")],yh);const Mp=yh;var Qw;let vh=Qw=class extends xr.EventedMixin(Mp){constructor(e){super(e),this.type="sun",this.cameraTrackingEnabled=!0,this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const t=new Date().getFullYear(),i=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(e){return new Qw(e.cloneConstructProperties())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){e!=null&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}autoUpdate(e,t){const i=Qw.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let r=null;e!=null&&(this.positionTimezoneInfo.autoUpdated=!0,r=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime())));const s=Qw.calculateTimezoneOffset(this.positionTimezoneInfo);if(i!==s&&(zU.target=this,zU.timezoneOffset=s,this.emit("timezone-will-change",zU)),e!=null)return r!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new Qw(me(I({},this.cloneConstructProperties()),{defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled}));return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return e.date!=null&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}};u([d({readOnly:!0})],vh.prototype,"type",void 0),u([d({type:Boolean})],vh.prototype,"cameraTrackingEnabled",void 0),u([d({type:Boolean})],vh.prototype,"ambientOcclusionEnabled",void 0),u([d({type:Boolean})],vh.prototype,"waterReflectionEnabled",void 0),u([d({type:Date})],vh.prototype,"defaultDate",null),u([d({type:Date})],vh.prototype,"date",null),vh=Qw=u([P("esri.views.3d.environment.SunLighting")],vh),function(e){function t({hours:i,minutes:r,seconds:s}){return Math.round(i+r/60+s/3600)}e.calculateTimezoneOffset=t}(vh||(vh={}));const zU={target:null,timezoneOffset:0},l_=vh;var _9;let Jw=_9=class extends xr.EventedMixin(Mp){constructor(e){super(e),this.type="virtual",this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1}clone(){return new _9(me(I({},this.cloneConstructProperties()),{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled}))}cloneWithWebsceneLighting(e){const t=this.clone();return t.directShadowsEnabled=e.directShadowsEnabled,t}};u([d({readOnly:!0})],Jw.prototype,"type",void 0),u([d({type:Boolean})],Jw.prototype,"ambientOcclusionEnabled",void 0),u([d({type:Boolean})],Jw.prototype,"waterReflectionEnabled",void 0),Jw=_9=u([P("esri.views.3d.environment.VirtualLighting")],Jw);const Zme=Jw,oVe={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:l_,virtual:Zme}};var b9;let c$=b9=class extends we{set quality(e){["low","high"].indexOf(e)!==-1&&this._set("quality",e)}clone(){return new b9({quality:this.quality})}};u([d({type:["low","high"],value:"low"})],c$.prototype,"quality",null),c$=b9=u([P("esri.views.3d.environment.SceneViewAtmosphere")],c$);const Qme=c$;var w9;let mA=w9=class extends fe{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new w9({cloudCover:this.cloudCover})}};u([ut({sunny:"sunny"})],mA.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],mA.prototype,"cloudCover",void 0),mA=w9=u([P("esri.views.3d.environment.SunnyWeather")],mA);const Jme=mA;var x9;let gA=x9=class extends fe{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new x9({cloudCover:this.cloudCover})}};u([ut({cloudy:"cloudy"})],gA.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],gA.prototype,"cloudCover",void 0),gA=x9=u([P("esri.views.3d.environment.CloudyWeather")],gA);const aVe=gA;var T9;let yA=T9=class extends fe{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new T9({fogStrength:this.fogStrength})}};u([ut({foggy:"foggy"})],yA.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],yA.prototype,"fogStrength",void 0),yA=T9=u([P("esri.views.3d.environment.FoggyWeather")],yA);const lVe=yA;var S9;let Kw=S9=class extends fe{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new S9({cloudCover:this.cloudCover,precipitation:this.precipitation})}};u([ut({rainy:"rainy"})],Kw.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],Kw.prototype,"cloudCover",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],Kw.prototype,"precipitation",void 0),Kw=S9=u([P("esri.views.3d.environment.RainyWeather")],Kw);const cVe=Kw;var E9;let ex=E9=class extends we{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5}clone(){return new E9({cloudCover:this.cloudCover,precipitation:this.precipitation})}};u([ut({snowy:"snowy"})],ex.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],ex.prototype,"cloudCover",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1}})],ex.prototype,"precipitation",void 0),ex=E9=u([P("esri.views.3d.environment.SnowyWeather")],ex);const uVe=ex,Kme={key:"type",base:null,typeMap:{sunny:Jme,cloudy:aVe,rainy:cVe,snowy:uVe,foggy:lVe}},iee=Object.keys(Kme.typeMap);function hVe(){return ue("enable-feature:precipitation")?iee:iee.filter(e=>e!=="snowy")}function dVe(e,t){return!!hVe().includes(e)||(t.error(`"${e}" is not a valid weather type`),!1)}const pu=1e4;let u$=class extends fe{constructor(e){super(e)}clone(){}};u([d({readOnly:!0,json:{read:!1}})],u$.prototype,"type",void 0),u$=u([P("esri.webscene.background.Background")],u$);const ege=u$;var A9;const pVe=me(I({},Bm),{nonNullable:!0});let vA=A9=class extends ege{constructor(e){super(e),this.type="color",this.color=new Je([0,0,0,1])}clone(){return new A9(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};u([ut({color:"color"},{readOnly:!0})],vA.prototype,"type",void 0),u([d(pVe)],vA.prototype,"color",void 0),vA=A9=u([P("esri.webscene.background.ColorBackground")],vA);const tge=vA,ree={base:ege,key:"type",typeMap:{color:tge}};function fVe(e){return(t,i,r)=>{if(!t)return t;for(const s in e.typeMap)if(t.type===s){const n=new e.typeMap[s];return n.read(t,r),n}}}const mVe={types:ree,json:{read:fVe(ree),write:{overridePolicy:(e,t,i)=>({enabled:!i||!i.isPresentation})}}};var C9;const see=(e,t,i)=>({enabled:!i||!i.isPresentation});let c_=C9=class extends fe{constructor(e){super(e),this.lighting=new Mp,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}clone(){return new C9(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:Mp.prototype.clone.call(this.lighting),background:se(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled}}};u([d({type:Mp,json:{write:!0}})],c_.prototype,"lighting",void 0),u([d(mVe)],c_.prototype,"background",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:see}}})],c_.prototype,"atmosphereEnabled",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:see}}})],c_.prototype,"starsEnabled",void 0),c_=C9=u([P("esri.webscene.Environment")],c_);const nS=c_;var _A;const gVe=he.getLogger("esri.views.3d.environment.SceneViewEnvironment");let u_=_A=class extends nS{constructor(e){super(e),this.atmosphere=new Qme,this.lighting=new l_}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new _A(me(I({},t),{lighting:l_.fromWebsceneLighting(t.lighting)}))}set weather(e){dVe(e==null?void 0:e.type,gVe)&&this._set("weather",e)}castLighting(e){return this._convertLighting(e)}applyLighting(e){this.lighting=this._convertLighting(e)}_convertLighting(e){return e?e instanceof l_||e instanceof Zme?e:e instanceof Mp?((t=this.lighting)==null?void 0:t.type)==="sun"?this.lighting.cloneWithWebsceneLighting(e):l_.fromWebsceneLighting(e):Zh(oVe,e):new l_;var t}clone(){return new _A({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:se(this.background)})}cloneWithWebsceneEnvironment(e){return new _A(me(I({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:se(this.background)},e.cloneConstructProperties()),{lighting:this.lighting.type&&this.lighting.type!=="sun"?l_.fromWebsceneLighting(e.lighting):this.lighting.cloneWithWebsceneLighting(e.lighting)}))}};u([d({type:Qme,json:{read:!1},nonNullable:!0})],u_.prototype,"atmosphere",void 0),u([d({types:Kme,nonNullable:!0,json:{write:!1},value:new Jme})],u_.prototype,"weather",null),u([d({nonNullable:!0})],u_.prototype,"lighting",void 0),u([At("lighting")],u_.prototype,"castLighting",null),u_=_A=u([P("esri.views.3d.environment.SceneViewEnvironment")],u_);const tx=u_;function zs(e,t){return e[0]=t[0],e[1]=t[1],e}function rr(e,t,i){return e[0]=t,e[1]=i,e}function Mh(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e}function lp(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e}function ige(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e}function rge(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e}function yVe(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function vVe(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function _Ve(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e}function bVe(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e}function wVe(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function nl(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e}function xVe(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e}function nT(e,t){const i=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(i*i+r*r)}function _L(e,t){const i=t[0]-e[0],r=t[1]-e[1];return i*i+r*r}function uq(e){const t=e[0],i=e[1];return Math.sqrt(t*t+i*i)}function sge(e){const t=e[0],i=e[1];return t*t+i*i}function hq(e,t){return e[0]=-t[0],e[1]=-t[1],e}function TVe(e,t){return e[0]=1/t[0],e[1]=1/t[1],e}function oR(e,t){const i=t[0],r=t[1];let s=i*i+r*r;return s>0&&(s=1/Math.sqrt(s),e[0]=t[0]*s,e[1]=t[1]*s),e}function gs(e,t){return e[0]*t[0]+e[1]*t[1]}function SVe(e,t,i){const r=t[0]*i[1]-t[1]*i[0];return e[0]=e[1]=0,e[2]=r,e}function ix(e,t,i,r){const s=t[0],n=t[1];return e[0]=s+r*(i[0]-s),e[1]=n+r*(i[1]-n),e}function EVe(e,t){t=t||1;const i=2*Nh()*Math.PI;return e[0]=Math.cos(i)*t,e[1]=Math.sin(i)*t,e}function R9(e,t,i){const r=t[0],s=t[1];return e[0]=i[0]*r+i[2]*s,e[1]=i[1]*r+i[3]*s,e}function h_(e,t,i){const r=t[0],s=t[1];return e[0]=i[0]*r+i[2]*s+i[4],e[1]=i[1]*r+i[3]*s+i[5],e}function AVe(e,t,i){const r=t[0],s=t[1];return e[0]=i[0]*r+i[3]*s+i[6],e[1]=i[1]*r+i[4]*s+i[7],e}function CVe(e,t,i){const r=t[0],s=t[1];return e[0]=i[0]*r+i[4]*s+i[12],e[1]=i[1]*r+i[5]*s+i[13],e}function RVe(e,t,i,r){const s=t[0]-i[0],n=t[1]-i[1],o=Math.sin(r),a=Math.cos(r);return e[0]=s*a-n*o+i[0],e[1]=s*o+n*a+i[1],e}function OVe(e,t){const i=e[0],r=e[1],s=t[0],n=t[1];let o=i*i+r*r;o>0&&(o=1/Math.sqrt(o));let a=s*s+n*n;a>0&&(a=1/Math.sqrt(a));const l=(i*s+r*n)*o*a;return l>1?0:l<-1?Math.PI:Math.acos(l)}function MVe(e){return"vec2("+e[0]+", "+e[1]+")"}function nge(e,t){return e[0]===t[0]&&e[1]===t[1]}function PVe(e,t){const i=e[0],r=e[1],s=t[0],n=t[1];return Math.abs(i-s)<=wt*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(r-n)<=wt*Math.max(1,Math.abs(r),Math.abs(n))}function IVe(e,t,i,r,s){let n=t[0]-i[0],o=t[1]-i[1];const a=(r[0]*n+r[1]*o)*(s-1);return n=r[0]*a,o=r[1]*a,e[0]=t[0]+n,e[1]=t[1]+o,e}const $Ve=uq,DVe=lp,LVe=ige,NVe=rge,oge=nT,FVe=_L,UVe=sge;Object.freeze({__proto__:null,copy:zs,set:rr,add:Mh,subtract:lp,multiply:ige,divide:rge,ceil:yVe,floor:vVe,min:_Ve,max:bVe,round:wVe,scale:nl,scaleAndAdd:xVe,distance:nT,squaredDistance:_L,length:uq,squaredLength:sge,negate:hq,inverse:TVe,normalize:oR,dot:gs,cross:SVe,lerp:ix,random:EVe,transformMat2:R9,transformMat2d:h_,transformMat3:AVe,transformMat4:CVe,rotate:RVe,angle:OVe,str:MVe,exactEquals:nge,equals:PVe,projectAndScale:IVe,len:$Ve,sub:DVe,mul:LVe,div:NVe,dist:oge,sqrDist:FVe,sqrLen:UVe});function age(e){return Math.min(1,Math.max(0,(e-1e5)/(1e6-1e5)))}const O9=1e4,Pb=je(5802e-9,13558e-9,331e-7),BU=3,VU=je(65e-8*BU,1881e-9*BU,85e-9*BU),kVe=3996e-9,zVe=.085,h$=1e5;function x(e,...t){let i="";for(let r=0;r<t.length;r++)i+=e[r]+t[r];return i+=e[e.length-1],i}(function(e){function t(r){return Math.round(r).toString()}function i(r){return r.toPrecision(8)}e.int=t,e.float=i})(x||(x={}));var E;(function(e){e.POSITION="position",e.NORMAL="normal",e.UV0="uv0",e.AUXPOS1="auxpos1",e.AUXPOS2="auxpos2",e.MAPPOS="mapPos",e.COLOR="color",e.SYMBOLCOLOR="symbolColor",e.SIZE="size",e.TANGENT="tangent",e.OFFSET="offset",e.SUBDIVISIONFACTOR="subdivisionFactor",e.COLORFEATUREATTRIBUTE="colorFeatureAttribute",e.SIZEFEATUREATTRIBUTE="sizeFeatureAttribute",e.OPACITYFEATUREATTRIBUTE="opacityFeatureAttribute",e.DISTANCETOSTART="distanceToStart",e.UVMAPSPACE="uvMapSpace",e.BOUNDINGRECT="boundingRect",e.UVREGION="uvRegion",e.NORMALCOMPRESSED="normalCompressed",e.PROFILERIGHT="profileRight",e.PROFILEUP="profileUp",e.PROFILEVERTEXANDNORMAL="profileVertexAndNormal",e.FEATUREVALUE="featureValue",e.MODELORIGINHI="modelOriginHi",e.MODELORIGINLO="modelOriginLo",e.MODEL="model",e.MODELNORMAL="modelNormal",e.INSTANCECOLOR="instanceColor",e.INSTANCEFEATUREATTRIBUTE="instanceFeatureAttribute",e.LOCALTRANSFORM="localTransform",e.GLOBALTRANSFORM="globalTransform",e.BOUNDINGSPHERE="boundingSphere",e.MODELORIGIN="modelOrigin",e.MODELSCALEFACTORS="modelScaleFactors",e.FEATUREATTRIBUTE="featureAttribute",e.STATE="state",e.LODLEVEL="lodLevel",e.POSITION0="position0",e.POSITION1="position1",e.NORMALA="normalA",e.NORMALB="normalB",e.COMPONENTINDEX="componentIndex",e.VARIANTOFFSET="variantOffset",e.VARIANTSTROKE="variantStroke",e.VARIANTEXTENSION="variantExtension",e.U8PADDING="u8padding",e.U16PADDING="u16padding",e.SIDENESS="sideness",e.START="start",e.END="end",e.UP="up",e.EXTRUDE="extrude"})(E||(E={}));function gm(e,t){t.attributeTextureCoordinates===_n.Default&&(e.attributes.add(E.UV0,"vec2"),e.varyings.add("vuv0","vec2"),e.vertex.code.add(x`void forwardTextureCoordinates() {
vuv0 = uv0;
}`)),t.attributeTextureCoordinates===_n.Atlas&&(e.attributes.add(E.UV0,"vec2"),e.varyings.add("vuv0","vec2"),e.attributes.add(E.UVREGION,"vec4"),e.varyings.add("vuvRegion","vec4"),e.vertex.code.add(x`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`)),t.attributeTextureCoordinates===_n.None&&e.vertex.code.add(x`void forwardTextureCoordinates() {}`)}var _n;(function(e){e[e.None=0]="None",e[e.Default=1]="Default",e[e.Atlas=2]="Atlas",e[e.COUNT=3]="COUNT"})(_n||(_n={}));function nd(e){e.code.add(x`const float MAX_RGBA_FLOAT =
255.0 / 256.0 +
255.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 / 256.0;
const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);
vec4 float2rgba(const float value) {
float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);
vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);
const float toU8AsFloat = 1.0 / 255.0;
return fixedPointU8 * toU8AsFloat;
}
const vec4 RGBA_2_FLOAT_FACTORS = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgba2float(vec4 rgba) {
return dot(rgba, RGBA_2_FLOAT_FACTORS);
}`)}function Os(e){e.include(nd),e.code.add(x`float linearDepthFromFloat(float depth, vec2 nearFar) {
return -(depth * (nearFar[1] - nearFar[0]) + nearFar[0]);
}
float linearDepthFromTexture(sampler2D depthTex, vec2 uv, vec2 nearFar) {
return linearDepthFromFloat(rgba2float(texture2D(depthTex, uv)), nearFar);
}`)}function BF(e){e.fragment.code.add(x`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}const BVe=he.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");class lge{constructor(){this.includedModules=new Map}include(t,i){this.includedModules.has(t)?this.includedModules.get(t)!==i&&BVe.error("Trying to include shader module multiple times with different sets of options."):(this.includedModules.set(t,i),t(this.builder,i))}}class Oi extends lge{constructor(){super(...arguments),this.vertex=new nee,this.fragment=new nee,this.attributes=new jVe,this.varyings=new HVe,this.extensions=new oS,this.constants=new Gr}get fragmentUniforms(){return this.fragment.uniforms}get builder(){return this}generateSource(t){const i=this.extensions.generateSource(t),r=this.attributes.generateSource(t),s=this.varyings.generateSource(),n=t==="vertex"?this.vertex:this.fragment,o=n.uniforms.generateSource(),a=n.code.generateSource(),l=t==="vertex"?WVe:qVe,c=this.constants.generateSource().concat(n.constants.generateSource());return`
${i.join(`
`)}

${l}

${c.join(`
`)}

${o.join(`
`)}

${r.join(`
`)}

${s.join(`
`)}

${a.join(`
`)}`}}class VVe{constructor(){this._entries=new Map}add(t,i,r){const s=`${t}_${i}_${r}`;return this._entries.set(s,{name:t,type:i,arraySize:r}),this}generateSource(){const t=i=>i?`[${i}]`:"";return Array.from(this._entries.values()).map(i=>`uniform ${i.type} ${i.name}${t(i.arraySize)};`)}get entries(){return Array.from(this._entries.values())}}class GVe{constructor(){this._entries=new Array}add(t){this._entries.push(t)}generateSource(){return this._entries}}class nee extends lge{constructor(){super(...arguments),this.uniforms=new VVe,this.code=new GVe,this.constants=new Gr}get builder(){return this}}class jVe{constructor(){this._entries=new Array}add(t,i){this._entries.push([t,i])}generateSource(t){return t==="fragment"?[]:this._entries.map(i=>`attribute ${i[1]} ${i[0]};`)}}class HVe{constructor(){this._entries=new Array}add(t,i){this._entries.push([t,i])}generateSource(){return this._entries.map(t=>`varying ${t[1]} ${t[0]};`)}}class oS{constructor(){this._entries=new Set}add(t){this._entries.add(t)}generateSource(t){const i=t==="vertex"?oS.ALLOWLIST_VERTEX:oS.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(r=>i.includes(r)).map(r=>`#extension ${r} : enable`)}}oS.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],oS.ALLOWLIST_VERTEX=[];class Gr{constructor(){this._entries=[]}add(t,i,r){let s="ERROR_CONSTRUCTOR_STRING";switch(i){case"float":s=Gr._numberToFloatStr(r);break;case"int":s=Gr._numberToIntStr(r);break;case"bool":s=r.toString();break;case"vec2":s=`vec2(${Gr._numberToFloatStr(r[0])},                            ${Gr._numberToFloatStr(r[1])})`;break;case"vec3":s=`vec3(${Gr._numberToFloatStr(r[0])},                            ${Gr._numberToFloatStr(r[1])},                            ${Gr._numberToFloatStr(r[2])})`;break;case"vec4":s=`vec4(${Gr._numberToFloatStr(r[0])},                            ${Gr._numberToFloatStr(r[1])},                            ${Gr._numberToFloatStr(r[2])},                            ${Gr._numberToFloatStr(r[3])})`;break;case"ivec2":s=`ivec2(${Gr._numberToIntStr(r[0])},                             ${Gr._numberToIntStr(r[1])})`;break;case"ivec3":s=`ivec3(${Gr._numberToIntStr(r[0])},                             ${Gr._numberToIntStr(r[1])},                             ${Gr._numberToIntStr(r[2])})`;break;case"ivec4":s=`ivec4(${Gr._numberToIntStr(r[0])},                             ${Gr._numberToIntStr(r[1])},                             ${Gr._numberToIntStr(r[2])},                             ${Gr._numberToIntStr(r[3])})`;break;case"mat2":case"mat3":case"mat4":s=`${i}(${Array.prototype.map.call(r,n=>Gr._numberToFloatStr(n)).join(", ")})`}return this._entries.push(`const ${i} ${t} = ${s};`),this}static _numberToIntStr(t){return t.toFixed(0)}static _numberToFloatStr(t){return Number.isInteger(t)?t.toFixed(1):t.toString()}generateSource(){return Array.from(this._entries)}}const qVe=`#ifdef GL_FRAGMENT_PRECISION_HIGH
  precision highp float;
  precision highp sampler2D;
#else
  precision mediump float;
  precision mediump sampler2D;
#endif`,WVe=`precision highp float;
precision highp sampler2D;`;function XVe(e){const t=new Oi;return t.attributes.add(E.POSITION,"vec2"),t.include(gm,{attributeTextureCoordinates:_n.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3"),t.vertex.uniforms.add("inverseProjectionMatrix","mat4"),t.vertex.uniforms.add("inverseViewMatrix","mat4"),t.vertex.code.add(x`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),t.fragment.uniforms.add("lightingMainDirection","vec3").add("radii","vec2").add("scaleHeight","float").add("cameraPosition","vec3").add("nearFar","vec2").add("heightParameters","vec4").add("innerFadeDistance","float").add("altitudeFade","float").add("depthTex","sampler2D").add("betaRayleigh","vec3").add("betaCombined","vec3").add("betaMie","float").add("hazeStrength","float"),t.include(BF),e.haze&&t.fragment.include(Os),t.fragment.code.add(x`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),t.fragment.code.add(x`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),t.fragment.code.add(x`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),t.fragment.code.add(x`
    const int STEPS = 6;

    float getGlow(float dist, float radius, float intensity) {
      return pow(radius / max(dist, 1e-6), intensity);
    }

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] - 20000.0;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${e.haze?x`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= ${e.haze?x``:" mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * "} exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${e.haze?"":x`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.05968310365 * mumu;

      ${e.haze?x`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:x`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.11936620731 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie += getGlow(1.0 - mu, 5e-5, 3.0) * smoothstep(0.01, 0.1, length(scattering));
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
      vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
      if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
        return fragColor;
      }

      float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
      vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
      float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
      if (relDist > 1.0) {
        return surfaceColor;
      }

      return mix(gl_FragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${e.haze?x`
          vec4 depthSample = texture2D(depthTex, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;
            cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);
            terrainDepth = max(0.0, length(cameraSpaceRay));
          }`:x`
          float depthSample = texture2D(depthTex, vuv0).r;
          if (depthSample != 1.0) {
            gl_FragColor = vec4(0);
            return;
          }`}

      ${e.haze?x`
            vec3 col = vec3(0);
            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
            if(depthSample != vec4(0)){
              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);
            }
            float alpha = 1.0 - fadeOut;`:x`
            vec3 col = getAtmosphereColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);;
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}
      col = tonemapACES(col);
      gl_FragColor = delinearizeGamma(vec4(col, alpha));
      ${e.haze?"":x`
          if (depthSample == 1.0) {
            gl_FragColor = applyUndergroundAtmosphere(rayDir, lightingMainDirection, gl_FragColor);
          }`}
    }
  `),t}const YVe=Object.freeze({__proto__:null,build:XVe});class Ni{constructor(t,i){this._module=t,this._loadModule=i}get(){return this._module}async reload(){return this._module=await this._loadModule(),this._module}}class Gi{constructor(t,i,r){this.release=r,i&&(this._config=i.snapshot()),this._program=this.initializeProgram(t),this._pipeline=this.initializePipeline(t)}destroy(){this._program=tt(this._program),this._pipeline=this._config=null}reload(t){tt(this._program),this._program=this.initializeProgram(t),this._pipeline=this.initializePipeline(t)}get program(){return this._program}get key(){return this._config.key}get configuration(){return this._config}bindPass(t,i){}bindMaterial(t,i){}bindDraw(t){}bindPipelineState(t,i=null,r){t.setPipelineState(this.getPipelineState(i,r))}ensureAttributeLocations(t){this.program.assertCompatibleVertexAttributeLocations(t)}get primitiveType(){return Tt.TRIANGLES}getPipelineState(t,i){return this._pipeline}}class mr{constructor(){this._key="",this._keyDirty=!1,this._parameterBits=this._parameterBits?this._parameterBits.map(()=>0):[],this._parameterNames||(this._parameterNames=[])}get key(){return this._keyDirty&&(this._keyDirty=!1,this._key=String.fromCharCode.apply(String,this._parameterBits)),this._key}snapshot(){const t=this._parameterNames,i={key:this.key};for(const r of t)i[r]=this[r];return i}}function Z(e={}){return(t,i)=>{var r,s;t._parameterNames=(r=t._parameterNames)!=null?r:[],t._parameterNames.push(i);const n=t._parameterNames.length-1,o=e.count||2,a=Math.ceil(Math.log2(o)),l=(s=t._parameterBits)!=null?s:[0];let c=0;for(;l[c]+a>16;)c++,c>=l.length&&l.push(0);t._parameterBits=l;const h=l[c],p=(1<<a)-1<<h;l[c]+=a,Object.defineProperty(t,i,{get(){return this[n]},set(f){if(this[n]!==f&&(this[n]=f,this._keyDirty=!0,this._parameterBits[c]=this._parameterBits[c]&~p|+f<<h&p,typeof f!="number"&&typeof f!="boolean"))throw"Configuration value for "+i+" must be boolean or number, got "+typeof f}})}}const mi=new Map([[E.POSITION,0],[E.NORMAL,1],[E.UV0,2],[E.COLOR,3],[E.SIZE,4],[E.TANGENT,4],[E.AUXPOS1,5],[E.SYMBOLCOLOR,5],[E.AUXPOS2,6],[E.FEATUREATTRIBUTE,6],[E.INSTANCEFEATUREATTRIBUTE,6],[E.INSTANCECOLOR,7],[E.MODEL,8],[E.MODELNORMAL,12],[E.MODELORIGINHI,11],[E.MODELORIGINLO,15]]),ZVe=he.getLogger("esri/views/webgl");function QVe(e,t){switch(t){case e.INVALID_ENUM:return"Invalid Enum. An unacceptable value has been specified for an enumerated argument.";case e.INVALID_VALUE:return"Invalid Value. A numeric argument is out of range.";case e.INVALID_OPERATION:return"Invalid Operation. The specified command is not allowed for the current state.";case e.INVALID_FRAMEBUFFER_OPERATION:return"Invalid Framebuffer operation. The currently bound framebuffer is not framebuffer complete when trying to render to or to read from it.";case e.OUT_OF_MEMORY:return"Out of memory. Not enough memory is left to execute the command.";case e.CONTEXT_LOST_WEBGL:return"WebGL context has been lost";default:return"Unknown error"}}const cge=!!ue("enable-feature:webgl-debug");function cu(){return cge}function aR(){return cge}function Zy(e){if(cu()){const t=e.getError();if(t){const i=QVe(e,t),r=new Error().stack;ZVe.error(new q("webgl-error","WebGL error occured",{message:i,stack:r}))}}}class Mi{constructor(t,i,r){this._context=t,this._locations=r,this._textures=new Map,this._freeTextureUnits=new $t({deallocator:null}),this._glProgram=t.programCache.acquire(i.generateSource("vertex"),i.generateSource("fragment"),r),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this._fragmentUniforms=cu()?i.fragmentUniforms.entries:null}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get isCompiled(){return this._glProgram.isCompiled}setUniform1b(t,i){this._glProgram.setUniform1i(t,i?1:0)}setUniform1i(t,i){this._glProgram.setUniform1i(t,i)}setUniform1f(t,i){this._glProgram.setUniform1f(t,i)}setUniform1fv(t,i){this._glProgram.setUniform1fv(t,i)}setUniform1iv(t,i){this._glProgram.setUniform1iv(t,i)}setUniform2f(t,i,r){this._glProgram.setUniform2f(t,i,r)}setUniform2fv(t,i){this._glProgram.setUniform2fv(t,i)}setUniform2iv(t,i){this._glProgram.setUniform2iv(t,i)}setUniform3f(t,i,r,s){this._glProgram.setUniform3f(t,i,r,s)}setUniform3fv(t,i){this._glProgram.setUniform3fv(t,i)}setUniform3iv(t,i){this._glProgram.setUniform3iv(t,i)}setUniform4f(t,i,r,s,n){this._glProgram.setUniform4f(t,i,r,s,n)}setUniform4fv(t,i){this._glProgram.setUniform4fv(t,i)}setUniform4iv(t,i){this._glProgram.setUniform4iv(t,i)}setUniformMatrix3fv(t,i){this._glProgram.setUniformMatrix3fv(t,i)}setUniformMatrix4fv(t,i){this._glProgram.setUniformMatrix4fv(t,i)}assertCompatibleVertexAttributeLocations(t){t.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(t,i){if(R(t)||t.glName==null){const s=this._textures.get(i);return s&&(this._context.bindTexture(null,s.unit),this._freeTextureUnit(s),this._textures.delete(i)),null}let r=this._textures.get(i);return r==null?(r=this._allocTextureUnit(t),this._textures.set(i,r)):r.texture=t,this._context.useProgram(this),this.setUniform1i(i,r.unit),this._context.bindTexture(t,r.unit),r.unit}rebindTextures(){this._context.useProgram(this),this._textures.forEach((t,i)=>{this._context.bindTexture(t.texture,t.unit),this.setUniform1i(i,t.unit)}),_(this._fragmentUniforms)&&this._fragmentUniforms.forEach(t=>{if((t.type==="sampler2D"||t.type==="samplerCube")&&!this._textures.has(t.name))throw new Error(`Texture sampler ${t.name} has no bound texture`)})}_allocTextureUnit(t){return{texture:t,unit:this._freeTextureUnits.length===0?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(t){this._freeTextureUnits.push(t.unit)}}var Di,F1,D_,lt,ns,ma,Ea,aS,Im,Aa,l0,lS,Ri,U1;(function(e){e[e.None=0]="None",e[e.Front=1]="Front",e[e.Back=2]="Back",e[e.COUNT=3]="COUNT"})(Di||(Di={})),function(e){e[e.Less=0]="Less",e[e.Lequal=1]="Lequal",e[e.COUNT=2]="COUNT"}(F1||(F1={})),function(e){e[e.NONE=0]="NONE",e[e.SMAA=1]="SMAA"}(D_||(D_={})),function(e){e[e.Color=0]="Color",e[e.Alpha=1]="Alpha",e[e.FrontFace=2]="FrontFace",e[e.NONE=3]="NONE",e[e.COUNT=4]="COUNT"}(lt||(lt={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.UPDATE=1]="UPDATE"}(ns||(ns={})),function(e){e[e.NOT_LOADED=0]="NOT_LOADED",e[e.LOADING=1]="LOADING",e[e.LOADED=2]="LOADED"}(ma||(ma={})),function(e){e[e.IntegratedMeshMaskExcluded=1]="IntegratedMeshMaskExcluded",e[e.OutlineVisualElementMask=2]="OutlineVisualElementMask"}(Ea||(Ea={})),function(e){e[e.ASYNC=0]="ASYNC",e[e.SYNC=1]="SYNC"}(aS||(aS={})),function(e){e[e.Highlight=0]="Highlight",e[e.MaskOccludee=1]="MaskOccludee",e[e.COUNT=2]="COUNT"}(Im||(Im={})),function(e){e[e.Triangle=0]="Triangle",e[e.Point=1]="Point",e[e.Line=2]="Line"}(Aa||(Aa={})),function(e){e[e.STRETCH=1]="STRETCH",e[e.PAD=2]="PAD"}(l0||(l0={})),function(e){e[e.CHANGED=0]="CHANGED",e[e.UNCHANGED=1]="UNCHANGED"}(lS||(lS={})),function(e){e[e.Blend=0]="Blend",e[e.Opaque=1]="Opaque",e[e.Mask=2]="Mask",e[e.MaskBlend=3]="MaskBlend",e[e.COUNT=4]="COUNT"}(Ri||(Ri={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(U1||(U1={}));function Sc(e,t,i=Cp.ADD,r=[0,0,0,0]){return{srcRgb:e,srcAlpha:e,dstRgb:t,dstAlpha:t,opRgb:i,opAlpha:i,color:{r:r[0],g:r[1],b:r[2],a:r[3]}}}function Xn(e,t,i,r,s=Cp.ADD,n=Cp.ADD,o=[0,0,0,0]){return{srcRgb:e,srcAlpha:t,dstRgb:i,dstAlpha:r,opRgb:s,opAlpha:n,color:{r:o[0],g:o[1],b:o[2],a:o[3]}}}const dq={face:ba.BACK,mode:XT.CCW},uge={face:ba.FRONT,mode:XT.CCW},VF=e=>e===Di.Back?dq:e===Di.Front?uge:null,Ma={zNear:0,zFar:1},Ft={r:!0,g:!0,b:!0,a:!0};function JVe(e){return o8e.intern(e)}function KVe(e){return a8e.intern(e)}function e8e(e){return l8e.intern(e)}function t8e(e){return c8e.intern(e)}function i8e(e){return u8e.intern(e)}function r8e(e){return h8e.intern(e)}function s8e(e){return d8e.intern(e)}function n8e(e){return p8e.intern(e)}function Ot(e){return f8e.intern(e)}class jm{constructor(t,i){this.makeKey=t,this.makeRef=i,this.interns=new Map}intern(t){if(!t)return null;const i=this.makeKey(t),r=this.interns;return r.has(i)||r.set(i,this.makeRef(t)),r.get(i)}}function Hm(e){return"["+e.join(",")+"]"}const o8e=new jm(hge,e=>I({__tag:"Blending"},e));function hge(e){return e?Hm([e.srcRgb,e.srcAlpha,e.dstRgb,e.dstAlpha,e.opRgb,e.opAlpha,e.color.r,e.color.g,e.color.b,e.color.a]):null}const a8e=new jm(dge,e=>I({__tag:"Culling"},e));function dge(e){return e?Hm([e.face,e.mode]):null}const l8e=new jm(pge,e=>I({__tag:"PolygonOffset"},e));function pge(e){return e?Hm([e.factor,e.units]):null}const c8e=new jm(fge,e=>I({__tag:"DepthTest"},e));function fge(e){return e?Hm([e.func]):null}const u8e=new jm(mge,e=>I({__tag:"StencilTest"},e));function mge(e){return e?Hm([e.function.func,e.function.ref,e.function.mask,e.operation.fail,e.operation.zFail,e.operation.zPass]):null}const h8e=new jm(gge,e=>I({__tag:"DepthWrite"},e));function gge(e){return e?Hm([e.zNear,e.zFar]):null}const d8e=new jm(yge,e=>I({__tag:"ColorWrite"},e));function yge(e){return e?Hm([e.r,e.g,e.b,e.a]):null}const p8e=new jm(vge,e=>I({__tag:"StencilWrite"},e));function vge(e){return e?Hm([e.mask]):null}const f8e=new jm(m8e,e=>({blending:JVe(e.blending),culling:KVe(e.culling),polygonOffset:e8e(e.polygonOffset),depthTest:t8e(e.depthTest),stencilTest:i8e(e.stencilTest),depthWrite:r8e(e.depthWrite),colorWrite:s8e(e.colorWrite),stencilWrite:n8e(e.stencilWrite)}));function m8e(e){return e?Hm([hge(e.blending),dge(e.culling),pge(e.polygonOffset),fge(e.depthTest),mge(e.stencilTest),gge(e.depthWrite),yge(e.colorWrite),vge(e.stencilWrite)]):null}class g8e{constructor(t){this._pipelineInvalid=!0,this._blendingInvalid=!0,this._cullingInvalid=!0,this._polygonOffsetInvalid=!0,this._depthTestInvalid=!0,this._stencilTestInvalid=!0,this._depthWriteInvalid=!0,this._colorWriteInvalid=!0,this._stencilWriteInvalid=!0,this._stateSetters=t}setPipeline(t){(this._pipelineInvalid||t!==this._pipeline)&&(this._setBlending(t.blending),this._setCulling(t.culling),this._setPolygonOffset(t.polygonOffset),this._setDepthTest(t.depthTest),this._setStencilTest(t.stencilTest),this._setDepthWrite(t.depthWrite),this._setColorWrite(t.colorWrite),this._setStencilWrite(t.stencilWrite),this._pipeline=t),this._pipelineInvalid=!1}invalidateBlending(){this._blendingInvalid=!0,this._pipelineInvalid=!0}invalidateCulling(){this._cullingInvalid=!0,this._pipelineInvalid=!0}invalidatePolygonOffset(){this._polygonOffsetInvalid=!0,this._pipelineInvalid=!0}invalidateDepthTest(){this._depthTestInvalid=!0,this._pipelineInvalid=!0}invalidateStencilTest(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDepthWrite(){this._depthWriteInvalid=!0,this._pipelineInvalid=!0}invalidateColorWrite(){this._colorWriteInvalid=!0,this._pipelineInvalid=!0}invalidateStencilWrite(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}_setBlending(t){this._blending=this._setSubState(t,this._blending,this._blendingInvalid,this._stateSetters.setBlending),this._blendingInvalid=!1}_setCulling(t){this._culling=this._setSubState(t,this._culling,this._cullingInvalid,this._stateSetters.setCulling),this._cullingInvalid=!1}_setPolygonOffset(t){this._polygonOffset=this._setSubState(t,this._polygonOffset,this._polygonOffsetInvalid,this._stateSetters.setPolygonOffset),this._polygonOffsetInvalid=!1}_setDepthTest(t){this._depthTest=this._setSubState(t,this._depthTest,this._depthTestInvalid,this._stateSetters.setDepthTest),this._depthTestInvalid=!1}_setStencilTest(t){this._stencilTest=this._setSubState(t,this._stencilTest,this._stencilTestInvalid,this._stateSetters.setStencilTest),this._stencilTestInvalid=!1}_setDepthWrite(t){this._depthWrite=this._setSubState(t,this._depthWrite,this._depthWriteInvalid,this._stateSetters.setDepthWrite),this._depthWriteInvalid=!1}_setColorWrite(t){this._colorWrite=this._setSubState(t,this._colorWrite,this._colorWriteInvalid,this._stateSetters.setColorWrite),this._colorWriteInvalid=!1}_setStencilWrite(t){this._stencilWrite=this._setSubState(t,this._stencilWrite,this._stencilWriteInvalid,this._stateSetters.setStencilWrite),this._stencilTestInvalid=!1}_setSubState(t,i,r,s){return(r||t!==i)&&(s(t),this._pipelineInvalid=!0),t}}class lR extends Gi{initializeProgram(t){const i=lR.shader.get(),r=this.configuration,s=i.build({haze:r.haze});return new Mi(t.rctx,s,mi)}initializePipeline(){return this.configuration.haze?Ot({blending:Xn(Ee.ONE,Ee.ZERO,Ee.ONE_MINUS_SRC_COLOR,Ee.ONE),colorWrite:Ft}):Ot({blending:Xn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:Li.LEQUAL},colorWrite:Ft})}}lR.shader=new Ni(YVe,()=>import("./ChapmanAtmosphere.glsl.0f242179.js"));class _ge extends mr{constructor(){super(...arguments),this.haze=!1}}u([Z()],_ge.prototype,"haze",void 0);class bn{constructor(t,i,r,s,n,o=!1,a=0){this.name=t,this.count=i,this.type=r,this.offset=s,this.stride=n,this.normalized=o,this.divisor=a}}new bn(E.POSITION,3,ot.FLOAT,0,12);new bn(E.POSITION,3,ot.FLOAT,0,20),new bn(E.UV0,2,ot.FLOAT,12,20);new bn(E.POSITION,3,ot.FLOAT,0,32),new bn(E.NORMAL,3,ot.FLOAT,12,32),new bn(E.UV0,2,ot.FLOAT,24,32);new bn(E.POSITION,3,ot.FLOAT,0,16),new bn(E.COLOR,4,ot.UNSIGNED_BYTE,12,16);const pq=[new bn(E.POSITION,2,ot.FLOAT,0,8)],RO=[new bn(E.POSITION,2,ot.FLOAT,0,16),new bn(E.UV0,2,ot.FLOAT,8,16)],Ml=he.getLogger("esri.views.webgl.BufferObject");function y8e(e){return jxe(e)}class jt{constructor(t,i,r,s){this._context=t,this.bufferType=i,this.usage=r,this._glName=null,this._size=-1,this._indexType=void 0,t.instanceCounter.increment(ks.Buffer,this),this._glName=this._context.gl.createBuffer(),Zy(this._context.gl),s&&this.setData(s)}static createIndex(t,i,r){return new jt(t,ft.ELEMENT_ARRAY_BUFFER,i,r)}static createVertex(t,i,r){return new jt(t,ft.ARRAY_BUFFER,i,r)}static createUniform(t,i,r){if(t.type!==Kt.WEBGL2)throw new Error("Uniform buffers are supported in WebGL2 only!");return new jt(t,ft.UNIFORM_BUFFER,i,r)}static createPixelPack(t,i=ri.STREAM_READ,r){if(t.type!==Kt.WEBGL2)throw new Error("Pixel pack buffers are supported in WebGL2 only!");const s=new jt(t,ft.PIXEL_PACK_BUFFER,i);return r&&s.setSize(r),s}static createPixelUnpack(t,i=ri.STREAM_DRAW,r){if(t.type!==Kt.WEBGL2)throw new Error("Pixel unpack buffers are supported in WebGL2 only!");return new jt(t,ft.PIXEL_UNPACK_BUFFER,i,r)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get byteSize(){return this.bufferType===ft.ELEMENT_ARRAY_BUFFER?this._indexType===ot.UNSIGNED_INT?4*this._size:2*this._size:this._size}get _isVAOAware(){return this.bufferType===ft.ELEMENT_ARRAY_BUFFER||this.bufferType===ft.ARRAY_BUFFER}dispose(){var t;(t=this._context)!=null&&t.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(ks.Buffer,this),this._context=null):this._glName&&Ml.warn("Leaked WebGL buffer object")}setSize(t,i=null){if(t<=0&&Ml.error("Buffer size needs to be positive!"),this.bufferType===ft.ELEMENT_ARRAY_BUFFER&&_(i))switch(this._indexType=i,i){case ot.UNSIGNED_SHORT:t*=2;break;case ot.UNSIGNED_INT:t*=4}this._setBufferData(t)}setData(t){if(!t)return;let i=t.byteLength;this.bufferType===ft.ELEMENT_ARRAY_BUFFER&&(rD(t)&&(i/=2,this._indexType=ot.UNSIGNED_SHORT),sD(t)&&(i/=4,this._indexType=ot.UNSIGNED_INT)),this._setBufferData(i,t)}_setBufferData(t,i=null){this._size=t;const r=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const s=this._context.gl;_(i)?s.bufferData(this.bufferType,i,this.usage):s.bufferData(this.bufferType,t,this.usage),Zy(s),this._isVAOAware&&this._context.bindVAO(r)}setSubData(t,i=0,r=0,s=t.byteLength){if(!t)return;(i<0||i>=this._size)&&Ml.error("offset is out of range!");let n=i,o=r,a=s,l=t.byteLength;this.bufferType===ft.ELEMENT_ARRAY_BUFFER&&(rD(t)?(l/=2,n*=2,o*=2,a*=2):sD(t)&&(l/=4,n*=4,o*=4,a*=4)),s===void 0&&(s=l-1),r>=s&&Ml.error("end must be bigger than start!"),i+r-s>this._size&&Ml.error("An attempt to write beyond the end of the buffer!");const c=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const h=this._context.gl,p=ArrayBuffer.isView(t)?t.buffer:t,f=o===0&&a===t.byteLength?p:p.slice(o,a);h.bufferSubData(this.bufferType,n,f),Zy(h),this._isVAOAware&&this._context.bindVAO(c)}setSubDataFromView(t,i,r,s){if(!t)return;(i<0||i>=this._size)&&Ml.error("offset is out of range!"),r>=s&&Ml.error("end must be bigger than start!"),i+r-s>this._size&&Ml.error("An attempt to write beyond the end of the buffer!");const n=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const o=this._context.gl;if(this._context.type===Kt.WEBGL2)o.bufferSubData(this.bufferType,i*t.BYTES_PER_ELEMENT,t,r,s-r);else{const a=r===0&&s===t.length?t:t.subarray(r,s);o.bufferSubData(this.bufferType,i*t.BYTES_PER_ELEMENT,a)}Zy(o),this._isVAOAware&&this._context.bindVAO(n)}getSubData(t,i=0,r,s){if(this._context.type!==Kt.WEBGL2)return void Ml.error("Get buffer subdata is supported in WebGL2 only!");if(r<0||s<0)return void Ml.error("Problem getting subdata: offset and length were less than zero!");const n=y8e(t)?t.BYTES_PER_ELEMENT:1;if(n*((r!=null?r:0)+(s!=null?s:0))>t.byteLength)return void Ml.error("Problem getting subdata: offset and length exceeded destination size!");i+n*(s!=null?s:0)>this.byteSize&&Ml.warn("Potential problem getting subdata: requested data exceeds buffer size!");const o=this._context.gl;this._context.bindBuffer(this,ft.COPY_READ_BUFFER),o.getBufferSubData(ft.COPY_READ_BUFFER,i,t,r,s),this._context.unbindBuffer(ft.COPY_READ_BUFFER)}async getSubDataAsync(t,i=0,r,s){this._context.type===Kt.WEBGL2?(await this._context.clientWaitAsync(),this.getSubData(t,i,r,s)):Ml.error("Get buffer subdata is supported in WebGL2 only!")}}function Zs(e){return window.WebGL2RenderingContext&&e instanceof window.WebGL2RenderingContext}const oee=4;class Qe{constructor(t,i,r=null){if(this._context=t,this.type="texture",this._glName=null,this._descriptor=void 0,this._samplingModeDirty=!1,this._wrapModeDirty=!1,this._wasImmutablyAllocated=!1,t.instanceCounter.increment(ks.Texture,this),this._descriptor=I({target:st.TEXTURE_2D,samplingMode:Ge.LINEAR,wrapMode:ct.REPEAT,flipped:!1,hasMipmap:!1,isOpaque:!1,unpackAlignment:4,preMultiplyAlpha:!1,isImmutable:!1},i),t.type!==Kt.WEBGL2&&(this._descriptor.isImmutable&&(this._descriptor.isImmutable=!1),K0(this._descriptor.target)))throw new Error("3D and array textures are not supported in WebGL1");this._descriptor.target===st.TEXTURE_CUBE_MAP?this._setDataCubeMap(r):this.setData(r)}get glName(){return this._glName}get descriptor(){return this._descriptor}get isDirty(){return this._samplingModeDirty||this._wrapModeDirty}dispose(){this._context.gl&&this._glName&&(this._context.unbindTextureAllUnits(this),this._context.gl.deleteTexture(this._glName),this._glName=null,this._context.instanceCounter.decrement(ks.Texture,this))}release(){this.dispose()}resize(t,i){const r=this._descriptor;if(r.width!==t||r.height!==i){if(this._wasImmutablyAllocated)throw new Error("Immutable textures can't be resized!");r.width=t,r.height=i,this._descriptor.target===st.TEXTURE_CUBE_MAP?this._setDataCubeMap(null):this.setData(null)}}_setDataCubeMap(t=null){for(let i=st.TEXTURE_CUBE_MAP_POSITIVE_X;i<=st.TEXTURE_CUBE_MAP_NEGATIVE_Z;i++)this._setData(t,i)}setData(t){this._setData(t)}_setData(t,i){if(!this._context||!this._context.gl)return;const r=this._context.gl;this._glName||(this._glName=r.createTexture()),t===void 0&&(t=null);const s=this._descriptor;i!=null||(i=s.target);const n=K0(i);var o;t===null&&(s.width=s.width||oee,s.height=s.height||oee,n&&(s.depth=(o=s.depth)!=null?o:1));const a=this._context.bindTexture(this,Qe.TEXTURE_UNIT_FOR_UPDATES);this._context.setActiveTexture(Qe.TEXTURE_UNIT_FOR_UPDATES),Qe._validateTexture(this._context,s),this._configurePixelStorage();const l=s.pixelFormat;let c=s.internalFormat?s.internalFormat:this._deriveInternalFormat(l,s.dataType);if(GU(t)){let h=t.width,p=t.height;const f=1;t instanceof HTMLVideoElement&&(h=t.videoWidth,p=t.videoHeight),s.width&&s.height,n&&s.depth,s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(i,c,s.hasMipmap,h,p,f),this._texImage(i,0,c,h,p,f,t),Zy(r),s.hasMipmap&&this.generateMipmap(),s.width===void 0&&(s.width=h),s.height===void 0&&(s.height=p),n&&s.depth===void 0&&(s.depth=f)}else{const{width:h,height:p,depth:f}=s;if(h!=null&&p!=null||console.error("Width and height must be specified!"),n&&f==null&&console.error("Depth must be specified!"),s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(i,c,s.hasMipmap,h,p,f),r.DEPTH24_STENCIL8&&c===r.DEPTH_STENCIL&&(c=r.DEPTH24_STENCIL8),d$(t)){const g=t.levels,y=aee(i,h,p,f),v=Math.min(y-1,g.length-1);Zs(r)?r.texParameteri(s.target,r.TEXTURE_MAX_LEVEL,v):s.hasMipmap=s.hasMipmap&&y===g.length;const b=c;if(!_8e(b))throw new Error("Attempting to use compressed data with an umcompressed format!");this._forEachMipmapLevel((w,S,T,A)=>{const C=g[Math.min(w,g.length-1)];this._compressedTexImage(i,w,b,S,T,A,C)},v)}else _(t)?(this._texImage(i,0,c,h,p,f,t),Zy(r),s.hasMipmap&&this.generateMipmap()):this._forEachMipmapLevel((g,y,v,b)=>{this._texImage(i,g,c,y,v,b,null),Zy(r)})}Qe._applySamplingMode(r,this._descriptor),Qe._applyWrapMode(r,this._descriptor),Qe._applyAnisotropicFilteringParameters(this._context,this._descriptor),Zy(r),this._context.bindTexture(a,Qe.TEXTURE_UNIT_FOR_UPDATES)}updateData(t,i,r,s,n,o){o||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const a=this._context.gl,l=this._descriptor,{pixelFormat:c,internalFormat:h,dataType:p,isImmutable:f,target:g}=l;if(f&&!this._wasImmutablyAllocated)throw new Error("Cannot update immutable texture before allocation!");const y=this._context.bindTexture(this,Qe.TEXTURE_UNIT_FOR_UPDATES);(i<0||r<0||s>l.width||n>l.height||i+s>l.width||r+n>l.height)&&console.error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage(),GU(o)?a.texSubImage2D(g,t,i,r,c,p,o):d$(o)?a.compressedTexSubImage2D(g,t,i,r,s,n,h,o.levels[t]):a.texSubImage2D(g,t,i,r,s,n,c,p,o),this._context.bindTexture(y,Qe.TEXTURE_UNIT_FOR_UPDATES)}updateData3D(t,i,r,s,n,o,a,l){l||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const c=this._context.gl;if(!Zs(c))throw new Error("3D textures are not supported in WebGL1");const h=this._descriptor,{pixelFormat:p,dataType:f,isImmutable:g,target:y,internalFormat:v}=h;if(g&&!this._wasImmutablyAllocated)throw new Error("Cannot update immutable texture before allocation!");K0(y)||console.warn("Attempting to set 3D texture data on a non-3D texture");const b=this._context.bindTexture(this,Qe.TEXTURE_UNIT_FOR_UPDATES);if(this._context.setActiveTexture(Qe.TEXTURE_UNIT_FOR_UPDATES),(i<0||r<0||s<0||n>h.width||o>h.height||a>h.depth||i+n>h.width||r+o>h.height||s+a>h.depth)&&console.error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage(),d$(l))l=l.levels[t],c.compressedTexSubImage3D(y,t,i,r,s,n,o,a,v,l);else{const w=l;c.texSubImage3D(y,t,i,r,s,n,o,a,p,f,w)}this._context.bindTexture(b,Qe.TEXTURE_UNIT_FOR_UPDATES)}generateMipmap(){const t=this._descriptor;if(!t.hasMipmap){if(this._wasImmutablyAllocated)throw new Error("Cannot add mipmaps to immutable texture after allocation");t.hasMipmap=!0,this._samplingModeDirty=!0,Qe._validateTexture(this._context,t)}t.samplingMode===Ge.LINEAR?(this._samplingModeDirty=!0,t.samplingMode=Ge.LINEAR_MIPMAP_NEAREST):t.samplingMode===Ge.NEAREST&&(this._samplingModeDirty=!0,t.samplingMode=Ge.NEAREST_MIPMAP_NEAREST);const i=this._context.bindTexture(this,Qe.TEXTURE_UNIT_FOR_UPDATES);this._context.setActiveTexture(Qe.TEXTURE_UNIT_FOR_UPDATES),this._context.gl.generateMipmap(t.target),this._context.bindTexture(i,Qe.TEXTURE_UNIT_FOR_UPDATES)}setSamplingMode(t){t!==this._descriptor.samplingMode&&(this._descriptor.samplingMode=t,this._samplingModeDirty=!0)}setWrapMode(t){t!==this._descriptor.wrapMode&&(this._descriptor.wrapMode=t,Qe._validateTexture(this._context,this._descriptor),this._wrapModeDirty=!0)}applyChanges(){const t=this._context.gl,i=this._descriptor;this._samplingModeDirty&&(Qe._applySamplingMode(t,i),this._samplingModeDirty=!1),this._wrapModeDirty&&(Qe._applyWrapMode(t,i),this._wrapModeDirty=!1)}_deriveInternalFormat(t,i){if(this._context.type===Kt.WEBGL1)return t;switch(i){case yt.FLOAT:switch(t){case $e.RGBA:return nt.RGBA32F;case $e.RGB:return nt.RGB32F;default:throw new Error("Unable to derive format")}case yt.UNSIGNED_BYTE:switch(t){case $e.RGBA:return nt.RGBA8;case $e.RGB:return nt.RGB8}default:return t}}_configurePixelStorage(){const t=this._context.gl,{unpackAlignment:i,flipped:r,preMultiplyAlpha:s}=this._descriptor;t.pixelStorei(t.UNPACK_ALIGNMENT,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,r?1:0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s?1:0)}_texStorage(t,i,r,s,n,o){const a=this._context.gl;if(!Zs(a))throw new Error("Immutable textures are not supported in WebGL1");if(!v8e(i))throw new Error("Immutable textures must have a sized internal format");if(!this._descriptor.isImmutable)return;const l=r?aee(t,s,n,o):1;K0(t)?a.texStorage3D(t,l,i,s,n,o):a.texStorage2D(t,l,i,s,n),this._wasImmutablyAllocated=!0}_texImage(t,i,r,s,n,o,a){const l=this._context.gl;let c=null;const h=this._context.type===Kt.WEBGL2,p=K0(t),{isImmutable:f,pixelFormat:g,dataType:y}=this._descriptor;if(h&&(c=l),h||!GU(a))if(f){if(_(a)){const v=a;p?c.texSubImage3D(t,i,0,0,0,s,n,o,g,y,v):l.texSubImage2D(t,i,0,0,s,n,g,y,v)}}else{const v=a;p?c.texImage3D(t,i,r,s,n,o,0,g,y,v):l.texImage2D(t,i,r,s,n,0,g,y,v)}else l.texImage2D(t,0,r,g,y,a)}_compressedTexImage(t,i,r,s,n,o,a){const l=this._context.gl;let c=null;const h=K0(t),p=this._descriptor.isImmutable;if(h){if(this._context.type!==Kt.WEBGL2)throw new Error("3D textures are not supported in WebGL1");c=l}p?_(a)&&(h?c.compressedTexSubImage3D(t,i,0,0,0,s,n,o,r,a):l.compressedTexSubImage2D(t,i,0,0,s,n,r,a)):h?c.compressedTexImage3D(t,i,r,s,n,o,0,a):l.compressedTexImage2D(t,i,r,s,n,0,a)}_forEachMipmapLevel(t,i=1/0){let{width:r,height:s,depth:n,hasMipmap:o,target:a}=this._descriptor;const l=a===st.TEXTURE_3D;for(let c=0;t(c,r,s,n),o&&(r!==1||s!==1||l&&n!==1)&&!(c>=i);++c)r=Math.max(1,r>>1),s=Math.max(1,s>>1),l&&(n=Math.max(1,n>>1))}static _validateTexture(t,i){(i.width<0||i.height<0||i.depth<0)&&console.error("Negative dimension parameters are not allowed!");const r=Zs(t.gl),s=xT(i.width)&&xT(i.height);r||!i.isImmutable&&!K0(i.target)||console.error("Immutable and 3D-like textures are not supported in WebGL1!"),r||s||(typeof i.wrapMode=="number"?i.wrapMode!==ct.CLAMP_TO_EDGE&&console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"):i.wrapMode.s===ct.CLAMP_TO_EDGE&&i.wrapMode.t===ct.CLAMP_TO_EDGE||console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"),i.hasMipmap&&console.error("Mipmapping requires power-of-two textures!"))}static _applySamplingMode(t,i){let r=i.samplingMode,s=i.samplingMode;r===Ge.LINEAR_MIPMAP_NEAREST||r===Ge.LINEAR_MIPMAP_LINEAR?(r=Ge.LINEAR,i.hasMipmap||(s=Ge.LINEAR)):r!==Ge.NEAREST_MIPMAP_NEAREST&&r!==Ge.NEAREST_MIPMAP_LINEAR||(r=Ge.NEAREST,i.hasMipmap||(s=Ge.NEAREST)),t.texParameteri(i.target,t.TEXTURE_MAG_FILTER,r),t.texParameteri(i.target,t.TEXTURE_MIN_FILTER,s)}static _applyWrapMode(t,i){typeof i.wrapMode=="number"?(t.texParameteri(i.target,t.TEXTURE_WRAP_S,i.wrapMode),t.texParameteri(i.target,t.TEXTURE_WRAP_T,i.wrapMode)):(t.texParameteri(i.target,t.TEXTURE_WRAP_S,i.wrapMode.s),t.texParameteri(i.target,t.TEXTURE_WRAP_T,i.wrapMode.t))}static _applyAnisotropicFilteringParameters(t,i){var r;const s=t.capabilities.textureFilterAnisotropic;!s||t.gl.texParameterf(i.target,s.TEXTURE_MAX_ANISOTROPY,(r=i.maxAnisotropy)!=null?r:1)}}function v8e(e){return e in nt}function _8e(e){return e in Ar}function d$(e){return _(e)&&"type"in e&&e.type==="compressed"}function b8e(e){return _(e)&&"byteLength"in e}function GU(e){return _(e)&&!d$(e)&&!b8e(e)}function K0(e){return e===st.TEXTURE_3D||e===st.TEXTURE_2D_ARRAY}function aee(e,t,i,r=1){let s=Math.max(t,i);return e===st.TEXTURE_3D&&(s=Math.max(s,r)),Math.round(Math.log(s)/Math.LN2)+1}Qe.TEXTURE_UNIT_FOR_UPDATES=0;function lee(e){const t=e.gl;switch(t.getError()){case t.NO_ERROR:return null;case t.INVALID_ENUM:return"An unacceptable value has been specified for an enumerated argument";case t.INVALID_VALUE:return"A numeric argument is out of range";case t.INVALID_OPERATION:return"The specified command is not allowed for the current state";case t.INVALID_FRAMEBUFFER_OPERATION:return"The currently bound framebuffer is not framebuffer complete";case t.OUT_OF_MEMORY:return"Not enough memory is left to execute the command";case t.CONTEXT_LOST_WEBGL:return"WebGL context is lost"}return"Unknown error"}function vn(e,t){return e.vertexBuffers[t].size/w8e(e.layout[t])}function w8e(e){return e[0].stride}function fq(e,t,i,r,s=0){const n=e.gl,o=e.capabilities.instancing;e.bindBuffer(i);for(const a of r){const l=t.get(a.name);l===void 0&&console.error(`There is no location for vertex attribute '${a.name}' defined.`);const c=s*a.stride;if(a.count<=4)n.vertexAttribPointer(l,a.count,a.type,a.normalized,a.stride,a.offset+c),n.enableVertexAttribArray(l),a.divisor>0&&o&&o.vertexAttribDivisor(l,a.divisor);else if(a.count===9)for(let h=0;h<3;h++)n.vertexAttribPointer(l+h,3,a.type,a.normalized,a.stride,a.offset+12*h+c),n.enableVertexAttribArray(l+h),a.divisor>0&&o&&o.vertexAttribDivisor(l+h,a.divisor);else if(a.count===16)for(let h=0;h<4;h++)n.vertexAttribPointer(l+h,4,a.type,a.normalized,a.stride,a.offset+16*h+c),n.enableVertexAttribArray(l+h),a.divisor>0&&o&&o.vertexAttribDivisor(l+h,a.divisor);else console.error("Unsupported vertex attribute element count: "+a.count)}}function mq(e,t,i,r){const s=e.gl,n=e.capabilities.instancing;e.bindBuffer(i);for(const o of r){const a=t.get(o.name);if(o.count<=4)s.disableVertexAttribArray(a),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a,0);else if(o.count===9)for(let l=0;l<3;l++)s.disableVertexAttribArray(a+l),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a+l,0);else if(o.count===16)for(let l=0;l<4;l++)s.disableVertexAttribArray(a+l),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a+l,0);else console.error("Unsupported vertex attribute element count: "+o.count)}e.unbindBuffer(ft.ARRAY_BUFFER)}function bge(e){switch(e){case $e.ALPHA:case $e.LUMINANCE:case $e.RED:case $e.RED_INTEGER:case nt.R8:case nt.R8I:case nt.R8UI:case nt.R8_SNORM:case Bo.STENCIL_INDEX8:return 1;case $e.LUMINANCE_ALPHA:case $e.RG:case $e.RG_INTEGER:case nt.RGBA4:case nt.R16F:case nt.R16I:case nt.R16UI:case nt.RG8:case nt.RG8I:case nt.RG8UI:case nt.RG8_SNORM:case nt.RGB565:case nt.RGB5_A1:case Bo.DEPTH_COMPONENT16:return 2;case $e.DEPTH_COMPONENT:case $e.RGB:case $e.RGB_INTEGER:case nt.RGB8:case nt.RGB8I:case nt.RGB8UI:case nt.RGB8_SNORM:case nt.SRGB8:case Bo.DEPTH_COMPONENT24:return 3;case $e.DEPTH_STENCIL:case $e.RGBA:case $e.RGBA_INTEGER:case nt.RGBA8:case nt.R32F:case nt.R11F_G11F_B10F:case nt.RG16F:case nt.R32I:case nt.R32UI:case nt.RG16I:case nt.RG16UI:case nt.RGBA8I:case nt.RGBA8UI:case nt.RGBA8_SNORM:case nt.SRGB8_ALPHA8:case nt.RGB9_E5:case nt.RGB10_A2UI:case nt.RGB10_A2:case Bo.DEPTH_STENCIL:case Bo.DEPTH_COMPONENT32F:case Bo.DEPTH24_STENCIL8:return 4;case Bo.DEPTH32F_STENCIL8:return 5;case nt.RGB16F:case nt.RGB16I:case nt.RGB16UI:return 6;case nt.RG32F:case nt.RG32I:case nt.RG32UI:case nt.RGBA16F:case nt.RGBA16I:case nt.RGBA16UI:return 8;case nt.RGB32F:case nt.RGB32I:case nt.RGB32UI:return 12;case nt.RGBA32F:case nt.RGBA32I:case nt.RGBA32UI:return 16;case Ar.COMPRESSED_RGB_S3TC_DXT1_EXT:case Ar.COMPRESSED_RGBA_S3TC_DXT1_EXT:return .5;case Ar.COMPRESSED_RGBA_S3TC_DXT3_EXT:case Ar.COMPRESSED_RGBA_S3TC_DXT5_EXT:return 1;case Ar.COMPRESSED_R11_EAC:case Ar.COMPRESSED_SIGNED_R11_EAC:case Ar.COMPRESSED_RGB8_ETC2:case Ar.COMPRESSED_SRGB8_ETC2:case Ar.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:case Ar.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:return .5;case Ar.COMPRESSED_RG11_EAC:case Ar.COMPRESSED_SIGNED_RG11_EAC:case Ar.COMPRESSED_RGBA8_ETC2_EAC:case Ar.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:return 1}return 0}function c0(e){if(R(e))return 0;if("descriptor"in e)return e.glName?c0(e.descriptor):0;const t=e.internalFormat||"pixelFormat"in e&&e.pixelFormat;if(!t)return 0;const i="hasMipmap"in e&&e.hasMipmap?1.3:1,r=e.width*e.height;return bge(t)*r*i}const ev=he.getLogger("esri.views.webgl.VertexArrayObject");class us{constructor(t,i,r,s,n=null){this._context=t,this._locations=i,this._layout=r,this._buffers=s,this._indexBuffer=n,this._glName=null,this._initialized=!1,t.instanceCounter.increment(ks.VAO,this)}get glName(){return this._glName}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get size(){return Object.keys(this._buffers).reduce((t,i)=>t+this._buffers[i].size,_(this._indexBuffer)?this._indexBuffer.size:0)}get layout(){return this._layout}get locations(){return this._locations}dispose(t=!0){if(!this._context)return void((this._glName||t&&Object.getOwnPropertyNames(this._buffers).length>0)&&ev.warn("Leaked WebGL VAO"));if(this._glName){var i,r;const s=(i=this._context)==null||(r=i.capabilities)==null?void 0:r.vao;s?(s.deleteVertexArray(this._glName),this._glName=null):ev.warn("Leaked WebGL VAO")}if(this._context.getBoundVAO()===this&&this._context.bindVAO(null),t){for(const s in this._buffers)this._buffers[s].dispose(),delete this._buffers[s];this._indexBuffer=tt(this._indexBuffer)}this._context.instanceCounter.decrement(ks.VAO,this),this._context=null}initialize(){if(this._initialized)return;const t=this._context.capabilities.vao;if(t){const i=t.createVertexArray();t.bindVertexArray(i),this._bindLayout(),t.bindVertexArray(null),this._glName=i}this._initialized=!0}bind(){this.initialize();const t=this._context.capabilities.vao;t?t.bindVertexArray(this.glName):(this._context.bindVAO(null),this._bindLayout())}_bindLayout(){const{_buffers:t,_layout:i,_indexBuffer:r}=this;t||ev.error("Vertex buffer dictionary is empty!");const s=this._context.gl;for(const n in t){const o=t[n];o||ev.error("Vertex buffer is uninitialized!");const a=i[n];a||ev.error("Vertex element descriptor is empty!"),fq(this._context,this._locations,o,a)}_(r)&&(this._context.capabilities.vao?s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,r.glName):this._context.bindBuffer(r))}unbind(){this.initialize();const t=this._context.capabilities.vao;t?t.bindVertexArray(null):this._unbindLayout()}_unbindLayout(){const{_buffers:t,_layout:i}=this;t||ev.error("Vertex buffer dictionary is empty!");for(const r in t){const s=t[r];s||ev.error("Vertex buffer is uninitialized!");const n=i[r];mq(this._context,this._locations,s,n)}_(this._indexBuffer)&&this._context.unbindBuffer(this._indexBuffer.bufferType)}}function bo(e,t=pq,i=mi,r=-1,s=1){let n=null;return t===RO?n=new Float32Array([r,r,0,0,s,r,1,0,r,s,0,1,s,s,1,1]):n=new Float32Array([r,r,s,r,r,s,s,s]),new us(e,i,{geometry:t},{geometry:jt.createVertex(e,ri.STATIC_DRAW,n)})}function x8e(e,t=pq,i=mi){const r=new Float32Array([-1,-1,3,-1,-1,3]);return new us(e,i,{geometry:t},{geometry:jt.createVertex(e,ri.STATIC_DRAW,r)})}const wge=4;function xge(e,t=wge){return new Qe(e,{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.NEAREST,width:t,height:t})}function cee(e,t,i=wge){const r=new Uint8Array(i*i*4);for(let s=0;s<r.length;s+=4)r[s+0]=255*t[0],r[s+1]=255*t[1],r[s+2]=255*t[2],r[s+3]=255*t[3];return new Qe(e,{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.NEAREST,width:i,height:i},r)}function Tge(e){return new Qe(e,{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.NEAREST,width:1,height:1},new Uint8Array([255,255,255,255]))}class uee{constructor(t){this._view=t,this.type="realistic",this.canRender=!0,this._cameraPosition=M(),this._projectionInverse=Te(),this._viewInverse=Te(),this._heightParameters=ni(),this._betasRayleigh=M(),this._betasCombined=M(),this._scaleHeight=0,this._radii=Ye(),this._nearFar=Ye(),this._cameraHeight=0,this._cameraHeightSq=0,this._cAtmosphere=0,this._innerFadeDistance=0,this._altitudeFade=0,this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=ai.radius,this._hazeStrength=1,this._darkenHaze=!1,this._updateRadius(ai.radius)}destroy(){this._atmosphereTechnique=Xi(this._atmosphereTechnique),this._atmosphereHazeTechnique=Xi(this._atmosphereHazeTechnique),this._vao=tt(this._vao),this._handles=rt(this._handles)}when(){return Promise.resolve()}initializeRenderContext(t){const i=t.renderContext.rctx;this._handles=new Ut,_(this._view.basemapTerrain.rootTiles)&&this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add(Rp(this._view,"basemapTerrain","elevation-change",s=>this._updateElevation(s),()=>this._updateElevation())),this._handles.add(Rp(this._view,"basemapTerrain","elevation-bounds-change",()=>this._updateVisibleElevationBounds()));const r=new _ge;r.haze=!1,this._atmosphereTechnique=t.shaderTechniqueRepository.acquire(lR,r),r.haze=!0,this._atmosphereHazeTechnique=t.shaderTechniqueRepository.acquire(lR,r),this._vao=bo(i,RO),this._scaleHeight=zVe*h$,oe(this._betasRayleigh,Pb[0],Pb[1],Pb[2]),oe(this._betasCombined,Pb[0]+VU[0],Pb[1]+VU[1],Pb[2]+VU[2])}render(t){this._render(t,this._atmosphereTechnique,t.offscreenRenderingHelper.depthTexture)}renderHaze(t,i){this._darkenHaze=i,this._render(t,this._atmosphereHazeTechnique,t.offscreenRenderingHelper.linearDepthTexture)}_render(t,i,r){this._update(t.camera);const s=t.rctx.useTechnique(i);t.offscreenRenderingHelper.renderDepthDetached(()=>{s.bindTexture(r,"depthTex"),this._renderCommon(i.program,t)})}_renderCommon(t,i){if(R(this._vao))return;const r=i.rctx;i.scenelightingData.setLightDirectionUniform(t),t.setUniform4fv("heightParameters",this._heightParameters),t.setUniform3fv("cameraPosition",this._cameraPosition),t.setUniformMatrix4fv("inverseProjectionMatrix",this._projectionInverse),t.setUniformMatrix4fv("inverseViewMatrix",this._viewInverse),t.setUniform2fv("nearFar",this._nearFar),t.setUniform2fv("radii",this._radii),t.setUniform1f("scaleHeight",this._scaleHeight),t.setUniform1f("betaMie",kVe),t.setUniform3fv("betaRayleigh",this._betasRayleigh),t.setUniform3fv("betaCombined",this._betasCombined),t.setUniform1f("innerFadeDistance",this._innerFadeDistance),t.setUniform1f("altitudeFade",this._altitudeFade),t.setUniform1f("hazeStrength",this._hazeStrength),r.bindVAO(this._vao),t.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(Tt.TRIANGLE_STRIP,0,4)}_adjustRadiusForTesselation(t){return t*Math.cos(Math.PI/16/16)}_updateElevation(t){const i=t?t.tile:gt(this._view.basemapTerrain.rootTiles,[null])[0];if(R(i)||i.level!==0)return;const r=this._adjustRadiusForTesselation(ai.radius+i.elevationBounds[0]);r!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=r,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const t=this._adjustRadiusForTesselation(ai.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||t<this._lowerBoundEarthRadius)&&this._updateRadius(t)}_updateRadius(t){this._lowerBoundEarthRadius=t,rr(this._radii,t,t+h$),this._innerFadeDistance=2*Math.sqrt((2*t-O9)*O9)}_update(t){if(R(t))return;this._cameraHeight=Pe(t.eye),this._cameraHeightSq=this._cameraHeight*this._cameraHeight,this._cAtmosphere=this._cameraHeightSq-this._radii[1]*this._radii[1];const i=Math.min(1,Math.max(0,(this._cameraHeight-this._radii[0])/h$));this._heightParameters=yi(this._cameraHeight,this._cameraHeightSq,this._cAtmosphere,i),ne(this._cameraPosition,t.eye),fr(this._projectionInverse,t.projectionMatrix),fr(this._viewInverse,t.viewMatrix),rr(this._nearFar,t.near,t.far),this._altitudeFade=age(this._cameraHeight-this._lowerBoundEarthRadius),this._hazeStrength=this._darkenHaze?qt(.6,1,TT(9500,10500,this._cameraHeight-ai.radius)):1}static isSupported(t){return t.renderContext.rctx.capabilities.depthTexture}}function T8e(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function Sge(e,t,i){i*=.5;const r=Math.sin(i);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(i),e}function Ege(e,t){const i=2*Math.acos(t[3]),r=Math.sin(i/2);return r>wt?(e[0]=t[0]/r,e[1]=t[1]/r,e[2]=t[2]/r):(e[0]=1,e[1]=0,e[2]=0),i}function Age(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=i[0],l=i[1],c=i[2],h=i[3];return e[0]=r*h+o*a+s*c-n*l,e[1]=s*h+o*l+n*a-r*c,e[2]=n*h+o*c+r*l-s*a,e[3]=o*h-r*a-s*l-n*c,e}function S8e(e,t,i){i*=.5;const r=t[0],s=t[1],n=t[2],o=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=r*l+o*a,e[1]=s*l+n*a,e[2]=n*l-s*a,e[3]=o*l-r*a,e}function E8e(e,t,i){i*=.5;const r=t[0],s=t[1],n=t[2],o=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=r*l-n*a,e[1]=s*l+o*a,e[2]=n*l+r*a,e[3]=o*l-s*a,e}function A8e(e,t,i){i*=.5;const r=t[0],s=t[1],n=t[2],o=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=r*l+s*a,e[1]=s*l-r*a,e[2]=n*l+o*a,e[3]=o*l-n*a,e}function C8e(e,t){const i=t[0],r=t[1],s=t[2];return e[0]=i,e[1]=r,e[2]=s,e[3]=Math.sqrt(Math.abs(1-i*i-r*r-s*s)),e}function p$(e,t,i,r){const s=t[0],n=t[1],o=t[2],a=t[3];let l,c,h,p,f,g=i[0],y=i[1],v=i[2],b=i[3];return c=s*g+n*y+o*v+a*b,c<0&&(c=-c,g=-g,y=-y,v=-v,b=-b),1-c>wt?(l=Math.acos(c),h=Math.sin(l),p=Math.sin((1-r)*l)/h,f=Math.sin(r*l)/h):(p=1-r,f=r),e[0]=p*s+f*g,e[1]=p*n+f*y,e[2]=p*o+f*v,e[3]=p*a+f*b,e}function R8e(e){const t=Nh(),i=Nh(),r=Nh(),s=Math.sqrt(1-t),n=Math.sqrt(t);return e[0]=s*Math.sin(2*Math.PI*i),e[1]=s*Math.cos(2*Math.PI*i),e[2]=n*Math.sin(2*Math.PI*r),e[3]=n*Math.cos(2*Math.PI*r),e}function O8e(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=i*i+r*r+s*s+n*n,a=o?1/o:0;return e[0]=-i*a,e[1]=-r*a,e[2]=-s*a,e[3]=n*a,e}function OO(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e}function Cge(e,t){const i=t[0]+t[4]+t[8];let r;if(i>0)r=Math.sqrt(i+1),e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r;else{let s=0;t[4]>t[0]&&(s=1),t[8]>t[3*s+s]&&(s=2);const n=(s+1)%3,o=(s+2)%3;r=Math.sqrt(t[3*s+s]-t[3*n+n]-t[3*o+o]+1),e[s]=.5*r,r=.5/r,e[3]=(t[3*n+o]-t[3*o+n])*r,e[n]=(t[3*n+s]+t[3*s+n])*r,e[o]=(t[3*o+s]+t[3*s+o])*r}return e}function M8e(e,t,i,r){const s=.5*Math.PI/180;t*=s,i*=s,r*=s;const n=Math.sin(t),o=Math.cos(t),a=Math.sin(i),l=Math.cos(i),c=Math.sin(r),h=Math.cos(r);return e[0]=n*l*h-o*a*c,e[1]=o*a*h+n*l*c,e[2]=o*l*c-n*a*h,e[3]=o*l*h+n*a*c,e}function P8e(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}const Rge=_a,I8e=Ho,$8e=d7,D8e=Age,L8e=JR,N8e=moe,F8e=m7,Oge=p7,U8e=Oge,Mge=f7,k8e=Mge,gq=foe,z8e=g1,B8e=goe;function V8e(e,t,i){const r=_e(t,i);return r<-.999999?(pt(dd,G8e,t),h7(dd)<1e-6&&pt(dd,j8e,t),be(dd,dd),Sge(e,dd,Math.PI),e):r>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(pt(dd,t,i),e[0]=dd[0],e[1]=dd[1],e[2]=dd[2],e[3]=1+r,gq(e,e))}const dd=M(),G8e=je(1,0,0),j8e=je(0,1,0);function H8e(e,t,i,r,s,n){return p$(hee,t,s,n),p$(dee,i,r,n),p$(e,hee,dee,2*n*(1-n)),e}const hee=k0(),dee=k0();function q8e(e,t,i,r){const s=W8e;return s[0]=i[0],s[3]=i[1],s[6]=i[2],s[1]=r[0],s[4]=r[1],s[7]=r[2],s[2]=-t[0],s[5]=-t[1],s[8]=-t[2],gq(e,Cge(e,s))}const W8e=wr();Object.freeze({__proto__:null,identity:T8e,setAxisAngle:Sge,getAxisAngle:Ege,multiply:Age,rotateX:S8e,rotateY:E8e,rotateZ:A8e,calculateW:C8e,slerp:p$,random:R8e,invert:O8e,conjugate:OO,fromMat3:Cge,fromEuler:M8e,str:P8e,copy:Rge,set:I8e,add:$8e,mul:D8e,scale:L8e,dot:N8e,lerp:F8e,length:Oge,len:U8e,squaredLength:Mge,sqrLen:k8e,normalize:gq,exactEquals:z8e,equals:B8e,rotationTo:V8e,sqlerp:H8e,setAxes:q8e});function t2(e=Y8e){return[e[0],e[1],e[2],e[3]]}function cR(e,t){return X8e(e[0],e[1],e[2],t,kj.get())}function X8e(e,t,i,r,s=t2()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function uR(e,t,i=t2()){return pt(i,e,t),be(i,i),i[3]=Bj(e,t),i}const Y8e=[0,0,1,0];function fi(){return new Float32Array(3)}function bL(e){const t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function Ht(e,t,i){const r=new Float32Array(3);return r[0]=e,r[1]=t,r[2]=i,r}function Pge(e,t){return new Float32Array(e,t,3)}function yq(){return fi()}function Ige(){return Ht(1,1,1)}function $ge(){return Ht(1,0,0)}function Dge(){return Ht(0,1,0)}function Lge(){return Ht(0,0,1)}const Z8e=yq(),Q8e=Ige(),J8e=$ge(),K8e=Dge(),e9e=Lge();Object.freeze({__proto__:null,create:fi,clone:bL,fromValues:Ht,createView:Pge,zeros:yq,ones:Ige,unitX:$ge,unitY:Dge,unitZ:Lge,ZEROS:Z8e,ONES:Q8e,UNIT_X:J8e,UNIT_Y:K8e,UNIT_Z:e9e});function Nge(e){e.extensions.add("GL_EXT_shader_texture_lod"),e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(x`#ifndef GL_EXT_shader_texture_lod
float calcMipMapLevel(const vec2 ddx, const vec2 ddy) {
float deltaMaxSqr = max(dot(ddx, ddx), dot(ddy, ddy));
return max(0.0, 0.5 * log2(deltaMaxSqr));
}
#endif
vec4 textureAtlasLookup(sampler2D texture, vec2 textureSize, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
#ifdef GL_EXT_shader_texture_lod
return texture2DGradEXT(texture, uvAtlas, dUVdx, dUVdy);
#else
vec2 dUVdxAuto = dFdx(uvAtlas);
vec2 dUVdyAuto = dFdy(uvAtlas);
float mipMapLevel = calcMipMapLevel(dUVdx * textureSize, dUVdy * textureSize);
float autoMipMapLevel = calcMipMapLevel(dUVdxAuto * textureSize, dUVdyAuto * textureSize);
return texture2D(texture, uvAtlas, mipMapLevel - autoMipMapLevel);
#endif
}`)}function vq(e,t){e.include(gm,t),e.fragment.code.add(x`
  struct TextureLookupParameter {
    vec2 uv;
    ${t.supportsTextureAtlas?"vec2 size;":""}
  } vtc;
  `),t.attributeTextureCoordinates===_n.Default&&e.fragment.code.add(x`vec4 textureLookup(sampler2D tex, TextureLookupParameter params) {
return texture2D(tex, params.uv);
}`),t.attributeTextureCoordinates===_n.Atlas&&(e.include(Nge),e.fragment.code.add(x`vec4 textureLookup(sampler2D tex, TextureLookupParameter params) {
return textureAtlasLookup(tex, params.size, params.uv, vuvRegion);
}`))}const gyt=Ht(0,.6,.2);var xt;function _q(e,t){const i=e.fragment,r=t.hasMetalnessAndRoughnessTexture||t.hasEmissionTexture||t.hasOcclusionTexture;t.pbrMode===xt.Normal&&r&&e.include(vq,t),t.pbrMode!==xt.Schematic?(t.pbrMode===xt.Disabled&&i.code.add(x`float getBakedOcclusion() { return 1.0; }`),t.pbrMode===xt.Normal&&(i.uniforms.add("emissionFactor","vec3"),i.uniforms.add("mrrFactors","vec3"),i.code.add(x`vec3 mrr;
vec3 emission;
float occlusion;`),t.hasMetalnessAndRoughnessTexture&&(i.uniforms.add("texMetallicRoughness","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texMetallicRoughnessSize","vec2"),i.code.add(x`void applyMetallnessAndRoughness(TextureLookupParameter params) {
vec3 metallicRoughness = textureLookup(texMetallicRoughness, params).rgb;
mrr[0] *= metallicRoughness.b;
mrr[1] *= metallicRoughness.g;
}`)),t.hasEmissionTexture&&(i.uniforms.add("texEmission","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texEmissionSize","vec2"),i.code.add(x`void applyEmission(TextureLookupParameter params) {
emission *= textureLookup(texEmission, params).rgb;
}`)),t.hasOcclusionTexture?(i.uniforms.add("texOcclusion","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texOcclusionSize","vec2"),i.code.add(x`void applyOcclusion(TextureLookupParameter params) {
occlusion *= textureLookup(texOcclusion, params).r;
}
float getBakedOcclusion() {
return occlusion;
}`)):i.code.add(x`float getBakedOcclusion() { return 1.0; }`),i.code.add(x`
    void applyPBRFactors() {
      mrr = mrrFactors;
      emission = emissionFactor;
      occlusion = 1.0;
      ${r?"vtc.uv = vuv0;":""}
      ${t.hasMetalnessAndRoughnessTexture?t.supportsTextureAtlas?"vtc.size = texMetallicRoughnessSize; applyMetallnessAndRoughness(vtc);":"applyMetallnessAndRoughness(vtc);":""}
      ${t.hasEmissionTexture?t.supportsTextureAtlas?"vtc.size = texEmissionSize; applyEmission(vtc);":"applyEmission(vtc);":""}
      ${t.hasOcclusionTexture?t.supportsTextureAtlas?"vtc.size = texOcclusionSize; applyOcclusion(vtc);":"applyOcclusion(vtc);":""}
    }
  `))):i.code.add(x`const vec3 mrr = vec3(0.0, 0.6, 0.2);
const vec3 emission = vec3(0.0);
float occlusion = 1.0;
void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`)}function Fge(e,t,i=!1){i||(e.setUniform3fv("mrrFactors",t.mrrFactors),e.setUniform3fv("emissionFactor",t.emissiveFactor))}(function(e){e[e.Disabled=0]="Disabled",e[e.Normal=1]="Normal",e[e.Schematic=2]="Schematic",e[e.Water=3]="Water",e[e.WaterOnIntegratedMesh=4]="WaterOnIntegratedMesh",e[e.COUNT=5]="COUNT"})(xt||(xt={}));function bq(e,t){const i=e.fragment,r=t.lightingSphericalHarmonicsOrder!==void 0?t.lightingSphericalHarmonicsOrder:2;r===0?(i.uniforms.add("lightingAmbientSH0","vec3"),i.code.add(x`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
return ambientLight * (1.0 - ambientOcclusion);
}`)):r===1?(i.uniforms.add("lightingAmbientSH_R","vec4"),i.uniforms.add("lightingAmbientSH_G","vec4"),i.uniforms.add("lightingAmbientSH_B","vec4"),i.code.add(x`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec4 sh0 = vec4(
0.282095,
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y
);
vec3 ambientLight = vec3(
dot(lightingAmbientSH_R, sh0),
dot(lightingAmbientSH_G, sh0),
dot(lightingAmbientSH_B, sh0)
);
return ambientLight * (1.0 - ambientOcclusion);
}`)):r===2&&(i.uniforms.add("lightingAmbientSH0","vec3"),i.uniforms.add("lightingAmbientSH_R1","vec4"),i.uniforms.add("lightingAmbientSH_G1","vec4"),i.uniforms.add("lightingAmbientSH_B1","vec4"),i.uniforms.add("lightingAmbientSH_R2","vec4"),i.uniforms.add("lightingAmbientSH_G2","vec4"),i.uniforms.add("lightingAmbientSH_B2","vec4"),i.code.add(x`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
vec4 sh1 = vec4(
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y,
1.092548 * normal.x * normal.y
);
vec4 sh2 = vec4(
1.092548 * normal.y * normal.z,
0.315392 * (3.0 * normal.z * normal.z - 1.0),
1.092548 * normal.x * normal.z,
0.546274 * (normal.x * normal.x - normal.y * normal.y)
);
ambientLight += vec3(
dot(lightingAmbientSH_R1, sh1),
dot(lightingAmbientSH_G1, sh1),
dot(lightingAmbientSH_B1, sh1)
);
ambientLight += vec3(
dot(lightingAmbientSH_R2, sh2),
dot(lightingAmbientSH_G2, sh2),
dot(lightingAmbientSH_B2, sh2)
);
return ambientLight * (1.0 - ambientOcclusion);
}`),t.pbrMode!==xt.Normal&&t.pbrMode!==xt.Schematic||i.code.add(x`const vec3 skyTransmittance = vec3(0.9, 0.9, 1.0);
vec3 calculateAmbientRadiance(float ambientOcclusion)
{
vec3 ambientLight = 1.2 * (0.282095 * lightingAmbientSH0) - 0.2;
return ambientLight *= (1.0 - ambientOcclusion) * skyTransmittance;
}`))}function GF(e){const t=e.fragment;t.uniforms.add("lightingMainDirection","vec3"),t.uniforms.add("lightingMainIntensity","vec3"),t.uniforms.add("lightingFixedFactor","float"),t.uniforms.add("lightingSpecularStrength","float"),t.uniforms.add("lightingEnvironmentStrength","float"),t.code.add(x`vec3 evaluateMainLighting(vec3 normal_global, float shadowing) {
float dotVal = clamp(dot(normal_global, lightingMainDirection), 0.0, 1.0);
dotVal = mix(dotVal, 1.0, lightingFixedFactor);
return lightingMainIntensity * ((1.0 - shadowing) * dotVal);
}`)}function jF(e){e.vertex.code.add(x`const float PI = 3.141592653589793;`),e.fragment.code.add(x`const float PI = 3.141592653589793;
const float LIGHT_NORMALIZATION = 1.0 / PI;
const float INV_PI = 0.3183098861837907;
const float HALF_PI = 1.570796326794897;`)}function Uge(e){e.fragment.uniforms.add("anchorPosition","vec3").add("anchorPositionCrossFade","vec3").add("fadeInOutFactor","float").add("cloudsHeight","float").add("rotationMatrixClouds","mat4").add("rotationMatrixCloudsCrossFade","mat4").add("radiusCurvatureCorrectionFactor","float").add("radius","float").add("cameraPosition","vec3").add("totalFadeInOut","float").add("crossFade","int").add("crossFadeAnchorFactor","float").add("cloudVariables","vec2").add("cubeMap","samplerCube"),e.fragment.code.add(x`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos, float radiusReduction)
{
vec3 dirAnchor = normalize(spherePos);
vec3 sphereOriginOffset = dirAnchor * radiusReduction;
float radiusClouds = radius + cloudsHeight - radiusReduction;
float B = 2.0 * dot(cameraPosition - sphereOriginOffset, dir);
float C = dot(cameraPosition - sphereOriginOffset, cameraPosition - sphereOriginOffset) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),e.fragment.code.add(x`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),e.fragment.code.add(x`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),e.fragment.code.add(x`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(lightingMainDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(lightingMainDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((lightingMainIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * pow(dirDotLight, RIM_SCATTERING_FACTOR) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),e.fragment.code.add(x`vec4 getCloudData(vec3 rayDir)
{
vec4 cloudData = textureCube(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
return mix(vec4(vec3(clamp(1.0 - cloudVariables.y, 0.6, 1.0)), 0.0), cloudData, smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(mu)));
}`),e.fragment.code.add(x`vec4 renderCloud(vec3 worldRay, vec3 position)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), position, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(normalize(-worldRay), cloudData), totalTransmittance);
}`),e.fragment.code.add(x`vec4 renderCloudCrossFade(vec3 worldRay, vec3 position)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), position, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColor = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), position, anchorPositionCrossFade, 0.0);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`)}function Vp(e){e.code.add(x`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}function t9e(){const e=new Oi;return e.attributes.add(E.POSITION,"vec2"),e.varyings.add("worldRay","vec3"),e.vertex.uniforms.add("inverseProjectionMatrix","mat4"),e.vertex.uniforms.add("inverseViewMatrix","mat4"),e.vertex.code.add(x`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),e.fragment.uniforms.add("lightingMainDirection","vec3"),e.fragment.include(Vp),e.fragment.include(nd),e.include(GF),e.include(bq,{pbrMode:xt.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(jF),e.include(BF),e.include(Uge),e.fragment.code.add(x`void main() {
vec4 cloudsColor = crossFade == 0 ? renderCloud(normalize(worldRay), cameraPosition) : renderCloudCrossFade(normalize(worldRay), cameraPosition);
gl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),e}const i9e=Object.freeze({__proto__:null,build:t9e});class HF extends Gi{constructor(t){super(t,null,()=>this.destroy())}initializeProgram(t){const i=HF.shader.get().build();return new Mi(t.rctx,i,mi)}initializePipeline(){return Ot({blending:Sc(Ee.ONE,Ee.SRC_ALPHA),depthTest:{func:Li.LEQUAL},colorWrite:Ft})}}HF.shader=new Ni(i9e,()=>import("./CloudsComposition.glsl.16ddd066.js"));let rx=class extends we{constructor(e){super(e),this._inverseProjectionMatrix=Te(),this._inverseViewMatrix=Te(),this._technique=new HF(e),this._vao=bo(e.rctx),this._setDefaultParallax(e.radius)}destroy(){this._technique=Xi(this._technique),this._vao=tt(this._vao)}render(e,t,i){this._parameters.clouds=t;const r=e.camera;if(R(this._vao)||R(r))return;const s=e.rctx,n=s.useTechnique(this._technique);e.scenelightingData.setLightDirectionUniform(n),e.scenelightingData.setUniforms(n,!1,!1),fr(this._inverseProjectionMatrix,r.projectionMatrix),fr(this._inverseViewMatrix,r.viewMatrix),n.setUniformMatrix4fv("inverseProjectionMatrix",this._inverseProjectionMatrix),n.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix),n.setUniform2f("cloudVariables",this._parameters.clouds.coverage,this._parameters.clouds.absorption),this._setParallaxParams(r.eye,i),e.cloudsCompositionParams=this._parameters,kge(n,r,this._parameters),s.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(Tt.TRIANGLE_STRIP,0,4)}get isFading(){return this._parameters.crossFade.stage!==su.FINISHED||this._parameters.fadeInOut.stage!==ko.FINISHED||this._parameters.fadeIn.stage!==ru.FINISHED||this._parameters.fadeInOutHeight.stage!==L_.FINISHED}_setDefaultParallax(e){this._parameters={parallax:{anchorPointClouds:M(),radius:e,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:Te()},parallaxNew:{anchorPointClouds:M(),radius:e,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:Te()},crossFade:{stage:su.FINISHED,factor:0,distanceThresholdFactor:.3},fadeInOut:{stage:ko.FINISHED,factor:0,distanceThresholdFactor:.6},fadeIn:{stage:ru.FINISHED,factor:0,distanceThresholdFactor:2},fadeInOutHeight:{stage:L_.FINISHED,factor:-1},cameraPositionLastFrame:M(),startTime:0,startTimeHeightFade:0,clouds:null}}_isCameraPositionFinal(e){return bT(this._parameters.cameraPositionLastFrame,e)}_setFadeInStage(e){const t=this._isCameraPositionFinal(e);this._parameters.fadeIn.stage===ru.FINISHED&&(this._parameters.fadeIn.factor=1,ne(this._parameters.parallax.anchorPointClouds,Jp),this._parameters.fadeIn.stage=ru.CHANGE_ANCHOR,this._parameters.crossFade.stage=su.FINISHED,this._parameters.fadeInOut.stage=ko.FINISHED),this._parameters.fadeIn.stage===ru.CHANGE_ANCHOR&&t&&(ne(this._parameters.parallax.anchorPointClouds,Jp),this._parameters.fadeIn.stage=ru.FADE_IN,this._parameters.startTime=performance.now()),this._parameters.fadeIn.factor>0&&this._parameters.fadeIn.stage===ru.FADE_IN&&(this._parameters.fadeIn.factor=1-(performance.now()-this._parameters.startTime)/500),this._parameters.fadeIn.factor<=0&&this._parameters.fadeIn.stage===ru.FADE_IN&&(this._parameters.fadeIn.stage=ru.FINISHED,this._parameters.fadeIn.factor=0)}_setCrossFadingStage(){this._parameters.crossFade.stage===su.FINISHED&&(ne(this._parameters.parallaxNew.anchorPointClouds,Jp),this._parameters.startTime=performance.now(),this._parameters.crossFade.factor=0,this._parameters.crossFade.stage=su.CROSS_FADE),this._parameters.crossFade.factor<1&&this._parameters.crossFade.stage===su.CROSS_FADE&&(this._parameters.crossFade.factor=(performance.now()-this._parameters.startTime)/500),this._parameters.crossFade.factor>=1&&this._parameters.crossFade.stage===su.CROSS_FADE&&(this._parameters.crossFade.stage=su.FINISHED,this._parameters.crossFade.factor=1,ne(this._parameters.parallax.anchorPointClouds,this._parameters.parallaxNew.anchorPointClouds))}_setFadeInOutStage(e){this._parameters.fadeInOut.stage===ko.FINISHED&&(this._parameters.startTime=performance.now(),this._parameters.fadeInOut.factor=0,this._parameters.fadeInOut.stage=ko.FADE_OUT),this._parameters.fadeInOut.factor<1&&this._parameters.fadeInOut.stage===ko.FADE_OUT&&(this._parameters.fadeInOut.factor=(performance.now()-this._parameters.startTime)/250),this._parameters.fadeInOut.factor>=1&&this._parameters.fadeInOut.stage===ko.FADE_OUT&&(this._parameters.fadeInOut.factor=1,ne(this._parameters.parallax.anchorPointClouds,Jp)),this._parameters.fadeInOut.factor>=1&&this._parameters.fadeInOut.stage===ko.FADE_OUT&&this._isCameraPositionFinal(e)&&(this._parameters.startTime=performance.now(),this._parameters.fadeInOut.factor=1,this._parameters.fadeInOut.stage=ko.FADE_IN,this._parameters.crossFade.stage=su.FINISHED,this._parameters.crossFade.factor=0),this._parameters.fadeInOut.factor>0&&this._parameters.fadeInOut.stage===ko.FADE_IN&&(this._parameters.fadeInOut.factor=1-(performance.now()-this._parameters.startTime)/500),this._parameters.fadeInOut.factor<=0&&this._parameters.fadeInOut.stage===ko.FADE_IN&&(this._parameters.fadeInOut.stage=ko.FINISHED,this._parameters.fadeInOut.factor=0)}_setFadeInOutHeight(e){const t=performance.now();this._parameters.startTimeHeightFade=this._parameters.fadeInOutHeight.stage===L_.FINISHED?t:this._parameters.startTimeHeightFade,e?this._parameters.fadeInOutHeight.factor+=(t-this._parameters.startTimeHeightFade)/500:this._parameters.fadeInOutHeight.factor-=(t-this._parameters.startTimeHeightFade)/500,this._parameters.startTimeHeightFade=t,this._parameters.fadeInOutHeight.factor=Be(this._parameters.fadeInOutHeight.factor,0,1),this._parameters.fadeInOutHeight.stage=L_.HEIGHT_FADE}_setParallaxParams(e,t){this._parameters.fadeInOutHeight.factor<0&&(this._parameters.fadeInOutHeight.factor=Pe(e)-this._parameters.parallax.radius>pu?1:0),be(Jp,e),ae(Jp,Jp,this._parameters.parallax.radius),this._parameters.parallax.anchorPointClouds[0]===0&&this._parameters.parallax.anchorPointClouds[1]===0&&this._parameters.parallax.anchorPointClouds[2]===0&&ne(this._parameters.parallax.anchorPointClouds,Jp);const i=Pe(de(r9e,this._parameters.parallax.anchorPointClouds,Jp));let r=!0;i>this._parameters.fadeIn.distanceThresholdFactor*this._parameters.parallax.cloudsHeight||this._parameters.fadeIn.stage!==ru.FINISHED?this._setFadeInStage(e):i>this._parameters.fadeInOut.distanceThresholdFactor*this._parameters.parallax.cloudsHeight||this._parameters.fadeInOut.stage!==ko.FINISHED?this._setFadeInOutStage(e):i>this._parameters.crossFade.distanceThresholdFactor*this._parameters.parallax.cloudsHeight&&!t||this._parameters.crossFade.stage!==su.FINISHED?this._setCrossFadingStage():r=!1;const s=Pe(e),n=s-this._parameters.parallax.radius;(n>1.7*pu||n<-pu)&&this._parameters.fadeInOutHeight.factor<1?this._parameters.fadeInOutHeight.factor=1:(n>pu||n<-.35*pu)&&this._parameters.fadeInOutHeight.factor<1?this._setFadeInOutHeight(!0):n<pu&&n>-.35*pu&&this._parameters.fadeInOutHeight.factor>0?this._setFadeInOutHeight(!1):this._parameters.fadeInOutHeight.stage=L_.FINISHED,this._parameters.parallax.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(s*s-this._parameters.parallax.radius*this._parameters.parallax.radius,0))/s,uR(pee,this._parameters.parallax.anchorPointClouds,Ib),this._parameters.parallax.transform=Te(),cl(this._parameters.parallax.transform,this._parameters.parallax.transform,Ib[3],Ib),r&&(uR(pee,this._parameters.parallaxNew.anchorPointClouds,Ib),this._parameters.parallaxNew.transform=Te(),cl(this._parameters.parallaxNew.transform,this._parameters.parallaxNew.transform,Ib[3],Ib)),ne(this._parameters.cameraPositionLastFrame,e)}};var ru,ko,su,L_;function kge(e,t,i){e.bindTexture(i.clouds.cubeMap.colorTexture,"cubeMap"),e.setUniform1f("cloudsHeight",i.parallax.cloudsHeight),e.setUniformMatrix4fv("rotationMatrixClouds",i.parallax.transform),e.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",i.parallaxNew.transform),e.setUniform3fv("anchorPosition",i.parallax.anchorPointClouds),e.setUniform3fv("anchorPositionCrossFade",i.parallaxNew.anchorPointClouds),i.fadeInOut.stage!==ko.FINISHED?e.setUniform1f("totalFadeInOut",i.fadeInOutHeight.factor+Math.max(Be(i.fadeInOut.factor,0,1))):e.setUniform1f("totalFadeInOut",i.fadeInOutHeight.factor+Math.max(Be(i.fadeIn.factor,0,1))),e.setUniform1f("radiusCurvatureCorrectionFactor",i.parallax.radiusCurvatureCorrectionFactor),e.setUniform1i("crossFade",i.crossFade.stage),e.setUniform1f("crossFadeAnchorFactor",Be(i.crossFade.factor,0,1)),e.setUniform1f("radius",i.parallax.radius),e.setUniform3fv("cameraPosition",t.eye)}u([d({constructOnly:!0})],rx.prototype,"rctx",void 0),u([d({constructOnly:!0})],rx.prototype,"viewingMode",void 0),u([d({constructOnly:!0})],rx.prototype,"radius",void 0),rx=u([P("esri.views.3d.environment.CloudsComposition")],rx),function(e){e[e.FINISHED=0]="FINISHED",e[e.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",e[e.FADE_IN=2]="FADE_IN"}(ru||(ru={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.FADE_OUT=1]="FADE_OUT",e[e.FADE_IN=2]="FADE_IN"}(ko||(ko={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.CROSS_FADE=1]="CROSS_FADE"}(su||(su={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.HEIGHT_FADE=1]="HEIGHT_FADE"}(L_||(L_={}));const pee=je(0,0,1),Ib=t2(),Jp=M(),r9e=M();function s9e(e){return _(e)&&_(e.cubeMap)&&!e.running&&e.coverage>0}function Lu(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function hR(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function wq(e,t,i,r,s,n,o,a,l,c){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e[4]=n,e[5]=o,e[6]=a,e[7]=l,e[8]=c,e}function xq(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function Nu(e,t){if(e===t){const i=t[1],r=t[2],s=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=r,e[7]=s}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e}function k1(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=h*o-a*c,f=-h*n+a*l,g=c*n-o*l;let y=i*p+r*f+s*g;return y?(y=1/y,e[0]=p*y,e[1]=(-h*r+s*c)*y,e[2]=(a*r-s*o)*y,e[3]=f*y,e[4]=(h*i-s*l)*y,e[5]=(-a*i+s*n)*y,e[6]=g*y,e[7]=(-c*i+r*l)*y,e[8]=(o*i-r*n)*y,e):null}function n9e(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8];return e[0]=o*h-a*c,e[1]=s*c-r*h,e[2]=r*a-s*o,e[3]=a*l-n*h,e[4]=i*h-s*l,e[5]=s*n-i*a,e[6]=n*c-o*l,e[7]=r*l-i*c,e[8]=i*o-r*n,e}function o9e(e){const t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],o=e[5],a=e[6],l=e[7],c=e[8];return t*(c*n-o*l)+i*(-c*s+o*a)+r*(l*s-n*a)}function qF(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=t[8],f=i[0],g=i[1],y=i[2],v=i[3],b=i[4],w=i[5],S=i[6],T=i[7],A=i[8];return e[0]=f*r+g*o+y*c,e[1]=f*s+g*a+y*h,e[2]=f*n+g*l+y*p,e[3]=v*r+b*o+w*c,e[4]=v*s+b*a+w*h,e[5]=v*n+b*l+w*p,e[6]=S*r+T*o+A*c,e[7]=S*s+T*a+A*h,e[8]=S*n+T*l+A*p,e}function wL(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=t[8],f=i[0],g=i[1];return e[0]=r,e[1]=s,e[2]=n,e[3]=o,e[4]=a,e[5]=l,e[6]=f*r+g*o+c,e[7]=f*s+g*a+h,e[8]=f*n+g*l+p,e}function Tq(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=t[8],f=Math.sin(i),g=Math.cos(i);return e[0]=g*r+f*o,e[1]=g*s+f*a,e[2]=g*n+f*l,e[3]=g*o-f*r,e[4]=g*a-f*s,e[5]=g*l-f*n,e[6]=c,e[7]=h,e[8]=p,e}function Sq(e,t,i){const r=i[0],s=i[1],n=i[2];return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e[6]=n*t[6],e[7]=n*t[7],e[8]=n*t[8],e}function a9e(e,t,i){const r=i[0],s=i[1];return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e}function l9e(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e}function c9e(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=0,e[3]=-i,e[4]=r,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function u9e(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function h9e(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e}function Eq(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=i+i,a=r+r,l=s+s,c=i*o,h=r*o,p=r*a,f=s*o,g=s*a,y=s*l,v=n*o,b=n*a,w=n*l;return e[0]=1-p-y,e[3]=h-w,e[6]=f+b,e[1]=h+w,e[4]=1-c-y,e[7]=g-v,e[2]=f-b,e[5]=g+v,e[8]=1-c-p,e}function zge(e,t){const i=t[0],r=t[1],s=t[2],n=t[4],o=t[5],a=t[6],l=t[8],c=t[9],h=t[10],p=h*o-a*c,f=-h*n+a*l,g=c*n-o*l,y=i*p+r*f+s*g;if(!y)return null;const v=1/y;return e[0]=p*v,e[1]=(-h*r+s*c)*v,e[2]=(a*r-s*o)*v,e[3]=f*v,e[4]=(h*i-s*l)*v,e[5]=(-a*i+s*n)*v,e[6]=g*v,e[7]=(-c*i+r*l)*v,e[8]=(o*i-r*n)*v,e}function cS(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=t[9],f=t[10],g=t[11],y=t[12],v=t[13],b=t[14],w=t[15],S=i*a-r*o,T=i*l-s*o,A=i*c-n*o,C=r*l-s*a,O=r*c-n*a,L=s*c-n*l,U=h*v-p*y,N=h*b-f*y,z=h*w-g*y,V=p*b-f*v,B=p*w-g*v,J=f*w-g*b;let Q=S*J-T*B+A*V+C*z-O*N+L*U;return Q?(Q=1/Q,e[0]=(a*J-l*B+c*V)*Q,e[1]=(l*z-o*J-c*N)*Q,e[2]=(o*B-a*z+c*U)*Q,e[3]=(s*B-r*J-n*V)*Q,e[4]=(i*J-s*z+n*N)*Q,e[5]=(r*z-i*B-n*U)*Q,e[6]=(v*L-b*O+w*C)*Q,e[7]=(b*A-y*L-w*T)*Q,e[8]=(y*O-v*A+w*S)*Q,e):null}function d9e(e,t,i){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/i,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e}function p9e(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"}function f9e(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2+e[4]**2+e[5]**2+e[6]**2+e[7]**2+e[8]**2)}function m9e(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e[6]=t[6]+i[6],e[7]=t[7]+i[7],e[8]=t[8]+i[8],e}function Bge(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e[6]=t[6]-i[6],e[7]=t[7]-i[7],e[8]=t[8]-i[8],e}function g9e(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*i,e}function y9e(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e[4]=t[4]+i[4]*r,e[5]=t[5]+i[5]*r,e[6]=t[6]+i[6]*r,e[7]=t[7]+i[7]*r,e[8]=t[8]+i[8]*r,e}function v9e(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]}function _9e(e,t){const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=t[0],f=t[1],g=t[2],y=t[3],v=t[4],b=t[5],w=t[6],S=t[7],T=t[8];return Math.abs(i-p)<=wt*Math.max(1,Math.abs(i),Math.abs(p))&&Math.abs(r-f)<=wt*Math.max(1,Math.abs(r),Math.abs(f))&&Math.abs(s-g)<=wt*Math.max(1,Math.abs(s),Math.abs(g))&&Math.abs(n-y)<=wt*Math.max(1,Math.abs(n),Math.abs(y))&&Math.abs(o-v)<=wt*Math.max(1,Math.abs(o),Math.abs(v))&&Math.abs(a-b)<=wt*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(l-w)<=wt*Math.max(1,Math.abs(l),Math.abs(w))&&Math.abs(c-S)<=wt*Math.max(1,Math.abs(c),Math.abs(S))&&Math.abs(h-T)<=wt*Math.max(1,Math.abs(h),Math.abs(T))}function Aq(e){const t=wt,i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8];return Math.abs(1-(i*i+n*n+l*l))<=t&&Math.abs(1-(r*r+o*o+c*c))<=t&&Math.abs(1-(s*s+a*a+h*h))<=t}const b9e=qF,w9e=Bge;Object.freeze({__proto__:null,fromMat4:Lu,copy:hR,set:wq,identity:xq,transpose:Nu,invert:k1,adjoint:n9e,determinant:o9e,multiply:qF,translate:wL,rotate:Tq,scale:Sq,scaleByVec2:a9e,fromTranslation:l9e,fromRotation:c9e,fromScaling:u9e,fromMat2d:h9e,fromQuat:Eq,normalFromMat4Legacy:zge,normalFromMat4:cS,projection:d9e,str:p9e,frob:f9e,add:m9e,subtract:Bge,multiplyScalar:g9e,multiplyScalarAndAdd:y9e,exactEquals:v9e,equals:_9e,isOrthoNormal:Aq,mul:b9e,sub:w9e});function G0(e,t=!0){e.attributes.add(E.POSITION,"vec2"),t&&e.varyings.add("uv","vec2"),e.vertex.code.add(x`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      ${t?x`uv = position * 0.5 + vec2(0.5);`:""}
    }
  `)}function x9e(){const e=new Oi;e.include(G0,!1),e.fragment.uniforms.add("tileRows","float").add("tileSize","float");const t=2,i=8;return e.fragment.code.add(x`
    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }

    vec4 taylorInvSqrt(vec4 r) {
      return 1.79284291400159 - 0.85373472095314 * r;
    }

    vec4 mod289(vec4 x) {
      return x - floor( x * (1.0 / 289.0)) * 289.0;
    }

    vec4 permute(vec4 x) {
      return mod289(((x * 34.0) + 1.0) * x);
    }

    vec4 fade(vec4 t) {
      return (t * t * t) * (t * (t * vec4(6.0) - vec4(15.0)) + vec4(10.0));
    }

    float glmPerlin(vec4 Position, vec4 rep) {
      vec4 Pi0 = mod(floor(Position), rep);
      vec4 Pi1 = mod(Pi0 + 1.0, rep);
      vec4 Pf0 = fract(Position);
      vec4 Pf1 = Pf0 - 1.0;
      vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);
      vec4 iy = vec4(Pi0.y, Pi0.y, Pi1.y, Pi1.y);

      vec4 ixy = permute(permute(ix) + iy);
      vec4 ixy0 = permute(ixy + vec4(Pi0.z));
      vec4 ixy1 = permute(ixy + vec4(Pi1.z));
      vec4 ixy00 = permute(ixy0 + vec4(Pi0.w));
      vec4 ixy01 = permute(ixy0 + vec4(Pi1.w));
      vec4 ixy10 = permute(ixy1 + vec4(Pi0.w));
      vec4 ixy11 = permute(ixy1 + vec4(Pi1.w));

      vec4 gx00 = ixy00 / 7.0;
      vec4 gy00 = floor(gx00) / 7.0;
      vec4 gz00 = floor(gy00) / 6.0;
      gx00 = fract(gx00) - 0.5;
      gy00 = fract(gy00) - 0.5;
      gz00 = fract(gz00) - 0.5;
      vec4 gw00 = vec4(0.75) - abs(gx00) - abs(gy00) - abs(gz00);
      vec4 sw00 = step(gw00, vec4(0.0));
      gx00 -= sw00 * (step(0.0, gx00) - 0.5);
      gy00 -= sw00 * (step(0.0, gy00) - 0.5);

      vec4 gx01 = ixy01 / 7.0;
      vec4 gy01 = floor(gx01) / 7.0;
      vec4 gz01 = floor(gy01) / 6.0;
      gx01 = fract(gx01) - 0.5;
      gy01 = fract(gy01) - 0.5;
      gz01 = fract(gz01) - 0.5;
      vec4 gw01 = vec4(0.75) - abs(gx01) - abs(gy01) - abs(gz01);
      vec4 sw01 = step(gw01, vec4(0.0));
      gx01 -= sw01 * (step(0.0, gx01) - 0.5);
      gy01 -= sw01 * (step(0.0, gy01) - 0.5);

      vec4 gx10 = ixy10 / 7.0;
      vec4 gy10 = floor(gx10) / 7.0;
      vec4 gz10 = floor(gy10) / 6.0;
      gx10 = fract(gx10) - 0.5;
      gy10 = fract(gy10) - 0.5;
      gz10 = fract(gz10) - 0.5;
      vec4 gw10 = vec4(0.75) - abs(gx10) - abs(gy10) - abs(gz10);
      vec4 sw10 = step(gw10, vec4(0.0));
      gx10 -= sw10 * (step(0.0, gx10) - 0.5);
      gy10 -= sw10 * (step(0.0, gy10) - 0.5);

      vec4 gx11 = ixy11 / 7.0;
      vec4 gy11 = floor(gx11) / 7.0;
      vec4 gz11 = floor(gy11) / 6.0;
      gx11 = fract(gx11) - 0.5;
      gy11 = fract(gy11) - 0.5;
      gz11 = fract(gz11) - 0.5;
      vec4 gw11 = vec4(0.75) - abs(gx11) - abs(gy11) - abs(gz11);
      vec4 sw11 = step(gw11, vec4(0.0));
      gx11 -= sw11 * (step(0.0, gx11) - 0.5);
      gy11 -= sw11 * (step(0.0, gy11) - 0.5);

      vec4 g0000 = vec4(gx00.x, gy00.x, gz00.x, gw00.x);
      vec4 g1000 = vec4(gx00.y, gy00.y, gz00.y, gw00.y);
      vec4 g0100 = vec4(gx00.z, gy00.z, gz00.z, gw00.z);
      vec4 g1100 = vec4(gx00.w, gy00.w, gz00.w, gw00.w);
      vec4 g0010 = vec4(gx10.x, gy10.x, gz10.x, gw10.x);
      vec4 g1010 = vec4(gx10.y, gy10.y, gz10.y, gw10.y);
      vec4 g0110 = vec4(gx10.z, gy10.z, gz10.z, gw10.z);
      vec4 g1110 = vec4(gx10.w, gy10.w, gz10.w, gw10.w);
      vec4 g0001 = vec4(gx01.x, gy01.x, gz01.x, gw01.x);
      vec4 g1001 = vec4(gx01.y, gy01.y, gz01.y, gw01.y);
      vec4 g0101 = vec4(gx01.z, gy01.z, gz01.z, gw01.z);
      vec4 g1101 = vec4(gx01.w, gy01.w, gz01.w, gw01.w);
      vec4 g0011 = vec4(gx11.x, gy11.x, gz11.x, gw11.x);
      vec4 g1011 = vec4(gx11.y, gy11.y, gz11.y, gw11.y);
      vec4 g0111 = vec4(gx11.z, gy11.z, gz11.z, gw11.z);
      vec4 g1111 = vec4(gx11.w, gy11.w, gz11.w, gw11.w);

      vec4 norm00 = taylorInvSqrt(vec4(dot(g0000, g0000), dot(g0100, g0100), dot(g1000, g1000), dot(g1100, g1100)));
      g0000 *= norm00.x;
      g0100 *= norm00.y;
      g1000 *= norm00.z;
      g1100 *= norm00.w;

      vec4 norm01 = taylorInvSqrt(vec4(dot(g0001, g0001), dot(g0101, g0101), dot(g1001, g1001), dot(g1101, g1101)));
      g0001 *= norm01.x;
      g0101 *= norm01.y;
      g1001 *= norm01.z;
      g1101 *= norm01.w;

      vec4 norm10 = taylorInvSqrt(vec4(dot(g0010, g0010), dot(g0110, g0110), dot(g1010, g1010), dot(g1110, g1110)));
      g0010 *= norm10.x;
      g0110 *= norm10.y;
      g1010 *= norm10.z;
      g1110 *= norm10.w;

      vec4 norm11 = taylorInvSqrt(vec4(dot(g0011, g0011), dot(g0111, g0111), dot(g1011, g1011), dot(g1111, g1111)));
      g0011 *= norm11.x;
      g0111 *= norm11.y;
      g1011 *= norm11.z;
      g1111 *= norm11.w;

      float n0000 = dot(g0000, Pf0);
      float n1000 = dot(g1000, vec4(Pf1.x, Pf0.y, Pf0.z, Pf0.w));
      float n0100 = dot(g0100, vec4(Pf0.x, Pf1.y, Pf0.z, Pf0.w));
      float n1100 = dot(g1100, vec4(Pf1.x, Pf1.y, Pf0.z, Pf0.w));
      float n0010 = dot(g0010, vec4(Pf0.x, Pf0.y, Pf1.z, Pf0.w));
      float n1010 = dot(g1010, vec4(Pf1.x, Pf0.y, Pf1.z, Pf0.w));
      float n0110 = dot(g0110, vec4(Pf0.x, Pf1.y, Pf1.z, Pf0.w));
      float n1110 = dot(g1110, vec4(Pf1.x, Pf1.y, Pf1.z, Pf0.w));
      float n0001 = dot(g0001, vec4(Pf0.x, Pf0.y, Pf0.z, Pf1.w));
      float n1001 = dot(g1001, vec4(Pf1.x, Pf0.y, Pf0.z, Pf1.w));
      float n0101 = dot(g0101, vec4(Pf0.x, Pf1.y, Pf0.z, Pf1.w));
      float n1101 = dot(g1101, vec4(Pf1.x, Pf1.y, Pf0.z, Pf1.w));
      float n0011 = dot(g0011, vec4(Pf0.x, Pf0.y, Pf1.z, Pf1.w));
      float n1011 = dot(g1011, vec4(Pf1.x, Pf0.y, Pf1.z, Pf1.w));
      float n0111 = dot(g0111, vec4(Pf0.x, Pf1.y, Pf1.z, Pf1.w));
      float n1111 = dot(g1111, Pf1);

      vec4 fade_xyzw = fade(Pf0);
      vec4 n_0w = mix(vec4(n0000, n1000, n0100, n1100), vec4(n0001, n1001, n0101, n1101), fade_xyzw.w);
      vec4 n_1w = mix(vec4(n0010, n1010, n0110, n1110), vec4(n0011, n1011, n0111, n1111), fade_xyzw.w);
      vec4 n_zw = mix(n_0w, n_1w, fade_xyzw.z);
      vec2 n_yzw = mix(vec2(n_zw.x, n_zw.y), vec2(n_zw.z, n_zw.w), fade_xyzw.y);
      float n_xyzw = mix(n_yzw.x, n_yzw.y, fade_xyzw.x);
      return 2.2 * n_xyzw;
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequencyFactor = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * glmPerlin(vec4(p, 0.0), vec4(frequency));
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequencyFactor;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float hash(float p) {
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);;
    }

    float noise(vec3 x) {
      vec3 p = floor(x);
      vec3 f = fract(x);

      f = f * f * (3.0 - 2.0 * f);
      float n = p.x + p.y * 57.0 + 113.0 * p.z;

      return mix(
      mix(
        mix(hash(n + 0.0), hash(n + 1.0), f.x),
        mix(hash(n + 57.0), hash(n + 58.0), f.x),
        f.y),
      mix(
        mix(hash(n + 113.0), hash(n + 114.0), f.x),
        mix(hash(n + 170.0), hash(n + 171.0), f.x),
        f.y),
      f.z);
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - noise(mod(tp, numCells));
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv, float tileRows) {
      vec2 tile = floor(uv);
      float z = floor(tileRows * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${x.float(i)});

      float worley0 = worley(p, ${x.float(t)} * 2.0);
      float worley1 = worley(p, ${x.float(t)} * 8.0);
      float worley2 = worley(p, ${x.float(t)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${x.float(t)});
      float worley1 = worley(p, ${x.float(t)} * 2.0);
      float worley2 = worley(p, ${x.float(t)} * 4.0);
      float worley3 = worley(p, ${x.float(t)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `),e.fragment.code.add(x`void main() {
float padWidth = 1.0;
float paddedSize = tileSize + 2.0 * padWidth;
float tileCount = tileRows * tileRows;
vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);
bool padCell = false;
if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
padCell = true;
}
if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
padCell = true;
}
bool startPadX = false;
bool startPadY = false;
bool endPadX = false;
bool endPadY = false;
if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
startPadX = true;
}
if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
startPadY = true;
}
if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
endPadX = true;
}
if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
endPadY = true;
}
vec2 padding = vec2(2.0 * padWidth) * tile;
vec2 uv;
if (padCell) {
vec2 pixel = gl_FragCoord.xy - padWidth - padding;
if (startPadX) {
pixel.x += tileSize;
}
if (startPadY) {
pixel.y += tileSize;
}
if (endPadX) {
pixel.x -= tileSize;
}
if (endPadY) {
pixel.y -= tileSize;
}
uv = vec2(pixel.xy / tileSize);
} else {
vec2 pixel = gl_FragCoord.xy - padWidth - padding;
uv = vec2(pixel.xy / tileSize);
}
vec3 p_ = get3Dfrom2D(uv, tileRows);
vec3 p = p_;
p.z /= (tileRows * tileRows);
float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
float worleyNoise = getTextureForPointWorley(p);
gl_FragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));
p_ = mod(p_ + 1.0, tileRows * tileRows);
p = p_;
p.z /= (tileRows * tileRows);
worleyPerlinNoise = getTextureForPointPerlinWorley(p);
worleyNoise = getTextureForPointWorley(p);
gl_FragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));
gl_FragColor.ba = vec2(0.0, 1.0);
}`),e}const T9e=Object.freeze({__proto__:null,build:x9e});class WF extends Gi{constructor(t){super(t,null,()=>this.destroy())}initializeProgram(t){const i=WF.shader.get().build();return new Mi(t.rctx,i,mi)}initializePipeline(){return Ot({blending:Sc(Ee.ONE,Ee.ZERO),depthTest:{func:Li.LEQUAL},colorWrite:Ft})}}WF.shader=new Ni(T9e,()=>import("./NoiseTextureAtlas.glsl.5ee31e59.js"));class sx{constructor(t,i){this._context=t,this._desc=i,this.type="renderbuffer",this._context.instanceCounter.increment(ks.Renderbuffer,this);const r=this._context.gl;this.glName=r.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:s,height:n,internalFormat:o,multisampled:a}=i;if(a){if(this._context.type!==Kt.WEBGL2)throw new Error("Multisampled renderbuffers are not supported in WebGL1!");r.renderbufferStorageMultisample(r.RENDERBUFFER,this.samples,o,s,n)}else r.renderbufferStorage(r.RENDERBUFFER,o,s,n)}get descriptor(){return this._desc}get samples(){const t=this._desc.samples,i=this._context.parameters.maxSamples;return t?Math.min(t,i):i}resize(t,i){const r=this._desc;if(r.width===t&&r.height===i)return;r.width=t,r.height=i;const s=this._context.gl;this._context.bindRenderbuffer(this),r.multisampled?s.renderbufferStorageMultisample(s.RENDERBUFFER,this.samples,r.internalFormat,r.width,r.height):s.renderbufferStorage(s.RENDERBUFFER,r.internalFormat,r.width,r.height)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(ks.Renderbuffer,this),this._context=null)}}const S9e=he.getLogger("esri.views.webgl.FrameBufferObject");class zi{constructor(t,i,r=null,s=null){if(this._context=t,this._glName=null,this._depthAttachment=null,this._stencilAttachment=null,this._colorAttachments=new Map,this._initialized=!1,this._desc=I({},i),t.instanceCounter.increment(ks.Framebuffer,this),_(r)){Array.isArray(r)||(r=[r]);for(let o=0;o<r.length;++o){const a=r[o],l=ql.COLOR_ATTACHMENT0+o;let c;mee(a)?($f(a)?(c=a.descriptor,this._colorAttachments.set(l,a)):(c=a,this._colorAttachments.set(l,new Qe(this._context,c))),r3(c,this._desc)):(fee(a)?(c=a.descriptor,this._colorAttachments.set(l,a)):(c=a,this._colorAttachments.set(l,new sx(this._context,c))),jU(c,this._desc)),this._validateColorAttachmentPoint(l)}}if(_(s)){let o,a;if(mee(s))this._context.capabilities.depthTexture||console.error("Setting the depth/stencil texture as an attachment requires WEBGL_depth_texture or WebGL2"),$f(s)?(a=s.descriptor,this._depthStencilTexture=s):(a=s,this._depthStencilTexture=new Qe(this._context,a)),r3(a,this._desc);else{var n;fee(s)?(a=s.descriptor,o=s):(a=s,o=new sx(this._context,a));const l=(n=this._desc.depthStencilTarget)!=null?n:ti.DEPTH_STENCIL_RENDER_BUFFER;l===ti.STENCIL_RENDER_BUFFER?this._stencilAttachment=o:l===ti.DEPTH_RENDER_BUFFER||l===ti.DEPTH_STENCIL_RENDER_BUFFER?this._depthAttachment=o:console.error('If a Renderbuffer is provided, "depthStencilTarget" must be one of STENCIL_RENDER_BUFFER, DEPTH_RENDER_BUFFER or DEPTH_STENCIL_RENDER_BUFFER'),jU(a,this._desc)}}}dispose(){if(!this._desc)return;const t=this._context.getBoundFramebufferObject();this._disposeColorAttachments(),this._disposeDepthStencilAttachments(),this._glName&&(this._context.gl.deleteFramebuffer(this._glName),this._glName=null),this._context.bindFramebuffer(t),this._context.instanceCounter.decrement(ks.Framebuffer,this),this._desc=null}get glName(){return this._glName}get descriptor(){return this._desc}get colorTexture(){const t=this._colorAttachments.get(ql.COLOR_ATTACHMENT0);return t&&$f(t)?t:null}get colorAttachment(){return this._colorAttachments.get(ql.COLOR_ATTACHMENT0)}get depthStencilAttachment(){return this._depthStencilTexture||this._depthAttachment||this._stencilAttachment}get depthStencilTexture(){return this._depthStencilTexture}get width(){return this._desc.width}get height(){return this._desc.height}get gpuMemoryUsage(){return[...this._colorAttachments].reduce((t,[i,r])=>t+c0(r),0)+c0(this.depthStencilAttachment)}getColorTexture(t){const i=this._colorAttachments.get(t);return i&&$f(i)?i:null}attachColorTexture(t,i=ql.COLOR_ATTACHMENT0){!t||(this._validateColorAttachmentPoint(i),r3(t.descriptor,this._desc),this._disposeColorAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(t.glName,i)),this._colorAttachments.set(i,t))}detachColorTexture(t=ql.COLOR_ATTACHMENT0){const i=this._colorAttachments.get(t);if($f(i)){const r=i;return this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,t)),this._colorAttachments.delete(t),r}}setColorTextureTarget(t,i=ql.COLOR_ATTACHMENT0){const r=this._colorAttachments.get(i);$f(r)&&this._framebufferTexture2D(r.glName,i,t)}attachDepthStencilTexture(t){if(R(t))return;const i=t.descriptor;i.pixelFormat!==$e.DEPTH_STENCIL&&console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!"),i.dataType!==yt.UNSIGNED_INT_24_8&&console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"),this._context.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture!"),r3(i,this._desc),this._desc.depthStencilTarget&&this._desc.depthStencilTarget!==ti.DEPTH_STENCIL_TEXTURE&&(this._desc.depthStencilTarget=ti.DEPTH_STENCIL_TEXTURE),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(t.glName,MZ)),this._depthStencilTexture=t}detachDepthStencilTexture(){const t=this._depthStencilTexture;return t&&this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,MZ)),this._depthStencilTexture=null,t}attachDepthStencilBuffer(t){if(R(t))return;const i=t.descriptor;if(i.internalFormat!==Bo.DEPTH_STENCIL&&i.internalFormat!==Bo.DEPTH_COMPONENT16&&console.error("Depth/Stencil buffer must have correct internalFormat"),jU(i,this._desc),this._disposeDepthStencilAttachments(),this._desc.depthStencilTarget=i.internalFormat===Bo.DEPTH_STENCIL?ti.DEPTH_STENCIL_RENDER_BUFFER:ti.DEPTH_RENDER_BUFFER,this._initialized){this._context.bindFramebuffer(this);const r=this._context.gl,s=this._desc.depthStencilTarget===ti.DEPTH_RENDER_BUFFER?r.DEPTH_ATTACHMENT:r.DEPTH_STENCIL_ATTACHMENT;r.framebufferRenderbuffer(qs.FRAMEBUFFER,s,r.RENDERBUFFER,t.glName)}this._depthAttachment=t}detachDepthStencilBuffer(){const t=this._context.gl,i=this._depthAttachment;if(i&&this._initialized){this._context.bindFramebuffer(this);const r=this._desc.depthStencilTarget===ti.DEPTH_RENDER_BUFFER?t.DEPTH_ATTACHMENT:t.DEPTH_STENCIL_ATTACHMENT;t.framebufferRenderbuffer(qs.FRAMEBUFFER,r,t.RENDERBUFFER,null)}return this._depthAttachment=null,i}detachAll(){this._colorAttachments.forEach((t,i)=>this._detachColorAttachment(i)),this.detachDepthStencilBuffer(),this.detachDepthStencilTexture()}copyToTexture(t,i,r,s,n,o,a){(t<0||i<0||n<0||o<0)&&console.error("Offsets cannot be negative!"),(r<=0||s<=0)&&console.error("Copy width and height must be greater than zero!");const l=this._desc,c=a.descriptor;a.descriptor.target!==st.TEXTURE_2D&&console.error("Texture target must be TEXTURE_2D!"),(t+r>l.width||i+s>l.height||n+r>c.width||o+s>c.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const h=this._context,p=h.bindTexture(a,Qe.TEXTURE_UNIT_FOR_UPDATES);h.setActiveTexture(Qe.TEXTURE_UNIT_FOR_UPDATES),h.bindFramebuffer(this),h.gl.copyTexSubImage2D(st.TEXTURE_2D,0,n,o,t,i,r,s),h.bindTexture(p,Qe.TEXTURE_UNIT_FOR_UPDATES)}readPixels(t,i,r,s,n,o,a){(r<=0||s<=0)&&console.error("Copy width and height must be greater than zero!"),a||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(t,i,r,s,n,o,a)}async readPixelsAsync(t,i,r,s,n,o,a){if(this._context.type!==Kt.WEBGL2)return cu()&&console.warn("Attempting to read pixels using pixel buffer object without WebGL2"),void this.readPixels(t,i,r,s,n,o,a);const l=this._context.gl,c=jt.createPixelPack(this._context,ri.STREAM_READ,a.byteLength);this._context.bindBuffer(c),this._context.bindFramebuffer(this),l.readPixels(t,i,r,s,n,o,0),this._context.unbindBuffer(ft.PIXEL_PACK_BUFFER),await c.getSubDataAsync(a),c.dispose()}resize(t,i){const r=this._desc;if(r.width!==t||r.height!==i){if(!this._initialized)return r.width=t,r.height=i,this._colorAttachments.forEach(s=>{s&&s.resize(t,i)}),void(this._depthStencilTexture&&this._depthStencilTexture.resize(t,i));r.width=t,r.height=i,this._colorAttachments.forEach(s=>{s&&s.resize(t,i)}),this._depthStencilTexture!=null?this._depthStencilTexture.resize(t,i):(this._depthAttachment||this._stencilAttachment)&&(this._depthAttachment&&this._depthAttachment.resize(t,i),this._stencilAttachment&&this._stencilAttachment.resize(t,i)),this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null),this._initialized=!1}}initializeAndBind(t=qs.FRAMEBUFFER){var i,r,s,n;const o=this._context.gl;if(this._initialized)return void o.bindFramebuffer(t,this.glName);this._glName&&o.deleteFramebuffer(this._glName);const a=this._context,l=o.createFramebuffer(),c=this._desc,h=(i=c.colorTarget)!=null?i:vr.RENDER_BUFFER,p=(r=c.width)!=null?r:1,f=(s=c.height)!=null?s:1;if(o.bindFramebuffer(t,l),this._colorAttachments.size===0)if(h===vr.TEXTURE||h===vr.CUBEMAP)this._colorAttachments.set(ql.COLOR_ATTACHMENT0,E9e(a,c,this.descriptor.colorTarget===vr.CUBEMAP?st.TEXTURE_CUBE_MAP:st.TEXTURE_2D));else{const y=new sx(a,{internalFormat:nt.RGBA4,width:p,height:f});this._colorAttachments.set(ql.COLOR_ATTACHMENT0,y)}this._colorAttachments.forEach((y,v)=>{y&&($f(y)?this._framebufferTexture2D(y.glName,v,gee(y),t):o.framebufferRenderbuffer(t,v,o.RENDERBUFFER,y.glName))});const g=(n=c.depthStencilTarget)!=null?n:ti.NONE;switch(g){case ti.DEPTH_RENDER_BUFFER:case ti.DEPTH_STENCIL_RENDER_BUFFER:{this._depthAttachment||(this._depthAttachment=new sx(a,{internalFormat:c.depthStencilTarget===ti.DEPTH_RENDER_BUFFER?Bo.DEPTH_COMPONENT16:Bo.DEPTH_STENCIL,width:p,height:f}));const y=g===ti.DEPTH_RENDER_BUFFER?o.DEPTH_ATTACHMENT:o.DEPTH_STENCIL_ATTACHMENT;o.framebufferRenderbuffer(t,y,o.RENDERBUFFER,this._depthAttachment.glName);break}case ti.STENCIL_RENDER_BUFFER:this._stencilAttachment||(this._stencilAttachment=new sx(a,{internalFormat:Bo.STENCIL_INDEX8,width:p,height:f})),o.framebufferRenderbuffer(t,o.STENCIL_ATTACHMENT,o.RENDERBUFFER,this._stencilAttachment.glName);break;case ti.DEPTH_STENCIL_TEXTURE:if(!this._depthStencilTexture){a.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture as an attachment!");const y={target:st.TEXTURE_2D,pixelFormat:$e.DEPTH_STENCIL,dataType:yt.UNSIGNED_INT_24_8,samplingMode:Ge.NEAREST,wrapMode:ct.CLAMP_TO_EDGE,width:p,height:f};this._depthStencilTexture=new Qe(a,y)}this._framebufferTexture2D(this._depthStencilTexture.glName,o.DEPTH_STENCIL_ATTACHMENT,gee(this._depthStencilTexture),t)}aR()&&o.checkFramebufferStatus(t)!==o.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=l,this._initialized=!0}_framebufferTexture2D(t,i=ql.COLOR_ATTACHMENT0,r=st.TEXTURE_2D,s=qs.FRAMEBUFFER,n=0){this._context.gl.framebufferTexture2D(s,i,r,t,n)}_detachColorAttachment(t){cu()&&console.warn("Detaching an FBO attachment can be a slow due to invalidating framebuffer completeness!");const i=this._context.gl,r=this._colorAttachments.get(t);return $f(r)?this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,t)):this._initialized&&(this._context.bindFramebuffer(this),i.framebufferRenderbuffer(qs.FRAMEBUFFER,t,i.RENDERBUFFER,null)),this._colorAttachments.delete(t),r}_disposeColorAttachments(){this._colorAttachments.forEach((t,i)=>{this._detachColorAttachment(i),t.dispose()}),this._colorAttachments.clear()}_disposeDepthStencilAttachments(){const t=this._context.gl;if(this._depthAttachment){if(this._initialized){this._context.bindFramebuffer(this);const i=this._desc.depthStencilTarget===ti.DEPTH_RENDER_BUFFER?t.DEPTH_ATTACHMENT:t.DEPTH_STENCIL_ATTACHMENT;t.framebufferRenderbuffer(qs.FRAMEBUFFER,i,t.RENDERBUFFER,null)}this._depthAttachment.dispose(),this._depthAttachment=null}this._stencilAttachment&&(this._initialized&&(this._context.bindFramebuffer(this),t.framebufferRenderbuffer(qs.FRAMEBUFFER,t.STENCIL_ATTACHMENT,t.RENDERBUFFER,null)),this._stencilAttachment.dispose(),this._stencilAttachment=null),this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,t.DEPTH_STENCIL_ATTACHMENT)),this._depthStencilTexture.dispose(),this._depthStencilTexture=null)}_validateColorAttachmentPoint(t){if(zi._MAX_COLOR_ATTACHMENTS===-1){const r=this._context.capabilities.drawBuffers;if(r){const s=this._context.gl;zi._MAX_COLOR_ATTACHMENTS=s.getParameter(r.MAX_COLOR_ATTACHMENTS)}else zi._MAX_COLOR_ATTACHMENTS=1}const i=t-ql.COLOR_ATTACHMENT0;i+1>zi._MAX_COLOR_ATTACHMENTS&&S9e.error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${i+1}. Implementation supports up to ${zi._MAX_COLOR_ATTACHMENTS} color attachments`)}}function $f(e){return"type"in e&&e.type==="texture"}function fee(e){return"type"in e&&e.type==="renderbuffer"}function mee(e){return $f(e)||"pixelFormat"in e}function E9e(e,t,i){return new Qe(e,{target:i,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.NEAREST,wrapMode:ct.CLAMP_TO_EDGE,width:t.width,height:t.height})}function r3(e,t){e.target!==st.TEXTURE_2D&&e.target!==st.TEXTURE_CUBE_MAP&&console.error("Texture type must be TEXTURE_2D or TEXTURE_CUBE_MAP!"),t.width!==void 0&&t.width>=0&&t.height!==void 0&&t.height>=0?t.width===e.width&&t.height===e.height||console.error("Color attachment texture must match the framebuffer's!"):(t.width=e.width,t.height=e.height)}function jU(e,t){t.width!==void 0&&t.width>=0&&t.height!==void 0&&t.height>=0?t.width===e.width&&t.height===e.height||console.error("Renderbuffer dimensions must match the framebuffer's!"):(t.width=e.width,t.height=e.height)}function gee(e){return e.descriptor.target===st.TEXTURE_CUBE_MAP?st.TEXTURE_CUBE_MAP_POSITIVE_X:st.TEXTURE_2D}zi._MAX_COLOR_ATTACHMENTS=-1;const uS=ue("esri-mobile")?64:128,A9e=uS/128,Cq=Math.ceil(Math.sqrt(uS)),wy=(uS+2)*Cq;class C9e{constructor(t,i){this._frameBuffer=new zi(t,{colorTarget:vr.TEXTURE,width:wy,height:wy},{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE,samplingMode:Ge.LINEAR,hasMipmap:!1,width:wy,height:wy}),this._vao=bo(t),this._technique=new WF({rctx:t,viewingMode:i.state.viewingMode})}get textureAtlas(){return this._frameBuffer.colorTexture}destroy(){this._technique=Xi(this._technique),this._frameBuffer=tt(this._frameBuffer),this._vao=tt(this._vao)}render(t){if(R(this._vao)||R(this.textureAtlas))return;const i=t.getViewport();t.setViewport(0,0,wy,wy),t.bindFramebuffer(this._frameBuffer);const r=t.useTechnique(this._technique);r.setUniform1f("tileSize",uS),r.setUniform1f("tileRows",Cq),t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),t.gl.drawArrays(t.gl.TRIANGLE_STRIP,0,4),t.setViewport(i.x,i.y,i.width,i.height)}}var Tu;function R9e(e){const t=new Oi;return t.include(G0,!1),t.fragment.uniforms.add("cloudRadius","float").add("halfCubeMapSize","float").add("power","float").add("sigmaE","float").add("density","float").add("cloudSize","float").add("detailSize","float").add("smoothness","float").add("cloudHeight","float").add("coverage","float").add("view","mat3").add("cloudShapeTexture","sampler2D"),t.fragment.code.add(x`
    const int STEPS = ${e.steps===Tu.SIXTEEN?x`16`:e.steps===Tu.HUNDRED?x`100`:x`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);

    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),t.fragment.code.add(x`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${x.float(wy)};
      const float dataWidth = ${x.float(wy)};
      const float tileRows = ${x.float(Cq)};
      const vec3 atlasDimensions = vec3(${x.float(uS)}, ${x.float(uS)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${x.float(A9e)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture2D(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }`),t.fragment.code.add(x`float clouds(vec3 p) {
float cloudVariations = getCloudShape(0.002 * p, 0.5);
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
cloud += (cloudVariations * 0.6 - 0.3) * ( -4.0 * (coverage * coverage - coverage));
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * saturate(remap(heightFraction, 0.75, 1.0, 1.0, 0.0));
float shape = getCloudShape(cloudSize * p, 0.0);
shape *= mix(0.0, 1.0, min(2.0 * (1.0 - coverage), 1.0));
cloud = saturate(remap(cloud, shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),t.fragment.code.add(x`vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = dot(start, start) - (radius * radius);
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}
float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}`),t.fragment.code.add(`
    vec3 multipleOctaves(float extinction, float mu, float stepL) {
      float attenuation = 1.0;
      float contribution = 1.0;
      float phaseAttenuation = 1.0;
      vec3 luminance = vec3(0);

      for (int i = 0; i < 4; i++) {
        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
        attenuation *= 0.2;
        contribution *= 0.6;
        phaseAttenuation *= 0.5;
      }

      return luminance;
    }`),t.fragment.code.add(x`vec3 lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
vec3 beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),t.fragment.code.add(x`vec3 mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return vec3(0);
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
vec3 color = vec3(0.0);
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
vec3 luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
color += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return color;
}`),t.fragment.code.add(x`void main() {
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
if (hitsPlanet) {
gl_FragColor = vec4(vec3(0), 1);
return;
}
vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);
vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
float totalTransmittance = 1.0;
vec3 sunDirection = normalize(vec3(0, 0, 1));
vec3 col = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance).rgb;
gl_FragColor = vec4(col, totalTransmittance);
}`),t}(function(e){e[e.SIXTEEN=0]="SIXTEEN",e[e.HUNDRED=1]="HUNDRED",e[e.TWOHUNDRED=2]="TWOHUNDRED",e[e.COUNT=3]="COUNT"})(Tu||(Tu={}));const O9e=Object.freeze({__proto__:null,get RayMarchingSteps(){return Tu},build:R9e});class I2{constructor(t,i,r,s,n,o,a,l,c=.5){this.coverage=t,this.density=i,this.absorption=r,this.cloudSize=s,this.detailSize=n,this.smoothness=o,this.cloudHeight=a,this.raymarchingStepType=l,this.median=c}}const Vge={sunny:new I2([.1,.7],[.02,.02],[0,0],[.86,.86],[.8,.8],[.5,.5],[.05,.05],Tu.SIXTEEN),cloudy:new I2([.24,.7],[.135,.2],[0,0],[.5,.5],[.65,.7],[.3,.3],[1,1],Tu.TWOHUNDRED),rainy:new I2([.5,.9],[.2,.5],[.3,.6],[.4,.4],[.7,.7],[.5,.5],[1,1],Tu.TWOHUNDRED),snowy:new I2([.5,.9],[.2,.5],[0,0],[.4,.4],[.7,.7],[.5,.5],[1,1],Tu.TWOHUNDRED),foggy:new I2([.8,.8],[.5,.5],[0,0],[.85,.85],[.75,.75],[.8,.8],[.3,.3],Tu.HUNDRED)};class XF extends Gi{constructor(t,i){super(t,i,()=>this.destroy())}initializeProgram(t){const i=XF.shader.get().build({steps:this.configuration.steps});return new Mi(t.rctx,i,mi)}initializePipeline(){return Ot({blending:Xn(Ee.ONE,Ee.ONE,Ee.ZERO,Ee.ZERO),depthTest:{func:Li.LEQUAL},colorWrite:Ft})}}XF.shader=new Ni(O9e,()=>import("./Clouds.glsl.3df274ee.js"));class Gge extends mr{constructor(){super(...arguments),this.steps=Tu.SIXTEEN}}u([Z({count:Tu.COUNT})],Gge.prototype,"steps",void 0);let Oo=class extends we{constructor(e){super(e),this._frameTask=null,this._handles=new Ut,this._cubeMapSize=ue("esri-mobile")?1024:2048,this._techniques=[],this._techniqueConfiguration=new Gge,this.coverage=qt(Xo.coverage[0],Xo.coverage[1],.5),this.density=qt(Xo.density[0],Xo.density[1],.5),this.absorption=qt(Xo.absorption[0],Xo.absorption[1],.5),this.cloudSize=qt(Xo.cloudSize[0],Xo.cloudSize[1],.5),this.detailSize=qt(Xo.detailSize[0],Xo.detailSize[1],.5),this.smoothness=qt(Xo.smoothness[0],Xo.smoothness[1],.5),this.cloudHeight=qt(Xo.cloudHeight[0],Xo.cloudHeight[1],.5),this.raymarchingStepType=Xo.raymarchingStepType,this._cloudRadius=0,this._viewMatrix=Te(),this._viewMatrix3=wr(),this.running=!1}_getTechnique(e){return this._techniques[e]||(this._techniqueConfiguration.steps=e,this._techniques[e]=new XF({rctx:this.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[e])}initialize(){this._vao=bo(this.rctx);const e=di(this.view.spatialReference);this._cloudRadius=.5*e.radius,this.setDirty(),this._frameTask=this.view.resourceController.scheduler.registerTask(ht.CLOUDS_GENERATOR,this),this._handles.add(this._frameTask),this._handles.add(Wt(this,"coverage",()=>this.setDirty())),["coverage","density","absorption","cloudSize","detailSize","smoothness","cloudHeight","raymarchingStepType"].forEach(t=>this._handles.add(Wt(this,t,()=>this.setDirty())))}destroy(){this._handles.destroy(),this._techniques.forEach(e=>Xi(e)),this._techniques=null,this._frameBufferCube=tt(this._frameBufferCube),this._vao=tt(this._vao),this._noiseTexture=rt(this._noiseTexture)}_ensureNoiseTexture(){return R(this._noiseTexture)&&(this._noiseTexture=new C9e(this.rctx,this.view),this._noiseTexture.render(this.rctx)),this._noiseTexture.textureAtlas}get frameBufferCube(){if(R(this._frameBufferCube)){const e={target:st.TEXTURE_CUBE_MAP,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE,samplingMode:Ge.LINEAR,hasMipmap:!1,width:this._cubeMapSize,height:this._cubeMapSize};this._frameBufferCube=new zi(this.rctx,{colorTarget:vr.CUBEMAP,width:this._cubeMapSize,height:this._cubeMapSize},e)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}applyPreset(e,t){const i=e.median,r=s=>{const n=qt(s[0],s[1],i);return t<.5?qt(s[0],n,2*t):qt(n,s[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingStepType=e.raymarchingStepType}setDirty(){this.running=!0}runTask(e){if(this.coverage===0||R(this._vao))return void(this.running=!1);const t=this._ensureNoiseTexture();if(R(t))return void(this.running=!1);const i=this._getTechnique(this.raymarchingStepType);if(!this.rctx.isTechniqueCompiled(i))return;const r=this.rctx.getViewport();this.rctx.setViewport(0,0,this._cubeMapSize,this._cubeMapSize),this.rctx.bindFramebuffer(this.frameBufferCube);const s=this.rctx.useTechnique(i),n=1+this.absorption,o=qt(35,120,this.absorption);s.bindTexture(t,"cloudShapeTexture"),s.setUniform1f("cloudRadius",this._cloudRadius),s.setUniform1f("halfCubeMapSize",.5*this._cubeMapSize),s.setUniform1f("power",o),s.setUniform1f("sigmaE",n),s.setUniform1f("density",qt(0,.3,this.density)),s.setUniform1f("cloudSize",qt(0,.02,Math.max(.01,1-this.cloudSize))),s.setUniform1f("detailSize",qt(0,.2,Math.max(.01,1-this.detailSize))),s.setUniform1f("smoothness",qt(0,.5,1-this.smoothness)),s.setUniform1f("cloudHeight",qt(0,1500,this.cloudHeight)),s.setUniform1f("coverage",this.coverage),this.rctx.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao);for(let a=0;a<5;a++){const l=M9e[a],c=P9e[a];Xce(this._viewMatrix,I9e,l,c),Lu(this._viewMatrix3,this._viewMatrix),s.setUniformMatrix3fv("view",this._viewMatrix3);const h=st.TEXTURE_CUBE_MAP_POSITIVE_X+a;this.frameBufferCube.setColorTextureTarget(h),this.rctx.gl.drawArrays(this.rctx.gl.TRIANGLE_STRIP,0,4),this.rctx.gl.flush()}this.running=!1,this.rctx.setViewport(r.x,r.y,r.width,r.height),this.requestRender(),e.madeProgress()}};u([d({constructOnly:!0})],Oo.prototype,"rctx",void 0),u([d({constructOnly:!0})],Oo.prototype,"view",void 0),u([d({constructOnly:!0})],Oo.prototype,"requestRender",void 0),u([d()],Oo.prototype,"_frameTask",void 0),u([d()],Oo.prototype,"coverage",void 0),u([d()],Oo.prototype,"density",void 0),u([d()],Oo.prototype,"absorption",void 0),u([d()],Oo.prototype,"cloudSize",void 0),u([d()],Oo.prototype,"detailSize",void 0),u([d()],Oo.prototype,"smoothness",void 0),u([d()],Oo.prototype,"cloudHeight",void 0),u([d()],Oo.prototype,"raymarchingStepType",void 0),u([d()],Oo.prototype,"running",void 0),Oo=u([P("esri.views.3d.environment.CloudsGenerator")],Oo);const M9e=[Ht(1,0,0),Ht(-1,0,0),Ht(0,1,0),Ht(0,-1,0),Ht(0,0,1)],P9e=[Ht(0,1,0),Ht(0,1,0),Ht(0,0,-1),Ht(0,0,1),Ht(0,1,0)],I9e=yq(),Xo=Vge.sunny;function $9e(e){const t=new Oi;return t.attributes.add(E.POSITION,"vec2"),t.include(gm,{attributeTextureCoordinates:_n.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3"),t.vertex.uniforms.add("inverseProjectionMatrix","mat4"),t.vertex.uniforms.add("inverseViewMatrix","mat4"),t.vertex.code.add(x`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),t.fragment.uniforms.add("atmosphereC","float").add("cameraPosition","vec3").add("nearFar","vec2").add("depthTex","sampler2D").add("fogStrength","float").add("fogAmount","float").add("fogColor","vec3"),t.include(BF),t.fragment.include(Os),t.fragment.code.add(x`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * atmosphereC;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),t.fragment.code.add(x`vec4 applyFog(float dist, vec3 rayDir){
if(dist == -1.0){
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);
dist = 0.055 * rayAtmosphereIntersect.y;
}
float fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));
return vec4(fogAmount * fogColor, fogAmount);
}`),t.fragment.code.add(x`
    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture2D(depthTex, vuv0).r;
      float zNorm = 2.0 * depthSample - 1.0;
      float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));
      if(depthSample < 1.0 && depthSample > 0.0){
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;
        cameraSpaceRay *= linDepth;
        terrainDepth = max(0.0, length(cameraSpaceRay));
      }

      ${e.haze?x`
          if(terrainDepth == -1.0){
            gl_FragColor = vec4(0);
            return;
          }`:""}

      vec4 fog = applyFog(terrainDepth, rayDir);

      gl_FragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));
    }
  `),t}const D9e=Object.freeze({__proto__:null,build:$9e});class dR extends Gi{initializeProgram(t){const i=dR.shader.get(),r=this.configuration,s=i.build({haze:r.haze});return new Mi(t.rctx,s,mi)}initializePipeline(){return this.configuration.haze?Ot({blending:Xn(Ee.ONE,Ee.ZERO,Ee.ONE_MINUS_SRC_COLOR,Ee.ONE),colorWrite:Ft}):Ot({blending:Xn(Ee.SRC_ALPHA,Ee.ZERO,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE),colorWrite:Ft})}}dR.shader=new Ni(D9e,()=>import("./Fog.glsl.93b6e6be.js"));class M9 extends mr{constructor(){super(...arguments),this.haze=!1}}u([Z()],M9.prototype,"haze",void 0);let bA=class extends we{constructor(e){super(e),this._projectionInverse=Te(),this._viewInverse=Te(),this._nearFar=Ye(),this._fogColor=fi(),this._fogColorAtNight=fi(),this._cameraDirection=fi(),this._foggyFadeStart=.3,this._foggyFadeEnd=.6,this._hazeFadeStart=.7,this._hazeFadeEnd=1,this._strength=4e-6;const t=e.context.renderContext.rctx;this._vao=bo(t,RO);const i=di(e.view.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+h$}destroy(){this._hazeFogTechnique=Xi(this._hazeFogTechnique),this._thickFogTechnique=Xi(this._thickFogTechnique),this._vao=tt(this._vao)}get _shaderTechniqueRepository(){return this.context.shaderTechniqueRepository}set strength(e){this._strength=e}get strength(){return this._strength}get thickFogTechnique(){if(R(this._thickFogTechnique)){const e=new M9;e.haze=!1,this._thickFogTechnique=this._shaderTechniqueRepository.acquire(dR,e)}return this._thickFogTechnique}get hazeFogTechnique(){if(R(this._hazeFogTechnique)){const e=new M9;e.haze=!0,this._hazeFogTechnique=this._shaderTechniqueRepository.acquire(dR,e)}return this._hazeFogTechnique}when(){return Promise.resolve()}render(e,t,i){if(this.view.basemapTerrain.baseOpacity===0&&!t||(this._update(e,t,i),this._fogAmount<=0))return;const r=e.offscreenRenderingHelper,s=t?this.thickFogTechnique:this.hazeFogTechnique,n=e.rctx.useTechnique(s);r.renderDepthDetached(()=>{n.bindTexture(r.depthTexture,"depthTex"),this._renderFog(s.program,e)})}_renderFog(e,t){if(R(this._vao))return!1;const i=t.rctx;return e.setUniform3fv("cameraPosition",t.camera.eye),e.setUniformMatrix4fv("inverseProjectionMatrix",this._projectionInverse),e.setUniformMatrix4fv("inverseViewMatrix",this._viewInverse),e.setUniform2fv("nearFar",this._nearFar),e.setUniform1f("atmosphereC",this._atmosphereC),e.setUniform1f("fogStrength",this._strength),e.setUniform1f("fogAmount",this._fogAmount),e.setUniform3fv("fogColor",this._fogColor),i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(Tt.TRIANGLE_STRIP,0,4),!0}_update(e,t,i){if(R(e.camera))return;const r=t?.1:0;i?oe(this._fogColor,.5,.5,.5):t?oe(this._fogColor,1.5,1.5,1.5):oe(this._fogColor,.24,.44,.8),ae(this._fogColorAtNight,this._fogColor,r),be(this._cameraDirection,e.camera.eye);const s=Math.max(0,_e(this._cameraDirection,e.scenelightingData.lightingMainDirection));Cs(this._fogColor,this._fogColorAtNight,this._fogColor,s),fr(this._projectionInverse,e.camera.projectionMatrix),fr(this._viewInverse,e.camera.viewMatrix),rr(this._nearFar,e.camera.near,e.camera.far);const n=Pe(e.camera.eye),o=n*n;this._atmosphereC=o-this._atmosphereRadius*this._atmosphereRadius,this._fogAmount=t?1-TT(this._foggyFadeStart*pu,this._foggyFadeEnd*pu,Math.abs(n-this._planetRadius)):1-TT(this._hazeFadeStart*pu,this._hazeFadeEnd*pu,Math.abs(n-this._planetRadius))}static isSupported(e){return e.capabilities.depthTexture}};u([d({constructOnly:!0})],bA.prototype,"context",void 0),u([d({constructOnly:!0})],bA.prototype,"view",void 0),bA=u([P("esri.views.3d.environment.Fog")],bA);async function Fu(e,t){const{data:i}=await Ti(e,I({responseType:"image"},t));return i}function Gn(e,t){const i=I({hasModelTransformation:!1},t);if(i.hasModelTransformation)return i.linearDepth?void e.vertex.code.add(x`vec4 transformPositionWithDepth(mat4 proj, mat4 view, mat4 model, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * (model * vec4(pos, 1.0));
depth = (-eye.z - nearFar[0]) / (nearFar[1] - nearFar[0]) ;
return proj * eye;
}`):void e.vertex.code.add(x`vec4 transformPosition(mat4 proj, mat4 view, mat4 model, vec3 pos) {
return proj * (view * (model * vec4(pos, 1.0)));
}`);i.linearDepth?e.vertex.code.add(x`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = (-eye.z - nearFar[0]) / (nearFar[1] - nearFar[0]) ;
return proj * eye;
}`):e.vertex.code.add(x`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)}var td;function L9e(e){const t=new Oi;if(e.geometry===td.Underground)t.attributes.add(E.POSITION,"vec2"),t.varyings.add("color","vec4"),t.vertex.uniforms.add("lightingMainDirection","vec3").add("cameraPosition","vec3").add("undergroundFadeAlpha","float"),t.vertex.code.add(x`void main(void) {
float ndotl = dot(normalize(cameraPosition), lightingMainDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),t.fragment.code.add(x`void main() {
gl_FragColor = color;
}`);else{t.include(Gn,{linearDepth:!1}),t.attributes.add(E.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const i=e.geometry===td.Cylinder;t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("lightingMainDirection","vec3"),i||(t.varyings.add("innerFactor","float"),t.vertex.uniforms.add("silCircleCenter","vec3").add("silCircleV1","vec3").add("silCircleV2","vec3").add("texV","vec2").add("innerScale","float"));const r=6.2831853,s=1/128;t.vertex.code.add(x`
		void main(void) {
      ${i?x`
      vec3 pos = position;
      float ndotl = lightingMainDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:x`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${x.float(r*s)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), lightingMainDirection);
      vtc.x = position.x  * ${x.float(s)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),t.fragment.uniforms.add("tex","sampler2D"),i||t.fragment.uniforms.add("altitudeFade","float"),t.fragment.code.add(x`
		void main() {
			vec4 atmosphereColor = texture2D(tex, vtc) * falloff;
      ${i?x`gl_FragColor = atmosphereColor;`:x`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return t}(function(e){e[e.Cone=0]="Cone",e[e.Cylinder=1]="Cylinder",e[e.Underground=2]="Underground",e[e.COUNT=3]="COUNT"})(td||(td={}));const N9e=Object.freeze({__proto__:null,get SimpleAtmosphereGeometry(){return td},build:L9e});class hS extends Gi{initializeProgram(t){const i=hS.shader.get(),r=this.configuration,s=i.build({geometry:r.geometry});return new Mi(t.rctx,s,mi)}initializePipeline(){return this.configuration.geometry===td.Cylinder?Ot({blending:Xn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),culling:dq,depthTest:{func:Li.LEQUAL},colorWrite:Ft}):Ot({blending:Xn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:Li.LEQUAL},colorWrite:Ft})}}hS.shader=new Ni(N9e,()=>import("./SimpleAtmosphere.glsl.6e419ac7.js"));class xL extends mr{constructor(){super(...arguments),this.geometry=td.Cone}}u([Z({count:td.COUNT})],xL.prototype,"geometry",void 0);const jge="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAABD1gYFAAAACXBIWXMAAC4jAAAuIwF4pT92AAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAXVJREFUeNq0k9GWhDAIQ3PjzP9/cuehFqhW19mz++IhkCZAq1prsqT+kSQS9g8Vnqp6VGVWkYVktR6tj3Gr968nLnfwlHzHYyHapkKS73bPd/39eI38AYWj24OGvqdwWjZ3l8IDgacXyl1Dj9tdLOzZiicj+P1YcGk0H2O2vN/VQpTveEHmPHQxZxYlqsQdhUeuCWREuDEvAjqlCqDIMYwIo2ijR1HdYUS58dQrKpgQ0EGeMocsTNXrxzyOhS9kfzlWjn82YuWLqwAnvfNEWJFjYXkJCT0s7AmS0NG4x7Lt6Cpy2MiVPBZmS668QT5AR1cevp7b6CpzQ/ZSNH0vmhy5CsNtdax0MBpXDBiFsrDiMSLKMc8b6hH93bNbEpRsIyHDUhNcfTyeKF16PC7c/2QdczvUnvOB1ylZHVFSMtd5s8C2IW/7w6hwM5GLavLCd1zkiFjB+BwH1DSgctQ7mPOimBLJrw35beSXkd8BM/cCqbXWPgMA+GQQ5sIgkfAAAAAASUVORK5CYII=";function Rl(e,t=0){const i=e.stride;return e.fieldNames.filter(r=>{const s=e.fields.get(r).optional;return!(s&&s.glPadding)}).map(r=>{const s=e.fields.get(r),n=s.constructor.ElementCount,o=F9e(s.constructor.ElementType),a=s.offset,l=!(!s.optional||!s.optional.glNormalized);return new bn(r,n,o,a,i,l,t)})}function F9e(e){const t=U9e[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}const U9e={u8:ot.UNSIGNED_BYTE,u16:ot.UNSIGNED_SHORT,u32:ot.UNSIGNED_INT,i8:ot.BYTE,i16:ot.SHORT,i32:ot.INT,f32:ot.FLOAT};class Rq{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=9;const o=this.TypedArrayConstructor;s===void 0&&(s=9*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getMat(t,i){let r=t*this.typedBufferStride;for(let s=0;s<9;s++)i[s]=this.typedBuffer[r++];return i}setMat(t,i){let r=t*this.typedBufferStride;for(let s=0;s<9;s++)this.typedBuffer[r++]=i[s]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;for(let l=0;l<9;++l)s[o++]=n[a++]}get buffer(){return this.typedBuffer.buffer}}Rq.ElementCount=9;class Oq{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=16;const o=this.TypedArrayConstructor;s===void 0&&(s=16*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getMat(t,i){let r=t*this.typedBufferStride;for(let s=0;s<16;s++)i[s]=this.typedBuffer[r++];return i}setMat(t,i){let r=t*this.typedBufferStride;for(let s=0;s<16;s++)this.typedBuffer[r++]=i[s]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;for(let l=0;l<16;++l)s[o++]=n[a++]}get buffer(){return this.typedBuffer.buffer}}Oq.ElementCount=16;class qm{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=1;const o=this.TypedArrayConstructor;s===void 0&&(s=o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}get(t){return this.typedBuffer[t*this.typedBufferStride]}set(t,i){this.typedBuffer[t*this.typedBufferStride]=i}get buffer(){return this.typedBuffer.buffer}}qm.ElementCount=1;class Wm{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=2;const o=this.TypedArrayConstructor;s===void 0&&(s=2*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getVec(t,i){return t*=this.typedBufferStride,rr(i,this.typedBuffer[t],this.typedBuffer[t+1])}setVec(t,i){t*=this.typedBufferStride,this.typedBuffer[t++]=i[0],this.typedBuffer[t]=i[1]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}setValues(t,i,r){t*=this.typedBufferStride,this.typedBuffer[t++]=i,this.typedBuffer[t]=r}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}}Wm.ElementCount=2;class Xm{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=3;const o=this.TypedArrayConstructor;s===void 0&&(s=3*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getVec(t,i){return t*=this.typedBufferStride,oe(i,this.typedBuffer[t],this.typedBuffer[t+1],this.typedBuffer[t+2])}setVec(t,i){t*=this.typedBufferStride,this.typedBuffer[t++]=i[0],this.typedBuffer[t++]=i[1],this.typedBuffer[t]=i[2]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}setValues(t,i,r,s){t*=this.typedBufferStride,this.typedBuffer[t++]=i,this.typedBuffer[t++]=r,this.typedBuffer[t]=s}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;s[o++]=n[a++],s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}}Xm.ElementCount=3;class Ym{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=4;const o=this.TypedArrayConstructor;s===void 0&&(s=4*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getVec(t,i){return t*=this.typedBufferStride,Ho(i,this.typedBuffer[t++],this.typedBuffer[t++],this.typedBuffer[t++],this.typedBuffer[t])}setVec(t,i){t*=this.typedBufferStride,this.typedBuffer[t++]=i[0],this.typedBuffer[t++]=i[1],this.typedBuffer[t++]=i[2],this.typedBuffer[t]=i[3]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}setValues(t,i,r,s,n){t*=this.typedBufferStride,this.typedBuffer[t++]=i,this.typedBuffer[t++]=r,this.typedBuffer[t++]=s,this.typedBuffer[t]=n}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;s[o++]=n[a++],s[o++]=n[a++],s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}}Ym.ElementCount=4;class MO extends qm{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}static fromTypedArray(t,i){return new MO(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}MO.ElementType="f32";class Uu extends Wm{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(Uu,t,i)}static fromTypedArray(t,i){return new Uu(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Uu.ElementType="f32";class Si extends Xm{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(Si,t,i)}static fromTypedArray(t,i){return new Si(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Si.ElementType="f32";class rn extends Ym{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(rn,t,i)}static fromTypedArray(t,i){return new rn(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}rn.ElementType="f32";class id extends Rq{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(id,t,i)}static fromTypedArray(t,i){return new id(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}id.ElementType="f32";class T0 extends Rq{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(T0,t,i)}static fromTypedArray(t,i){return new T0(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}T0.ElementType="f64";class dS extends Oq{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(dS,t,i)}static fromTypedArray(t,i){return new dS(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}dS.ElementType="f32";class S0 extends Oq{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(S0,t,i)}static fromTypedArray(t,i){return new S0(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}S0.ElementType="f64";class pS extends qm{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(pS,t,i)}static fromTypedArray(t,i){return new pS(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}pS.ElementType="f64";class fS extends Wm{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(fS,t,i)}static fromTypedArray(t,i){return new fS(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}fS.ElementType="f64";class Xr extends Xm{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(Xr,t,i)}static fromTypedArray(t,i){return new Xr(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Xr.ElementType="f64";class z1 extends Ym{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(z1,t,i)}static fromTypedArray(t,i){return new z1(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}z1.ElementType="f64";class $m extends qm{constructor(t,i=0,r,s){super(Uint8Array,t,i,r,s),this.elementType="u8"}slice(t,i){return this.sliceBuffer($m,t,i)}static fromTypedArray(t,i){return new $m(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}$m.ElementType="u8";class B1 extends Wm{constructor(t,i=0,r,s){super(Uint8Array,t,i,r,s),this.elementType="u8"}slice(t,i){return this.sliceBuffer(B1,t,i)}static fromTypedArray(t,i){return new B1(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}B1.ElementType="u8";class E0 extends Xm{constructor(t,i=0,r,s){super(Uint8Array,t,i,r,s),this.elementType="u8"}slice(t,i){return this.sliceBuffer(E0,t,i)}static fromTypedArray(t,i){return new E0(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}E0.ElementType="u8";class Pa extends Ym{constructor(t,i=0,r,s){super(Uint8Array,t,i,r,s),this.elementType="u8"}slice(t,i){return this.sliceBuffer(Pa,t,i)}static fromTypedArray(t,i){return new Pa(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Pa.ElementType="u8";class V1 extends qm{constructor(t,i=0,r,s){super(Uint16Array,t,i,r,s),this.elementType="u16"}slice(t,i){return this.sliceBuffer(V1,t,i)}static fromTypedArray(t,i){return new V1(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}V1.ElementType="u16";class mS extends Wm{constructor(t,i=0,r,s){super(Uint16Array,t,i,r,s),this.elementType="u16"}slice(t,i){return this.sliceBuffer(mS,t,i)}static fromTypedArray(t,i){return new mS(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}mS.ElementType="u16";class G1 extends Xm{constructor(t,i=0,r,s){super(Uint16Array,t,i,r,s),this.elementType="u16"}slice(t,i){return this.sliceBuffer(G1,t,i)}static fromTypedArray(t,i){return new G1(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}G1.ElementType="u16";class A0 extends Ym{constructor(t,i=0,r,s){super(Uint16Array,t,i,r,s),this.elementType="u16"}slice(t,i){return this.sliceBuffer(A0,t,i)}static fromTypedArray(t,i){return new A0(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}A0.ElementType="u16";class j1 extends qm{constructor(t,i=0,r,s){super(Uint32Array,t,i,r,s),this.elementType="u32"}slice(t,i){return this.sliceBuffer(j1,t,i)}static fromTypedArray(t,i){return new j1(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}j1.ElementType="u32";class gS extends Wm{constructor(t,i=0,r,s){super(Uint32Array,t,i,r,s),this.elementType="u32"}slice(t,i){return this.sliceBuffer(gS,t,i)}static fromTypedArray(t,i){return new gS(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}gS.ElementType="u32";class pR extends Xm{constructor(t,i=0,r,s){super(Uint32Array,t,i,r,s),this.elementType="u32"}slice(t,i){return this.sliceBuffer(pR,t,i)}static fromTypedArray(t,i){return new pR(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}pR.ElementType="u32";class fR extends Ym{constructor(t,i=0,r,s){super(Uint32Array,t,i,r,s),this.elementType="u32"}slice(t,i){return this.sliceBuffer(fR,t,i)}static fromTypedArray(t,i){return new fR(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}fR.ElementType="u32";class yS extends qm{constructor(t,i=0,r,s){super(Int8Array,t,i,r,s),this.elementType="i8"}slice(t,i){return this.sliceBuffer(yS,t,i)}static fromTypedArray(t,i){return new yS(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}yS.ElementType="i8";class H1 extends Wm{constructor(t,i=0,r,s){super(Int8Array,t,i,r,s),this.elementType="i8"}slice(t,i){return this.sliceBuffer(H1,t,i)}static fromTypedArray(t,i){return new H1(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}H1.ElementType="i8";class mR extends Xm{constructor(t,i=0,r,s){super(Int8Array,t,i,r,s),this.elementType="i8"}slice(t,i){return this.sliceBuffer(mR,t,i)}static fromTypedArray(t,i){return new mR(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}mR.ElementType="i8";class gR extends Ym{constructor(t,i=0,r,s){super(Int8Array,t,i,r,s),this.elementType="i8"}slice(t,i){return this.sliceBuffer(gR,t,i)}static fromTypedArray(t,i){return new gR(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}gR.ElementType="i8";class yR extends qm{constructor(t,i=0,r,s){super(Int16Array,t,i,r,s),this.elementType="i16"}slice(t,i){return this.sliceBuffer(yR,t,i)}static fromTypedArray(t,i){return new yR(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}yR.ElementType="i16";class q1 extends Wm{constructor(t,i=0,r,s){super(Int16Array,t,i,r,s),this.elementType="i16"}slice(t,i){return this.sliceBuffer(q1,t,i)}static fromTypedArray(t,i){return new q1(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}q1.ElementType="i16";class vR extends Xm{constructor(t,i=0,r,s){super(Int16Array,t,i,r,s),this.elementType="i16"}slice(t,i){return this.sliceBuffer(vR,t,i)}static fromTypedArray(t,i){return new vR(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}vR.ElementType="i16";class _R extends Ym{constructor(t,i=0,r,s){super(Int16Array,t,i,r,s),this.elementType="i16"}slice(t,i){return this.sliceBuffer(_R,t,i)}static fromTypedArray(t,i){return new _R(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}_R.ElementType="i16";class bR extends qm{constructor(t,i=0,r,s){super(Int32Array,t,i,r,s),this.elementType="i32"}slice(t,i){return this.sliceBuffer(bR,t,i)}static fromTypedArray(t,i){return new bR(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}bR.ElementType="i32";class wR extends Wm{constructor(t,i=0,r,s){super(Int32Array,t,i,r,s),this.elementType="i32"}slice(t,i){return this.sliceBuffer(wR,t,i)}static fromTypedArray(t,i){return new wR(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}wR.ElementType="i32";class xR extends Xm{constructor(t,i=0,r,s){super(Int32Array,t,i,r,s),this.elementType="i32"}slice(t,i){return this.sliceBuffer(xR,t,i)}static fromTypedArray(t,i){return new xR(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}xR.ElementType="i32";class TR extends Ym{constructor(t,i=0,r,s){super(Int32Array,t,i,r,s),this.elementType="i32"}slice(t,i){return this.sliceBuffer(TR,t,i)}static fromTypedArray(t,i){return new TR(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}TR.ElementType="i32";function Hge(e){switch(e){case"u8":case"i8":return 1;case"u16":case"i16":return 2;case"u32":case"i32":case"f32":return 4;case"f64":return 8;default:return}}function k9e(e){switch(e){case"u8":case"u16":case"u32":return!1;case"i8":case"i16":case"i32":case"f32":case"f64":return!0;default:return}}function z9e(e){switch(e){case"u8":case"u16":case"u32":case"i8":case"i16":case"i32":return!0;case"f32":case"f64":return!1;default:return}}function B9e(e){switch(e){case"u8":return 255;case"u16":return 65535;case"u32":return 4294967295;case"i8":return 127;case"i16":return 32767;case"i32":return 2147483647;case"f32":return 3402823e32;case"f64":return 179769e303;default:return}}class TL{constructor(t,i){this.layout=t,this.buffer=typeof i=="number"?new ArrayBuffer(i*t.stride):i;for(const r of t.fieldNames){const s=t.fields.get(r);this[r]=new s.constructor(this.buffer,s.offset,this.stride)}}get stride(){return this.layout.stride}get count(){return this.buffer.byteLength/this.stride}get byteLength(){return this.buffer.byteLength}getField(t,i){const r=this[t];return r&&r.elementCount===i.ElementCount&&r.elementType===i.ElementType?r:null}slice(t,i){return new TL(this.layout,this.buffer.slice(t*this.stride,i*this.stride))}copyFrom(t,i,r,s){const n=this.stride;if(n%4==0){const o=new Uint32Array(t.buffer,i*n,s*n/4);new Uint32Array(this.buffer,r*n,s*n/4).set(o)}else{const o=new Uint8Array(t.buffer,i*n,s*n);new Uint8Array(this.buffer,r*n,s*n).set(o)}}}class Mq{constructor(){this.stride=0,this.fields=new Map,this.fieldNames=[]}vec2f(t,i){return this._appendField(t,Uu,i),this}vec2f64(t,i){return this._appendField(t,fS,i),this}vec3f(t,i){return this._appendField(t,Si,i),this}vec3f64(t,i){return this._appendField(t,Xr,i),this}vec4f(t,i){return this._appendField(t,rn,i),this}vec4f64(t,i){return this._appendField(t,z1,i),this}mat3f(t,i){return this._appendField(t,id,i),this}mat3f64(t,i){return this._appendField(t,T0,i),this}mat4f(t,i){return this._appendField(t,dS,i),this}mat4f64(t,i){return this._appendField(t,S0,i),this}vec4u8(t,i){return this._appendField(t,Pa,i),this}f32(t,i){return this._appendField(t,MO,i),this}f64(t,i){return this._appendField(t,pS,i),this}u8(t,i){return this._appendField(t,$m,i),this}u16(t,i){return this._appendField(t,V1,i),this}i8(t,i){return this._appendField(t,yS,i),this}vec2i8(t,i){return this._appendField(t,H1,i),this}vec2i16(t,i){return this._appendField(t,q1,i),this}vec2u8(t,i){return this._appendField(t,B1,i),this}vec4u16(t,i){return this._appendField(t,A0,i),this}u32(t,i){return this._appendField(t,j1,i),this}_appendField(t,i,r){const s=i.ElementCount*Hge(i.ElementType),n=this.stride;this.fields.set(t,{size:s,constructor:i,offset:n,optional:r}),this.stride+=s,this.fieldNames.push(t)}alignTo(t){return this.stride=Math.floor((this.stride+t-1)/t)*t,this}hasField(t){return this.fieldNames.indexOf(t)>=0}createBuffer(t){return new TL(this,t)}createView(t){return new TL(this,t)}clone(){const t=new Mq;return t.stride=this.stride,t.fields=new Map,this.fields.forEach((i,r)=>t.fields.set(r,i)),t.fieldNames=this.fieldNames.slice(),t.BufferType=this.BufferType,t}}function kr(){return new Mq}function j0(e,t,i){e.setUniform3f("cameraPosition",i[3]-t[0],i[7]-t[1],i[11]-t[2])}function Ol(e,t){e.setUniformMatrix4fv("proj",t)}function qge(e,t,i){Wo(yee,i,t),e.setUniform3fv("localOrigin",t),e.setUniformMatrix4fv("view",yee)}function Gp(e,t){qge(e,t.origin,t.camera.viewMatrix)}function Wge(e,t){e.setUniform4fv("viewport",t.camera.fullViewport)}const yee=EO();var P9;(function(e){function t(o,a){const l=o[a],c=o[a+1],h=o[a+2];return Math.sqrt(l*l+c*c+h*h)}function i(o,a){const l=o[a],c=o[a+1],h=o[a+2],p=1/Math.sqrt(l*l+c*c+h*h);o[a]*=p,o[a+1]*=p,o[a+2]*=p}function r(o,a,l){o[a]*=l,o[a+1]*=l,o[a+2]*=l}function s(o,a,l,c,h,p=a){(h=h||o)[p]=o[a]+l[c],h[p+1]=o[a+1]+l[c+1],h[p+2]=o[a+2]+l[c+2]}function n(o,a,l,c,h,p=a){(h=h||o)[p]=o[a]-l[c],h[p+1]=o[a+1]-l[c+1],h[p+2]=o[a+2]-l[c+2]}e.length=t,e.normalize=i,e.scale=r,e.add=s,e.subtract=n})(P9||(P9={}));const wo=ni();class V9e{constructor(t){this.message=t}toString(){return`AssertException: ${this.message}`}}function at(e,t){if(!e)throw t=t||"assert",console.log(new Error(t).stack),new V9e(t)}function $b(e,t){e||(t=t||"",console.warn("Verify failed: "+t+`
`+new Error("verify").stack))}function vee(e,t,i,r){let s,n=(i[0]-e[0])/t[0],o=(r[0]-e[0])/t[0];n>o&&(s=n,n=o,o=s);let a=(i[1]-e[1])/t[1],l=(r[1]-e[1])/t[1];if(a>l&&(s=a,a=l,l=s),n>l||a>o)return!1;a>n&&(n=a),l<o&&(o=l);let c=(i[2]-e[2])/t[2],h=(r[2]-e[2])/t[2];return c>h&&(s=c,c=h,h=s),!(n>h||c>o)&&(h<o&&(o=h),!(o<0))}function s3(e,t,i,r,s,n=Ye()){const o=(r[s]-i[s])*(t[0]-e[0])-(r[0]-i[0])*(t[s]-e[s]),a=(r[0]-i[0])*(e[s]-i[s])-(r[s]-i[s])*(e[0]-i[0]);if(o===0)return!1;const l=a/o;return n[0]=e[0]+l*(t[0]-e[0]),n[1]=e[s]+l*(t[s]-e[s]),!0}function _ee(e,t,i,r,s){s||(s=e),wo[0]=e[0],wo[1]=e[1],wo[2]=e[2],wo[3]=1,Ou(wo,wo,t),s.length>2&&(s[2]=-wo[2]),Ou(wo,wo,i),at(wo[3]!==0),s[0]=wo[0]/wo[3],s[1]=wo[1]/wo[3],s[2]=wo[2]/wo[3],s[0]=(.5*s[0]+.5)*r[2]+r[0],s[1]=(.5*s[1]+.5)*r[3]+r[1]}function G9e(e,t){return Math.log(e)/Math.log(t)}function Xge(e,t,i,r){e[12]=t,e[13]=i,e[14]=r}function Yge(e){return e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[15]===1}function j9e(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/t)}function H9e(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/i)}function q9e(e,t,i){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}function W9e(e,t,i){return 2*Math.atan(i*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}function Pq(e,t,i,r,s){const n=e;e[11]===0?(r[0]=2/(t*n[0]),r[1]=2/(i*n[5]),r[2]=(1+n[12])/n[0],r[3]=(1+n[13])/n[5],rr(s,0,1)):(r[0]=-2/(t*n[0]),r[1]=-2/(i*n[5]),r[2]=(1-n[8])/n[0],r[3]=(1-n[9])/n[5],rr(s,1,0))}class YF{constructor(t,i,r,s){this.primitiveIndices=t,this._numIndexPerPrimitive=i,this.indices=r,this.position=s,this.center=M(),at(t.length>=1),at(r.length%this._numIndexPerPrimitive==0),at(r.length>=t.length*this._numIndexPerPrimitive),at(s.size===3||s.size===4);const{data:n,size:o}=s,a=t.length;let l=o*r[this._numIndexPerPrimitive*t[0]];tv.clear(),tv.push(l),this.bbMin=je(n[l],n[l+1],n[l+2]),this.bbMax=As(this.bbMin);for(let h=0;h<a;++h){const p=this._numIndexPerPrimitive*t[h];for(let f=0;f<this._numIndexPerPrimitive;++f){l=o*r[p+f],tv.push(l);let g=n[l];this.bbMin[0]=Math.min(g,this.bbMin[0]),this.bbMax[0]=Math.max(g,this.bbMax[0]),g=n[l+1],this.bbMin[1]=Math.min(g,this.bbMin[1]),this.bbMax[1]=Math.max(g,this.bbMax[1]),g=n[l+2],this.bbMin[2]=Math.min(g,this.bbMin[2]),this.bbMax[2]=Math.max(g,this.bbMax[2])}}Cs(this.center,this.bbMin,this.bbMax,.5),this.radius=.5*Math.max(Math.max(this.bbMax[0]-this.bbMin[0],this.bbMax[1]-this.bbMin[1]),this.bbMax[2]-this.bbMin[2]);let c=this.radius*this.radius;for(let h=0;h<tv.length;++h){l=tv.getItemAt(h);const p=n[l]-this.center[0],f=n[l+1]-this.center[1],g=n[l+2]-this.center[2],y=p*p+f*f+g*g;if(y<=c)continue;const v=Math.sqrt(y),b=.5*(v-this.radius);this.radius=this.radius+b,c=this.radius*this.radius;const w=b/v;this.center[0]+=p*w,this.center[1]+=f*w,this.center[2]+=g*w}tv.clear()}getCenter(){return this.center}getBSRadius(){return this.radius}getBBMin(){return this.bbMin}getBBMax(){return this.bbMax}getChildren(){if(this._children)return this._children;if(qn(this.bbMin,this.bbMax)>1){const t=Cs(M(),this.bbMin,this.bbMax,.5),i=this.primitiveIndices.length,r=new Uint8Array(i),s=new Array(8);for(let c=0;c<8;++c)s[c]=0;const{data:n,size:o}=this.position;for(let c=0;c<i;++c){let h=0;const p=this._numIndexPerPrimitive*this.primitiveIndices[c];let f=o*this.indices[p],g=n[f],y=n[f+1],v=n[f+2];for(let b=1;b<this._numIndexPerPrimitive;++b){f=o*this.indices[p+b];const w=n[f],S=n[f+1],T=n[f+2];w<g&&(g=w),S<y&&(y=S),T<v&&(v=T)}g<t[0]&&(h|=1),y<t[1]&&(h|=2),v<t[2]&&(h|=4),r[c]=h,++s[h]}let a=0;for(let c=0;c<8;++c)s[c]>0&&++a;if(a<2)return;const l=new Array(8);for(let c=0;c<8;++c)l[c]=s[c]>0?new Uint32Array(s[c]):void 0;for(let c=0;c<8;++c)s[c]=0;for(let c=0;c<i;++c){const h=r[c];l[h][s[h]++]=this.primitiveIndices[c]}this._children=new Array(8);for(let c=0;c<8;++c)l[c]!==void 0&&(this._children[c]=new YF(l[c],this._numIndexPerPrimitive,this.indices,this.position))}return this._children}static prune(){tv.prune()}}const tv=new $t({deallocator:null});class PO{constructor(){this.id=Ta()}unload(){}}var rd;(function(e){e[e.Layer=0]="Layer",e[e.Object=1]="Object",e[e.Geometry=2]="Geometry",e[e.Material=3]="Material",e[e.Texture=4]="Texture",e[e.COUNT=5]="COUNT"})(rd||(rd={}));function bee(e,t,i){const r=nT(e,t),s=nT(t,i),n=nT(i,e),o=(r+s+n)/2,a=o*(o-r)*(o-s)*(o-n);return a<=0?0:Math.sqrt(a)}function X9e(e,t,i){return de(HU,t,e),de(wee,i,e),Pe(pt(HU,HU,wee))/2}new Gm(z0);new Gm(()=>({p0:null,p1:null,p2:null}));const HU=M(),wee=M();let xy=(()=>{const e=new Uint32Array(131072);for(let t=0;t<e.length;++t)e[t]=t;return e})();const Zge=new Uint16Array([0]),SL=(()=>{const e=new Uint16Array(65536);for(let t=0;t<e.length;++t)e[t]=t;return e})();function vS(e){if(e===1)return Zge;if(e<SL.length)return new Uint16Array(SL.buffer,0,e);if(e>xy.length){const t=Math.max(2*xy.length,e);xy=new Uint32Array(t);for(let i=0;i<xy.length;i++)xy[i]=i}return new Uint32Array(xy.buffer,0,e)}function yyt(e){if(e===1)return new Uint16Array(Zge);if(e<SL.length)return new Uint16Array(SL.slice(0,e));if(e>xy.length){const t=new Uint32Array(e);for(let i=0;i<t.length;i++)t[i]=i;return t}return new Uint32Array(xy.slice(0,e))}function Qge(e,t,i){if(!e)return!1;const{size:r,data:s}=e;oe(i,0,0,0),oe(uu,0,0,0);let n=0,o=0;for(let a=0;a<t.length-2;a+=3){const l=t[a+0]*r,c=t[a+1]*r,h=t[a+2]*r;oe(Xs,s[l+0],s[l+1],s[l+2]),oe(rm,s[c+0],s[c+1],s[c+2]),oe(n3,s[h+0],s[h+1],s[h+2]);const p=X9e(Xs,rm,n3);p?(pe(Xs,Xs,rm),pe(Xs,Xs,n3),ae(Xs,Xs,1/3*p),pe(i,i,Xs),n+=p):(pe(uu,uu,Xs),pe(uu,uu,rm),pe(uu,uu,n3),o+=3)}return(o!==0||n!==0)&&(n!==0?(ae(i,i,1/n),!0):o!==0&&(ae(i,uu,1/o),!0))}function Jge(e,t,i){if(!e||!t)return!1;const{size:r,data:s}=e;oe(i,0,0,0);let n=-1,o=0;for(let a=0;a<t.length;a++){const l=t[a]*r;n!==l&&(i[0]+=s[l+0],i[1]+=s[l+1],i[2]+=s[l+2],o++),n=l}return o>1&&ae(i,i,1/o),o>0}function Iq(e,t,i,r){if(!e)return!1;const{size:s,data:n}=e;oe(r,0,0,0),oe(uu,0,0,0);let o=0,a=0;const l=t?t.length-1:n.length/s-1,c=l+(i?2:0);for(let h=0;h<c;h+=2){const p=h<l?h:l,f=h<l?h+1:0,g=(t?t[p]:p)*s,y=(t?t[f]:f)*s;Xs[0]=n[g+0],Xs[1]=n[g+1],Xs[2]=n[g+2],rm[0]=n[y+0],rm[1]=n[y+1],rm[2]=n[y+2],ae(Xs,pe(Xs,Xs,rm),.5);const v=c7(Xs,rm);v>0?(pe(r,r,ae(Xs,Xs,v)),o+=v):(pe(uu,uu,Xs),a++)}return o!==0?(ae(r,r,1/o),!0):a!==0&&(ae(r,uu,1/a),!0)}const Xs=M(),rm=M(),n3=M(),uu=M();class lr extends PO{constructor(t,i=[],r=Aa.Triangle,s=-1){super(),this._primitiveType=r,this.edgeIndicesLength=s,this.type=rd.Geometry,this._vertexAttributes=new Map,this._indices=new Map,this._boundingInfo=null;for(const[n,o]of t)o&&this._vertexAttributes.set(n,I({},o));if(i==null||i.length===0){const n=Y9e(this._vertexAttributes),o=vS(n);this.edgeIndicesLength=this.edgeIndicesLength<0?n:this.edgeIndicesLength;for(const a of this._vertexAttributes.keys())this._indices.set(a,o)}else for(const[n,o]of i)o&&(this._indices.set(n,Z9e(o)),n===E.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._indices.get(n).length:this.edgeIndicesLength))}cloneShallow(){const t=new lr([],void 0,this._primitiveType,void 0),{_vertexAttributes:i,_indices:r}=t;return this._vertexAttributes.forEach((s,n)=>{i.set(n,s)}),this._indices.forEach((s,n)=>{r.set(n,s)}),t.screenToWorldRatio=this.screenToWorldRatio,t._boundingInfo=this._boundingInfo,t}get vertexAttributes(){return this._vertexAttributes}getMutableAttribute(t){const i=this._vertexAttributes.get(t);return i&&!i.exclusive&&(i.data=Array.from(i.data),i.exclusive=!0),i}get indices(){return this._indices}get indexCount(){const t=this._indices.values().next().value;return t?t.length:0}get primitiveType(){return this._primitiveType}get faceCount(){return this.indexCount/3}get boundingInfo(){return R(this._boundingInfo)&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(t){return this.primitiveType===Aa.Triangle?this._computeAttachmentOriginTriangles(t):this._computeAttachmentOriginPoints(t)}_computeAttachmentOriginTriangles(t){const i=this.indices.get(E.POSITION),r=this.vertexAttributes.get(E.POSITION);return Qge(r,i,t)}_computeAttachmentOriginPoints(t){const i=this.indices.get(E.POSITION),r=this.vertexAttributes.get(E.POSITION);return Jge(r,i,t)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const t=this.indices.get(E.POSITION);if(t.length===0)return null;const i=this.primitiveType===Aa.Triangle?3:1;at(t.length%i==0,"Indexing error: "+t.length+" not divisible by "+i);const r=vS(t.length/i),s=this.vertexAttributes.get(E.POSITION);return new YF(r,i,t,s)}}function Y9e(e){const t=e.values().next().value;return t==null?0:t.data.length/t.size}function Z9e(e){if(e.BYTES_PER_ELEMENT===Uint16Array.BYTES_PER_ELEMENT)return e;for(const t of e)if(t>=65536)return e;return new Uint16Array(e)}const Db=P9;var qU,WU,XU,I9;(function(e){const i=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],r=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],s=[0,0,1,0,1,1,0,1],n=new Uint16Array([0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5]),o=new Uint16Array(36);for(let c=0;c<6;c++)for(let h=0;h<6;h++)o[6*c+h]=c;const a=new Uint16Array(36);for(let c=0;c<6;c++)a[6*c+0]=0,a[6*c+1]=1,a[6*c+2]=2,a[6*c+3]=2,a[6*c+4]=3,a[6*c+5]=0;function l(c){Array.isArray(c)||(c=[c,c,c]);const h=new Array(24);for(let p=0;p<8;p++)h[3*p]=i[p][0]*c[0],h[3*p+1]=i[p][1]*c[1],h[3*p+2]=i[p][2]*c[2];return new lr([[E.POSITION,{size:3,data:h,exclusive:!0}],[E.NORMAL,{size:3,data:r}],[E.UV0,{size:2,data:s}]],[[E.POSITION,n],[E.NORMAL,o],[E.UV0,a]])}e.createGeometry=l})(qU||(qU={})),function(e){const i=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],r=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],s=new Uint16Array([5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0]),n=new Uint16Array([0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7]);function o(a){Array.isArray(a)||(a=[a,a,a]);const l=new Array(18);for(let c=0;c<6;c++)l[3*c]=i[c][0]*a[0],l[3*c+1]=i[c][1]*a[1],l[3*c+2]=i[c][2]*a[2];return new lr([[E.POSITION,{size:3,data:l,exclusive:!0}],[E.NORMAL,{size:3,data:r}]],[[E.POSITION,s],[E.NORMAL,n]])}e.createGeometry=o}(WU||(WU={})),function(e){const r=Ht(-.5,0,-.5),s=Ht(.5,0,-.5),n=Ht(0,0,.5),o=Ht(0,0+.5,0),a=fi(),l=fi(),c=fi(),h=fi(),p=fi();de(a,r,o),de(l,r,s),pt(c,a,l),be(c,c),de(a,s,o),de(l,s,n),pt(h,a,l),be(h,h),de(a,n,o),de(l,n,r),pt(p,a,l),be(p,p);const f=[r,s,n,o],g=[0,-1,0,c[0],c[1],c[2],h[0],h[1],h[2],p[0],p[1],p[2]],y=[0,1,2,3,1,0,3,2,1,3,0,2],v=[0,0,0,1,1,1,2,2,2,3,3,3];function b(w){Array.isArray(w)||(w=[w,w,w]);const S=new Array(12);for(let T=0;T<4;T++)S[3*T]=f[T][0]*w[0],S[3*T+1]=f[T][1]*w[1],S[3*T+2]=f[T][2]*w[2];return new lr([[E.POSITION,{size:3,data:S,exclusive:!0}],[E.NORMAL,{size:3,data:g}]],[[E.POSITION,new Uint16Array(y)],[E.NORMAL,new Uint16Array(v)]])}e.createGeometry=b}(XU||(XU={})),function(e){function t(T,A,C,O={uv:!0}){const L=-Math.PI,U=2*Math.PI,N=-Math.PI/2,z=Math.PI,V=Math.max(3,Math.floor(A)),B=Math.max(2,Math.floor(C)),J=(V+1)*(B+1),Q=new Float32Array(3*J),te=new Float32Array(3*J),ie=new Float32Array(2*J),$=[];let F=0;for(let K=0;K<=B;K++){const H=[],ee=K/B,ye=N+ee*z,Ae=Math.cos(ye);for(let Ve=0;Ve<=V;Ve++){const Se=Ve/V,xe=L+Se*U,Re=Math.cos(xe)*Ae,ze=Math.sin(ye),ji=-Math.sin(xe)*Ae;Q[3*F]=Re*T,Q[3*F+1]=ze*T,Q[3*F+2]=ji*T,te[3*F]=Re,te[3*F+1]=ze,te[3*F+2]=ji,ie[2*F]=Se,ie[2*F+1]=ee,H.push(F),++F}$.push(H)}const k=new Uint32Array(2*V*(B-1)*3);F=0;for(let K=0;K<B;K++)for(let H=0;H<V;H++){const ee=$[K][H],ye=$[K][H+1],Ae=$[K+1][H+1],Ve=$[K+1][H];K===0?(k[F++]=ee,k[F++]=Ae,k[F++]=Ve):K===B-1?(k[F++]=ee,k[F++]=ye,k[F++]=Ae):(k[F++]=ee,k[F++]=ye,k[F++]=Ae,k[F++]=Ae,k[F++]=Ve,k[F++]=ee)}const G=[[E.POSITION,k],[E.NORMAL,k]],W=[[E.POSITION,{size:3,data:Q,exclusive:!0}],[E.NORMAL,{size:3,data:te,exclusive:!0}]];return O.uv&&(W.push([E.UV0,{size:2,data:ie,exclusive:!0}]),G.push([E.UV0,k])),O.offset&&(G[0][0]=E.OFFSET,W[0][0]=E.OFFSET,G.push([E.POSITION,new Uint32Array(k.length)]),W.push([E.POSITION,{size:3,data:Float64Array.from(O.offset),exclusive:!0}])),new lr(W,G)}function i(T,A,C){const O=T;let L,U;if(C)L=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],U=new Uint32Array([0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1]);else{const Q=O*(1+Math.sqrt(5))/2;L=[-O,Q,0,O,Q,0,-O,-Q,0,O,-Q,0,0,-O,Q,0,O,Q,0,-O,-Q,0,O,-Q,Q,0,-O,Q,0,O,-Q,0,-O,-Q,0,O],U=new Uint32Array([0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1])}for(let Q=0;Q<L.length;Q+=3)Db.scale(L,Q,T/Db.length(L,Q));let N={};function z(Q,te){Q>te&&([Q,te]=[te,Q]);const ie=Q.toString()+"."+te.toString();if(N[ie])return N[ie];let $=L.length;return L.length+=3,Db.add(L,3*Q,L,3*te,L,$),Db.scale(L,$,T/Db.length(L,$)),$/=3,N[ie]=$,$}for(let Q=0;Q<A;Q++){const te=U.length,ie=new Uint32Array(4*te);for(let $=0;$<te;$+=3){const F=U[$],k=U[$+1],G=U[$+2],W=z(F,k),K=z(k,G),H=z(G,F),ee=4*$;ie[ee]=F,ie[ee+1]=W,ie[ee+2]=H,ie[ee+3]=k,ie[ee+4]=K,ie[ee+5]=W,ie[ee+6]=G,ie[ee+7]=H,ie[ee+8]=K,ie[ee+9]=W,ie[ee+10]=K,ie[ee+11]=H}U=ie,N={}}const V=new Float32Array(L);for(let Q=0;Q<V.length;Q+=3)Db.normalize(V,Q);const B=[[E.POSITION,U],[E.NORMAL,U]],J=[[E.POSITION,{size:3,data:new Float32Array(L),exclusive:!0}],[E.NORMAL,{size:3,data:V,exclusive:!0}]];return new lr(J,B)}function r(T,A,C,O,L,U,N){const z=A?[A[0],A[1],A[2]]:[0,0,0],V=T?[T[0],T[1],T[2]]:[0,0,1];U=U||[0,0];const B=C?[255*C[0],255*C[1],255*C[2],C.length>3?255*C[3]:255]:[255,255,255,255],J=O!=null&&O.length===2?O:[1,1],Q=[[E.POSITION,{size:3,data:z,exclusive:!0}],[E.NORMAL,{size:3,data:V,exclusive:!0}],[E.UV0,{size:U.length,data:U}],[E.COLOR,{size:4,data:B,exclusive:!0}],[E.SIZE,{size:2,data:J}]];if(L!=null){const te=new Float32Array([L[0],L[1],L[2],L[3]]);Q.push([E.AUXPOS1,{size:4,data:te}])}if(N!=null){const te=new Float32Array([N[0],N[1],N[2],N[3]]);Q.push([E.AUXPOS2,{size:4,data:te}])}return new lr(Q,null,Aa.Point)}function s(T,A,C,O,L,U,N,z){if(T!=null){const{data:V}=z.getMutableAttribute(E.NORMAL);V[0]=T[0],V[1]=T[1],V[2]=T[2]}if(A!=null){const{data:V}=z.getMutableAttribute(E.POSITION);V[0]=A[0],V[1]=A[1],V[2]=A[2]}if(C!=null){const{data:V}=z.getMutableAttribute(E.COLOR);V[0]=C[0],V[1]=C[1],V[2]=C[2],V[3]=C[3]}if(O!=null){const{data:V}=z.getMutableAttribute(E.SIZE);V[0]=O[0],V[1]=O[1]}if(L!=null){const{data:V}=z.getMutableAttribute(E.AUXPOS1);V[0]=L[0],V[1]=L[1],V[2]=L[2],V[3]=L[3]}if(U!=null){const{data:V}=z.getMutableAttribute(E.UV0);V[0]=U[0],V[1]=U[1]}if(N!=null){const{data:V}=z.getMutableAttribute(E.AUXPOS2);V[0]=N[0],V[1]=N[1],V[2]=N[2],V[3]=N[3]}}function n(T,A){const C=new Float32Array(3*T.length),O=new Float32Array(A?3*T.length:3),L=new Uint32Array(T.length),U=new Uint32Array(T.length);for(let B=0;B<T.length;B++)C[3*B]=T[B][0],C[3*B+1]=T[B][1],C[3*B+2]=T[B][2],A&&(O[3*B]=A[B][0],O[3*B+1]=A[B][1],O[3*B+2]=A[B][2]),L[B]=B,U[B]=0;A||(O[0]=0,O[1]=1,O[2]=0);const N=[0,0],z=[[E.POSITION,L],[E.NORMAL,A?L:U],[E.UV0,U]],V=[[E.POSITION,{size:3,data:C,exclusive:!0}],[E.NORMAL,{size:3,data:O,exclusive:!0}],[E.UV0,{size:2,data:N,exclusive:!0}]];return new lr(V,z,Aa.Point)}function o(){const T=[0,0,0,0,0,100,100,0,0],A=new Uint16Array([0,1,2]),C=[0,1,0],O=new Uint16Array([0,0,0]),L=[0,0],U=new Uint16Array([0,0,0]),N=[[E.POSITION,A],[E.NORMAL,O],[E.UV0,U]],z=[[E.POSITION,{size:3,data:T,exclusive:!0}],[E.NORMAL,{size:3,data:C,exclusive:!0}],[E.UV0,{size:2,data:L,exclusive:!0}]];return new lr(z,N)}e.createBoxGeometry=qU.createGeometry,e.createDiamondGeometry=WU.createGeometry,e.createTetrahedronGeometry=XU.createGeometry,e.createSphereGeometry=t,e.createPolySphereGeometry=i,e.createPointGeometry=r,e.updatePointGeometry=s,e.createPointArrayGeometry=n,e.createTriangleGeometry=o;const a=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function l(T=a){const A=new Array(12);for(let B=0;B<4;B++)for(let J=0;J<3;J++)A[3*B+J]=T[B][J];const C=new Uint32Array([0,1,2,2,3,0]),O=[0,0,1],L=new Uint32Array([0,0,0,0,0,0]),U=[0,0,1,0,1,1,0,1],N=[255,255,255,255],z=[[E.POSITION,C],[E.NORMAL,L],[E.UV0,C],[E.COLOR,L]],V=[[E.POSITION,{size:3,data:A,exclusive:!0}],[E.NORMAL,{size:3,data:O,exclusive:!0}],[E.UV0,{size:2,data:U,exclusive:!0}],[E.COLOR,{size:4,data:N,exclusive:!0}]];return new lr(V,z)}function c(T,A,C,O,L=!0,U=!0){let N=0;const z=A,V=T;let B=Ht(0,N,0),J=Ht(0,N+V,0),Q=Ht(0,-1,0),te=Ht(0,1,0);O&&(N=V,J=Ht(0,0,0),B=Ht(0,N,0),Q=Ht(0,1,0),te=Ht(0,-1,0));const ie=[J,B],$=[Q,te],F=C+2,k=Math.sqrt(V*V+z*z);if(O)for(let Se=C-1;Se>=0;Se--){const xe=Se*(2*Math.PI/C),Re=Ht(Math.cos(xe)*z,N,Math.sin(xe)*z);ie.push(Re);const ze=Ht(V*Math.cos(xe)/k,-z/k,V*Math.sin(xe)/k);$.push(ze)}else for(let Se=0;Se<C;Se++){const xe=Se*(2*Math.PI/C),Re=Ht(Math.cos(xe)*z,N,Math.sin(xe)*z);ie.push(Re);const ze=Ht(V*Math.cos(xe)/k,z/k,V*Math.sin(xe)/k);$.push(ze)}const G=new Uint32Array(2*(C+2)*3),W=new Uint32Array(2*(C+2)*3);let K=0,H=0;if(L){for(let Se=3;Se<ie.length;Se++)G[K++]=1,G[K++]=Se-1,G[K++]=Se,W[H++]=0,W[H++]=0,W[H++]=0;G[K++]=ie.length-1,G[K++]=2,G[K++]=1,W[H++]=0,W[H++]=0,W[H++]=0}if(U){for(let Se=3;Se<ie.length;Se++)G[K++]=Se,G[K++]=Se-1,G[K++]=0,W[H++]=Se,W[H++]=Se-1,W[H++]=1;G[K++]=0,G[K++]=2,G[K++]=ie.length-1,W[H++]=1,W[H++]=2,W[H++]=$.length-1}const ee=new Float32Array(3*F);for(let Se=0;Se<F;Se++)ee[3*Se]=ie[Se][0],ee[3*Se+1]=ie[Se][1],ee[3*Se+2]=ie[Se][2];const ye=new Float32Array(3*F);for(let Se=0;Se<F;Se++)ye[3*Se]=$[Se][0],ye[3*Se+1]=$[Se][1],ye[3*Se+2]=$[Se][2];const Ae=[[E.POSITION,G],[E.NORMAL,W]],Ve=[[E.POSITION,{size:3,data:ee,exclusive:!0}],[E.NORMAL,{size:3,data:ye,exclusive:!0}]];return new lr(Ve,Ae)}function h(T,A,C,O,L,U){const N=O?bL(O):Ht(1,0,0),z=L?bL(L):Ht(0,0,0);U=U==null||U;const V=fi();be(V,N);const B=fi();ae(B,V,Math.abs(T));const J=fi();ae(J,B,-.5),pe(J,J,z);const Q=Ht(0,1,0);Math.abs(1-_e(V,Q))<.2&&oe(Q,0,0,1);const te=fi();pt(te,V,Q),be(te,te),pt(Q,te,V);const ie=2*C+(U?2:0),$=C+(U?2:0),F=new Float32Array(3*ie),k=new Float32Array(3*$),G=new Float32Array(2*ie),W=new Uint32Array(3*C*(U?4:2)),K=new Uint32Array(3*C*(U?4:2));U&&(F[3*(ie-2)+0]=J[0],F[3*(ie-2)+1]=J[1],F[3*(ie-2)+2]=J[2],G[2*(ie-2)]=0,G[2*(ie-2)+1]=0,F[3*(ie-1)+0]=F[3*(ie-2)+0]+B[0],F[3*(ie-1)+1]=F[3*(ie-2)+1]+B[1],F[3*(ie-1)+2]=F[3*(ie-2)+2]+B[2],G[2*(ie-1)]=1,G[2*(ie-1)+1]=1,k[3*($-2)+0]=-V[0],k[3*($-2)+1]=-V[1],k[3*($-2)+2]=-V[2],k[3*($-1)+0]=V[0],k[3*($-1)+1]=V[1],k[3*($-1)+2]=V[2]);const H=function(xe,Re,ze){W[xe]=Re,K[xe]=ze};let ee=0;const ye=fi(),Ae=fi();for(let xe=0;xe<C;xe++){const Re=xe*(2*Math.PI/C);ae(ye,Q,Math.sin(Re)),ae(Ae,te,Math.cos(Re)),pe(ye,ye,Ae),k[3*xe+0]=ye[0],k[3*xe+1]=ye[1],k[3*xe+2]=ye[2],ae(ye,ye,A),pe(ye,ye,J),F[3*xe+0]=ye[0],F[3*xe+1]=ye[1],F[3*xe+2]=ye[2],G[2*xe+0]=xe/C,G[2*xe+1]=0,F[3*(xe+C)+0]=F[3*xe+0]+B[0],F[3*(xe+C)+1]=F[3*xe+1]+B[1],F[3*(xe+C)+2]=F[3*xe+2]+B[2],G[2*(xe+C)+0]=xe/C,G[2*xe+1]=1;const ze=(xe+1)%C;H(ee++,xe,xe),H(ee++,xe+C,xe),H(ee++,ze,ze),H(ee++,ze,ze),H(ee++,xe+C,xe),H(ee++,ze+C,ze)}if(U){for(let xe=0;xe<C;xe++){const Re=(xe+1)%C;H(ee++,ie-2,$-2),H(ee++,xe,$-2),H(ee++,Re,$-2)}for(let xe=0;xe<C;xe++){const Re=(xe+1)%C;H(ee++,xe+C,$-1),H(ee++,ie-1,$-1),H(ee++,Re+C,$-1)}}const Ve=[[E.POSITION,W],[E.NORMAL,K],[E.UV0,W]],Se=[[E.POSITION,{size:3,data:F,exclusive:!0}],[E.NORMAL,{size:3,data:k,exclusive:!0}],[E.UV0,{size:2,data:G,exclusive:!0}]];return new lr(Se,Ve)}function p(T,A,C,O,L){C=C||10,O=O==null||O,at(T.length>1);const U=[[0,0,0]],N=[],z=[];for(let V=0;V<C;V++){N.push([0,-V-1,-(V+1)%C-1]);const B=V/C*2*Math.PI;z.push([Math.cos(B)*A,Math.sin(B)*A])}return e.createPathExtrusionGeometry(z,T,U,N,O,L)}function f(T,A,C,O,L,U=Ht(0,0,0)){const N=T.length,z=new Float32Array(A.length*N*3+(6*C.length||0)),V=new Float32Array(A.length*N*3+(C?6:0)),B=(A.length-1)*N*6+3*O.length*2,J=new Uint32Array(B),Q=new Uint32Array(B);let te=0,ie=0,$=0,F=0;const k=fi(),G=fi(),W=fi(),K=fi(),H=fi(),ee=fi(),ye=fi(),Ae=M(),Ve=fi(),Se=fi(),xe=fi(),Re=fi(),ze=fi(),ji=ii();oe(Ve,0,1,0),de(G,A[1],A[0]),be(G,G),L?(pe(Ae,A[0],U),be(W,Ae)):oe(W,0,0,1),S(G,W,Ve,Ve,H,W,xee),ne(K,W),ne(Re,H);for(let Pt=0;Pt<C.length;Pt++)ae(ee,H,C[Pt][0]),ae(Ae,W,C[Pt][2]),pe(ee,ee,Ae),pe(ee,ee,A[0]),z[te++]=ee[0],z[te++]=ee[1],z[te++]=ee[2];V[ie++]=-G[0],V[ie++]=-G[1],V[ie++]=-G[2];for(let Pt=0;Pt<O.length;Pt++)J[$++]=O[Pt][0]>0?O[Pt][0]:-O[Pt][0]-1+C.length,J[$++]=O[Pt][1]>0?O[Pt][1]:-O[Pt][1]-1+C.length,J[$++]=O[Pt][2]>0?O[Pt][2]:-O[Pt][2]-1+C.length,Q[F++]=0,Q[F++]=0,Q[F++]=0;let Yr=C.length;const Ms=C.length-1;for(let Pt=0;Pt<A.length;Pt++){let JO=!1;Pt>0&&(ne(k,G),Pt<A.length-1?(de(G,A[Pt+1],A[Pt]),be(G,G)):JO=!0,pe(Se,k,G),be(Se,Se),pe(xe,A[Pt-1],K),WT(A[Pt],Se,ji),db(ji,xc(xe,k),Ae)?(de(Ae,Ae,A[Pt]),be(W,Ae),pt(H,Se,W),be(H,H)):S(Se,K,Re,Ve,H,W,xee),ne(K,W),ne(Re,H)),L&&(pe(Ae,A[Pt],U),be(ze,Ae));for(let ad=0;ad<N;ad++)if(ae(ee,H,T[ad][0]),ae(Ae,W,T[ad][1]),pe(ee,ee,Ae),be(ye,ee),V[ie++]=ye[0],V[ie++]=ye[1],V[ie++]=ye[2],pe(ee,ee,A[Pt]),z[te++]=ee[0],z[te++]=ee[1],z[te++]=ee[2],!JO){const o2=(ad+1)%N;J[$++]=Yr+ad,J[$++]=Yr+N+ad,J[$++]=Yr+o2,J[$++]=Yr+o2,J[$++]=Yr+N+ad,J[$++]=Yr+N+o2;for(let a2=0;a2<6;a2++)Q[F++]=J[$-6+a2]-Ms}Yr+=N}const Ps=A[A.length-1];for(let Pt=0;Pt<C.length;Pt++)ae(ee,H,C[Pt][0]),ae(Ae,W,C[Pt][1]),pe(ee,ee,Ae),pe(ee,ee,Ps),z[te++]=ee[0],z[te++]=ee[1],z[te++]=ee[2];const ds=ie/3;V[ie++]=G[0],V[ie++]=G[1],V[ie++]=G[2];const Is=Yr-N;for(let Pt=0;Pt<O.length;Pt++)J[$++]=O[Pt][0]>=0?Yr+O[Pt][0]:-O[Pt][0]-1+Is,J[$++]=O[Pt][2]>=0?Yr+O[Pt][2]:-O[Pt][2]-1+Is,J[$++]=O[Pt][1]>=0?Yr+O[Pt][1]:-O[Pt][1]-1+Is,Q[F++]=ds,Q[F++]=ds,Q[F++]=ds;const Tb=[[E.POSITION,J],[E.NORMAL,Q]],n5=[[E.POSITION,{size:3,data:z,exclusive:!0}],[E.NORMAL,{size:3,data:V,exclusive:!0}]];return new lr(n5,Tb)}function g(T,A,C){at(T.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),at(T[0].length===3,"createPolylineGeometry(): malformed vertex"),at(A==null||A.length===T.length,"createPolylineGeometry: need same number of points and normals"),at(A==null||A[0].length===3,"createPolylineGeometry(): malformed normal");const O=new Float64Array(3*T.length),L=new Uint32Array(2*(T.length-1));let U=0,N=0;for(let B=0;B<T.length;B++){for(let J=0;J<3;J++)O[U++]=T[B][J];B>0&&(L[N++]=B-1,L[N++]=B)}const z=[],V=[];if(z.push([E.POSITION,L]),V.push([E.POSITION,{size:3,data:O,exclusive:!0}]),A){const B=new Float32Array(3*A.length);let J=0;for(let Q=0;Q<T.length;Q++)for(let te=0;te<3;te++)B[J++]=A[Q][te];z.push([E.NORMAL,L]),V.push([E.NORMAL,{size:3,data:B,exclusive:!0}])}return C&&(V.push([E.COLOR,{size:4,data:C}]),z.push([E.COLOR,vS(C.length/4)])),new lr(V,z,Aa.Line)}function y(T,A,C,O,L=0){const U=new Array(18),N=[[-A,L,O/2],[C,L,O/2],[0,T+L,O/2],[-A,L,-O/2],[C,L,-O/2],[0,T+L,-O/2]],z=new Uint16Array([0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5]);for(let V=0;V<6;V++)U[3*V]=N[V][0],U[3*V+1]=N[V][1],U[3*V+2]=N[V][2];return new lr([[E.POSITION,{size:3,data:U,exclusive:!0}]],[[E.POSITION,z]])}function v(T,A){const C=T.getMutableAttribute(E.POSITION).data;for(let O=0;O<C.length;O+=3){const L=C[O],U=C[O+1],N=C[O+2];oe(Lb,L,U,N),ke(Lb,Lb,A),C[O]=Lb[0],C[O+1]=Lb[1],C[O+2]=Lb[2]}}function b(T,A=T){const C=T.vertexAttributes,O=C.get(E.POSITION).data,L=C.get(E.NORMAL).data;if(L){const U=A.getMutableAttribute(E.NORMAL).data;for(let N=0;N<L.length;N+=3){const z=L[N+1];U[N+1]=-L[N+2],U[N+2]=z}}if(O){const U=A.getMutableAttribute(E.POSITION).data;for(let N=0;N<O.length;N+=3){const z=O[N+1];U[N+1]=-O[N+2],U[N+2]=z}}return A}function w(T,A,C,O,L){return!(Math.abs(_e(A,T))>L)&&(pt(C,T,A),be(C,C),pt(O,C,T),be(O,O),!0)}function S(T,A,C,O,L,U,N){return w(T,A,L,U,N)||w(T,C,L,U,N)||w(T,O,L,U,N)}e.createSquareGeometry=l,e.createConeGeometry=c,e.createCylinderGeometry=h,e.createTubeGeometry=p,e.createPathExtrusionGeometry=f,e.createPolylineGeometry=g,e.createExtrudedTriangle=y,e.transformInPlace=v,e.cgToGIS=b,e.makeOrthoBasisDirUp=w,e.makeOrthoBasisDirUpFallback=S}(I9||(I9={}));const xee=.99619469809,Lb=fi(),Qa=I9,Q9e=he.getLogger("esri.views.3d.environment.PanoramicAtmosphere");class J9e{constructor(){this.type="panoramic",this._techniqueConfig=new xL,this._readyResolver=Sm(),this._readyController=new AbortController}destroy(){this._readyResolver.reject(),this._texture=tt(this._texture),this._vao=tt(this._vao),this._readyController=Iu(this._readyController)}when(){return this._readyResolver.promise}initializeRenderContext(t){this._techniqueConfig.geometry=td.Cylinder,this._technique=t.shaderTechniqueRepository.acquire(hS,this._techniqueConfig);const i=t.renderContext.rctx;this._vao=this._createVertexArrayObject(i),this._vaoCount=vn(this._vao,"geometry"),Fu(jge,{signal:this._readyController.signal}).then(r=>{this._texture=new Qe(i,{pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE,samplingMode:Ge.LINEAR,flipped:!0},r),t.requestRender(),this._readyController=null,this._readyResolver.resolve()}).catch(r=>{pr(r)||Q9e.error("Unable to initialize atmosphere: image request failed",r),this._readyResolver.reject()})}get canRender(){return this._texture!=null}render(t){const i=t.rctx,r=i.useTechnique(this._technique);r.bindTexture(this._texture,"tex"),Ol(r,t.camera.projectionMatrix),K9e(Tee,t.camera.viewMatrix),r.setUniformMatrix4fv("view",Tee),r.setUniform4f("uColor",1,1,1,1),t.scenelightingData.setLightDirectionUniform(r),i.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(Tt.TRIANGLES,0,this._vaoCount)}renderHaze(){return!1}_createVertexArrayObject(t){const i=Qa.createPolySphereGeometry(1,2,!1),r=i.indices.get(E.POSITION);for(let a=0;a<r.length;a+=3){const l=r[a];r[a]=r[a+2],r[a+2]=l}const s=i.vertexAttributes.get(E.POSITION).data,n=See.createBuffer(r.length),o=n.position;for(let a=0;a<r.length;++a){const l=3*r[a];o.set(a,0,s[l]),o.set(a,1,s[l+1]),o.set(a,2,s[l+2])}return new us(t,mi,{geometry:Rl(See)},{geometry:jt.createVertex(t,ri.STATIC_DRAW,n.buffer)})}}function K9e(e,t){Ur(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1}const Tee=Te(),See=kr().vec3f(E.POSITION);var oc;function eGe(e){const t=new Oi;return t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.INSTANCEFEATUREATTRIBUTE,"float"),t.vertex.uniforms.add("cameraPosition","vec3").add("offset","vec3").add("width","float").add("proj","mat4").add("view","mat4").add("time","float"),t.varyings.add("vUv","vec2"),t.vertex.code.add(x`
    //https://www.shadertoy.com/view/4djSRW
    vec3 hash31(float p){
      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return fract((p3.xxy + p3.yzz) * p3.zyx);
    }

    float hash11(float p){
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);
    }

    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/
    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
    }

    void main(void) {

      vUv = position.xz;

      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${e.type===oc.RAIN?x`

            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:x`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
    }
  `),t.fragment.uniforms.add("opacity","float").add("particleColor","vec3"),t.fragment.code.add(x`
    void main() {

      // Cut off corners of the triangle
      if(vUv.x < 0.0 || vUv.y < 0.0){
        discard;
      }

      float d = length(vUv - vec2(0.5));

      ${e.type===oc.RAIN?x`d = 0.5 * smoothstep(0.5, 0.0, d);`:x`d = smoothstep(0.5, 0.1, d);`}
      gl_FragColor = opacity * vec4(particleColor * d, d);
    }
  `),t}(function(e){e[e.RAIN=0]="RAIN",e[e.SNOW=1]="SNOW"})(oc||(oc={}));const tGe=Object.freeze({__proto__:null,get PrecipitationType(){return oc},build:eGe});class cm extends Gi{initializeProgram(t){const i=cm.shader.get(),r=this.configuration,s=i.build({type:r.type});return new Mi(t.rctx,s,cm.attributeLocation)}initializePipeline(){return Ot({blending:Xn(Ee.ONE,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:Li.LEQUAL},colorWrite:Ft})}}cm.shader=new Ni(tGe,()=>import("./Precipitation.glsl.399cac9d.js")),cm.attributeLocation=new Map([[E.POSITION,0],[E.INSTANCEFEATUREATTRIBUTE,1]]);class $9 extends mr{constructor(){super(...arguments),this.type=oc.RAIN}}u([Z()],$9.prototype,"type",void 0);class Kge{constructor(){this.enabled=!0,this._time=0}get time(){return this._time}advance(t){return _(t.forcedTime)?this._time!==t.forcedTime&&(this._time=t.forcedTime,!0):!(!this.enabled||t.dt===0)&&(this._time+=t.dt,!0)}}let d_=class extends we{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._opacity=1,this._width=500,this._offset=M(),this._tile=M(),this._particleColor=fi(),this._particleColorAtNight=fi(),this._nightMultiplier=.7,this._cameraDirection=fi(),this._renderParameters={camera:null,time:0,radius:1},this._animation=new Kge,this._updatingTracking=new fp,this._renderParameters.time=0,this._renderParameters.radius=di(e.view.spatialReference).radius,this._shaderTechniqueRepository=e.context.shaderTechniqueRepository}destroy(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechnique=Xi(this._snowTechnique),this._rainTechnique=Xi(this._rainTechnique),this._vao=tt(this._vao),this._instanceIdBuffer=tt(this._instanceIdBuffer)}get updating(){return this._updatingTracking.updating}get rainTechnique(){if(R(this._rainTechnique)){const e=new $9;e.type=oc.RAIN,this._rainTechnique=this._shaderTechniqueRepository.acquire(cm,e)}return this._rainTechnique}get snowTechnique(){if(R(this._snowTechnique)){const e=new $9;e.type=oc.SNOW,this._snowTechnique=this._shaderTechniqueRepository.acquire(cm,e)}return this._snowTechnique}update(e){return this._animation.advance(e)}render(e,t,i){const{rctx:r,camera:s}=e;this._ensureResources(r);const n=i===oc.RAIN?this.rainTechnique:this.snowTechnique;if(R(n)||R(this._vao)||R(this._instanceIdBuffer)||(_(e.cloudsCompositionParams)&&(this._opacity=1-e.cloudsCompositionParams.fadeInOutHeight.factor),this._opacity<=0))return;const o=r.useTechnique(n);this._renderParameters.camera=s,this._renderParameters.time=(i===oc.RAIN?this._rainSpeed:this._snowSpeed)*Goe(this._animation.time),this._update(o,s,i,e),r.bindVAO(this._vao);const a=cm.attributeLocation;o.assertCompatibleVertexAttributeLocations(this._vao),fq(r,a,this._instanceIdBuffer,Eee,0),r.capabilities.instancing.drawArraysInstanced(Tt.TRIANGLES,0,3,this._numParticles*t),mq(r,a,this._instanceIdBuffer,Eee)}_update(e,t,i,r){const s=t.eye;this._tile[0]=Math.floor((s[0]+.5*this._width)/this._width),this._tile[1]=Math.floor((s[1]+.5*this._width)/this._width),this._tile[2]=Math.floor((s[2]+.5*this._width)/this._width),this._offset[0]=s[0]-this._tile[0]*this._width,this._offset[1]=s[1]-this._tile[1]*this._width,this._offset[2]=s[2]-this._tile[2]*this._width,e.setUniform1f("width",this._width),e.setUniform3fv("offset",this._offset),e.setUniformMatrix4fv("view",t.viewMatrix),e.setUniform3fv("cameraPosition",s),Ol(e,t.projectionMatrix),e.setUniform1f("time",this._renderParameters.time),i===oc.RAIN?oe(this._particleColor,.85,.85,.85):oe(this._particleColor,1,1,1),ae(this._particleColorAtNight,this._particleColor,this._nightMultiplier),be(this._cameraDirection,s);const n=Math.max(0,_e(this._cameraDirection,r.scenelightingData.lightingMainDirection));Cs(this._particleColor,this._particleColorAtNight,this._particleColor,n),e.setUniform3fv("particleColor",this._particleColor),e.setUniform1f("opacity",this._opacity)}_ensureResources(e){_(this._vao)||(this._vao=this._createVertexArrayObject(e),_(this._instanceIdBuffer)||(this._instanceIdBuffer=this._createInstanceIndices(e)))}_createInstanceIndices(e){const t=[];for(let i=0;i<this._numParticles;i++)t.push(i);return jt.createVertex(e,ri.STATIC_DRAW,new Float32Array(t))}_createVertexArrayObject(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new us(e,cm.attributeLocation,{geometry:Rl(iGe)},{geometry:jt.createVertex(e,ri.STATIC_DRAW,t)})}};u([d({constructOnly:!0})],d_.prototype,"context",void 0),u([d({constructOnly:!0})],d_.prototype,"view",void 0),u([d({readOnly:!0})],d_.prototype,"updating",null),u([d()],d_.prototype,"_updatingTracking",void 0),d_=u([P("esri.views.3d.environment.Precipitation")],d_);const iGe=kr().vec3f(E.POSITION),Eee=Rl(kr().f32(E.INSTANCEFEATUREATTRIBUTE),1),rGe="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAAE00TaTAAAACXBIWXMAAA7AAAAOwAFq1okJAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAp1JREFUSMd9lcmSEzEQRCtflnqxYZgIThBDAP//kXDQ0pJtuDhqycxWZ5fKERFCERARIAVEyCjCtSFFEjWVa9q7OdJE0oiidIhKhRBROlhloiGVhaYERQHJWFEwMpYKrjUlibI2cqSJIJEpKNmM2c3GkRTOJDnThTMpnMWu0VFszs3Jfbe5bza3w+a229yOIs6zmP3czfn1K2w/for8+EVU15pNmmyqkeJyclinXNJRu1xrUaJmjmdzJiejVNt7zZVBRAIq1RwrsrrWnez+SR7WmQQP/1itKz2q/pmzuJtYnNy2bth9x9z2NLfDcB7FHOcGx6ebOb9/iPzxG/ztg4iorglFiKjzF9HSNphCoRb1OY3RZQJrYgRdT68bmgXGDdBzrTG8qNS7QP/m19ef7tGlcoH7vESYkK70uoPuOLEetz0IqeGoWQW6MlB/j36EnipYGKPWwDRg/RkNhXCNJIzAhMk6PrDePJNII6JHqM5VWqYApCtNFPe0GFFGtOWopWCrEVBSoiQi06KkRRaD08IlxXa/ifz8Jvz2LvjyLnh7F/r8Rei8a8xfjNkIrpmMOQ1C02COrkTEHxGhh+6DQJfXc/eZprXxcIyVIf1LJVgWvKaHvwI/1aQxtv851SQ/nqGXL6MHFVY3nmhLyqKsWO/+qzWif+yS1TpNKq8NezjGPCV69ciZoQj1PwfN6QRpWyCGVMe1D/AAHt3/gefu1Ign3AVpjOiNXkN90JlpL6TUnzFEUU+Jvks0tkp/dY3Fy1TzI24BWwsYJPyg11Q0FqDwK72xIz2kLojbeuxS1FpgtfNWyMX1gFw0j3W7RNeSHTVEe3VaV7SdCzVywFaEt02w7QH7Eeg4AvZDNdJ+Cu1HENsutO+Byi6ilEBZ9BeCNBJceJIjHgAAAABJRU5ErkJggg==",sGe=he.getLogger("esri.views.3d.environment.SimpleAtmosphere"),o3=128,Aee=-O9,Cee=0,YU=50,nGe=()=>1-511/512,oGe=rI([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class aGe{constructor(t){this.view=t,this.type="simple",this._renderData={texV:Ye(),silCircleCenter:M(),silCircleV1:M(),silCircleV2:M(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._texture=null,this._fadeVaoCount=0,this._readyResolver=Sm(),this._readyController=new AbortController,this.texV1=1,this.canRender=!0,this.isOnMars=Lp(t.spatialReference);const i=di(t.spatialReference);this.planetRadius=i.radius,this.outerRimWidth=i.outerAtmosphereRimWidth,this.innerRimFactor=(this.planetRadius+Aee)/this.planetRadius,this.middleRimFactor=(this.planetRadius+Cee)/this.planetRadius,this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius,this.texV0=Cee/this.outerRimWidth,this.texVScale=this.texV1-this.texV0}destroy(){this._readyResolver.reject(),this._cameraChangeHandle=Js(this._cameraChangeHandle),this._texture=tt(this._texture),this._fadeVao=tt(this._fadeVao),this._vao=tt(this._vao),this._readyController=Iu(this._readyController)}when(){return this._readyResolver.promise}async initializeRenderContext(t){this._shaderTechniqueRepository=t.shaderTechniqueRepository;const i=t.renderContext.rctx;this._cameraChangeHandle=Wt(this.view,"state.camera",()=>t.requestRender(),!0),this._vao=this._createRibbon(i),this._vaoCount=vn(this._vao,"geometry"),this._fadeVao=bo(i),this._fadeVaoCount=vn(this._fadeVao,"geometry");const r=this.isOnMars?rGe:jge,s=this._readyController.signal;try{const n=await Fu(r,{signal:s});Qt(s),this._texture=new Qe(i,{pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE,samplingMode:Ge.LINEAR,flipped:!0},n),t.requestRender(),this._readyController=null,this._readyResolver.resolve()}catch(n){pr(n)||sGe.error("Unable to initialize simple atmosphere: image request failed",n),this._readyResolver.reject(n)}}get coneTechnique(){if(R(this._coneTechnique)){const t=new xL;t.geometry=td.Cone,this._coneTechnique=this._shaderTechniqueRepository.acquire(hS,t)}return this._coneTechnique}get undergroundTechnique(){if(R(this._undergroundTechnique)){const t=new xL;t.geometry=td.Underground,this._undergroundTechnique=this._shaderTechniqueRepository.acquire(hS,t)}return this._undergroundTechnique}render(t){this._update(t.camera);const i=t.rctx;if(this._renderData.undergroundFadeAlpha<1){const r=i.useTechnique(this.coneTechnique);r.setUniformMatrix4fv("proj",t.camera.projectionMatrix),r.setUniformMatrix4fv("view",t.camera.viewMatrix),r.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),r.setUniform3fv("silCircleV1",this._renderData.silCircleV1),r.setUniform3fv("silCircleV2",this._renderData.silCircleV2),r.setUniform2fv("texV",this._renderData.texV),r.bindTexture(this._texture,"tex"),t.scenelightingData.setLightDirectionUniform(r),r.setUniform1f("altitudeFade",this._renderData.altitudeFade),r.setUniform1f("innerScale",this._renderData.innerScale),i.bindVAO(this._vao),i.drawArrays(Tt.TRIANGLES,0,this._vaoCount)}if(this._renderData.undergroundFadeAlpha>0){const r=i.useTechnique(this.undergroundTechnique);r.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),t.scenelightingData.setLightDirectionUniform(r),r.setUniform3fv("cameraPosition",t.camera.eye),i.bindVAO(this._fadeVao),i.drawArrays(Tt.TRIANGLE_STRIP,0,this._fadeVaoCount)}}renderHaze(){return!1}_update(t){const i=M(),r=this.planetRadius,s=Pe(t.eye),n=s-r;if(n<0){const g=Math.min(-n/5e3,1);this._renderData.undergroundFadeAlpha=g}else this._renderData.undergroundFadeAlpha=0;const o=Math.max(YU,n),a=r+Aee;this._renderData.innerScale=lGe(r+o,r,a)-1,this._renderData.altitudeFade=age(n),ae(i,t.eye,(r+YU)/s),Ree(i,t.center,t.up,r,this._renderData);const l=this._computeScreenRimWidth(t,i,t.up,this._renderData),c=nGe(),h=oGe(n);let p=this.texV0+c*this.texVScale,f=this.texV0+l*h*this.texVScale;if(n>YU){Ree(t.eye,t.center,t.up,r,this._renderData);const g=this._computeScreenRimWidth(t,t.eye,t.up,this._renderData),y=Be((g-1.5)/(l-1.5),0,1);p=this.texV0+y*c*this.texVScale,f=this.texV0+qt(this.texV1,l*h,y)*this.texVScale}rr(this._renderData.texV,p,f)}_createRibbon(t){const i=new Float32Array(3+3*o3*3),r=new Uint32Array(3*o3*5);i[0]=0,i[1]=0,i[2]=-1;for(let o=0;o<o3;o++){const a=9*o+3;i[a+0]=o,i[a+1]=this.innerRimFactor,i[a+2]=-1,i[a+3]=o,i[a+4]=this.middleRimFactor,i[a+5]=0,i[a+6]=o,i[a+7]=this.outerRimFactor,i[a+8]=1;const l=3*o+1,c=o===o3-1?1:l+3,h=15*o;r[h+0]=l,r[h+1]=l+1,r[h+2]=c+1,r[h+3]=c+1,r[h+4]=c,r[h+5]=l,r[h+6]=l+1,r[h+7]=l+2,r[h+8]=c+2,r[h+9]=c+2,r[h+10]=c+1,r[h+11]=l+1,r[h+12]=l,r[h+13]=c,r[h+14]=0}const s=Oee.createBuffer(r.length),n=s.position;for(let o=0;o<r.length;++o){const a=3*r[o];n.set(o,0,i[a]),n.set(o,1,i[a+1]),n.set(o,2,i[a+2])}return new us(t,mi,{geometry:Rl(Oee)},{geometry:jt.createVertex(t,ri.STATIC_DRAW,s.buffer)})}_computeScreenRimWidth(t,i,r,s){return pe($2,s.silCircleCenter,s.silCircleV2),ae(QU,$2,this.outerRimFactor),sF(ZU,i,$2,r),_ee($2,ZU,t.projectionMatrix,t.viewport),_ee(QU,ZU,t.projectionMatrix,t.viewport),xi($2,QU)/t.height}}function Ree(e,t,i,r,s){const n=Pe(e),o=r*Math.sqrt(n*n-r*r)/n,a=Math.sqrt(r*r-o*o),l=s.silCircleV1,c=s.silCircleV2;return ae(s.silCircleCenter,e,a/n),pt(l,e,t),Go(l)<1&&pt(l,e,i),ae(l,l,o/Pe(l)),pt(c,l,e),ae(c,c,o/Pe(c)),o}const ZU=Te(),$2=M(),QU=M();function lGe(e,t,i){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-i*i)+t*i)}const Oee=kr().vec3f(E.POSITION);function $q(e){const t=x`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`,i=x`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`;e.vertex.code.add(t),e.vertex.code.add(i),e.fragment.code.add(t),e.fragment.code.add(i)}function cGe(){const e=new Oi;return e.attributes.add(E.POSITION,"vec3"),e.attributes.add(E.COLOR,"vec4"),e.attributes.add(E.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add("transform","mat4").add("viewport","vec4").add("pixelRatio","float"),e.include($q),e.vertex.code.add(x`void main(void) {
vec4 posProj = transform * vec4(position, 0);
gl_Position = alignToPixelCenter(posProj, viewport.zw);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),e.fragment.code.add(x`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
gl_FragColor = vec4(vcolor.xyz, intensity);
}`),e}const uGe=Object.freeze({__proto__:null,build:cGe});class ZF extends Gi{constructor(t){super(t,null,()=>this.destroy())}initializeProgram(t){const i=ZF.shader.get().build();return new Mi(t.rctx,i,mi)}initializePipeline(){return Ot({blending:Xn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:Li.LEQUAL},colorWrite:Ft})}bindPass(t){const i=this._makeInfiniteProjectionMatrix(t.camera.projectionMatrix,t.camera.near,hGe);dr(i,i,t.camera.viewMatrix),dr(i,i,t.modelMatrix),this.program.setUniformMatrix4fv("transform",i),this.program.setUniform4fv("viewport",t.camera.fullViewport),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio)}_makeInfiniteProjectionMatrix(t,i,r){return Ur(r,t),r[10]=24e-8-1,r[11]=-1,r[14]=(24e-8-2)*i,r}}ZF.shader=new Ni(uGe,()=>import("./Stars.glsl.66de064c.js"));const hGe=Te(),dGe=he.getLogger("esri.views.3d.environment.Stars");let uy=class extends we{constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._renderParameter={camera:null,modelMatrix:Te()},this._updatingTracking=new fp}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return _(this._loadDataTask)&&!this._loadDataTask.finished}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=Iu(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=Xi(this._technique),this._vao=tt(this._vao)}render(e){const{rctx:t,camera:i}=e;if(this._ensureResources(t),R(this._technique)||R(this._vao))return;const r=t.useTechnique(this._technique);this._renderParameter.camera=i,this._technique.bindPass(this._renderParameter),t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(Tt.POINTS,0,this._numPoints)}_ensureResources(e){if(_(this._technique)||R(Nb))return;this._technique=new ZF({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=Nb.byteLength/Mee;const t=new Float32Array(Nb,0,2*this._numPoints),i=new Uint8Array(Nb,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,t,i,this._numPoints),this._updatingTracking.add(()=>{var r;return(r=this.view)==null?void 0:r.environment.lighting.date},r=>this._update(r),fn)}_computeDayDuration(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(e),r=this._renderParameter.modelMatrix;Ur(r,mGe),GT(r,r,-i*Math.PI),dr(r,fGe,r),GT(r,r,-t*Math.PI),this.requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,t,i,r){const s=Pee.createBuffer(r),n=s.position,o=s.color,a=s.size;for(let l=0;l<r;l++){const c=t[2*l+0],h=t[2*l+1];n.set(l,0,-Math.cos(c)*Math.sin(h)),n.set(l,1,-Math.sin(c)*Math.sin(h)),n.set(l,2,-Math.cos(h));const p=this._unpackUint8Attributes(i[l]),f=this._hexToRGB(pGe[p[1]]);o.set(l,0,255*f[0]),o.set(l,1,255*f[1]),o.set(l,2,255*f[2]),o.set(l,3,255),a.set(l,p[0])}return new us(e,mi,{geometry:Rl(Pee)},{geometry:jt.createVertex(e,ri.STATIC_DRAW,s.buffer)})}_createLoadDataTask(){if(_(Nb))return null;const e=iO(async t=>{const{data:i}=await nRe("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});this._verifyStarData(i),Nb=i});return e.promise.catch(t=>{pr(t)||dGe.error(t)}).then(()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))}),e}_verifyStarData(e){if(!e)throw new q("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/Mee;if(t%1!=0||t>5e4||t<5e3)throw new q("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};u([d({constructOnly:!0})],uy.prototype,"view",void 0),u([d({constructOnly:!0})],uy.prototype,"requestRender",void 0),u([d({readOnly:!0})],uy.prototype,"updating",null),u([d()],uy.prototype,"_loadDataTask",void 0),u([d()],uy.prototype,"_updatingTracking",void 0),uy=u([P("esri.views.3d.environment.Stars")],uy);const pGe=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],fGe=Fj(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),mGe=Fj(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),Mee=9,Pee=kr().vec3f(E.POSITION).vec4u8(E.COLOR).f32(E.SIZE);let Nb=null;var wA;const gGe=[ve.POSTPROCESSING_ENVIRONMENT_OPAQUE,ve.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];let Iee,Mo=wA=class extends we{constructor(e){super(e),this._handles=new Ut,this._context=null,this._pendingAtmosphere=null,this._atmosphere=null,this._precipitationEnabled=P5e()}initialize(){this.view._stage.addRenderPlugin(gGe,this)}destroy(){var e;this._pendingAtmosphere=rt(this._pendingAtmosphere),((e=this.view)==null?void 0:e._stage)!=null&&this.view._stage.removeRenderPlugin(this),this._handles=rt(this._handles),this._set("view",null)}get atmosphereType(){return _(this._pendingAtmosphere)?this._pendingAtmosphere.type:_(this._atmosphere)?this._atmosphere.type:"none"}get canRender(){var e;return!((e=this.view.basemapTerrain)==null||!e.renderer.canRender)||this.view.viewingMode!=="global"}get needsLinearDepth(){return this._selectAtmosphereType()==="realistic"}updateAnimation(e){return!!_(this._precipitation)&&this._precipitation.update(e)}get updating(){return _(this._pendingAtmosphere)||_(this._stars)&&this._stars.updating||_(this._clouds)&&this._clouds.running}get weatherVisible(){return Pe(this.view.state.camera.eye)-di(this.view.spatialReference).radius<=pu}get _stars(){var e,t;const i=this.view,r=(e=(t=i.environment)==null?void 0:t.starsEnabled)!=null&&e,s=this._get("_stars");return!r||R(this._context)?(rt(s),null):_(s)?s:new uy({view:i,requestRender:()=>this._setNeedsRender()})}get _precipitation(){const e=this._get("_precipitation");if(!this._precipitationEnabled||R(this._context))return rt(e),null;const t=this.view,i=this._context;return _(e)&&e.context===i?e:(rt(e),new d_({context:i,view:t}))}get _clouds(){const e=this._get("_clouds");if(!this.weatherEnabled||R(this._context))return rt(e),null;if(_(e))return e;const t=this.view,i=this._context.renderContext.rctx;return rt(e),new Oo({rctx:i,view:t,requestRender:()=>this._setNeedsRender()})}get _cloudComposition(){const e=this._get("_cloudComposition");if(!this.weatherEnabled||R(this._context))return rt(e),null;const t=this.view.state.viewingMode,i=this._context.renderContext.rctx,r=di(this.view.spatialReference).radius;return _(e)&&e.viewingMode===t&&e.radius===r?e:(rt(e),new rx({rctx:i,viewingMode:t,radius:r}))}get _fog(){const e=this._get("_fog");if(!this.weatherEnabled||R(this._context))return rt(e),null;if(_(e))return e;const t=this.view,i=this._context;return rt(e),new bA({context:i,view:t})}get weatherEnabled(){var e,t;return!((e=this.view)==null||(t=e.environmentManager)==null||!t.weatherEnabled)}get precipitationEnabled(){return this._precipitationEnabled}set precipitationEnabled(e){this._precipitationEnabled=e}initializeRenderContext(e=null){this._context=e,this._handles.add([eH(this.view,"basemapTerrain",()=>this._updateBasemapTerrain(),!0),Nt(()=>({viewingMode:this.view.viewingMode,atmosphereEnabled:this.view.environment.atmosphereEnabled,atmosphereQuality:this.view.environment.atmosphere.quality}),()=>this._updateAtmosphere(),rc),Nt(()=>this._stars,()=>this._setNeedsRender()),Nt(()=>this._clouds,()=>this._updateWeather(this._weatherUpdateParameters),fn),Nt(()=>this._precipitation,()=>this._setNeedsRender()),Nt(()=>this._fog,()=>this._updateFog(this._weatherUpdateParameters),fn),Nt(()=>this._weatherUpdateParameters,t=>{this._updateWeather(t),this._updateFog(t)},rc)])}uninitializeRenderContext(){this._context=null,this._atmosphere=rt(this._atmosphere),this._set("_stars",rt(this._stars)),this._set("_precipitation",rt(this._precipitation)),this._set("_clouds",rt(this._clouds)),this._set("_cloudComposition",rt(this._cloudComposition)),this._set("_fog",rt(this._fog))}render(e){if(e.pass===Le.MATERIAL)switch(e.slot){case ve.POSTPROCESSING_ENVIRONMENT_OPAQUE:_(this._stars)&&this._stars.render(e),_(this._atmosphere)&&this._atmosphere.canRender&&(this._atmosphere.render(e),s9e(this._clouds)&&_(this._cloudComposition)&&(this._cloudComposition.render(e,this._clouds,_(this.view.animation)),this._cloudComposition.isFading&&this._setNeedsRender()));break;case ve.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(_(this._atmosphere)&&this._atmosphere.canRender){const t=this.weatherEnabled?this.view.environment.weather.type:"disabled";if(this._atmosphere.renderHaze(e,t==="rainy"),_(this._fog)){const i=t==="foggy"||t==="rainy"||t==="snowy";(i||this._selectAtmosphereType()!=="realistic")&&this._fog.render(e,i,t==="rainy")}this.view.environment.weather.type!=="rainy"&&this.view.environment.weather.type!=="snowy"||!_(this._precipitation)||this._precipitation.render(e,this.view.environment.weather.precipitation,this.view.environment.weather.type==="rainy"?oc.RAIN:oc.SNOW)}}}get _weatherUpdateParameters(){const e=this.weatherEnabled?this.view.environment.weather:null;return R(e)?null:e.type==="rainy"||e.type==="snowy"?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:e.type==="foggy"?e.fogStrength:e.cloudCover}}_updateWeather(e){R(e)||R(this._clouds)||(this._clouds.applyPreset(Vge[e.type],e.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){_(this._context)&&this._context.requestRender()}_updateFog(e){if(!R(this._fog)&&!R(e))switch(e.type){case"foggy":this._fog.strength=qt(3e-5,.005,e.weatherAdjustment**3),this._setNeedsRender();break;case"rainy":case"snowy":this._fog.strength=qt(4e-6,8e-5,e.effect**3),this._setNeedsRender();break;default:this._fog.strength=4e-6,this._setNeedsRender()}}_updateAtmosphere(){const e=this._selectAtmosphereType();if(this.atmosphereType===e)return;_(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return _(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const i=new t(this.view);_(this._context)&&i.initializeRenderContext(this._context),R(this._atmosphere)&&(this._atmosphere=i,this._setNeedsRender()),this._pendingAtmosphere=i,i.when().then(()=>{_(this._atmosphere)&&this._pendingAtmosphere&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()}).catch(()=>{this._pendingAtmosphere===i&&(this._pendingAtmosphere=null)})}_getAtmosphereClass(){switch(this._selectAtmosphereType()){case"none":return null;case"realistic":return uee;case"panoramic":return J9e;case"simple":return aGe;default:return}}_selectAtmosphereType(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),i=this.view.viewingMode;return!e||t==null||Np(this.view.spatialReference)?"none":i==="local"?"panoramic":t==="high"&&_(this._context)&&uee.isSupported(this._context)&&OT(this.view.spatialReference)?"realistic":"simple"}_updateBasemapTerrain(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=_(this._atmosphere)&&this.atmosphereType==="simple")}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType(),stubGetAtmosphereClass:e=>{Iee=wA.prototype._getAtmosphereClass,wA.prototype._getAtmosphereClass=e},restoreGetAtmosphereClass:()=>{wA.prototype._getAtmosphereClass=Iee},precipitationEnabled:e=>{this.precipitationEnabled=e}}}};u([d({constructOnly:!0})],Mo.prototype,"view",void 0),u([d({type:Boolean,readOnly:!0})],Mo.prototype,"updating",null),u([d()],Mo.prototype,"weatherVisible",null),u([d()],Mo.prototype,"_context",void 0),u([d()],Mo.prototype,"_pendingAtmosphere",void 0),u([d({readOnly:!0})],Mo.prototype,"_stars",null),u([d({readOnly:!0})],Mo.prototype,"_precipitation",null),u([d({readOnly:!0})],Mo.prototype,"_clouds",null),u([d({readOnly:!0})],Mo.prototype,"_cloudComposition",null),u([d({readOnly:!0})],Mo.prototype,"_fog",null),u([d()],Mo.prototype,"weatherEnabled",null),u([d()],Mo.prototype,"_precipitationEnabled",void 0),u([d({readOnly:!0})],Mo.prototype,"_weatherUpdateParameters",null),Mo=wA=u([P("esri.views.3d.environment.EnvironmentRenderer")],Mo);function $ee(e,t,i){return yGe(e,t.longitude,t.latitude,i.longitude,i.latitude)}function yGe(e,t,i,r,s){const n=Rt(i),o=Rt(s),a=n-o,l=Rt(t)-Rt(r),c=Math.sin(a/2),h=Math.sin(l/2),p=2*Yh(Math.sqrt(c*c+Math.cos(n)*Math.cos(o)*h*h))*e;return Math.round(1e4*p)/1e4}function vGe(e,t,i){const r=t.spatialReference,s=di(r),n=new et(t.x,e.y,r),o=new et(i.x,e.y,r),a=new et(e.x,t.y,r),l=new et(e.x,i.y,r);return{lon:$ee(s.radius,n,o),lat:$ee(s.radius,a,l)}}function _Ge(e,t,i){const r=t/i,s=Rt(e),n=Math.sin(r/2),o=Math.cos(s),a=2*Yh(Math.sqrt(n*n/(o*o)));return yl(a)}function bGe(e,t){let i=e/15;return t||(i=Math.round(i)),i}function Dee(e,t){t||(t={hours:0,minutes:0,seconds:0}),t.hours=bGe(e[0],!0);const i=t.hours%1;t.hours-=i,t.minutes=60*i;const r=t.minutes%1;return t.minutes-=r,t.seconds=Math.round(60*r),t}var Lee,Nee,Fee,eye={exports:{}};Lee=eye,Nee=function(){var e=Math.PI,t=Math.sin,i=Math.cos,r=Math.tan,s=Math.asin,n=Math.atan2,o=Math.acos,a=e/180,l=864e5,c=2440588,h=2451545,p={dec:0,ra:0};function f($){return $.valueOf()/l-.5+c}function g($){return new Date(($+.5-c)*l)}function y($){return f($)-h}var v=23.4397*a;function b($,F){return n(t($)*i(v)-r(F)*t(v),i($))}function w($,F){return s(t(F)*i(v)+i(F)*t(v)*t($))}function S($,F,k){return n(t($),i($)*t(F)-r(k)*i(F))}function T($,F,k){return s(t(F)*t(k)+i(F)*i(k)*i($))}function A($,F){return a*(280.16+360.9856235*$)-F}function C($){return a*(357.5291+.98560028*$)}function O($){return a*(1.9148*t($)+.02*t(2*$)+3e-4*t(3*$))}function L($,F){return $+F+102.9372*a+e}function U($,F){var k=C($),G=L(k,O(k));return F||(F={dec:0,ra:0}),F.dec=w(G,0),F.ra=b(G,0),F}var N={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function($,F,k,G){var W=a*-k,K=a*F,H=y($),ee=U(H,p),ye=A(H,W)-ee.ra;return G||(G={azimuth:0,altitude:0}),G.azimuth=S(ye,K,ee.dec),G.altitude=T(ye,K,ee.dec),G}},z=[[-.83,"sunrise","sunset"]];N.addTime=function($,F,k){z.push([$,F,k])};var V=9e-4;function B($,F){return Math.round($-V-F/(2*e))}function J($,F,k){return V+($+F)/(2*e)+k}function Q($,F,k){return h+$+.0053*t(F)-.0069*t(2*k)}function te($,F,k){return o((t($)-t(F)*t(k))/(i(F)*i(k)))}function ie($){var F=a*(134.963+13.064993*$),k=a*(93.272+13.22935*$),G=a*(218.316+13.176396*$)+6.289*a*t(F),W=5.128*a*t(k),K=385001-20905*i(F);return{ra:b(G,W),dec:w(G,W),dist:K}}return N.getTimes=function($,F,k){var G=a*-k,W=a*F,K=B(y($),G),H=J(0,G,K),ee=C(H),ye=O(ee),Ae=L(ee,ye),Ve=w(Ae,0),Se=Q(H,ee,Ae);function xe(Is){return Q(J(te(Is,W,Ve),G,K),ee,Ae)}function Re(Is){var Tb=(t(Is)-t(W)*t(Ve))/(i(W)*i(Ve));return Tb<-1?N.PolarException.MIDNIGHT_SUN:Tb>1?N.PolarException.POLAR_NIGHT:N.PolarException.NORMAL}var ze,ji,Yr,Ms,Ps,ds={solarNoon:g(Se),nadir:g(Se-.5),polarException:N.PolarException.NORMAL};for(ze=0,ji=z.length;ze<ji;ze+=1)Ps=Se-((Ms=xe((Yr=z[ze])[0]*a))-Se),ds[Yr[1]]=g(Ps),ds[Yr[2]]=g(Ms);return ds.polarException=Re(z[0][0]*a),ds},N.getMoonPosition=function($,F,k){var G=a*-k,W=a*F,K=y($),H=ie(K),ee=A(K,G)-H.ra,ye=T(ee,W,H.dec);return ye+=.017*a/r(ye+10.26*a/(ye+5.1*a)),{azimuth:S(ee,W,H.dec),altitude:ye,distance:H.dist}},N.getMoonFraction=function($){var F=y($),k=U(F),G=ie(F),W=149598e3,K=o(t(k.dec)*t(G.dec)+i(k.dec)*i(G.dec)*i(k.ra-G.ra)),H=n(W*t(K),G.dist-W*i(K));return(1+i(H))/2},N},(Fee=Nee())!==void 0&&(Lee.exports=Fee);const W1=eye.exports,rp={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function wGe(e,t,i,r,s,n,o){oe(o.ambient.color,1,1,1),o.ambient.intensity=rp.global.ambient,oe(o.direct.color,1,1,1),o.direct.intensity=rp.global.direct;const a=t[2],l=Be((Math.abs(a)-rp.local.altitude)/(rp.global.altitude-rp.local.altitude),0,1);let c;if(o.globalFactor=l,n==="sun"&&(c=W1.getTimes(e,t[1],t[0])),l<1){let h;if(n==="sun")h=OGe(e,c,r);else{const p=iye(r);h={direct:{intensity:rp.local.directAtNoon*p.direct,color:je(1,1,1)},ambient:{intensity:rp.local.ambientAtNoon*p.ambient,color:je(1,1,1)},timeOfDay:"early afternoon"}}Cs(o.ambient.color,h.ambient.color,o.ambient.color,l),o.ambient.intensity=qt(h.ambient.intensity,o.ambient.intensity,l),Cs(o.direct.color,h.direct.color,o.direct.color,l),o.direct.intensity=qt(h.direct.intensity,o.direct.intensity,l),o.specularStrength=r==="rainy"||r==="snowy"||r==="foggy"?0:1,o.environmentStrength=r==="rainy"?.7:r==="snowy"||r==="foggy"?.75:1}o.noonFactor=n==="sun"?RGe(e,c):1,n==="sun"?TGe(e,t,i,o.direct.directionToLightSource):xGe(s,i,o.direct.directionToLightSource)}function xGe(e,t,i){t===Ie.Global?be(l3,e.eye):oe(l3,0,0,1),Tl(a3,MGe,e.viewRight),ke(i,l3,a3),Tl(a3,PGe,l3),ke(i,i,a3)}function TGe(e,t,i,r){const s=CGe,n=Ap(AGe);if(i===Ie.Global)W1.getPosition(e,0,0,s),oe(r,0,0,-1),VT(n,n,-s.azimuth),iF(n,n,-s.altitude),ke(r,r,n);else{const o=rp.planarDirection,a=o.globalAngles,l=t[2];let c=(Math.abs(l)-o.localAltitude)/(o.globalAltitude-o.localAltitude);c=Be(c,0,1),c<1?(W1.getPosition(e,t[1],t[0],s),s.azimuth=(1-c)*s.azimuth+c*a.azimuth,s.altitude=(1-c)*s.altitude+c*a.altitude):(s.azimuth=a.azimuth,s.altitude=a.altitude),oe(r,0,-1,0),GT(n,n,-s.azimuth),VT(n,n,-s.altitude),ke(r,r,n)}}function SGe(e,t){if(t===Ie.Global)return!0;const i=rp.planarDirection;return Math.abs(e)<i.localAltitude}const EGe=je(.5773502691896258,-.5773502691896258,.5773502691896258);class tye{constructor(){this.ambient={color:je(1,1,1),intensity:.55},this.direct={color:je(1,1,1),intensity:.55,directionToLightSource:As(EGe)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const AGe=Te(),CGe={azimuth:0,altitude:0};function RGe(e,t){const i=e.valueOf();let r,s;t.polarException===W1.PolarException.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=r+432e6):t.polarException===W1.PolarException.POLAR_NIGHT?(r=i-2,s=i-1):(r=t.sunrise.valueOf(),s=t.sunset.valueOf());const n=r+(s-r)/2;return 1-Be(Math.abs(i-n)/432e5,0,1)}function iye(e){switch(e){case"disabled":case"sunny":case"cloudy":return{direct:1,ambient:1};case"rainy":return{direct:.4,ambient:1.2};case"snowy":return{direct:.5,ambient:1.3};case"foggy":return{direct:.2,ambient:1.6}}}function Uee(e,t){const i=(e[0]+e[1]+e[2])/3;for(let r=0;r<3;r++)e[r]=e[r]+(i-e[r])*t;return e}function OGe(e,t,i){const r=e.valueOf();let s,n;t.polarException===W1.PolarException.MIDNIGHT_SUN?(s=r-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,n=s+432e6):t.polarException===W1.PolarException.POLAR_NIGHT?(s=r-2,n=r-1):(s=t.sunrise.valueOf(),n=t.sunset.valueOf());const o=n-s,a=s+o/2,l=o/4,c=a-l,h=a+l,p=.06*o,f=s-p/2,g=s+p/2,y=n-p/2,v=n+p/2,b=rp.local,w=[.01,b.ambientAtNight],S=[.8,.8,1],T=[.01,.01,.01],A=[b.directAtTwilight,b.ambientAtTwilight],C=[1,.6,.5],O=[.8,.8,1],L=[.9*b.directAtNoon,b.ambientAtNoon],U=[1,.98,.98],N=[.98,.98,1],z=[b.directAtNoon,b.ambientAtNoon],V=[1,1,1],B=[1,1,1],J=L,Q=U,te=N,ie=A,$=C,F=O;let k,G,W=[0,0],K=[0,0,0],H=[0,0,0];r<f||r>v?(W=w,K=T,H=S,G="night"):r<g?(k=g-f,W=An(r-f,k,w,A),K=An(r-f,k,T,C),H=An(r-f,k,S,O),G="sun rising"):r<c?(k=c-g,W=An(r-g,k,A,L),K=An(r-g,k,C,U),H=An(r-g,k,O,N),G="early morning"):r<a?(k=a-c,W=An(r-c,k,L,z),K=An(r-c,k,U,V),H=An(r-c,k,N,B),G="late morning"):r<h?(k=h-a,W=An(r-a,k,z,J),K=An(r-a,k,V,Q),H=An(r-a,k,B,te),G="early afternoon"):r<y?(k=y-h,W=An(r-h,k,J,ie),K=An(r-h,k,Q,$),H=An(r-h,k,te,F),G="late afternoon"):r<v&&(k=v-y,W=An(r-y,k,ie,w),K=An(r-y,k,$,T),H=An(r-y,k,F,S),G="sun setting");let ee=0;switch(i){case"rainy":case"foggy":ee=.9;case"snowy":ee=.5}ee>0&&(K=Uee(K,ee),H=Uee(H,ee));const ye=je(K[0],K[1],K[2]),Ae=je(H[0],H[1],H[2]),Ve=iye(i);return{direct:{intensity:W[0]*Ve.direct,color:ye},ambient:{intensity:W[1]*Ve.ambient,color:Ae},timeOfDay:G}}function An(e,t,i,r){const s=[];for(let n=0;n<i.length;n++)s[n]=(r[n]-i[n])*e/t+i[n];return s}const a3=Te(),l3=M(),MGe=.35,PGe=-.5;class Dq{constructor(t=M()){this.intensity=t}}class rye{constructor(t=M(),i=je(.57735,.57735,.57735)){this.intensity=t,this.direction=i}}class D9{constructor(t=M(),i=je(.57735,.57735,.57735),r=!0,s=1,n=1){this.intensity=t,this.direction=i,this.castShadows=r,this.specularStrength=s,this.environmentStrength=n}}class sye{constructor(){this.r=[0],this.g=[0],this.b=[0]}}let _h=class extends xr.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new Ut,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new D9,this._ambientLight=new Dq,this._moonLight=new rye,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get _view(){var e;return(e=this._renderer)==null?void 0:e.view}get updating(){var e;return!!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||(e=this._renderer)!=null&&e.updating)}get weatherEnabled(){var e,t,i;return((e=this._view)==null?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&((t=this._view)==null||(i=t.state)==null?void 0:i.viewingMode)===Ie.Global&&OT(this._view.spatialReference)}get weatherVisible(){var e;return this.weatherEnabled&&((e=this._renderer)==null?void 0:e.weatherVisible)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){if(this._renderer)return;this._renderer=new Mo({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler(),r=()=>this._updateLighting();this._viewHandles.add([Nt(()=>e.environment.lighting,s=>this._updateLightingHandler(s),Sh),Nt(()=>e.environment.lighting.date,s=>this._lightingDateHandler(s),Sh),Nt(()=>e.stationary,()=>this._interactingStationaryHandler()),Nt(()=>e.environment.lighting.directShadowsEnabled,t,Sh),Nt(()=>e.environment.lighting.ambientOcclusionEnabled,t,Sh),Nt(()=>e.environment.lighting.waterReflectionEnabled,t,Sh),Nt(()=>{var s;return(s=e.environment.background)==null?void 0:s.color},t,Sh),Nt(()=>e.spatialReference,()=>this._resetReferencePosition(!0),Sh),Nt(()=>e.environment.weather.type,r,Sh),Nt(()=>this.weatherEnabled,r,Sh),Nt(()=>e.viewingMode,()=>this._resetReferencePosition(!0),rc),Nt(()=>e.environment.lighting.type==="sun"&&e.environment.lighting.cameraTrackingEnabled,s=>this._updateCameraTracking(s),rc),Nt(()=>e.state.camera,i,rc),Nt(()=>this.disableQueries,i)]),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=rt(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking(e.type==="sun"&&e.cameraTrackingEnabled),this._lightingDateHandler(e.date),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const t=this._view.environment.lighting;(t==null?void 0:t.type)==="sun"&&(t.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if((t==null?void 0:t.type)!=="virtual"){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!I1(i)){const r=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(r))return void this._requestReferencePositionUpdate(r)}if(this._preupdateTracking(e),_(this._referencePosWGS84Comparable)){const r=Dee(this._referencePosWGS84Comparable,kee);_(r)&&(t.autoUpdate(null,r),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.type==="sun"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;i&&(this._cameraHandlerClientSide(i,e)||this._cameraHandlerServerSide(i))}_cameraHandlerClientSide(e,t){const i=OT(this._view.spatialReference);if(i&&!I1(this._view.spatialReference))return!1;const r=e.position;return R(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=M()),i?MOe(r,this._referencePosWGS84Comparable):oe(this._referencePosWGS84Comparable,r.longitude,r.latitude,r.z),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLighting(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLighting(e){const t=this._view,i=e||t.environment.lighting.date,r=this._referencePosWGS84Comparable,s=_(r)?IGe:$Ge;if(_(r)){const h=this.weatherVisible?t.environment.weather.type:"disabled";wGe(i,r,t.state.viewingMode,h,t.state.camera,t.environment.lighting.type,s)}const n=this._mainLight,o=s.direct;ae(n.intensity,o.color,o.intensity*Math.PI),ne(n.direction,o.directionToLightSource),n.specularStrength=s.specularStrength,n.environmentStrength=s.environmentStrength;const a=this._ambientLight;ae(a.intensity,s.ambient.color,s.ambient.intensity);const l=this._moonLight;Cs(l.intensity,LGe,NGe,s.globalFactor);const c=(1-.5*s.globalFactor)*(1-.4*s.noonFactor*(1-s.globalFactor));ae(l.intensity,l.intensity,c),ne(l.direction,o.directionToLightSource),t._stage.renderView.updateLightSources([n,a,l],1-s.noonFactor,s.globalFactor),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||R(e))return!1;const i=DGe;i.setTime((t||this._view.environment.lighting.date).getTime());const r=Dee(e,kee);if(R(r))return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;const n=i.getUTCHours()-(r.hours-s.hours),o=i.getUTCMinutes()-(r.minutes-s.minutes),a=i.getUTCSeconds()-(r.seconds-s.seconds);return i.setUTCHours(n),i.setUTCMinutes(o),i.setUTCSeconds(a),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const t=tl(this._referencePosWGS84Comparable,!0,s=>SGe(s[2],this._view.state.viewingMode)),i=this._view.environment.background,r=i instanceof tge?{type:"color",color:Uj(Je.toUnitRGBA(i.color))}:{type:"color",color:yi(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,fillLightsEnabled:this._view.environment.lighting.type==="sun",background:r})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const i=this._referencePosUpdateQuery=AT(this._referencePointUpdateDelay).then(()=>{if(this._referencePosUpdateQuery===i){const s=()=>this._referencePosUpdateQuery!==i;return this._doReferencePositionUpdateQuery(s)}}).catch(s=>{s.name==="mapcoordshelper:missing-geometry-service"&&(this.disableQueries=!0)}).then(()=>{this._referencePosUpdateQuery===i&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))}),r=this._referencePosUpdateTimer=AT(this._referencePointUpdateInterval).then(()=>{this._referencePosUpdateTimer===r&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())});this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const i=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=i):this._referencePosWGS84Comparable=[t[0],t[1],i],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){const e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t},set disableWeather(t){e._disableWeather=t}}}};u([d({type:Boolean,readOnly:!0})],_h.prototype,"updating",null),u([d()],_h.prototype,"disableQueries",void 0),u([d()],_h.prototype,"_disableWeather",void 0),u([d()],_h.prototype,"weatherEnabled",null),u([d()],_h.prototype,"weatherVisible",null),u([d()],_h.prototype,"referencePositionWGS84Comparable",null),u([d()],_h.prototype,"_renderer",void 0),u([d()],_h.prototype,"_referencePosWGS84Comparable",void 0),_h=u([P("esri.views.3d.environment.SceneViewEnvironmentManager")],_h);const IGe=new tye,$Ge=new tye,DGe=new Date,kee={hours:0,minutes:0,seconds:0},LGe=je(.22,.22,.33),NGe=je(.22,.22,.22);function SR(e,t){return(e&t)!=0}function EL(e,t,i,r,s,n){e!==0&&(i?(n.min=Math.min(n.min,t),n.max=Math.max(n.max,t)):r!=null?(n.min-=Math.max(0,(t-n.min)*(1-r)),n.max+=Math.max(0,(t-n.max)*(1-r))):s&&(n.min-=Math.max(0,t-n.min-s),n.max+=Math.max(0,t-n.max-s)))}var Mt,Yi,en;(function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"})(Mt||(Mt={})),function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"}(Yi||(Yi={})),function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"}(en||(en={}));const C0={selection:Yi.NONE,interactionType:Mt.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:en.TUMBLE};function nye(e,t,i,r){return t=t||e.viewForward,ne(r,t),ae(r,r,Math.sign(_e(t,i))),r}function FGe(e,t,i,r){return VGe(e,t,i,zGe(r,t,i,!0))}function UGe(e,t,i,r){const s=_e(i,de(e,r,t));return pe(e,t,ae(e,i,s))}const kGe={dir:M(),len:0,clip:Ye()};function zGe(e,t,i,r){const s=kGe;return e?(i&&r&&(s.len=xi(t,i)),ne(s.dir,e)):r?(s.len=xi(t,i),de(s.dir,i,t),ae(s.dir,s.dir,1/s.len)):(de(s.dir,i,t),be(s.dir,s.dir)),s}function BGe(e,t,i){const r=_e(e,i.dir),s=-tr(e,t);if(s<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return s>0;if((s<0||r<0)&&!(s<0&&r<0))return!0;const n=s/r;return r>0?n<i.clip[1]&&(i.clip[1]=n):n>i.clip[0]&&(i.clip[0]=n),i.clip[0]<=i.clip[1]}function VGe(e,t,i,r){r.clip[0]=0,r.clip[1]=i?r.len:Number.MAX_VALUE;for(let s=0;s<e.length;s++)if(!BGe(e[s],t,r))return!1;return!0}function GGe(e,t,i=C0){const r=Lq(e,t,i);if(r===0)return!1;const s=e.renderCoordsHelper,n=s.getAltitude(t.eye)+r,o=nye(t,i.interactionDirection,qGe(e,t,Math.sign(r),ZGe),YGe),a=ne(QGe,t.viewForward),l=s.intersectInfiniteManifold(xc(t.eye,o),n,JU);return t.eye=_(l)?l:s.setAltitude(JU,n,t.eye),t.center=UGe(JU,t.eye,a,t.center),!0}function Lq(e,t,i=C0){if(!jGe(e,i))return 0;const r=WGe(e.state.constraints.altitude,XGe);HGe(e,i,r);const s=e.renderCoordsHelper.getAltitude(t.eye),n=Be(s,r.min,r.max)-s;return Math.abs(n)<=1e-6?0:n}function jGe(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i)&&(t.interactionType!==Mt.TUMBLE||!SR(t.selection,Yi.TILT))}function HGe(e,t,i){const r=t.interactionType;if(r===Mt.NONE)return;const{min:s,max:n}=i,{interactionStartCamera:o,interactionFactor:a}=t,l=r===Mt.TUMBLE||r===Mt.ZOOM,c=Lq(e,o),h=c===0?0:e.renderCoordsHelper.getAltitude(o.eye);i.min=s,i.max=n,EL(c,h,l,a,.05*h,i)}function qGe(e,t,i,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),ae(r,r,i),r}function WGe(e,t){return t.min=e.min,t.max=e.max,t}const XGe={min:0,max:0},YGe=M(),ZGe=M(),QGe=M(),JU=M();function Nq(e,t,i=C0){if(!e.state.isLocal)return 0;const r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;c3.min=0,c3.max=r,KGe(e,i,c3);const s=Fq(e,t),n=c3.max-s;return n>=-1e-6?0:n}function JGe(e,t,i=C0){const r=Nq(e,t,i);if(r===0)return!1;const s=e.pointsOfInterest.surfaceOrigin,n=Fq(e,t)+r,o=ne(t7e,t.eye),a=nye(t,i.interactionDirection,e7e(e,t,s7e),r7e);if(!B0(Due(s.renderLocation,n),xc(t.eye,a),u3))return!1;t.eye=u3;const l=de(i7e,t.eye,o);t.center=pe(u3,t.center,l);const c=e.renderCoordsHelper.getAltitude(t.center),h=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,c,u3);return _(h)&&(t.center=h),!0}function KGe(e,t,i){const r=t.interactionType;if(r===Mt.NONE)return;const{min:s,max:n}=i,{interactionStartCamera:o,interactionFactor:a}=t,l=r===Mt.ZOOM||r===Mt.PAN,c=Nq(e,o),h=c===0?0:Fq(e,o);i.min=s,i.max=n,EL(c,h,l,a,.05*h,i)}function Fq(e,t){const i=e.pointsOfInterest.surfaceOrigin;return xi(t.eye,i.renderLocation)}function e7e(e,t,i){const r=e.pointsOfInterest.surfaceOrigin;return Um(i,t.eye,r.renderLocation)}const c3={min:0,max:0},t7e=M(),i7e=M(),r7e=M(),s7e=M(),u3=M();var ur,Wn;(function(e){e[e.OBJECT=0]="OBJECT",e[e.HUD=1]="HUD",e[e.TERRAIN=2]="TERRAIN",e[e.OVERLAY=3]="OVERLAY",e[e.I3S=4]="I3S",e[e.PCL=5]="PCL",e[e.LOD=6]="LOD",e[e.VOXEL=7]="VOXEL"})(ur||(ur={}));class n7e{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=Wn.ALL}}(function(e){e[e.MIN=0]="MIN",e[e.MINMAX=1]="MINMAX",e[e.ALL=2]="ALL"})(Wn||(Wn={}));function jp(e){return _(e)&&_(e.dist)}function zee(e){return(t,i,r)=>(Cs(Bee,t,i,r),!qj(e,Bee))}function oye(e){return jp(e)&&e.intersector===ur.OBJECT&&!!e.target}function Uq(e){return jp(e)&&e.intersector===ur.HUD&&!!e.target&&_(e.target.center)}const Bee=M();class o7e{constructor(){this._transform=Te(),this._transformInverse=new h3({value:this._transform},fr,Te),this._transformInverseTranspose=new h3(this._transformInverse,Oa,Te),this._transformTranspose=new h3({value:this._transform},Oa,Te),this._transformInverseRotation=new h3({value:this._transform},zge,wr)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(t){Ur(this._transform,t)}multiplyTransform(t){dr(this._transform,this._transform,t)}set(t){Ur(this._transform,t),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(t,i){this.setTransformMatrix(t),this.multiplyTransform(i),this._invalidateLazyTransforms()}}class h3{constructor(t,i,r){this.original=t,this.update=i,this.dirty=!0,this.transform=r()}invalidate(){this.dirty=!0}get value(){return this.dirty&&(this.update(this.transform,this.original.value),this.dirty=!1),this.transform}}class a7e{constructor(t=0){this.offset=t,this.tmpVertex=M()}applyToVertex(t,i,r){const s=t+this.localOrigin[0],n=i+this.localOrigin[1],o=r+this.localOrigin[2],a=this.offset/Math.sqrt(s*s+n*n+o*o);return this.tmpVertex[0]=t+s*a,this.tmpVertex[1]=i+n*a,this.tmpVertex[2]=r+o*a,this.tmpVertex}applyToAabb(t){const i=t[0]+this.localOrigin[0],r=t[1]+this.localOrigin[1],s=t[2]+this.localOrigin[2],n=t[3]+this.localOrigin[0],o=t[4]+this.localOrigin[1],a=t[5]+this.localOrigin[2],l=this.offset/Math.sqrt(i*i+r*r+s*s);t[0]+=i*l,t[1]+=r*l,t[2]+=s*l;const c=this.offset/Math.sqrt(n*n+o*o+a*a);return t[3]+=n*c,t[4]+=o*c,t[5]+=a*c,t}}class l7e{constructor(t=0){this.offset=t,this.componentLocalOriginLength=0,this.tmpVertex=M(),this.mbs=ni(),this.obb={center:M(),halfSize:fi(),quaternion:null}}set localOrigin(t){this.componentLocalOriginLength=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}applyToVertex(t,i,r){const s=t,n=i,o=r+this.componentLocalOriginLength,a=this.offset/Math.sqrt(s*s+n*n+o*o);return this.tmpVertex[0]=t+s*a,this.tmpVertex[1]=i+n*a,this.tmpVertex[2]=r+o*a,this.tmpVertex}applyToAabb(t){const i=t[0],r=t[1],s=t[2]+this.componentLocalOriginLength,n=t[3],o=t[4],a=t[5]+this.componentLocalOriginLength,l=this.offset/Math.sqrt(i*i+r*r+s*s);t[0]+=i*l,t[1]+=r*l,t[2]+=s*l;const c=this.offset/Math.sqrt(n*n+o*o+a*a);return t[3]+=n*c,t[4]+=o*c,t[5]+=a*c,t}applyToMbs(t){const i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),r=this.offset/i;return this.mbs[0]=t[0]+t[0]*r,this.mbs[1]=t[1]+t[1]*r,this.mbs[2]=t[2]+t[2]*r,this.mbs[3]=t[3]+t[3]*this.offset/i,this.mbs}applyToObb(t){const i=t.center,r=this.offset/Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);this.obb.center[0]=i[0]+i[0]*r,this.obb.center[1]=i[1]+i[1]*r,this.obb.center[2]=i[2]+i[2]*r,p0(this.obb.halfSize,t.halfSize,t.quaternion),pe(this.obb.halfSize,this.obb.halfSize,t.center);const s=this.offset/Math.sqrt(this.obb.halfSize[0]*this.obb.halfSize[0]+this.obb.halfSize[1]*this.obb.halfSize[1]+this.obb.halfSize[2]*this.obb.halfSize[2]);return this.obb.halfSize[0]+=this.obb.halfSize[0]*s,this.obb.halfSize[1]+=this.obb.halfSize[1]*s,this.obb.halfSize[2]+=this.obb.halfSize[2]*s,de(this.obb.halfSize,this.obb.halfSize,t.center),OO(Hee,t.quaternion),p0(this.obb.halfSize,this.obb.halfSize,Hee),this.obb.halfSize[0]*=this.obb.halfSize[0]<0?-1:1,this.obb.halfSize[1]*=this.obb.halfSize[1]<0?-1:1,this.obb.halfSize[2]*=this.obb.halfSize[2]<0?-1:1,this.obb.quaternion=t.quaternion,this.obb}}class c7e{constructor(t=0){this.offset=t,this.sphere=xn(),this.tmpVertex=M()}applyToVertex(t,i,r){const s=this.objectTransform.transform;let n=s[0]*t+s[4]*i+s[8]*r+s[12],o=s[1]*t+s[5]*i+s[9]*r+s[13],a=s[2]*t+s[6]*i+s[10]*r+s[14];const l=this.offset/Math.sqrt(n*n+o*o+a*a);n+=n*l,o+=o*l,a+=a*l;const c=this.objectTransform.inverse;return this.tmpVertex[0]=c[0]*n+c[4]*o+c[8]*a+c[12],this.tmpVertex[1]=c[1]*n+c[5]*o+c[9]*a+c[13],this.tmpVertex[2]=c[2]*n+c[6]*o+c[10]*a+c[14],this.tmpVertex}applyToMinMax(t,i){const r=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*r,t[1]+=t[1]*r,t[2]+=t[2]*r;const s=this.offset/Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);i[0]+=i[0]*s,i[1]+=i[1]*s,i[2]+=i[2]*s}applyToAabb(t){const i=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*i,t[1]+=t[1]*i,t[2]+=t[2]*i;const r=this.offset/Math.sqrt(t[3]*t[3]+t[4]*t[4]+t[5]*t[5]);return t[3]+=t[3]*r,t[4]+=t[4]*r,t[5]+=t[5]*r,t}applyToBoundingSphere(t){const i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),r=this.offset/i;return this.sphere[0]=t[0]+t[0]*r,this.sphere[1]=t[1]+t[1]*r,this.sphere[2]=t[2]+t[2]*r,this.sphere[3]=t[3]+t[3]*this.offset/i,this.sphere}}const Vee=new c7e;function L9(e){return _(e)?(Vee.offset=e,Vee):null}const Gee=new l7e;function vyt(e){return _(e)?(Gee.offset=e,Gee):null}const jee=new a7e;function u7e(e){return _(e)?(jee.offset=e,jee):null}const N_="terrain",Hee=k0();function AL(e,t,i){for(let r=0;r<i;++r)t[2*r]=e[r],t[2*r+1]=e[r]-t[2*r]}function h7e(e,t,i,r){for(let s=0;s<r;++s)qee[0]=e[s],AL(qee,KU,1),t[s]=KU[0],i[s]=KU[1]}const qee=new Float64Array(1),KU=new Float32Array(2);function N9(e,t){return R(e)&&(e=[]),e.push(t),e}function F9(e,t){if(R(e))return null;const i=e.filter(r=>r!==t);return i.length===0?null:i}function IO(e){return!!_(e)&&!e.visible}function d7e(e,t,i){const r=e.origin.vec3;Xge(ek,-r[0],-r[1],-r[2]),_(e.transformation)?dr(t,ek,e.transformation):Ur(t,ek),i&&(fr(i,t),Oa(i,i))}function p7e(e,t,i,r,s){d3[0]=e.get(t,0),d3[1]=e.get(t,1),d3[2]=e.get(t,2),AL(d3,iv,3),i.set(s,0,iv[0]),r.set(s,0,iv[1]),i.set(s,1,iv[2]),r.set(s,1,iv[3]),i.set(s,2,iv[4]),r.set(s,2,iv[5])}const d3=new Float64Array(3),iv=new Float32Array(6),ek=Te(),_S=1e-5;class f7e{constructor(t){this.options=new n7e,this._results=new m7e,this.transform=new o7e,this.tolerance=_S,this.verticalOffset=null,this._ray=Vn(),this._rayEnd=M(),this._rayBeginTransformed=M(),this._rayEndTransformed=M(),this.viewingMode=t==null?Ie.Global:t}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,i,r){this.resetWithRay(rMe(t,i,this._ray),r)}resetWithRay(t,i){this.camera=i,t!==this._ray&&UD(t,this._ray),this.options.verticalOffset!==0?this.viewingMode===Ie.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,pe(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(t=null,i,r,s,n){this.point=i,this.filterPredicate=s,this.tolerance=r==null?_S:r;const o=L9(this.verticalOffset);if(_(t)&&t.length>0){const a=n?l=>{n(l)&&this.intersectObject(l)}:l=>{this.intersectObject(l)};for(const l of t){const c=l.getSpatialQueryAccelerator&&l.getSpatialQueryAccelerator();_(c)?(_(o)?c.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,a,o):c.forEachAlongRay(this._ray.origin,this._ray.direction,a),this.options.selectionMode&&this.options.hud&&c.forEachDegenerateObject(a)):l.objects.forAll(h=>a(h))}}this.sortResults()}intersectObject(t){const i=t.geometryRecords;if(!i)return;const r=t.transformation,s=L9(this.verticalOffset);for(const n of i){const{geometry:o,material:a,instanceParameters:l}=n;if(IO(l))continue;const c=o.id;this.transform.setAndInvalidateLazyTransforms(r,n.getShaderTransformation()),ke(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),ke(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const h=this.transform.transform;_(s)&&(s.objectTransform=this.transform),a.intersect(o,l,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(p,f,g,y,v,b)=>{if(p>=0){if(_(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,p))return;if(y){if(this._results.hud.dist==null||p<this._results.hud.dist){const S={object:t,geometryId:c,triangleNr:g,center:b};this._results.hud.set(ur.HUD,S,p,f,ls,v)}return}const w=S=>S.set(ur.OBJECT,{object:t,geometryId:c,triangleNr:g},p,f,h,v);if((this._results.min.drapedLayerOrder==null||v>=this._results.min.drapedLayerOrder)&&(this._results.min.dist==null||p<this._results.min.dist)&&w(this._results.min),this.options.store!==Wn.MIN&&(this._results.max.drapedLayerOrder==null||v<this._results.max.drapedLayerOrder)&&(this._results.max.dist==null||p>this._results.max.dist)&&w(this._results.max),this.options.store===Wn.ALL){const S=QF(this._ray);S.set(ur.OBJECT,{object:t,geometryId:c,triangleNr:g},p,f,h),this._results.all.push(S)}}},n.shaderTransformation)}}sortResults(){this._results.all.sort((t,i)=>t.dist!==i.dist?gt(t.dist,0)-gt(i.dist,0):t.drapedLayerOrder!==i.drapedLayerOrder?gt(t.drapedLayerOrder,Number.MAX_VALUE)-gt(i.drapedLayerOrder,Number.MAX_VALUE):gt(i.drapedLayerGraphicOrder,Number.MIN_VALUE)-gt(t.drapedLayerGraphicOrder,Number.MIN_VALUE))}}function ku(e){return new f7e(e)}class m7e{constructor(){this._min=new xA(Vn()),this._max=new xA(Vn()),this._hud=new xA(Vn()),this._ground=new xA(Vn())}get min(){return this._min}get max(){return this._max}get hud(){return this._hud}get ground(){return this._ground}init(t){this._min.init(t),this._max.init(t),this._hud.init(t),this._ground.init(t),this.all=[]}}class xA{constructor(t){this.intersector=ur.OBJECT,this.normal=M(),this.transformation=Te(),this._ray=Vn(),this.init(t)}get ray(){return this._ray}get distanceInRenderSpace(){return _(this.dist)?(ae(p3,this.ray.direction,this.dist),Pe(p3)):null}getIntersectionPoint(t){return!!jp(this)&&(ae(p3,this.ray.direction,this.dist),pe(t,this.ray.origin,p3),!0)}getTransformedNormal(t){return ne(D2,this.normal),D2[3]=0,Ou(D2,D2,this.transformation),ne(t,D2),be(t,t)}init(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=ur.OBJECT,UD(t,this._ray)}set(t,i,r,s,n,o,a){this.intersector=t,this.dist=r,ne(this.normal,gt(s,aoe)),Ur(this.transformation,gt(n,ls)),this.target=i,this.drapedLayerOrder=o,this.drapedLayerGraphicOrder=a}copy(t){UD(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,ne(this.normal,t.normal),Ur(this.transformation,t.transformation)}}function QF(e){return new xA(e)}const p3=M(),D2=ni();function aye(e,t,i,r){return _(e.renderCoordsHelper.fromRenderCoords(t.eye,CL,r))&&ej(i,CL)}function JF(e,t){return e.elevationProvider?gt(e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground"),0):0}function bb(e,t,i,r){const s=e.state.camera.clone();t&&(s.eye=t,s.center=i,s.up=r),g7e(e,s.ray,hg)||ne(hg,s.center);const n=e.state.constraints,o=n.minimumPoiDistance;if(qn(s.eye,hg)<o){const a=n.collision.enabled;ne(rv,s.viewForward),ae(rv,rv,o),a?s.eye=de(CL,hg,rv):pe(hg,s.eye,rv);const l=e.renderCoordsHelper,c=l.getAltitude(s.eye),h=n.collision.elevationMargin;a&&c<h&&(de(rv,hg,s.eye),s.eye=l.setAltitude(CL,h,s.eye),pe(hg,s.eye,rv))}return s.center=hg,s}function Wee(e,t,i){if(!e.state.isGlobal)return!1;const r=JF(e,t),s=e.stateManager.constraintsManager.nearFarHeuristic,{far:n}=s.compute(t,i,e.renderDataExtent,r,v7e),o=n*n;return qn(t,i)>o}function g7e(e,t,i){let r=Xee[e.viewingMode];r||(r=ku(e.state.viewingMode),r.options.backfacesTerrain=!e.state.isGlobal,r.options.invisibleTerrain=!0,Xee[e.viewingMode]=r);const{isGlobal:s}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(t,r,i)||Wee(e,t.origin,i))||!(!e.renderCoordsHelper.intersectManifold(t,0,i)||Wee(e,t.origin,i))||!!s&&y7e(t,i,di(e.spatialReference).radius)}function y7e(e,t,i){const r=_e(e.origin,e.origin)-i*i,s=r>0?Math.sqrt(r)/3:1;return ae(t,e.direction,s/Pe(e.direction)),pe(t,t,e.origin),!0}const Xee={},CL=M(),hg=M(),rv=M(),v7e={near:0,far:0};function i2(e,t,i=Ru.EYE){const r=e.state.constraints;if(!r.collision.enabled)return!1;const s=JF(e,t.eye),n=e.renderCoordsHelper.getAltitude(t.eye),o=s+r.collision.elevationMargin;if(n>=o)return!1;const a=Pe(t.eye);if(de(f3,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(_7e,o,t.eye),i===Ru.EYE_AND_CENTER)t.center=pe(f3,t.eye,f3);else if(i===Ru.EYE_AND_CENTER_SCALE){const l=(a-n+o)/a;t.center=ae(f3,t.center,l)}return!0}var Ru;(function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"})(Ru||(Ru={}));const f3=M(),_7e=M();function R0(e,t,i){e.worldUpAtPosition(t,Yee),de(tk,i,t);const r=Pe(tk);return r===0?0:Rs(_e(tk,Yee)/r)}const Yee=M(),tk=M();function lye(e,t,i=C0,r=!0){L2.eyeCenterDistance=0,L2.requiresTwoSteps=!1;const s=kq(e,t,i,void 0,L2);if(s===0)return!1;switch(Tl(m3,-s,t.viewRight),i.tiltMode){case en.LOOK_AROUND:ke(dg,t.viewForward,m3),ae(dg,dg,L2.eyeCenterDistance),t.center=pe(Py,t.eye,dg);break;case en.TUMBLE:de(dg,t.center,t.eye),ke(dg,dg,m3),t.eye=de(Py,t.center,dg);break;default:i.tiltMode}return t.up=ke(Py,t.up,m3),!L2.requiresTwoSteps||!r||lye(e,t,i,!1)}function kq(e,t,i=C0,r=C0,s){if(!e.state.constraints.tilt)return 0;const n=t.distance,o=e.state.constraints.tilt(n,O7e);return R7e(e,i,o),r.interactionType===Mt.TUMBLE&&SR(r.selection,Yi.ALTITUDE)&&cye(e,r.interactionStartCamera,o),i.tiltMode===en.LOOK_AROUND||r.tiltMode===en.LOOK_AROUND?w7e(e,t,o,s):b7e(e,t,o)}function b7e(e,t,i){const r=R0(e.renderCoordsHelper,t.center,t.eye),s=r-Be(r,i.min,i.max);return ER(s)?s:0}function w7e(e,t,i,r){switch(r&&(r.requiresTwoSteps=!1),e.viewingMode){case"global":return T7e(e,t,i,r);case"local":return x7e(e,t,i,r);default:return void(e.viewingMode,void 0)}}function x7e(e,t,i,r){const s=R0(e.renderCoordsHelper,t.center,t.eye),n=Be(s,i.min,i.max),o=s-n;if(!ER(o))return 0;if(r){const a=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=e.renderCoordsHelper.getAltitude(t.eye)-a,c=Math.cos(n);Math.abs(c)>1e-4?r.eyeCenterDistance=l/c:r.eyeCenterDistance=t.distance}return o}function T7e(e,t,i,r){const s=S7e(e,t,M7e),n=Be(s.tiltAtCenter,i.min,i.max);if(!ER(s.tiltAtCenter-n))return 0;let o,a;return s.centerIsOnSurface?(o=E7e(s),a=A7e(s,o)):(o=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),r&&o<Math.PI/2&&(r.requiresTwoSteps=!0,o=Math.PI/2-1e-5),a=C7e(s,o)),r&&(r.eyeCenterDistance=U9(s,o)),a}function S7e(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+di(e.spatialReference).radius,n=e.renderCoordsHelper.intersectManifold(t.ray,r,Py);return i.eyeCenterDistance=t.distance,i.centerIsOnSurface=!1,_(n)?(i.eyeCenterDistance=xi(t.eye,n),i.tiltAtCenter=R0(e.renderCoordsHelper,n,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=R0(e.renderCoordsHelper,t.center,t.eye):(jS(s,t.ray,Py),i.eyeCenterDistance=xi(t.eye,Py),i.tiltAtCenter=Rs(-_e(t.viewForward,be(Py,Py)))),i.radius=s,i.eyeRadius=Pe(t.eye),i.constraints=e.state.constraints,i}function ER(e){return Math.abs(e)>1e-9}function E7e(e){const{constraints:t,eyeCenterDistance:i,tiltAtCenter:r}=e;let s=r,n=t.clampTilt(i,r);const o=U9(e,n);if(t.clampTilt(o,r)===n)return n;let a=0;for(;a<10&&ER(n-s);){const l=(s+n)/2,c=U9(e,l);ER(t.clampTilt(c,l)-l)?s=l:n=l,a++}return n}function U9(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-Be(t,0,Math.PI),r=Yh(e.radius/e.eyeRadius*Math.sin(i)),s=Math.PI-i-r,n=Math.sin(s)/Math.sin(i);if(e.eyeRadius<e.radius&&n>1){const o=Math.PI-r,a=Math.PI-i-o;return Math.sin(a)/Math.sin(i)*e.eyeRadius}return n*e.eyeRadius}function A7e(e,t){const i=Yh(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=Yh(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-r:r-i}function C7e(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}function R7e(e,t,i){if(t.interactionType===Mt.NONE)return;const{interactionStartCamera:r,interactionFactor:s}=t,{min:n,max:o}=i,a=kq(e,r,C0,t),l=a===0?0:R0(e.renderCoordsHelper,r.center,r.eye);i.min=n,i.max=o,t.interactionType===Mt.TUMBLE?(SR(t.selection,Yi.ALTITUDE)&&cye(e,r,i),EL(a,l,!0,s,Zee,i)):EL(a,l,!1,s,Zee,i)}function cye(e,t,i){if(e.state.isLocal)return;const r=e.state.constraints;if(!r.altitude)return;const s=Go(t.center),n=Math.sqrt(s),o=t.distance,a=di(e.spatialReference).radius,l=r.altitude.min+a,c=r.altitude.max+a,h=(l*l-o*o-s)/(-2*n*o),p=(c*c-o*o-s)/(-2*n*o);i.min=Math.max(i.min,Math.min(Math.PI-Rs(p),i.max)),i.max=Math.min(i.max,Math.PI-Rs(h))}const dg=M(),m3=Te(),Py=M(),Zee=Rt(5),O7e={min:0,max:0},M7e={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},L2={eyeCenterDistance:0,requiresTwoSteps:!1};function P7e(e){return e}const KF=e=>e*e,zq=e=>1-KF(1-e),I7e=e=>e<.5?KF(2*e)/2:(zq(2*(e-.5))+1)/2,Bq=e=>e*e*e,uye=e=>1-Bq(1-e),hye=e=>e<.5?Bq(2*e)/2:(uye(2*(e-.5))+1)/2,Vq=e=>e*e*e*e,dye=e=>1-Vq(1-e),$7e=e=>e<.5?Vq(2*e)/2:(dye(2*(e-.5))+1)/2,Gq=e=>e*e*e*e*e,pye=e=>1-Gq(1-e),D7e=e=>e<.5?Gq(2*e)/2:(pye(2*(e-.5))+1)/2,jq=e=>1-Math.cos(e*Math.PI/2),fye=e=>1-jq(1-e),L7e=e=>e<.5?jq(2*e)/2:(fye(2*(e-.5))+1)/2,Hq=e=>2**(10*(e-1)),$O=e=>1-Hq(1-e),N7e=e=>e<.5?Hq(2*e)/2:($O(2*(e-.5))+1)/2,qq=e=>-(Math.sqrt(1-e*e)-1),mye=e=>1-qq(1-e),F7e=e=>e<.5?qq(2*e)/2:(mye(2*(e-.5))+1)/2;function Vu(e){const t=2*(e-Math.sqrt((e-1)*e)),i=t/2/e;return r=>r<i?e*r*r:t*r-t+1}function Gu(e,t){return(i,r)=>i<t?t*e(i/t,r):1-e((1-i)/(1-t),r)*(1-t)}const U7e=Gu(Vu(1),1),k7e=Gu(Vu(1),0),gye=Gu(Vu(1),.5),z7e=Gu(Vu(2),1),B7e=Gu(Vu(2),0),V7e=Gu(Vu(2),.5),G7e=Gu(Vu(3),1),j7e=Gu(Vu(3),0),H7e=Gu(Vu(3),.5),q7e=Gu(Vu(4),1),W7e=Gu(Vu(4),0),X7e=Gu(Vu(4),.5),Y7e={linear:P7e,"in-quad":KF,"out-quad":zq,"in-out-quad":I7e,"in-coast-quad":U7e,"out-coast-quad":k7e,"in-out-coast-quad":gye,"in-cubic":Bq,"out-cubic":uye,"in-out-cubic":hye,"in-coast-cubic":z7e,"out-coast-cubic":B7e,"in-out-coast-cubic":V7e,"in-quart":Vq,"out-quart":dye,"in-out-quart":$7e,"in-coast-quart":G7e,"out-coast-quart":j7e,"in-out-coast-quart":H7e,"in-quint":Gq,"out-quint":pye,"in-out-quint":D7e,"in-coast-quint":q7e,"out-coast-quint":W7e,"in-out-coast-quint":X7e,"in-sine":jq,"out-sine":fye,"in-out-sine":L7e,"in-expo":Hq,"out-expo":$O,"in-out-expo":N7e,"in-circ":qq,"out-circ":mye,"in-out-circ":F7e};function Fr(e,t,i=K7e,r=t){let s=!1;r!==t&&r.copyFrom(t),r.computeUp(e.state.viewingMode);for(let a=0;a<eje;a++){let l=0;for(const c of J7e)if(SR(i.selection,c.type)){const h=Math.abs(c.error(e,r,i));c.apply(e,r,i)&&(s=!0,l+=h)}if(l===0)break}const n=SR(i.selection,Yi.COLLISION),o=Z7e(i.interactionType,e);return n&&i2(e,r,o)&&(s=!0),s&&r.computeUp(e.state.viewingMode),s}function Z7e(e,t){switch(e){case Mt.PAN:return Ru.EYE_AND_CENTER;case Mt.ASCEND:return t.state.isGlobal?Ru.EYE_AND_CENTER_SCALE:Ru.EYE_AND_CENTER;default:return Ru.EYE}}function Ih(e,t){const i=typeof e=="number"?e:nT(e,t),r=Math.min(1,i/150);return hye(r)}function Q7e(e,t,i){return kq(e,t,i)*t.distance}const J7e=[{type:Yi.TILT,error:Q7e,apply:lye},{type:Yi.ALTITUDE,error:Lq,apply:GGe},{type:Yi.DISTANCE,error:Nq,apply:JGe}],K7e={selection:Yi.ALL,interactionType:Mt.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:en.TUMBLE},eje=5,Pl=M(),$a=M(),pg=M(),Jn=M(),sv=M(),tje=M(),Il={upward:je(0,0,1),forward:je(0,1,0),sideway:je(1,0,0)},Qee=wr();class Jee{constructor(t=Ie.Global){this.viewingMode=t,this.center=M(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=As(Il.forward)}pixelsPerPanAtZoom(t){return this.size/2/(this._zoomToPanScale*t)}zoomAtPixelsPerPan(t){return this.size/2/(this._zoomToPanScale*t)}pixelsPerRotateAtZoom(){const t=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/t}compareTo(t,i){if(i||(i={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===Ie.Global){const n=(Pe(this.center)+Pe(t.center))/2;i.pan=y5(this.center,t.center)*n}else i.pan=xi(this.center,t.center);let r=Math.abs(t.yaw-this.yaw);r>=Math.PI&&(r=2*Math.PI-r);const s=Math.abs(t.pitch-this.pitch);return i.rotate=Math.max(r,s),i.sourceZoom=this.distance,i.targetZoom=t.distance,i}interpolate(t,i,r){this.viewingMode===Ie.Global?t2e(t.center,i.center,r.pan,this.center):Cs(this.center,t.center,i.center,r.pan),this.distance=qt(t.distance,i.distance,r.zoom),this.pitch=qt(t.pitch,i.pitch,r.rotate);let s=t.yaw;const n=i.yaw;Math.abs(n-s)>=Math.PI&&(s+=2*(s<n?1:-1)*Math.PI),this.yaw=qt(s,n,r.rotate)}copyFrom(t){ne(this.center,t.center),this.pitch=t.pitch,this.yaw=t.yaw,this.distance=t.distance,ne(this.lookAtDirection,t.lookAtDirection),this.size=t.size,this.copyFromCommon(t),this.viewingMode=t.viewingMode}copyFromRenderCamera(t){const i=this._lookAtOrientation(t.center,Qee);ne(this.center,t.center),de(Jn,t.center,t.eye),al(Jn,Jn,i),al(sv,t.up,i),this.distance=Pe(Jn),Jn[0]/=this.distance,Jn[1]/=this.distance,Jn[2]/=this.distance,this.pitch=this._eyeUpToPitch(Jn),this.yaw=this._eyeUpToYaw(Jn,sv),this.size=Math.sqrt(t.width*t.width+t.height*t.height),this.copyFromCommon(t)}copyFromCommon(t){this.fov=t.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(t){const i=this._lookAtOrientation(this.center,Qee);Nu(i,i),this._axisAngleVec3(Il.sideway,this.pitch-Math.PI/2,Il.forward,Jn),this._axisAngleVec3(Il.upward,this.yaw,Jn),this._axisAngleVec3(Il.sideway,this.pitch-Math.PI/2,Il.upward,sv),this._axisAngleVec3(Il.upward,this.yaw,sv),ae(Jn,Jn,this.distance),al(Jn,Jn,i),al(sv,sv,i),t.center=this.center,t.eye=de(Jn,this.center,Jn),t.up=sv}_axisAngleVec3(t,i,r,s=r){const n=Math.cos(i),o=Math.sin(i);return ae(Pl,r,n),pt($a,t,r),ae($a,$a,o),ae(pg,t,(1-n)*_e(t,r)),pe(s,pe(s,Pl,$a),pg)}_lookAtOrientation(t,i=wr()){return this._upAtLookAt(t,pg),pt(Pl,this.lookAtDirection,pg),be(Pl,Pl),Pl[0]===0&&Pl[1]===0&&Pl[2]===0&&ne(Pl,Il.sideway),pt($a,pg,Pl),be($a,$a),i[0]=Pl[0],i[1]=$a[0],i[2]=pg[0],i[3]=Pl[1],i[4]=$a[1],i[5]=pg[1],i[6]=Pl[2],i[7]=$a[2],i[8]=pg[2],i}_upAtLookAt(t,i){return this.viewingMode===Ie.Local?ne(i,Il.upward):be(i,t)}_eyeUpToPitch(t){return Math.PI-y5(Il.upward,t)}_eyeUpToYaw(t,i){const r=tje;return Math.abs(i[2])<.5?(ne(r,i),t[2]>0&&ae(r,r,-1)):ne(r,t),pt($a,r,Il.upward),be($a,$a),y5(Il.sideway,$a,Il.upward)}}function Wq(e){return e?{ray:Vn(e.ray),c0:e.c0,c1:e.c1}:{ray:Vn(),c0:0,c1:Number.MAX_VALUE}}function ije(e,t=Wq()){return UD(e,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}function rje(e,t,i=Wq()){const r=Pe(e.vector);return $ue(e.origin,t,i.ray),i.c0=0,i.c1=r,i}new Gm(()=>({c0:0,c1:0,ray:null}));function AR(e){return e?[ii(e[0]),ii(e[1]),ii(e[2]),ii(e[3]),ii(e[4]),ii(e[5])]:[ii(),ii(),ii(),ii(),ii(),ii()]}function yye(){return[M(),M(),M(),M(),M(),M(),M(),M()]}function RL(e,t){for(let i=0;i<O0.NUM;i++)cF(e[i],t[i])}function vye(e,t,i,r=cje){const s=dr(pO.get(),t,e);fr(s,s);for(let n=0;n<k9.NUM;++n){const o=Ou(kj.get(),lje[n],s);oe(r[n],o[0]/o[3],o[1]/o[3],o[2]/o[3])}_ye(i,r)}function _ye(e,t){co(t[Xe.FAR_BOTTOM_LEFT],t[Xe.NEAR_BOTTOM_LEFT],t[Xe.NEAR_TOP_LEFT],e[Wi.LEFT]),co(t[Xe.NEAR_BOTTOM_RIGHT],t[Xe.FAR_BOTTOM_RIGHT],t[Xe.FAR_TOP_RIGHT],e[Wi.RIGHT]),co(t[Xe.FAR_BOTTOM_LEFT],t[Xe.FAR_BOTTOM_RIGHT],t[Xe.NEAR_BOTTOM_RIGHT],e[Wi.BOTTOM]),co(t[Xe.NEAR_TOP_LEFT],t[Xe.NEAR_TOP_RIGHT],t[Xe.FAR_TOP_RIGHT],e[Wi.TOP]),co(t[Xe.NEAR_BOTTOM_LEFT],t[Xe.NEAR_BOTTOM_RIGHT],t[Xe.NEAR_TOP_RIGHT],e[Wi.NEAR]),co(t[Xe.FAR_BOTTOM_RIGHT],t[Xe.FAR_BOTTOM_LEFT],t[Xe.FAR_TOP_LEFT],e[Wi.FAR])}function Qy(e,t){for(let i=0;i<O0.NUM;i++){const r=e[i];if(r[0]*t[0]+r[1]*t[1]+r[2]*t[2]+r[3]>=t[3])return!1}return!0}function sje(e,t){return wye(e,ije(t,xye.get()))}function nje(e,t,i){return wye(e,rje(t,i,xye.get()))}function bye(e,t){for(let i=0;i<O0.NUM;i++)if(tr(e[i],t)>0)return!1;return!0}function oje(e,t){for(let i=0;i<O0.NUM;i++)if(SMe(e[i],t))return!1;return!0}function wye(e,t){for(let i=0;i<O0.NUM;i++)if(!EMe(e[i],t))return!1;return!0}var Wi,Xe;(function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.TOP=3]="TOP",e[e.NEAR=4]="NEAR",e[e.FAR=5]="FAR"})(Wi||(Wi={})),function(e){e[e.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",e[e.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",e[e.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",e[e.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",e[e.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",e[e.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",e[e.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",e[e.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(Xe||(Xe={}));const aje={bottom:[Xe.FAR_BOTTOM_RIGHT,Xe.NEAR_BOTTOM_RIGHT,Xe.NEAR_BOTTOM_LEFT,Xe.FAR_BOTTOM_LEFT],near:[Xe.NEAR_BOTTOM_LEFT,Xe.NEAR_BOTTOM_RIGHT,Xe.NEAR_TOP_RIGHT,Xe.NEAR_TOP_LEFT],far:[Xe.FAR_BOTTOM_RIGHT,Xe.FAR_BOTTOM_LEFT,Xe.FAR_TOP_LEFT,Xe.FAR_TOP_RIGHT],right:[Xe.NEAR_BOTTOM_RIGHT,Xe.FAR_BOTTOM_RIGHT,Xe.FAR_TOP_RIGHT,Xe.NEAR_TOP_RIGHT],left:[Xe.FAR_BOTTOM_LEFT,Xe.NEAR_BOTTOM_LEFT,Xe.NEAR_TOP_LEFT,Xe.FAR_TOP_LEFT],top:[Xe.FAR_TOP_LEFT,Xe.NEAR_TOP_LEFT,Xe.NEAR_TOP_RIGHT,Xe.FAR_TOP_RIGHT]};var O0,k9;(function(e){e[e.NUM=6]="NUM"})(O0||(O0={})),function(e){e[e.NUM=8]="NUM"}(k9||(k9={}));const lje=[yi(-1,-1,-1,1),yi(1,-1,-1,1),yi(1,1,-1,1),yi(-1,1,-1,1),yi(-1,-1,1,1),yi(1,-1,1,1),yi(1,1,1,1),yi(-1,1,1,1)],xye=new Gm(Wq),cje=yye(),uje=he.getLogger("esri.views.3d.webgl-engine.lib.Camera");class wi{constructor(t=null,i=null,r=null){this._viewUp=M(),this._viewForward=M(),this._viewRight=M(),this._ray=Vn(),this._viewport=yi(0,0,1,1),this._padding=yi(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=vi(1,1e3),this._viewDirty=!0,this._viewMatrix=Te(),this._projectionDirty=!0,this._projectionMatrix=Te(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=Te(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=Te(),this._frustumDirty=!0,this._frustum=AR(),this._fullViewport=ni(),this.pixelRatio=1,this.relativeElevation=0,_(t)&&ne(this._ray.origin,t),this._center=_(i)?As(i):M(),this._up=_(r)?As(r):je(0,0,1)}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center)}get ray(){return de(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){Ur(this._viewMatrix,t),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get x(){return this._viewport[0]}set x(t){t+=this._padding[bt.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get y(){return this._viewport[1]}set y(t){t+=this._padding[bt.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get fullWidth(){return this._viewport[2]+this._padding[bt.RIGHT]+this._padding[bt.LEFT]}set fullWidth(t){this.width=t-(this._padding[bt.RIGHT]+this._padding[bt.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[bt.TOP]+this._padding[bt.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[bt.TOP]+this._padding[bt.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[bt.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[bt.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){this._padding[bt.TOP]===t[bt.TOP]&&this._padding[bt.RIGHT]===t[bt.RIGHT]&&this._padding[bt.BOTTOM]===t[bt.BOTTOM]&&this._padding[bt.LEFT]===t[bt.LEFT]||(this._viewport[0]+=t[bt.LEFT]-this._padding[bt.LEFT],this._viewport[1]+=t[bt.BOTTOM]-this._padding[bt.BOTTOM],this._viewport[2]-=t[bt.RIGHT]+t[bt.LEFT]-(this._padding[bt.RIGHT]+this._padding[bt.LEFT]),this._viewport[3]-=t[bt.TOP]+t[bt.BOTTOM]-(this._padding[bt.TOP]+this._padding[bt.BOTTOM]),_a(this._padding,t),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewProjectionMatrix(){return this._viewProjectionDirty&&(dr(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const t=this.width,i=this.height,r=this.near*Math.tan(this.fovY/2),s=r*this.aspect;Wce(this._projectionMatrix,-s*(1+2*this._padding[bt.LEFT]/t),s*(1+2*this._padding[bt.RIGHT]/t),-r*(1+2*this._padding[bt.BOTTOM]/i),r*(1+2*this._padding[bt.TOP]/i),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix}set projectionMatrix(t){Ur(this._projectionMatrix,t),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fov(){return this._fov}set fov(t){this._fov=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return q9e(this._fov,this.width,this.height)}set fovX(t){this._fov=j9e(t,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return W9e(this._fov,this.width,this.height)}set fovY(t){this._fov=H9e(t,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return xi(this._center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(fr(this._viewInverseTransposeMatrix,this.viewMatrix),Oa(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const i=2*t-1;return 2*this.near*this.far/(this.far+this.near-i*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation&&this.relativeElevation>=0}copyFrom(t){ne(this._ray.origin,t.eye),ne(this._center,t.center),ne(this._up,t.up),_a(this._viewport,t.viewport),_a(this._padding,t.padding),zs(this._nearFar,t.nearFar),this._fov=t.fov,this.relativeElevation=t.relativeElevation;const i=t;return this._viewDirty=i._viewDirty,this._viewDirty||(Ur(this._viewMatrix,t.viewMatrix),ne(this._viewRight,t.viewRight),ne(this._viewUp,t.viewUp),ne(this._viewForward,t.viewForward)),i._projectionDirty?this._projectionDirty=!0:(Ur(this._projectionMatrix,t.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=i._frustumDirty,this._frustumDirty||(RL(this._frustum,t.frustum),this._frustumDirty=!1),i._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(Ur(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),_a(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up}clone(){return new wi().copyFrom(this)}equals(t){return ll(this.eye,t.eye)&&ll(this._center,t.center)&&ll(this._up,t.up)&&g1(this._viewport,t.viewport)&&g1(this._padding,t.padding)&&nge(this._nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation}almostEquals(t){if(this.pixelRatio!==t.pixelRatio||Math.abs(t.fov-this._fov)>=.001)return!1;const i=5e-4,r=1-1e-10;vp(Kn,t.eye,t.center),vp(ik,this.eye,this._center);const s=_e(Kn,ik),n=Kz(Kn),o=Kz(ik);return s*s>=r*n*o&&u7(t.eye,this.eye)<Math.max(n,o)*i*i&&iD(t.padding,this._padding)<.5&&iD(t.viewport,this._viewport)<.5}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(JA(this.viewForward,de(Kn,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,i){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(i||1)))}getScreenCenter(t=Rr()){return t[0]=(this.padding[bt.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[bt.TOP]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,i=.5,r=.5){return t[0]=this.padding[bt.LEFT]+this.width*i,t[1]=this.padding[bt.BOTTOM]+this.height*r,t[2]=.5,t}setGLViewport(t){const i=this.viewport,r=this.padding;t.setViewport(i[0]-r[3],i[1]-r[2],i[2]+r[1]+r[3],i[3]+r[0]+r[2])}applyProjection(t,i,r=!1){t!==ei&&ne(ei,t),ei[3]=1,r&&(i[2]=-ei[2]),Ou(ei,ei,this.projectionMatrix),ae(ei,ei,1/Math.abs(ei[3]));const s=this.fullViewport;return i[0]=qt(0,s[0]+s[2],.5+.5*ei[0]),i[1]=qt(0,s[1]+s[3],.5+.5*ei[1]),r||(i[2]=.5*(ei[2]+1)),i}projectToScreen(t,i){this.projectToRenderScreen(t,rk),this.renderToScreen(rk,i)}projectToRenderScreen(t,i){if(ei[0]=t[0],ei[1]=t[1],ei[2]=t[2],ei[3]=1,Ou(ei,ei,this.viewProjectionMatrix),ei[3]===0)return null;ae(ei,ei,1/Math.abs(ei[3]));const r=this.fullViewport;return"x"in i?(i.x=qt(0,r[0]+r[2],.5+.5*ei[0]),i.y=qt(0,r[1]+r[3],.5+.5*ei[1])):(i[0]=qt(0,r[0]+r[2],.5+.5*ei[0]),i[1]=qt(0,r[1]+r[3],.5+.5*ei[1]),i.length>2&&(i[2]=.5*(ei[2]+1))),i}unprojectFromScreen(t,i){return this.unprojectFromRenderScreen(this.screenToRender(t,rk),i)}unprojectFromRenderScreen(t,i){if(dr(g3,this.projectionMatrix,this.viewMatrix),!fr(g3,g3))return null;const r=this.fullViewport;return ei[0]=2*(t[0]-r[0])/r[2]-1,ei[1]=2*(t[1]-r[1])/r[3]-1,ei[2]=2*t[2]-1,ei[3]=1,Ou(ei,ei,g3),ei[3]===0?null:(i[0]=ei[0]/ei[3],i[1]=ei[1]/ei[3],i[2]=ei[2]/ei[3],i)}constrainWindowSize(t,i,r,s=r){const n=t*this.pixelRatio,o=i*this.pixelRatio,a=Math.max(n-r/2,0),l=Math.max(this.fullHeight-o-s/2,0),c=-Math.min(n-r/2,0),h=-Math.min(this.fullHeight-o-s/2,0);return[a,l,r-c- -Math.min(this.fullWidth-n-r/2,0),s-h- -Math.min(o-s/2,0)]}computeUp(t){t===Ie.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,i){const r=t[0]*this.pixelRatio,s=this.fullHeight-t[1]*this.pixelRatio;return i[0]=r,i[1]=s,i}renderToScreen(t,i){const r=t[0]/this.pixelRatio,s=(this.fullHeight-t[1])/this.pixelRatio;i[0]=r,i[1]=s}_computeUpGlobal(){de(Kn,this.center,this.eye);const t=Pe(this.center);t<1?(oe(this._up,0,0,1),this._markViewDirty()):Math.abs(_e(Kn,this.center))>.9999*Pe(Kn)*t||(pt(this._up,Kn,this.center),pt(this._up,this._up,Kn),be(this._up,this._up),this._markViewDirty())}_computeUpLocal(){Um(Kn,this.eye,this.center),Math.abs(Kn[2])<=.9999&&(ae(Kn,Kn,Kn[2]),oe(this._up,-Kn[0],-Kn[1],1-Kn[2]),be(this._up,this._up),this._markViewDirty())}_compareAndSetView(t,i){typeof t[0]=="number"&&isFinite(t[0])&&typeof t[1]=="number"&&isFinite(t[1])&&typeof t[2]=="number"&&isFinite(t[2])?ll(t,i)||(ne(i,t),this._markViewDirty()):uje.warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(vye(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(sF(this._viewMatrix,this.eye,this._center,this._up),oe(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),oe(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),oe(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}const ei=ni(),g3=Te(),Kn=M(),ik=M(),rk=zn();var bt;(function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT"})(bt||(bt={}));const OL={desiredScreenFlow:2,minDuration:500,maxDuration:8e3};class Xq{constructor(t){this.createCamera=t,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:OL.desiredScreenFlow},this.source=t(),this.target=t()}clone(){const t=new Xq(this.createCamera);return t.copyFrom(this),t}copyFrom(t){this.update(t.source,t.target,t.settings)}update(t,i,r){this.source!==t&&this.source.copyFrom(t),this.target!==i&&this.target.copyFrom(i),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=r.desiredScreenFlow!=null?r.desiredScreenFlow:OL.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(t){const i=this.target.pixelsPerPanAtZoom(t);return this.halfWindowSize/i}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}class hje{constructor(){this.segments=[]}get time(){return this.segments.reduce((t,i)=>t+i.time,0)}interpolateComponentsAt(t,i){t=Math.min(Math.max(t,0),1),t*=this.time;let r=0,s=0;const n=this.definition;for(let o=0;o<this.segments.length;o++){const a=this.segments[o],l=a.definition;if(t<=a.time||o===this.segments.length-1){i=this.segmentInterpolateComponentsAt(a,t/a.time,i),n.hasPan?i.pan=(r+l.compared.pan*i.pan)/n.compared.pan:i.pan=1,n.hasRotate?i.rotate=(s+l.compared.rotate*i.rotate)/n.compared.rotate:i.rotate=1;const c=i.zoom*(l.compared.targetZoom-l.compared.sourceZoom)+l.compared.sourceZoom,h=this.segments[0].definition.compared.sourceZoom,p=this.segments[this.segments.length-1].definition.compared.targetZoom;return n.hasZoom?i.zoom=(c-h)/(p-h):i.zoom=1,i}t-=a.time,r+=l.compared.pan,s+=l.compared.rotate}}segmentInterpolateComponentsAt(t,i,r){return t.interpolateComponentsAt(i,r)}}class sk{constructor(t){t&&this.update(t)}get time(){return this._time}update(t){t&&(this.definition?this.definition.copyFrom(t):this.definition=t.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const t=this.definition,i=t.compared,r=i.sourceZoom,s=i.targetZoom;this._zoomSign=r>s?1:-1,this._panPixelsAtSource=i.pan*t.source.pixelsPerPanAtZoom(r);const n=(t.source.pixelsPerRotateAtZoom(r)+t.target.pixelsPerRotateAtZoom(s))/2;this._rotatePixels=i.rotate*n}_updatePixelFlow(){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom,{hasZoom:r,hasPan:s,hasRotate:n}=this.definition;let o=0,a=0;r&&(s&&(o=(i/t-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(a=this._zoomSign*(Math.log(t/i)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(r&&s&&n){const c=o+a+o*a;this._zoomPixelFlow=o*a/c*l,this._panPixelFlow=a/c*l,this._rotatePixelFlow=o/c*l}else if(r&&s){const c=1+o;this._zoomPixelFlow=o/c*l,this._panPixelFlow=1/c*l}else if(r&&n){const c=1+a;this._zoomPixelFlow=a/c*l,this._rotatePixelFlow=1/c*l}else if(s&&n){const c=this._panPixelsAtSource/this._rotatePixels,h=1+c;this._panPixelFlow=c/h*l,this._rotatePixelFlow=1/h*l}else s?this._panPixelFlow=l:r?this._zoomPixelFlow=l:n&&(this._rotatePixelFlow=l);this._time=n?this.rotateTime:r?this.zoomTime:s?this.panTime:0}get rotateTime(){return this.definition.hasRotate?this._rotatePixels/this._rotatePixelFlow:0}get zoomTime(){return this.definition.hasZoom?this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow:0}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,i=t*this._panPixelsAtSource;return Math.log(i*(this._zoomPixelFlow/this._panPixelFlow)+1)/(t*this._zoomPixelFlow)}return this._panPixelsAtSource/this._panPixelFlow}return 0}_interpolateComponentsZoom(t){if(t===0||t===1)return t;if(this.definition.hasZoom){const i=this.definition.compared.sourceZoom,r=this.definition.compared.targetZoom;return(i*(i/r)**-t-i)/(r-i)}return t}_interpolateComponentsPan(t){if(t===0||t===1)return t;if(this.definition.hasPan&&this.definition.hasZoom){const i=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(i*t*this._time)-1))/(i*Math.LN2)}return t}_interpolateComponentsRotate(t){return t}interpolateComponentsAt(t,i){t=Math.min(Math.max(t,0),1);const r=this._interpolateComponentsZoom(t),s=this._interpolateComponentsPan(t),n=this._interpolateComponentsRotate(t);return i?(i.zoom=r,i.pan=s,i.rotate=n):i={zoom:r,pan:s,rotate:n},i}}function dje(e,t,i){const r=t-e.compared.sourceZoom,s=e.halfWindowPanAtZoom(r);return-e.halfWindowSize*(i.ascensionFactor*Math.LN2*e.compared.pan+s)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*s)}function pje(e,t,i){const r=1/t,s=Math.log(e.compared.sourceZoom*r),n=1/e.desiredPixelFlow,o=1/Math.LN2,a=t-e.compared.sourceZoom,l=1/a,c=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(a))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*n*o*l*c-e.halfWindowSize*s*n*o*l+e.halfWindowSize*s*n*o*c/(a*a)}function fje(e,t,i){const r=t-e.compared.sourceZoom,s=1/r,n=1/t,o=Math.log(e.compared.sourceZoom*n),a=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(r))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*a+2*s*o+2*n-2*o*a/(r*r)-a/(t*t))/(e.desiredPixelFlow*Math.LN2)}function mje(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function gje(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function yje(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function vje(e,t,i){return-e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}function _je(e,t,i){return e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}function bje(e,t,i){return-2*e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}function wje(e,t,i){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function xje(e,t,i){const r=Math.log(t/e.compared.targetZoom),s=1/e.desiredPixelFlow,n=1/Math.LN2,o=-t+e.compared.targetZoom,a=1/o,l=(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*r*s*n*a+e.halfWindowSize*r*s*n*l/(o*o)+e.halfWindowSize*s*n*a*l/t}function Tje(e,t,i){const r=t-e.compared.targetZoom,s=1/r,n=1/t,o=Math.log(t/e.compared.targetZoom),a=(e.halfWindowPanAtZoom(t)+i.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*a-2*s*o+2*n+2*o*a/(r*r)-a/(t*t))/(e.desiredPixelFlow*Math.LN2)}function Sje(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function Eje(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function Aje(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function Cje(e){const t=Math.LN2*e.compared.pan,i=e.compared.sourceZoom-e.compared.targetZoom,r=e.halfWindowPanAtZoom(i),s=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*r);return e.compared.sourceZoom<=e.compared.targetZoom?s*(t-r):s*(t+r)}function Rje(e,t){let i=Oje(e,t);const r={ascensionFactor:t.ascensionFactor!=null?t.ascensionFactor:.5,descensionFactor:t.descensionFactor!=null?t.descensionFactor:.5},s=r.ascensionFactor===0,n=r.descensionFactor===0,o=s?mje:dje,a=s?gje:pje,l=s?yje:fje,c=n?Sje:wje,h=n?Eje:xje,p=n?Aje:Tje,f=A=>o(e,A,r)+vje(e,A,r)+c(e,A,r),g=A=>a(e,A,r)+_je(e,A,r)+h(e,A,r),y=A=>l(e,A,r)+bje(e,A,r)+p(e,A,r);let v=f(i);const b=Cje(e);let w;const S=t.maximumIterations||20,T=t.maximumDistance!=null?t.maximumDistance:1/0;for(w=0;w<S;w++){const C=(g(i)+1e-6)/y(i);if(isNaN(C)||i>=T&&C<0){if(!isFinite(T))return null;i=T,v=f(i);break}if(i-=C,i<e.compared.sourceZoom||i<e.compared.targetZoom)return null;const O=f(i);if(Math.abs(O-v)/v<=.005)break;v=O}return v>b*(1-.3)||i<e.compared.sourceZoom||i<e.compared.targetZoom?null:i}function Oje(e,t){const i=Math.max(e.compared.sourceZoom,e.compared.targetZoom),r=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return r<i?t.maximumDistance!=null?i+(t.maximumDistance-i)/2:1.5*i:t.maximumDistance?Math.min(t.maximumDistance,r):r}class Mje extends hje{constructor(t,i){super(),this._preallocSegments=[new sk,new sk,new sk],this.update(t,i)}update(t,i){if(!t)return;this.definition?this.definition.copyFrom(t):this.definition=t.clone();let r=null;i&&i.apex&&(r=Rje(t,i.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,r==null?this._updateWithoutApex():this._updateWithApex(r,i.apex)}segmentInterpolateComponentsAt(t,i,r){return r=t.interpolateComponentsAt(i,r),t===this._ascensionSegment?r.zoom=zq(r.zoom):t===this._descensionSegment&&(r.zoom=KF(r.zoom)),r}_updateWithApex(t,i){const[r,s,n]=this._preallocSegments,o=i.ascensionFactor!=null?i.ascensionFactor:.5,a=Math.min(1-o,i.ascensionFactor!=null?i.descensionFactor:.5),l=1-o-a;r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.compared.targetZoom=t,r.definition.compared.pan=this.definition.compared.pan*o,r.definition.compared.rotate=this.definition.compared.rotate*o,r.update(),this._ascensionSegment=r,this.segments.push(r),l>0&&(s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.copyFrom(this.definition),s.definition.compared.sourceZoom=t,s.definition.compared.targetZoom=t,s.definition.compared.pan=this.definition.compared.pan*l,s.definition.compared.rotate=this.definition.compared.rotate*l,s.update(),this.segments.push(s)),n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.compared.sourceZoom=t,n.definition.compared.pan=this.definition.compared.pan*a,n.definition.compared.rotate=this.definition.compared.rotate*a,n.update(),this._descensionSegment=n,this.segments.push(n)}_updateWithoutApex(){const[t]=this._preallocSegments;t.update(this.definition),this.segments.push(t)}}const Pje={zoom:0,pan:0,rotate:0};class Ije{constructor(t){this.createCamera=t,this._time=0,this.definition=new Xq(t),this.path=new Mje}get time(){return this._time}update(t,i,r){this.definition.update(t,i,r),this.path.update(this.definition,r),this._time=this._applyTimeSettings(Voe(this.path.time),r),this._easing=r.easing?r.easing:this._time>=1e3?gye:$O}cameraAt(t,i){i=i||this.createCamera(),t=Math.min(Math.max(0,t),1),t=this._normalizedEasing(t);const r=this.path.interpolateComponentsAt(t,Pje);return i.interpolate(this.definition.source,this.definition.target,r),i}_normalizedEasing(t){const i=this._easing(0,this._time),r=this._easing(1,this._time);return(this._easing(t,this._time)-i)/(r-i)}_applyTimeSettings(t,i){const r=i.speedFactor!=null?i.speedFactor:1;i.duration!=null?t=i.duration:i.speedFactor!=null&&(t=t/r);const s=i.minDuration!=null?i.minDuration:OL.minDuration/r,n=i.maxDuration!=null?i.maxDuration:OL.maxDuration/r;return Math.min(Math.max(s,t),n)}}const $je=M();class Dje{constructor(t){this.currentTime=0,this._animation=new Ije(()=>new Jee(t)),this._current=new Jee(t)}get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}update(t,i,r){const s=this._animation.definition.source,n=this._animation.definition.target,o=de($je,i.center,t.center),a=Pe(o);a>=1e-5?(o[0]/=a,o[1]/=a,o[2]/=a):(o[0]=0,o[1]=1,o[0]=0),ne(s.lookAtDirection,o),ne(n.lookAtDirection,o),s.copyFromRenderCamera(t),n.copyFromRenderCamera(i),this._current.copyFrom(s),this._animation.update(s,n,r),this.currentTime=0,t.almostEquals(i)&&(this.currentTime=this._animation.time)}cameraAt(t,i){return this._animation.cameraAt(t,this._current),i=i||new wi,this._current.copyToRenderCamera(i),i}step(t,i){return this.finished||(this.currentTime=this.currentTime+Voe(t),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,i)}}var cr;(function(e){e.Ready="ready",e.Rejected="rejected",e.Running="running",e.Stopped="stopped",e.Finished="finished"})(cr||(cr={}));let Q_=class extends we{constructor(){super(...arguments),this.state=cr.Ready}get active(){return this.state===cr.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=cr.Stopped,!0)}finishController(){this.state=cr.Finished}get steppingFinished(){return!1}};u([d({readOnly:!0})],Q_.prototype,"active",null),u([d()],Q_.prototype,"state",void 0),Q_=u([P("esri.views.3d.state.controllers.CameraController")],Q_);let CR=class extends Q_{get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(pi()),this._asyncResult=null),this.state===cr.Finished||this.state===cr.Stopped?this.state===cr.Finished?e.resolve():e.reject(pi()):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=cr.Running,_(this.viewAnimation)&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!_(this.viewAnimation)||this.state!==cr.Ready&&this.state!==cr.Running||(this.viewAnimation.state===sS.State.FINISHED?this.finish():this.viewAnimation.state===sS.State.STOPPED&&(this.state=cr.Stopped))}onControllerEnd(){_(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===cr.Finished?this.viewAnimation.finish():this.state===cr.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===cr.Finished?this._asyncResult.resolve():this._asyncResult.reject(pi()))}finish(){this.finishController()}};CR=u([P("esri.views.3d.state.controllers.AnimationController")],CR);let um=class extends CR{constructor(e){super(e),this.view=null,this.mode="interaction",this.hasTarget=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.animation=new Dje(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new sS}get isInteractive(){return this.mode==="interaction"}begin(e,t){this.hasTarget=!0;const i=this.animationSettings(t);y3.copyFrom(this.view.state.camera);const r=ku(this.view.state.viewingMode);this.intersectionHelper.intersectRay(y3.ray,r,Kee)&&(y3.center=Kee),this.animation.update(y3,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this.hasTarget&&this.animation.finished}stepController(e,t){this.hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this.hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return me(I({apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0}},e),{easing:typeof e.easing=="string"?Y7e[e.easing]:e.easing})}};u([d({constructOnly:!0})],um.prototype,"view",void 0),u([d({constructOnly:!0})],um.prototype,"mode",void 0),um=u([P("esri.views.3d.state.controllers.PointToPointAnimationController")],um);const y3=new wi,Kee=M();function Tye(e,t,i){return Lje(e,e.screenToRender(t,Ne.get()),i)}function Lje(e,t,i){const r=zs(Ne.get(),t);if(r[2]=0,!e.unprojectFromRenderScreen(r,i.origin))return null;const s=zs(Ne.get(),t);s[2]=1;const n=e.unprojectFromRenderScreen(s,Ne.get());return R(n)?null:(de(i.direction,n,i.origin),i)}function r2(e,t,i){return Yq(e,e.screenToRender(t,Ne.get()),i)}function Yq(e,t,i){ne(i.origin,e.eye);const r=oe(Ne.get(),t[0],t[1],1),s=e.unprojectFromRenderScreen(r,Ne.get());return R(s)?null:(de(i.direction,s,i.origin),i)}function Zq(e,t,i,r){const s=r2(t,i,Nje);return B0(e,s,r)}const Nje=Vn(),Sye=30,ML=[1,3e8],Eye=70;function f1(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function z9(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function M0(e,t,i){const r=Tl(pO.get(),i[3],i);de(_i,e.eye,t),ke(_i,_i,r),e.eye=pe(_i,_i,t),de(_i,e.center,t),ke(_i,_i,r),e.center=pe(_i,_i,t),e.up=ke(_i,e.up,r)}function Fje(e,t,i,r){return db(e,Tye(t,i,Kq),r)}function B9(e,t,i,r){return db(e,r2(t,i,Kq),r)}function Qq(e,t,i,r){const s=Ne.get();let n=1-i;de(s,t,e.eye);const o=Pe(s);let a=o*(1-n);n>=0&&a<r&&(a=r,n=-(a-o)/o),Math.abs(o-a)<1e-6||(ae(s,s,n),e.eye=pe(_i,e.eye,s),e.center=Cs(_i,e.center,t,n))}function Aye(e,t,i){t.getScreenCenter(ete),Zq(e,t,ete,_i)&&(t.center=_i);const r=t.distance,s=r*i;if(Math.abs(r-s)<1e-6)return;const n=ae(Ne.get(),t.viewForward,s);t.eye=de(_i,t.center,n)}const ete=Rr();function nk(e,t){oe(t,0,0,0);for(const i of e)pe(t,t,i);ae(t,t,1/e.length)}function f$(e,t,i,r){return Math.sin(e/Pe(t))*(i+r.radius)}function tte(e,t,i,r){return f$(Math.PI/2,t,i,r)+(e-Math.PI/2)}var yn;(function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"})(yn||(yn={}));const ite={Elevation:3e4,Angle:Rt(6)},hC={Pole:.95,Angle:Rt(18),Tilt:45},Cye=Rt(80);function Rye(e,t,i,r,s){const n=M(),o=xn();let a=!0,l=!0;return e.intersectScreen(i,n)?o[3]=Pe(n):(l=!1,t.aboveGround?o[3]=Math.max(Pe(t.center),.9*s.radius):o[3]=Pe(t.eye)-t.relativeElevation,r?RR(o,t,i,n):a=Zq(o,t,i,n)),{sphere:o,scenePickPoint:a?n:null,hasGeometryIntersection:l}}function e4(e,t,i,r){return Pe(e.eye)-r.radius>ite.Elevation?yn.Horizontal:i?(r2(e,t,ute),-Math.sign(e.relativeElevation)*(.5*Math.PI+Bj(e.eye,ute.direction))<ite.Angle?yn.Vertical:yn.Horizontal):yn.Vertical}function Oye(e,t,i){de(ok,i,t),e.eye=de(_i,e.eye,ok),e.center=de(_i,e.center,ok)}const ok=M();function RR(e,t,i,r){const s=r2(t,i,Kq);return!R(s)&&(jS(e,s,v3),B0(e,s,r)?!(qn(v3,s.origin)<qn(r,s.origin))||(ne(r,v3),!1):(de(Fb,t.eye,t.center),be(Fb,Fb),Vue(Fb,-_e(be(Fb,Fb),v3),rte),db(rte,s,r),!1))}const v3=M(),Fb=M(),rte=ii();function Mye(e,t,i,r,s,n){let o;if(pt($L,e,t),de(x3,e,t),Pe(e)<=s||!r.aboveGround){pt(i,x3,r.eye);const a=_e(e,t)/(Pe(e)*Pe(t)),l=Math.cos(Be(g0.normalize(Rt(n)),0,Cye));o=-Rs(a)-Math.max(0,Pe(t)-s)/(l*s)}else de(ste,r.eye,r.center),pt(i,x3,ste),o=-Pe(x3)/s;return be(i,i),ae(i,i,Pe($L)),o}const ste=M();function nte(e,t,i,r){let s,n;const o=Math.cos(Be(g0.normalize(Rt(r)),0,Cye));return s=t>i?-(t-i)/(o*i):t<-i?Math.PI-(t+i)/(o*i):Rs(t/i),n=e>i?-(e-i)/(o*i):e<-i?Math.PI-(e+i)/(o*i):Rs(e/i),(n-s)*i}function Uje(e,t,i,r,s,n,o,a,l,c){const h=nte(e[2],t[2],o[3],l),p=c?nte(e[0],t[0],o[3],180):t[0]-e[0],f=Math.sin(a)*p-Math.cos(a)*h,g=Math.cos(a)*p+Math.sin(a)*h;be(_i,s);const y=c?f/Math.sqrt(Math.abs(o[3]**2-_e(i,_i)**2)):f/o[3],v=g/Math.sqrt(Math.abs(o[3]**2-_e(i,r)**2));rr(n,y,v)}function Pye(e,t,i,r,s,n,o,a,l,c){pt($L,e,t),fV(n.up,n.eye,_3,b3,w3),fV([0,0,1],n.eye,ym,u0,Lye),ne(i,u0),ne(r,ym),be(i,i),ae(i,i,Pe($L)),AZ(e,be(b3,b3),be(w3,w3),be(_3,_3),ote),AZ(t,b3,w3,_3,ate),Uje(ote,ate,e,ym,u0,s,o,a,l,c)}function kje(e,t,i,r,s,n,o){Tl(PL,s,r),Tl(IL,o,n),dr(Lx,PL,IL),de(t,e,i),ke(t,t,Lx),pe(t,t,i)}function Iye(e,t,i,r,s,n){Tl(PL,r,i),Tl(IL,n,s),dr(Lx,PL,IL),de(_i,e.eye,t),ke(_i,_i,Lx),e.eye=pe(_i,_i,t),de(_i,e.center,t),ke(_i,_i,Lx),e.center=pe(_i,_i,t),de(_i,e.up,t),ke(_i,_i,Lx),e.up=pe(_i,_i,t)}function Jq(e,t,i,r,s,n,o=hC.Pole,a=hC.Angle){const l=Math.abs(r)>Math.PI-a||Math.abs(r)<a,c=Math.abs(e[2])<i*o||Math.abs(t)>i;return!!(l&&c&&n.aboveGround&&s<hC.Tilt)}function $ye(e,t,i,r,s,n){if(n)uR(i,r,lte),M0(t,e,lte);else{const o=Mye(i,r,cte,t,e[3],s);M0(t,e,cR(cte,o))}}function Dye(e,t,i,r,s,n,o){const a=o?20:1,l=1e-12;let c,h;ne(nv,r),T3.copyFrom(t);for(let p=0;p<a&&qn(i,nv)>l&&(c=qn(i,nv),Pye(i,nv,u0,ym,N2,T3,e,s,n,o),Iye(T3,e,ym,N2[1],u0,N2[0]),kje(nv,nv,e,ym,N2[1],u0,N2[0]),h=qn(i,nv),h<c||p===0);p++)t.copyFrom(T3)}function zje(e,t,i,r,s,n,o){Jq(i,_e(t.up,i),e[3],-g0.normalize(Rt(s)),n,t,hC.Pole,hC.Angle)?Dye(e,t,i,r,-g0.normalize(Rt(s)),n,o):$ye(e,t,i,r,n,o)}function Bje(e,t,i,r,s,n){const{eye:o}=e;fV([0,0,1],o,ym,u0,Lye);const a=t.translation[0]*i.pan,l=s.mode==="zoom"?0:t.translation[1]*i.pan,c=Math.max(Math.sqrt(Math.abs(1-_e(e.center,ym)**2/Pe(e.center)**2)),.5),h=(Math.sin(n)*l+Math.cos(n)*a)/c,p=-Math.cos(n)*l+Math.sin(n)*a;switch(cl(r.pan.matrix,r.pan.matrix,h,ym),r.pan.enabled=!0,s.mode){case"pan":cl(r.pan.matrix,r.pan.matrix,p,u0),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}function Vje(e,t,i,r,s){const{eye:n,viewRight:o}=e,a=pt(Ne.get(),o,n),l=t.translation[0]*i.pan;switch(l!==0&&(cl(r.pan.matrix,r.pan.matrix,-l,a),r.pan.enabled=!0),s.mode){case"pan":{const c=t.translation[1]*i.pan;c!==0&&(cl(r.pan.matrix,r.pan.matrix,c,o),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}function Gje(e,t,i,r,s,n,o,a,l){Jq(e.center,_e(e.up,e.center),Pe(e.center),-g0.normalize(Rt(n)),o,t)?Bje(t,i,r,a,l,-g0.normalize(Rt(s))):Vje(t,i,r,a,l)}const ym=M(),u0=M(),Lye=M(),_3=M(),b3=M(),w3=M(),ote=M(),ate=M(),N2=Ye(),lte=t2(),PL=Te(),IL=Te(),Lx=Te(),nv=M(),_i=M(),x3=M(),T3=new wi,$L=M(),cte=M(),Kq={origin:M(),direction:M()},ute={origin:M(),direction:M()},hte=.6,ak=4,jje=12,Hje=60,qje=20;let DL=class extends um{constructor(){super(...arguments),this.zoomLocation=M(),this.tmpCamera=new wi,this.tmpViewDir=M(),this.tmpRayDir={origin:M(),direction:M()},this.targetOnSphere=M(),this.tmpCenter=M(),this.constraintOptions={selection:Yi.ALL_EXCEPT_COLLISION,interactionType:Mt.ZOOM,interactionFactor:null,interactionStartCamera:new wi,interactionDirection:null,tiltMode:en.TUMBLE},this.sphere=xn()}initialize(){this.intersector=ku(this.view.state.viewingMode)}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r);let s=!1,n=!1;this.intersectionHelper.intersectScreen(t,this.zoomLocation)&&(s=e>0,n=!0),this.tmpCamera.copyFrom(i.camera),s?this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter):this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:ne(this.zoomLocation,this.tmpCamera.center),this._updateCamera(this.tmpCamera,e,this.zoomLocation,t,n),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:600,easing:$O}}_updateCamera(e,t,i,r,s){const n=di(this.view.spatialReference);if(e4(e,r,s,n)===yn.Horizontal){let o=hte**t;this.sphere[3]=Pe(i),de(this.tmpViewDir,e.center,e.eye);const a=Pe(this.tmpViewDir);let l=a*o;if(o<=1&&l<ak&&(l=ak,o=l/a),Math.abs(a-l)<1e-6)return;const c=Pe(e.center);if(this.sphere[3]!==c){const h=this.sphere[3]+o*(c-this.sphere[3]);e.center=ae(S3,e.center,h/c)}ae(this.tmpViewDir,this.tmpViewDir,-o),e.eye=pe(S3,e.center,this.tmpViewDir),Fr(this.view,e,this.constraintOptions),qn(i,e.center)>1e-12&&Zq(this.sphere,e,r,this.targetOnSphere)&&zje(this.sphere,e,i,this.targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let o=hte**Math.abs(t);const a=t>0?1:-1;let l;r2(e,r,this.tmpRayDir),be(this.tmpRayDir.direction,this.tmpRayDir.direction),this.view.camera.position.hasZ&&(l=Math.abs(this.view.camera.position.z));let c=Math.max(jje*l,qje);const h=this.view._stage.renderView.getMinimalDepthForArea(null,r[0],r[1],this.view.state.camera,Hje);c=c>h?h:c,ae(this.tmpRayDir.direction,this.tmpRayDir.direction,c),pe(i,this.tmpRayDir.origin,this.tmpRayDir.direction);let p=c*o;const f=Math.max(ak,1.01*e.nearFar[0]);if(t>0&&p<f&&(p=f,o=p/c),Math.abs(c-p)<1e-6)return;ae(this.tmpRayDir.direction,this.tmpRayDir.direction,a*(1-o)),e.eye=pe(S3,e.eye,this.tmpRayDir.direction),e.center=pe(S3,e.center,this.tmpRayDir.direction)}i2(this.view,e)}};DL=u([P("esri.views.3d.state.controllers.global.ZoomStepController")],DL);const S3=M(),Wje=.6,Xje=4,Yje=60,Zje=14,Qje=20;let LL=class extends um{constructor(){super(...arguments),this.zoomLocation=M(),this.tmpCamera=new wi,this.tmpRayDir=M(),this.tmpCenter=M(),this.constraintOptions={selection:Yi.ALL,interactionType:Mt.ZOOM,interactionFactor:null,interactionStartCamera:new wi,interactionDirection:null,tiltMode:en.TUMBLE}}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r),this.tmpCamera.copyFrom(i.camera);const s=ku(this.view.state.viewingMode);e>0?(this.intersectionHelper.intersectScreenFreePointFallback(t,this.zoomLocation),this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter)):this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:ne(this.zoomLocation,this.tmpCamera.center);const n=Wje**e;let o=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),t[0],t[1],this.view.state.camera,Yje);const a=Math.max(Zje*Math.abs(this.view.camera.position.z),Qje);if(o=o?Math.min(o,a):a,o){const l=M();de(l,this.zoomLocation,this.tmpCamera.eye),o<Pe(l)&&(be(l,l),pe(this.zoomLocation,this.tmpCamera.eye,ae(l,l,o)))}this._updateCamera(this.tmpCamera,n,this.zoomLocation),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:600,easing:$O}}_updateCamera(e,t,i){de(this.tmpRayDir,i,e.eye);const r=Pe(this.tmpRayDir);let s=r*t;const n=t<=1,o=Math.max(Xje,1.01*e.nearFar[0]);n&&s<o&&(s=o,t=s/r),Math.abs(r-s)<1e-6||(ae(this.tmpRayDir,this.tmpRayDir,t),e.eye=de(dte,i,this.tmpRayDir),e.center=Cs(dte,e.center,i,1-t),Fr(this.view,e,this.constraintOptions))}};LL=u([P("esri.views.3d.state.controllers.local.ZoomStepController")],LL);const dte=M();function Jje(e,t){switch(t){case"primary":return e.pointerType==="touch"||e.button===0;case"secondary":return e.pointerType!=="touch"&&e.button===2;case"tertiary":return e.pointerType!=="touch"&&e.button===1}}function eW(e,t){if(e.pointerType==="touch")return!1;switch(t){case"primary":return e.button===0;case"secondary":return e.button===2;case"tertiary":return e.button===1}}class Kje extends Yn{constructor(t,i){super(!0),this.view=t,this.registerIncoming("double-click",i,r=>this._handleDoubleClick(r))}_handleDoubleClick(t){const i=t.data;if(Jje(i,"primary")){const r=this.view.state.isGlobal?new DL({view:this.view,mode:"animation"}):new LL({view:this.view,mode:"animation"});this.view.state.switchCameraController(r),r.zoomStep(Math.log(.5)/Math.log(.6),Rr(i.x,i.y)),t.stopPropagation()}}}let P0=class extends Q_{constructor(){super(...arguments),this.startCamera=new wi,this.currentCamera=new wi}get isInteractive(){return!0}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=cr.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}};P0=u([P("esri.views.3d.state.controllers.InteractiveController")],P0);var Ja;(function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"})(Ja||(Ja={}));const eHe=7,lk=90;let Nx=class extends P0{constructor(e){super(e),this.view=null,this.pivot=Ja.CENTER,this.lastPoint=Ye(),this.tmpWorldUp=M(),this.tmpViewDir=M(),this.tmpRotCurPoint=Ye(),this.tmpTransf=Te(),this.tmpAxis=M(),this.tmpPivotPoint=M(),this.pivotPos=M(),this.constraintOptions={selection:Yi.ALL,interactionType:Mt.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:en.TUMBLE}}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.rotScale=this.pivot===Ja.CENTER?3:1.5}begin(e){if(this.active){switch(this.pivot){case Ja.EYE:ne(this.pivotPos,this.startCamera.eye),this.constraintOptions.interactionType=Mt.LOOK_AROUND,this.constraintOptions.tiltMode=en.LOOK_AROUND,this.constraintOptions.selection=Yi.NONE;break;case Ja.CENTER:this.intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this.pivotPos)||ne(this.pivotPos,this.startCamera.center),this._constrainPivotPoint(e),this.startCamera.center=this.pivotPos,this.constraintOptions.interactionType=Mt.TUMBLE,this.constraintOptions.tiltMode=en.TUMBLE,this.constraintOptions.selection=Yi.ALL&~Yi.DISTANCE}this.constraintOptions.interactionStartCamera=this.startCamera,f1(this.startCamera,e,this.lastPoint)}}_constrainPivotPoint(e){const t=this.startCamera,i=M();de(i,this.pivotPos,t.eye);let r=Pe(i);this.view.camera.position.hasZ&&(r=Math.min(r,eHe*Math.abs(this.view.camera.position.z)));const s=di(this.view.spatialReference),n=Rr(t.width/t.pixelRatio*.5,t.height/t.pixelRatio*.5),o=e4(this.startCamera,n,!0,s);let a=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),t.fullWidth/t.pixelRatio*.5,t.fullHeight/t.pixelRatio*.5,t,2.5*lk,lk),l=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),e[0],e[1],t,lk);a===void 0&&l===void 0||(a=a===void 0?l:a,l=l===void 0||o===yn.Horizontal?a:l,r=a>l?l:a),be(i,i),ne(this.pivotPos,pe(this.tmpPivotPoint,t.eye,ae(this.tmpPivotPoint,i,r)))}update(e){if(this.active){switch(this.pivot){case Ja.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this.pivotPos);break;case Ja.CENTER:this.currentCamera.center=this.pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this.pivotPos)}Fr(this.view,this.currentCamera,this.constraintOptions)}}end(){this.active&&this.finishController()}_applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this.tmpWorldUp),f1(e,t,this.tmpRotCurPoint);let s=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,n=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;de(this.tmpViewDir,i,r);const o=Pe(this.tmpViewDir),a=Rs(_e(this.tmpViewDir,this.tmpWorldUp)/o);if(this.pivot===Ja.EYE){s*=-.5;const l=.5*Math.PI-a,c=.5*Math.PI*.99;s=l-Math.max(-c,Math.min(c,l+s))}return s=Be(s+a,Fn.min,Fn.max)-a,pt(this.tmpAxis,e.up,this.tmpViewDir),this.pivot===Ja.CENTER&&(n=-n),Tl(this.tmpTransf,n,this.tmpWorldUp),cl(this.tmpTransf,this.tmpTransf,s,this.tmpAxis),ke(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),e.up=ke(ck,e.up,this.tmpTransf),pe(ck,r,this.tmpViewDir),zs(this.lastPoint,this.tmpRotCurPoint),ck}};u([d({constructOnly:!0})],Nx.prototype,"view",void 0),u([d()],Nx.prototype,"pivot",void 0),Nx=u([P("esri.views.3d.state.controllers.RotateController")],Nx);const ck=M();class uk extends Yn{constructor(t,i,r,s){super(!0),this.view=t,this.pointerAction=i,this.pivot=r,this.registerIncoming("drag",s,n=>this._handleDrag(n))}_handleDrag(t){const i=t.data;if(i.pointers.size>1||!eW(t.data,this.pointerAction))return;const r=Rr(i.center.x,i.center.y);switch(i.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=new Nx({view:this.view,pivot:this.pivot}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(r);break;case"update":this.cameraController&&this.cameraController.update(r);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}t.stopPropagation()}}let m$=class extends P0{constructor(e){super(e),this.view=null,this.pickPoint=M(),this.tmpP0=Ye(),this.panAxisAngle=t2(),this.tmpRayDir=M(),this.targetOnSphere=M(),this.tmpRay={origin:M(),direction:M()},this.dragBeginPoint=Rr(),this.normalizedAnchorPoint=Ye(),this.constraintOptions={selection:Yi.ALL_EXCEPT_COLLISION,interactionType:Mt.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:en.TUMBLE},this.sphere=xn(),this.hasPickPoint=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;zs(this.dragBeginPoint,e),f1(this.startCamera,e,this.normalizedAnchorPoint);const t=di(this.view.spatialReference),i=Rye(this.intersectionHelper,this.startCamera,e,!1,t);if(this.navMode=e4(this.startCamera,e,i.hasGeometryIntersection,t),this.navMode===yn.Horizontal)this.hasPickPoint=!!i.scenePickPoint,this.pickPoint=i.scenePickPoint,this.sphere=i.sphere;else{let r;r2(this.startCamera,e,this.tmpRay),be(this.tmpRay.direction,this.tmpRay.direction),this.view.camera.position.hasZ&&(r=Math.abs(this.view.camera.position.z));let s=Be(Sye*r,ML[0],ML[1]);const n=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,Eye);s=s>n?n:s,this.hasPickPoint=!0,ae(this.tmpRay.direction,this.tmpRay.direction,s),pe(this.pickPoint,this.tmpRay.origin,this.tmpRay.direction)}this.constraintOptions.interactionStartCamera=this.startCamera}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this.navMode===yn.Horizontal){de(this.tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=Pe(this.tmpRayDir);f1(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;if(this.hasPickPoint&&r<t){const n=1-(1-r/t)*(1-this.sphere[3]/Pe(this.currentCamera.center));this.currentCamera.center=ae(E3,this.currentCamera.center,n)}ae(this.tmpRayDir,this.tmpRayDir,-r/t),this.currentCamera.eye=pe(E3,this.currentCamera.center,this.tmpRayDir),this.constraintOptions.interactionFactor=Ih(this.dragBeginPoint,e),Fr(this.view,this.currentCamera,this.constraintOptions),this.hasPickPoint&&(RR(this.sphere,this.currentCamera,this.dragBeginPoint,this.targetOnSphere),uR(this.pickPoint,this.targetOnSphere,this.panAxisAngle),M0(this.currentCamera,this.sphere,this.panAxisAngle))}else{const t=Pe(this.tmpRay.direction);f1(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;ae(this.tmpRayDir,this.tmpRay.direction,1-r/t),this.currentCamera.eye=pe(E3,this.currentCamera.eye,this.tmpRayDir),this.currentCamera.center=pe(E3,this.currentCamera.center,this.tmpRayDir)}i2(this.view,this.currentCamera)}}end(){this.active&&this.finishController()}};u([d({constructOnly:!0})],m$.prototype,"view",void 0),m$=u([P("esri.views.3d.state.controllers.global.ZoomController")],m$);const E3=M();let g$=class extends P0{constructor(e){super(e),this.view=null,this.tmpP=M(),this.tmpDir=M(),this.tmpN=M(),this.tmpP0=Ye(),this.tmpPoi=M(),this.tmpRayDir=M(),this.dragBeginPoint=Rr(),this.normalizedAnchorPoint=Ye(),this.constraintOptions={selection:Yi.ALL,interactionType:Mt.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:M(),tiltMode:en.TUMBLE},this.plane=ii()}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;let t;zs(this.dragBeginPoint,e),f1(this.startCamera,e,this.normalizedAnchorPoint),this.intersectionHelper.intersectScreenFreePointFallback(e,this.tmpP),de(this.tmpDir,this.tmpP,this.startCamera.eye),be(this.tmpDir,this.tmpDir),this.view.camera.position.hasZ&&(t=Math.abs(this.view.camera.position.z));let i=Be(Sye*t,ML[0],ML[1]);const r=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),e[0],e[1],this.view.state.camera,Eye);i=i>r?r:i,ae(this.tmpDir,this.tmpDir,i),pe(this.tmpP,this.startCamera.eye,this.tmpDir),de(this.tmpN,this.startCamera.eye,this.startCamera.center),be(this.tmpN,this.tmpN),this.tmpN[1]<0&&mo(this.tmpN,this.tmpN),WT(this.tmpP,this.tmpN,this.plane),this.constraintOptions.interactionStartCamera=this.startCamera}update(e){if(!this.active)return;Fje(this.plane,this.currentCamera,this.dragBeginPoint,this.tmpPoi)||ne(this.tmpPoi,this.currentCamera.center),f1(this.currentCamera,e,this.tmpP0);let t=4*(this.tmpP0[1]-this.normalizedAnchorPoint[1]);zs(this.normalizedAnchorPoint,this.tmpP0),de(this.tmpRayDir,this.tmpPoi,this.currentCamera.eye);const i=Pe(this.tmpRayDir);let r=i*(1-t);ne(this.constraintOptions.interactionDirection,this.tmpRayDir),ae(this.constraintOptions.interactionDirection,this.constraintOptions.interactionDirection,Math.sign(t)/i);const s=this.view.state.constraints.minimumPoiDistance;t>=0&&r<s&&(r=s,t=-(r-i)/i),Math.abs(i-r)<1e-6||(ae(this.tmpRayDir,this.tmpRayDir,t),this.currentCamera.eye=pe(ov,this.currentCamera.eye,this.tmpRayDir),Cs(ov,this.currentCamera.center,this.tmpPoi,t),this.tmpPoi[2]>this.startCamera.center[2]?ov[2]=Math.max(this.startCamera.center[2],ov[2]):ov[2]=Math.min(this.startCamera.center[2],ov[2]),this.currentCamera.center=ov,this.constraintOptions.interactionFactor=Ih(this.dragBeginPoint,e),Fr(this.view,this.currentCamera,this.constraintOptions))}end(){this.active&&this.finishController()}};u([d({constructOnly:!0})],g$.prototype,"view",void 0),g$=u([P("esri.views.3d.state.controllers.local.ZoomController")],g$);const ov=M();class tHe extends Yn{constructor(t,i,r){super(!0),this.view=t,this.pointerAction=i,this.registerIncoming("drag",r,s=>this._handleDrag(s))}_handleDrag(t){const i=t.data;if(i.pointers.size>1||!eW(t.data,this.pointerAction))return;const r=Rr(i.center.x,i.center.y);switch(i.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.view.state.isGlobal?this.cameraController=new m$({view:this.view}):this.cameraController=new g$({view:this.view}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(r);break;case"update":this.cameraController&&this.cameraController.update(r);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}t.stopPropagation()}}const iHe=M(),A3=M();function tW(){return{direction:M(),up:M()}}function Nye(e,t,i,r,s){let n=be(iHe,e),o=_e(n,r);const a=o>0;o=Math.abs(o),o>.99&&(o=Math.abs(_e(t,r)),o<.99?(ne(n,t),a&&ae(n,n,-1)):n=null);let l=0;if(n){ae(A3,r,_e(r,n)),de(n,n,A3);const h=_e(n,s)/(Pe(n)*Pe(s));pt(A3,n,s),l=(_e(A3,r)>0?1:-1)*yl(Rs(h))}const c=yl(Rs(-_e(r,e)/Pe(e)));return i?(i.heading=l,i.tilt=c,i):{heading:l,tilt:c}}const Fye=je(0,1,0),Uye=je(0,0,1),F2=Te(),Kp=M(),ef=M();function kye(e,t,i,r=tW()){const{direction:s,up:n}=r;return Hce(F2,-Rt(t)),VT(F2,F2,Rt(i)),ke(s,Uye,F2),ae(s,s,-1),ke(n,Fye,F2),r}function rHe(e,t,i,r){return Nye(t,i,r,Uye,Fye)}function sHe(e,t,i,r){const s=kye(e,i,r),n=M();return ae(n,s.direction,-t),pe(n,n,e),{up:s.up,eye:n,heading:i,tilt:r}}function nHe(e){return yl(e)}function oHe(e){return Rt(e)}function zye(e,t,i,r,s){const n=e.renderSpatialReference,o=e.map&&e.spatialReference||t.spatialReference;return tn(t,Kp,n),tn(t,ef,n),Kp[0]-=i/2,ef[0]+=i/2,Kp[1]-=r/2,ef[1]+=r/2,wn(Kp,n,Kp,o),wn(ef,n,ef,o),s?(s.xmin=Kp[0],s.ymin=Kp[1],s.xmax=ef[0],s.ymax=ef[1],s.spatialReference=o):s=new Xt(Kp[0],Kp[1],ef[0],ef[1],o),s}const aHe=Object.freeze({__proto__:null,headingTiltToDirectionUp:kye,directionToHeadingTilt:rHe,eyeForCenterWithHeadingTilt:sHe,lookAtTiltToEyeTilt:nHe,eyeTiltToLookAtTilt:oHe,toExtent:zye}),Bye=je(0,0,1),Vye=be(M(),je(1,1,1)),lHe=new m0(-180,180),U2=Te(),Ty=M(),Ub=M();function Gye(e,t,i,r=tW()){pt(Ty,e,Bye),_e(Ty,Ty)===0&&pt(Ty,e,Vye),Tl(U2,-Rt(t),e),cl(U2,U2,-Rt(i),Ty);const{up:s,direction:n}=r;return pt(s,Ty,e),be(s,s),ke(s,s,U2),be(n,e),mo(n,n),ke(n,n,U2),r}function cHe(e,t,i,r){const s=Ty,n=Ub;return be(s,e),pt(Ub,s,Bye),_e(Ub,Ub)===0&&pt(Ub,s,Vye),pt(n,Ub,s),Nye(t,i,r,s,n)}function uHe(e,t,i,r){const s={eye:M(),up:null,tilt:r,heading:i},n=Ty;n[0]=e[0],n[1]=e[2],n[2]=-e[1];const o=t,a=Rt(i),l=Rt(r),c=Math.sin(a),h=Math.cos(a),p=Math.sin(l),f=Math.cos(l),g=Pe(n);let y;if(Math.abs(l)<1e-8)y=o+g;else{const ie=g/p,$=Yh(o/ie),F=Math.PI-l-$;y=ie*Math.sin(F)}const v=f*o,b=o*o*(p*p),w=h*h*b,S=y-v,T=S*S,A=w*(w+T-n[1]*n[1]);if(A<0)return ae(s.eye,n,y/g),s.tilt=0,s;const C=Math.sqrt(A),O=n[1]*S,L=w+T;let U;if(U=h>0?-C+O:C+O,Math.abs(L)<1e-8)return g<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=o):ae(s.eye,n,y/g),s.tilt=0,hk(s.eye),dk(s,e);s.eye[1]=U/L;const N=c*c*b,z=p*o,V=h*z*s.eye[1],B=s.eye[1]*s.eye[1],J=1-B,Q=Math.sqrt(J),te=w*B+N-2*V*Q*S+J*T;return Math.abs(te)<1e-8?(ae(s.eye,n,y/g),s.tilt=0,hk(s.eye),dk(s,e)):(s.eye[0]=(J*(y*n[0]-v*n[0])-z*Q*(n[0]*s.eye[1]*h+n[2]*c))/te,s.eye[2]=(J*(y*n[2]-v*n[2])-z*Q*(n[2]*s.eye[1]*h-n[0]*c))/te,ae(s.eye,s.eye,y),hk(s.eye),dk(s,e))}function hk(e){const t=e[1];e[1]=-e[2],e[2]=t}function dk(e,t){const i=Gye(t,e.heading,e.tilt);return e.up=i.up,e}function hHe(e,t,i){const r=Pe(t),s=Math.sqrt(i*i+r*r-2*i*r*Math.cos(Math.PI-e)),n=Yh(i/(s/Math.sin(e)));return yl(e-n)}function dHe(e,t,i){const r=Rt(e),s=Pe(t);return Yh(i/(s/Math.sin(r)))+r}function jye(e,t,i,r,s){let n,o,a,l;const c=t.latitude,h=di(e.spatialReference).radius,p=t.longitude,f=_Ge(c,i,h)/2;n=p-f,o=p+f;const g=Rt(c),y=(1+Math.sin(g))/(1-Math.sin(g)),v=(y+1)*Math.tan(r/h/2),b=v*v;function w(T){const A=Math.PI/2;return(T=i2e.normalize(T,-A))>A&&(T=Math.PI-T),T}if(a=1.5*Math.PI-2*Math.atan(.5*(v+Math.sqrt(4*y+b))),l=a+r/h,a=w(a),l=w(l),l<a){const T=l;l=a,a=T}if(a=Math.max(yl(a),-90),l=Math.min(yl(l),90),o=lHe.monotonic(n,o),o-n>180){const T=(o-n-180)/2;n+=T,o-=T}const S=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:He.WGS84;return s?(s.xmin=n,s.ymin=a,s.xmax=o,s.ymax=l,s.spatialReference=S):s=new Xt(n,a,o,l,S),e.spatialReference&&e.spatialReference.isWebMercator&&fm(s,!1,s),s}const pHe=Object.freeze({__proto__:null,headingTiltToDirectionUp:Gye,directionToHeadingTilt:cHe,eyeForCenterWithHeadingTilt:uHe,lookAtTiltToEyeTilt:hHe,eyeTiltToLookAtTilt:dHe,toExtent:jye});function bS(e,t){return e!=null&&(t==null||(t===Ie.Local?!e.isGeographic||e.isWGS84||e.wkid===xu.CGCS2000:e.isWebMercator||e.isWGS84||e.wkid===xu.CGCS2000||e.wkid===xu.GCSMARS2000||e.wkid===xu.GCSMARS2000_SPHERE||e.wkid===xu.GCSMOON2000))}const Hye=he.getLogger("esri.views.3d.support.cameraUtils"),qye=39.37,Wye=96,V9=1,fHe=8,mHe=5,Xye=1,pte=M(),C3=M(),gHe={heading:0,tilt:0},Kf=new et,yHe=new m0(-20037508342788905e-9,20037508342788905e-9),vHe=new m0(-180,180);var jn;function DO(e){return e.spatialReference||He.WGS84}function s2(e){return e.viewingMode==="global"?pHe:aHe}function _He(e,t,i,r,s){return s2(e).headingTiltToDirectionUp(t,i,r,s)}function Xf(e,t){if(R(t))return null;const i=e.renderSpatialReference,r=s2(e).headingTiltToDirectionUp,s=M();if(!tn(t.position,s,i))return null;const n=r(s,t.heading,t.tilt);ae(n.direction,n.direction,e.state.camera.distance),pe(n.direction,n.direction,s);const o=bb(e,s,n.direction,n.up);return o.fov=Rt(t.fov),o}(function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"})(jn||(jn={}));const kb=M();function wS(e,t,i){const r=e.renderSpatialReference,s=t4(e,t.eye,t.viewForward,t.up,gHe);let n=DO(e);return wn(t.eye,r,kb,n)||(n=He.WGS84,wn(t.eye,r,kb,n)),R(i)?new _l(new et(kb,n),s.heading,s.tilt,yl(t.fov)):(i.position.x=kb[0],i.position.y=kb[1],i.position.z=kb[2],i.position.spatialReference=n,i.heading=s.heading,i.tilt=s.tilt,i.fov=yl(t.fov),i)}function iW(e,t,i){const r=e.state.camera,s=r.width/2/r.pixelRatio;return e.renderCoordsHelper.viewingMode===Ie.Global&&i!=null&&(t*=Math.cos(Rt(i))),t/=e.renderCoordsHelper.unitInMeters,s/(Wye*qye/t)/Math.tan(r.fovX/2)}function X1(e,t,i){const r=e.state.camera,s=t*Math.tan(r.fovX/2),n=r.width/2/r.pixelRatio;let o=Wye*qye/(n/s);return e.renderCoordsHelper.viewingMode===Ie.Global&&(o/=Math.cos(Rt(i))),o*=e.renderCoordsHelper.unitInMeters,o}function Yye(e,t,i,r,s,n){return Zye(e,t,iW(e,i,t.latitude),r,s,n)}function Zye(e,t,i,r,s,n){if(m1(n)){const a=new n2(n.signal);return OR(e,r.heading,r.tilt,t,i,s,a),void a.resolver.promise.then(l=>{const c=FL(e,l,r.fov);if(!R(c))return n.resolver.resolve(c);n.resolver.reject()},l=>n.resolver.reject(l))}const o=OR(e,r.heading,r.tilt,t,i,s);return FL(e,o,r.fov,n)}function t4(e,t,i,r,s){return s2(e).directionToHeadingTilt(t,i,r,s)}function bHe(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,Kf,e.spatialReference)&&gt(Vh(e.elevationProvider,Kf),0)>Kf.z-Xye)}async function wHe(e,t,i){if(!e.renderCoordsHelper.fromRenderCoords(t,Kf,e.spatialReference))return!1;const r=await e.elevationProvider.queryElevation(Kf.x,Kf.y,Kf.z,Kf.spatialReference,"ground",i);return gt(r,0)>Kf.z-Xye}async function xHe(e,t,i){const r=M();if(t)if(t instanceof et){if(tn(t,r,e.renderSpatialReference),t.z==null&&e.basemapTerrain!=null){const s=await e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",i);return _(s)&&e.renderCoordsHelper.setAltitude(r,s),r}}else ne(r,t);else ne(r,e.state.camera.center);return r}function THe(e,t){const i=M();if(t&&t instanceof et){if(tn(t,i,e.renderSpatialReference),t.z==null&&e.basemapTerrain!=null){const r=Vh(e.elevationProvider,t);_(r)&&e.renderCoordsHelper.setAltitude(i,r)}}else ne(i,t||e.state.camera.center);return i}function OR(e,t,i,r,s,n,o){const a=r&&r instanceof et?r:null;if(m1(o))return xHe(e,r,o.signal).then(c=>{G9(e,t,i,a,c,s,n,o)},c=>o.resolver.reject(c)),null;const l=THe(e,r);return G9(e,t,i,a,l,s,n,o)}function G9(e,t,i,r,s,n,o,a){if(R(r)){const p=e.renderSpatialReference;if(r=_0(s,p,DO(e)),R(r))return null}n=Math.max(n,e.state.constraints.minimumPoiDistance);const l=AHe(e,t,i,s,n,o),c=(0,s2(e).eyeForCenterWithHeadingTilt)(s,n,l.heading,l.tilt);if(o===jn.ADJUST&&e.viewingMode==="global"&&i>0){const p=()=>{const g=Qye(e,s,n,RHe(e,n,i,s));return o=i-g<1?jn.LOCKED:jn.ADJUST,G9(e,t,g,r,s,n,o,a)},f=e.map.ground.navigationConstraint;if(!f||f.type==="stay-above"){if(bHe(e,c.eye))return p();if(m1(a))return wHe(e,c.eye,a.signal).then(g=>g?p():(a.resolver.resolve({eye:c.eye,up:c.up,center:As(s),heading:c.heading,tilt:c.tilt}),null)),null}}const h=!a||m1(a)?{center:M(),eye:M(),up:M(),tilt:0,heading:0}:a;return h.eye=c.eye,h.up=c.up,h.center=As(s),h.heading=c.heading,h.tilt=c.tilt,m1(a)&&a.resolver.resolve(h),h}function dC(e,t,i,r,s,n=null){const o=t.zmax!=null&&t.zmin!=null;let a,l,c;if(e.state.isGlobal){if(!bS(t.spatialReference,Ie.Global))return m1(n)&&n.resolver.reject(),null;const w=new et(t.xmin,t.ymin,t.spatialReference),S=new et(t.xmax,t.ymax,t.spatialReference),T=t.spatialReference.isGeographic?vHe:yHe;a=new et({x:T.center(w.x,S.x),y:(S.y+w.y)/2,z:o?(t.zmax+t.zmin)/2:null,spatialReference:t.spatialReference});const A=di(t.spatialReference),C=vGe(a,w,S);l=C.lon,c=C.lat,T.diff(w.x,S.x)>T.range/2&&(l+=A.halfCircumference),l=Math.min(l,A.halfCircumference),c=Math.min(c,A.halfCircumference)}else{const w=gt(e.renderSpatialReference,t.spatialReference);w.equals(t.spatialReference)||(t=dO(t,w)),l=t.xmax-t.xmin,c=t.ymax-t.ymin;const S=o?(t.zmax+t.zmin)/2:null;a=new et({x:t.xmin+.5*l,y:t.ymin+.5*c,z:S,spatialReference:w})}const h=o?t.zmax-t.zmin:0,p=e.state.camera,f=1/Math.tan(p.fovX/2),g=1/Math.tan(p.fovY/2),y=1/Math.tan(p.fov/2),v=Math.max(.5*l*f,.5*c*g,.5*h*y)/V9;if(m1(n)){const w=new n2(n.signal);return OR(e,i,r,a,v,s,w),void w.resolver.promise.then(S=>{const T=FL(e,S,e.camera.fov);if(!R(T))return n.resolver.resolve(T);n.resolver.reject()},S=>n.resolver.reject(S))}const b=OR(e,i,r,a,v,s);return FL(e,b,e.camera.fov,n)}function SHe(e,t,i){const r=e.renderSpatialReference,s=_0(i,r,DO(e));if(R(s))return null;const n=Math.tan(t.fovX/2),o=Math.tan(t.fovY/2),a=c7(t.eye,i),l=2*a*n*V9,c=2*a*o*V9;return e.viewingMode==="global"?jye(e,s,l,c):zye(e,s,l,c)}function EHe(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(i/r)/Math.LN2>fHe)return!0;const s=e.renderSpatialReference,n=DO(e),o=_0(t,s,n),a=_0(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s,n);if(R(o)||R(a))return!1;const l=Math.tan(.5*e.state.camera.fov)*r;return a.distance(o)/l>mHe}function AHe(e,t,i,r,s,n){let o=0;return n===jn.ADJUST&&EHe(e,r,s)?(t=0,o=CHe(e,s,i,r)):o=rW(e,r,s,i),o=e.state.constraints.clampTilt(s,o),{heading:t,tilt:i=Qye(e,r,s,o)}}const NL=.7;function CHe(e,t,i,r){const s=e.state.constraints.tilt(t);s.max=Math.min(s.max,.5*Math.PI);const n=s.min*(1-NL)+s.max*NL,o=rW(e,r,t,i);return Math.min(o,n)}function RHe(e,t,i,r){const s=e.state.constraints.tilt(t);let n=rW(e,r,t,i);return n=Math.min(n,.5*Math.PI),s.min*(1-NL)+n*NL}function Qye(e,t,i,r){return s2(e).lookAtTiltToEyeTilt(r,t,i)}function rW(e,t,i,r){return s2(e).eyeTiltToLookAtTilt(r,t,i)}function FL(e,t,i,r){if(R(t))return null;const s=e.renderSpatialReference,n=_0(t.eye,s,DO(e));return R(n)?null:_(r)?(r.position=n,r.heading=t.heading,r.tilt=t.tilt,r.fov=i,r):new _l(n,t.heading,t.tilt,i)}function Jye(e,t){var i;const r=(i=e.basemapTerrain)==null?void 0:i.tilingScheme;if(r)return r.levelAtScale(t);Hye.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function Kye(e,t){var i;const r=(i=e.basemapTerrain)==null?void 0:i.tilingScheme;if(r)return r.scaleAtLevel(t);Hye.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function OHe(e,t){return e.spatialReference?ahe(t,e.spatialReference):void 0}function e0e(e,t,i){const r=e.renderSpatialReference;let s,n;t||(t=e.state.camera);const o=He.WGS84;return t instanceof _l?(s=t.position.latitude,tn(t.position,pte,r),tn(i,C3,r),n=xi(pte,C3)):(wn(t.center,r,C3,o),s=C3[1],n=t.distance),X1(e,n,s)}class n2{constructor(t){this.signal=t,this.resolver=Sm()}}function m1(e){return e&&"resolver"in e}function Zu(e){let t=e*e;return e<0&&(t*=-1),t}function fte(e,t,i){const r=i,s=e.state,n=e.device,o=t.tiltDirection==="forward-down"?1:-1,a=1;return n.deviceType==="standard"?(r.translation[0]=Zu(s.axes[0]),r.translation[1]=Zu(s.axes[1]),r.translation[2]=Zu(s.buttons[7])-Zu(s.buttons[6]),r.heading=Zu(s.axes[2]),r.tilt=Zu(s.axes[3])):n.deviceType==="spacemouse"&&(r.translation[0]=1.2*Zu(s.axes[0]),r.translation[1]=1.2*Zu(s.axes[1]),r.translation[2]=2*-Zu(s.axes[2]),r.heading=1.2*Zu(s.axes[5]),r.tilt=1.2*Zu(s.axes[3])),r.tilt*=o,ae(r.translation,r.translation,a),r}function mte(e,t){const i=t;return i.translation[0]=e[1]-e[0],i.translation[1]=e[3]-e[2],i.translation[2]=e[4]-e[5],i.heading=e[7]-e[6],i.tilt=e[8]-e[9],i.zoom=e[10]-e[11],i}function pk(e){return e.translation[0]===0&&e.translation[1]===0&&e.translation[2]===0&&e.heading===0&&e.tilt===0&&e.zoom===0}let Iy=class extends P0{constructor(e){super(e),this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this.tmpCamera=new wi,this.constraintOptions={selection:Yi.ALL,interactionType:Mt.NONE,interactionStartCamera:new wi,interactionFactor:0,interactionDirection:null,tiltMode:en.LOOK_AROUND}}handleEventGamepad(e){const t=fte(e,this.view.navigation.gamepad,this.transformation);(e.action==="end"||pk(t))&&this.finishController()}activateDirection(e){this.keysButtonState[e]=1,mte(this.keysButtonState,this.transformation)}deactivateDirection(e){this.keysButtonState[e]=0;const t=mte(this.keysButtonState,this.transformation);pk(t)&&this.finishController()}onControllerStart(e){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this.filteredSurfaceElevation+=i*(t-this.filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,av),this._applyDisabledMovementTypes(av),this._applyPan(av.pan),this._applyRotate(av.rotate),this._applyZoom(av.zoom),this._applyAscend(av.ascend),this.constraintOptions.interactionType=Mt.NONE,this.constraintOptions.selection=Yi.COLLISION,Fr(this.view,this.currentCamera,this.constraintOptions),super.stepController(e,t)}_updateStartHeading(){this.transformation.heading!==0&&(this.headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;de(Yo,t.center,t.eye),ke(Yo,Yo,e.matrix),t.center=pe(Yo,Yo,t.eye),t.up=ke(Yo,t.up,e.matrix),this.constraintOptions.interactionType=Mt.LOOK_AROUND,this.constraintOptions.selection=Yi.ALL_EXCEPT_COLLISION,Fr(this.view,t,this.constraintOptions)}_applyPan(e,t=this.currentCamera){!e.enabled||(t.eye=ke(Yo,t.eye,e.matrix),t.center=ke(Yo,t.center,e.matrix),this.view.state.isGlobal&&(t.up=ke(Yo,t.up,e.matrix)),this.constraintOptions.interactionType=Mt.PAN,this.constraintOptions.selection=Yi.ALL,Fr(this.view,t,this.constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=pe(Yo,this.currentCamera.eye,ae(Ne.get(),t,e)),ne(k2,t),mo(k2,k2),this.constraintOptions.interactionDirection=k2,this.constraintOptions.interactionType=Mt.ZOOM,this.constraintOptions.selection=Yi.ALL_EXCEPT_COLLISION,Fr(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,Ne.get());if(this.constraintOptions.interactionDirection=ne(k2,t),this.view.state.isGlobal){const i=Pe(this.currentCamera.eye),r=(i+e)/i;this.currentCamera.eye=ae(Yo,this.currentCamera.eye,r),this.currentCamera.center=ae(Yo,this.currentCamera.center,r)}else{const i=ae(Ne.get(),t,e);this.currentCamera.eye=pe(Yo,this.currentCamera.eye,i),this.currentCamera.center=pe(Yo,this.currentCamera.center,i)}this._updateCameraCenter(),this.constraintOptions.interactionType=Mt.ASCEND,this.constraintOptions.selection=Yi.COLLISION,Fr(this.view,this.currentCamera,this.constraintOptions)&&this._updateCameraCenter(),this.constraintOptions.selection=Yi.ALL_EXCEPT_COLLISION,Fr(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){NHe(i);const r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,i):this._calculateControlTransformationGlobal(r,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,Yo)}_calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:s}=t,n=this.transformation,o=this.view.navigation.gamepad,a=oe(Ne.get(),s[0],s[1],0);be(a,a);const l=n.translation[0]*e.pan;if(l!==0){const y=ae(Ne.get(),r,l);Wo(i.pan.matrix,i.pan.matrix,y),i.pan.enabled=!0}switch(o.mode){case"pan":{const y=-n.translation[1]*e.pan;if(y!==0){const v=ae(Ne.get(),a,y);Wo(i.pan.matrix,i.pan.matrix,v),i.pan.enabled=!0}i.zoom=n.zoom*e.zoom;break}case"zoom":i.zoom=(-n.translation[1]+n.zoom)*e.zoom;break;default:o.mode}const c=n.translation[2]*e.ascend;i.ascend=c;const h=-n.heading*e.rotate;h!==0&&(cl(i.rotate.matrix,i.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,Ne.get())),i.rotate.enabled=!0);const p=n.tilt*e.rotate,f=R0(this.view.renderCoordsHelper,t.center,t.eye),g=Be(f+p,Fn.min,Fn.max)-f;g&&(cl(i.rotate.matrix,i.rotate.matrix,g,r),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:s}=t,n=this.transformation,o=this.view.navigation.gamepad,a=pt(Ne.get(),s,r);be(a,a),mo(a,a),Gje(this.startCamera,t,n,e,this.view.camera.heading,this.headingStart,this.view.camera.tilt,i,o),this.tmpCamera.copyFrom(this.currentCamera),this._applyPan(av.pan,this.tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,c=n.translation[2]*e.ascend;i.ascend=c;const h=-n.heading*e.rotate;h!==0&&(cl(i.rotate.matrix,i.rotate.matrix,h,this.tmpCamera.eye),i.rotate.enabled=!0);const p=n.tilt*e.rotate,f=this._clampTiltDeltaGlobalToValidRange(p,t.ray,l);f!==0&&(cl(i.rotate.matrix,i.rotate.matrix,f,this.tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=n.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const r=di(this.view.spatialReference),s=f$(Fn.min,t.origin,i,r);let n=0,o=0;const a=Ne.get();if(this.view.renderCoordsHelper.intersectManifold(t,i,a)){const l=R0(this.view.renderCoordsHelper,a,t.origin);n=f$(l,t.origin,i,r),o=f$(Fn.max,t.origin,i,r)}else{jS(i+r.radius,t,a);const l=Rs(-_e(t.direction,be(a,a)));n=tte(l,t.origin,i,r),o=tte(Fn.max,t.origin,i,r)}return Be(n+e,s,o)-n}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,s=r.getAltitude(e),n=t+Math.abs(s-t);return r.setAltitude(i,n,e),n}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:s}=_He(this.view,t,0,t0e,LHe),n=i.intersectManifoldClosestSilhouette(xc(t,s),e,Ne.get()),o=xi(t,n),a=i.intersectManifoldClosestSilhouette(xc(t,Um(Ne.get(),t,r.center)),e,Ne.get()),l=xi(t,a);return Math.min(o,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:s}=i,n=t.intersectManifoldClosestSilhouette(r.ray,this.filteredSurfaceElevation,Ne.get());if(s){const o=de(Ne.get(),e,n),a=Pe(o);ae(o,o,1/a);const l=be(Ne.get(),e),c=Rs(_e(l,o));return a*Math.sin(Math.min(PHe,c))}{const o=ne(Ne.get(),e);return t.setAltitude(o,this.filteredSurfaceElevation),xi(n,o)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:IHe}_computeVelocities(e){const t=this.filteredSurfaceElevation,i=t+di(this.view.spatialReference).radius,{camera:r,isGlobal:s}=this.view.state,n=Ne.get(),o=this._getPointAbsoluteSurfaceElevation(r.eye,t,n),a=this._clampedDistanceToSurface(t,n),l=r.width/2,c=gte*r.width,h=gte*r.width,p=a*Math.tan(.5*r.fovX)/l,f=p/i,g=p/this._computeHeadingRotateRadius(n),y=o-t;return{pan:(s?f:p)*c*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(c*e/l)*y-y),zoom:2**(c*e/l)*a-a,rotate:Be(g*h,$He,DHe)*e}}_applyDisabledMovementTypes(e){!_(this.disableMovements)||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&Ap(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&Ap(e.rotate.matrix))}static activatesFor(e,t){const i=fte(t,e.navigation.gamepad,MHe);return!(t.action==="end"||pk(i))}};u([d({constructOnly:!0})],Iy.prototype,"view",void 0),u([d({constructOnly:!0})],Iy.prototype,"gamepadDevice",void 0),u([d({constructOnly:!0})],Iy.prototype,"disableMovements",void 0),Iy=u([P("esri.views.3d.state.controllers.GamepadKeyboardController")],Iy);const MHe={translation:[0,0,0],heading:0,tilt:0,zoom:0},t0e=80,PHe=Rt(t0e),gte=.75,IHe=5,$He=Rt(30),DHe=Rt(80),av={zoom:0,ascend:0,pan:{enabled:!1,matrix:Te()},rotate:{enabled:!1,matrix:Te()}},Yo=M(),k2=M(),LHe=tW();function NHe(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,Ap(e.pan.matrix),e.rotate.enabled=!1,Ap(e.rotate.matrix)}class FHe extends Yn{constructor(t){super(!0),this.view=t,this.watchHandles=new Ut,this.handle=this.registerIncoming("gamepad",i=>this._handleEventGamepad(i)),this.handle.pause()}onInstall(t){super.onInstall(t),this.watchHandles.add([Wt(this.view.navigation.gamepad,"enabled",i=>{i?this.handle.resume():(this.handle.pause(),this.cameraControllerGamepad&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null))}),this.view.navigation.gamepad.watch("device",i=>{this.cameraControllerGamepad&&i&&this.cameraControllerGamepad.gamepadDevice!==i&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null)})])}onUninstall(){this.watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(t){const i=this.view.navigation.gamepad.device;if(i&&t.data.device!==i)return;const r=this.cameraControllerGamepad&&this.cameraControllerGamepad.active;if(r||Iy.activatesFor(this.view,t.data)){if(!r){const s=new Iy({view:this.view,gamepadDevice:t.data.device});this.view.state.switchCameraController(s)&&(this.cameraControllerGamepad=s)}this.cameraControllerGamepad&&this.cameraControllerGamepad.active&&this.cameraControllerGamepad.gamepadDevice===t.data.device&&this.cameraControllerGamepad.handleEventGamepad(t.data)}}}var Wa;(function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"})(Wa||(Wa={}));class UHe extends Yn{constructor(t,i){super(!0),this.view=t,this.disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:Ie.Local},this.keyToNumber={[i.left]:Wa.LEFT,[i.right]:Wa.RIGHT,[i.forward]:Wa.FORWARD,[i.backward]:Wa.BACKWARD,[i.up]:Wa.UP,[i.down]:Wa.DOWN,[i.headingLeft]:Wa.HEADINGLEFT,[i.headingRight]:Wa.HEADINGRIGHT,[i.tiltUp]:Wa.TILTUP,[i.tiltDown]:Wa.TILTDOWN,[i.zoomIn]:Wa.ZOOMIN,[i.zoomOut]:Wa.ZOOMOUT},this.registerIncoming("key-down",null,r=>this._handleKeyDown(r)),this.registerIncoming("key-up",null,r=>this._handleKeyUp(r)),this.registerIncoming("blur",null,()=>this._handleBlur())}_handleKeyDown(t){if(t.data.native.ctrlKey||t.data.native.metaKey)return;const i=this.keyToNumber[t.data.key];i!=null&&(this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active||(this.cameraControllerKeyboard=new Iy({view:this.view,disableMovements:this.disableMovements}),this.view.state.switchCameraController(this.cameraControllerKeyboard)),this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.activateDirection(i),t.stopPropagation()))}_handleBlur(){this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.finishController(),this.cameraControllerKeyboard=null)}_handleKeyUp(t){if(t.data.native.ctrlKey||t.data.native.metaKey)return;const i=this.keyToNumber[t.data.key];i!=null&&this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.deactivateDirection(i),t.stopPropagation())}}class kHe extends Yn{constructor(t,i){super(!0),this.view=t,this.registerIncoming("mouse-wheel",i,r=>this._handleMouseWheel(r))}_handleMouseWheel(t){if(!this.view.navigation.mouseWheelZoomEnabled)return;const i=t.data;this.cameraController&&this.cameraController.active||(this.cameraController=this.view.state.isGlobal?new DL({view:this.view,mode:"interaction"}):new LL({view:this.view,mode:"interaction"}),this.view.state.switchCameraController(this.cameraController)),this.cameraController.zoomStep(-1/60*i.deltaY,Rr(i.x,i.y)),t.preventDefault(),t.stopPropagation()}}class UL{constructor(t){this._gain=t}reset(t){this._value=t}set gain(t){this._gain=t}get value(){return this._value===void 0?0:this._value}update(t){this._value===void 0?this._value=t:this._value=this._gain*t+(1-this._gain)*this._value}}let h0=class extends CR{constructor(e){super(e),this.view=null,this.beginCamera=new wi,this.elapsedTimeSec=0,this.constraintOptions={selection:Yi.ALL,interactionType:Mt.PAN,interactionFactor:0,interactionStartCamera:new wi,interactionDirection:null,tiltMode:en.TUMBLE}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new sS}get steppingFinished(){return this.momentum.isFinished(this.elapsedTimeSec)}onControllerStart(e){this.beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this.beginCamera,super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this.beginCamera),this.elapsedTimeSec+=e,this.momentumStep(this.elapsedTimeSec,t),Fr(this.view,t,this.constraintOptions)}};u([d({constructOnly:!0})],h0.prototype,"view",void 0),h0=u([P("esri.views.3d.state.controllers.momentum.MomentumController")],h0);let pC=class extends h0{constructor(e){super(e),this.interactionType=Mt.PAN,this.tmpPan=M()}momentumStep(e,t){const i=this.momentum.value(e);ae(this.tmpPan,this.momentum.direction,i),t.eye=de(yte,t.eye,this.tmpPan),t.center=de(yte,t.center,this.tmpPan),this.constraintOptions.interactionDirection=this.tmpPan}};u([d({constructOnly:!0})],pC.prototype,"momentum",void 0),pC=u([P("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],pC);const yte=M(),zHe=M(),R3=M();let y$=class extends h0{constructor(e){super(e),this.interactionType=Mt.PAN}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);ne(R3,t.eye),be(R3,R3),pt(this.momentum.axis2,R3,this.momentum.axis1),Iye(t,zHe,this.momentum.axis1,i,this.momentum.axis2,r)}};u([d({constructOnly:!0})],y$.prototype,"momentum",void 0),y$=u([P("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],y$);let F_=class extends h0{constructor(e){super(e),this.interactionType=Mt.TUMBLE}set center(e){this._set("center",As(e))}set axis(e){this._set("axis",As(e))}momentumStep(e,t){const i=this.momentum.value(e);M0(t,this.center,cR(this.axis,i))}};u([d({constructOnly:!0})],F_.prototype,"momentum",void 0),u([d({constructOnly:!0})],F_.prototype,"center",null),u([d({constructOnly:!0})],F_.prototype,"axis",null),F_=u([P("esri.views.3d.state.controllers.momentum.MomentumController")],F_);let Fx=class extends h0{constructor(e){super(e),this.interactionType=Mt.ZOOM,this.constraintOptions.interactionDirection=M()}set zoomCenter(e){this._set("zoomCenter",As(e))}momentumStep(e,t){ne(this.constraintOptions.interactionDirection,t.eye);const i=this.momentum.valueDelta(0,e);Qq(t,this.zoomCenter,i,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionDirection=Um(this.constraintOptions.interactionDirection,t.eye,this.constraintOptions.interactionDirection)}};u([d({constructOnly:!0})],Fx.prototype,"momentum",void 0),u([d({constructOnly:!0})],Fx.prototype,"zoomCenter",null),Fx=u([P("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],Fx);let p_=class extends h0{constructor(e){super(e),this.interactionType=Mt.ZOOM,this.radius=0,this.tmpSceneCenter=M(),this.tmpZoomAxisAngle=t2(),this.sphere=xn()}set screenCenter(e){this._set("screenCenter",Rr(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",As(e))}initialize(){this.sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);Aye(this.sphere,t,i),this.constraintOptions.interactionType=Mt.ZOOM,Fr(this.view,t,this.constraintOptions),RR(this.sphere,t,this.screenCenter,this.tmpSceneCenter),uR(this.sceneCenter,this.tmpSceneCenter,this.tmpZoomAxisAngle),M0(t,this.sphere,this.tmpZoomAxisAngle),this.constraintOptions.interactionType=Mt.PAN}};u([d({constructOnly:!0})],p_.prototype,"momentum",void 0),u([d({constructOnly:!0})],p_.prototype,"screenCenter",null),u([d({constructOnly:!0})],p_.prototype,"sceneCenter",null),u([d({constructOnly:!0})],p_.prototype,"radius",void 0),p_=u([P("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],p_);class $h{constructor(t){this.gain=t}update(t){if(this.hasLastValue){const i=this.computeDelta(t);this._updateDelta(i)}this.lastValue=t}reset(){this.lastValue=void 0,this.filteredDelta=void 0}get hasLastValue(){return this.lastValue!==void 0}get hasFilteredDelta(){return this.filteredDelta!==void 0}computeDelta(t){return t-this.lastValue}_updateDelta(t){this.hasFilteredDelta?this.filteredDelta=(1-this.gain)*this.filteredDelta+this.gain*t:this.filteredDelta=t}}class i4{constructor(t,i,r){this._initialVelocity=t,this._stopVelocity=i,this._friction=r,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(t){return t>this.duration}get friction(){return this._friction}value(t){return this.valueFromInitialVelocity(this._initialVelocity,t)}valueDelta(t,i){const r=this.value(t);return this.value(t+i)-r}valueFromInitialVelocity(t,i){i=Math.min(i,this.duration);const r=1-this.friction;return t*(r**i-1)/Math.log(r)}}class BHe extends i4{constructor(t,i,r,s,n){super(t,i,r),this.sceneVelocity=s,this.direction=n}value(t){return super.valueFromInitialVelocity(this.sceneVelocity,t)}}class i0e{constructor(t=300,i=12,r=.84){this.minimumInitialVelocity=t,this.stopVelocity=i,this.friction=r,this.enabled=!0,this.time=new $h(.6),this.screen=[new $h(.4),new $h(.4)],this.scene=[new $h(.6),new $h(.6),new $h(.6)],this.tmpDirection=M()}add(t,i,r){if(this.enabled){if(this.time.hasLastValue&&this.time.computeDelta(r)<.015)return;this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.scene[0].update(i[0]),this.scene[1].update(i[1]),this.scene[2].update(i[2]),this.time.update(r)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const t=this.screen[0].filteredDelta,i=this.screen[1].filteredDelta,r=Math.sqrt(t*t+i*i)/this.time.filteredDelta;return Math.abs(r)<this.minimumInitialVelocity?null:this.createMomentum(r,this.stopVelocity,this.friction)}createMomentum(t,i,r){oe(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);const s=Pe(this.tmpDirection);s>0&&ae(this.tmpDirection,this.tmpDirection,1/s);const n=s/this.time.filteredDelta;return new BHe(t,i,r,n,this.tmpDirection)}}class vte{constructor(t){this.gain=t}update(t){this.hasFilteredValue?this.filteredValue=(1-this.gain)*this.filteredValue+this.gain*t:this.filteredValue=t}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}}const _te=1e-5;class VHe extends i4{constructor(t,i,r,s,n,o=0,a){super(t,i,r),this.angularVelocity1=s,this.axis1=n,this.angularVelocity2=o,this.axis2=a}value1(t){return super.valueFromInitialVelocity(this.angularVelocity1,t)}value2(t){return super.valueFromInitialVelocity(this.angularVelocity2,t)}}class GHe{constructor(t=300,i=12,r=.84){this.minimumInitialVelocity=t,this.stopVelocity=i,this.friction=r,this.enabled=!0,this.tmpAxis1=M(),this.tmpAxis2=M(),this.tmpAngles=Ye(),this.time=new $h(.3),this.screen=[new $h(.4),new $h(.4)],this.angle1=new vte(.6),this.angle2=new vte(.6),this.axis1=M(),this.axis2=M(),this.lastScene=M()}addMomentumDirectRotation(t,i,r,s,n,o){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(r)<.01)return;let a=Mye(this.lastScene,i,this.tmpAxis2,s,n,o);this.angle2.update(0),Go(this.tmpAxis2)<_te?a=0:be(this.axis1,this.tmpAxis2),this.angle1.update(a),ne(this.lastScene,i)}this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.time.update(r)}}addMomentumPreserveHeading(t,i,r,s,n,o,a){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(r)<.01)return;Pye(this.lastScene,i,this.tmpAxis2,this.tmpAxis1,this.tmpAngles,s,n,o,a,!1),Go(this.tmpAxis2)<_te?(this.angle1.update(0),this.angle2.update(0)):(this.angle1.update(this.tmpAngles[1]),this.angle2.update(this.tmpAngles[0]),be(this.axis1,this.tmpAxis1),be(this.axis2,this.tmpAxis2)),ne(this.lastScene,i)}this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.time.update(r)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.angle1.reset(),this.angle2.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const t=this.screen[0].filteredDelta,i=this.screen[1].filteredDelta,r=Math.sqrt(t*t+i*i)/this.time.filteredDelta;return Math.abs(r)<this.minimumInitialVelocity?null:this.createMomentum(r,this.stopVelocity,this.friction)}createMomentum(t,i,r){const s=this.angle1.filteredValue/this.time.filteredDelta,n=this.angle2.filteredValue/this.time.filteredDelta;return new VHe(t,i,r,s,this.axis1,n,this.axis2)}}class r0e{constructor(t=2.5,i=.01,r=.95,s=12){this.minimumInitialVelocity=t,this.stopVelocity=i,this.friction=r,this.maxVelocity=s,this.enabled=!0,this.value=new $h(.8),this.time=new $h(.3)}add(t,i){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;if(this.value.hasFilteredDelta){const r=this.value.computeDelta(t);this.value.filteredDelta*r<0&&this.value.reset()}}this.time.update(i),this.value.update(t)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta)return null;let t=this.value.filteredDelta/this.time.filteredDelta;return t=Be(t,-this.maxVelocity,this.maxVelocity),Math.abs(t)<this.minimumInitialVelocity?null:this.createMomentum(t,this.stopVelocity,this.friction)}createMomentum(t,i,r){return new i4(t,i,r)}}class s0e extends r0e{constructor(t=3,i=.01,r=.95,s=12){super(t,i,r,s)}add(t,i){if(this.value.hasLastValue){const r=this.value.lastValue;let s=t-r;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;t=r+s}super.add(t,i)}}class jHe extends i4{constructor(t,i,r){super(t,i,r)}value(t){const i=super.value(t);return Math.exp(i)}valueDelta(t,i){const r=super.value(t),s=super.value(t+i)-r;return Math.exp(s)}}class n0e extends r0e{constructor(t=2.5,i=.01,r=.95,s=12){super(t,i,r,s)}add(t,i){super.add(Math.log(t),i)}createMomentum(t,i,r){return new jHe(t,i,r)}}let v$=class extends P0{constructor(e){super(e),this.view=null,this.smoothRotation=new UL(.05),this.rotationAxis=M(),this.panningPlane=ii(),this.smoothScaling=new UL(.05),this.zoomCenterScreen=Rr(),this.zoomMomentumEstimator=new n0e,this.rotationMomentumEstimator=new s0e,this.panSphericalMomentumEstimator=new GHe,this.panPlanarMomentumEstimator=new i0e,this.adjustedSphere=xn(),this.tmp3d=M(),this.tmpScreenPointArray=Rr(),this.beginScreenPoint=Rr(),this.beginScenePoint=M(),this.screenPickPoint=Rr(),this.navMode=yn.Horizontal,this.tmpInteractionDirection=M(),this.constraintOptions={selection:Yi.ALL,interactionType:Mt.NONE,interactionFactor:0,interactionStartCamera:new wi,interactionDirection:null,tiltMode:en.TUMBLE}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panPlanarMomentumEstimator.enabled=t,this.panSphericalMomentumEstimator.enabled=t,this.beginHeading=-g0.normalize(Rt(this.view.camera.heading)),this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.smoothRotation.reset(),em(e.center,this.screenPickPoint),zs(this.beginScreenPoint,this.screenPickPoint);const i=di(this.view.spatialReference),r=Rye(this.intersectionHelper,this.startCamera,this.screenPickPoint,!0,i);this.scenePickPoint=r.scenePickPoint,this.sphere=r.sphere,ne(this.beginScenePoint,this.scenePickPoint),this.navMode=e4(this.startCamera,this.screenPickPoint,r.hasGeometryIntersection,i),this.navMode===yn.Vertical&&this._preparePlanarPanMode(e),this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}_preparePlanarPanMode(e){const t=mo(this.tmp3d,this.startCamera.viewForward);WT(this.scenePickPoint,t,this.panningPlane);const i=Rr(this.screenPickPoint[0],0),r=M(),s=Pe(this.startCamera.eye);this.adjustedSphere[3]=s<this.sphere[3]?s-100:this.sphere[3],RR(this.adjustedSphere,this.startCamera,i,r);const n=zn();this.startCamera.projectToRenderScreen(r,n);const o=.9*n[1];this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],o),this.intersectionHelper.intersectScreen(this.screenPickPoint,this.scenePickPoint)&&WT(this.scenePickPoint,this.panningPlane,this.panningPlane);const a=M(),l=M(),c=M(),h=80,p=5,f=50;de(a,this.scenePickPoint,this.currentCamera.eye),be(a,a);const g=p*Math.max(Math.abs(this.view.camera.position.z),f),y=this.view._stage.renderView.getMinimalDepthForArea(null,this.screenPickPoint[0],this.screenPickPoint[1],this.view.state.camera,h),v=y?Math.min(y,g):g;ne(c,pe(l,this.currentCamera.eye,ae(l,a,v))),this.panningPlane[3]=-_e(this.panningPlane,c),this.startCamera.center=pe(l,this.startCamera.eye,ae(l,this.startCamera.viewForward,v));const b=em(e.center,this.tmpScreenPointArray);B9(this.panningPlane,this.startCamera,b,this.beginScenePoint)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this.navMode===yn.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e))}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return this.navMode===yn.Horizontal?new p_({view:this.view,momentum:t,screenCenter:this.zoomCenterScreen,sceneCenter:this.beginScenePoint,radius:this.sphere[3]}):new Fx({view:this.view,momentum:t,zoomCenter:this.beginScenePoint});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new F_({view:this.view,momentum:i,center:this.sphere,axis:this.rotationAxis});if(this.navMode===yn.Horizontal){const r=this.panSphericalMomentumEstimator.evaluateMomentum();if(r)return new y$({view:this.view,momentum:r})}else{const r=this.panPlanarMomentumEstimator.evaluateMomentum();if(r)return new pC({view:this.view,momentum:r})}return null}_zoomSpherical(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),Aye(this.sphere,this.currentCamera,this.smoothScaling.value),em(e.center,this.zoomCenterScreen),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),this.constraintOptions.interactionType=Mt.ZOOM,this.constraintOptions.interactionFactor=Ih(e.radius-this.beginRadius),Fr(this.view,this.currentCamera,this.constraintOptions)}_panningSpherical(e){const t=em(e.center,this.tmpScreenPointArray);RR(this.sphere,this.currentCamera,t,this.tmp3d),Jq(this.beginScenePoint,_e(this.currentCamera.up,this.beginScenePoint),this.sphere[3],this.beginHeading,this.view.camera.tilt,this.startCamera)?(Dye(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.beginHeading,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this.tmp3d,.001*e.timestamp,this.startCamera,this.sphere,this.beginHeading,this.view.camera.tilt)):($ye(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumDirectRotation(t,this.tmp3d,.001*e.timestamp,this.startCamera,this.sphere[3],this.view.camera.tilt)),this.constraintOptions.interactionType=Mt.PAN,this.constraintOptions.interactionFactor=Ih(this.screenPickPoint,t),Fr(this.view,this.currentCamera,this.constraintOptions)}_rotateSpherical(e){be(this.rotationAxis,this.scenePickPoint),this.currentCamera.aboveGround||mo(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value,i=t+z9(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=r,this.smoothRotation.update(i);const s=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(s,.001*e.timestamp),M0(this.currentCamera,this.sphere,cR(this.rotationAxis,s)),this.constraintOptions.interactionType=Mt.TUMBLE,this.constraintOptions.interactionFactor=Ih(e.radius*i),Fr(this.view,this.currentCamera,this.constraintOptions)}_panningPlanar(e){const t=em(e.center,this.tmpScreenPointArray);B9(this.panningPlane,this.currentCamera,t,this.tmp3d)&&(Oye(this.currentCamera,this.beginScenePoint,this.tmp3d),this.panPlanarMomentumEstimator.add(t,this.tmp3d,.001*e.timestamp),this.constraintOptions.interactionType=Mt.PAN,this.constraintOptions.interactionFactor=Ih(this.beginScreenPoint,t),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this.tmpInteractionDirection),Fr(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),Qq(this.currentCamera,this.beginScenePoint,this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionType=Mt.ZOOM,this.constraintOptions.interactionFactor=Ih(e.radius-this.beginRadius),Fr(this.view,this.currentCamera,this.constraintOptions)}_rotatePlanar(e){ne(this.rotationAxis,this.beginScenePoint),this.currentCamera.aboveGround||mo(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value;let i=e.angle-t;i=z9(i);const r=t+i,s=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=s,this.smoothRotation.update(r);const n=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(n,.001*e.timestamp),M0(this.currentCamera,this.sphere,cR(this.rotationAxis,n)),this.constraintOptions.interactionType=Mt.TUMBLE,this.constraintOptions.interactionFactor=Ih(e.radius*n),Fr(this.view,this.currentCamera,this.constraintOptions)}};u([d({constructOnly:!0})],v$.prototype,"view",void 0),v$=u([P("esri.views.3d.state.controllers.global.PinchAndPanController")],v$);const bte=je(0,0,1),HHe={ELEVATION_THRESHOLD:3e4,ANGLE_THRESHOLD:16/180*Math.PI},qHe=80;let _$=class extends P0{constructor(e){super(e),this.view=null,this.rotationValueSmooth=new UL(.05),this.scalingValueSmooth=new UL(.05),this.planeHorizontal=ii(),this.planeVertical=ii(),this.rotationMomentumEstimator=new s0e,this.panMomentumEstimator=new i0e(300,12,.9),this.zoomMomentumEstimator=new n0e,this.beginCenter=M(),this.tmpPoints=[],this.beginCenterScreen=Rr(),this.tmpCentroid3d=M(),this.tmpCentroid2d=Rr(),this.tmp2d=Rr(),this.constraintOptions={selection:Yi.ALL,interactionType:Mt.NONE,interactionFactor:0,interactionStartCamera:new wi,interactionDirection:null,tiltMode:en.TUMBLE}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panMomentumEstimator.enabled=t,this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.rotationValueSmooth.reset(),this.scalingValueSmooth.reset(),em(e.center,this.beginCenterScreen),Vue(bte,0,this.planeHorizontal);const i=M();this.intersectionHelper.intersectScreenFreePointFallback(this.beginCenterScreen,i);const r=M();mo(r,this.startCamera.viewForward);const s=M();ne(s,bte);const n=_e(r,s),o=Yh(n<0?-n:n);if(this.panMode=o>=HHe.ANGLE_THRESHOLD?yn.Horizontal:yn.Vertical,hV(this.planeHorizontal,this.planeHorizontal,i),this.startCamera.aboveGround||dV(this.planeHorizontal,this.planeHorizontal),this.panMode===yn.Vertical){ae(s,s,n),de(this.planeVertical,r,s),be(this.planeVertical,this.planeVertical),hV(this.planeVertical,this.planeVertical,i);const a=M(),l=M(),c=M();de(a,i,this.currentCamera.eye),be(a,a);const h=5*Math.max(Math.abs(this.view.camera.position.z),50),p=this.view._stage.renderView.getMinimalDepthForArea(this.view.getVoxelWasmPerSceneView(),this.beginCenterScreen[0],this.beginCenterScreen[1],this.view.state.camera,qHe),f=p?Math.min(p,h):h;ne(c,pe(l,this.currentCamera.eye,ae(l,a,f))),this.planeVertical[3]=-_e(this.planeVertical,c),this.computePlanePoints(e.pointers,this.planeVertical,this.startCamera,this.tmpPoints),nk(this.tmpPoints,this.beginCenter)}else this.computePlanePoints(e.pointers,this.planeHorizontal,this.startCamera,this.tmpPoints),nk(this.tmpPoints,this.beginCenter);this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this.panMode===yn.Horizontal?this.planeHorizontal:this.planeVertical,r=this.beginCenter;if(t){const s=this.beginRadius/e.radius,n=.001875*Math.min(Math.max(e.radius,40),120);this.scalingValueSmooth.gain=n,this.scalingValueSmooth.update(s),Qq(this.currentCamera,r,this.scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this.zoomMomentumEstimator.add(this.scalingValueSmooth.value,.001*e.timestamp),this.constraintOptions.interactionType=Mt.ZOOM,this.constraintOptions.interactionFactor=Ih(Math.abs(e.radius-this.beginRadius)),Fr(this.view,this.currentCamera,this.constraintOptions)}if(this.computePlanePoints(e.pointers,i,this.currentCamera,this.tmpPoints),nk(this.tmpPoints,this.tmpCentroid3d),em(e.center,this.tmpCentroid2d),Oye(this.currentCamera,r,this.tmpCentroid3d),this.panMomentumEstimator.add(this.tmpCentroid2d,this.tmpCentroid3d,.001*e.timestamp),this.constraintOptions.interactionType=Mt.PAN,this.constraintOptions.interactionFactor=Ih(this.beginCenterScreen,this.tmpCentroid2d),Fr(this.view,this.currentCamera,this.constraintOptions),t){const s=this.planeHorizontal,n=r,o=this.rotationValueSmooth.value,a=o+z9(e.angle-o),l=.00125*Math.min(Math.max(e.radius,40),120);this.rotationValueSmooth.gain=l,this.rotationValueSmooth.update(a);const c=this.rotationValueSmooth.value-this.beginAngle;this.rotationMomentumEstimator.add(c,.001*e.timestamp),M0(this.currentCamera,n,cR(s,c)),this.constraintOptions.interactionType=Mt.TUMBLE,this.constraintOptions.interactionFactor=Ih(Math.abs(e.radius*c)),Fr(this.view,this.currentCamera,this.constraintOptions)}}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return new Fx({view:this.view,momentum:t,zoomCenter:this.beginCenter});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new F_({view:this.view,momentum:i,center:this.beginCenter,axis:this.planeHorizontal});const r=this.panMomentumEstimator.evaluateMomentum();return r?new pC({view:this.view,momentum:r}):null}computePlanePoints(e,t,i,r){r.length=e.size;const s=this.tmp2d;let n=0;return e.forEach(o=>{s[0]=o.x,s[1]=o.y,r[n]===void 0&&(r[n]=M()),B9(t,i,s,r[n]),n+=1}),r}};u([d({constructOnly:!0})],_$.prototype,"view",void 0),_$=u([P("esri.views.3d.state.controllers.local.PinchAndPanController")],_$);class wte extends Yn{constructor(t,i,r){super(!0),this.view=t,this.pointerAction=i,this.lastEndTimestamp=0,this.lastTimestamp=0,this.registerIncoming("drag",r,s=>this._handleDrag(s))}_handleDrag(t){if(t.data.pointerType==="mouse"&&!eW(t.data,this.pointerAction))return;const i=t.timestamp-this.lastEndTimestamp,r=40,s=this.momentum&&this.momentum.active&&i<r;switch(t.data.action){case"start":case"update":if(s)break;this.controller&&this.controller.active?t.data.timestamp-this.lastTimestamp>2&&(this.controller.update(t.data),this.lastTimestamp=t.timestamp):this._startController(t);break;case"end":case"removed":this._endController(t,!0);break;case"added":this._endController(t,!1),this._startController(t)}t.stopPropagation()}_endController(t,i){if(this.controller&&this.controller.active){this.lastEndTimestamp=t.timestamp;const r=this.controller.end(t.data);i&&r&&(this.momentum=r,this.view.state.switchCameraController(this.momentum))}this.controller=null}_startController(t){this.controller=this._createController(),this.view.state.switchCameraController(this.controller),this.controller.begin(t.data),this.lastTimestamp=t.timestamp}_createController(){return this.view.state.isGlobal?new v$({view:this.view}):new _$({view:this.view})}}class WHe extends Yn{constructor(t,i){super(!0),this.view=t,this.registerIncoming("pointer-down",i,()=>this.view.state.stopActiveCameraController())}}class o0e extends Yn{constructor(t,i){super(!0),this.key=t,this.registerIncoming("key-down",i,r=>this._handleKeyDown(r))}_handleKeyDown(t){t.data.key===this.key&&(this.activate(),t.stopPropagation())}}class XHe extends o0e{constructor(t,i,r){super(i,r),this.view=t}activate(){this.view.goTo({heading:0}).catch(()=>{})}}class YHe extends o0e{constructor(t,i,r){super(i,r),this.view=t}activate(){this.view.goTo({tilt:0}).catch(()=>{})}}class ZHe extends Yn{constructor(t,i=!1){super(!0),this.view=t,this.invert=i,this.registerIncoming("vertical-two-finger-drag",r=>this._handleTwoFinger(r))}_handleTwoFinger(t){var i,r,s;const n=this.invert?-1:1,o=Rr(0,t.data.delta*n);switch(t.data.action){case"begin":(i=this.cameraController)==null||i.end(),this.cameraController=new Nx({view:this.view,pivot:Ja.CENTER}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(o);break;case"update":(r=this.cameraController)==null||r.update(o);break;case"end":(s=this.cameraController)==null||s.end(),this.cameraController=null}}}function xte(e){const t=e.native;return t?{buttons:t.buttons.map(i=>i.pressed?i.value?i.value:1:0),axes:t.axes.map(i=>KHe(i,e.axisThreshold))}:{buttons:[],axes:[]}}function QHe(e,t){if(e.axes.length!==t.axes.length||e.buttons.length!==t.buttons.length)return!1;for(let i=0;i<e.axes.length;i++)if(e.axes[i]!==t.axes[i])return!1;for(let i=0;i<e.buttons.length;i++)if(e.buttons[i]!==t.buttons[i])return!1;return!0}function JHe(e){for(let t=0;t<e.axes.length;t++)if(e.axes[t]!==0)return!1;for(let t=0;t<e.buttons.length;t++)if(e.buttons[t]!==0)return!1;return!0}function KHe(e,t){const i=Math.abs(e);return i<t?0:Math.sign(e)*(i-t)/(1-t)}class eqe{constructor(t,i){this.element=t,this.input=i,this._hasEventListeners=!1,this._onConnectGamepad=n=>{this._connectGamepad(n.gamepad)},this._onDisconnectGamepad=n=>{const o=n.gamepad,a=o.index,l=this.inputDevices[a];l&&(this._emitGamepadEvent(o,xte(l),!1),this.inputDevices.splice(a,1),this.latestUpdate.splice(a,1),this.input.gamepad.devices.remove(l),this.ensurePollingState())},this.frameTask=null,this.latestUpdate=new Array,this.inputDevices=new Array,this.callback=null;const r="getGamepads"in window.navigator,s=window.isSecureContext;this.supported=r&&s,this.supported&&(this._forEachGamepad(n=>this._connectGamepad(n)),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(t){this._hasEventListeners!==t&&(this._hasEventListeners=t,this.ensurePollingState())}get eventsEnabled(){return this.supported&&this.inputDevices.length>0&&this._hasEventListeners}set onEvent(t){this.callback=t}_connectGamepad(t){const i=new cq(t);i.deviceType!=="unknown"&&(this.inputDevices[t.index]=i,this.input.gamepad.devices.add(i)),this.ensurePollingState()}ensurePollingState(){this.eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){this.frameTask==null&&(this.frameTask=_1({update:()=>this._readGamepadState()}))}_stopPolling(){this.frameTask!=null&&(this.frameTask.remove(),this.frameTask=null,this.latestUpdate=new Array)}_readGamepadState(){const t=document.hasFocus(),i=this.element.contains(document.activeElement),r=this.input.gamepad.enabledFocusMode==="document"&&!t||this.input.gamepad.enabledFocusMode==="view"&&!i;this._forEachGamepad(s=>{const n=this.inputDevices[s.index];if(!n)return;const o=this.latestUpdate[s.index],a=xte(n),l=r||JHe(a);o&&(o.timestamp===s.timestamp||!o.active&&l||QHe(o.state,a))||this._emitGamepadEvent(s,a,!l)})}_forEachGamepad(t){const i=window.navigator.getGamepads();for(let r=0;r<i.length;r++){const s=i[r];this._validate(s)&&t(s)}}_emitGamepadEvent(t,i,r){const s=this.latestUpdate[t.index],n=s&&s.active;if(!n&&!r)return;const o=!n&&r?"start":n&&r?"update":"end";this.latestUpdate[t.index]={timestamp:t.timestamp,state:i,active:r},this.callback&&this.callback({device:this.inputDevices[t.index],state:i,action:o})}_validate(t){if(!t||!t.connected)return!1;for(let i=0;i<t.axes.length;i++)if(isNaN(t.axes[i]))return!1;return!0}}const Tte=ue("trident"),Ste=ue("edge"),tqe=ue("chrome"),iqe=ue("ff"),rqe=ue("safari"),zb={touchNone:"esri-view-surface--touch-none",touchPan:"esri-view-surface--touch-pan"};class r4{constructor(t,i){this.input=i,this._active={},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=t,t.getAttribute("tabindex")||t.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new eqe(t,this.input),this._gamepadSource.onEvent=r=>this._callback("gamepad",r)}destroy(){this._callback=null,this.activeEvents=null,this._activePointerCaptures.forEach(t=>{this._releasePointerCaptureSafe(t)}),this._gamepadSource&&(this._gamepadSource.destroy(),this._gamepadSource=null),this._activePointerCaptures=null,this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(t){this._browserTouchPanningEnabled=t,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(t){this._callback=t}set activeEvents(t){for(const i in this._active)if(!t||!t.has(i)){const r=this._active[i];this._element.removeEventListener(fk[i],r),delete this._active[i]}t&&t.forEach(i=>{if(!this._active[i]&&fk[i]){const r=(this._eventHandlers[i]||this._handleDefault).bind(this,i);this._element.addEventListener(fk[i],r),this._active[i]=r}}),this._gamepadSource.hasEventListeners=t&&t.has("gamepad")}setPointerCapture(t,i){i?(this._element.setPointerCapture(t.pointerId),this._activePointerCaptures.add(t.pointerId)):(this._releasePointerCaptureSafe(t.pointerId),this._activePointerCaptures.delete(t.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?zb.touchNone:zb.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?zb.touchPan:zb.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(zb.touchNone),this._element.classList.remove(zb.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_releasePointerCaptureSafe(t){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(t))return;this._element.releasePointerCapture(t)}catch{}}_updateNormalizedPointerLikeEvent(t,i){const r=Lme(this._element,t);return r4.test.disableSubpixelCoordinates&&(r.x=Math.round(r.x),r.y=Math.round(r.y)),i.x=r.x,i.y=r.y,i}_handleKey(t,i){const r=_6e(i);r&&t==="key-up"&&this._keyDownState.delete(r);const s={native:i,key:r,repeat:r&&this._keyDownState.has(r)};r&&t==="key-down"&&this._keyDownState.add(s.key),this._callback(t,s)}_handlePointer(t,i){const r=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,pointerType:i.pointerType,button:i.button,buttons:i.buttons,eventId:this._eventId++});this._callback(t,r)}_handlePointerPreventDefault(t,i){const r=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,pointerType:i.pointerType,button:i.button,buttons:i.buttons,eventId:this._eventId++});i.preventDefault(),this._callback(t,r)}_handleMouseWheel(t,i){let r=i.deltaY;switch(i.deltaMode){case 0:(Tte||Ste)&&(r=r/document.documentElement.clientHeight*600);break;case 1:r*=30;break;case 2:r*=900}Tte||Ste?r*=.7:tqe||rqe?r*=.6:iqe&&(r*=1.375);const s=100,n=Math.abs(r);n>s&&(r=r/n*200/(1+Math.exp(-.02*(n-s))));const o=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,deltaY:r});this._callback(t,o)}_handlePointerCaptureLost(t,i){this._activePointerCaptures.delete(i.pointerId),this._handleDefault(t,i)}_handleDefault(t,i){const r={native:i};i.preventDefault(),this._callback(t,r)}_preventAltKeyDefault(t){t.key==="Alt"&&t.preventDefault()}_preventMultiTouchPanning(t){t.touches.length>1&&t.preventDefault()}}r4.test={disableSubpixelCoordinates:!1};const fk={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};class sqe extends Yn{constructor(){super(!0),this.registerIncoming("context-menu",t=>{t.data.native.preventDefault()})}}function a0e(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}function nqe(e,t){const i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)}function oqe(e,t){if(t?(t.radius=0,t.center.x=0,t.center.y=0):t={radius:0,center:Jh()},e.length===0)return t;if(e.length===1)return t.center.x=e[0].x,t.center.y=e[0].y,t;if(e.length===2){const[T,A]=e,[C,O]=[A.x-T.x,A.y-T.y];return t.radius=Math.sqrt(C*C+O*O)/2,t.center.x=(T.x+A.x)/2,t.center.y=(T.y+A.y)/2,t}let i=0,r=0;for(let T=0;T<e.length;T++)i+=e[T].x,r+=e[T].y;i/=e.length,r/=e.length;const s=e.map(T=>T.x-i),n=e.map(T=>T.y-r);let o=0,a=0,l=0,c=0,h=0,p=0,f=0;for(let T=0;T<s.length;T++){const A=s[T],C=n[T],O=A*A,L=C*C;o+=O,a+=L,l+=A*C,c+=O*A,h+=L*C,p+=A*L,f+=C*O}const g=.5*(c+p),y=.5*(h+f),v=o*a-l*l,b=(g*a-y*l)/v,w=(o*y-l*g)/v,S=Jh(b+i,w+r);return{radius:Math.sqrt(b*b+w*w+(o+a)/e.length),center:S}}class aqe extends Yn{constructor(t){super(!1),this.navigationTouch=t,this.startStateModifiers=new Set,this.activePointerMap=new Map,this.isDragging=!1,this.isCurrentDragSuppressed=!1,this.drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(t,i,r,s){return{action:t,pointerType:this.pointerType,button:this.mouseButton,buttons:i.buttons,timestamp:s,pointers:lqe(this.activePointerMap),pointer:i,angle:r.angle,radius:r.radius,center:r.center}}_addPointer(t){const i=t.native.pointerId,r=O3(this.activePointerMap).angle,s={event:t,initialAngle:0,lastAngle:0};this.activePointerMap.set(i,s);const n=b$(s,l0e(this.activePointerMap));s.initialAngle=n,s.lastAngle=n,this._updatePointerAngles(r)}_updatePointer(t){if(t&&t.x==null&&t.y==null)return;const i=t.native.pointerId,r=this.activePointerMap.get(i);r?r.event=t:this._addPointer(t)}_removePointer(t){const i=O3(this.activePointerMap).angle;this.activePointerMap.delete(t),this._updatePointerAngles(i)}_updatePointerAngles(t){const i=O3(this.activePointerMap);this.activePointerMap.forEach(r=>{r.initialAngle=b$(r,i)-t,r.lastAngle=b$(r,i)-t})}_emitEvent(t,i,r){const s=O3(this.activePointerMap);this.drag.emit(this._createPayload(t,i,s,r),void 0,this.startStateModifiers)}_handlePointerUpAndPointerLost(t){const i=t.data.native.pointerId,r=t.timestamp;this.activePointerMap.get(i)&&(this.activePointerMap.size===1?(this._updatePointer(t.data),!this.isCurrentDragSuppressed&&this._emitEvent("end",t.data,r),this.isDragging=!1,this.isCurrentDragSuppressed=!1,this._removePointer(i)):(this._removePointer(i),this._emitEvent("removed",t.data,t.timestamp)))}_handlePointerDrag(t){const i=t.data,r=i.currentEvent,s=t.timestamp;switch(i.action){case"start":case"update":this.isDragging?this.activePointerMap.has(r.native.pointerId)?(this._updatePointer(r),!this.isCurrentDragSuppressed&&this._emitEvent("update",r,s)):(this._addPointer(r),this._emitEvent("added",r,s),this.isCurrentDragSuppressed=this.isSuppressed):(this._updatePointer(r),this.pointerType=t.data.startEvent.pointerType,this.mouseButton=t.data.startEvent.button,this.startStateModifiers=t.modifiers,this.isDragging=!0,this.isCurrentDragSuppressed=this.isSuppressed,!this.isCurrentDragSuppressed&&this._emitEvent("start",r,s))}}get isSuppressed(){return this.navigationTouch&&!this.navigationTouch.browserTouchPanEnabled&&this.pointerType==="touch"&&this.activePointerMap.size===1}}function l0e(e){const t=[];return e.forEach(i=>{t.push(Jh(i.event.x,i.event.y))}),oqe(t)}function O3(e){const t=l0e(e);let i=0;return e.forEach(r=>{let s=b$(r,t),n=s-r.lastAngle;for(;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;s=r.lastAngle+n,r.lastAngle=s,i+=s-r.initialAngle}),i/=e.size||1,{angle:i,radius:t.radius,center:t.center}}function lqe(e){const t=new Map;return e.forEach((i,r)=>t.set(r,i.event)),t}function b$(e,t){const i=e.event,r=i.x-t.center.x,s=i.y-t.center.y;return Math.atan2(s,r)}var Ete;(function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right",e[e.Back=3]="Back",e[e.Forward=4]="Forward",e[e.Undefined=-1]="Undefined"})(Ete||(Ete={}));const Jy={maximumDoubleClickDelay:250,maximumDoubleClickDistance:10,maximumDoubleTouchDelay:350,maximumDoubleTouchDistance:35};class cqe extends Yn{constructor(t=Jy.maximumDoubleClickDelay,i=Jy.maximumDoubleClickDistance,r=Jy.maximumDoubleTouchDelay,s=Jy.maximumDoubleTouchDistance,n=RN){super(!1),this.maximumDoubleClickDelay=t,this.maximumDoubleClickDistance=i,this.maximumDoubleTouchDelay=r,this.maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",this._handleImmediateClick.bind(this)),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("drag",this._handleDrag.bind(this))}onUninstall(){this._pointerState.forEach(t=>t.doubleClickTimeout=Js(t.doubleClickTimeout))}get hasPendingInputs(){return qr(this._pointerState,t=>t.doubleClickTimeout!=null)}_pointerId(t){const i=t.native;return i.pointerType==="mouse"?`${i.pointerId}:${i.button}`:`${i.pointerType}`}_handleImmediateClick(t){const i=t.data,r=this._pointerId(i),s=this._pointerState.get(r);if(s){const n=i.native.pointerType==="touch"?this.maximumDoubleTouchDistance:this.maximumDoubleClickDistance;a0e(s.event.data,i)>n?(this._clearDoubleClickTimeout(r,!0),this._startClick(t)):(this._clearDoubleClickTimeout(r,!1),this._doubleClick.emit(s.event.data,void 0,s.event.modifiers))}else this._startClick(t)}_startClick(t){const i=this._pointerId(t.data),r=t.data.native.pointerType==="touch"?this.maximumDoubleTouchDelay:this.maximumDoubleClickDelay;this._pointerState.set(i,{event:t,doubleClickTimeout:this._clock.setTimeout(()=>this._doubleClickTimeoutExceeded(i),r)}),this.refreshHasPendingInputs()}_handlePointerDrag(t){const i=this._pointerId(t.data.currentEvent);this._clearDoubleClickTimeout(i,!0)}_handleDrag(t){const i=this._pointerId(t.data.pointer);this._clearDoubleClickTimeout(i,!0)}_clearDoubleClickTimeout(t,i){const r=this._pointerState.get(t);r&&(r.doubleClickTimeout.remove(),r.doubleClickTimeout=null,i&&this._doubleClickTimeoutExceeded(t),this._pointerState.delete(t),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(t){const i=this._pointerState.get(t);this._click.emit(i.event.data,void 0,i.event.modifiers),i.doubleClickTimeout=null,this._pointerState.delete(t),this.refreshHasPendingInputs()}}class uqe extends Yn{constructor(t=Jy.maximumDoubleClickDelay,i=Jy.maximumDoubleClickDistance,r=Jy.maximumDoubleTouchDelay,s=Jy.maximumDoubleTouchDistance,n=RN){super(!1),this.maximumDoubleClickDelay=t,this.maximumDoubleClickDistance=i,this.maximumDoubleTouchDelay=r,this.maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",o=>{this._handlePointerLoss(o,"pointer-up")}),this.registerIncoming("pointer-capture-lost",o=>{this._handlePointerLoss(o,"pointer-capture-lost")}),this.registerIncoming("pointer-cancel",o=>{this._handlePointerLoss(o,"pointer-cancel")})}onUninstall(){this._pointerState.forEach(t=>{t.immediateDoubleClick&&t.immediateDoubleClick.timeoutHandle.remove()}),super.onUninstall()}_handlePointerDown(t){const i=t.data,r=this._pointerId(i);if(!this._pointerState.has(r)){const s={downButton:i.native.button,immediateDoubleClick:null};this._pointerState.set(r,s),this.startCapturingPointer(i.native)}}_handlePointerLoss(t,i){const r=t.data,s=this._pointerId(r),n=this._pointerState.get(s);if(n&&i==="pointer-up"&&n.downButton===r.native.button){const o=n.immediateDoubleClick;if(o){o.timeoutHandle.remove();const a=t.data.native.pointerType==="touch"?this.maximumDoubleTouchDistance:this.maximumDoubleClickDistance;a0e(o,t.data)>a?this._startImmediateDoubleClick(t,n):(this._immediateDoubleClick.emit(t.data,void 0,o.modifiers),this._removeState(r))}else this._startImmediateDoubleClick(t,n)}}_startImmediateDoubleClick(t,i){const r=t.data.native.pointerType==="touch"?this.maximumDoubleTouchDelay:this.maximumDoubleClickDelay;i.immediateDoubleClick={x:t.data.x,y:t.data.y,modifiers:t.modifiers,timeoutHandle:this._clock.setTimeout(()=>this._removeState(t.data),r)}}_pointerId(t){const i=t.native;return i.pointerType==="mouse"?`${i.pointerId}:${i.button}`:`${i.pointerType}`}_removeState(t){const i=this._pointerId(t);this._pointerState.delete(i),this.stopCapturingPointer(t.native),this.refreshHasPendingInputs()}}const z2={maximumClickDelay:300,movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500};class hqe extends Yn{constructor(t=z2.maximumClickDelay,i=z2.movementUntilMouseDrag,r=z2.movementUntilPenDrag,s=z2.movementUntilTouchDrag,n=z2.holdDelay,o=RN){super(!1),this.maximumClickDelay=t,this.movementUntilMouseDrag=i,this.movementUntilPenDrag=r,this.movementUntilTouchDrag=s,this.holdDelay=n,this._clock=o,this._pointerState=new Map,this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",a=>{this._handlePointerLoss(a,"pointer-up")}),this.registerIncoming("pointer-capture-lost",a=>{this._handlePointerLoss(a,"pointer-capture-lost")}),this.registerIncoming("pointer-cancel",a=>{this._handlePointerLoss(a,"pointer-cancel")}),this._moveHandle=this.registerIncoming("pointer-move",this._handlePointerMove.bind(this)),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach(t=>{t.holdTimeout!=null&&(t.holdTimeout.remove(),t.holdTimeout=null)}),super.onUninstall()}_handlePointerDown(t){const i=t.data,r=i.native.pointerId;let s=null;this._pointerState.size===0&&(s=this._clock.setTimeout(()=>{const o=this._pointerState.get(r);if(o){if(!o.isDragging){const a=o.previousEvent;this._pointerHold.emit(a,void 0,t.modifiers),o.holdEmitted=!0}o.holdTimeout=null}},this.holdDelay));const n={startEvent:i,previousEvent:i,startTimestamp:t.timestamp,isDragging:!1,downButton:i.native.button,holdTimeout:s,modifiers:new Set};this._pointerState.set(r,n),this.startCapturingPointer(i.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(t)}_createPointerDragData(t,i,r){return{action:t,startEvent:i.startEvent,previousEvent:i.previousEvent,currentEvent:r}}_handlePointerMove(t){const i=t.data,r=i.native.pointerId,s=this._pointerState.get(r);s&&(s.isDragging?this._pointerDrag.emit(this._createPointerDragData("update",s,i),void 0,s.modifiers):nqe(i,s.startEvent)>this._getDragThreshold(i.native.pointerType)&&this._startDragging(t),s.previousEvent=i)}_getDragThreshold(t){switch(t){case"touch":return this.movementUntilTouchDrag;case"pen":return this.movementUntilPenDrag;default:return this.movementUntilMouseDrag}}_startDragging(t){const i=t.data,r=i.native.pointerId;this._pointerState.forEach(s=>{s.holdTimeout!=null&&(s.holdTimeout.remove(),s.holdTimeout=null),s.isDragging||(s.modifiers=t.modifiers,s.isDragging=!0,r===s.startEvent.native.pointerId?this._pointerDrag.emit(this._createPointerDragData("start",s,i)):this._pointerDrag.emit(this._createPointerDragData("start",s,s.previousEvent),t.timestamp))})}_handlePointerLoss(t,i){const r=t.data,s=r.native.pointerId,n=this._pointerState.get(s);n&&(n.holdTimeout!=null&&(n.holdTimeout.remove(),n.holdTimeout=null),n.isDragging?this._pointerDrag.emit(this._createPointerDragData("end",n,i==="pointer-up"?r:n.previousEvent),void 0,n.modifiers):i==="pointer-up"&&n.downButton===r.native.button&&t.timestamp-n.startTimestamp<=this.maximumClickDelay&&!n.holdEmitted&&this._immediateClick.emit(r),this._pointerState.delete(s),this.stopCapturingPointer(r.native),this._pointerState.size===0&&this._moveHandle.pause())}}class dqe{constructor(t){this.callbacks=t,this.currentCount=0,this.callbacks.condition||(this.callbacks.condition=()=>!0)}handle(t){const i=t.data,r=i.pointers.size;switch(i.action){case"start":this.currentCount=r,this._emitStart(t);break;case"added":this._emitEnd(this.previousEvent),this.currentCount=r,this._emitStart(t);break;case"update":this._emitUpdate(t);break;case"removed":this.startEvent&&this._emitEnd(this.previousEvent),this.currentCount=r,this._emitStart(t);break;case"end":this._emitEnd(t),this.currentCount=0}this.previousEvent=t}_emitStart(t){this.startEvent=t,this.callbacks.condition(this.currentCount,t)&&this.callbacks.start(this.currentCount,t,this.startEvent)}_emitUpdate(t){this.callbacks.condition(this.currentCount,t)&&this.callbacks.update(this.currentCount,t,this.startEvent)}_emitEnd(t){this.callbacks.condition(this.currentCount,t)&&this.callbacks.end(this.currentCount,t,this.startEvent),this.startEvent=null}}class pqe extends Yn{constructor(t=20,i=40){super(!1),this._threshold=t,this._maxDelta=i,this.state="ready",this.emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this.dragEventSeparator=new dqe({start:(r,s)=>this._observeStart(r,s),update:(r,s,n)=>this._observeUpdate(r,s,n),end:(r,s)=>this._observeEnd(s)}),this.registerIncoming("drag",r=>this.dragEventSeparator.handle(r))}get failed(){return this.state==="failed"}_observeStart(t,i){t===1&&this.emittedArtificalEnd2&&(this.emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:i.data.button,buttons:i.data.buttons,pointerType:i.data.pointerType,timestamp:i.data.timestamp,pointers:i.data.pointers,pointer:i.data.pointer,angle:i.data.angle,radius:i.data.radius,center:i.data.center}),i.stopPropagation()),this.state=t===2?"ready":"failed"}_observeUpdate(t,i,r){if(this.state!=="failed"&&t===2)return this.state==="active"?(this._vertical.emit({delta:i.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void i.stopPropagation()):void(this._checkMovementWithinLimits(i.data,r.data)?this._checkVerticalThresholdReached(i.data,r.data)&&(this.state="active",this.emittedArtificalEnd2=!0,this._thresholdReachedCenter=i.data.center,this._artificalDrag.emit({action:"end",button:i.data.button,buttons:i.data.buttons,pointerType:i.data.pointerType,timestamp:i.data.timestamp,pointers:i.data.pointers,pointer:i.data.pointer,angle:i.data.angle,radius:i.data.radius,center:i.data.center}),this._vertical.emit({delta:i.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),i.stopPropagation()):this.state="failed")}_observeEnd(t){this.state==="active"&&(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this.state="ready",t.stopPropagation())}_checkMovementWithinLimits(t,i){let r=-1/0,s=1/0,n=-1/0,o=1/0;i.pointers.forEach(v=>{r=Math.max(r,v.x),s=Math.min(s,v.x),n=Math.max(n,v.y),o=Math.min(o,v.y)});let a=-1/0,l=1/0,c=-1/0,h=1/0;t.pointers.forEach(v=>{a=Math.max(a,v.x),l=Math.min(l,v.x),c=Math.max(c,v.y),h=Math.min(h,v.y)});const p=r-s,f=n-o,g=a-l,y=c-h;return Math.abs(t.center.x-i.center.x)<this._threshold&&Math.abs(g-p)<=this._maxDelta&&Math.abs(y-f)<=this._maxDelta}_checkVerticalThresholdReached(t,i){let r=Math.abs(t.center.y-i.center.y);return t.pointers.forEach((s,n)=>{const o=i.pointers.get(n);r=Math.min(r,Math.abs(s.y-o.y))}),r>=this._threshold}}let Df=class extends we{constructor(){super(...arguments),this._handles=new Ut}destroy(){this._handles&&(this._handles.removeAll(),this._handles=null),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){e!=="pan"&&e!=="rotate"||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){e!=="default"&&e!=="pro"||e===this._get("mode")||(this._set("mode",e),this._updateMode())}disconnect(){this.view.viewEvents.disconnect(),this._inputManager&&(this._inputManager.destroy(),this._inputManager=null),this._source&&(this._source.destroy(),this._source=null)}connect(){const e=this.view;this._source=new r4(this.view.surface,e.input);const t=[new uqe,new hqe,new cqe,new aqe(this.view.navigation),new pqe],i=new n_({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new sqe],a0.INTERNAL),this._modeDragPan=new wte(e,"primary"),this._modeDragRotate=new uk(e,"secondary",Ja.CENTER),this._modeDragZoom=new tHe(e,"tertiary");const r={lookAround:"b",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},resetHeading:"n",resetTilt:"p"};i.installHandlers("navigation",[new WHe(e),new Kje(e),new FHe(e),new UHe(e,r.pan),new kHe(e),new YHe(e,r.resetTilt),new XHe(e,r.resetHeading),new uk(e,"primary",Ja.EYE,[r.lookAround]),new uk(e,"secondary",Ja.CENTER,[r.lookAround]),new wte(e,"tertiary",[r.lookAround]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new ZHe(e)],a0.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),Wt(this.view.navigation,"browserTouchPanEnabled",s=>{this._source.browserTouchPanningEnabled=!s})}_updateMode(){const e=this.mode,t=this.primaryDragAction,i=j9.get(e).get(t);this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom)}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};u([d()],Df.prototype,"view",void 0),u([d({value:"pan"})],Df.prototype,"primaryDragAction",null),u([d({value:"default"})],Df.prototype,"mode",null),u([d({readOnly:!0,aliasOf:"_inputManager.hasPendingInputs"})],Df.prototype,"hasPendingInputs",void 0),u([d({readOnly:!0,aliasOf:"_inputManager.latestPointerType"})],Df.prototype,"latestPointerType",void 0),u([d()],Df.prototype,"_inputManager",void 0),Df=u([P("esri.views.3d.input.SceneInputManager")],Df);const j9=new Map,mk=new Map,gk=new Map;mk.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),mk.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),gk.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),gk.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),j9.set("default",mk),j9.set("pro",gk);const fqe=Df;let ar=class extends we{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.SCENEVIEW_LOCKING_LOG=!1,this.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,this.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.TEXT_SHOW_BASELINE=!1,this.TEXT_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,this.LINE_WIREFRAMES=!1}};u([d()],ar.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),u([d()],ar.prototype,"SCENEVIEW_LOCKING_LOG",void 0),u([d()],ar.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),u([d()],ar.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),u([d()],ar.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),u([d()],ar.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),u([d()],ar.prototype,"DECONFLICTOR_SHOW_GRID",void 0),u([d()],ar.prototype,"LABELS_SHOW_BORDER",void 0),u([d()],ar.prototype,"TEXT_SHOW_BASELINE",void 0),u([d()],ar.prototype,"TEXT_SHOW_BORDER",void 0),u([d()],ar.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),u([d()],ar.prototype,"OVERLAY_SHOW_CENTER",void 0),u([d()],ar.prototype,"SHOW_POI",void 0),u([d()],ar.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),u([d()],ar.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),u([d()],ar.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),u([d()],ar.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),u([d()],ar.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),u([d()],ar.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),u([d()],ar.prototype,"I3S_TREE_SHOW_TILES",void 0),u([d()],ar.prototype,"I3S_SHOW_MODIFICATIONS",void 0),u([d()],ar.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),u([d()],ar.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),u([d()],ar.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),u([d()],ar.prototype,"LINE_WIREFRAMES",void 0),ar=u([P("esri.views.3d.support.DebugFlags")],ar);const hi=new ar;let Yl,oT,H9=!1,q9=!1,W9=!1,X9=!1,fC=null;function mqe(e,t){if(!q9||!oT)return;c0e();const i=oT;let r=0;for(let s=0;s<e.accBinsNumX;s++)for(let n=0;n<e.accBinsNumY;n++){const o=e.accBins[s][e.accBinsNumY-1-n];r+=o.length;const a=s*e.accBinsSizeX,l=(s+1)*e.accBinsSizeX,c=n*e.accBinsSizeY,h=(n+1)*e.accBinsSizeY;i.fillText(o.length.toFixed(),a+5,c+15),u0e(a,l,c,h,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.size,70,50),i.fillText("total numTests: "+e.accNumTests,70,30)}function gqe(e){W9=hi.DECONFLICTOR_SHOW_VISIBLE,X9=hi.DECONFLICTOR_SHOW_INVISIBLE,H9=W9||X9,q9=hi.DECONFLICTOR_SHOW_GRID,fC=null,H9||q9?fC=()=>yqe(e):Yl&&(Yl.parentElement.removeChild(Yl),Yl=null)}function c0e(){fC&&(fC(),fC=null)}function yqe(e){Yl==null&&(Yl=document.createElement("canvas"),Yl.setAttribute("id","canvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(Yl));const t=e.width*e.pixelRatio,i=e.height*e.pixelRatio;Yl.setAttribute("width",`${t}px`),Yl.setAttribute("height",`${i}px`),Yl.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${e.width}px;height:${e.height}px`),oT=Yl.getContext("2d"),oT.clearRect(0,0,e.width,e.height),oT.font="12px Arial"}function u0e(e,t,i,r,s){c0e();const n=Yl.height,o=oT;o.beginPath(),o.lineWidth=1,o.strokeStyle=s,o.moveTo(e,n-i),o.lineTo(t,n-i),o.stroke(),o.lineTo(t,n-r),o.stroke(),o.lineTo(t,n-i),o.stroke(),o.lineTo(e,n-i),o.stroke(),o.lineTo(e,n-i),o.stroke(),o.closePath()}function vqe(e,t){H9&&(t&&W9||!t&&X9)&&u0e(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}var mn,ac;(function(e){e[e.GRAPHIC=0]="GRAPHIC",e[e.LABEL=1]="LABEL",e[e._COUNT=2]="_COUNT"})(mn||(mn={})),function(e){e[e.USER_SETTING=0]="USER_SETTING",e[e.SCALE_RANGE=1]="SCALE_RANGE",e[e.FILTER=2]="FILTER",e[e.DECONFLICTION=3]="DECONFLICTION",e[e._COUNT=4]="_COUNT"}(ac||(ac={}));function h0e(e,t){return new s4(e,m0e,t)}function _qe(e,t){const{curvatureDependent:i,scaleStart:r,scaleFallOffRange:s}=m0e;return new s4(e,{curvatureDependent:{min:{curvature:i.min.curvature,tiltAngle:i.min.tiltAngle,scaleFallOffFactor:yk.curvatureDependent.min.scaleFallOffFactor},max:{curvature:i.max.curvature,tiltAngle:i.max.tiltAngle,scaleFallOffFactor:yk.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:s,minPixelSize:yk.minPixelSize},t)}function bqe(e){return Math.abs(e*e*e)}function d0e(e,t,i){const r=i.parameters,s=i.paddingPixelsOverride;return B2.scale=Math.min(r.divisor/(t-r.offset),1),B2.factor=bqe(e),B2.minPixelSize=r.minPixelSize,B2.paddingPixels=s,B2}function p0e(e,t){return e===0?t.minPixelSize:t.minPixelSize*(1+2*t.paddingPixels/e)}function sW(e,t){return Math.max(qt(e*t.scale,e,t.factor),p0e(e,t))}function wqe(e,t,i){const r=d0e(e,t,i);return r.minPixelSize=0,r.paddingPixels=0,sW(1,r)}function Ate(e,t,i,r){r.scale=wqe(e,t,i),r.factor=0,r.minPixelSize=i.parameters.minPixelSize,r.paddingPixels=i.paddingPixelsOverride}function f0e(e,t,i=[0,0]){const r=Math.min(Math.max(t.scale,p0e(e[1],t)/Math.max(1e-5,e[1])),1);return i[0]=e[0]*r,i[1]=e[1]*r,i}function xqe(e,t,i,r){return sW(e,d0e(t,i,r))}class s4{constructor(t,i,r,s=Tqe(),n){this.viewingMode=t,this.description=i,this.ellipsoidRadius=r,this.parameters=s,this._paddingPixelsOverride=n,this.viewingMode===Ie.Local?(this.coverageCompensation=this._surfaceCoverageCompensationLocal,this.calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this.coverageCompensation=this._surfaceCoverageCompensationGlobal,this.calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}get paddingPixelsOverride(){return this._paddingPixelsOverride||this.parameters.paddingPixels}update(t){return(!this.parameters||this.parameters.camera.fovY!==t.fovY||this.parameters.camera.distance!==t.distance)&&(this._calculateParameters(t,this.ellipsoidRadius,this.parameters),!0)}overridePadding(t){return t!==this.paddingPixelsOverride?new s4(this.viewingMode,this.description,this.ellipsoidRadius,this.parameters,t):this}_calculateParameters(t,i,r){const{scaleStart:s,scaleFallOffRange:n,minPixelSize:o}=this.description,{fovY:a,distance:l}=t,c=this.calculateCurvatureDependentParameters(t,i),h=this.coverageCompensation(t,i,c),{tiltAngle:p,scaleFallOffFactor:f}=c,g=Math.sin(p)*l,y=.5*Math.PI-p-a*(.5-s*h),v=g/Math.cos(y),b=y+a*n*h,w=(v-f*(g/Math.cos(b)))/(1-f);return r.camera.fovY=t.fovY,r.camera.distance=t.distance,r.offset=w,r.divisor=v-w,r.minPixelSize=o,r}_calculateCurvatureDependentParametersLocal(t,i,r=Cte){return r.tiltAngle=this.description.curvatureDependent.min.tiltAngle,r.scaleFallOffFactor=this.description.curvatureDependent.min.scaleFallOffFactor,r}_calculateCurvatureDependentParametersGlobal(t,i,r=Cte){const s=this.description.curvatureDependent,n=1+t.distance/i,o=Math.sqrt(n*n-1),[a,l]=[s.min.curvature,s.max.curvature],c=Be((o-a)/(l-a),0,1),[h,p]=[s.min,s.max];return r.tiltAngle=qt(h.tiltAngle,p.tiltAngle,c),r.scaleFallOffFactor=qt(h.scaleFallOffFactor,p.scaleFallOffFactor,c),r}_surfaceCoverageCompensationLocal(t,i,r){return(t.fovY-r.tiltAngle)/t.fovY}_surfaceCoverageCompensationGlobal(t,i,r){const s=i*i,n=r.tiltAngle+.5*Math.PI,{fovY:o,distance:a}=t,l=a*a+s-2*Math.cos(n)*a*i,c=Math.sqrt(l),h=Math.sqrt(l-s);return(Math.acos(h/c)-Math.asin(i/(c/Math.sin(n)))+.5*o)/o}}const m0e={curvatureDependent:{min:{curvature:Rt(10),tiltAngle:Rt(12),scaleFallOffFactor:.5},max:{curvature:Rt(70),tiltAngle:Rt(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},yk={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14};function Tqe(){return{camera:{distance:0,fovY:0},divisor:0,offset:0,minPixelSize:0,paddingPixels:0}}const B2={scale:0,factor:0,minPixelSize:0,paddingPixels:0},Cte={tiltAngle:0,scaleFallOffFactor:0};function Sqe(e){return e instanceof Float32Array&&e.length>=16}function Eqe(e){return Array.isArray(e)&&e.length>=16}function Aqe(e){return Sqe(e)||Eqe(e)}var j;(function(e){e[e.Color=0]="Color",e[e.Depth=1]="Depth",e[e.Normal=2]="Normal",e[e.Shadow=3]="Shadow",e[e.Highlight=4]="Highlight",e[e.Draped=5]="Draped",e[e.Occlusion=6]="Occlusion",e[e.Alpha=7]="Alpha",e[e.COUNT=8]="COUNT"})(j||(j={}));var hu;(function(e){e[e.OCCLUDED=0]="OCCLUDED",e[e.NOTOCCLUDED=1]="NOTOCCLUDED",e[e.BOTH=2]="BOTH",e[e.COUNT=3]="COUNT"})(hu||(hu={}));const M3=cs();function n4(e,t,i,r,s,n,o){if(!IO(t))if(e.boundingInfo){at(e.primitiveType===Aa.Triangle);const a=i.tolerance;g0e(e.boundingInfo,r,s,a,n,o)}else{const a=e.indices.get(E.POSITION),l=e.vertexAttributes.get(E.POSITION);LO(r,s,0,a.length/3,a,l,void 0,n,o)}}const Cqe=M();function g0e(e,t,i,r,s,n){if(R(e))return;const o=v0e(t,i,Cqe);if(Lle(M3,e.getBBMin()),Nle(M3,e.getBBMax()),_(s)&&s.applyToAabb(M3),nW(M3,t,o,r)){const{primitiveIndices:a,indices:l,position:c}=e,h=a?a.length:l.length/3;if(h>Iqe){const p=e.getChildren();if(p!==void 0){for(let f=0;f<8;++f)p[f]!==void 0&&g0e(p[f],t,i,r,s,n);return}}LO(t,i,0,h,l,c,a,s,n)}}const y0e=M();function LO(e,t,i,r,s,n,o,a,l){if(o)return Rqe(e,t,i,r,s,n,o,a,l);const c=n.data,h=n.stride||n.size,p=e[0],f=e[1],g=e[2],y=t[0]-p,v=t[1]-f,b=t[2]-g;for(let w=i,S=3*i;w<r;++w){let T=h*s[S++],A=c[T++],C=c[T++],O=c[T];T=h*s[S++];let L=c[T++],U=c[T++],N=c[T];T=h*s[S++];let z=c[T++],V=c[T++],B=c[T];_(a)&&([A,C,O]=a.applyToVertex(A,C,O,w),[L,U,N]=a.applyToVertex(L,U,N,w),[z,V,B]=a.applyToVertex(z,V,B,w));const J=L-A,Q=U-C,te=N-O,ie=z-A,$=V-C,F=B-O,k=v*F-$*b,G=b*ie-F*y,W=y*$-ie*v,K=J*k+Q*G+te*W;if(Math.abs(K)<=Number.EPSILON)continue;const H=p-A,ee=f-C,ye=g-O,Ae=H*k+ee*G+ye*W;if(K>0){if(Ae<0||Ae>K)continue}else if(Ae>0||Ae<K)continue;const Ve=ee*te-Q*ye,Se=ye*J-te*H,xe=H*Q-J*ee,Re=y*Ve+v*Se+b*xe;if(K>0){if(Re<0||Ae+Re>K)continue}else if(Re>0||Ae+Re<K)continue;const ze=(ie*Ve+$*Se+F*xe)/K;ze>=0&&l(ze,NO(J,Q,te,ie,$,F,y0e),w,!1)}}function Rqe(e,t,i,r,s,n,o,a,l){const c=n.data,h=n.stride||n.size,p=e[0],f=e[1],g=e[2],y=t[0]-p,v=t[1]-f,b=t[2]-g;for(let w=i;w<r;++w){const S=o[w];let T=3*S,A=h*s[T++],C=c[A++],O=c[A++],L=c[A];A=h*s[T++];let U=c[A++],N=c[A++],z=c[A];A=h*s[T];let V=c[A++],B=c[A++],J=c[A];_(a)&&([C,O,L]=a.applyToVertex(C,O,L,w),[U,N,z]=a.applyToVertex(U,N,z,w),[V,B,J]=a.applyToVertex(V,B,J,w));const Q=U-C,te=N-O,ie=z-L,$=V-C,F=B-O,k=J-L,G=v*k-F*b,W=b*$-k*y,K=y*F-$*v,H=Q*G+te*W+ie*K;if(Math.abs(H)<=Number.EPSILON)continue;const ee=p-C,ye=f-O,Ae=g-L,Ve=ee*G+ye*W+Ae*K;if(H>0){if(Ve<0||Ve>H)continue}else if(Ve>0||Ve<H)continue;const Se=ye*ie-te*Ae,xe=Ae*Q-ie*ee,Re=ee*te-Q*ye,ze=y*Se+v*xe+b*Re;if(H>0){if(ze<0||Ve+ze>H)continue}else if(ze>0||Ve+ze<H)continue;const ji=($*Se+F*xe+k*Re)/H;ji>=0&&l(ji,NO(Q,te,ie,$,F,k,y0e),S,!1)}}const Rte=M(),Ote=M();function NO(e,t,i,r,s,n,o){return oe(Rte,e,t,i),oe(Ote,r,s,n),pt(o,Rte,Ote),be(o,o),o}function v0e(e,t,i){return oe(i,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function nW(e,t,i,r){return oW(e,t,i,r,1/0)}function oW(e,t,i,r,s){const n=(e[0]-r-t[0])*i[0],o=(e[3]+r-t[0])*i[0];let a=Math.min(n,o),l=Math.max(n,o);const c=(e[1]-r-t[1])*i[1],h=(e[4]+r-t[1])*i[1];if(l=Math.min(l,Math.max(c,h)),l<0||(a=Math.max(a,Math.min(c,h)),a>l))return!1;const p=(e[2]-r-t[2])*i[2],f=(e[5]+r-t[2])*i[2];return l=Math.min(l,Math.max(p,f)),!(l<0)&&(a=Math.max(a,Math.min(p,f)),!(a>l)&&a<s)}function _0e(e,t,i,r,s){let n=(i.screenLength||0)*e.pixelRatio;s&&(n=xqe(n,r,t,s));const o=n*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return Be(o*t,i.minWorldLength||0,i.maxWorldLength!=null?i.maxWorldLength:1/0)}function MR(e,t,i){if(!e)return;const r=e.parameters,s=e.paddingPixelsOverride;t.setUniform4f(i,r.divisor,r.offset,r.minPixelSize,s)}function b0e(e,t){const i=t?b0e(t):{};for(const r in e){let s=e[r];s&&s.forEach&&(s=Pqe(s)),s==null&&r in i||(i[r]=s)}return i}function Oqe(e,t){let i=!1;for(const r in t){const s=t[r];s!==void 0&&(i=!0,Array.isArray(s)?e[r]=s.slice():e[r]=s)}return i}function Mqe(e,t,i,r,s,n){if(!t.options.selectionMode)return;const o=e.vertexAttributes.get(E.POSITION).data,a=e.vertexAttributes.get(E.SIZE),l=a&&a.data[0],c=r[0],h=r[1],p=((l+s)/2+4)*e.screenToWorldRatio;let f=Number.MAX_VALUE,g=0;for(let y=0;y<o.length-5;y+=3){const v=o[y],b=o[y+1],w=c-v,S=h-b,T=o[y+3]-v,A=o[y+4]-b,C=Be((T*w+A*S)/(T*T+A*A),0,1),O=T*C-w,L=A*C-S,U=O*O+L*L;U<f&&(f=U,g=y/3)}f<p*p&&n(i.dist,i.normal,g,!1)}function Pqe(e){const t=[];return e.forEach(i=>t.push(i)),t}const Y9={multiply:1,ignore:2,replace:3,tint:4},Iqe=1e3;function aW(e){e.vertex.code.add(x`float screenSizePerspectiveMinSize(float size, vec4 factor) {
float nonZeroSize = 1.0 - step(size, 0.0);
return (
factor.z * (
1.0 +
nonZeroSize *
2.0 * factor.w / (
size + (1.0 - nonZeroSize)
)
)
);
}`),e.vertex.code.add(x`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),e.vertex.code.add(x`vec4 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec4 params) {
return vec4(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z,
params.w
);
}`),e.vertex.code.add(x`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec4 factor) {
return max(mix(size * factor.x, size, factor.y), screenSizePerspectiveMinSize(size, factor));
}`),e.vertex.code.add(x`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),e.vertex.code.add(x`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec4 factor) {
return mix(size * clamp(factor.x, screenSizePerspectiveMinSize(size.y, factor) / max(1e-5, size.y), 1.0), size, factor.y);
}`),e.vertex.code.add(x`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)}function $qe(e,t){if(t.screenSizePerspective){MR(t.screenSizePerspective,e,"screenSizePerspective");const i=t.screenSizePerspectiveAlignment||t.screenSizePerspective;MR(i,e,"screenSizePerspectiveAlignment")}}var hl;function w0e(e,t){const i=e;i.include(aW),i.attributes.add(E.POSITION,"vec3"),i.attributes.add(E.NORMAL,"vec3"),i.attributes.add(E.AUXPOS1,"vec4"),i.vertex.uniforms.add("proj","mat4"),i.vertex.uniforms.add("view","mat4"),i.vertex.uniforms.add("viewNormal","mat4"),i.vertex.uniforms.add("viewport","vec4"),i.vertex.uniforms.add("cameraPosition","vec3"),i.vertex.uniforms.add("polygonOffset","float"),i.vertex.uniforms.add("cameraGroundRelative","float"),i.vertex.uniforms.add("pixelRatio","float"),i.vertex.uniforms.add("perDistancePixelRatio","float"),i.vertex.uniforms.add("renderTransparentlyOccludedHUD","float"),t.verticalOffsetEnabled&&i.vertex.uniforms.add("verticalOffset","vec4"),t.screenSizePerspectiveEnabled&&i.vertex.uniforms.add("screenSizePerspectiveAlignment","vec4"),i.vertex.uniforms.add("hudVisibilityTexture","sampler2D"),i.vertex.constants.add("smallOffsetAngle","float",.984807753012208),i.vertex.code.add(x`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),i.vertex.code.add(x`float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
float pointGroundSign = sign(pointGroundDistance);
if (pointGroundSign == 0.0) {
pointGroundSign = cameraGroundRelative;
}
float groundRelative = cameraGroundRelative * pointGroundSign;
if (polygonOffset > .0) {
float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
float factor = (1.0 - tanAlpha / viewport[2]);
if (groundRelative > 0.0) {
posView *= factor;
}
else {
posView /= factor;
}
}
return groundRelative;
}`),t.isDraped||i.vertex.code.add(x`void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
float distanceToCamera = length(posView);
float pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;
vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;
vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
posModel += modelOffset;
posView += viewOffset;
}`),i.vertex.code.add(x`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offsetting
      // of labels with respect to objects. It also pulls the label towards the viewer
      // so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${t.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${t.screenSizePerspectiveEnabled&&(t.verticalOffsetEnabled||t.screenCenterOffsetUnitsEnabled===hl.Screen)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${t.verticalOffsetEnabled?t.screenSizePerspectiveEnabled?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${t.verticalOffsetEnabled?x`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${t.screenCenterOffsetUnitsEnabled!==hl.Screen?x`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `:""}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${t.screenCenterOffsetUnitsEnabled===hl.Screen?t.screenSizePerspectiveEnabled?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${t.screenCenterOffsetUnitsEnabled===hl.Screen?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `),i.vertex.code.add(x`bool testVisibilityHUD(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}function x0e(e,t){e.setUniform1f("renderTransparentlyOccludedHUD",t.renderTransparentlyOccludedHUD===hu.OCCLUDED?1:t.renderTransparentlyOccludedHUD===hu.NOTOCCLUDED?0:.75)}(function(e){e[e.World=0]="World",e[e.Screen=1]="Screen",e[e.COUNT=2]="COUNT"})(hl||(hl={}));class Zm{constructor(t){this._material=t.material,this._techniqueRep=t.techniqueRep,this._output=t.output}dispose(){this._techniqueRep.release(this._technique)}get technique(){return this._technique}ensureTechnique(t,i,r=this._output){return this._technique=this._techniqueRep.releaseAndAcquire(t,this._material.getTechniqueConfig(r,i),this._technique),this._technique}ensureResources(t){return ma.LOADED}}class lW extends Zm{constructor(t){super(t),this._numLoading=0,this._disposed=!1,this._textureRepository=t.textureRep,this._textureId=t.textureId,this._acquire(t.textureId,i=>this._texture=i),this._acquire(t.normalTextureId,i=>this._textureNormal=i),this._acquire(t.emissiveTextureId,i=>this._textureEmissive=i),this._acquire(t.occlusionTextureId,i=>this._textureOcclusion=i),this._acquire(t.metallicRoughnessTextureId,i=>this._textureMetallicRoughness=i)}dispose(){this._texture=Xi(this._texture),this._textureNormal=Xi(this._textureNormal),this._textureEmissive=Xi(this._textureEmissive),this._textureOcclusion=Xi(this._textureOcclusion),this._textureMetallicRoughness=Xi(this._textureMetallicRoughness),this._disposed=!0}ensureResources(t){return this._numLoading===0?ma.LOADED:ma.LOADING}updateTexture(t){(R(this._texture)||t!==this._texture.id)&&(this._texture=Xi(this._texture),this._textureId=t,this._acquire(this._textureId,i=>this._texture=i))}bindTextures(t){_(this._texture)&&t.bindTexture(this._texture.glTexture,"tex"),_(this._textureNormal)&&t.bindTexture(this._textureNormal.glTexture,"normalTexture"),_(this._textureEmissive)&&t.bindTexture(this._textureEmissive.glTexture,"texEmission"),_(this._textureOcclusion)&&t.bindTexture(this._textureOcclusion.glTexture,"texOcclusion"),_(this._textureMetallicRoughness)&&t.bindTexture(this._textureMetallicRoughness.glTexture,"texMetallicRoughness")}bindTextureScale(t){const i=_(this._texture)?this._texture.glTexture:null;_(i)&&i.descriptor.textureCoordinateScaleFactor?t.setUniform2fv("textureCoordinateScaleFactor",i.descriptor.textureCoordinateScaleFactor):t.setUniform2f("textureCoordinateScaleFactor",1,1)}_acquire(t,i){if(R(t))return void i(null);const r=this._textureRepository.acquire(t);if(Cc(r))return++this._numLoading,void r.then(s=>{if(this._disposed)return Xi(s),void i(null);i(s)}).finally(()=>--this._numLoading);i(r)}}class od extends PO{constructor(t,i){super(),this.type=rd.Material,this.supportsEdges=!1,this._visible=!0,this._renderPriority=0,this._insertOrder=0,this._vertexAttributeLocations=mi,this._parameters=b0e(t,i),this.validateParameters(this._parameters)}dispose(){}get parameters(){return this._parameters}update(t){return!1}setParameters(t){Oqe(this._parameters,t)&&(this.validateParameters(this._parameters),this.parametersChanged())}validateParameters(t){}get visible(){return this._visible}set visible(t){t!==this._visible&&(this._visible=t,this.parametersChanged())}shouldRender(t){return this.isVisible()&&this.isVisibleInPass(t.pass)&&(this.renderOccluded&t.renderOccludedMask)!=0}isVisibleInPass(t){return!0}get renderOccluded(){return this.parameters.renderOccluded}get renderPriority(){return this._renderPriority}set renderPriority(t){t!==this._renderPriority&&(this._renderPriority=t,this.parametersChanged())}get insertOrder(){return this._insertOrder}set insertOrder(t){t!==this._insertOrder&&(this._insertOrder=t,this.parametersChanged())}get vertexAttributeLocations(){return this._vertexAttributeLocations}isVisible(){return this._visible}parametersChanged(){_(this.repository)&&this.repository.materialChanged(this)}}var Cr;(function(e){e[e.Occlude=1]="Occlude",e[e.Transparent=2]="Transparent",e[e.OccludeAndTransparent=4]="OccludeAndTransparent",e[e.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",e[e.Opaque=16]="Opaque"})(Cr||(Cr={}));const ju={renderOccluded:Cr.Occlude};function Dqe(e,t,i,r,s=1){const n=i.typedBuffer,o=i.typedBufferStride,a=e.length;if(r*=o,s===1)for(let l=0;l<a;++l)n[r]=t[e[l]],r+=o;else for(let l=0;l<a;++l){const c=t[e[l]];for(let h=0;h<s;h++)n[r]=c,r+=o}}function Lqe(e,t,i,r){const s=i.typedBuffer,n=i.typedBufferStride,o=e.length;r*=n;for(let a=0;a<o;++a){const l=2*e[a];s[r]=t[l],s[r+1]=t[l+1],r+=n}}function T0e(e,t,i,r,s){const n=i.typedBuffer,o=i.typedBufferStride,a=e.length;if(r*=o,s==null||s===1)for(let l=0;l<a;++l){const c=3*e[l];n[r]=t[c],n[r+1]=t[c+1],n[r+2]=t[c+2],r+=o}else for(let l=0;l<a;++l){const c=3*e[l];for(let h=0;h<s;++h)n[r]=t[c],n[r+1]=t[c+1],n[r+2]=t[c+2],r+=o}}function xS(e,t,i,r,s=1){const n=i.typedBuffer,o=i.typedBufferStride,a=e.length;if(r*=o,s===1)for(let l=0;l<a;++l){const c=4*e[l];n[r]=t[c],n[r+1]=t[c+1],n[r+2]=t[c+2],n[r+3]=t[c+3],r+=o}else for(let l=0;l<a;++l){const c=4*e[l];for(let h=0;h<s;++h)n[r]=t[c],n[r+1]=t[c+1],n[r+2]=t[c+2],n[r+3]=t[c+3],r+=o}}function FO(e,t,i,r,s,n=1){if(!i)return void T0e(e,t,r,s,n);const o=r.typedBuffer,a=r.typedBufferStride,l=e.length,c=i[0],h=i[1],p=i[2],f=i[4],g=i[5],y=i[6],v=i[8],b=i[9],w=i[10],S=i[12],T=i[13],A=i[14];if(s*=a,n===1)for(let C=0;C<l;++C){const O=3*e[C],L=t[O],U=t[O+1],N=t[O+2];o[s]=c*L+f*U+v*N+S,o[s+1]=h*L+g*U+b*N+T,o[s+2]=p*L+y*U+w*N+A,s+=a}else for(let C=0;C<l;++C){const O=3*e[C],L=t[O],U=t[O+1],N=t[O+2],z=c*L+f*U+v*N+S,V=h*L+g*U+b*N+T,B=p*L+y*U+w*N+A;for(let J=0;J<n;++J)o[s]=z,o[s+1]=V,o[s+2]=B,s+=a}}function cW(e,t,i,r,s,n=1){if(!i)return void T0e(e,t,r,s,n);const o=i,a=r.typedBuffer,l=r.typedBufferStride,c=e.length,h=o[0],p=o[1],f=o[2],g=o[4],y=o[5],v=o[6],b=o[8],w=o[9],S=o[10],T=!Rj(o),A=1e-6,C=1-A;if(s*=l,n===1)for(let O=0;O<c;++O){const L=3*e[O],U=t[L],N=t[L+1],z=t[L+2];let V=h*U+g*N+b*z,B=p*U+y*N+w*z,J=f*U+v*N+S*z;if(T){const Q=V*V+B*B+J*J;if(Q<C&&Q>A){const te=1/Math.sqrt(Q);V*=te,B*=te,J*=te}}a[s+0]=V,a[s+1]=B,a[s+2]=J,s+=l}else for(let O=0;O<c;++O){const L=3*e[O],U=t[L],N=t[L+1],z=t[L+2];let V=h*U+g*N+b*z,B=p*U+y*N+w*z,J=f*U+v*N+S*z;if(T){const Q=V*V+B*B+J*J;if(Q<C&&Q>A){const te=1/Math.sqrt(Q);V*=te,B*=te,J*=te}}for(let Q=0;Q<n;++Q)a[s+0]=V,a[s+1]=B,a[s+2]=J,s+=l}}function Nqe(e,t,i,r,s,n=1){if(!i)return void xS(e,t,r,s,n);const o=i,a=r.typedBuffer,l=r.typedBufferStride,c=e.length,h=o[0],p=o[1],f=o[2],g=o[4],y=o[5],v=o[6],b=o[8],w=o[9],S=o[10],T=!Rj(o),A=1e-6,C=1-A;if(s*=l,n===1)for(let O=0;O<c;++O){const L=4*e[O],U=t[L],N=t[L+1],z=t[L+2],V=t[L+3];let B=h*U+g*N+b*z,J=p*U+y*N+w*z,Q=f*U+v*N+S*z;if(T){const te=B*B+J*J+Q*Q;if(te<C&&te>A){const ie=1/Math.sqrt(te);B*=ie,J*=ie,Q*=ie}}a[s+0]=B,a[s+1]=J,a[s+2]=Q,a[s+3]=V,s+=l}else for(let O=0;O<c;++O){const L=4*e[O],U=t[L],N=t[L+1],z=t[L+2],V=t[L+3];let B=h*U+g*N+b*z,J=p*U+y*N+w*z,Q=f*U+v*N+S*z;if(T){const te=B*B+J*J+Q*Q;if(te<C&&te>A){const ie=1/Math.sqrt(te);B*=ie,J*=ie,Q*=ie}}for(let te=0;te<n;++te)a[s+0]=B,a[s+1]=J,a[s+2]=Q,a[s+3]=V,s+=l}}function kL(e,t,i,r,s,n=1){const o=r.typedBuffer,a=r.typedBufferStride,l=e.length;if(s*=a,n===1){if(i===4)for(let c=0;c<l;++c){const h=4*e[c];o[s]=t[h],o[s+1]=t[h+1],o[s+2]=t[h+2],o[s+3]=t[h+3],s+=a}else if(i===3)for(let c=0;c<l;++c){const h=3*e[c];o[s]=t[h],o[s+1]=t[h+1],o[s+2]=t[h+2],o[s+3]=255,s+=a}}else if(i===4)for(let c=0;c<l;++c){const h=4*e[c];for(let p=0;p<n;++p)o[s]=t[h],o[s+1]=t[h+1],o[s+2]=t[h+2],o[s+3]=t[h+3],s+=a}else if(i===3)for(let c=0;c<l;++c){const h=3*e[c];for(let p=0;p<n;++p)o[s]=t[h],o[s+1]=t[h+1],o[s+2]=t[h+2],o[s+3]=255,s+=a}}function o4(e,t,i,r,s,n){for(const o of t.fieldNames){const a=e.vertexAttributes.get(o),l=e.indices.get(o);if(a&&l)switch(o){case E.POSITION:{at(a.size===3);const c=s.getField(o,Si);c&&FO(l,a.data,i,c,n);break}case E.NORMAL:{at(a.size===3);const c=s.getField(o,Si);c&&cW(l,a.data,r,c,n);break}case E.UV0:{at(a.size===2);const c=s.getField(o,Uu);c&&Lqe(l,a.data,c,n);break}case E.COLOR:{at(a.size===3||a.size===4);const c=s.getField(o,Pa);c&&kL(l,a.data,a.size,c,n);break}case E.SYMBOLCOLOR:{at(a.size===3||a.size===4);const c=s.getField(o,Pa);c&&kL(l,a.data,a.size,c,n);break}case E.TANGENT:{at(a.size===4);const c=s.getField(o,rn);c&&Nqe(l,a.data,r,c,n);break}}}}function zL(e,t,i=0){const r=Be(e,0,kqe);for(let s=0;s<4;s++)t[i+s]=Math.floor(256*zqe(r*Fqe[s]))}function uW(e,t=0){let i=0;for(let r=0;r<4;r++)i+=e[t+r]*Uqe[r];return i}const Fqe=[1,256,65536,16777216],Uqe=[1/256,1/65536,1/16777216,1/4294967296],kqe=uW(new Uint8ClampedArray([255,255,255,255]));function zqe(e){return e-Math.floor(e)}function Bqe(){if(R(vk)){const e=t=>ui(`esri/libs/basisu/${t}`);vk=import("./basis_transcoder.3a994fb7.js").then(t=>t.b).then(({default:t})=>t({locateFile:e}).then(i=>(i.initializeBasis(),delete i.then,i)))}return vk}let vk;var U_;(function(e){e[e.ETC1_RGB=0]="ETC1_RGB",e[e.ETC2_RGBA=1]="ETC2_RGBA",e[e.BC1_RGB=2]="BC1_RGB",e[e.BC3_RGBA=3]="BC3_RGBA",e[e.BC4_R=4]="BC4_R",e[e.BC5_RG=5]="BC5_RG",e[e.BC7_M6_RGB=6]="BC7_M6_RGB",e[e.BC7_M5_RGBA=7]="BC7_M5_RGBA",e[e.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",e[e.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",e[e.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",e[e.ATC_RGB=11]="ATC_RGB",e[e.ATC_RGBA=12]="ATC_RGBA",e[e.FXT1_RGB=17]="FXT1_RGB",e[e.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",e[e.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",e[e.ETC2_EAC_R11=20]="ETC2_EAC_R11",e[e.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",e[e.RGBA32=13]="RGBA32",e[e.RGB565=14]="RGB565",e[e.BGR565=15]="BGR565",e[e.RGBA4444=16]="RGBA4444"})(U_||(U_={}));let Hh=null,P3=null;async function S0e(){return R(P3)&&(P3=Bqe(),Hh=await P3),P3}function Vqe(e,t){if(R(Hh))return e.byteLength;const i=new Hh.BasisFile(new Uint8Array(e)),r=A0e(i)?E0e(i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),t):0;return i.close(),i.delete(),r}function Gqe(e,t){if(R(Hh))return e.byteLength;const i=new Hh.KTX2File(new Uint8Array(e)),r=C0e(i)?E0e(i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),t):0;return i.close(),i.delete(),r}function E0e(e,t,i,r,s){const n=bge(t?Ar.COMPRESSED_RGBA8_ETC2_EAC:Ar.COMPRESSED_RGB8_ETC2),o=s&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(i*r*n*o)}function A0e(e){return e.getNumImages()>=1&&!e.isUASTC()}function C0e(e){return e.getFaces()>=1&&e.isETC1S()}async function jqe(e,t,i){R(Hh)&&(Hh=await S0e());const r=new Hh.BasisFile(new Uint8Array(i));if(!A0e(r))return null;r.startTranscoding();const s=R0e(e,t,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),(n,o)=>r.getImageTranscodedSizeInBytes(0,n,o),(n,o,a)=>r.transcodeImage(a,0,n,o,0,0));return r.close(),r.delete(),s}async function Hqe(e,t,i){R(Hh)&&(Hh=await S0e());const r=new Hh.KTX2File(new Uint8Array(i));if(!C0e(r))return null;r.startTranscoding();const s=R0e(e,t,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),(n,o)=>r.getImageTranscodedSizeInBytes(n,0,0,o),(n,o,a)=>r.transcodeImage(a,n,0,0,o,0,-1,-1));return r.close(),r.delete(),s}function R0e(e,t,i,r,s,n,o,a){const{compressedTextureETC:l,compressedTextureS3TC:c}=e.capabilities,[h,p]=l?r?[U_.ETC2_RGBA,Ar.COMPRESSED_RGBA8_ETC2_EAC]:[U_.ETC1_RGB,Ar.COMPRESSED_RGB8_ETC2]:c?r?[U_.BC3_RGBA,Ar.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[U_.BC1_RGB,Ar.COMPRESSED_RGB_S3TC_DXT1_EXT]:[U_.RGBA32,$e.RGBA],f=t.hasMipmap?i:Math.min(1,i),g=[];for(let w=0;w<f;w++)g.push(new Uint8Array(o(w,h))),a(w,h,g[w]);const y=g.length>1,v=y?Ge.LINEAR_MIPMAP_LINEAR:Ge.LINEAR,b=me(I({},t),{samplingMode:v,hasMipmap:y,internalFormat:p,width:s,height:n});return new Qe(e,b,{type:"compressed",levels:g})}const V2=he.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),qqe=542327876,Wqe=131072,Xqe=4;function hW(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function Yqe(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}const Zqe=hW("DXT1"),Qqe=hW("DXT3"),Jqe=hW("DXT5"),Kqe=31,eWe=0,tWe=1,iWe=2,rWe=3,sWe=4,nWe=7,oWe=20,aWe=21;function lWe(e,t,i){const{textureData:r,internalFormat:s,width:n,height:o}=cWe(i,t.hasMipmap);return t.samplingMode=r.levels.length>1?Ge.LINEAR_MIPMAP_LINEAR:Ge.LINEAR,t.hasMipmap=r.levels.length>1,t.internalFormat=s,t.width=n,t.height=o,new Qe(e,t,r)}function cWe(e,t){const i=new Int32Array(e,0,Kqe);if(i[eWe]!==qqe)return V2.error("Invalid magic number in DDS header"),null;if(!(i[oWe]&Xqe))return V2.error("Unsupported format, must contain a FourCC code"),null;const r=i[aWe];let s,n;switch(r){case Zqe:s=8,n=Ar.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Qqe:s=16,n=Ar.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Jqe:s=16,n=Ar.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return V2.error("Unsupported FourCC code:",Yqe(r)),null}let o=1,a=i[sWe],l=i[rWe];(3&a)==0&&(3&l)==0||(V2.warn("Rounding up compressed texture size to nearest multiple of 4."),a=a+3&-4,l=l+3&-4);const c=a,h=l;let p,f;i[iWe]&Wqe&&t!==!1&&(o=Math.max(1,i[nWe])),o===1||xT(a)&&xT(l)||(V2.warn("Ignoring mipmaps of non power of two sized compressed texture."),o=1);let g=i[tWe]+4;const y=[];for(let v=0;v<o;++v)f=(a+3>>2)*(l+3>>2)*s,p=new Uint8Array(e,g,f),y.push(p),g+=f,a=Math.max(1,a>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:y},internalFormat:n,width:c,height:h}}class rs extends PO{constructor(t,i){super(),this.data=t,this.type=rd.Texture,this._glTexture=null,this._powerOfTwoStretchInfo=null,this._loadingPromise=null,this._loadingController=null,this.events=new xr,this.params=i||{},this.params.mipmap=this.params.mipmap!==!1,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:ct.REPEAT,t:ct.REPEAT},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||l0.STRETCH,this.estimatedTexMemRequired=rs._estimateTexMemRequired(this.data,this.params),this._startPreload()}_startPreload(){const t=this.data;R(t)||(t instanceof HTMLVideoElement?this._startPreloadVideoElement(t):t instanceof HTMLImageElement&&this._startPreloadImageElement(t))}_startPreloadVideoElement(t){UT(t.src)||t.preload==="auto"&&t.crossOrigin||(t.preload="auto",t.crossOrigin="anonymous",t.src=t.src)}_startPreloadImageElement(t){Up(t.src)||UT(t.src)||t.crossOrigin||(t.crossOrigin="anonymous",t.src=t.src)}static _getDataDimensions(t){return t instanceof HTMLVideoElement?{width:t.videoWidth,height:t.videoHeight}:t}static _estimateTexMemRequired(t,i){if(R(t))return 0;if(c2(t)||E_(t))return i.encoding===rs.KTX2_ENCODING?Gqe(t,i.mipmap):i.encoding===rs.BASIS_ENCODING?Vqe(t,i.mipmap):t.byteLength;const{width:r,height:s}=t instanceof Image||t instanceof ImageData||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement?rs._getDataDimensions(t):i;return(i.mipmap?4/3:1)*r*s*(i.components||4)||0}dispose(){this.data=void 0}get width(){return this.params.width}get height(){return this.params.height}_createDescriptor(t){var i;return{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?Ge.LINEAR_MIPMAP_LINEAR:Ge.LINEAR,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:(i=this.params.maxAnisotropy)!=null?i:this.params.mipmap?t.parameters.maxMaxAnisotropy:1}}get glTexture(){return this._glTexture}load(t,i){if(_(this._glTexture))return this._glTexture;if(_(this._loadingPromise))return this._loadingPromise;const r=this.data;return R(r)?(this._glTexture=new Qe(t,this._createDescriptor(t),null),this._glTexture):typeof r=="string"?this._loadFromURL(t,i,r):r instanceof Image?this._loadFromImageElement(t,i,r):r instanceof HTMLVideoElement?this._loadFromVideoElement(t,i,r):r instanceof ImageData||r instanceof HTMLCanvasElement?this._loadFromImage(t,r,i):(c2(r)||E_(r))&&this.params.encoding===rs.DDS_ENCODING?(this.data=void 0,this._loadFromDDSData(t,r)):(c2(r)||E_(r))&&this.params.encoding===rs.KTX2_ENCODING?(this.data=void 0,this._loadFromKTX2(t,r)):(c2(r)||E_(r))&&this.params.encoding===rs.BASIS_ENCODING?(this.data=void 0,this._loadFromBasis(t,r)):E_(r)?this._loadFromPixelData(t,r):c2(r)?this._loadFromPixelData(t,new Uint8Array(r)):null}get requiresFrameUpdates(){return this.data instanceof HTMLVideoElement}frameUpdate(t,i,r){if(!(this.data instanceof HTMLVideoElement)||R(this._glTexture)||this.data.readyState<mC.HAVE_CURRENT_DATA||r===this.data.currentTime)return r;if(_(this._powerOfTwoStretchInfo)){const{framebuffer:s,vao:n,sourceTexture:o}=this._powerOfTwoStretchInfo;o.setData(this.data),this._drawStretchedTexture(t,i,s,n,o,this._glTexture)}else{const{width:s,height:n}=this.data,{width:o,height:a}=this._glTexture.descriptor;s!==o||n!==a?this._glTexture.updateData(0,0,0,Math.min(s,o),Math.min(n,a),this.data):this._glTexture.setData(this.data)}return this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.data.currentTime}_loadFromDDSData(t,i){return this._glTexture=lWe(t,this._createDescriptor(t),i),this._glTexture}_loadFromKTX2(t,i){return this._loadAsync(()=>Hqe(t,this._createDescriptor(t),i).then(r=>(this._glTexture=r,r)))}_loadFromBasis(t,i){return this._loadAsync(()=>jqe(t,this._createDescriptor(t),i).then(r=>(this._glTexture=r,r)))}_loadFromPixelData(t,i){at(this.params.width>0&&this.params.height>0);const r=this._createDescriptor(t);return r.pixelFormat=this.params.components===1?$e.LUMINANCE:this.params.components===3?$e.RGB:$e.RGBA,r.width=this.params.width,r.height=this.params.height,this._glTexture=new Qe(t,r,i),this._glTexture}_loadFromURL(t,i,r){return this._loadAsync(async s=>{const n=await Fu(r,{signal:s});return Qt(s),this._loadFromImage(t,n,i)})}_loadFromImageElement(t,i,r){return r.complete?this._loadFromImage(t,r,i):this._loadAsync(async s=>{const n=await tce(r,r.src,!1,s);return Qt(s),this._loadFromImage(t,n,i)})}_loadFromVideoElement(t,i,r){return r.readyState>=mC.HAVE_CURRENT_DATA?this._loadFromImage(t,r,i):this._loadFromVideoElementAsync(t,i,r)}_loadFromVideoElementAsync(t,i,r){return this._loadAsync(s=>new Promise((n,o)=>{const a=()=>{r.removeEventListener("loadeddata",l),r.removeEventListener("error",c),Js(h)},l=()=>{r.readyState>=mC.HAVE_CURRENT_DATA&&(a(),n(this._loadFromImage(t,r,i)))},c=p=>{a(),o(p||new q("Failed to load video"))};r.addEventListener("loadeddata",l),r.addEventListener("error",c);const h=go(s,()=>c(pi()))}))}_loadFromImage(t,i,r){const s=rs._getDataDimensions(i);this.params.width=s.width,this.params.height=s.height;const n=this._createDescriptor(t);return n.pixelFormat=this.params.components===3?$e.RGB:$e.RGBA,!this._requiresPowerOfTwo(t,n)||xT(s.width)&&xT(s.height)?(n.width=s.width,n.height=s.height,this._glTexture=new Qe(t,n,i),this._glTexture):(this._glTexture=this._makePowerOfTwoTexture(t,i,s,n,r),this._glTexture)}_loadAsync(t){const i=new AbortController;this._loadingController=i;const r=t(i.signal);this._loadingPromise=r;const s=()=>{this._loadingController===i&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null)};return r.then(s,s),r}_requiresPowerOfTwo(t,i){const r=ct.CLAMP_TO_EDGE,s=typeof i.wrapMode=="number"?i.wrapMode===r:i.wrapMode.s===r&&i.wrapMode.t===r;return!Zs(t.gl)&&(i.hasMipmap||!s)}_makePowerOfTwoTexture(t,i,r,s,n){const{width:o,height:a}=r,l=wT(o),c=wT(a);let h;switch(s.width=l,s.height=c,this.params.powerOfTwoResizeMode){case l0.PAD:s.textureCoordinateScaleFactor=[o/l,a/c],h=new Qe(t,s),h.updateData(0,0,0,o,a,i);break;case l0.STRETCH:case null:case void 0:h=this._stretchToPowerOfTwo(t,i,s,n());break;default:this.params.powerOfTwoResizeMode}return s.hasMipmap&&h.generateMipmap(),h}_stretchToPowerOfTwo(t,i,r,s){const n=new Qe(t,r),o=new zi(t,{colorTarget:vr.TEXTURE,depthStencilTarget:ti.NONE},n),a=new Qe(t,{target:st.TEXTURE_2D,pixelFormat:r.pixelFormat,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE,samplingMode:Ge.LINEAR,flipped:!!r.flipped,maxAnisotropy:8,preMultiplyAlpha:r.preMultiplyAlpha},i),l=bo(t),c=t.getBoundFramebufferObject();return this._drawStretchedTexture(t,s,o,l,a,n),this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:l,sourceTexture:a,framebuffer:o}:(l.dispose(!0),a.dispose(),o.detachColorTexture(),o.dispose()),t.bindFramebuffer(c),n}_drawStretchedTexture(t,i,r,s,n,o){t.bindFramebuffer(r);const a=t.getViewport();t.setViewport(0,0,o.descriptor.width,o.descriptor.height);const l=t.useTechnique(i);l.setUniform4f("uColor",1,1,1,1),l.bindTexture(n,"tex"),t.bindVAO(s),t.drawArrays(Tt.TRIANGLE_STRIP,0,vn(s,"geometry")),t.bindFramebuffer(null),t.setViewport(a.x,a.y,a.width,a.height)}unload(){if(_(this._powerOfTwoStretchInfo)){const{framebuffer:t,vao:i,sourceTexture:r}=this._powerOfTwoStretchInfo;i.dispose(!0),r.dispose(),t.dispose(),this._glTexture=null,this._powerOfTwoStretchInfo=null}if(_(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),_(this._loadingController)){const t=this._loadingController;this._loadingController=null,this._loadingPromise=null,t.abort()}this.events.emit("unloaded")}}var mC;rs.DDS_ENCODING="image/vnd-ms.dds",rs.KTX2_ENCODING="image/ktx2",rs.BASIS_ENCODING="image/x.basis",function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(mC||(mC={}));const PR=128,dW=.5;function O0e(e,t=PR,i=t*dW,r=0){const s=uWe(e,t,i,r);return new rs(s,{mipmap:!1,wrap:{s:ct.CLAMP_TO_EDGE,t:ct.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0})}function uWe(e,t=PR,i=t*dW,r=0){switch(e){case"circle":default:return hWe(t,i);case"square":return dWe(t,i);case"cross":return fWe(t,i,r);case"x":return mWe(t,i,r);case"kite":return pWe(t,i);case"triangle":return gWe(t,i);case"arrow":return yWe(t,i)}}function hWe(e,t){const i=e/2-.5;return UO(e,I0e(i,i,t/2))}function dWe(e,t){return M0e(e,t,!1)}function pWe(e,t){return M0e(e,t,!0)}function fWe(e,t,i=0){return P0e(e,t,!1,i)}function mWe(e,t,i=0){return P0e(e,t,!0,i)}function gWe(e,t){return UO(e,$0e(e/2,t,t/2))}function yWe(e,t){const i=t,r=t/2,s=e/2,n=.8*i,o=I0e(s,(e-t)/2-n,Math.sqrt(n*n+r*r)),a=$0e(s,i,r);return UO(e,(l,c)=>Math.max(a(l,c),-o(l,c)))}function M0e(e,t,i){return i&&(t/=Math.SQRT2),UO(e,(r,s)=>{let n=r-.5*e+.25,o=.5*e-s-.75;if(i){const a=(n+o)/Math.SQRT2;o=(o-n)/Math.SQRT2,n=a}return Math.max(Math.abs(n),Math.abs(o))-.5*t})}function P0e(e,t,i,r=0){t-=r,i&&(t*=Math.SQRT2);const s=.5*t;return UO(e,(n,o)=>{let a,l=n-.5*e,c=.5*e-o-1;if(i){const h=(l+c)/Math.SQRT2;c=(c-l)/Math.SQRT2,l=h}return l=Math.abs(l),c=Math.abs(c),a=l>c?l>s?Math.sqrt((l-s)*(l-s)+c*c):c:c>s?Math.sqrt(l*l+(c-s)*(c-s)):l,a-=r/2,a})}function I0e(e,t,i){return(r,s)=>{const n=r-e,o=s-t;return Math.sqrt(n*n+o*o)-i}}function $0e(e,t,i){const r=Math.sqrt(t*t+i*i);return(s,n)=>{const o=Math.abs(s-e)-i,a=n-e+t/2+.75,l=(t*o+i*a)/r,c=-a;return Math.max(l,c)}}function UO(e,t){const i=new Uint8Array(4*e*e);for(let r=0;r<e;r++)for(let s=0;s<e;s++){const n=s+e*r;let o=t(s,r);o=o/e+.5,zL(o,i,4*n)}return i}function Or(e,t){if(t.slicePlaneEnabled){e.extensions.add("GL_OES_standard_derivatives"),t.sliceEnabledForVertexPrograms&&(e.vertex.uniforms.add("slicePlaneOrigin","vec3"),e.vertex.uniforms.add("slicePlaneBasis1","vec3"),e.vertex.uniforms.add("slicePlaneBasis2","vec3")),e.fragment.uniforms.add("slicePlaneOrigin","vec3"),e.fragment.uniforms.add("slicePlaneBasis1","vec3"),e.fragment.uniforms.add("slicePlaneBasis2","vec3");const i=x`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
#define rejectBySlice(_pos_) sliceByPlane(_pos_)
#define discardBySlice(_pos_) { if (sliceByPlane(_pos_)) discard; }`,r=x`vec4 applySliceHighlight(vec4 color, vec3 pos) {
SliceFactors factors = calculateSliceFactors(pos);
const float HIGHLIGHT_WIDTH = 1.0;
const vec4 HIGHLIGHT_COLOR = vec4(0.0, 0.0, 0.0, 0.3);
factors.front /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.front);
factors.side0 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side0);
factors.side1 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side1);
factors.side2 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side2);
factors.side3 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side3);
if (sliceByFactors(factors)) {
return color;
}
float highlightFactor = (1.0 - step(0.5, factors.front))
* (1.0 - step(0.5, factors.side0))
* (1.0 - step(0.5, factors.side1))
* (1.0 - step(0.5, factors.side2))
* (1.0 - step(0.5, factors.side3));
return mix(color, vec4(HIGHLIGHT_COLOR.rgb, color.a), highlightFactor * HIGHLIGHT_COLOR.a);
}`,s=t.sliceHighlightDisabled?x`#define highlightSlice(_color_, _pos_) (_color_)`:x`
        ${r}
        #define highlightSlice(_color_, _pos_) (sliceEnabled() ? applySliceHighlight(_color_, _pos_) : (_color_))
      `;t.sliceEnabledForVertexPrograms&&e.vertex.code.add(i),e.fragment.code.add(i),e.fragment.code.add(s)}else{const i=x`#define rejectBySlice(_pos_) false
#define discardBySlice(_pos_) {}
#define highlightSlice(_color_, _pos_) (_color_)`;t.sliceEnabledForVertexPrograms&&e.vertex.code.add(i),e.fragment.code.add(i)}}function wb(e,t,i){I0(e,t,i.slicePlane,{origin:i.origin})}function I0(e,t,i,r){if(t.slicePlaneEnabled)if(_(i)){if(ne(tf,i.origin),ne(fg,i.basis1),ne(mg,i.basis2),_(r)&&_(r.origin)&&de(tf,i.origin,r.origin),_(r)&&_(r.view)){const s=_(r.origin)?Wo(vWe,r.view,r.origin):r.view;pe(fg,fg,tf),pe(mg,mg,tf),ke(tf,tf,s),ke(fg,fg,s),ke(mg,mg,s),de(fg,fg,tf),de(mg,mg,tf)}e.setUniform3fv("slicePlaneOrigin",tf),e.setUniform3fv("slicePlaneBasis1",fg),e.setUniform3fv("slicePlaneBasis2",mg)}else e.setUniform3fv("slicePlaneBasis1",pl),e.setUniform3fv("slicePlaneBasis2",pl),e.setUniform3fv("slicePlaneOrigin",pl)}const tf=M(),fg=M(),mg=M(),vWe=Te();function D0e(e){e.include(Os),e.uniforms.add("geometryDepthTexture","sampler2D"),e.uniforms.add("nearFar","vec2"),e.code.add(x`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}function L0e(e,t){t.multipassGeometryEnabled&&t.geometryLinearDepthTexture&&e.bindTexture(t.geometryLinearDepthTexture,"geometryDepthTexture")}function _We(e,t){t.multipassGeometryEnabled&&e.vertex.include(D0e),t.multipassTerrainEnabled&&e.varyings.add("depth","float"),e.vertex.code.add(x`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel
      // filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${t.multipassGeometryEnabled?x`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${t.multipassTerrainEnabled?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),t.multipassTerrainEnabled&&e.fragment.include(Os),e.fragment.uniforms.add("terrainDepthTexture","sampler2D"),e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("inverseViewport","vec2"),e.fragment.include(nd),e.fragment.code.add(x`
  void main() {
    gl_FragColor = vec4(1, 1, 1, 1);
    ${t.multipassTerrainEnabled?x`

          vec2 uv = gl_FragCoord.xy * inverseViewport;

          //Read the rgba data from the texture linear depth
          vec4 terrainDepthData = texture2D(terrainDepthTexture, uv);

          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), nearFar);

          //If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)
          //Mark the HUD vertex as occluded by transparent terrain
          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){
            gl_FragColor.g = 0.5;
          }`:""}
  }
  `)}const bWe=yi(1,1,0,1),N0e=yi(1,0,1,1);function Qm(e){e.fragment.uniforms.add("depthTex","sampler2D"),e.fragment.uniforms.add("highlightViewportPixelSz","vec4"),e.fragment.constants.add("occludedHighlightFlag","vec4",bWe).add("unoccludedHighlightFlag","vec4",N0e),e.fragment.code.add(x`void outputHighlight() {
vec4 fragCoord = gl_FragCoord;
float sceneDepth = texture2D(depthTex, (fragCoord.xy - highlightViewportPixelSz.xy) * highlightViewportPixelSz.zw).r;
if (fragCoord.z > sceneDepth + 5e-7) {
gl_FragColor = occludedHighlightFlag;
}
else {
gl_FragColor = unoccludedHighlightFlag;
}
}`)}function Hp(e,t){e.bindTexture(t.highlightDepthTexture,"depthTex"),e.setUniform4f("highlightViewportPixelSz",0,0,t.inverseViewport[0],t.inverseViewport[1])}function aT(e,t){t.vvInstancingEnabled&&(t.vvSize||t.vvColor)&&e.attributes.add(E.INSTANCEFEATUREATTRIBUTE,"vec4"),t.vvSize?(e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.uniforms.add("vvSymbolRotationMatrix","mat3"),e.vertex.uniforms.add("vvSymbolAnchor","vec3"),e.vertex.code.add(x`vec3 vvScale(vec4 _featureAttribute) {
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),e.vertex.code.add(x`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 vvScale = clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize + eps, vvSizeMaxSize);
        return vec4(vvSymbolRotationMatrix * _normal / vvScale, 1.0);
      }

      ${t.vvInstancingEnabled?x`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):e.vertex.code.add(x`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),t.vvColor?(e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(x`
      uniform float vvColorValues[vvColorNumber];
      uniform vec4 vvColorColors[vvColorNumber];

      vec4 vvGetColor(vec4 featureAttribute, float values[vvColorNumber], vec4 colors[vvColorNumber]) {
        float value = featureAttribute.y;
        if (value <= values[0]) {
          return colors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (values[i] >= value) {
            float f = (value - values[i-1]) / (values[i] - values[i-1]);
            return mix(colors[i-1], colors[i], f);
          }
        }
        return colors[vvColorNumber - 1];
      }

      ${t.vvInstancingEnabled?x`
      vec4 vvColor() {
        return vvGetColor(instanceFeatureAttribute, vvColorValues, vvColorColors);
      }`:""}
    `)):e.vertex.code.add(x`vec4 vvColor() { return vec4(1.0); }`)}function pW(e,t){t.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",t.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",t.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",t.vvSizeOffset),e.setUniform3fv("vvSizeFactor",t.vvSizeFactor)),t.vvColorEnabled&&(e.setUniform1fv("vvColorValues",t.vvColorValues),e.setUniform4fv("vvColorColors",t.vvColorColors))}function F0e(e,t){pW(e,t),t.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",t.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",t.vvOpacityOpacities))}function wWe(e,t){pW(e,t),t.vvSizeEnabled&&(e.setUniform3fv("vvSymbolAnchor",t.vvSymbolAnchor),e.setUniformMatrix3fv("vvSymbolRotationMatrix",t.vvSymbolRotationMatrix))}const BL=.1,Hn=.001;function vm(e,t){const i=e.fragment;switch(t.alphaDiscardMode){case Ri.Blend:i.code.add(x`
        #define discardOrAdjustAlpha(color) { if (color.a < ${x.float(Hn)}) { discard; } }
      `);break;case Ri.Opaque:i.code.add(x`void discardOrAdjustAlpha(inout vec4 color) {
color.a = 1.0;
}`);break;case Ri.Mask:i.uniforms.add("textureAlphaCutoff","float"),i.code.add(x`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } else { color.a = 1.0; } }`);break;case Ri.MaskBlend:e.fragment.uniforms.add("textureAlphaCutoff","float"),e.fragment.code.add(x`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } }`)}}function xWe(e){const t=new Oi,i=e.signedDistanceFieldEnabled;if(t.include($q),t.include(w0e,e),t.include(Or,e),e.output===j.Occlusion)return t.include(_We,e),t;t.include(aW),t.fragment.include(nd),t.fragment.include(Vp),t.include(aT,e),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),e.binaryHighlightOcclusionEnabled&&t.varyings.add("voccluded","float"),t.vertex.uniforms.add("screenOffset","vec2").add("anchorPos","vec2").add("textureCoordinateScaleFactor","vec2").add("materialColor","vec4"),i&&t.vertex.uniforms.add("outlineColor","vec4"),e.screenSizePerspectiveEnabled&&t.vertex.uniforms.add("screenSizePerspective","vec4"),(e.debugDrawLabelBorder||e.binaryHighlightOcclusionEnabled)&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add(E.UV0,"vec2"),t.attributes.add(E.COLOR,"vec4"),t.attributes.add(E.SIZE,"vec2"),t.attributes.add(E.AUXPOS2,"vec4"),t.vertex.code.add(x`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${e.screenSizePerspectiveEnabled?x`
      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:x`
      inputSize = size;
      vec2 screenOffsetScaled = screenOffset;`}

      ${e.vvSize?"inputSize *= vvScale(auxpos2).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${e.occlusionTestEnabled||e.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":""}

      ${e.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""}
    `);const r=x`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPos) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,s=e.pixelSnappingEnabled?i?x`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:x`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:x`posProj += quadOffset;`;t.vertex.code.add(x`
      ${e.occlusionTestEnabled?"if (visible) {":""}
      ${r}
      ${e.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

      bool alphaDiscard = vcolor.a < ${x.float(Hn)};
      ${i?`alphaDiscard = alphaDiscard && outlineColor.a < ${x.float(Hn)};`:""}
      if (alphaDiscard) {
        // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      } else {
        ${s}
        gl_Position = posProj;
      }

      vtc = uv * textureCoordinateScaleFactor;

      ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
      vsize = inputSize;
      ${e.occlusionTestEnabled?x`} else { vtc = vec2(0.0);
        ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
    }
    `),t.fragment.uniforms.add("tex","sampler2D"),i&&(t.fragment.uniforms.add("outlineColor","vec4"),t.fragment.uniforms.add("outlineSize","float"));const n=e.debugDrawLabelBorder?x`(isBorder > 0.0 ? 0.0 : ${x.float(BL)})`:x.float(BL),o=x`
    ${e.debugDrawLabelBorder?x`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${i?x`
      vec4 fillPixelColor = vcolor;

      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      const float txSize = ${x.float(PR)};
      const float texelSize = 1.0 / txSize;
      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${n} ||
          fillPixelColor.a + outlinePixelColor.a < ${x.float(Hn)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        gl_FragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${n}) {
          discard;
        }

        gl_FragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:x`
          vec4 texColor = texture2D(tex, vtc, -0.5);
          if (texColor.a < ${n}) {
            discard;
          }
          gl_FragColor = texColor * premultiplyAlpha(vcolor);
          `}

    // Draw debug border with transparency, so that original texels along border are still partially visible
    ${e.debugDrawLabelBorder?x`gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`:""}
  `;return e.output===j.Alpha&&t.fragment.code.add(x`
      void main() {
        ${o}
        gl_FragColor = vec4(gl_FragColor.a);
      }
      `),e.output===j.Color&&t.fragment.code.add(x`
    void main() {
      ${o}
      ${e.frontFacePass?"gl_FragColor.rgb /= gl_FragColor.a;":""}
    }
    `),e.output===j.Highlight&&(t.include(Qm),t.fragment.code.add(x`
    void main() {
      ${o}
      ${e.binaryHighlightOcclusionEnabled?x`
          if (voccluded == 1.0) {
            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
          } else {
            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);
          }`:"outputHighlight();"}
    }
    `)),t}function U0e(e,t,i){e.setUniform4fv("materialColor",t.color),t.textureIsSignedDistanceField&&(t.outlineColor[3]<=0||t.outlineSize<=0?(e.setUniform4fv("outlineColor",c1),e.setUniform1f("outlineSize",0)):(e.setUniform4fv("outlineColor",t.outlineColor),e.setUniform1f("outlineSize",t.outlineSize))),e.setUniform2f("screenOffset",2*t.screenOffset[0]*i,2*t.screenOffset[1]*i),e.setUniform2fv("anchorPos",VL(t))}function VL(e,t=SWe){return e.textureIsSignedDistanceField?TWe(e.anchorPos,e.distanceFieldBoundingBox,t):zs(t,e.anchorPos),t}function TWe(e,t,i){i[0]=e[0]*(t[2]-t[0])+t[0],i[1]=e[1]*(t[3]-t[1])+t[1]}const SWe=Ye(),EWe=Object.freeze({__proto__:null,build:xWe,bindHUDMaterialUniforms:U0e,calculateAnchorPosForRendering:VL});function k0e(e,t){const i=e.vertex.code;t.verticalOffsetEnabled?(e.vertex.uniforms.add("verticalOffset","vec4"),t.screenSizePerspectiveEnabled&&(e.include(aW),e.vertex.uniforms.add("screenSizePerspectiveAlignment","vec4")),i.add(x`
    vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {
      float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);
      ${t.viewingMode===Ie.Global?x`vec3 worldNormal = normalize(worldPos + localOrigin);`:x`vec3 worldNormal = vec3(0.0, 0.0, 1.0);`}
      ${t.screenSizePerspectiveEnabled?x`
          float cosAngle = dot(worldNormal, normalize(worldPos - cameraPosition));
          float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);`:x`
          float verticalOffsetScreenHeight = verticalOffset.x;`}
      // Screen sized offset in world space, used for example for line callouts
      float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);
      return worldNormal * worldOffset;
    }

    vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {
      return worldPos + calculateVerticalOffset(worldPos, localOrigin);
    }
    `)):i.add(x`vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }`)}function fW(e,t,i){if(!t.verticalOffset)return;const r=AWe(t.verticalOffset,i.camera.fovY,i.camera.fullViewport[3]),s=i.camera.pixelRatio||1;e.setUniform4f("verticalOffset",r.screenLength*s,r.perDistance,r.minWorldLength,r.maxWorldLength)}function AWe(e,t,i,r=CWe){return r.screenLength=e.screenLength,r.perDistance=Math.tan(.5*t)/(.5*i),r.minWorldLength=e.minWorldLength,r.maxWorldLength=e.maxWorldLength,r}const CWe={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0};function Ec(e,t){e.fragment.uniforms.add("terrainDepthTexture","sampler2D"),e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("inverseViewport","vec2"),e.fragment.code.add(x`
    // Compare the linearized depths of fragment and terrain. Discard fragments on the wrong side of the terrain.
    void terrainDepthTest(vec4 fragCoord, float fragmentDepth){

      float terrainDepth = linearDepthFromTexture(terrainDepthTexture, fragCoord.xy * inverseViewport, nearFar);
      if(fragmentDepth ${t.cullAboveGround?">":"<="} terrainDepth){
        discard;
      }
    }
  `)}function Jm(e,t){t.multipassTerrainEnabled&&t.terrainLinearDepthTexture&&e.bindTexture(t.terrainLinearDepthTexture,"terrainDepthTexture")}const gl=Xn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),RWe=Sc(Ee.ONE,Ee.ONE),z0e=Sc(Ee.ZERO,Ee.ONE_MINUS_SRC_ALPHA);function Km(e){return e===lt.FrontFace?null:e===lt.Alpha?z0e:RWe}function a4(e){return e===lt.FrontFace?Ma:null}const l4=5e5,c4={factor:-1,units:-2};function u4(e){return e?c4:null}function H0(e,t=Li.LESS){return e===lt.NONE||e===lt.FrontFace?t:Li.LEQUAL}class kO extends Gi{initializeProgram(t){const i=kO.shader.get(),r=this.configuration,s=i.build({output:r.output,frontFacePass:r.transparencyPassType===lt.FrontFace,viewingMode:t.viewingMode,occlusionTestEnabled:r.occlusionTestEnabled,signedDistanceFieldEnabled:r.sdf,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,debugDrawLabelBorder:r.debugDrawLabelBorder,binaryHighlightOcclusionEnabled:r.binaryHighlightOcclusion,screenCenterOffsetUnitsEnabled:r.screenCenterOffsetUnitsEnabled,screenSizePerspectiveEnabled:r.screenSizePerspective,verticalOffsetEnabled:r.verticalOffset,pixelSnappingEnabled:r.pixelSnappingEnabled,vvSize:r.vvSize,vvColor:r.vvColor,vvInstancingEnabled:!1,isDraped:r.isDraped,multipassGeometryEnabled:r.multipassGeometryEnabled,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Mi(t.rctx,s,mi)}bindPass(t,i){Ol(this.program,i.camera.projectionMatrix),this.program.setUniform1f("cameraGroundRelative",i.camera.aboveGround?1:-1),this.program.setUniform1f("perDistancePixelRatio",Math.tan(i.camera.fovY/2)/(i.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",i.camera.viewInverseTransposeMatrix),this.program.setUniform1f("polygonOffset",t.shaderPolygonOffset),fW(this.program,t,i),$qe(this.program,t),this.program.setUniform1f("pixelRatio",i.camera.pixelRatio||1),Wge(this.program,i),this.configuration.output===j.Occlusion?(this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),L0e(this.program,i),Jm(this.program,i)):(x0e(this.program,i),U0e(this.program,t,i.camera.pixelRatio||1),pW(this.program,t),this.configuration.occlusionTestEnabled&&this.program.bindTexture(i.hudVisibilityTexture,"hudVisibilityTexture")),this.configuration.output===j.Highlight&&Hp(this.program,i)}bindDraw(t){Gp(this.program,t),j0(this.program,t.origin,t.camera.viewInverseTransposeMatrix),wb(this.program,this.configuration,t),this.program.rebindTextures()}_setPipelineState(t){const i=this.configuration,r=t===lt.NONE,s=t===lt.FrontFace,n=Li.LEQUAL,o=this.configuration.polygonOffsetEnabled&&OWe,a=(r||s)&&i.output!==j.Highlight?(i.depthEnabled||i.output===j.Occlusion)&&Ma:null;return Ot({blending:i.output===j.Color||i.output===j.Alpha||i.output===j.Highlight?r?MWe:Km(t):null,depthTest:{func:n},depthWrite:a,colorWrite:Ft,polygonOffset:o})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return this.configuration.output===j.Occlusion?Tt.POINTS:Tt.TRIANGLES}}kO.shader=new Ni(EWe,()=>import("./HUDMaterial.glsl.a581cb9d.js"));const OWe={factor:0,units:-4},MWe=Sc(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA);class js extends mr{constructor(){super(...arguments),this.output=j.Color,this.occlusionTestEnabled=!0,this.sdf=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.screenSizePerspective=!1,this.screenCenterOffsetUnitsEnabled=hl.World,this.debugDrawLabelBorder=!1,this.binaryHighlightOcclusion=!0,this.slicePlaneEnabled=!1,this.polygonOffsetEnabled=!1,this.depthEnabled=!0,this.transparencyPassType=lt.NONE,this.pixelSnappingEnabled=!0,this.isDraped=!1,this.multipassGeometryEnabled=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Z({count:j.COUNT})],js.prototype,"output",void 0),u([Z()],js.prototype,"occlusionTestEnabled",void 0),u([Z()],js.prototype,"sdf",void 0),u([Z()],js.prototype,"vvSize",void 0),u([Z()],js.prototype,"vvColor",void 0),u([Z()],js.prototype,"verticalOffset",void 0),u([Z()],js.prototype,"screenSizePerspective",void 0),u([Z({count:hl.COUNT})],js.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([Z()],js.prototype,"debugDrawLabelBorder",void 0),u([Z()],js.prototype,"binaryHighlightOcclusion",void 0),u([Z()],js.prototype,"slicePlaneEnabled",void 0),u([Z()],js.prototype,"polygonOffsetEnabled",void 0),u([Z()],js.prototype,"depthEnabled",void 0),u([Z({count:lt.COUNT})],js.prototype,"transparencyPassType",void 0),u([Z()],js.prototype,"pixelSnappingEnabled",void 0),u([Z()],js.prototype,"isDraped",void 0),u([Z()],js.prototype,"multipassGeometryEnabled",void 0),u([Z()],js.prototype,"multipassTerrainEnabled",void 0),u([Z()],js.prototype,"cullAboveGround",void 0);class TS extends od{constructor(t){super(t,zWe),this.techniqueConfig=new js}getTechniqueConfig(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.verticalOffset=!!this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.parameters.screenSizePerspective,this.techniqueConfig.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?hl.Screen:hl.World,this.techniqueConfig.polygonOffsetEnabled=this.parameters.polygonOffset,this.techniqueConfig.isDraped=this.parameters.isDraped,this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this.techniqueConfig.sdf=this.parameters.textureIsSignedDistanceField,this.techniqueConfig.vvSize=!!this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=!!this.parameters.vvColorEnabled,t===j.Color&&(this.techniqueConfig.debugDrawLabelBorder=!!this.parameters.debugDrawLabelBorder),t===j.Highlight&&(this.techniqueConfig.binaryHighlightOcclusion=this.parameters.binaryHighlightOcclusion),this.techniqueConfig.depthEnabled=this.parameters.depthEnabled,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.multipassGeometryEnabled=i.multipassGeometryEnabled,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}intersect(t,i,r,s,n,o,a,l,c){_(c)?this._intersectDrapedHudGeometry(t,o,a,l,c):this._intersectHudGeometry(t,i,r,s,a,l)}_intersectDrapedHudGeometry(t,i,r,s,n){const o=t.vertexAttributes.get(E.POSITION),a=t.vertexAttributes.get(E.SIZE),l=this.parameters,c=VL(l);let h=1,p=1;if(_(s)){const g=s(Ite);h=g[0],p=g[5]}h*=t.screenToWorldRatio,p*=t.screenToWorldRatio;const f=UWe*t.screenToWorldRatio;for(let g=0;g<o.data.length/o.size;g++){const y=g*o.size,v=o.data[y],b=o.data[y+1],w=g*a.size;let S;gg[0]=a.data[w]*h,gg[1]=a.data[w+1]*p,l.textureIsSignedDistanceField&&(S=l.outlineSize*t.screenToWorldRatio/2),Mte(i,v,b,gg,f,S,l,c)&&r(n.dist,n.normal,-1,!0)}}_intersectHudGeometry(t,i,r,s,n,o){if(!s.options.selectionMode||!s.options.hud||IO(i))return;const a=this.parameters;let l=1,c=1;if(Lu(bk,r),_(o)){const S=o(Ite);l=S[0],c=S[5],$We(bk)}const h=t.vertexAttributes.get(E.POSITION),p=t.vertexAttributes.get(E.SIZE),f=t.vertexAttributes.get(E.NORMAL),g=t.vertexAttributes.get(E.AUXPOS1);at(h.size>=3);const y=s.point,v=s.camera,b=VL(a);l*=v.pixelRatio,c*=v.pixelRatio;const w=this.parameters.centerOffsetUnits==="screen";for(let S=0;S<h.data.length/h.size;S++){const T=S*h.size;oe(xo,h.data[T],h.data[T+1],h.data[T+2]),ke(xo,xo,r);const A=S*p.size;gg[0]=p.data[A]*l,gg[1]=p.data[A+1]*c,ke(xo,xo,v.viewMatrix);const C=S*g.size;if(oe(Qu,g.data[C+0],g.data[C+1],g.data[C+2]),!w&&(xo[0]+=Qu[0],xo[1]+=Qu[1],Qu[2]!==0)){const L=Qu[2];be(Qu,xo),de(xo,xo,ae(Qu,Qu,L))}const O=S*f.size;if(oe(G2,f.data[O],f.data[O+1],f.data[O+2]),this._normalAndViewAngle(G2,bk,v,wk),this._applyVerticalOffsetTransformationView(xo,wk,v,_k),v.applyProjection(xo,lv),lv[0]>-1){let L=Math.floor(lv[0])+this.parameters.screenOffset[0],U=Math.floor(lv[1])+this.parameters.screenOffset[1];w&&(L+=Qu[0],Qu[1]!==0&&(U+=sW(Qu[1],_k.factorAlignment))),f0e(gg,_k.factor,gg);const N=FWe*v.pixelRatio;let z;if(a.textureIsSignedDistanceField&&(z=a.outlineSize*v.pixelRatio/2),Mte(y,L,U,gg,N,z,a,b)){const V=s.ray;if(ke(Pte,xo,fr(NWe,v.viewMatrix)),lv[0]=y[0],lv[1]=y[1],v.unprojectFromRenderScreen(lv,xo)){const B=M();ne(B,V.direction);const J=1/Pe(B);ae(B,B,J),n(xi(V.origin,xo)*J,B,-1,!0,1,Pte)}}}}}computeAttachmentOrigin(t,i){const r=t.vertexAttributes;if(!r)return!1;const s=r.get(E.POSITION),n=t.indices.get(E.POSITION);return Jge(s,n,i)}createBufferWriter(){return new VWe(this)}_normalAndViewAngle(t,i,r,s){return Aqe(i)&&(i=Lu(LWe,i)),al(s.normal,t,i),ke(s.normal,s.normal,r.viewInverseTransposeMatrix),s.cosAngle=_e(V0e,kWe),s}_updateScaleInfo(t,i,r){const s=this.parameters;s.screenSizePerspective?Ate(r,i,s.screenSizePerspective,t.factor):(t.factor.scale=1,t.factor.factor=0,t.factor.minPixelSize=0,t.factor.paddingPixels=0),s.screenSizePerspectiveAlignment?Ate(r,i,s.screenSizePerspectiveAlignment,t.factorAlignment):(t.factorAlignment.factor=t.factor.factor,t.factorAlignment.scale=t.factor.scale,t.factorAlignment.minPixelSize=t.factor.minPixelSize,t.factorAlignment.paddingPixels=t.factor.paddingPixels)}applyShaderOffsetsView(t,i,r,s,n,o,a){const l=this._normalAndViewAngle(i,r,n,wk);return this._applyVerticalGroundOffsetView(t,l,n,a),this._applyVerticalOffsetTransformationView(a,l,n,o),this._applyPolygonOffsetView(a,l,s[3],n,a),this._applyCenterOffsetView(a,s,a),a}applyShaderOffsetsNDC(t,i,r,s,n){return this._applyCenterOffsetNDC(t,i,r,s),_(n)&&ne(n,s),this._applyPolygonOffsetNDC(s,i,r,s),s}_applyPolygonOffsetView(t,i,r,s,n){const o=s.aboveGround?1:-1;let a=Math.sign(r);a===0&&(a=o);const l=o*a;if(this.parameters.shaderPolygonOffset<=0)return ne(n,t);const c=Be(Math.abs(i.cosAngle),.01,1),h=1-Math.sqrt(1-c*c)/c/s.viewport[2];return ae(n,t,l>0?h:1/h),n}_applyVerticalGroundOffsetView(t,i,r,s){const n=Pe(t),o=r.aboveGround?1:-1,a=.5*r.computeRenderPixelSizeAtDist(n),l=ae(xo,i.normal,o*a);return pe(s,t,l),s}_applyVerticalOffsetTransformationView(t,i,r,s){const n=this.parameters;if(!n.verticalOffset||!n.verticalOffset.screenLength){if(n.screenSizePerspective||n.screenSizePerspectiveAlignment){const c=Pe(t);this._updateScaleInfo(s,c,i.cosAngle)}else s.factor.scale=1,s.factorAlignment.scale=1;return t}const o=Pe(t),a=n.screenSizePerspectiveAlignment||n.screenSizePerspective,l=_0e(r,o,n.verticalOffset,i.cosAngle,a);return this._updateScaleInfo(s,o,i.cosAngle),ae(i.normal,i.normal,l),pe(t,t,i.normal)}_applyCenterOffsetView(t,i,r){const s=this.parameters.centerOffsetUnits!=="screen";return r!==t&&ne(r,t),s&&(r[0]+=i[0],r[1]+=i[1],i[2]&&(be(G2,r),pe(r,r,ae(G2,G2,i[2])))),r}_applyCenterOffsetNDC(t,i,r,s){const n=this.parameters.centerOffsetUnits!=="screen";return s!==t&&ne(s,t),n||(s[0]+=i[0]/r.fullWidth*2,s[1]+=i[1]/r.fullHeight*2),s}_applyPolygonOffsetNDC(t,i,r,s){const n=this.parameters.shaderPolygonOffset;if(t!==s&&ne(s,t),n){const o=r.aboveGround?1:-1,a=o*Math.sign(i[3]);s[2]-=(a||o)*n}return s}requiresSlot(t){if(t===ve.DRAPED_MATERIAL)return!0;const{drawInSecondSlot:i,occlusionTest:r}=this.parameters;return t===(i?ve.LABEL_MATERIAL:ve.HUD_MATERIAL)||r&&t===ve.OCCLUSION_PIXELS}createGLMaterial(t){return t.output===j.Color||t.output===j.Alpha?new PWe(t):t.output===j.Highlight?new B0e(t):null}calculateRelativeScreenBounds(t,i,r=Dt()){return IWe(this.parameters,t,i,r),r[2]=r[0]+t[0],r[3]=r[1]+t[1],r}}class B0e extends lW{constructor(t){super(I(I({},t),t.material.parameters))}updateParameters(t){return this.updateTexture(this._material.parameters.textureId),this.selectProgram(t)}selectProgram(t){return this.ensureTechnique(kO,t)}beginSlot(t){return this.updateParameters(t)}bind(t,i){this.bindTextures(i.program),this.bindTextureScale(i.program),i.bindPass(this._material.parameters,t)}}class PWe extends B0e{_isOcclusionSlot(t){return t.slot===ve.OCCLUSION_PIXELS&&this._material.parameters.occlusionTest&&(this._output===j.Color||this._output===j.Alpha)}selectProgram(t){return this.ensureTechnique(kO,t,this._isOcclusionSlot(t)?j.Occlusion:this._output)}bind(t,i){this._isOcclusionSlot(t)||(this.bindTextures(i.program),this.bindTextureScale(i.program)),i.bindPass(this._material.parameters,t)}}function IWe(e,t,i,r=DWe){return zs(r,e.anchorPos),r[0]*=-t[0],r[1]*=-t[1],r[0]+=e.screenOffset[0]*i,r[1]+=e.screenOffset[1]*i,r}function $We(e){const t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],o=e[5],a=e[6],l=e[7],c=e[8],h=1/Math.sqrt(t*t+i*i+r*r),p=1/Math.sqrt(s*s+n*n+o*o),f=1/Math.sqrt(a*a+l*l+c*c);return e[0]=t*h,e[1]=i*h,e[2]=r*h,e[3]=s*p,e[4]=n*p,e[5]=o*p,e[6]=a*f,e[7]=l*f,e[8]=c*f,e}function Mte(e,t,i,r,s,n,o,a){let l=t-s-(a[0]>0?r[0]*a[0]:0),c=l+r[0]+2*s,h=i-s-(a[1]>0?r[1]*a[1]:0),p=h+r[1]+2*s;if(o.textureIsSignedDistanceField){const f=o.distanceFieldBoundingBox;l+=r[0]*f[0],h+=r[1]*f[1],c-=r[0]*(1-f[2]),p-=r[1]*(1-f[3]),l-=n,c+=n,h-=n,p+=n}return e[0]>l&&e[0]<c&&e[1]>h&&e[1]<p}const _k={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},DWe=Ye(),xo=M(),G2=M(),lv=zn(),V0e=M(),Pte=M(),bk=wr(),LWe=wr(),NWe=Te(),Qu=M(),wk={normal:V0e,cosAngle:0},Ite=Te(),FWe=1,UWe=2,gg=[0,0],kWe=je(0,0,1),zWe=I({texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:vi(.5,.5),shaderPolygonOffset:1e-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",depthEnabled:!0,pixelSnappingEnabled:!0,debugDrawLabelBorder:!1,isDraped:!1},ju),BWe=kr().vec3f(E.POSITION).vec3f(E.NORMAL).vec2f(E.UV0).vec4u8(E.COLOR).vec2f(E.SIZE).vec4f(E.AUXPOS1).vec4f(E.AUXPOS2);class VWe{constructor(t){this.material=t,this.vertexBufferLayout=BWe}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return 6*t.indices.get(E.POSITION).length}write(t,i,r,s){FO(i.indices.get(E.POSITION),i.vertexAttributes.get(E.POSITION).data,t.transformation,r.position,s,6),cW(i.indices.get(E.NORMAL),i.vertexAttributes.get(E.NORMAL).data,t.invTranspTransformation,r.normal,s,6);{const n=i.vertexAttributes.get(E.UV0).data;let o,a,l,c;if(n==null||n.length<4){const g=this.material.parameters;o=0,a=0,l=g.texCoordScale[0],c=g.texCoordScale[1]}else o=n[0],a=n[1],l=n[2],c=n[3];l=Math.min(1.99999,l+1),c=Math.min(1.99999,c+1);const h=i.indices.get(E.POSITION).length,p=r.uv0;let f=s;for(let g=0;g<h;++g)p.set(f,0,o),p.set(f,1,a),f+=1,p.set(f,0,l),p.set(f,1,a),f+=1,p.set(f,0,l),p.set(f,1,c),f+=1,p.set(f,0,l),p.set(f,1,c),f+=1,p.set(f,0,o),p.set(f,1,c),f+=1,p.set(f,0,o),p.set(f,1,a),f+=1}kL(i.indices.get(E.COLOR),i.vertexAttributes.get(E.COLOR).data,4,r.color,s,6);{const n=i.indices.get(E.SIZE),o=i.vertexAttributes.get(E.SIZE).data,a=n.length,l=r.size;let c=s;for(let h=0;h<a;++h){const p=o[2*n[h]],f=o[2*n[h]+1];for(let g=0;g<6;++g)l.set(c,0,p),l.set(c,1,f),c+=1}}i.indices.get(E.AUXPOS1)&&i.vertexAttributes.get(E.AUXPOS1)&&xS(i.indices.get(E.AUXPOS1),i.vertexAttributes.get(E.AUXPOS1).data,r.auxpos1,s,6),i.indices.get(E.AUXPOS2)&&i.vertexAttributes.get(E.AUXPOS2)&&xS(i.indices.get(E.AUXPOS2),i.vertexAttributes.get(E.AUXPOS2).data,r.auxpos2,s,6)}}const pd=M(),Bb=ni(),j2=ni(),xk=M(),GWe=Te(),jWe=xn(),Tk=Vn(),HWe=M(),qWe=Dt();class WWe{constructor(){this.aabr=Dt(),this.distance=0,this.culled=!1,this.visible=!1}}class XWe{constructor(t,i,r={}){this.graphics3DGraphic=t,this.slicePlaneEnabled=i,this.info=r}}class YWe{constructor(){this.active=new Map,this.visible=new Map}clear(){this.active.clear(),this.visible.clear()}}class ZWe{}class QWe{constructor(){this.sortArray=new $t({allocator:t=>t||new ZWe})}}var Ya;(function(e){e[e.Idle=0]="Idle",e[e.Process=1]="Process",e[e.Sort=2]="Sort",e[e.Deconflict=3]="Deconflict",e[e.NumStates=4]="NumStates"})(Ya||(Ya={}));class G0e{constructor(){this.camera=new wi,this.slicePlane=pb(),this.slicePlaneEnabled=!1}copyFrom(t){this.camera.copyFrom(t.camera),HS(t.slicePlane,this.slicePlane),this.slicePlaneEnabled=t.slicePlaneEnabled}}let Ux=class extends we{constructor(){super(...arguments),this._dirty=!1,this._runningViewState=new G0e,this._state=Ya.Idle,this.graphics=new YWe,this.iterators=new QWe,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0}get dirty(){return this._dirty}get state(){return this._state}destroy(){this.graphics.clear(),this.iterators=null}setDirty(){!this._dirty&&this.graphics.active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==Ya.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const e=this._state/Ya.NumStates;return this._dirty?.5*e:e}get running(){return this.view.ready&&this.view.state!=null&&this.updating}runTask(e){switch(this._state){case Ya.Idle:this._startUpdate(),e.madeProgress();case Ya.Process:if(this._state=Ya.Process,!this._processActiveGraphics(e))return;case Ya.Sort:if(this._state=Ya.Sort,!this._sortVisibleGraphics(e))return;case Ya.Deconflict:if(this._state=Ya.Deconflict,!this._deconflictVisibleGraphics(e))return;default:mqe(this,this.graphics.visible),this._state=Ya.Idle,this.notifyChange("updating")}}modifyGraphics(e,t){t?e.forEach(i=>this.addToActiveGraphics(i)):e.forEach(i=>this.removeFromActiveGraphics(i)),this.setDirty()}layerSupportsDeconfliction(e){if(R(e)||e.type!=="object3d")return!1;const t=e.stageObject;return(t?t.geometryRecords.length:0)!==1?!1:t.geometryRecords[0].material instanceof TS}_startUpdate(){gqe(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._runningViewState.camera;this._initBins(e,t),this._resetIterators()}addToActiveGraphics(e){e.info[this.visibilityGroup]=new WWe,this.graphics.active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){this._removeFromVisibleGraphics(e),JWe(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this.graphics.active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}_addToVisibleGraphics(e){this.graphics.visible.set(e.graphics3DGraphic.graphic.uid,e)}_removeFromVisibleGraphics(e){this.graphics.visible.delete(e.graphics3DGraphic.graphic.uid)}_processActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),i=fr(GWe,this._runningViewState.camera.projectionMatrix),r=this.view.viewingMode==="global"&&this.view.map.ground.opacity===1&&this._runningViewState.camera.relativeElevation>0?jWe:null;let s=0;for(_(r)&&(ke(r,pl,this._runningViewState.camera.viewMatrix),r[3]=di(this.view.spatialReference).radius,s=Uue(r,pl));!e.done;){e.madeProgress();const n=t.next();if(n.done===!0)return this._resetActiveGraphicsIterator(),!0;const o=n.value,a=o&&o.info[this.visibilityGroup];a&&(this._collectGraphics3DGraphics(o,i,r,s),a.culled?this._removeFromVisibleGraphics(o):this._addToVisibleGraphics(o))}return!1}_sortVisibleGraphics(e){const t=this._ensureSortGraphicsIterator();for(;!e.done;){const i=t.next();if(e.madeProgress(),i.done===!0)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(e){const t=this._ensureVisibleGraphicsIterator(),i=this.visibilityGroup===mn.LABEL;for(;!e.done;){e.madeProgress();const r=t.next();if(r.done===!0)return this._resetVisibleGraphicsIterator(),!0;const s=r.value,n=s.info[this.visibilityGroup];if(!n||n.culled)continue;const o=s.graphics3DGraphic,a=(!i||o.isVisible())&&!this._isConflicted(s);a&&this._addToBins(s),n.visible=a,this._setGraphicVisibility(s,a),vqe(n,a)}return!1}_resetIterators(){this.iterators.active=null,this.iterators.visible=null,this.iterators.sort=null}_ensureActiveGraphicsIterator(){return this.iterators.active||(this.iterators.active=$te(this.graphics.active)),this.iterators.active}_resetActiveGraphicsIterator(){this.iterators.active=null}_ensureVisibleGraphicsIterator(){return this.iterators.visible||(this.iterators.visible=$te(this.graphics.visible)),this.iterators.visible}_resetVisibleGraphicsIterator(){this.iterators.visible=null}_ensureSortGraphicsIterator(){return this.iterators.sort||(this.iterators.sort=KWe(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup)),this.iterators.sort}_resetSortGraphicsIterator(){this.iterators.sort=null}_collectGraphics3DGraphics(e,t,i,r){const s=e.graphics3DGraphic;if(s.destroyed)return;const n=e.info[this.visibilityGroup];if(!s.isVisible(mn.GRAPHIC,ac.DECONFLICTION))return void(n.culled=!0);const o=this.getGraphicsLayers(s);$u(n.aabr);let a=null;for(const l of o){if(!this.layerSupportsDeconfliction(l))continue;const c=l.stageObject.geometryRecords[0].material;if(R(a)){if(a=this._getProjectionInfo(l,t,iXe),a.isOutsideScreen||this._isCulledBySlice(e,pd)||_(i)&&this._isCulledByHorizon(a,i,r))return void(n.culled=!0);!hi.TESTS_DISABLE_OPTIMIZATIONS&&n.visible&&(a.distance*=.7)}this._expandBoundingRect(n,l,c,a)}R(a)?n.culled=!0:(n.distance=a.distance,n.culled=!1)}_getProjectionInfo(e,t,i){const r=this._runningViewState.camera,s=e.stageObject,n=s.geometryRecords[0],o=n.material,a=Tc(s.boundingVolumeWorldSpace.bounds);ke(pd,a,r.viewMatrix);const l=n.geometry.vertexAttributes,c=l.get(E.NORMAL).data,h=l.get(E.AUXPOS1).data;return o.applyShaderOffsetsView(pd,c,s.transformation,h,r,i.scaleInfo,pd),Ho(Bb,pd[0],pd[1],pd[2],1),Ou(j2,Bb,r.projectionMatrix),ae(i.positionNDC,j2,1/j2[3]),o.applyShaderOffsetsNDC(i.positionNDC,h,r,i.positionNDC,xk),i.distanceWithoutPolygonOffset=r.depthNDCToWorld(xk[2]),i.distance=xk[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:r.depthNDCToWorld(i.positionNDC[2]),Ho(j2,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),Ou(Bb,j2,t),JR(Bb,Bb,1/Bb[3]),oe(i.positionView,pd[0],pd[1],pd[2]),i}_isCulledByHorizon(e,t,i){return ne(Tk.direction,e.positionView),oe(Tk.origin,0,0,0),!!B0(t,Tk,HWe)&&e.distanceWithoutPolygonOffset>i}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&qj(this._runningViewState.slicePlane,t)}_expandBoundingRect(e,t,i,{positionNDC:r,scaleInfo:s}){const n=this._runningViewState.camera,o=t.getScreenSize(eXe);f0e(o,s.factor,o),o[0]*=n.pixelRatio,o[1]*=n.pixelRatio;const a=SD(i.calculateRelativeScreenBounds(o,s.factorAlignment.scale,qWe),qt(0,n.fullWidth,.5+.5*r[0]),qt(0,n.fullHeight,.5+.5*r[1])),l=this.iconMarginFactor;if(l!==0){const c=l*Math.min(tm(a),A1(a));a[0]-=c,a[1]-=c,a[2]+=c,a[3]+=c}n0(e.aabr,a,e.aabr)}_isConflicted(e){const t=e.graphics3DGraphic.graphic.uid,i=e.info[this.visibilityGroup];for(let r=Math.floor(i.aabr[0]/this.accBinsSizeX);r<=Math.floor(i.aabr[2]/this.accBinsSizeX);r++)if(!(r<0||r>=this.accBinsNumX))for(let s=Math.floor(i.aabr[1]/this.accBinsSizeY);s<=Math.floor(i.aabr[3]/this.accBinsSizeY);s++){if(s<0||s>=this.accBinsNumY)continue;const n=this.accBins[r][s];for(let o=0;o<n.length;o++){const a=n.data[o],l=a.info[this.visibilityGroup];if(l&&l.visible&&a.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,VN(l.aabr,i.aabr)))return!0}}return!1}_initBins(e,t){if(this.accBins==null){this.accBins=[];for(let i=0;i<this.accBinsNumX;i++){this.accBins.push([]);const r=this.accBins[this.accBins.length-1];for(let s=0;s<this.accBinsNumY;s++)r.push(new $t)}}else for(let i=0;i<this.accBinsNumX;i++)for(let r=0;r<this.accBinsNumY;r++)this.accBins[i][r].clear();this.accBinsSizeX=e/this.accBinsNumX,this.accBinsSizeY=t/this.accBinsNumY,this.accNumTests=0}_addToBins(e){const t=e.info[this.visibilityGroup],i=Math.floor(t.aabr[0]/this.accBinsSizeX),r=Math.floor(t.aabr[2]/this.accBinsSizeX),s=Math.floor(t.aabr[1]/this.accBinsSizeY),n=Math.floor(t.aabr[3]/this.accBinsSizeY);for(let o=i;o<=r;o++)if(!(o<0||o>=this.accBinsNumX))for(let a=s;a<=n;a++)a<0||a>=this.accBinsNumY||this.accBins[o][a].push(e)}_setGraphicVisibility(e,t){const i=e.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(ac.DECONFLICTION,t,this.visibilityGroup),this.visibilityGroup===mn.LABEL&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function JWe(e,t){const i=e.graphics3DGraphic;i.destroyed||i.clearVisibilityFlag(ac.DECONFLICTION,t)}function*$te(e){if(Map.prototype.entries){const t=e.entries();for(let i=t.next();!i.done;i=t.next())yield i.value[1]}else yield*e.values()}function*KWe(e,t,i){t.clear(),e.forEach((s,n)=>{const o=t.pushNew();o.id=n,o.prio=s.info?-s.info[i].distance:Number.MAX_VALUE}),yield;const r=t.iterableSort((s,n)=>n.prio-s.prio);for(let s=r.next();!s.done;s=r.next())yield;t.forAll(s=>{const n=e.get(s.id);n&&(e.delete(s.id),e.set(s.id,n))}),t.clear()}u([d({constructOnly:!0})],Ux.prototype,"view",void 0),u([d({type:Boolean,readOnly:!0})],Ux.prototype,"updating",null),Ux=u([P("esri.views.3d.layers.graphics.Deconflictor")],Ux);const eXe=Ye();class tXe{constructor(){this.positionView=M(),this.positionNDC=M(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}get isOutsideScreen(){const t=this.positionNDC;return t[0]<-1||t[1]<-1||t[2]<-1||t[0]>=1||t[1]>=1}}const iXe=new tXe,rXe=2e3;let w$=class extends Ux{constructor(){super(...arguments),this.visibilityGroup=mn.LABEL,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return;const t=performance.now();(e.state===Ws.IDLE||t-this._lastDeconfliction>rXe)&&(super.runTask(e),this.state===Ya.Idle&&(this._lastDeconfliction=t))}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelGraphics}};u([d({constructOnly:!0})],w$.prototype,"parent",void 0),w$=u([P("esri.views.3d.layers.graphics.LabelDeconflictor")],w$);let Z9=class extends Ux{constructor(){super(...arguments),this._handles=new Ut,this._contexts=new Map,this._viewState=new G0e,this.visibilityGroup=mn.GRAPHIC,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([this.view.watch("state.camera",()=>{this._updateViewState(),this.setDirty()}),this.view.watch("map.ground.opacity",(e,t)=>{e!==1&&t!==1||this.setDirty()}),Wt(this.view,"slicePlane",()=>{this._updateSlicePlane(),this._slicePlaneChanged()})]),this._frameTask=this.view.resourceController.scheduler.registerTask(ht.GRAPHICS_DECONFLICTOR,this),this._labels=new w$({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&Sk(e));t.setVisibilityFlag(ac.DECONFLICTION,i,mn.GRAPHIC)}_updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;_(e)&&Kue(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=_(e)}_slicePlaneChanged(){qr(this._contexts,(e,t)=>t.symbolCreationContext.slicePlaneEnabled)&&this.setDirty()}addGraphicsOwner(e){let t=this._contexts.get(e);return t==null&&(t=new Map,this._contexts.set(e,t),this.setDirty()),{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:i=>this._removeGraphic(t,i),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach(i=>this._removeGraphic(t,i.graphics3DGraphic))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach(i=>this._removeGraphic(t,i.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const r=i.graphic.uid,s=new XWe(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,s),Sk(e)&&this.addToActiveGraphics(s),e.labelsEnabled&&this._labels.addToActiveGraphics(s)}_removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=Sk(e);i||sXe(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach(r=>r.slicePlaneEnabled=i),this.setDirty()}getGraphicsLayers(e){return e.graphics}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.graphics;if(!t||!t.length)return!1;for(const i of t)if(this.layerSupportsDeconfliction(i))return!0;return!1}};function Sk(e){const t=e.layer;return!(!t||!t.featureReduction||t.featureReduction.type!=="selection")}function sXe(e){const t=e.graphics3DGraphics;t&&t.forEach(i=>i.clearVisibilityFlag(ac.DECONFLICTION))}Z9=u([P("esri.views.3d.layers.graphics.GraphicsDeconflictor")],Z9);const mW=(e,t,i)=>[t,i],SS=(e,t,i)=>[t,i,e[2]],gW=(e,t,i)=>[t,i,e[2],e[3]];function _yt(e){return e?{originPosition:e.originPosition==="upper-left"?"upperLeft":e.originPosition==="lower-left"?"lowerLeft":e.originPosition,scale:e.tolerance?[e.tolerance,e.tolerance]:[1,1],translate:_(e.extent)?[e.extent.xmin,e.extent.ymax]:[0,0]}:null}function j0e({scale:e,translate:t},i){return i*e[0]+t[0]}function H0e({scale:e,translate:t},i){return t[1]-i*e[1]}function q0e(e,t,i){const r=new Array(i.length);if(!i.length)return r;const[s,n]=e.scale;let o=j0e(e,i[0][0]),a=H0e(e,i[0][1]);r[0]=t(i[0],o,a);for(let l=1;l<i.length;l++){const c=i[l];o+=c[0]*s,a-=c[1]*n,r[l]=t(c,o,a)}return r}function W0e(e,t,i){const r=new Array(i.length);for(let s=0;s<i.length;s++)r[s]=q0e(e,t,i[s]);return r}function nXe(e,t,i,r){return q0e(e,i?r?gW:SS:r?SS:mW,t)}function oXe(e,t,i,r){return W0e(e,i?r?gW:SS:r?SS:mW,t)}function aXe(e,t,i,r){return W0e(e,i?r?gW:SS:r?SS:mW,t)}function X0e(e,t,i,r,s){return _(i)&&(t.points=nXe(e,i.points,r,s)),t}function Y0e(e,t,i,r,s){return R(i)||(t.x=j0e(e,i.x),t.y=H0e(e,i.y),t!==i&&(r&&(t.z=i.z),s&&(t.m=i.m))),t}function Z0e(e,t,i,r,s){return _(i)&&(t.rings=aXe(e,i.rings,r,s)),t}function Q0e(e,t,i,r,s){return _(i)&&(t.paths=oXe(e,i.paths,r,s)),t}function J0e(e,t){if(e===t)return!0;if(e==null||t==null||e.length!==t.length)return!1;for(let i=0;i<e.length;i++){const r=e[i],s=t[i];if(r.length!==s.length)return!1;for(let n=0;n<r.length;n++)if(r[n]!==s[n])return!1}return!0}function K0e(e,t){if(e===t)return!0;if(e==null||t==null||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!J0e(e[i],t[i]))return!1;return!0}function lXe(e,t){return!!zO(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}function cXe(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!zO(e.spatialReference,t.spatialReference)&&K0e(e.paths,t.paths)}function uXe(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!zO(e.spatialReference,t.spatialReference)&&K0e(e.rings,t.rings)}function hXe(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!zO(e.spatialReference,t.spatialReference)&&J0e(e.points,t.points)}function dXe(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!zO(e.spatialReference,t.spatialReference)&&e.xmin===t.xmin&&e.ymin===t.ymin&&e.zmin===t.zmin&&e.xmax===t.xmax&&e.ymax===t.ymax&&e.zmax===t.zmax}function zO(e,t){return e===t||e&&t&&e.equals(t)}function pXe(e,t){if(e===t)return!0;if(R(e)||R(t)||e.type!==t.type)return!1;switch(e.type){case"point":return lXe(e,t);case"extent":return dXe(e,t);case"polyline":return cXe(e,t);case"polygon":return uXe(e,t);case"multipoint":return hXe(e,t);case"mesh":return!1;default:return}}function fXe(e,t){if(e===t)return!0;if(!e||!t)return!1;const i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;for(const s of i)if(e[s]!==t[s])return!1;return!0}function byt(e,t){return e===t||e!=null&&t!=null&&e.objectId===t.objectId&&!!pXe(e.geometry,t.geometry)&&!!fXe(e.attributes,t.attributes)}class wyt{constructor(t,i,r){this.uid=t,this.geometry=i,this.attributes=r,this.visible=!0,this.objectId=null,this.centroid=null}}function xyt(e){return _(e.geometry)}class Tyt{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}}function Syt(e){const t=Zae.fromJSON(e.geometryType),i=He.fromJSON(e.spatialReference),r=e.transform,s=e.features.map(n=>{const o=mXe(n,t,i,e.objectIdFieldName),a=o.geometry;if(_(a)&&r)switch(a.type){case"point":o.geometry=Y0e(r,a,a,a.hasZ,a.hasM);break;case"multipoint":o.geometry=X0e(r,a,a,a.hasZ,a.hasM);break;case"polygon":o.geometry=Z0e(r,a,a,a.hasZ,a.hasM);break;case"polyline":o.geometry=Q0e(r,a,a,a.hasZ,a.hasM);break;case"extent":case"mesh":o.geometry=a}return o});return{geometryType:t,features:s,spatialReference:i,fields:e.fields?e.fields.map(n=>gO.fromJSON(n)):null,objectIdFieldName:e.objectIdFieldName,globalIdFieldName:e.globalIdFieldName,geohashFieldName:e.geohashFieldName,geometryProperties:e.geometryProperties,hasZ:e.hasZ,hasM:e.hasM,exceededTransferLimit:e.exceededTransferLimit,transform:null}}function mXe(e,t,i,r){return{uid:Ta(),objectId:r&&e.attributes?e.attributes[r]:null,attributes:e.attributes,geometry:gXe(e.geometry,t,i),visible:!0}}function gXe(e,t,i){if(R(e))return null;switch(t){case"point":{const r=e;return{x:r.x,y:r.y,z:r.z,m:r.m,hasZ:r.z!=null,hasM:r.m!=null,type:"point",spatialReference:i}}case"polyline":{const r=e;return{paths:r.paths,hasZ:!!r.hasZ,hasM:!!r.hasM,type:"polyline",spatialReference:i}}case"polygon":{const r=e;return{rings:r.rings,hasZ:!!r.hasZ,hasM:!!r.hasM,type:"polygon",spatialReference:i}}case"multipoint":{const r=e;return{points:r.points,hasZ:!!r.hasZ,hasM:!!r.hasM,type:"multipoint",spatialReference:i}}}}function eg(e,t,i,r){return{x:e,y:t,z:i,hasZ:i!=null,hasM:!1,spatialReference:r,type:"point"}}function yXe(e){if(R(e))return 0;let t=32;switch(e.type){case"point":t+=42;break;case"polyline":case"polygon":{let i=0;const r=2+(e.hasZ?1:0)+(e.hasM?1:0),s=e.type==="polyline"?e.paths:e.rings;for(const n of s)i+=n.length;t+=8*i*r+64,t+=128*i,t+=34,t+=32*(s.length+1);break}case"multipoint":{const i=2+(e.hasZ?1:0)+(e.hasM?1:0),r=e.points.length;t+=8*r*i+64,t+=128*r,t+=34,t+=32;break}case"extent":t+=98,e.hasM&&(t+=32),e.hasZ&&(t+=32);break;case"mesh":t+=nM(e.vertexAttributes.position),t+=nM(e.vertexAttributes.normal),t+=nM(e.vertexAttributes.uv),t+=nM(e.vertexAttributes.tangent)}return t}function Eyt(e){let t=32;return t+=yue(e.attributes),t+=3,t+=8+yXe(e.geometry),t}function vXe(e){if(R(e))return 0;switch(e.type){case"point":return 1;case"polyline":{let t=0;for(const i of e.paths)t+=i.length;return t}case"polygon":{let t=0;for(const i of e.rings)t+=i.length;return t}case"multipoint":return e.points.length;case"extent":return 2;case"mesh":{const t=e.vertexAttributes&&e.vertexAttributes.position;return t?t.length/3:0}default:return}}function Ayt(e){if(R(e))return!1;switch(e.type){case"extent":case"point":return!0;case"polyline":for(const t of e.paths)if(t.length>0)return!0;return!1;case"polygon":for(const t of e.rings)if(t.length>0)return!0;return!1;case"multipoint":return e.points.length>0;case"mesh":return!e.loaded||e.vertexAttributes.position.length>0}}function Cyt(e,t){switch(ki(t),e.type==="mesh"&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(let i=0;i<e.paths.length;i++)C5(t,e.paths[i],e.hasZ);break;case"polygon":for(let i=0;i<e.rings.length;i++)C5(t,e.rings[i],e.hasZ);break;case"multipoint":C5(t,e.points,e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,e.zmin!=null&&(t[2]=e.zmin),e.zmax!=null&&(t[5]=e.zmax)}}function _Xe(e,t){switch($u(t),e.type==="mesh"&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(let i=0;i<e.paths.length;i++)A5(t,e.paths[i]);break;case"polygon":for(let i=0;i<e.rings.length;i++)A5(t,e.rings[i]);break;case"multipoint":A5(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax}}function Ryt(e,t){return e.objectId!=null?e.objectId:e.attributes&&t?e.attributes[t]:null}cs();Dt();function eve(e){return"declaredClass"in e}function Dte(e){return"declaredClass"in e}function bXe(e){return"declaredClass"in e}function wXe(e,t){if(!e)return null;if(bXe(e))return e;const i=new qo({layer:t,sourceLayer:t});return i.visible=e.visible,i.symbol=se(e.symbol),i.attributes=se(e.attributes),i.geometry=tve(e.geometry),i}function tve(e){return R(e)?null:eve(e)?e:bp(xXe(e))}function xXe(e){const t=e.spatialReference.toJSON();switch(e.type){case"point":{const{x:i,y:r,z:s,m:n}=e;return{x:i,y:r,z:s,m:n,spatialReference:t}}case"polygon":{const{rings:i,hasZ:r,hasM:s}=e;return{rings:Lte(i),hasZ:r,hasM:s,spatialReference:t}}case"polyline":{const{paths:i,hasZ:r,hasM:s}=e;return{paths:Lte(i),hasZ:r,hasM:s,spatialReference:t}}case"extent":{const{xmin:i,xmax:r,ymin:s,ymax:n,zmin:o,zmax:a,mmin:l,mmax:c,hasZ:h,hasM:p}=e;return{xmin:i,xmax:r,ymin:s,ymax:n,zmin:o,zmax:a,mmin:l,mmax:c,hasZ:h,hasM:p,spatialReference:t}}case"multipoint":{const{points:i,hasZ:r,hasM:s}=e;return{points:rve(i)?ive(i):i,hasZ:r,hasM:s,spatialReference:t}}default:return}}function Lte(e){return TXe(e)?e.map(t=>ive(t)):e}function ive(e){return e.map(t=>tTe(t))}function TXe(e){for(const t of e)if(t.length!==0)return rve(t);return!1}function rve(e){return e.length&&(xoe(e[0])||Toe(e[0]))}function SXe(e,t){if(!e)return null;let i;if(Dte(e)){if(t==null)return e.clone();if(Dte(t))return t.copy(e)}return t!=null?(i=t,i.x=e.x,i.y=e.y,i.spatialReference=e.spatialReference,e.hasZ?(i.z=e.z,i.hasZ=e.hasZ):(i.z=null,i.hasZ=!1),e.hasM?(i.m=e.m,i.hasM=!0):(i.m=null,i.hasM=!1)):(i=eg(e.x,e.y,e.z,e.spatialReference),e.hasM&&(i.m=e.m,i.hasM=!0)),i}const EXe=he.getLogger("esri.layers.support.labelFormatUtils"),Nte={type:"simple",evaluate:()=>null},AXe={getAttribute:(e,t)=>e.field(t)};async function sve(e,t,i){if(!e||!e.symbol)return Nte;const r=e.where,s=UF(e),n=r?await import("./WhereClause.d621a470.js"):null;let o;if(s.type==="arcade"){const a=await U2e(s.expression,i,t);o={type:"arcade",evaluate(l){try{const c=a.evaluate({$feature:"attributes"in l?a.repurposeFeature(l):l});if(c!=null)return c.toString()}catch{EXe.error(new q("bad-arcade-expression","Encountered an error when evaluating label expression for feature",{feature:l,expression:s}))}return null},needsHydrationToEvaluate:()=>eq(s.expression)==null}}else o={type:"simple",evaluate:a=>s.expression.replace(/{[^}]*}/g,l=>{const c=l.slice(1,-1),h=t.get(c);if(!h)return l;let p=null;return"attributes"in a?a&&a.attributes&&(p=a.attributes[h.name]):p=a.field(h.name),p==null?"":nve(p,h)})};if(r){let a;try{a=n.WhereClause.create(r,t)}catch{return Nte}const l=o.evaluate;o.evaluate=c=>{const h="attributes"in c?void 0:AXe;return a.testFeature(c,h)?l(c):null}}return o}function nve(e,t){if(e==null)return"";const i=t.domain;if(i){if(i.type==="codedValue"||i.type==="coded-value"){const s=e;for(const n of i.codedValues)if(n.code===s)return n.name}else if(i.type==="range"){const s=+e,n="range"in i?i.range[0]:i.minValue,o="range"in i?i.range[1]:i.maxValue;if(n<=s&&s<=o)return i.name}}let r=e;return t.type==="date"||t.type==="esriFieldTypeDate"?r=Cm(r,X7("short-date")):DN(t)&&(r=Rm(+r)),r||""}var Oyt=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",createLabelFunction:sve,formatField:nve});function yW(e,t){if(e.type==="point")return yg(e,t,!1);if(eve(e))switch(e.type){case"extent":return yg(e.center,t,!1);case"polygon":return yg(e.centroid,t,!1);case"polyline":return yg(Fte(e),t,!0);case"mesh":return yg(e.origin,t,!1)}else switch(e.type){case"extent":return yg(CXe(e),t,!0);case"polygon":return yg(RXe(e),t,!0);case"polyline":return yg(Fte(e),t,!0)}}function Fte(e){const t=e.paths[0];if(!t||t.length===0)return null;const i=Lae(t,Dae(t)/2);return eg(i[0],i[1],i[2],e.spatialReference)}function CXe(e){const t=isFinite(e.zmin);return eg(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),t?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}function RXe(e){const t=e.rings[0];if(!t||t.length===0)return null;const i=Nae(e.rings,e.hasZ);return eg(i[0],i[1],i[2],e.spatialReference)}function yg(e,t,i){const r=i?e:SXe(e);return t&&e?AOe(e,r,t)?r:null:r}function Myt(e,t,i,r=0){if(e){t||(t=Dt());const s=e;let n=.5*s.width*(i-1),o=.5*s.height*(i-1);return s.width<1e-7*s.height?n+=o/20:s.height<1e-7*s.width&&(o+=n/20),Ho(t,s.xmin-n-r,s.ymin-o-r,s.xmax+n+r,s.ymax+o+r),t}return null}function ove(e,t){for(let i=0;i<e.geometries.length;++i){const r=e.geometries[i].getMutableAttribute(E.AUXPOS1);r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttrsUpdated(e.geometryRecords[i]))}}function gC(e,t){const i=aF(ap);return _(e)&&(i[0]=e[0],i[1]=e[1],i[2]=e[2]),_(t)?i[3]=t:_(e)&&e.length>3&&(i[3]=e[3]),i}function Pyt(e,t,i,r,s,n=[0,0,0,0]){for(let o=0;o<3;++o)_(e)&&e[o]!=null?n[o]=e[o]:_(i)&&i[o]!=null?n[o]=i[o]:n[o]=s[o];return _(t)?n[3]=t:_(r)?n[3]=r:n[3]=s[3],n}function Ute(e=up,t,i,r=1){const s=new Array(3);if(R(t)||R(i))s[0]=1,s[1]=1,s[2]=1;else{let n,o=0;for(let a=2;a>=0;a--){const l=e[a];let c;const h=l!=null,p=a===0&&!n&&!h,f=i[a];l==="symbol-value"||p?c=f!==0?t[a]/f:1:h&&l!=="proportional"&&isFinite(l)&&(c=f!==0?l/f:1),c!=null&&(s[a]=c,n=c,o=Math.max(o,Math.abs(c)))}for(let a=2;a>=0;a--)s[a]==null?s[a]=n:s[a]===0&&(s[a]=.001*o)}for(let n=2;n>=0;n--)s[n]/=r;return da(s)}function OXe(e){return e.isPrimitive!=null}function h4(e){return OXe(e)&&(e=[e.width,e.depth,e.height]),GL(e)?null:"Symbol sizes may not be negative values"}function GL(e){if(Array.isArray(e)){for(const t of e)if(!GL(t))return!1;return!0}return e==null||e>=0}function MXe(e,t,i,r=Te()){const s=e||0,n=t||0,o=i||0;return s!==0&&GT(r,r,-s/180*Math.PI),n!==0&&VT(r,r,n/180*Math.PI),o!==0&&iF(r,r,o/180*Math.PI),r}function vW(e,t){return t.minDemResolution!=null?t.minDemResolution:jN(e)?t.minDemResolutionForPoints:.01*KEe(e)}function ave(e,t,i,r,s,n,o,a,l,c,h){const p=UXe[h.mode];let f,g,y=0;if(br(e,t,i,r,l.spatialReference,s,a))return p.requiresAlignment(h)?(y=p.applyElevationAlignmentBuffer(r,s,n,o,a,l,c,h),f=n,g=o):(f=r,g=s),br(f,l.spatialReference,g,n,c.spatialReference,o,a)?y:void 0}function Dm(e,t,i,r,s){const n=(mL(e)?e.z:Sme(e)?e.array[e.offset+2]:e[2])||0;switch(i.mode){case"on-the-ground":{const o=gt(Vh(t,e,"ground"),0);return s.verticalDistanceToGround=0,s.sampledElevation=o,void(s.z=o)}case"relative-to-ground":{const o=gt(Vh(t,e,"ground"),0),a=i.geometryZWithOffset(n,r);return s.verticalDistanceToGround=a,s.sampledElevation=o,void(s.z=a+o)}case"relative-to-scene":{const o=gt(Vh(t,e,"scene"),0),a=i.geometryZWithOffset(n,r);return s.verticalDistanceToGround=a,s.sampledElevation=o,void(s.z=a+o)}case"absolute-height":{const o=i.geometryZWithOffset(n,r),a=gt(Vh(t,e,"ground"),0);return s.verticalDistanceToGround=o-a,s.sampledElevation=a,void(s.z=o)}default:return i.mode,void(s.z=0)}}function PXe(e,t,i,r){return Dm(e,t,i,r,kx),kx.z}function BO(e,t,i){return t==null||i==null?e.definedChanged:t==="on-the-ground"&&i==="on-the-ground"?e.staysOnTheGround:t===i||t!=="on-the-ground"&&i!=="on-the-ground"?_r.UPDATE:e.onTheGroundChanged}function zu(e){return e==="relative-to-ground"||e==="relative-to-scene"}function $0(e){return e!=="absolute-height"}function IXe(e,t,i,r,s){Dm(t,i,s,r,kx),ove(e,kx.verticalDistanceToGround);const n=kx.sampledElevation,o=Ur(kXe,e.transformation);return I3[0]=t.x,I3[1]=t.y,I3[2]=kx.z,Kh(t.spatialReference,I3,o,r.spatialReference)?e.transformation=o:console.warn("Could not locate symbol object properly, it might be misplaced"),n}function $Xe(e,t,i,r,s,n){let o=0;const a=n.spatialReference;t*=3,r*=3;for(let l=0;l<s;++l){const c=e[t+0],h=e[t+1],p=e[t+2],f=gt(n.getElevation(c,h,p,a,"ground"),0);o+=f,i[r+0]=c,i[r+1]=h,i[r+2]=f,t+=3,r+=3}return o/s}function DXe(e,t,i,r,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),h=a.featureExpressionInfoContext,p=n.spatialReference;t*=3,r*=3;for(let f=0;f<s;++f){const g=e[t+0],y=e[t+1],v=e[t+2],b=gt(n.getElevation(g,y,v,p,"ground"),0);l+=b,i[r+0]=g,i[r+1]=y,i[r+2]=h==null?v+b+c:b+c,t+=3,r+=3}return l/s}function LXe(e,t,i,r,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),h=a.featureExpressionInfoContext,p=n.spatialReference;t*=3,r*=3;for(let f=0;f<s;++f){const g=e[t+0],y=e[t+1],v=e[t+2],b=gt(n.getElevation(g,y,v,p,"scene"),0);l+=b,i[r+0]=g,i[r+1]=y,i[r+2]=h==null?v+b+c:b+c,t+=3,r+=3}return l/s}function NXe(e){const t=e.meterUnitOffset,i=e.featureExpressionInfoContext;return t!==0||i!=null}function FXe(e,t,i,r,s,n,o,a){const l=a.calculateOffsetRenderUnits(o),c=a.featureExpressionInfoContext;t*=3,r*=3;for(let h=0;h<s;++h){const p=e[t+0],f=e[t+1],g=e[t+2];i[r+0]=p,i[r+1]=f,i[r+2]=c==null?g+l:l,t+=3,r+=3}return 0}class VO{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}var _r;(function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"})(_r||(_r={}));const UXe={"absolute-height":{applyElevationAlignmentBuffer:FXe,requiresAlignment:NXe},"on-the-ground":{applyElevationAlignmentBuffer:$Xe,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:DXe,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:LXe,requiresAlignment:()=>!0}},kXe=Te(),kx=new VO,I3=M();function lve(e,t,i,r){const s=e.stageObject,n=s.geometryRecords;let o=0;for(const a of n){const{update:l,averageGeometrySampledElevation:c}=uve(a,t,i,r);o+=c,l&&s.geometryVertexAttrsUpdated(a)}return o/n.length}function IR(e,t,i,r){const s=e.stageObject,n=t.centerPointInElevationSR;let o=0;s.metadata.usesVerticalDistanceToGround?(Dm(n,i,t,r,ya),ove(s,ya.verticalDistanceToGround),o=ya.sampledElevation):(Dm(n,i,t,r,ya),t.mode!=="absolute-height"&&(o=ya.sampledElevation));const a=Ur(zXe,s.transformation),l=oe(cve,a[12],a[13],a[14]);hi.TESTS_DISABLE_OPTIMIZATIONS?(ga[0]=n.x,ga[1]=n.y,ga[2]=ya.z,Kh(n.spatialReference,ga,a,r.spatialReference)&&(s.transformation=a)):r.setAltitudeOfTransformation(ya.z,a);const c=_W/r.unitInMeters;return(Math.abs(a[12]-l[0])>=c||Math.abs(a[13]-l[1])>=c||Math.abs(a[14]-l[2])>=c)&&(s.transformation=a),o}const zXe=Te();function BXe(e,t,i,r){const s=e.graphics3DSymbolLayer.lodRenderer;if(R(s))return 0;const n=t.centerPointInElevationSR;Dm(n,i,t,r,ya);const o=t.mode!=="absolute-height"?ya.sampledElevation:0,a=s.instanceData,l=e.instanceIndex,c=GXe;a.getGlobalTransform(l,c);const h=oe(cve,c[12],c[13],c[14]);hi.TESTS_DISABLE_OPTIMIZATIONS?(ga[0]=n.x,ga[1]=n.y,ga[2]=ya.z,Kh(n.spatialReference,ga,c,r.spatialReference)&&a.setGlobalTransform(l,c)):r.setAltitudeOfTransformation(ya.z,c);const p=_W/r.unitInMeters;return(hi.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(c[12]-h[0])>=p||Math.abs(c[13]-h[1])>=p||Math.abs(c[14]-h[2])>=p)&&a.setGlobalTransform(l,c),o}function VXe(e,t,i,r){const s=e.stageObject,n=s.geometryRecords;if(n.length===0)return 0;let o=0,a=null,l=0,c=!1;for(const h of n){const p=h.geometry.vertexAttributes.get(E.POSITION);if(p!==a){const{update:f,averageGeometrySampledElevation:g}=uve(h,t,i,r);l=g,a=p,c=f}c&&s.geometryVertexAttrsUpdated(h),o+=l}return o/n.length}const _W=.01,ga=M(),Lc=M(),Vb=M(),GXe=Te(),cve=M(),ya=new VO;function uve(e,t,i,r){let s=!1;const n=i.spatialReference,o=e.geometry,a=e.getShaderTransformation(),l=t.requiresSampledElevationInfo;Lc[0]=a[12],Lc[1]=a[13],Lc[2]=a[14],o.invalidateBoundingInfo();const c=o.getMutableAttribute(E.POSITION),h=c.data,p=o.vertexAttributes.get(E.MAPPOS).data,f=c.size,g=h.length/f,y=new Tme(p,n);let v=0,b=0;for(let w=0;w<g;w++){if(Vb[0]=h[v],Vb[1]=h[v+1],Vb[2]=h[v+2],Dm(y,i,t,r,ya),l&&(b+=ya.sampledElevation),hi.TESTS_DISABLE_OPTIMIZATIONS)h[v]=y.array[y.offset],h[v+1]=y.array[y.offset+1],h[v+2]=ya.z,br(h,n,v,h,r.spatialReference,v,1),h[v]-=Lc[0],h[v+1]-=Lc[1],h[v+2]-=Lc[2],s=!0;else{ga[0]=h[v]+Lc[0],ga[1]=h[v+1]+Lc[1],ga[2]=h[v+2]+Lc[2],r.setAltitude(ga,ya.z),h[v]=ga[0]-Lc[0],h[v+1]=ga[1]-Lc[1],h[v+2]=ga[2]-Lc[2];const S=_W/r.unitInMeters;(Math.abs(Vb[0]-h[v])>=S||Math.abs(Vb[1]-h[v+1])>=S||Math.abs(Vb[2]-h[v+2])>=S)&&(s=!0)}v+=f,y.offset+=3}return b/=g,{update:s,averageGeometrySampledElevation:b}}const jXe=he.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function HXe(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}function Iyt(e){const t=e&&e.expression;if(typeof t=="string"){const i=pve(t);if(i!=null)return{cachedResult:i}}return null}async function $yt(e,t,i){const r=e&&e.expression;if(typeof r!="string")return null;const s=pve(r);if(s!=null)return{cachedResult:s};const n=await wp(),o=n.arcadeUtils,a=o.createSyntaxTree(r);return o.dependsOnView(a)?(i!=null&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:o.createFunction(a),context:o.createExecContext(null,{sr:t}),modules:n}}}function hve(e,t,i){return e.arcadeUtils.createFeature(t.attributes,t.geometry,i)}function bW(e,t){if(e!=null&&!dve(e)){if(!t||!e.arcade)return void jXe.errorOncePerTick("Arcade support required but not provided");const i=t;i._geometry&&(i._geometry=tve(i._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function qXe(e){if(e!=null){if(dve(e))return e.cachedResult;const t=e.arcade;let i=e.arcade.modules.arcadeUtils.executeFunction(t.func,t.context);return typeof i!="number"&&(e.cachedResult=0,i=0),i}return 0}function Dyt(e,t=!1){let i=e&&e.featureExpressionInfo;const r=i&&i.expression;return t||r==="0"||(i=null),i}const WXe={cachedResult:0};function dve(e){return e.cachedResult!=null}function pve(e){return e==="0"?0:null}class Mc{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(t){this._unit=t,this._metersPerElevationInfoUnit=oke(t)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(t){this._meterUnitOffset=t,this._renderUnitOffset=0}set offsetElevationInfoUnits(t){this._meterUnitOffset=t*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(t){this._renderUnitOffset+=t}geometryZWithOffset(t,i){const r=this.calculateOffsetRenderUnits(i);return this.featureExpressionInfoContext!=null?r:t+r}calculateOffsetRenderUnits(t){let i=this._meterUnitOffset;const r=this.featureExpressionInfoContext;return r!=null&&(i+=qXe(r)*this._metersPerElevationInfoUnit),i/t.unitInMeters+this._renderUnitOffset}setFromElevationInfo(t){this.mode=t.mode,this.unit=nke(t.unit)?t.unit:"meters",this.offsetElevationInfoUnits=gt(t.offset,0)}updateFeatureExpressionInfoContext(t,i,r){if(R(t))return void(this._featureExpressionInfoContext=null);const s=t&&t.arcade;s&&_(i)&&_(r)?(this._featureExpressionInfoContext=HXe(t),bW(this._featureExpressionInfoContext,hve(s.modules,i,r))):this._featureExpressionInfoContext=t}static fromElevationInfo(t){const i=new Mc;return _(t)&&i.setFromElevationInfo(t),i}}var Ct;(function(e){e[e.INVISIBLE=0]="INVISIBLE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OPAQUE=2]="OPAQUE"})(Ct||(Ct={}));class qp{constructor(t,i,r,s,n,o,a,l=null){this.graphics3DSymbolLayer=t,this.stageObject=i,this._uniqueGeometries=r,this._uniqueMaterials=s,this._sharedResource=n,this.elevationAligner=o,this.elevationContext=a,this._edgeState=l,this.type="object3d",this._stageLayer=null,this._stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1,this.graphics3DSymbolLayer=t,this.stageObject=i}get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}initialize(t,i){this._stageLayer=i,this._stage=t,t.addMany(this._uniqueMaterials),t.addMany(this._uniqueGeometries),t.add(this.stageObject)}destroy(){const t=this._stage;this._stageLayer&&(t.removeMany(this._uniqueMaterials),t.removeMany(this._uniqueGeometries)),t.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const i=this._stage.renderView.ensureEdgeView();i.hasObject(this.stageObject)&&i.removeObject(this.stageObject),this.stageObject.dispose(),_(this._sharedResource)&&this._sharedResource.release(),this._visible=!1,this._stageLayer=null,this._stage=null}layerOpacityChanged(t,i){if(R(this._edgeState))return;const r=kte(this._edgeState.baseMaterial);let s=!1;for(const n of this._edgeState.edgeMaterials)n.objectTransparency!==r&&(n.objectTransparency=r,s=!0);s&&this._resetEdgeObject(i),this._stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[t])}slicePlaneEnabledChanged(t,i){R(this._edgeState)||(this._stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{slicePlaneEnabled:t},!i),this._edgeState.properties.slicePlaneEnabled=t)}setVisibility(t){if(this._stage!=null&&this._visible!==t&&(this._visible=t,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this._stageLayer.add(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),_(this._edgeState))){const i=this._stage.renderView.ensureEdgeView();i.hasObject(this.stageObject)?i.updateObjectVisibility(this.stageObject,t):t&&this._addOrUpdateEdgeObject(i,!1)}}get visible(){return this._visible}alignWithElevation(t,i,r,s){this.elevationAligner!=null&&(_(r)&&bW(this.elevationContext.featureExpressionInfoContext,r),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,t,i),this._resetEdgeObject(s))}getCenterObjectSpace(t=M()){return ne(t,Tc(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(t=cs()){const i=this.stageObject.boundingVolumeObjectSpace;return Lle(t,i.min),Nle(t,i.max),t}computeAttachmentOrigin(t){if(this.useObjectOriginAsAttachmentOrigin){const i=this.stageObject.transformation;t.render.origin[0]+=i[12],t.render.origin[1]+=i[13],t.render.origin[2]+=i[14],t.render.num++}else for(const i of this.stageObject.geometryRecords)i.computeAttachmentOrigin(rf)&&(ke(rf,rf,this.stageObject.transformation),pe(t.render.origin,t.render.origin,rf),t.render.num++)}async getProjectedBoundingBox(t,i,r,s,n){const o=this.getBoundingBoxObjectSpace(n),a=XXe,l=jN(o)?1:a.length;for(let h=0;h<l;h++){const p=a[h];vg[0]=o[p[0]],vg[1]=o[p[1]],vg[2]=o[p[2]],ke(vg,vg,this.stageObject.transformation),cv[3*h+0]=vg[0],cv[3*h+1]=vg[1],cv[3*h+2]=vg[2]}if(!t(cv,0,l))return null;ki(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],cv[h+p]),o[p+3]=Math.max(o[p+3],cv[h+p]);c&&r.push({location:cv.slice(h,h+3),screenSpaceBoundingRect:c})}if(i&&i.service&&this.elevationContext.mode!=="absolute-height"){Fh(o,rf);const h=this.elevationContext.mode==="relative-to-scene"?"scene":"ground";let p=0;if(i.useViewElevation)p=gt(i.service.getElevation(rf[0],rf[1],h),0);else try{const f=vW(o,i);p=gt(await i.service.queryElevation(rf[0],rf[1],s,f,h),0)}catch{}Dle(o,0,0,-this.alignedSampledElevation+p)}return o}addObjectState(t,i){t===Im.Highlight&&i.addObject(this.stageObject,this.stageObject.highlight()),t===Im.MaskOccludee&&i.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(t){t.removeObject(this.stageObject)}_resetEdgeObject(t){if(R(this._edgeState))return;const i=this._stage.renderView.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(i,t):i.removeObject(this.stageObject)}_addOrUpdateEdgeObject(t,i){const r=this._edgeState;if(R(r))return;const s=kte(r.baseMaterial);for(const n of r.edgeMaterials)n.objectTransparency=s;t.addOrUpdateObject3D(this.stageObject,r.edgeMaterials,r.properties,!i).then(()=>{var n;return(n=this._stageLayer)==null?void 0:n.sync()})}}function kte(e){return e.isVisible?e.parameters.transparent?Ct.TRANSPARENT:Ct.OPAQUE:Ct.INVISIBLE}const cv=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],vg=M(),rf=M(),XXe=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];var Es;(function(e){e[e.Recreate_Symbol=0]="Recreate_Symbol",e[e.Recreate_Graphics=1]="Recreate_Graphics",e[e.Fast_Update=2]="Fast_Update"})(Es||(Es={}));class wW{constructor(t){this.schedule=t,this._loadStatus=ic.LOADING,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(t,i){return this._loadStatus===ic.LOADED?(t&&t(),this._loader):this._loadStatus===ic.FAILED?(i&&i(this._loadError),this._loader):(R(this._loader)&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=ic.LOADED},r=>{throw this._loadError=r,this._abortController=null,this._loadStatus=ic.FAILED,!pr(r)&&this.logger&&r.message&&this.logger.warn(r.message),r})),this._loader.then(t,i).catch(()=>{}),this._loader)}abortLoad(){_(this._abortController)?this._abortController=Iu(this._abortController):this._loadStatus===ic.LOADING&&(this._loadStatus=ic.FAILED),this._loader=null}}var ic;(function(e){e[e.LOADING=0]="LOADING",e[e.LOADED=1]="LOADED",e[e.FAILED=2]="FAILED"})(ic||(ic={}));function YXe(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}function fve(e,t){const i=(r,s,n=!1)=>({levels:r.map(o=>{const a=s(o.tesselation);return n&&Qa.cgToGIS(a),{components:[{geometry:a,material:t}],faceCount:a.indexCount/3,minScreenSpaceRadius:o.minScreenSpaceRadius}})});switch(e){case"sphere":return i([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],r=>Qa.createPolySphereGeometry(.5,r,!0));case"cube":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>Qa.createBoxGeometry(1));case"cone":return i(Ek,r=>Qa.createConeGeometry(1,.5,r,!1),!0);case"inverted-cone":return i(Ek,r=>Qa.createConeGeometry(1,.5,r,!0),!0);case"cylinder":return i(Ek,r=>Qa.createCylinderGeometry(1,.5,r,[0,0,1],[0,0,.5]));case"tetrahedron":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>Qa.createTetrahedronGeometry(1),!0);case"diamond":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>Qa.createDiamondGeometry(1),!0);default:return}}const Ek=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];function ZXe(e){return e.type==="fill"}function QXe(e){return e.type==="extrude"}function JXe(e){return e&&e.enabled&&(QXe(e)||ZXe(e))&&_(e.edges)}function KXe(e){return e&&e.enabled&&e.edges||null}function mve(e,t){return eYe(KXe(e),t)}function eYe(e,t){if(R(e))return null;const i=_(e.color)?Uj(Je.toUnitRGBA(e.color)):yi(0,0,0,0),r=fo(e.size),s=fo(e.extensionLength);switch(e.type){case"solid":return tYe(I({color:i,size:r,extensionLength:s},t));case"sketch":return iYe(I({color:i,size:r,extensionLength:s},t));default:return}}function tYe(e){return me(I(I({},rYe),e),{type:"solid"})}function iYe(e){return me(I(I({},sYe),e),{type:"sketch"})}const rYe={color:yi(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:Ct.OPAQUE},sYe={color:yi(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:Ct.OPAQUE};function $3(e){const t=[];return e.levels.forEach(i=>{i.components.forEach(r=>{t.push(r.material)})}),TN(t)}function nYe(e){const t=new Array;return e.levels.forEach(i=>{i.components.forEach(r=>{r.textures&&t.push(...r.textures)})}),TN(t)}function xW(e){const t=[];return e.components.forEach(i=>{t.push(i.geometry)}),TN(t)}function oYe(e){const t=[];return e.levels.forEach(i=>{i.components.forEach(r=>{t.push(r.geometry)})}),TN(t)}function aYe(e){return xW(e).reduce((t,i)=>t+i.indexCount/3,0)}const TW={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function Lyt(e){return e.type==="web-style"?TW:SW(e.symbolLayers.toArray().map(t=>gve(e,t)))}function SW(e){let t=0,i=0,r=0,s=!1,n=0;const o={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const a of e)R(a)||(t+=a.primitivesPerFeature,i+=a.primitivesPerCoordinate,r+=a.drawCallsPerFeature,o.bytesPerFeature+=a.memory.bytesPerFeature,o.bytesPerFeatureLabel+=a.memory.bytesPerFeatureLabel,o.bytesPerCoordinate+=a.memory.bytesPerCoordinate,o.draped.bytesPerFeature+=a.memory.bytesPerFeature,o.draped.bytesPerFeatureLabel+=a.memory.bytesPerFeatureLabel,o.draped.bytesPerCoordinate+=a.memory.bytesPerCoordinate,s=s||a.estimated,++n);return{primitivesPerFeature:t,primitivesPerCoordinate:i,drawCallsPerFeature:r,estimated:s,memory:o,numComplexities:n}}function Nyt(e){const t=SW(e);return t.numComplexities>0&&(t.primitivesPerFeature/=t.numComplexities,t.primitivesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.bytesPerCoordinate/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities,t.memory.draped.bytesPerCoordinate/=t.numComplexities),t}const zte={};function gve(e,t){const i=yve(e,t),r=JXe(t)?2:0;switch(t.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:r,estimated:!1,memory:i};case"fill":return e.type==="mesh-3d"?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:r,estimated:!1,memory:i}:_(t.outline)&&t.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:i}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:i};case"object":return t.resource&&t.resource.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:i}:me(I({},lYe(t.resource&&t.resource.primitive||nce)),{memory:i});case"path":{let a=0,l=0;switch(t.profile){case"circle":a=10;break;case"quad":a=4;break;default:return void(t.profile,void 0)}switch(t.join){case"round":l=3;break;case"miter":case"bevel":l=1;break;default:return void(t.join,void 0)}const c=2*a,h=a*l*2;let p=-2*h-c;switch(t.cap){case"none":break;case"butt":case"square":p+=2*(a-1);break;case"round":p+=2*(a*(3-1)*2+a);break;default:return}return{primitivesPerFeature:p,primitivesPerCoordinate:h+c,drawCallsPerFeature:0,estimated:!1,memory:i}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:i};default:return}}function yve(e,t){const i=e.type==="point-3d";switch(t.type){case"extrude":return t.edges&&t.edges.size>0?Zo.EXTRUDE_EDGES:Zo.EXTRUDE;case"fill":return _(t.outline)&&t.outline.size>0?Zo.FILL_OUTLINE:Zo.FILL;case"water":return Zo.FILL;case"line":return t.join==="round"?Zo.LINE_ROUND:Zo.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return Zo.PATH_ROUND_CIRCLE;case"quad":return Zo.PATH_ROUND_QUAD;default:return void(t.profile,void 0)}case"miter":case"bevel":switch(t.profile){case"circle":return Zo.PATH_MITER_CIRCLE;case"quad":return Zo.PATH_MITER_QUAD;default:return void(t.profile,void 0)}default:return void(t.join,void 0)}case"object":return i?Zo.OBJECT_POINT:Zo.OBJECT_POLYGON;case"icon":case"text":return i?Zo.ICON_POINT:Zo.ICON_POLYGON;default:return}}function lYe(e){let t=zte[e];if(t)return t;const i=fve(e,null);return t={primitivesPerFeature:xW(i.levels[0]).reduce((r,s)=>r+s.indices.get(E.POSITION).length/3,0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},zte[e]=t,t}const Zo={ICON_POINT:{bytesPerFeature:7127.413186968842,bytesPerFeatureLabel:4826.302896296296,bytesPerCoordinate:0,draped:{bytesPerFeature:3929.4396628895197,bytesPerFeatureLabel:3550.1332222222227,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:9329.452613976147,bytesPerFeatureLabel:3675.3372604938268,bytesPerCoordinate:60.177252982212096,draped:{bytesPerFeature:6190.247450139383,bytesPerFeatureLabel:3744.074358024691,bytesPerCoordinate:59.488211068026104}},OBJECT_POINT:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0,draped:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506,draped:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506}},LINE_MITER:{bytesPerFeature:7321.028181375921,bytesPerFeatureLabel:4048.0226716049388,bytesPerCoordinate:186.55621386363578,draped:{bytesPerFeature:4246.856619435009,bytesPerFeatureLabel:3852.3737679012347,bytesPerCoordinate:163.47884002621583}},LINE_ROUND:{bytesPerFeature:7482.205842738954,bytesPerFeatureLabel:4045.886987654321,bytesPerCoordinate:191.5452524171851,draped:{bytesPerFeature:4473.481387957992,bytesPerFeatureLabel:3842.1112395061728,bytesPerCoordinate:167.27703460226945}},PATH_MITER_CIRCLE:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275,draped:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275}},PATH_ROUND_CIRCLE:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957,draped:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957}},PATH_MITER_QUAD:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203,draped:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203}},PATH_ROUND_QUAD:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826,draped:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826}},FILL:{bytesPerFeature:9478.244183633637,bytesPerFeatureLabel:3713.816824691358,bytesPerCoordinate:95.9343604185578,draped:{bytesPerFeature:6287.911108168086,bytesPerFeatureLabel:3790.785032098766,bytesPerCoordinate:83.08783220478168}},FILL_OUTLINE:{bytesPerFeature:13085.871870349445,bytesPerFeatureLabel:3392.613241975309,bytesPerCoordinate:118.63968023169875,draped:{bytesPerFeature:8437.199992480122,bytesPerFeatureLabel:3973.5431172839503,bytesPerCoordinate:106.33556817014312}},EXTRUDE:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477,draped:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477}},EXTRUDE_EDGES:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312,draped:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312}}},D3=he.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class Wp extends wW{constructor(t,i,r,s){super(r.schedule),this._context=r,this._elevationInfoOverride=null,this._ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},this.complexity=null,this.logger=D3,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.symbol=t,this.symbolLayer=i,this._renderPriority=s.renderPriority,this._renderPriorityStep=s.renderPriorityStep,this._elevationContext=new Mc,this.complexity=this.computeComplexity(),this._ignoreDrivers=s.ignoreDrivers,this._ignoreDrivers||(this._drivenProperties=Bte(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}_drivenPropertiesChanged(t){if(this._ignoreDrivers)return!1;const i=this._drivenProperties,r=Bte(t);return r.color!==i.color||r.opacity!==i.opacity||r.opacityAlwaysOpaque!==i.opacityAlwaysOpaque||r.size!==i.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(t,i,r,s){const n=t.projectionSuccess,o="polygons"in t?t.polygons:null,a=`${s} geometry failed to be created`;let l=null;n?!i.length||i.length===1&&!i[0].length?l=`${a} (no ${r} were defined)`:Array.isArray(i)&&Array.isArray(i[0])?o&&o.length===0&&r==="rings"&&i.length>0&&i[0].length>2&&(l=`${a} (filled rings should use clockwise winding - try reversing the order of vertices)`):l=`${a} (${r} should be defined as a 2D array)`:l=`${a} (failed to project geometry to view spatial reference)`,l&&D3.warnOncePerTick(l)}_validateGeometry(t,i=null,r=null){if(_(i)&&!i.includes(t.type))return this.logger.warn("unsupported geometry type for "+r+` symbol: ${t.type}`),!1;if(t.type==="point"){const s=t;if(!isFinite(s.x)||!isFinite(s.y))return D3.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return cYe}_defaultElevationInfoZ(){return uYe}_updateElevationContext(){_(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(t){return t.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(t,i=this.getDefaultElevationInfo(t)){return this._elevationContext.mode||i.mode}setElevationInfoOverride(t){this._elevationInfoOverride=t,this._updateElevationContext()}setGraphicElevationContext(t,i){const r=t.geometry,s=this.getDefaultElevationInfo(r);i.unit=this._elevationContext.unit!=null?this._elevationContext.unit:s.unit,i.mode=this.getGeometryElevationMode(r,s),i.offsetMeters=gt(this._elevationContext.meterUnitOffset,gt(s.offset,0));const n=!this._elevationOptions.supportsOnTheGround&&i.mode==="on-the-ground";n&&(i.mode="relative-to-ground",i.offsetMeters=0);const o=n?WXe:this._elevationContext.featureExpressionInfoContext;return i.updateFeatureExpressionInfoContext(o,t,this._context.layer),i}prepareSymbolLayerPatch(t){}updateGeometry(t,i){return!1}onRemoveGraphic(t){}_getLayerOpacity(){if(this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner)return this._context.graphicsCoreOwner.fullOpacity;const t=this._context.layer.opacity;return t==null?1:t}_getCombinedOpacity(t,i=Vte){let r=1;return this.draped||(r*=this._getLayerOpacity()),this._drivenProperties.opacity||(_(t)?r*=t.a:i.hasIntrinsicColor||(r=0)),r}_getCombinedOpacityAndColor(t,i=Vte){const r=this._getCombinedOpacity(t,i);if(this._drivenProperties.color)return gC(null,r);const s=_(t)?Je.toUnitRGB(t):up;return gC(s,r)}_getVertexOpacityAndColor(t,i=null){const r=this._drivenProperties.color?t.color:null,s=this._drivenProperties.opacity?t.opacity:null,n=gC(r,s);return _(i)&&(n[0]*=i,n[1]*=i,n[2]*=i,n[3]*=i),n}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return gve(this.symbol,this.symbolLayer)}globalPropertyChanged(t,i,r){switch(t){case"opacity":return this.layerOpacityChanged(i,r);case"elevationInfo":{const s=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(i,r,s)!==_r.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(i,r);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(t,i,r){let s=_r.UPDATE;return t.forEach(n=>{const o=i(n);if(_(o)){const a=n.graphic;this.setGraphicElevationContext(a,o.elevationContext),o.needsElevationUpdates=r(o.elevationContext.mode)}else s=_r.RECREATE}),s}applyRendererDiff(t,i){return Es.Recreate_Symbol}getFastUpdateAttrValues(t){if(!this._fastUpdates.enabled)return null;const i=this._fastUpdates.visualVariables,r=i.size?_m(i.size.field,t):0,s=i.color?_m(i.color.field,t):0,n=i.opacity?_m(i.opacity.field,t):0;return yi(r,s,n,0)}get draped(){return this._draped}ensureDrapedStatus(t){return this._draped==null?(this._draped=t,!0):(t!==this.draped&&D3.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}}function _m(e,t){const i=e!=null?t.attributes[e]:0;return i!=null&&isFinite(i)?i:0}function Bte(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach(i=>{switch(i.type){case"color":if(t.color=!0,i.stops)for(let r=0;r<i.stops.length;r++){const s=i.stops[r].color;s&&(t.opacity=!0,s.a<1&&(t.opacityAlwaysOpaque=!1))}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0}}),t}const cYe={mode:"on-the-ground",offset:0,unit:"meters"},uYe={mode:"absolute-height",offset:0,unit:"meters"},Vte={hasIntrinsicColor:!1};class Y1{constructor(){this._disposed=!1}get disposed(){return this._disposed}get shaderTransformation(){return this._shaderTransformation}acquire(t,i,r,s,n,o){this.id=Ta(),this.geometry=t,this.material=i,this.transformation=r,this.instanceParameters=s,this.origin=n,this._shaderTransformation=o,this._disposed=!1}release(){this._disposed=!1}dispose(){this._disposed=!0}getStaticTransformation(){return this.transformation}getShaderTransformation(){return _(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}computeAttachmentOrigin(t){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,t):this.geometry.computeAttachmentOrigin(t))&&(ke(t,t,this.getStaticTransformation()),!0)}}Y1.pool=new Wr(Y1);class jL{constructor(t){this.channel=t,this.id=Ta()}}class tg extends PO{constructor(t={}){super(),this.type=rd.Object,this._geometryRecords=new Array,this._geometries=new Array,this._objectTransformation=Te(),this._bvObjectSpace=new Gte,this._bvWorldSpace=new Gte,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=t.castShadow==null||t.castShadow,this.metadata=t.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new vve),this.transformation=Te();const{geometries:i,materials:r,transformations:s,origins:n}=t;if(Array.isArray(i)){at(r.length===i.length,"Object3D: materials don't match geometries"),at(s.length===i.length,"Object3D: transformations don't match geometries"),this._geometryRecords.length=i.length,this._geometries.length=i.length;for(let o=0;o<i.length;o++)this._geometries[o]=i[o],this._geometryRecords[o]=Y1.pool.acquire(i[o],r[o],l1(s[o]),{highlights:null,occludees:null,visible:this._visible},n&&n[o])}}get geometryRecords(){return this._geometryRecords}get geometries(){return this._geometries}get transformation(){return this._objectTransformation}set transformation(t){Ur(this._objectTransformation,t),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}dispose(){this._geometryRecords.length=0,this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(t){at(this._parentLayer==null||t==null,"Object3D can only be added to a single Layer"),this._parentLayer=t}addGeometry(t,i,r,s,n){r=r||ls,this._geometries.push(t);const o=Y1.pool.acquire(t,i,r,{highlights:null,occludees:null,visible:this._visible},s,n);return this._geometryRecords.push(o),this._hasVolatileTransformation=this._hasVolatileTransformation||_(o.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:o}),this._invalidateBoundingVolume(),o}removeGeometry(t){const i=this._geometryRecords.splice(t,1)[0];return this._hasVolatileTransformation=_(i.shaderTransformation)?this._geometryRecords.some(r=>_(r.shaderTransformation)):this._hasVolatileTransformation,i.dispose(),this._geometries.splice(t,1),this._emit("objectGeometryRemoved",{object:this,record:i}),this._invalidateBoundingVolume(),i}removeAllGeometries(){for(;this.geometryRecords.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(t){this._emit("vertexAttrsUpdated",{object:this,record:t}),this._invalidateBoundingVolume()}get isVisible(){return this._visible}setVisible(t){if(this._visible!==t){this._visible=t;for(const i of this._geometryRecords)i.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const t=new jL(Im.MaskOccludee);for(const i of this._geometryRecords)i.instanceParameters.occludees=N9(i.instanceParameters.occludees,t);return this._emit("occlusionChanged",this),t}removeOcclude(t){for(const i of this._geometryRecords)i.instanceParameters.occludees=F9(i.instanceParameters.occludees,t);this._emit("occlusionChanged",this)}highlight(){const t=new jL(Im.Highlight);for(const i of this._geometryRecords)i.instanceParameters.highlights=N9(i.instanceParameters.highlights,t);return this._emit("highlightChanged",this),t}removeHighlight(t){for(const i of this._geometryRecords)i.instanceParameters.highlights=F9(i.instanceParameters.highlights,t);this._emit("highlightChanged",this)}getCombinedStaticTransformation(t,i){return dr(gt(i,Te()),this.transformation,t.getStaticTransformation())}_getCombinedShaderTransformation(t,i){return i=i||Te(),dr(i,this.transformation,t.getShaderTransformation()),i}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let s=0;s<this._geometryRecords.length;++s){const n=this._geometries[s],o=this._geometryRecords[s],a=n.boundingInfo;_(a)&&(this._calculateTransformedBoundingVolume(a,this._bvObjectSpace,o.getShaderTransformation()),this._calculateTransformedBoundingVolume(a,this._bvWorldSpace,this._getCombinedShaderTransformation(o)))}Cs(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),Cs(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const t=M(),i=M(),r=w1(this.transformation);for(let s=0;s<this._geometryRecords.length;++s){const n=this._geometries[s].boundingInfo;if(R(n))continue;const o=this._geometryRecords[s].getShaderTransformation(),a=w1(o);ke(t,n.getCenter(),o);const l=xi(t,this._bvObjectSpace.bounds),c=n.getBSRadius()*a;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],l+c),ke(i,t,this.transformation);const h=xi(i,this._bvWorldSpace.bounds),p=c*r;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],h+p)}this._bvDirty=!1}_calculateTransformedBoundingVolume(t,i,r){const s=t.getBBMin(),n=t.getBBMax(),o=As(s),a=As(n);ke(o,o,r),ke(a,a,r);for(let l=0;l<3;++l)i.min[l]=Math.min(i.min[l],o[l],a[l]),i.max[l]=Math.max(i.max[l],o[l],a[l]);for(let l=0;l<3;++l){ne(o,s),ne(a,n),o[l]=n[l],a[l]=s[l],ke(o,o,r),ke(a,a,r);for(let c=0;c<3;++c)i.min[c]=Math.min(i.min[c],o[c],a[c]),i.max[c]=Math.max(i.max[c],o[c],a[c])}}_invalidateBoundingVolume(){this._bvDirty=!0,_(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(t,i){_(this._parentLayer)&&this._parentLayer.events.emit(t,i)}get test(){const t=this;return{hasGeometry:i=>t._geometries.indexOf(i)>-1,getGeometryIndex:i=>t._geometries.indexOf(i)}}}class vve{constructor(){this.min=je(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=je(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class Gte extends vve{constructor(){super(...arguments),this.bounds=xn()}init(){oe(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),oe(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),Lue(this.bounds)}}const Ky=M();function EW(e,t,i,r,s,n,o,a){const l=i?i.length:0,c=e.clippingExtent;if(tn(t,Ky,e.elevationProvider.spatialReference),_(c)&&!tj(c,Ky))return null;tn(t,Ky,e.renderCoordsHelper.spatialReference);const h=e.localOriginFactory.getOrigin(Ky),p=new tg({castShadow:!1,metadata:{layerUid:n,graphicUid:o,usesVerticalDistanceToGround:!0}});for(let f=0;f<l;f++){const g=ls;p.addGeometry(i[f],r[f],g,h,a)}return{object:p,sampledElevation:IXe(p,t,e.elevationProvider,e.renderCoordsHelper,s)}}function $R(e,t,i){const r=e.elevationContext,s=i.spatialReference;tn(t,Ky,s),r.centerPointInElevationSR=eg(Ky[0],Ky[1],t.hasZ?Ky[2]:0,s)}function DR(e){switch(e.type){case"point":return e;case"polygon":case"extent":return yW(e);case"polyline":{const t=e.paths[0];if(!t||t.length===0)return null;const i=Lae(t,Dae(t)/2);return eg(i[0],i[1],i[2],e.spatialReference)}case"mesh":return e.origin}return null}function AW(){return new Float32Array(2)}function hYe(e){const t=new Float32Array(2);return t[0]=e[0],t[1]=e[1],t}function yu(e,t){const i=new Float32Array(2);return i[0]=e,i[1]=t,i}function dYe(e,t){return new Float32Array(e,t,2)}function _ve(){return AW()}function bve(){return yu(1,1)}function wve(){return yu(1,0)}function xve(){return yu(0,1)}const pYe=_ve(),fYe=bve(),mYe=wve(),gYe=xve();Object.freeze({__proto__:null,create:AW,clone:hYe,fromValues:yu,createView:dYe,zeros:_ve,ones:bve,unitX:wve,unitY:xve,ZEROS:pYe,ONES:fYe,UNIT_X:mYe,UNIT_Y:gYe});function yYe(e){const t=new Oi;return t.include($q),t.include(w0e,e),t.include(Or,e),t.attributes.add(E.UV0,"vec2"),t.vertex.uniforms.add("lineSize","float").add("pixelToNDC","vec2").add("borderSize","float").add("screenOffset","vec2"),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),e.multipassGeometryEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(x`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${e.occlusionTestEnabled?x`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${e.screenSizePerspectiveEnabled?x`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:x`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${e.multipassGeometryEnabled?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${e.depthHudEnabled?e.depthHudAlignStartEnabled?x`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:x`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.screenSizePerspectiveEnabled?x`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:x`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),t.fragment.uniforms.add("uColor","vec4"),t.fragment.uniforms.add("borderColor","vec4"),e.multipassGeometryEnabled&&(t.fragment.include(D0e,e),t.fragment.uniforms.add("inverseViewport","vec2")),t.fragment.code.add(x`
    void main() {
      ${e.multipassGeometryEnabled?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = uColor.a * borderColor.a * coverage.y;
      float colorAlpha = uColor.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${e.depthHudEnabled?x`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:x`
      // Compute the finalRgb, but keep it pre-multiplied (for unpre-multiplied you
      // need to divide by finalAlpha). We avoid the division here by setting the
      // appropriate blending function in the material.
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),t}function Tve(e,t,i){jte(e,"uColor",t.color),e.setUniform1f("pixelRatio",i),e.setUniform2f("screenOffset",t.screenOffset[0]*i,t.screenOffset[1]*i),t.borderColor!==null?(jte(e,"borderColor",t.borderColor),e.setUniform1f("borderSize",i)):(e.setUniform4f("borderColor",0,0,0,0),e.setUniform1f("borderSize",0))}function jte(e,t,i){i.length===3?e.setUniform4f(t,i[0],i[1],i[2],1):e.setUniform4fv(t,i)}const vYe=Object.freeze({__proto__:null,build:yYe,bindLineCalloutUniforms:Tve});class d4 extends Gi{initializeProgram(t){const i=d4.shader.get(),r=this.configuration,s=i.build({occlusionTestEnabled:r.occlusionTestEnabled,verticalOffsetEnabled:r.verticalOffset,screenSizePerspectiveEnabled:r.screenSizePerspective,depthHudEnabled:r.depthHudEnabled,depthHudAlignStartEnabled:r.depthHudAlignStartEnabled,screenCenterOffsetUnitsEnabled:r.screenCenterOffsetUnitsEnabled,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,viewingMode:t.viewingMode,isDraped:!1,multipassGeometryEnabled:r.multipassGeometryEnabled});return new Mi(t.rctx,s,mi)}bindPass(t,i){Ol(this.program,i.camera.projectionMatrix),Tve(this.program,t,i.camera.pixelRatio||1),fW(this.program,t,i),x0e(this.program,i),this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),L0e(this.program,i),this.program.bindTexture(i.hudVisibilityTexture,"hudVisibilityTexture"),this.program.setUniform1f("cameraGroundRelative",i.camera.aboveGround?1:-1),this.program.setUniform1f("polygonOffset",t.shaderPolygonOffset),Wge(this.program,i),this.program.setUniform1f("perDistancePixelRatio",Math.tan(i.camera.fovY/2)/(i.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",i.camera.viewInverseTransposeMatrix),this.program.setUniform2f("pixelToNDC",2/i.camera.fullViewport[2],2/i.camera.fullViewport[3]);const r=i.camera.pixelRatio||1;this.program.setUniform1f("lineSize",Math.ceil(t.size)*r),MR(t.screenSizePerspective,this.program,"screenSizePerspectiveAlignment")}bindDraw(t){Gp(this.program,t),j0(this.program,t.origin,t.camera.viewInverseTransposeMatrix),wb(this.program,this.configuration,t),this.program.rebindTextures()}setPipelineState(t){const i=t?Li.ALWAYS:Li.LESS;return this.configuration.depthHudEnabled?Ot({depthTest:{func:i},depthWrite:Ma}):Ot({blending:Xn(Ee.ONE,Ee.SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:i},colorWrite:Ft})}initializePipeline(){return this.setPipelineState(this.configuration.multipassGeometryEnabled)}}d4.shader=new Ni(vYe,()=>import("./LineCallout.glsl.e14f8126.js"));class Lf extends mr{constructor(){super(...arguments),this.occlusionTestEnabled=!0,this.verticalOffset=!1,this.screenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.screenCenterOffsetUnitsEnabled=hl.World,this.slicePlaneEnabled=!1,this.multipassGeometryEnabled=!1}}u([Z()],Lf.prototype,"occlusionTestEnabled",void 0),u([Z()],Lf.prototype,"verticalOffset",void 0),u([Z()],Lf.prototype,"screenSizePerspective",void 0),u([Z()],Lf.prototype,"depthHudEnabled",void 0),u([Z()],Lf.prototype,"depthHudAlignStartEnabled",void 0),u([Z({count:hl.COUNT})],Lf.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([Z()],Lf.prototype,"slicePlaneEnabled",void 0),u([Z()],Lf.prototype,"multipassGeometryEnabled",void 0);class J_ extends od{constructor(t){super(t,bYe),this.techniqueConfig=new Lf,this._uniqueMaterialIdentifier=J_.uniqueMaterialIdentifier(this.parameters)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}getPassParameters(){return this.parameters}getTechniqueConfig(t,i){const r=(i==null?void 0:i.slot)!==ve.LINE_CALLOUTS;return this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.verticalOffset=!!this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.parameters.screenSizePerspective,this.techniqueConfig.depthHudEnabled=r,this.techniqueConfig.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this.techniqueConfig.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?hl.Screen:hl.World,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.multipassGeometryEnabled=!!i&&i.multipassGeometryEnabled,this.techniqueConfig}intersect(){}requiresSlot(t){switch(t){case ve.LINE_CALLOUTS:case ve.LINE_CALLOUTS_HUD_DEPTH:return!0}return!1}createGLMaterial(t){return t.output===j.Color?new _Ye(t):null}createBufferWriter(){return new xYe}validateParameters(t){const i=J_.uniqueMaterialIdentifier(t);i!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=i)}static uniqueMaterialIdentifier(t){return JSON.stringify({screenOffset:t.screenOffset||[0,0],centerOffsetUnits:t.centerOffsetUnits||"world"})}}class _Ye extends Zm{updateParameters(t){return this.ensureTechnique(d4,t)}beginSlot(t){return this.updateParameters(t)}bind(t,i){i.bindPass(this._material.getPassParameters(),t)}}const bYe=I({verticalOffset:null,screenSizePerspective:null,screenOffset:[0,0],color:[0,0,0,1],size:1,borderColor:null,occlusionTest:!1,shaderPolygonOffset:1e-5,depthHUDAlignStart:!1,centerOffsetUnits:"world",slicePlaneEnabled:!1},ju),wYe=kr().vec3f(E.POSITION).vec3f(E.NORMAL).vec2f(E.UV0).vec4f(E.AUXPOS1),Hte=[yu(0,0),yu(1,0),yu(0,1),yu(1,0),yu(1,1),yu(0,1)];class xYe{constructor(){this.vertexBufferLayout=wYe}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return 6*t.indices.get(E.POSITION).length}write(t,i,r,s){FO(i.indices.get(E.POSITION),i.vertexAttributes.get(E.POSITION).data,t.transformation,r.position,s,6),cW(i.indices.get(E.NORMAL),i.vertexAttributes.get(E.NORMAL).data,t.invTranspTransformation,r.normal,s,6),xS(i.indices.get(E.AUXPOS1),i.vertexAttributes.get(E.AUXPOS1).data,r.auxpos1,s,6);for(let n=0;n<Hte.length;++n)r.uv0.setVec(s+n,Hte[n])}}class p4 extends Wp{constructor(t,i){super(t,null,i,EYe),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._material=new J_(this.materialParameters),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}_perInstanceMaterialParameters(t){const i=this.materialParameters;return i.screenOffset=t.screenOffset||[0,0],i.centerOffsetUnits=t.centerOffsetUnits||"world",i}get materialParameters(){const t=this.symbol,i=t.callout,r=_(i.color)?Je.toUnitRGBA(i.color):[0,0,0,0];r[3]*=this._getLayerOpacity();const s=fo(i.size||0);let n=null;if(t.verticalOffset){const{screenLength:p,minWorldLength:f,maxWorldLength:g}=t.verticalOffset;n={screenLength:fo(p),minWorldLength:f||0,maxWorldLength:g!=null?g:1/0}}const o=_(i.border)&&_(i.border.color)?Je.toUnitRGBA(i.border.color):null,a=t.symbolLayers.getItemAt(0).type==="object",l=!a,c=a?0:void 0,h=t.type==="label-3d";return{color:r,size:s,verticalOffset:n,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:o,occlusionTest:l,shaderPolygonOffset:c,depthHUDAlignStart:h,slicePlaneEnabled:this._context.slicePlaneEnabled,renderOccluded:ju.renderOccluded}}_defaultElevationInfoNoZ(){return SYe}createGraphics3DGraphic(t){const i=t.renderingInfo,r=t.graphic,s=this.setGraphicElevationContext(r,new Mc,i.elevationOffset||0),n=i.symbol,o=this._elevationContext.mode==="on-the-ground"&&(n.type==="cim"||!n.symbolLayers.some(l=>l.type==="object"||l.type==="text"));if(n.type!=="label-3d"&&o||n.type==="point-3d"&&n.symbolLayers.every(l=>l.type==="text"&&!uce(l)))return null;const a=yW(r.geometry);return R(a)?null:this._createAs3DShape(a,s,i,r.uid)}layerOpacityChanged(){return R(this._material)||this._material.setParameters(this.materialParameters),!0}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=BO(p4.elevationModeChangeTypes,r,s);return n!==_r.UPDATE||t.forEach(o=>{const a=i(o);_(a)&&this.updateGraphicElevationContext(o.graphic,a)}),n}slicePlaneEnabledChanged(){return R(this._material)||this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}setGraphicElevationContext(t,i,r=0){const s=super.setGraphicElevationContext(t,i);return s.addOffsetRenderUnits(r),s}updateGraphicElevationContext(t,i){this.setGraphicElevationContext(t,i.elevationContext,i.metadata.elevationOffset),i.needsElevationUpdates=zu(i.elevationContext.mode)}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:TW.memory}}_createVertexData(t){const{translation:i,centerOffset:r}=t,s=i?{size:3,data:[i[0],i[1],i[2]],exclusive:!0}:{size:3,data:[0,0,0],exclusive:!0},n=r?{size:4,data:[r[0],r[1],r[2],r[3]],exclusive:!0}:{size:4,data:[0,0,0,1],exclusive:!0};return[[E.POSITION,s],[E.NORMAL,{size:3,data:[0,0,1],exclusive:!0}],[E.AUXPOS1,n]]}_getOrCreateMaterial(t){const i=this._perInstanceMaterialParameters(t),r=J_.uniqueMaterialIdentifier(i);if(_(this._material)&&r===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(t.materialCollection){let s=t.materialCollection.get(r);return R(s)&&(s=new J_(i),t.materialCollection.add(r,s)),{material:s,isUnique:!1}}return{material:new J_(i),isUnique:!0}}_createAs3DShape(t,i,r,s){const n=[new lr(this._createVertexData(r),TYe,Aa.Point)],o=this._getOrCreateMaterial(r),a=EW(this._context,t,n,[o.material],i,this._context.layer.uid,s);if(a===null)return null;const l=new qp(this,a.object,n,o.isUnique?[o.material]:null,null,IR,i);return l.metadata={elevationOffset:r.elevationOffset||0},l.alignedSampledElevation=a.sampledElevation,l.needsElevationUpdates=zu(i.mode),$R(l,t,this._context.elevationProvider),l}}p4.elevationModeChangeTypes={definedChanged:_r.UPDATE,staysOnTheGround:_r.UPDATE,onTheGroundChanged:_r.RECREATE};const Ak=new Uint16Array([0]),TYe=[[E.POSITION,Ak],[E.NORMAL,Ak],[E.AUXPOS1,Ak]],SYe={mode:"relative-to-ground",offset:0},EYe={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1},qte=he.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function AYe(e,t){if(!bj(e))return qte.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const i=CYe[e.callout.type];return i?new i(e,t):(qte.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${e.callout.type}`),null)}const CYe={line:p4};class RYe{constructor(t,i,r){this.graphic=t,this.renderingInfo=i,this.layer=r}}const Wte=new Wr(Array,e=>GN(e,Fle),null,10,5),OYe=Dt();class MYe{constructor(t,i,r,s,n){this.graphic=t,this.graphics3DSymbol=i,this.graphics=r,this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=PYe(mn._COUNT,ac._COUNT),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++i.referenced,this._featureExpressionFeature=n?hve(n,t,s):null;for(const o of r)_(o)&&(this.isElevationSource=this.isElevationSource||o.isElevationSource)}get labelGraphics(){return this._labelGraphics}get extent(){return this._extent}initialize(t,i,r){this._layer=i,this._stage=t,this._forEachSymbolLayerGraphic(s=>{s.initialize(t,i,r),s.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(t=>t.destroy()),this.graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return this.graphics==null}clearLabelGraphics(){this._forEachLabelGraphic(t=>t.destroy()),this._labelGraphics.length=0}addLabelGraphic(t,i,r){this._labelGraphics.push(t),t.initialize(i,r),t.setVisibility(this.isVisible(mn.LABEL))}addAuxiliaryGraphic(t){this._auxiliaryGraphics.push(t),this._layer&&(t.initialize(this._stage,this._layer),t.setVisibility(this.isVisible()))}get isDraped(){let t=!1;return this._forEachSymbolLayerGraphic(i=>{i.type==="draped"&&(t=!0)}),t}isVisible(t=mn.GRAPHIC,i){for(let r=0;r<=t;r++){const s=this._visibilityFlags[r];for(let n=0;n<s.length;++n)if(s[n]===!1&&n!==i)return!1}return!0}hasVisibilityFlag(t,i){return this._visibilityFlags[i][t]!=null}setVisibilityFlag(t,i,r){const s=this.isVisible(r);this._visibilityFlags[r][t]=i;const n=this.isVisible(r);if(s===n)return!1;if(r===mn.LABEL)this._forEachLabelGraphic(o=>o.setVisibility(n));else{this._forEachSymbolLayerGraphic(a=>a.setVisibility(n));const o=this.isVisible(mn.LABEL);this._forEachLabelGraphic(a=>a.setVisibility(o))}return!0}clearVisibilityFlag(t,i=mn.GRAPHIC){return this.setVisibilityFlag(t,void 0,i)}computeExtent(t){if(!this._extent){const i=this.graphic.geometry;if(R(i))return!1;this._extent=Dt(),_Xe(i,this._extent);const r=i.spatialReference;if(!r.equals(t)&&!nF(this._extent,r,this._extent,t))return this._extent=null,!1}return!0}getAsOptimizedGeometry(t,i){return _(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===t&&this._optimizedGeometry.hasM===i||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,t,i),this._optimizedGeometry.hasZ=t,this._optimizedGeometry.hasM=i),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(t,i,r){let s=t.geometry;return s.type!=="mesh"&&s.type!=="extent"||(s=bc.fromExtent(s.type==="mesh"?s.extent:s)),tLe(s,i,r)}get usedMemory(){let t=yue(this.graphic.attributes);return this._forEachSymbolLayerGraphic(i=>{const r=i.graphics3DSymbolLayer.complexity;if(R(r))return;const s=i.type==="draped"?r.memory.draped:r.memory;t+=s.bytesPerFeature,s.bytesPerCoordinate&&(t+=vXe(this.graphic.geometry)*s.bytesPerCoordinate)}),t}computeAttachmentOrigin(){const t={render:{origin:M(),num:0},draped:{origin:Ye(),num:0}};for(const i of this.graphics)R(i)||i.computeAttachmentOrigin(t);return t.render.num&&ae(t.render.origin,t.render.origin,1/t.render.num),t.draped.num&&nl(t.draped.origin,t.draped.origin,1/t.draped.num),t}async getProjectedBoundingBox(t,i,r,s,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?ki(n.boundingBox):n.boundingBox=ki(),n.requiresDrapedElevation=!1,await JN(this.graphics,async o=>{if(R(o))return;const a=o.type==="draped"?i:t,l=Wte.acquire(),c=await o.getProjectedBoundingBox(a,r,n.screenSpaceObjects,s,l);isFinite(c[2])&&isFinite(c[5])||(n.requiresDrapedElevation=!0),c&&FT(n.boundingBox,l),Wte.release(l)}),QEe(n.boundingBox)||oB(ij(n.boundingBox,OYe))?n:null}needsElevationUpdates(){for(const t of this.graphics)if(_(t)&&(t.type==="object3d"||t.type==="lod-instance")&&t.needsElevationUpdates)return!0;for(const t of this._labelGraphics)if(t&&t.needsElevationUpdates)return!0;return!1}alignWithElevation(t,i,r){this._forEachRenderedGraphic(s=>{s.type!=="object3d"&&s.type!=="lod-instance"||s.alignWithElevation(t,i,this._featureExpressionFeature,r)})}addObjectStateSet(t,i){this._forEachSymbolLayerGraphic(r=>r.addObjectState(t,i))}removeObjectState(t){this._forEachSymbolLayerGraphic(i=>i.removeObjectState(t))}_forEachGraphicList(t,i){t.forEach(r=>r&&i(r))}_forEachSymbolLayerGraphic(t){this._forEachGraphicList(this.graphics,t),this._forEachGraphicList(this._auxiliaryGraphics,t)}_forEachLabelGraphic(t){this._forEachGraphicList(this._labelGraphics,t)}_forEachRenderedGraphic(t){this._forEachSymbolLayerGraphic(t),this._forEachLabelGraphic(t)}}function PYe(e,t){const i=new Array(e);for(let r=0;r<i.length;r++)i[r]=new Array(t);return i}var Xte,Yte,Zte,Sve={exports:{}};Xte=Sve,Yte=function(){function e($,F,k){k=k||2;var G,W,K,H,ee,ye,Ae,Ve=F&&F.length,Se=Ve?F[0]*k:$.length,xe=t($,0,Se,k,!0),Re=[];if(!xe||xe.next===xe.prev)return Re;if(Ve&&(xe=l($,F,xe,k)),$.length>80*k){G=K=$[0],W=H=$[1];for(var ze=k;ze<Se;ze+=k)(ee=$[ze])<G&&(G=ee),(ye=$[ze+1])<W&&(W=ye),ee>K&&(K=ee),ye>H&&(H=ye);Ae=(Ae=Math.max(K-G,H-W))!==0?1/Ae:0}return r(xe,Re,k,G,W,Ae),Re}function t($,F,k,G,W){var K,H;if(W===ie($,F,k,G)>0)for(K=F;K<k;K+=G)H=J(K,$[K],$[K+1],H);else for(K=k-G;K>=F;K-=G)H=J(K,$[K],$[K+1],H);if(H&&C(H,H.next)){var ee=H.next;Q(H),H=ee}return H}function i($,F){if(!$)return $;F||(F=$);var k,G=$;do if(k=!1,G.steiner||!C(G,G.next)&&A(G.prev,G,G.next)!==0)G=G.next;else{var W=G.prev;if(Q(G),(G=F=W)===G.next)break;k=!0}while(k||G!==F);return F}function r($,F,k,G,W,K,H){if($){!H&&K&&y($,G,W,K);for(var ee,ye,Ae=$;$.prev!==$.next;)if(ee=$.prev,ye=$.next,K?n($,G,W,K):s($))F.push(ee.i/k),F.push($.i/k),F.push(ye.i/k),Q($),$=ye.next,Ae=ye.next;else if(($=ye)===Ae){H?H===1?r($=o(i($),F,k),F,k,G,W,K,2):H===2&&a($,F,k,G,W,K):r(i($),F,k,G,W,K,1);break}}}function s($){var F=$.prev,k=$,G=$.next;if(A(F,k,G)>=0)return!1;for(var W=$.next.next;W!==$.prev;){if(S(F.x,F.y,k.x,k.y,G.x,G.y,W.x,W.y)&&A(W.prev,W,W.next)>=0)return!1;W=W.next}return!0}function n($,F,k,G){var W=$.prev,K=$,H=$.next;if(A(W,K,H)>=0)return!1;for(var ee=W.x<K.x?W.x<H.x?W.x:H.x:K.x<H.x?K.x:H.x,ye=W.y<K.y?W.y<H.y?W.y:H.y:K.y<H.y?K.y:H.y,Ae=W.x>K.x?W.x>H.x?W.x:H.x:K.x>H.x?K.x:H.x,Ve=W.y>K.y?W.y>H.y?W.y:H.y:K.y>H.y?K.y:H.y,Se=b(ee,ye,F,k,G),xe=b(Ae,Ve,F,k,G),Re=$.prevZ,ze=$.nextZ;Re&&Re.z>=Se&&ze&&ze.z<=xe;){if(Re!==$.prev&&Re!==$.next&&S(W.x,W.y,K.x,K.y,H.x,H.y,Re.x,Re.y)&&A(Re.prev,Re,Re.next)>=0||(Re=Re.prevZ,ze!==$.prev&&ze!==$.next&&S(W.x,W.y,K.x,K.y,H.x,H.y,ze.x,ze.y)&&A(ze.prev,ze,ze.next)>=0))return!1;ze=ze.nextZ}for(;Re&&Re.z>=Se;){if(Re!==$.prev&&Re!==$.next&&S(W.x,W.y,K.x,K.y,H.x,H.y,Re.x,Re.y)&&A(Re.prev,Re,Re.next)>=0)return!1;Re=Re.prevZ}for(;ze&&ze.z<=xe;){if(ze!==$.prev&&ze!==$.next&&S(W.x,W.y,K.x,K.y,H.x,H.y,ze.x,ze.y)&&A(ze.prev,ze,ze.next)>=0)return!1;ze=ze.nextZ}return!0}function o($,F,k){var G=$;do{var W=G.prev,K=G.next.next;!C(W,K)&&O(W,G,G.next,K)&&z(W,K)&&z(K,W)&&(F.push(W.i/k),F.push(G.i/k),F.push(K.i/k),Q(G),Q(G.next),G=$=K),G=G.next}while(G!==$);return i(G)}function a($,F,k,G,W,K){var H=$;do{for(var ee=H.next.next;ee!==H.prev;){if(H.i!==ee.i&&T(H,ee)){var ye=B(H,ee);return H=i(H,H.next),ye=i(ye,ye.next),r(H,F,k,G,W,K),void r(ye,F,k,G,W,K)}ee=ee.next}H=H.next}while(H!==$)}function l($,F,k,G){var W,K,H,ee=[];for(W=0,K=F.length;W<K;W++)(H=t($,F[W]*G,W<K-1?F[W+1]*G:$.length,G,!1))===H.next&&(H.steiner=!0),ee.push(w(H));for(ee.sort(c),W=0;W<ee.length;W++)k=i(k=p(ee[W],k),k.next);return k}function c($,F){return $.x-F.x}function h($){if($.next.prev===$)return $;let F=$;for(;;){const k=F.next;if(k.prev===F||k===F||k===$)break;F=k}return F}function p($,F){var k=f($,F);if(!k)return F;var G=B(k,$),W=i(k,k.next);let K=h(G);return i(K,K.next),W=h(W),h(F===k?W:F)}function f($,F){var k,G=F,W=$.x,K=$.y,H=-1/0;do{if(K<=G.y&&K>=G.next.y&&G.next.y!==G.y){var ee=G.x+(K-G.y)*(G.next.x-G.x)/(G.next.y-G.y);if(ee<=W&&ee>H){if(H=ee,ee===W){if(K===G.y)return G;if(K===G.next.y)return G.next}k=G.x<G.next.x?G:G.next}}G=G.next}while(G!==F);if(!k)return null;if(W===H)return k;var ye,Ae=k,Ve=k.x,Se=k.y,xe=1/0;G=k;do W>=G.x&&G.x>=Ve&&W!==G.x&&S(K<Se?W:H,K,Ve,Se,K<Se?H:W,K,G.x,G.y)&&(ye=Math.abs(K-G.y)/(W-G.x),z(G,$)&&(ye<xe||ye===xe&&(G.x>k.x||G.x===k.x&&g(k,G)))&&(k=G,xe=ye)),G=G.next;while(G!==Ae);return k}function g($,F){return A($.prev,$,F.prev)<0&&A(F.next,$,$.next)<0}function y($,F,k,G){var W=$;do W.z===null&&(W.z=b(W.x,W.y,F,k,G)),W.prevZ=W.prev,W.nextZ=W.next,W=W.next;while(W!==$);W.prevZ.nextZ=null,W.prevZ=null,v(W)}function v($){var F,k,G,W,K,H,ee,ye,Ae=1;do{for(k=$,$=null,K=null,H=0;k;){for(H++,G=k,ee=0,F=0;F<Ae&&(ee++,G=G.nextZ);F++);for(ye=Ae;ee>0||ye>0&&G;)ee!==0&&(ye===0||!G||k.z<=G.z)?(W=k,k=k.nextZ,ee--):(W=G,G=G.nextZ,ye--),K?K.nextZ=W:$=W,W.prevZ=K,K=W;k=G}K.nextZ=null,Ae*=2}while(H>1);return $}function b($,F,k,G,W){return($=1431655765&(($=858993459&(($=252645135&(($=16711935&(($=32767*($-k)*W)|$<<8))|$<<4))|$<<2))|$<<1))|(F=1431655765&((F=858993459&((F=252645135&((F=16711935&((F=32767*(F-G)*W)|F<<8))|F<<4))|F<<2))|F<<1))<<1}function w($){var F=$,k=$;do(F.x<k.x||F.x===k.x&&F.y<k.y)&&(k=F),F=F.next;while(F!==$);return k}function S($,F,k,G,W,K,H,ee){return(W-H)*(F-ee)-($-H)*(K-ee)>=0&&($-H)*(G-ee)-(k-H)*(F-ee)>=0&&(k-H)*(K-ee)-(W-H)*(G-ee)>=0}function T($,F){return $.next.i!==F.i&&$.prev.i!==F.i&&!N($,F)&&(z($,F)&&z(F,$)&&V($,F)&&(A($.prev,$,F.prev)||A($,F.prev,F))||C($,F)&&A($.prev,$,$.next)>0&&A(F.prev,F,F.next)>0)}function A($,F,k){return(F.y-$.y)*(k.x-F.x)-(F.x-$.x)*(k.y-F.y)}function C($,F){return $.x===F.x&&$.y===F.y}function O($,F,k,G){var W=U(A($,F,k)),K=U(A($,F,G)),H=U(A(k,G,$)),ee=U(A(k,G,F));return W!==K&&H!==ee||!(W!==0||!L($,k,F))||!(K!==0||!L($,G,F))||!(H!==0||!L(k,$,G))||!(ee!==0||!L(k,F,G))}function L($,F,k){return F.x<=Math.max($.x,k.x)&&F.x>=Math.min($.x,k.x)&&F.y<=Math.max($.y,k.y)&&F.y>=Math.min($.y,k.y)}function U($){return $>0?1:$<0?-1:0}function N($,F){var k=$;do{if(k.i!==$.i&&k.next.i!==$.i&&k.i!==F.i&&k.next.i!==F.i&&O(k,k.next,$,F))return!0;k=k.next}while(k!==$);return!1}function z($,F){return A($.prev,$,$.next)<0?A($,F,$.next)>=0&&A($,$.prev,F)>=0:A($,F,$.prev)<0||A($,$.next,F)<0}function V($,F){var k=$,G=!1,W=($.x+F.x)/2,K=($.y+F.y)/2;do k.y>K!=k.next.y>K&&k.next.y!==k.y&&W<(k.next.x-k.x)*(K-k.y)/(k.next.y-k.y)+k.x&&(G=!G),k=k.next;while(k!==$);return G}function B($,F){var k=new te($.i,$.x,$.y),G=new te(F.i,F.x,F.y),W=$.next,K=F.prev;return $.next=F,F.prev=$,k.next=W,W.prev=k,G.next=k,k.prev=G,K.next=G,G.prev=K,G}function J($,F,k,G){var W=new te($,F,k);return G?(W.next=G.next,W.prev=G,G.next.prev=W,G.next=W):(W.prev=W,W.next=W),W}function Q($){$.next.prev=$.prev,$.prev.next=$.next,$.prevZ&&($.prevZ.nextZ=$.nextZ),$.nextZ&&($.nextZ.prevZ=$.prevZ)}function te($,F,k){this.i=$,this.x=F,this.y=k,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function ie($,F,k,G){for(var W=0,K=F,H=k-G;K<k;K+=G)W+=($[H]-$[K])*($[K+1]+$[H+1]),H=K;return W}return e.deviation=function($,F,k,G){var W=F&&F.length,K=W?F[0]*k:$.length,H=Math.abs(ie($,0,K,k));if(W)for(var ee=0,ye=F.length;ee<ye;ee++){var Ae=F[ee]*k,Ve=ee<ye-1?F[ee+1]*k:$.length;H-=Math.abs(ie($,Ae,Ve,k))}var Se=0;for(ee=0;ee<G.length;ee+=3){var xe=G[ee]*k,Re=G[ee+1]*k,ze=G[ee+2]*k;Se+=Math.abs(($[xe]-$[ze])*($[Re+1]-$[xe+1])-($[xe]-$[Re])*($[ze+1]-$[xe+1]))}return H===0&&Se===0?0:Math.abs((Se-H)/H)},e.flatten=function($){for(var F=$[0][0].length,k={vertices:[],holes:[],dimensions:F},G=0,W=0;W<$.length;W++){for(var K=0;K<$[W].length;K++)for(var H=0;H<F;H++)k.vertices.push($[W][K][H]);W>0&&(G+=$[W-1].length,k.holes.push(G))}return k},e},(Zte=Yte())!==void 0&&(Xte.exports=Zte);const ES=Sve.exports,f4=he.getLogger("esri.views.3d.support.buffer.math");function GO(e,t,i){if(e.count!==t.count)return void f4.error("source and destination buffers need to have the same number of elements");const r=e.count,s=i[0],n=i[1],o=i[2],a=i[4],l=i[5],c=i[6],h=i[8],p=i[9],f=i[10],g=i[12],y=i[13],v=i[14],b=e.typedBuffer,w=e.typedBufferStride,S=t.typedBuffer,T=t.typedBufferStride;for(let A=0;A<r;A++){const C=A*w,O=A*T,L=S[O],U=S[O+1],N=S[O+2];b[C]=s*L+a*U+h*N+g,b[C+1]=n*L+l*U+p*N+y,b[C+2]=o*L+c*U+f*N+v}}function Z1(e,t,i){if(e.count!==t.count)return void f4.error("source and destination buffers need to have the same number of elements");const r=e.count,s=i[0],n=i[1],o=i[2],a=i[3],l=i[4],c=i[5],h=i[6],p=i[7],f=i[8],g=e.typedBuffer,y=e.typedBufferStride,v=t.typedBuffer,b=t.typedBufferStride;for(let w=0;w<r;w++){const S=w*y,T=w*b,A=v[T],C=v[T+1],O=v[T+2];g[S]=s*A+a*C+h*O,g[S+1]=n*A+l*C+p*O,g[S+2]=o*A+c*C+f*O}}function Q9(e,t,i){const r=Math.min(e.count,t.count),s=e.typedBuffer,n=e.typedBufferStride,o=t.typedBuffer,a=t.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=i*o[h],s[c+1]=i*o[h+1],s[c+2]=i*o[h+2]}}function CW(e,t){const i=Math.min(e.count,t.count),r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride;for(let a=0;a<i;a++){const l=a*s,c=a*o,h=n[c],p=n[c+1],f=n[c+2],g=Math.sqrt(h*h+p*p+f*f);if(g>0){const y=1/g;r[l]=y*h,r[l+1]=y*p,r[l+2]=y*f}}}function IYe(e,t,i){const r=Math.min(e.count,t.count),s=e.typedBuffer,n=e.typedBufferStride,o=t.typedBuffer,a=t.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=o[h]>>i,s[c+1]=o[h+1]>>i,s[c+2]=o[h+2]>>i}}Object.freeze({__proto__:null,transformMat4:GO,transformMat3:Z1,scale:Q9,normalize:CW,shiftRight:IYe});function m4(e,t){if(!e||e.symbol)return null;const i=t&&t.renderer;return e&&_(i)&&i.getObservationRenderer?i.getObservationRenderer(e):i}function $Ye(e,t){if(_(e.symbol))return e.symbol;const i=m4(e,t);return _(i)&&i.type!=="dot-density"?i.getSymbol(e,t):null}function Fyt(e,t){const i=m4(e,t),r=$Ye(e,t);if(R(r))return null;const s={renderer:i,symbol:r};if(R(i)||!("visualVariables"in i)||!i.visualVariables)return s;const n=kH(i,e,t),o=["proportional","proportional","proportional"];for(const{variable:a,value:l}of n)switch(a.type){case"color":s.color=l.toRgba();break;case"size":if(a.target==="outline")s.outlineSize=l;else{const c=a.axis,h=a.useSymbolValue?"symbol-value":l;switch(c){case"width":o[0]=h;break;case"depth":o[1]=h;break;case"height":o[2]=h;break;case"width-and-depth":o[0]=o[1]=h;break;default:o[0]=o[1]=o[2]=h}}break;case"opacity":s.opacity=l;break;case"rotation":switch(a.axis){case"tilt":s.tilt=l;break;case"roll":s.roll=l;break;default:s.heading=l}}return o[0]==="proportional"&&o[1]==="proportional"&&o[2]==="proportional"||(s.size=o),s}async function DYe(e,t){if(_(e.symbol))return e.symbol;const i=m4(e,t);return _(i)&&i.getSymbolAsync(e,me(I({},t),{abortOptions:{signal:t.signal}}))}async function Uyt(e,t){const i=m4(e,t),r=await DYe(e,t);if(!r)return null;const s={renderer:i,symbol:r};if(!i||!("visualVariables"in i)||!i.visualVariables)return s;const n=kH(i,e,t),o=["proportional","proportional","proportional"];for(const{variable:a,value:l}of n)if(a.type==="color")s.color=Je.toUnitRGBA(l);else if(a.type==="size")if(a.target==="outline")s.outlineSize=l;else{const c=a.axis,h=a.useSymbolValue?"symbol-value":l;c==="width"?o[0]=h:c==="depth"?o[1]=h:c==="height"?o[2]=h:o[0]=o[1]=c==="width-and-depth"?h:o[2]=h}else a.type==="opacity"?s.opacity=l:a.type==="rotation"&&a.axis==="tilt"?s.tilt=l:a.type==="rotation"&&a.axis==="roll"?s.roll=l:a.type==="rotation"&&(s.heading=l);return(isFinite(o[0])||isFinite(o[1])||isFinite(o[2]))&&(s.size=o),s}function LYe(e,t=0){const i=e[t];return typeof i=="number"&&isFinite(i)?i:null}function NYe(e){for(let t=0;t<3;t++){const i=e[t];if(typeof i=="number")return isFinite(i)?i:0}return 0}function Eve(e,t,i){var r;const s=e.byteLength/(4*t),n=new Uint32Array(e,0,s*t);let o=new Uint32Array(s);const a=(r=i==null?void 0:i.minReduction)!=null?r:0,l=(i==null?void 0:i.originalIndices)||null,c=l?l.length:0,h=(i==null?void 0:i.componentOffsets)||null;let p=0;if(h)for(let O=0;O<h.length-1;O++){const L=h[O+1]-h[O];L>p&&(p=L)}else p=s;const f=Math.floor(1.1*p)+1;(fd==null||fd.length<2*f)&&(fd=new Uint32Array(wT(2*f)));for(let O=0;O<2*f;O++)fd[O]=0;let g=0;const y=!!h&&!!l,v=y?c:s,b=y?new Uint32Array(c):null,w=1.96;let S=a!==0?Math.ceil(4*w*w/(a*a)*a*(1-a)):v,T=1,A=h?h[1]:v;for(let O=0;O<v;O++){if(O===S){const B=1-g/O;if(B+w*Math.sqrt(B*(1-B)/O)<a)return null;S*=2}if(O===A){for(let B=0;B<2*f;B++)fd[B]=0;if(l)for(let B=h[T-1];B<h[T];B++)b[B]=o[l[B]];A=h[++T]}const L=y?l[O]:O,U=L*t,N=kYe(n,U,t);let z=N%f,V=g;for(;fd[2*z+1]!==0;){if(fd[2*z]===N){const B=fd[2*z+1]-1;if(FYe(n,U,B*t,t)){V=o[B];break}}z++,z>=f&&(z-=f)}V===g&&(fd[2*z]=N,fd[2*z+1]=L+1,g++),o[L]=V}if(a!==0&&1-g/s<a)return null;if(y){for(let O=h[T-1];O<b.length;O++)b[O]=o[l[O]];o=b}const C=new Uint32Array(t*g);g=0;for(let O=0;O<v;O++)o[O]===g&&(UYe(n,(y?l[O]:O)*t,C,g*t,t),g++);if(l&&!y){const O=new Uint32Array(c);for(let L=0;L<O.length;L++)O[L]=o[l[L]];o=O}return{buffer:C.buffer,indices:o,uniqueCount:g}}function FYe(e,t,i,r){for(let s=0;s<r;s++)if(e[t+s]!==e[i+s])return!1;return!0}function UYe(e,t,i,r,s){for(let n=0;n<s;n++)i[r+n]=e[t+n]}function kYe(e,t,i){let r=0;for(let s=0;s<i;s++)r=e[t+s]+r|0,r=r+(r<<11)+(r>>>2)|0;return r>>>0}let fd=null;function kyt(e){const t=jO(e.rings,e.hasZ,Pp.CCW_IS_HOLE),i=[];let r=0,s=0;for(const a of t.polygons){const l=a.count,c=a.index,h=new Float64Array(t.position.buffer,3*c*t.position.BYTES_PER_ELEMENT,3*l),p=a.holeIndices.map(g=>g-c),f=new Uint32Array(ES(h,p,3));i.push({position:h,faces:f}),r+=h.length,s+=f.length}const n=zYe(i,r,s),o=Eve(n.position.buffer,6,{originalIndices:n.faces});return n.position=new Float64Array(o.buffer),n.faces=o.indices,n}function zYe(e,t,i){if(e.length===1)return e[0];const r=new Float64Array(t),s=new Uint32Array(i);let n=0,o=0,a=0;for(const l of e){for(let c=0;c<l.position.length;c++)r[n++]=l.position[c];for(let c=0;c<l.faces.length;c++)s[o++]=l.faces[c]+a;a=n/3}return{position:r,faces:s}}function jO(e,t,i){const r=e.length,s=new Array(r),n=new Array(r),o=new Array(r);let a=0,l=0,c=0,h=0;for(let g=0;g<r;++g)h+=e[g].length;const p=new Float64Array(3*h);let f=0;for(let g=r-1;g>=0;g--){const y=e[g],v=i===Pp.CCW_IS_HOLE&&BYe(y);if(v&&r!==1)s[a++]=y;else{let b=y.length;for(let S=0;S<a;++S)b+=s[S].length;const w={index:f,pathLengths:new Array(a+1),count:b,holeIndices:new Array(a)};w.pathLengths[0]=y.length,y.length>0&&(o[c++]={index:f,count:y.length}),f=v?L3(y,y.length-1,-1,p,f,y.length,t):L3(y,0,1,p,f,y.length,t);for(let S=0;S<a;++S){const T=s[S];w.holeIndices[S]=f,w.pathLengths[S+1]=T.length,T.length>0&&(o[c++]={index:f,count:T.length}),f=L3(T,0,1,p,f,T.length,t)}a=0,w.count>0&&(n[l++]=w)}}for(let g=0;g<a;++g){const y=s[g];y.length>0&&(o[c++]={index:f,count:y.length}),f=L3(y,0,1,p,f,y.length,t)}return l<r&&(n.length=l),c<r&&(o.length=c),{position:p,polygons:n,outlines:o}}function L3(e,t,i,r,s,n,o){s*=3;for(let a=0;a<n;++a){const l=e[t];r[s++]=l[0],r[s++]=l[1],r[s++]=o?l[2]:0,t+=i}return s/3}function BYe(e){return!N7(e,!1,!1)}var Pp;(function(e){e[e.NONE=0]="NONE",e[e.CCW_IS_HOLE=1]="CCW_IS_HOLE"})(Pp||(Pp={}));var yC,J9,zx;(function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"})(yC||(yC={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(J9||(J9={})),function(e){e[e.LAYER_VIEW=0]="LAYER_VIEW",e[e.EXTERNAL=1]="EXTERNAL"}(zx||(zx={}));var is,uo,AS,dn,Qs;(function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"})(is||(is={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(uo||(uo={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(AS||(AS={})),function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.Water=3]="Water",e[e.Occluded=4]="Occluded"}(dn||(dn={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(Qs||(Qs={}));class VYe{constructor(t,i){this.vec3=t,this.id=i}}function vC(e,t,i,r){return new VYe(je(e,t,i),r)}var $n;(function(e){e[e.None=0]="None",e[e.ColorAndWater=1]="ColorAndWater",e[e.Highlight=2]="Highlight",e[e.Occluded=3]="Occluded"})($n||($n={}));class Qte{constructor(t,i){this.index=t,this.renderTargets=i,this.extent=Dt(),this.resolution=0,this.renderLocalOrigin=vC(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new jYe,this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=t,this.validTargets=new Array(i.renderTargets.length).fill(!1)}getValidTarget(t){return this.validTargets[t]?this.renderTargets.getTarget(t):null}get needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(t){const i=t===$n.ColorAndWater?this.renderTargets.getTarget(dn.Color):t===$n.Highlight?this.renderTargets.getTarget(dn.Highlight):this.renderTargets.getTarget(dn.Occluded);return i?i.getTexture():null}getNormalTexture(t){const i=t===$n.ColorAndWater?this.renderTargets.getTarget(dn.Water):null;return i?i.getTexture():null}draw(t,i){const r=this.computeRenderTargetValidityBitfield(),s=this.needsColorWithoutRasterImage;for(const n of this.renderTargets.renderTargets)n.type===dn.ColorNoRasterImage&&s===!1?this.validTargets[n.type]=!1:this.validTargets[n.type]=t.drawTarget(this,n,i);return r^this.computeRenderTargetValidityBitfield()?lS.CHANGED:lS.UNCHANGED}computeRenderTargetValidityBitfield(){const t=this.validTargets;return+t[dn.Color]|+t[dn.ColorNoRasterImage]<<1|+t[dn.Highlight]<<2|+t[dn.Water]<<3|+t[dn.Occluded]<<4}setupGeometryViewsCyclical(t){this.setupGeometryViewsDirect();const i=.001*t.range;if(this.extent[0]-i<=t.min){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];SD(this.extent,t.range,0,r)}if(this.extent[2]+i>=t.max){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];SD(this.extent,-t.range,0,r)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,y0(this.canvasGeometries.extents[0],this.extent)}hasSomeSizedView(){for(let t=0;t<this.canvasGeometries.numViews;t++){const i=this.canvasGeometries.extents[t];if(i[0]!==i[2]&&i[1]!==i[3])return!0}return!1}applyViewport(t){t.setViewport(this.index===is.INNER?0:this.resolution,0,this.resolution,this.resolution)}}function GYe(e,t,i){return Math.min(wT(Math.max(e,t)+256),i)}class jYe{constructor(){this.extents=[Dt(),Dt(),Dt()],this.numViews=0}}class Ave{constructor(t,i){this.size=AW(),this._fbo=null,this._fbo=new zi(t,{colorTarget:vr.TEXTURE,depthStencilTarget:ti.NONE},{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE,samplingMode:Ge.LINEAR_MIPMAP_LINEAR,hasMipmap:i,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=tt(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return this._fbo!==null}resize(t,i){this.size[0]=t,this.size[1]=i,this._fbo.resize(this.size[0],this.size[1])}bind(t){t.bindFramebuffer(this._fbo)}generateMipMap(){this._fbo.colorTexture.descriptor.hasMipmap&&this._fbo.colorTexture.generateMipmap()}disposeRenderTargetMemory(){var t;(t=this._fbo)==null||t.resize(0,0)}get gpuMemoryUsage(){var t,i;return(t=(i=this._fbo)==null?void 0:i.gpuMemoryUsage)!=null?t:0}}class HYe{constructor(t){const i=(r,s,n=!0)=>({type:s,fbo:new Ave(t,n),renderPass:r,valid:!1,lastUsed:1/0});this.renderTargets=[i(Le.MATERIAL,dn.Color),i(Le.MATERIAL,dn.ColorNoRasterImage),i(Le.MATERIAL_HIGHLIGHT,dn.Highlight,!1),i(Le.MATERIAL_NORMAL,dn.Water),i(Le.MATERIAL,dn.Occluded)]}getTarget(t){return this.renderTargets[t].fbo}dispose(){for(const t of this.renderTargets)t.fbo.dispose()}disposeRenderTargetMemory(){for(const t of this.renderTargets)t.fbo.disposeRenderTargetMemory()}validateUsageForTarget(t,i,r){if(t)i.lastUsed=r;else if(r-i.lastUsed>qYe)i.fbo.disposeRenderTargetMemory(),i.lastUsed=1/0;else if(i.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce((t,i)=>t+i.fbo.gpuMemoryUsage,0)}}const qYe=1e3;class RW{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return this._outer.size===0}get(t,i){var r;return(r=this._outer.get(t))==null?void 0:r.get(i)}set(t,i,r){const s=this._outer.get(t);s?s.set(i,r):this._outer.set(t,new Map([[i,r]]))}delete(t,i){const r=this._outer.get(t);r&&(r.delete(i),r.size===0&&this._outer.delete(t))}forEach(t){this._outer.forEach((i,r)=>t(i,r))}}class WYe{constructor(t){this.technique=t,this.refCount=0,this.refZeroFrame=0}}class Cve{constructor(t){this._context=t,this._perConstructorInstances=new RW,this._frameCounter=0,this._keepAliveFrameCount=Jte}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach(t=>t.forEach(i=>i.technique.destroy())),this._perConstructorInstances.clear()}acquire(t,i){const r=i.key;let s=this._perConstructorInstances.get(t,r);if(R(s)){const n=new t(this._context,i,()=>this.release(n));s=new WYe(n),this._perConstructorInstances.set(t,r,s)}return++s.refCount,s.technique}releaseAndAcquire(t,i,r){if(_(r)){if(i.key===r.key)return r;this.release(r)}return this.acquire(t,i)}release(t){if(R(t)||this._perConstructorInstances.empty)return;const i=this._perConstructorInstances.get(t.constructor,t.key);R(i)||(--i.refCount,i.refCount===0&&(i.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==Jte&&this._perConstructorInstances.forEach((t,i)=>{t.forEach((r,s)=>{r.refCount===0&&r.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(r.technique.destroy(),this._perConstructorInstances.delete(i,s))})})}async reloadAll(){const t=new Array;this._perConstructorInstances.forEach((i,r)=>{const s=async(n,o)=>{const a=o.shader;a&&(await a.reload(),n.forEach(l=>{l.technique.reload(this._context)}))};t.push(s(i,r))}),await Promise.all(t)}}const Jte=-1,g4=e=>{class t extends e{constructor(){super(...arguments),this._isDisposed=!1}dispose(){for(const s of(r=this._managedDisposables)!=null?r:[]){var r;const n=this[s];this[s]=null,n&&typeof n.dispose=="function"&&n.dispose()}this._isDisposed=!0}get isDisposed(){return this._isDisposed}}return t};class y4 extends g4(class{}){}function Dn(){return(e,t)=>{var i,r;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=(i=(r=e._managedDisposables)==null?void 0:r.slice())!=null?i:[]),e._managedDisposables.unshift(t)}}class Rve{constructor(){this.adds=new $t,this.removes=new $t,this.updates=new $t({allocator:t=>t||new XYe,deallocator:t=>(t.renderGeometry=null,t)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}class XYe{}class YYe{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}function Ove(e){const t=new Map,i=r=>{let s=t.get(r);return s||(s=new YYe,t.set(r,s)),s};return e.removes.forAll(r=>{Ck(r)&&i(r.material).removes.push(r)}),e.adds.forAll(r=>{Ck(r)&&i(r.material).adds.push(r)}),e.updates.forAll(r=>{Ck(r.renderGeometry)&&i(r.renderGeometry.material).updates.push(r)}),t}function Ck(e){return e.data.indexCount>=1}class Mve{constructor(t,i){this._material=t,this._repository=i,this._map=new Map}destroy(){this._map.forEach((t,i)=>{_(t)&&this._repository.release(this._material,Q1(i))})}load(t,i){this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,Q1(i)));const r=this._map.get(i);if(_(r)){if(r.ensureResources(t)===ma.LOADED)return r;this._repository.requestRender()}return null}}function Q1(e){switch(e){default:case Le.MATERIAL:return j.Color;case Le.MATERIAL_ALPHA:return j.Alpha;case Le.MATERIAL_DEPTH_SHADOWMAP_ALL:return j.Shadow;case Le.MATERIAL_NORMAL:return j.Normal;case Le.MATERIAL_DEPTH:return j.Depth;case Le.MATERIAL_HIGHLIGHT:return j.Highlight;case Le.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT:case Le.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return j.Shadow}}var Gt;(function(e){var t,i;(t=e.Geometry||(e.Geometry={}))[t.ADD=1]="ADD",t[t.UPDATE=2]="UPDATE",t[t.REMOVE=4]="REMOVE",(i=e.State||(e.State={}))[i.VISIBILITIES=1]="VISIBILITIES",i[i.VERTEXATTRS=2]="VERTEXATTRS",i[i.TRANSFORMATION=4]="TRANSFORMATION",i[i.HIGHLIGHTS=8]="HIGHLIGHTS",i[i.OCCLUDEES=16]="OCCLUDEES"})(Gt||(Gt={}));function Lm(e){e.fragment.include(nd),e.fragment.uniforms.add("shadowMapTex","sampler2D"),e.fragment.uniforms.add("numCascades","int"),e.fragment.uniforms.add("cascadeDistances","vec4"),e.fragment.uniforms.add("shadowMapMatrix","mat4",4),e.fragment.uniforms.add("depthHalfPixelSz","float"),e.fragment.code.add(x`int chooseCascade(float _linearDepth, out mat4 mat) {
vec4 distance = cascadeDistances;
float depth = _linearDepth;
int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;
mat = i == 0 ? shadowMapMatrix[0] : i == 1 ? shadowMapMatrix[1] : i == 2 ? shadowMapMatrix[2] : shadowMapMatrix[3];
return i;
}
vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {
vec4 lv = mat * vec4(_vpos, 1.0);
lv.xy /= lv.w;
return 0.5 * lv.xyz + vec3(0.5);
}
vec2 cascadeCoordinates(int i, vec3 lvpos) {
return vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;
}
float readShadowMapDepth(vec2 uv, sampler2D _depthTex) {
return rgba2float(texture2D(_depthTex, uv));
}
float posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {
return readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;
}
float filterShadow(vec2 uv, vec3 lvpos, float halfPixelSize, sampler2D _depthTex) {
float texSize = 0.5 / halfPixelSize;
vec2 st = fract((vec2(halfPixelSize) + uv) * texSize);
float s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);
float s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float readShadowMap(const in vec3 _vpos, float _linearDepth) {
mat4 mat;
int i = chooseCascade(_linearDepth, mat);
if (i >= numCascades) { return 0.0; }
vec3 lvpos = lightSpacePosition(_vpos, mat);
if (lvpos.z >= 1.0) { return 0.0; }
if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }
vec2 uv = cascadeCoordinates(i, lvpos);
return filterShadow(uv, lvpos, depthHalfPixelSz, shadowMapTex);
}`)}function ZYe(e,t){t.shadowMappingEnabled&&(t.shadowMap.bind(e),t.shadowMap.bindView(e,t.origin))}function QYe(e,t,i){t.shadowMappingEnabled&&t.shadowMap.bindView(e,i)}function JYe(e,t){t.shadowMappingEnabled&&t.shadowMap.bindView(e,t.origin)}function KYe(e){e.fragment.uniforms.add("lastFrameColorMap","sampler2D"),e.fragment.uniforms.add("reprojectionMatrix","mat4"),e.fragment.uniforms.add("proj","mat4"),e.fragment.code.add(x`vec2 reprojectionCoordinate(vec3 projectionCoordinate)
{
vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
reprojectedCoord.xy /= reprojectedCoord.w;
return reprojectedCoord.xy * 0.5 + 0.5;
}`)}function eZe(e,t){e.bindTexture(t.lastFrameColorTexture,"lastFrameColorMap"),e.setUniformMatrix4fv("reprojectionMatrix",t.reprojectionMatrix),e.setUniformMatrix4fv("proj",t.camera.projectionMatrix)}function tZe(e,t){e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("depthMapView","sampler2D"),e.fragment.uniforms.add("view","mat4"),e.fragment.uniforms.add("invResolutionHeight","float"),e.fragment.include(Os),e.include(KYe),e.fragment.code.add(x`
  const int maxSteps = ${t.highStepCount?"150;":"75;"}

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
          return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}function OW(e,t){t.ssrEnabled&&(e.bindTexture(t.linearDepthTexture,"depthMapView"),e.setUniform2fv("nearFar",t.camera.nearFar),e.setUniformMatrix4fv("view",t.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/t.camera.height),eZe(e,t))}function iZe(e){e.fragment.code.add(x`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function rZe(e){e.fragment.code.add(x`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}function Kte(e){e.fragment.uniforms.add("texWaveNormal","sampler2D"),e.fragment.uniforms.add("texWavePerturbation","sampler2D"),e.fragment.uniforms.add("waveParams","vec4"),e.fragment.uniforms.add("waveDirection","vec2"),e.include(iZe),e.fragment.code.add(x`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}function sZe(e,t){e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)}function HO(e,t){t.output===j.Color&&t.receiveShadows?(e.varyings.add("linearDepth","float"),e.vertex.code.add(x`void forwardLinearDepth() { linearDepth = gl_Position.w; }`)):t.output===j.Depth||t.output===j.Shadow?(e.varyings.add("linearDepth","float"),e.vertex.uniforms.add("nearFar","vec2"),e.vertex.code.add(x`void forwardLinearDepth() {
linearDepth = (-position_view().z - nearFar[0]) / (nearFar[1] - nearFar[0]);
}`)):e.vertex.code.add(x`void forwardLinearDepth() {}`)}function e0(e,t){t.viewingMode===Ie.Global?e.vertex.code.add(x`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(x`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),t.viewingMode===Ie.Global?e.vertex.code.add(x`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(x`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}function nZe(e){const t=e.fragment.code;t.add(x`vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)
{
return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;
}`),t.add(x`float integratedRadiance(float cosTheta2, float roughness)
{
return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);
}`),t.add(x`vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)
{
float cosTheta2 = 1.0 - RdotNG * RdotNG;
float intRadTheta = integratedRadiance(cosTheta2, roughness);
float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;
float sky = 2.0 - ground;
return (ground * ambientGround + sky * ambientSky) * 0.5;
}`)}function v4(e,t){const i=e.fragment.code;e.include(jF),t.pbrMode===xt.Water||t.pbrMode===xt.WaterOnIntegratedMesh?(i.add(x`
    struct PBRShadingWater
    {
        float NdotL;   // cos angle between normal and light direction
        float NdotV;   // cos angle between normal and view direction
        float NdotH;   // cos angle between normal and half vector
        float VdotH;   // cos angle between view direction and half vector
        float LdotH;   // cos angle between light direction and half vector
        float VdotN;   // cos angle between view direction and normal vector
    };

    float dtrExponent = ${t.useCustomDTRExponentForWater?"2.2":"2.0"};
    `),i.add(x`vec3 fresnelReflection(float angle, vec3 f0, float f90) {
return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);
}`),i.add(x`float normalDistributionWater(float NdotH, float roughness)
{
float r2 = roughness * roughness;
float NdotH2 = NdotH * NdotH;
float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;
return r2 / denom;
}`),i.add(x`float geometricOcclusionKelemen(float LoH)
{
return 0.25 / (LoH * LoH);
}`),i.add(x`vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)
{
vec3  F = fresnelReflection(props.VdotH, F0, F0Max);
float dSun = normalDistributionWater(props.NdotH, roughness);
float V = geometricOcclusionKelemen(props.LdotH);
float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);
float strengthSunHaze  = 1.2;
float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;
return ((dSun + dSunHaze) * V) * F;
}
vec3 tonemapACES(const vec3 x) {
return (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);
}`)):t.pbrMode!==xt.Normal&&t.pbrMode!==xt.Schematic||(e.include(nZe),i.add(x`struct PBRShadingInfo
{
float NdotL;
float NdotV;
float NdotH;
float VdotH;
float LdotH;
float NdotNG;
float RdotNG;
float NdotAmbDir;
float NdotH_Horizon;
vec3 skyRadianceToSurface;
vec3 groundRadianceToSurface;
vec3 skyIrradianceToSurface;
vec3 groundIrradianceToSurface;
float averageAmbientRadiance;
float ssao;
vec3 albedoLinear;
vec3 f0;
vec3 f90;
vec3 diffuseColor;
float metalness;
float roughness;
};`),i.add(x`float normalDistribution(float NdotH, float roughness)
{
float a = NdotH * roughness;
float b = roughness / (1.0 - NdotH * NdotH + a * a);
return b * b * INV_PI;
}`),i.add(x`const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);
const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);
const vec2 c2 = vec2(-1.04, 1.04);
vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;
return c2 * a004 + r.zw;
}`),i.add(x`vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {
vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);
vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);
vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;
vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);
vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;
vec3 specularComponent = specularColor * indirectSpecular;
return (diffuseComponent + specularComponent);
}`),i.add(x`float gamutMapChanel(float x, vec2 p){
return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );
}`),i.add(x`vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){
vec3 outColor;
vec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));
outColor.x = gamutMapChanel(inColor.x, p) ;
outColor.y = gamutMapChanel(inColor.y, p) ;
outColor.z = gamutMapChanel(inColor.z, p) ;
return outColor;
}`))}function Pve(e,t){e.include(v4,t),e.include(BF),e.include(rZe),t.cloudsReflectionsEnabled&&e.include(Uge),t.ssrEnabled&&e.include(tZe,t),e.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),e.fragment.code.add(x`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),e.fragment.code.add(x`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),t.cloudsReflectionsEnabled&&e.fragment.code.add(x`vec4 cloudsColor = crossFade == 0 ? renderCloud(reflectedWorld, position) : renderCloudCrossFade(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y*cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * (1.0 - totalFadeInOut);`),t.ssrEnabled?e.fragment.code.add(x`vec4 viewPosition = vec4(positionView.xyz, 1.0);
vec3 viewDir = normalize(viewPosition.xyz);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view *vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);
reflectionHit = clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod*0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor + reflSea * seaColorMod + specular  + foam);`):e.fragment.code.add(x`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),t.cloudsReflectionsEnabled?t.ssrEnabled?e.fragment.code.add(x`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):e.fragment.code.add(x`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):e.fragment.code.add(x`return waterRenderedColor;
}`)}function oZe(e){const t=new Oi;return t.include(Gn,{linearDepth:!1}),t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.UV0,"vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),t.vertex.uniforms.add("waterColor","vec4"),e.output!==j.Color&&e.output!==j.Alpha||(t.include(e0,e),t.include(HO,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),t.fragment.uniforms.add("localOrigin","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(x`
      void main(void) {
        if (waterColor.a < ${x.float(Hn)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${e.output===j.Color?"forwardLinearDepth();":""}
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(Os),t.include(Ec,e)),e.output===j.Alpha&&(t.include(Or,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(x`
        void main() {
          discardBySlice(vpos);
          ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `)),e.output===j.Color&&(t.include(GF),t.include(bq,{pbrMode:xt.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(Kte,e),t.include(Or,e),e.receiveShadows&&t.include(Lm,e),t.include(Pve,e),t.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("lightingSpecularStrength","float").add("lightingEnvironmentStrength","float").add("cameraPosition","vec3").add("timeElapsed","float").add("view","mat4"),t.fragment.include(Vp),t.fragment.code.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - cameraPosition);
        float shadow = ${e.receiveShadows?x`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view*vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, lightingMainDirection, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.output===j.Normal&&(t.include(e0,e),t.include(Kte,e),t.include(Or,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),t.vertex.code.add(x`
        void main(void) {
          if (waterColor.a < ${x.float(Hn)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(x`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`)),e.output===j.Draped&&(t.varyings.add("vpos","vec3"),t.vertex.code.add(x`
        void main(void) {
          if (waterColor.a < ${x.float(Hn)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(x`void main() {
gl_FragColor = waterColor;
}`)),e.output===j.Highlight&&(t.include(Qm),t.varyings.add("vpos","vec3"),t.vertex.code.add(x`
      void main(void) {
        if (waterColor.a < ${x.float(Hn)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),t.include(Or,e),t.fragment.code.add(x`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}const aZe=Object.freeze({__proto__:null,build:oZe});class _4 extends Gi{constructor(t,i,r){super(t,i,r),this._textureRepository=t.waterTextureRepository}initializeProgram(t){const i=_4.shader.get(),r=this.configuration,s=i.build({oitEnabled:r.transparencyPassType===lt.Color,output:r.output,viewingMode:t.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:r.receiveShadows,pbrMode:xt.Water,useCustomDTRExponentForWater:!0,ssrEnabled:r.useSSR,cloudsReflectionsEnabled:ue("enable-feature:clouds-reflections"),highStepCount:!0,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Mi(t.rctx,s,mi)}bindPass(t,i){Ol(this.program,i.camera.projectionMatrix),i.multipassTerrainEnabled&&(this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),Jm(this.program,i)),this.configuration.output===j.Color&&(i.lighting.setUniforms(this.program,!1,!1),OW(this.program,i),ue("enable-feature:clouds-reflections")&&_(i.cloudsCompositionParams)&&kge(this.program,i.camera,i.cloudsCompositionParams)),this.configuration.output!==j.Color&&this.configuration.output!==j.Normal||(sZe(this.program,t),this._textureRepository.bind(this.program)),this.program.setUniform4fv("waterColor",t.color),this.configuration.output===j.Highlight&&Hp(this.program,i)}bindDraw(t){Gp(this.program,t),this.program.rebindTextures(),this.configuration.output!==j.Color&&this.configuration.output!==j.Alpha||j0(this.program,t.origin,t.camera.viewInverseTransposeMatrix),this.configuration.output===j.Color&&ZYe(this.program,t),this.configuration.output!==j.Color&&this.configuration.output!==j.Alpha&&this.configuration.output!==j.Highlight||wb(this.program,this.configuration,t)}_setPipelineState(t){const i=this.configuration,r=t===lt.NONE,s=t===lt.FrontFace;return Ot({blending:i.output!==j.Normal&&i.output!==j.Highlight&&i.transparent?r?gl:Km(t):null,depthTest:{func:H0(t)},depthWrite:r?i.writeDepth&&Ma:a4(t),colorWrite:Ft,polygonOffset:r||s?null:u4(i.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}_4.shader=new Ni(aZe,()=>import("./WaterSurface.glsl.f8d58d0a.js"));class eu extends mr{constructor(){super(...arguments),this.output=j.Color,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=lt.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Z({count:j.COUNT})],eu.prototype,"output",void 0),u([Z()],eu.prototype,"receiveShadows",void 0),u([Z()],eu.prototype,"slicePlaneEnabled",void 0),u([Z()],eu.prototype,"transparent",void 0),u([Z()],eu.prototype,"enableOffset",void 0),u([Z()],eu.prototype,"writeDepth",void 0),u([Z()],eu.prototype,"useSSR",void 0),u([Z()],eu.prototype,"isDraped",void 0),u([Z({count:lt.COUNT})],eu.prototype,"transparencyPassType",void 0),u([Z()],eu.prototype,"multipassTerrainEnabled",void 0),u([Z()],eu.prototype,"cullAboveGround",void 0);class eie extends Zm{updateParameters(t){return this.ensureTechnique(_4,t)}setElapsedTimeUniform(t){const i=.001*this._material.animation.time;t.setUniform1f("timeElapsed",i*this._material.parameters.animationSpeed)}_updateShadowState(t){t.shadowMappingEnabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:t.shadowMappingEnabled})}_updateSSRState(t){t.ssrEnabled!==this._material.parameters.ssrEnabled&&this._material.setParameters({ssrEnabled:t.ssrEnabled})}ensureResources(t){const i=this._techniqueRep.constructionContext.waterTextureRepository;return i.ready||i.updating||i.loadTextures(t),i.ready?ma.LOADED:ma.LOADING}beginSlot(t){return this._output===j.Color&&(this._updateShadowState(t),this._updateSSRState(t)),this.updateParameters(t)}bind(t,i){i.bindPass(this._material.parameters,t),this._output!==j.Normal&&this._output!==j.Color||this.setElapsedTimeUniform(i.program)}}const lZe=kr().vec3f(E.POSITION),cZe=kr().vec3f(E.POSITION).vec2f(E.UV0),Ive=kr().vec3f(E.POSITION).vec4u8(E.COLOR);class b4{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(E.POSITION).length}write(t,i,r,s){o4(i,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,r,s)}}const $ve=I({waveStrength:.06,waveTextureRepeat:32,waveDirection:vi(1,0),waveVelocity:.05,flowStrength:.015,flowOffset:-.5,animationSpeed:.35,color:[0,0,0,0],transparent:!0,writeDepth:!0,slicePlaneEnabled:!1,isDraped:!1,receiveShadows:!0,ssrEnabled:!1},ju),uZe={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}};class Dve extends od{constructor(t){super(t,$ve),this._techniqueConfig=new eu,this.animation=new Kge}getTechniqueConfig(t,i){return this._techniqueConfig.output=t,this._techniqueConfig.writeDepth=this.parameters.writeDepth,this._techniqueConfig.receiveShadows=this.parameters.receiveShadows,this._techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this._techniqueConfig.transparent=this.parameters.transparent,this._techniqueConfig.useSSR=this.parameters.ssrEnabled,this._techniqueConfig.isDraped=this.parameters.isDraped,this._techniqueConfig.transparencyPassType=i.transparencyPassType,this._techniqueConfig.enableOffset=i.camera.relativeElevation<l4,this._techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this._techniqueConfig.cullAboveGround=i.cullAboveGround,this._techniqueConfig}update(t){const i=Math.min(t.camera.relativeElevation,t.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*i<hZe;const r=this.animation.advance(t);return this.animation.enabled&&r}intersect(t,i,r,s,n,o,a){n4(t,i,s,n,o,void 0,a)}requiresSlot(t,i){switch(Q1(i)){case j.Normal:return t===ve.DRAPED_WATER;case j.Color:if(this.parameters.isDraped)return t===ve.DRAPED_MATERIAL;break;case j.Highlight:return t===ve.OPAQUE_MATERIAL||t===ve.DRAPED_MATERIAL}let r=ve.OPAQUE_MATERIAL;return this.parameters.transparent&&(r=this.parameters.writeDepth?ve.TRANSPARENT_MATERIAL:ve.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),t===r}createGLMaterial(t){if(t.output===j.Color&&this.parameters.isDraped)return t.output=j.Draped,new eie(t);switch(t.output){case j.Color:case j.Normal:case j.Highlight:case j.Alpha:return new eie(t)}return null}createBufferWriter(){return new b4(cZe)}}const hZe=35e3;class tie{constructor(t){this.first=t.from,this.count=t.to-t.from}}class nx{constructor(t=0,i=0){this.from=t,this.to=i}}class dZe extends nx{constructor(t,i,r,s,n,o){super(i,r),this.id=t,this.isVisible=s,this.hasHighlights=n,this.hasOccludees=o}}function iie(e){return Array.from(e.values()).sort(pZe)}function pZe(e,t){return e.from===t.from?e.to-t.to:e.from-t.from}function N3(e,t){if(e.length===0)return void e.push(new tie(t));const i=e[e.length-1];if(fZe(i,t)){const r=t.from-i.first+t.to-t.from;i.count=r}else e.push(new tie(t))}function fZe(e,t){return e.first+e.count>=t.from}class mZe{constructor(t,i){this._pool=t,this._size=0,this._buffer=t.newBuffer(K9(i))}dispose(){this._buffer=this._pool.deleteBuffer(this._buffer),this._size=0}release(){this.erase(0,this._size),this.dispose()}get vao(){return this._buffer.vao}get array(){return this._buffer.array}get size(){return this._size}grow(t){this._resize(this._size+t,!0).dispose()}alloc(t){return this._resize(t,!1)}_resize(t,i){let r;const s=gZe(this._buffer.length,this._size,t);if(this._buffer.length!==s){const o=this._pool.newBuffer(s);i&&(o.array.set(this._buffer.array.subarray(0,Math.min(this._size,s))),o.vao.vertexBuffers.geometry.setSubData(o.array,0,0,o.array.byteLength)),r=this._buffer,this._buffer=o}const n=this._size;return this._size=t,r?{dispose:()=>{r.array.fill(0,0,n),this._pool.deleteBuffer(r)},copy:(o,a,l)=>this._buffer.array.set(r.array.subarray(a,l),o),hasNewBuffer:!0}:{dispose:()=>{},copy:(o,a,l)=>{o!==a&&this._buffer.array.copyWithin(o,a,l)},hasNewBuffer:!1}}erase(t,i){this._buffer.array.fill(0,t,i)}}const rie=65536;function K9(e){return Math.ceil(e/rie)*rie}function gZe(e,t,i){return t<=i?e>=i?e:K9(Math.max(2*e,i)):e<=2*i?e:K9(i)}class yZe{constructor(t,i,r,s){this.vao=new us(t,i,{geometry:r},{geometry:jt.createVertex(t,ri.STATIC_DRAW)}),this.array=new Float32Array(s),this.vao.vertexBuffers.geometry.setSize(this.array.byteLength)}dispose(){this.vao.dispose(!0)}get length(){return this.array.length}}const vZe=VI+1;class _Ze{constructor(t,i,r){this._rctx=t,this._locations=i,this._layout=r,this._cache=t.newCache(`MergedRenderer pool ${Ta()}`,bZe)}dispose(){this._cache.destroy()}newBuffer(t){const i=t.toString(),r=this._cache.pop(i);if(_(r)){const s=r.pop();return r.length>0&&this._cache.put(i,r,s.array.byteLength*r.length,vZe),s}return new yZe(this._rctx,this._locations,this._layout,t)}deleteBuffer(t){const i=t.array.byteLength,r=t.array.length.toString(),s=this._cache.pop(r);return _(s)?(s.push(t),this._cache.put(r,s,i*s.length,-1)):this._cache.put(r,[t],i,-1),null}}function bZe(e,t){if(t===Jf.ALL)return void e.forEach(s=>s.dispose());const i=e.pop(),r=e.length*i.array.byteLength;return i.dispose(),r}class Lve{constructor(t,i,r){this._rctx=t,this._materialRepository=i,this._material=r,this.type="MergedRenderer",this._dataByOrigin=new Map,this._renderCommandData=new $t,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new Mve(this._material,this._materialRepository),this._bufferWriter=r.createBufferWriter(),this._bufferPool=new _Ze(t,r.vertexAttributeLocations,Rl(this._bufferWriter.vertexBufferLayout))}dispose(){this._glMaterials.destroy(),this._dataByOrigin.forEach(t=>t.buffer.dispose()),this._dataByOrigin.clear(),this._bufferPool.dispose()}get isEmpty(){return this._dataByOrigin.size===0}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this._material instanceof Dve}get rendersOccluded(){return!this.isEmpty&&this._material.renderOccluded!==Cr.Occlude}modify(t){this._updateGeometries(t.updates),this._addAndRemoveGeometries(t.adds,t.removes),this._updateRenderCommands()}_addAndRemoveGeometries(t,i){const r=this._bufferWriter,s=r.vertexBufferLayout.stride/4,n=this._dataByOrigin,o=xZe(t,i);o.forEach((a,l)=>{o.delete(l);const c=a.toAdd.reduce((w,S)=>w+r.elementCount(S.data),0);let h=n.get(l);if(h==null)at(a.toRemove.length===0),h=new SZe(a.origin,new mZe(this._bufferPool,c*s)),n.set(l,h);else if(a.toAdd.length===0&&h.instances.size===a.toRemove.length)return h.buffer.dispose(),void n.delete(l);let p=0;h.instances.forEach(w=>p+=w.to-w.from);const f=a.toRemove.reduce((w,S)=>w+r.elementCount(S.data),0),g=h.buffer.size,y=(p+c-f)*s,v=AZe;if(y<g/2?this._removeAndRebuild(h,a.toRemove,s,y,v):a.toRemove.length>0&&this._remove(h,a.toRemove,s,v),a.toAdd.length>0){const w=CZe;Xge(w,-a.origin[0],-a.origin[1],-a.origin[2]),this._add(h,a.toAdd,s,w,v)}const b=h.buffer.vao.vertexBuffers.geometry;oie(v),v.forAll(({from:w,to:S})=>{if(w<S){const T=h.buffer.array,A=4,C=w*A,O=S*A;b.setSubData(T,C,C,O)}}),v.clear(),h.drawCommandsDirty=!0})}_updateGeometries(t){const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4;for(const s of t){const n=s.renderGeometry,o=this._dataByOrigin.get(n.origin.id),a=o&&o.instances.get(n.id);if(!a)return;const l=s.updateType;if(l&Gt.State.VISIBILITIES&&(a.isVisible=n.instanceParameters.visible),l&(Gt.State.HIGHLIGHTS|Gt.State.VISIBILITIES)){const c=n.instanceParameters.visible;a.hasHighlights=!!n.instanceParameters.highlights&&c}if(l&Gt.State.OCCLUDEES&&(a.hasOccludees=!!n.instanceParameters.occludees),l&(Gt.State.VERTEXATTRS|Gt.State.TRANSFORMATION)){const{array:c,vao:h}=o.buffer;d7e(n,Rk,H2),i.write({transformation:Rk,invTranspTransformation:H2},n.data,i.vertexBufferLayout.createView(c.buffer),a.from),at(a.from+i.elementCount(n.data)===a.to,"material VBO layout has changed"),h.vertexBuffers.geometry.setSubData(c,a.from*r*4,a.from*r*4,a.to*r*4)}o.drawCommandsDirty=!0}}_updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach(i=>{i.hasHiddenInstances=!1,i.hasHighlights=!1,i.hasOccludees=!1,qr(i.instances,r=>(r.isVisible?(r.hasHighlights&&(this._hasHighlights=!0,i.hasHighlights=!0),r.hasOccludees&&(this._hasOccludees=!0,i.hasOccludees=!0)):i.hasHiddenInstances=!0,i.hasHiddenInstances&&i.hasHighlights&&i.hasOccludees))});const t=i=>{if(i.drawCommandsDefault=null,i.drawCommandsHighlight=null,i.drawCommandsOccludees=null,i.drawCommandsShadowHighlightRest=null,i.instances.size===0)return;if(!nie(i)){const s=this._bufferWriter.vertexBufferLayout.stride,n=4*i.buffer.size/s;return void(i.drawCommandsDefault=[{first:0,count:n}])}const r=iie(i.instances);i.drawCommandsDefault=[],i.drawCommandsHighlight=[],i.drawCommandsOccludees=[],i.drawCommandsShadowHighlightRest=[];for(const s of r)s.isVisible&&(s.hasOccludees?N3(i.drawCommandsOccludees,s):N3(i.drawCommandsDefault,s),s.hasHighlights?N3(i.drawCommandsHighlight,s):N3(i.drawCommandsShadowHighlightRest,s))};this._dataByOrigin.forEach(i=>{i.drawCommandsDirty&&(t(i),i.drawCommandsDirty=!1)})}updateAnimation(t){return this._material.update(t)}requiresSlot(t,i){return t==null||this._material.requiresSlot(t,i)}render(t,i,r){if(!this.requiresSlot(t,i))return!1;const s=i===Le.MATERIAL_HIGHLIGHT||i===Le.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT;if(s&&!this._hasHighlights)return!1;const n=i===Le.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,o=!(s||n);if(this._dataByOrigin.forEach(h=>{if(s&&!h.hasHighlights)return;const p=(s?h.drawCommandsHighlight:n&&nie(h)?h.drawCommandsShadowHighlightRest:h.drawCommandsDefault)||null,f=o&&h.drawCommandsOccludees||null;(_(p)||_(f))&&this._renderCommandData.push(new EZe(h.origin,h.buffer,p,f))}),this._renderCommandData.length===0)return!1;const a=this._rctx,l=this._glMaterials.load(a,i);if(R(l))return this._renderCommandData.clear(),!1;const c=l.beginSlot(r);return a.useTechnique(c,t,!1),l.bind(r,c),this._renderCommandData.forAll(({origin:h,buffer:p,renderCommands:f,occludeeCommands:g})=>{r.origin=h,c.bindDraw(r),c.ensureAttributeLocations(p.vao),a.bindVAO(p.vao);const y=c.primitiveType;_(f)&&this._renderCommands(a,y,f),_(g)&&(c.bindPipelineState(a,t,!0),this._renderCommands(a,y,g),c.bindPipelineState(a,t,!1))}),this._renderCommandData.clear(),!0}_renderCommands(t,i,r){for(let s=0;s<r.length;s++)t.drawArrays(i,r[s].first,r[s].count)}_removeAndRebuild(t,i,r,s,n){for(const h of i)t.instances.delete(h.id);const o=iie(t.instances);t.instances.clear();const a=t.buffer.size,l=t.buffer.alloc(s);let c=0;for(const h of o){const p=h.from*r,f=h.to*r;l.copy(c,p,f),h.from=c/r,c+=f-p,h.to=c/r,t.instances.set(h.id,h)}n.push(new nx(0,l.hasNewBuffer?t.buffer.array.length:a)),l.dispose(),t.buffer.erase(c,n.back().to),t.holes.clear()}_remove(t,i,r,s){for(const n of i){const o=n.id,a=t.instances.get(o),l=a.from*r,c=a.to*r;t.buffer.erase(l,c),t.holes.push(new nx(a.from,a.to)),t.instances.delete(o),s.push(new nx(l,c))}oie(t.holes)}_add(t,i,r,s,n){if(i.length===0)return;const o=this._bufferWriter;let a=o.vertexBufferLayout.createView(t.buffer.array.buffer);const l=t.holes.length>0;let c=Number.MAX_SAFE_INTEGER,h=Number.MIN_SAFE_INTEGER;for(const p of i){const f=_(p.transformation)?dr(Rk,s,p.transformation):s;fr(H2,f);const g=Oa(H2,H2),y=o.elementCount(p.data),v=y*r;let b=TZe(t.holes,y);R(b)&&(b=t.buffer.size/r,t.buffer.grow(v),a=o.vertexBufferLayout.createView(t.buffer.array.buffer)),o.write({transformation:f,invTranspTransformation:g},p.data,a,b);const w=p.instanceParameters.visible,S=!!p.instanceParameters.highlights&&w,T=!!p.instanceParameters.occludees,A=new dZe(p.id,b,b+y,w,S,T);at(t.instances.get(p.id)==null),t.instances.set(p.id,A),l?n.push(new nx(A.from*r,A.to*r)):(c=Math.min(A.from,c),h=Math.max(A.to,h))}l||n.push(new nx(c*r,h*r))}get test(){return{material:this._material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}class wZe{constructor(t){this.origin=t,this.toAdd=new Array,this.toRemove=new Array}}function xZe(e,t){const i=new Map;for(const r of e)sie(i,r,!0);for(const r of t)sie(i,r,!1);return i}function sie(e,t,i){const r=t.origin;if(R(r))return;let s=e.get(r.id);s==null&&(s=new wZe(r.vec3),e.set(r.id,s)),i?s.toAdd.push(t):s.toRemove.push(t)}function nie(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}function TZe(e,t){let i;if(!e.some(s=>!(s.to-s.from<t)&&(i=s,!0)))return null;const r=i.from;return i.from+=t,i.from>=i.to&&e.removeUnordered(i),r}function oie(e){const t=new Map;e.forAll(r=>t.set(r.from,r));let i=!0;for(;i;)i=!1,e.forEach(r=>{const s=t.get(r.to);s&&(r.to=s.to,t.delete(s.from),e.removeUnordered(s),i=!0)})}class SZe{constructor(t,i){this.origin=t,this.buffer=i,this.instances=new Map,this.holes=new $t({deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!1}}class EZe{constructor(t,i,r,s){this.origin=t,this.buffer=i,this.renderCommands=r,this.occludeeCommands=s}}const AZe=new $t({deallocator:null}),CZe=Te(),Rk=Te(),H2=Te();let k_=class extends we{constructor(){super(...arguments),this._pending=new RZe,this._changes=new Rve,this._materialRenderers=new Map,this._sortedMaterialRenderers=new $t,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach(e=>e.dispose()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return qr(this._materialRenderers,e=>e.rendersOccluded)}get isEmpty(){return!this.updating&&this._materialRenderers.size===0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=Ove(this._changes);let t=!1,i=!1,r=!1;return e.forEach((s,n)=>{let o=this._materialRenderers.get(n);if(!o&&s.adds.length>0&&(o=new Lve(this.rctx,this.materialRepository,n),this._materialRenderers.set(n,o),t=!0,i=!0,r=!0),!o)return;const a=i||o.hasHighlights,l=r||o.hasWater;o.modify(s),i=i||a!==o.hasHighlights,r=r||l!==o.hasWater,o.isEmpty&&(this._materialRenderers.delete(n),o.dispose(),t=!0)}),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),i&&(this._hasHighlights=qr(this._materialRenderers,s=>s.hasHighlights)),r&&(this._hasWater=qr(this._materialRenderers,s=>s.hasWater)),this.notifyChange("updating"),!0}add(e){if(e.length===0)return;const t=this._pending.empty;for(const i of e)this._pending.adds.add(i);t&&this.notifyChange("updating")}remove(e){const t=this._pending.empty;for(const i of e)this._pending.adds.has(i)?(this._pending.removed.add(i),this._pending.adds.delete(i)):this._pending.removed.has(i)||this._pending.removes.add(i);t&&!this._pending.empty&&this.notifyChange("updating")}modify(e,t){const i=this._changes.updates.length===0;for(const r of e){const s=this._changes.updates.pushNew();s.renderGeometry=r,s.updateType=t}i&&this._changes.updates.length>0&&this.notifyChange("updating")}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll(({materialRenderer:i})=>t=i.updateAnimation(e)||t),t}render(e,t){for(let i=0;i<this._sortedMaterialRenderers.length;i++){const r=this._sortedMaterialRenderers.data[i];r.material.shouldRender(e)&&r.materialRenderer.render(t.slot,e.pass,t)}}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach((t,i)=>{i.insertOrder=e++,this._sortedMaterialRenderers.push({material:i,materialRenderer:t})}),this._sortedMaterialRenderers.sort((t,i)=>{const r=i.material.renderPriority-t.material.renderPriority;return r!==0?r:t.material.insertOrder-i.material.insertOrder})}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};u([d()],k_.prototype,"rctx",void 0),u([d()],k_.prototype,"materialRepository",void 0),u([d()],k_.prototype,"updating",null),k_=u([P("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],k_);class RZe{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(t){return this.adds.has(t)||this.removes.has(t)||this.removed.has(t)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const zyt=(()=>{if(!("document"in globalThis))return()=>null;const e=document.createElement("canvas"),t=e.getContext("2d"),i=512;return e.height=i,e.width=1,r=>{t.clearRect(0,0,1,e.height);const s=t.createLinearGradient(0,0,0,e.height);for(const{ratio:n,color:o}of r)s.addColorStop(Math.max(n,.001),`rgba(${o.r}, ${o.g}, ${o.b}, ${o.a})`);return t.fillStyle=s,t.fillRect(0,0,1,e.height),t.getImageData(0,0,1,e.height).data}})();function Byt(e,t,i,r){const{blurRadius:s,fieldOffset:n,field:o}=t,a=new Float64Array(i*r),l=Nve(s),c=Math.round(3*s);let h,p=Number.NEGATIVE_INFINITY;const f=OZe(o,n),g=new Set;for(const y of e){const v=y.getCursor();for(;v.next();){const b=v.getObjectId();if(g.has(b))continue;g.add(b);const w=v.readLegacyPointGeometry(),S=128;if(w.x<-S||w.x>=i+S||w.y<-S||w.y>r+S)continue;const T=+f(v),A=Math.round(w.x)-c,C=Math.round(w.y)-c,O=Math.max(0,A),L=Math.max(0,C),U=Math.min(r,Math.round(w.y)+c),N=Math.min(i,Math.round(w.x)+c);for(let z=L;z<U;z++){const V=l[z-C];for(let B=O;B<N;B++){const J=l[B-A];h=a[z*i+B]+=V*J*T,h>p&&(p=h)}}}}return{matrix:a.buffer,max:p}}function Nve(e){const t=Math.round(3*e),i=2*e*e,r=new Float64Array(2*t+1);for(let s=0;s<=r.length;s++)r[s]=Math.exp(-((s-t)**2)/i)/Math.sqrt(2*Math.PI)*(e/2);return r}function OZe(e,t){return e!=null?typeof t=="string"?i=>-1*+i.readAttribute(e):i=>+i.readAttribute(e)+t:i=>1}var Ac;function MZe(e){const t=new Oi,{mode:i,isAttributeDriven:r}=e;return t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.UV0,"vec2"),e.isAttributeDriven&&(t.attributes.add(E.FEATUREATTRIBUTE,"float"),t.varyings.add("attributeValue","float")),t.varyings.add("unitCirclePos","vec2"),t.vertex.uniforms.add("radius","float"),t.vertex.uniforms.add("proj","mat4"),t.vertex.uniforms.add("view","mat4"),t.vertex.code.add(x`
    void main() {
      unitCirclePos = uv0;

      vec4 posProj = proj * (view * vec4(${E.POSITION}, 1.0));
      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);

      ${r?x`attributeValue = ${E.FEATUREATTRIBUTE};`:""}
      gl_Position = posProj + quadOffset;
    }
  `),i===Ac.KernelDensity?t.fragment.code.add(x`
      void main() {
        float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
        if (radiusRatioSquared > 1.0) {
          discard;
        }

        float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;
        float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared ${r?x` * attributeValue`:""};
        gl_FragColor = vec4(density);
      }
    `):i===Ac.GaussianBlur&&(t.fragment.uniforms.add("kernel","sampler2D"),t.fragment.code.add(x`
    void main() {
      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
      if (radiusRatioSquared > 1.0) {
        discard;
      }

      vec2 uv = abs(unitCirclePos);
      vec2 uvX = vec2(uv.x, 0.5);
      vec2 uvY = vec2(uv.y, 0.5);
      float intensity = texture2D(kernel, uvX).r * texture2D(kernel, uvY).r${r?x` * attributeValue`:""};
      gl_FragColor = vec4(intensity);
    }
  `)),t}(function(e){e[e.GaussianBlur=0]="GaussianBlur",e[e.KernelDensity=1]="KernelDensity"})(Ac||(Ac={}));const PZe=Object.freeze({__proto__:null,get HeatmapMode(){return Ac},build:MZe});var aie;(function(e){e[e.Screen=0]="Screen",e[e.World=1]="World"})(aie||(aie={}));class w4 extends Gi{constructor(t,i,r){super(t,i,r),this._kernelBlurRadius=1;const{R32F:s,textureFloatLinear:n}=t.rctx.capabilities.textureFloat,o=s!=null;this._kernelTextureChannels=o?1:4,this._floatInterpolationDisabled=!n;const a={target:st.TEXTURE_2D,pixelFormat:o?$e.RED:$e.RGBA,internalFormat:o?nt.R32F:$e.RGBA,dataType:yt.FLOAT,samplingMode:Ge.NEAREST,wrapMode:ct.CLAMP_TO_EDGE,width:1,height:1};this._kernel=new Qe(t.rctx,a)}initializeProgram(t){const i=w4.shader.get().build({isAttributeDriven:this.configuration.isAttributeDriven,mode:this.configuration.mode});return new Mi(t.rctx,i,mi)}initializePipeline(){return Ot({blending:Sc(Ee.ONE,Ee.ONE,Cp.ADD),colorWrite:Ft,depthTest:null,depthWrite:null})}bindPass(t,i){const{camera:r}=i,{mode:s}=this.configuration;switch(Ol(this.program,r.projectionMatrix),s){case Ac.KernelDensity:this._bindKernelDensityPass(t,i);break;case Ac.GaussianBlur:this._bindGaussianBlurPass(t,i)}}bindDraw(t){Gp(this.program,t)}_bindKernelDensityPass({searchRadius:t,resolutionForScale:i},{camera:r,screenToWorldRatio:s}){i!==0&&(t/=s/i),this.program.setUniform1f("radius",t*r.pixelRatio/r.fullViewport[2])}_bindGaussianBlurPass({searchRadius:t,resolutionForScale:i},{camera:r,screenToWorldRatio:s}){const n=Math.round(t),o=3*(i===0?n:n*i/s);i===0||this._floatInterpolationDisabled?this._kernel.setSamplingMode(Ge.NEAREST):this._kernel.setSamplingMode(Ge.LINEAR),this._kernelBlurRadius!==n&&this._recomputeKernel(n),this.program.setUniform1f("radius",2*o*r.pixelRatio/r.fullViewport[2]),this.program.bindTexture(this._kernel,"kernel")}_recomputeKernel(t){const i=Nve(t),r=Math.ceil(i.length/2),s=this._kernelTextureChannels,n=new Float32Array(r*s);for(let o=0;o<r;++o){const a=i[r-1-o];for(let l=0;l<s;++l)n[o*s+l]=a}this._kernel.resize(r,1),this._kernel.setData(n),this._kernelBlurRadius=t}destroy(){this._kernel=tt(this._kernel),super.destroy()}}w4.shader=new Ni(PZe,()=>import("./HeatmapDensity.glsl.8fc5f8fa.js"));class eG extends mr{constructor(){super(...arguments),this.isAttributeDriven=!1,this.mode=Ac.GaussianBlur}}u([Z()],eG.prototype,"isAttributeDriven",void 0),u([Z()],eG.prototype,"mode",void 0);const IZe=I({searchRadius:128,resolutionForScale:0,colorRampData:null,isAttributeDriven:!1,minDensity:0,maxDensity:100,fieldTotal:0,pixelRatio:1},ju);class $Ze extends od{constructor(t){super(t,IZe),this._techniqueConfig=new eG}requiresSlot(t,i){return t===ve.DRAPED_MATERIAL&&i===Le.MATERIAL}getTechniqueConfig(){return this._techniqueConfig.isAttributeDriven=this.parameters.isAttributeDriven,this._techniqueConfig}createGLMaterial(t){return new DZe(t)}intersect(){}createBufferWriter(){return new LZe(this.parameters.isAttributeDriven?NZe:Fve)}}class DZe extends Zm{constructor(t){super(t)}beginSlot(t){return this.updateParameters(t)}updateParameters(t){return this.ensureTechnique(w4,t)}bind(t,i){i.bindPass(this._material.parameters,t)}}class LZe{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(E.POSITION).length*Ok}write(t,i,r,s){FO(i.indices.get(E.POSITION),i.vertexAttributes.get(E.POSITION).data,t.transformation,r.position,s,Ok);const n=i.indices.get(E.POSITION).length,o=r.uv0;let a=s;for(let c=0;c<n;++c)o.setValues(a++,-1,-1),o.setValues(a++,1,-1),o.setValues(a++,1,1),o.setValues(a++,1,1),o.setValues(a++,-1,1),o.setValues(a++,-1,-1);const l="featureAttribute"in r?r.featureAttribute:null;l&&Dqe(i.indices.get(E.FEATUREATTRIBUTE),i.vertexAttributes.get(E.FEATUREATTRIBUTE).data,l,s,Ok)}}const Fve=kr().vec3f(E.POSITION).vec2f(E.UV0),NZe=Fve.clone().f32(E.FEATUREATTRIBUTE),Ok=6;function FZe(e){return e instanceof $Ze}function UZe(e){const t=new Oi,{mode:i}=e;return t.include(G0),t.include(vm,{alphaDiscardMode:Ri.Blend}),t.fragment.uniforms.add("densityMap","sampler2D"),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("densityNormalizer","float"),t.fragment.uniforms.add("minDensity","float"),i===Ac.KernelDensity&&t.fragment.uniforms.add("densityMultiplier","float"),t.fragment.code.add(x`
    void main() {
      float density = texture2D(densityMap, uv).r${i===Ac.KernelDensity?x` * densityMultiplier`:""};
      float densityRatio = (density - minDensity) * densityNormalizer;

      vec4 color = texture2D(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));

      discardOrAdjustAlpha(color);
      gl_FragColor = color;
    }
  `),t}const kZe=Object.freeze({__proto__:null,build:UZe,get HeatmapMode(){return Ac}});class x4 extends Gi{constructor(t,i){super(t,i,()=>this.destroy())}initializeProgram(t){const i=x4.shader.get().build({mode:this.configuration.mode});return new Mi(t.rctx,i,mi)}initializePipeline(t){return Ot({blending:gl,colorWrite:Ft,depthTest:null,depthWrite:null})}bindPass(t,i){const{densityMap:r,colorRamp:s,maxDensity:n,minDensity:o,searchRadius:a}=t;this.program.bindTexture(r,"densityMap"),this.program.bindTexture(s,"tex"),this.configuration.mode===Ac.KernelDensity&&this.program.setUniform1f("densityMultiplier",3/(a*a*Math.PI)),this.program.setUniform1f("densityNormalizer",1/(n-o)),this.program.setUniform1f("minDensity",o)}get primitiveType(){return Tt.TRIANGLE_STRIP}}x4.shader=new Ni(kZe,()=>import("./Heatmap.glsl.1ad69f50.js"));class Uve extends mr{constructor(){super(...arguments),this.mode=Ac.GaussianBlur}}u([Z()],Uve.prototype,"mode",void 0);let HL=class extends k_{constructor(){super(...arguments),this.type="draped-heatmap"}initialize(){super.initialize();const e={colorTarget:vr.TEXTURE,depthStencilTarget:ti.NONE,width:0,height:0},{capabilities:t}=this.rctx,{R32F:i}=t.colorBufferFloat,{textureFloatLinear:r}=t.textureFloat,s=i!=null,n={target:st.TEXTURE_2D,pixelFormat:s?$e.RED:$e.RGBA,internalFormat:s?nt.R32F:$e.RGBA,dataType:yt.FLOAT,samplingMode:r?Ge.LINEAR:Ge.NEAREST,wrapMode:ct.CLAMP_TO_EDGE,width:0,height:0};this._densityMap=new zi(this.rctx,e,n),this._quad=bo(this.rctx);const o={target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.LINEAR,wrapMode:ct.CLAMP_TO_EDGE,width:1,height:1},a=new Qe(this.rctx,o,new Uint8ClampedArray(4));this._colorRamp=a,this._technique=new x4({rctx:this.rctx,viewingMode:Ie.Local},new Uve),this._heatmapParameters={colorRamp:a,densityMap:this._densityMap.colorTexture,searchRadius:1,minDensity:0,maxDensity:100,fieldTotal:0}}destroy(){this._technique=Xi(this._technique),this._densityMap=tt(this._densityMap),this._quad=tt(this._quad),this._colorRamp=tt(this._colorRamp)}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccluded(){return!1}get _heatmapDensityMaterialRenderers(){return this._sortedMaterialRenderers.filter(zZe)}add(e){super.add(e)}remove(e){super.remove(e)}render(e,t){const i=this._heatmapDensityMaterialRenderers,r=i.length;if(r<1)return;const s=this.rctx.getBoundFramebufferObject(),n=this.rctx.getViewport(),o=i[0].material.parameters,{pixelRatio:a}=o,l=Math.ceil(n.width*a),c=Math.ceil(n.height*a);this._densityMap.resize(l,c),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,l,c),this.rctx.clear(bi.COLOR_BUFFER_BIT);let h=!1;for(let w=0;w<r;w++){const S=i[w];S.material.shouldRender(e)&&(h=h||S.materialRenderer.render(t.slot,e.pass,t))}if(this.rctx.bindFramebuffer(s),this.rctx.setViewport(n.x,n.y,n.width,n.height),!h)return;const{searchRadius:p,minDensity:f,maxDensity:g,fieldTotal:y,colorRampData:v}=o,b=this._heatmapParameters;if(b.searchRadius=p,b.fieldTotal=y,b.searchRadius=p,b.minDensity=f,b.maxDensity=g,_(v)&&v!==this._colorRampData){const{colorRamp:w}=b,S=w.descriptor.width,T=v.length/4;T!==S&&w.resize(T,1),w.setData(v),this._colorRampData=v}this.rctx.bindVAO(this._quad),this.rctx.useProgram(this._technique.program),this._technique.bindPipelineState(this.rctx),this._technique.bindPass(b,t),this.rctx.drawArrays(this._technique.primitiveType,0,vn(this._quad,"geometry"))}};function zZe(e){return FZe(e.material)}HL=u([P("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],HL);const BZe=he.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository");class VZe{constructor(t){this._glMaterial=t,this.refCnt=0,this._glMaterial=t}incRefCnt(){++this.refCnt}decRefCnt(){--this.refCnt,at(this.refCnt>=0)}getRefCnt(){return this.refCnt}get glMaterial(){return this._glMaterial}}class kve{constructor(t,i,r,s){this._textureRepository=t,this._techniqueRepository=i,this.materialChanged=r,this.requestRender=s,this._id2glMaterialRef=new RW}dispose(){this._textureRepository.dispose()}acquire(t,i){this._ownMaterial(t);let r=this._id2glMaterialRef.get(i,t.id);if(R(r)){const s=t.createGLMaterial({material:t,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:i});r=new VZe(s),this._id2glMaterialRef.set(i,t.id,r)}return r.incRefCnt(),r.glMaterial}release(t,i){const r=this._id2glMaterialRef.get(i,t.id);_(r)&&(r.decRefCnt(),r.getRefCnt()===0&&(tt(r.glMaterial),this._id2glMaterialRef.delete(i,t.id)))}_ownMaterial(t){_(t.repository)&&t.repository!==this&&BZe.error("Material is already owned by a different material repository"),t.repository=this}}const GZe=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","vertexAttrsUpdated"];class zve{constructor(t,i){this._objectToBoundingSphere=t,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new Er,this._objectCount=0,i&&(i.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=i.maximumObjectsPerNode),i.maximumDepth!==void 0&&(this._maximumDepth=i.maximumDepth))}get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}destroy(){this._degenerateObjects.clear(),Er.clearPool(),tG[0]=null,uv.prune(),f_.prune()}add(t,i=t.length){this._objectCount+=i,this._grow(t,i);const r=Er.acquire();for(let s=0;s<i;s++){const n=t[s];this._isDegenerate(n)?this._degenerateObjects.add(n):(r.init(this._root),this._add(n,r))}Er.release(r)}remove(t,i=null){this._objectCount-=t.length;const r=Er.acquire();for(const s of t){const n=_(i)?i:qT(this._objectToBoundingSphere(s),XZe);TA(n[3])?(r.init(this._root),this._remove(s,n,r)):this._degenerateObjects.delete(s)}Er.release(r),this._shrink()}update(t,i){if(!TA(i[3])&&this._isDegenerate(t))return;const r=WZe(t);this.remove(r,i),this.add(r)}forEachAlongRay(t,i,r){const s=xc(t,i);this._forEachNode(this._root,n=>{if(!this._intersectsNode(s,n))return!1;const o=n.node;return o.terminals.forAll(a=>{this._intersectsObject(s,a)&&r(a)}),o.residents!==null&&o.residents.forAll(a=>{this._intersectsObject(s,a)&&r(a)}),!0})}forEachAlongRayWithVerticalOffset(t,i,r,s){const n=xc(t,i);this._forEachNode(this._root,o=>{if(!this._intersectsNodeWithOffset(n,o,s))return!1;const a=o.node;return a.terminals.forAll(l=>{this._intersectsObjectWithOffset(n,l,s)&&r(l)}),a.residents!==null&&a.residents.forAll(l=>{this._intersectsObjectWithOffset(n,l,s)&&r(l)}),!0})}forEach(t){this._forEachNode(this._root,i=>{const r=i.node;return r.terminals.forAll(t),r.residents!==null&&r.residents.forAll(t),!0}),this._degenerateObjects.forEach(t)}forEachDegenerateObject(t){this._degenerateObjects.forEach(t)}findClosest(t,i,r,s=()=>!0,n=1/0){let o=1/0,a=1/0,l=null;const c=Mk(t,i),h=p=>{if(--n,!s(p))return;const f=this._objectToBoundingSphere(p);if(!Qy(r,f))return;const g=Sy(t,i,Tc(f)),y=g-f[3],v=g+f[3];y<o&&(o=y,a=v,l=p)};return this._forEachNodeDepthOrdered(this._root,p=>{if(n<=0||!Qy(r,p.bounds)||(ae(Nc,c,p.halfSize),pe(Nc,Nc,p.bounds),Sy(t,i,Nc)>a))return!1;const f=p.node;return f.terminals.forAll(g=>h(g)),f.residents!==null&&f.residents.forAll(g=>h(g)),!0},t,i),l}forEachInDepthRange(t,i,r,s,n,o,a){let l=-1/0,c=1/0;const h={setRange:v=>{r===hc.FRONT_TO_BACK?(l=Math.max(l,v.near),c=Math.min(c,v.far)):(l=Math.max(l,-v.far),c=Math.min(c,-v.near))}};h.setRange(s);const p=Sy(i,r,t),f=Mk(i,r),g=Mk(i,-r),y=v=>{if(!a(v))return;const b=this._objectToBoundingSphere(v),w=Tc(b),S=Sy(i,r,w)-p,T=S-b[3],A=S+b[3];T>c||A<l||!Qy(o,b)||n(v,h)};this._forEachNodeDepthOrdered(this._root,v=>{if(!Qy(o,v.bounds)||(ae(Nc,f,v.halfSize),pe(Nc,Nc,v.bounds),Sy(i,r,Nc)-p>c)||(ae(Nc,g,v.halfSize),pe(Nc,Nc,v.bounds),Sy(i,r,Nc)-p<l))return!1;const b=v.node;return b.terminals.forAll(w=>y(w)),b.residents!==null&&b.residents.forAll(w=>y(w)),!0},i,r)}forEachNode(t){this._forEachNode(this._root,i=>t(i.node,i.bounds,i.halfSize))}_intersectsNode(t,i){return F3(i.bounds,2*-i.halfSize,Zl),F3(i.bounds,2*i.halfSize,Ql),vee(t.origin,t.direction,Zl,Ql)}_intersectsNodeWithOffset(t,i,r){return F3(i.bounds,2*-i.halfSize,Zl),F3(i.bounds,2*i.halfSize,Ql),r.applyToMinMax(Zl,Ql),vee(t.origin,t.direction,Zl,Ql)}_intersectsObject(t,i){const r=this._objectToBoundingSphere(i);return!(r[3]>0)||cV(r,t)}_intersectsObjectWithOffset(t,i,r){const s=this._objectToBoundingSphere(i);return!(s[3]>0)||cV(r.applyToBoundingSphere(s),t)}_forEachNode(t,i){let r=Er.acquire().init(t);const s=[r];for(;s.length!==0;){if(r=s.pop(),i(r)&&!r.isLeaf())for(let n=0;n<r.node.children.length;n++)r.node.children[n]&&s.push(Er.acquire().init(r).advance(n));Er.release(r)}}_forEachNodeDepthOrdered(t,i,r,s=hc.FRONT_TO_BACK){let n=Er.acquire().init(t);const o=[n];for(qZe(r,s,uie);o.length!==0;){if(n=o.pop(),i(n)&&!n.isLeaf())for(let a=7;a>=0;--a){const l=uie[a];n.node.children[l]&&o.push(Er.acquire().init(n).advance(l))}Er.release(n)}}_remove(t,i,r){uv.clear();const s=r.advanceTo(i,(n,o)=>{uv.push(n.node),uv.push(o)})?r.node.terminals:r.node.residents;if(s.removeUnordered(t),s.length===0)for(let n=uv.length-2;n>=0;n-=2){const o=uv.data[n],a=uv.data[n+1];if(!this._purge(o,a))break}}_nodeIsEmpty(t){if(t.terminals.length!==0)return!1;if(t.residents!==null)return t.residents.length===0;for(let i=0;i<t.children.length;i++)if(t.children[i])return!1;return!0}_purge(t,i){return i>=0&&(t.children[i]=null),!!this._nodeIsEmpty(t)&&(t.residents===null&&(t.residents=new $t({shrink:!0})),!0)}_add(t,i){i.advanceTo(this._objectToBoundingSphere(t))?i.node.terminals.push(t):(i.node.residents.push(t),i.node.residents.length>this._maximumObjectsPerNode&&i.depth<this._maximumDepth&&this._split(i))}_split(t){const i=t.node.residents;t.node.residents=null;for(let r=0;r<i.length;r++){const s=Er.acquire().init(t);this._add(i.getItemAt(r),s),Er.release(s)}}_grow(t,i){if(i!==0&&(lie(t,i,r=>this._objectToBoundingSphere(r),md),TA(md[3])&&!this._fitsInsideTree(md)))if(this._nodeIsEmpty(this._root.node))qT(md,this._root.bounds),this._root.halfSize=1.25*md[3];else{const r=this._rootBoundsForRootAsSubNode(md);this._placingRootViolatesMaxDepth(r)?this._rebuildTree(md,r):this._growRootAsSubNode(r),Er.release(r)}}_rebuildTree(t,i){ne(Ik,i.bounds),Ik[3]=i.halfSize,lie([t,Ik],2,s=>s,$k);const r=Er.acquire().init(this._root);this._root.initFrom(null,$k,1.25*$k[3]),this._forEachNode(r,s=>(this.add(s.node.terminals.data,s.node.terminals.length),s.node.residents!==null&&this.add(s.node.residents.data,s.node.residents.length),!0)),Er.release(r)}_placingRootViolatesMaxDepth(t){const i=Math.log(t.halfSize/this._root.halfSize)*Math.LOG2E;let r=0;return this._forEachNode(this._root,s=>(r=Math.max(r,s.depth),r+i<=this._maximumDepth)),r+i>this._maximumDepth}_rootBoundsForRootAsSubNode(t){const i=t[3],r=t;let s=-1/0;const n=this._root.bounds,o=this._root.halfSize;for(let a=0;a<3;a++){const l=n[a]-o-(r[a]-i),c=r[a]+i-(n[a]+o),h=Math.max(0,Math.ceil(l/(2*o))),p=Math.max(0,Math.ceil(c/(2*o)))+1,f=2**Math.ceil(Math.log(h+p)*Math.LOG2E);s=Math.max(s,f),U3[a].min=h,U3[a].max=p}for(let a=0;a<3;a++){let l=U3[a].min,c=U3[a].max;const h=(s-(l+c))/2;l+=Math.ceil(h),c+=Math.floor(h);const p=n[a]-o-l*o*2;Pk[a]=p+(c+l)*o}return Pk[3]=s*o*Vve,Er.acquire().initFrom(null,Pk,s*o,0)}_growRootAsSubNode(t){const i=this._root.node;ne(md,this._root.bounds),md[3]=this._root.halfSize,this._root.init(t),t.advanceTo(md,null,!0),t.node.children=i.children,t.node.residents=i.residents,t.node.terminals=i.terminals}_shrink(){for(;;){const t=this._findShrinkIndex();if(t===-1)break;this._root.advance(t),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let t=null;const i=this._root.node.children;let r=0,s=0;for(;s<i.length&&t==null;)r=s++,t=i[r];for(;s<i.length;)if(i[s++])return-1;return r}_isDegenerate(t){return!TA(this._objectToBoundingSphere(t)[3])}_fitsInsideTree(t){const i=this._root.bounds,r=this._root.halfSize;return t[3]<=r&&t[0]>=i[0]-r&&t[0]<=i[0]+r&&t[1]>=i[1]-r&&t[1]<=i[1]+r&&t[2]>=i[2]-r&&t[2]<=i[2]+r}}class Er{constructor(){this.bounds=xn(),this.halfSize=0,this.initFrom(null,null,0,0)}init(t){return this.initFrom(t.node,t.bounds,t.halfSize,t.depth)}initFrom(t,i,r,s=this.depth){return this.node=_(t)?t:Er.createEmptyNode(),_(i)&&qT(i,this.bounds),this.halfSize=r,this.depth=s,this}advance(t){let i=this.node.children[t];i||(i=Er.createEmptyNode(),this.node.children[t]=i),this.node=i,this.halfSize/=2,this.depth++;const r=Bve[t];return this.bounds[0]+=r[0]*this.halfSize,this.bounds[1]+=r[1]*this.halfSize,this.bounds[2]+=r[2]*this.halfSize,this.bounds[3]=this.halfSize*Vve,this}advanceTo(t,i,r=!1){for(;;){if(this.isTerminalFor(t))return i&&i(this,-1),!0;if(this.isLeaf()){if(!r)return i&&i(this,-1),!1;this.node.residents=null}const s=this._childIndex(t);i&&i(this,s),this.advance(s)}}isLeaf(){return this.node.residents!=null}isTerminalFor(t){return t[3]>this.halfSize/2}_childIndex(t){const i=this.bounds;return(i[0]<t[0]?1:0)+(i[1]<t[1]?2:0)+(i[2]<t[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new $t({shrink:!0}),residents:new $t({shrink:!0})}}static acquire(){return Er._pool.acquire()}static release(t){Er._pool.release(t)}static clearPool(){Er._pool.prune()}}var hc;function jZe(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function HZe(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function F3(e,t,i){i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t}function lie(e,t,i,r){if(t===1){const s=i(e[0]);qT(s,r)}else{Zl[0]=1/0,Zl[1]=1/0,Zl[2]=1/0,Ql[0]=-1/0,Ql[1]=-1/0,Ql[2]=-1/0;for(let s=0;s<t;s++){const n=i(e[s]);TA(n[3])&&(jZe(Zl,n),HZe(Ql,n))}Cs(r,Zl,Ql,.5),r[3]=Math.max(Ql[0]-Zl[0],Ql[1]-Zl[1],Ql[2]-Zl[2])/2}}function qZe(e,t,i){if(!f_.length)for(let r=0;r<8;++r)f_.push({index:0,distance:0});for(let r=0;r<8;++r){const s=Bve[r];f_.data[r].index=r,f_.data[r].distance=Sy(e,t,s)}f_.sort((r,s)=>r.distance-s.distance);for(let r=0;r<8;++r)i[r]=f_.data[r].index}function Mk(e,t){let i=1/0,r=null;for(let s=0;s<8;++s){const n=Sy(e,t,cie[s]);n<i&&(i=n,r=cie[s])}return r}function Sy(e,t,i){return t*(e[0]*i[0]+e[1]*i[1]+e[2]*i[2])}function TA(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}Er._pool=new Wr(Er),function(e){e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(hc||(hc={}));const Bve=[je(-1,-1,-1),je(1,-1,-1),je(-1,1,-1),je(1,1,-1),je(-1,-1,1),je(1,-1,1),je(-1,1,1),je(1,1,1)],cie=[je(-1,-1,-1),je(-1,-1,1),je(-1,1,-1),je(-1,1,1),je(1,-1,-1),je(1,-1,1),je(1,1,-1),je(1,1,1)],Vve=Math.sqrt(3),tG=[null];function WZe(e){return tG[0]=e,tG}const Pk=xn(),Nc=M(),Zl=M(),Ql=M(),uv=new $t,XZe=xn(),md=xn(),Ik=xn(),$k=xn(),U3=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],f_=new $t,uie=[0,0,0,0,0,0,0,0];class Gve extends PO{constructor(t,i=""){var r,s,n;super(),this.apiLayerUid=i,this.type=rd.Layer,this.events=new xr,this.isSliceable=!1,this._objects=new $t,this._stageHandles=new Ut,this.apiLayerUid=i,this.isVisible=(r=t==null?void 0:t.isVisible)==null||r,this.isPickable=(s=t==null?void 0:t.isPickable)==null||s,this.updatePolicy=(n=t==null?void 0:t.updatePolicy)!=null?n:aS.ASYNC}get objects(){return this._objects}destroy(){this.detachStage(),this._stage=null}attachStage(t){this.detachStage(),this._stage=t;for(const i of GZe)this._stageHandles.add(this.events.on(i,r=>t.handleEvent(i,r)))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}add(t){this._objects.push(t),t.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:t}),_(this._octree)&&this._octree.add([t])}remove(t){this._objects.removeUnordered(t)&&(t.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:t}),_(this._octree)&&this._octree.remove([t]))}addMany(t){this._objects.pushArray(t);for(const i of t)i.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:t}),_(this._octree)&&this._octree.add(t)}removeMany(t){const i=new Array;if(this._objects.removeUnorderedMany(t,t.length,i),i.length!==0){for(const r of i)r.parentLayer=null;this.events.emit("layerObjectsRemoved",{layer:this,objects:i}),_(this._octree)&&this._octree.remove(i)}}sync(){_(this._stage)&&this.updatePolicy!==aS.SYNC&&this._stage.syncLayer(this.id)}notifyObjectBBChanged(t,i){_(this._octree)&&this._octree.update(t,i)}getSpatialQueryAccelerator(){return R(this._octree)&&this._objects.length>50&&this._createOctree(),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=rt(this._octree)}_createOctree(){this._octree=new zve(t=>t.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.data,this._objects.length)}}function qL(e){return _(e)&&e.type===rd.Layer}const MW={vvSizeEnabled:!1,vvSizeMinSize:Ht(1,1,1),vvSizeMaxSize:Ht(100,100,100),vvSizeOffset:Ht(0,0,0),vvSizeFactor:Ht(1,1,1),vvSizeValue:Ht(1,1,1),vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvOpacityEnabled:!1,vvOpacityValues:[0,0,0,0,0,0,0,0],vvOpacityOpacities:[1,1,1,1,1,1,1,1],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:wr()};function jve(e,t){e.vertex.uniforms.add("intrinsicWidth","float"),t.vvSize?(e.attributes.add(E.SIZEFEATUREATTRIBUTE,"float"),e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.code.add(x`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(e.attributes.add(E.SIZE,"float"),e.vertex.code.add(x`float getSize(){
return intrinsicWidth * size;
}`)),t.vvOpacity?(e.attributes.add(E.OPACITYFEATUREATTRIBUTE,"float"),e.vertex.constants.add("vvOpacityNumber","int",8),e.vertex.code.add(x`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):e.vertex.code.add(x`vec4 applyOpacity( vec4 color ){
return color;
}`),t.vvColor?(e.attributes.add(E.COLORFEATUREATTRIBUTE,"float"),e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(x`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 interpolateColor( float value ) {
if (value <= vvColorValues[0]) {
return vvColorColors[0];
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return mix(vvColorColors[i-1], vvColorColors[i], f);
}
}
return vvColorColors[vvColorNumber - 1];
}
vec4 getColor(){
return applyOpacity(interpolateColor(colorFeatureAttribute));
}`)):(e.attributes.add(E.COLOR,"vec4"),e.vertex.code.add(x`vec4 getColor(){
return applyOpacity(color);
}`))}function q0(e,t){e.fragment.include(nd),t.output===j.Shadow?(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(x`float _calculateFragDepth(const in float depth) {
const float SLOPE_SCALE = 2.0;
const float BIAS = 2.0 * .000015259;
float m = max(abs(dFdx(depth)), abs(dFdy(depth)));
float result = depth + SLOPE_SCALE * m + BIAS;
return clamp(result, .0, .999999);
}
void outputDepth(float _linearDepth) {
gl_FragColor = float2rgba(_calculateFragDepth(_linearDepth));
}`)):t.output===j.Depth&&e.fragment.code.add(x`void outputDepth(float _linearDepth) {
gl_FragColor = float2rgba(_linearDepth);
}`)}function Hve(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?YZe(e,t):ZZe(e)}function YZe(e,t){const i=!(t.draped&&t.stipplePreferContinuous);e.fragment.include(nd),e.vertex.uniforms.add("stipplePatternPixelSize","float"),e.vertex.uniforms.add("pixelRatio","float"),t.draped?e.vertex.uniforms.add("worldToScreenRatio","float"):(e.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),e.vertex.uniforms.add("cameraPosition","vec3"),e.vertex.code.add(x`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),e.varyings.add("vStippleDistance","float"),t.stippleRequiresClamp&&e.varyings.add("vStippleDistanceLimits","vec2"),t.stippleRequiresStretchMeasure&&e.varyings.add("vStipplePatternStretch","float"),e.vertex.code.add(x`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${QZe};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),e.vertex.code.add(x`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),e.vertex.code.add(x`
    if (segmentLengthPseudoScreen >= ${i?"patternLength":"1e4"}) {
  `),e.vertex.code.add(x`
        // Round the screen length to get an integer number of pattern repetitions (minimum 1).
        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
        float segmentLengthScreenRounded = flooredRepetitions * patternLength;

        ${t.stippleRequiresStretchMeasure?x`
              float stretch = repetitions / flooredRepetitions;

              // We need to impose a lower bound on the stretch factor to prevent the dots from merging together when there is only 1 repetition.
              // 0.75 is the lowest possible stretch value for flooredRepetitions > 1, so it makes sense as lower bound.
              vStipplePatternStretch = max(0.75, stretch);`:""}

        return vec2(0.0, segmentLengthScreenRounded);
      }
      return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
    }
  `),e.fragment.uniforms.add("stipplePatternTexture","sampler2D"),e.fragment.uniforms.add("stipplePatternSDFNormalizer","float"),e.fragment.uniforms.add("stipplePatternTextureSize","float"),e.fragment.uniforms.add("stipplePatternPixelSizeInv","float"),t.stippleOffColorEnabled&&e.fragment.uniforms.add("stippleOffColor","vec4"),e.fragment.code.add(x`float padTexture(float u) {
return (u * stipplePatternTextureSize + 1.0)/(stipplePatternTextureSize + 2.0);
}`),e.fragment.code.add(x`
    float getStippleSDF(out bool isClamped) {
      ${t.stippleRequiresClamp?x`
          float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
          vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
          isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;`:x`
          float stippleDistanceClamped = vStippleDistance;
          isClamped = false;`}

      float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv;
      ${t.stippleScaleWithLineWidth?x`u *= vLineSizeInv;`:""}
      u = padTexture(fract(u));

      float encodedSDF = rgba2float(texture2D(stipplePatternTexture, vec2(u, 0.5)));
      float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;

      ${t.stippleRequiresStretchMeasure?x`return (sdf - 0.5) * vStipplePatternStretch + 0.5;`:x`return sdf;`}
    }

    float getStippleSDF() {
      bool ignored;
      return getStippleSDF(ignored);
    }

    float getStippleAlpha() {
      bool isClamped;
      float stippleSDF = getStippleSDF(isClamped);

      float antiAliasedResult = ${t.stippleScaleWithLineWidth?x`clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);`:x`clamp(stippleSDF + 0.5, 0.0, 1.0);`}

      return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
    }
  `),t.stippleOffColorEnabled?e.fragment.code.add(x`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`):e.fragment.code.add(x`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}function ZZe(e){e.fragment.code.add(x`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}const QZe=x.float(.4),WL=1;var qh;function JZe(e){const t=new Oi,i=e.capType!==qh.BUTT,r=e.capType===qh.ROUND,s=e.stippleEnabled&&r,n=e.falloffEnabled||s,o=e.innerColorEnabled||r,a=e.stippleEnabled&&e.stippleScaleWithLineWidth||r,l=e.stippleEnabled&&e.stippleScaleWithLineWidth,c=e.stippleEnabled||r;return t.include(jF),t.include(jve,e),t.include(Hve,me(I({},e),{stippleRequiresStretchMeasure:!0})),e.output===j.Depth&&t.include(q0,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("nearFar","vec2").add("pixelRatio","float").add("miterLimit","float").add("screenSize","vec2").add("inverseProjectionMatrix","mat4"),t.vertex.constants.add("LARGE_HALF_FLOAT","float",65500),t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.SUBDIVISIONFACTOR,"float"),t.attributes.add(E.UV0,"vec2"),t.attributes.add(E.AUXPOS1,"vec3"),t.attributes.add(E.AUXPOS2,"vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("linearDepth","float"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),a&&t.varyings.add("vLineWidth","float"),l&&t.varyings.add("vLineSizeInv","float"),o&&t.varyings.add("vLineDistance","float"),n&&t.varyings.add("vLineDistanceNorm","float"),e.falloffEnabled&&t.fragment.uniforms.add("falloff","float"),e.innerColorEnabled&&(t.fragment.uniforms.add("innerColor","vec4"),t.fragment.uniforms.add("innerWidth","float")),r&&(t.varyings.add("vSegmentSDF","float"),t.varyings.add("vReverseSegmentSDF","float")),t.vertex.code.add(x`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),t.vertex.code.add(x`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= screenSize / posNdc.w;
return posNdc;
}`),t.vertex.code.add(x`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${e.multipassTerrainEnabled?"depth = pos.z;":""}
      linearDepth = (-pos.z - nearFar[0]) / (nearFar[1] - nearFar[0]);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),t.vertex.code.add(x`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;

      float lineSize = getSize();
      float lineWidth = lineSize * pixelRatio;

      ${a?x`vLineWidth = lineWidth;`:""}
      ${l?x`vLineSizeInv = 1.0 / lineSize;`:""}

      // convert sub-pixel coverage to alpha
      if (lineWidth < 1.0) {
        coverage = lineWidth;
        lineWidth = 1.0;
      }else{
        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if
        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly
        // so we only really care to round anything larger than 1.
        lineWidth = floor(lineWidth + 0.5);
      }

      vec4 pos  = view * vec4(position.xyz, 1.0);
      vec4 prev = view * vec4(auxpos1.xyz, 1.0);
      vec4 next = view * vec4(auxpos2.xyz, 1.0);

      clipAndTransform(pos, prev, next, isStartVertex);

      vec2 left = (pos.xy - prev.xy);
      vec2 right = (next.xy - pos.xy);

      float leftLen = length(left);
      float rightLen = length(right);
  `),c&&t.vertex.code.add(x`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${r?x`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),t.vertex.code.add(x`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),e.roundJoins?t.vertex.code.add(x`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${e.stippleEnabled?x`min(1.0, subdivisionFactor * ${x.float((WL+2)/(WL+1))})`:x`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):t.vertex.code.add(x`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`),t.vertex.code.add(x`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${i?x`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),t.vertex.code.add(x`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

    ${n||o?x`float lineDistNorm = sign(uv0.y) * pos.w;`:""}

    ${o?x`vLineDistance = lineWidth * lineDistNorm;`:""}
    ${n?x`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),r&&t.vertex.code.add(x`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),e.stippleEnabled&&(e.draped||t.vertex.code.add(x`vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),t.vertex.code.add(x`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),e.draped?t.vertex.code.add(x`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):t.vertex.code.add(x`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),t.vertex.code.add(x`
      float patternLength = ${e.stippleScaleWithLineWidth?"lineSize * ":""} stipplePatternPixelSize;

      // Compute the coordinates at both start and end of the line segment, because we need both to clamp to in the fragment shader
      vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);

      vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);

      // Adjust the coordinate to the displaced position (the pattern is shortened/overextended on the in/outside of joins)
      if (segmentLengthScreenDouble >= 0.001) {
        // Project the actual vertex position onto the line segment. Note that the resulting factor is within [0..1] at the
        // original vertex positions, and slightly outside of that range at the displaced positions
        vec2 stippleDisplacement = pos.xy - segmentOrigin;
        float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);

        // Apply this offset to the actual vertex coordinate (can be screen or pseudo-screen space)
        vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
      }

      // Cancel out perspective correct interpolation because we want this length the really represent the screen distance
      vStippleDistanceLimits *= pos.w;
      vStippleDistance *= pos.w;

      // Disable stipple distance limits on caps
      vStippleDistanceLimits = isJoin ?
                                 vStippleDistanceLimits :
                                 isStartVertex ?
                                  vec2(-1e038, vStippleDistanceLimits.y) :
                                  vec2(vStippleDistanceLimits.x, 1e038);
    `)),t.vertex.code.add(x`
      // Convert back into NDC
      pos.xy = (pos.xy / screenSize) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${e.wireframe&&!e.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
    }
  }
  `),e.multipassTerrainEnabled&&(t.fragment.include(Os),t.include(Ec,e)),t.include(Or,e),t.fragment.uniforms.add("intrinsicColor","vec4"),t.fragment.include(Vp),t.fragment.code.add(x`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
  `),e.wireframe?t.fragment.code.add(x`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(r&&t.fragment.code.add(x`
      float sdf = min(vSegmentSDF, vReverseSegmentSDF);
      vec2 fragmentPosition = vec2(
        min(sdf, 0.0),
        vLineDistance
      ) * gl_FragCoord.w;

      float fragmentRadius = length(fragmentPosition);
      float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

      if (capCoverage < ${x.float(Hn)}) {
        discard;
      }
    `),s?t.fragment.code.add(x`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${x.float(Hn)}, stippleCoverage);
      `):t.fragment.code.add(x`float stippleAlpha = getStippleAlpha();`),t.fragment.code.add(x`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);
vec4 color = intrinsicColor * vColor;`),e.innerColorEnabled&&t.fragment.code.add(x`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`),t.fragment.code.add(x`vec4 finalColor = blendStipple(color, stippleAlpha);`),e.falloffEnabled&&t.fragment.code.add(x`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`)),t.fragment.code.add(x`
    if (finalColor.a < ${x.float(Hn)}) {
      discard;
    }

    ${e.output===j.Alpha?x`gl_FragColor = vec4(finalColor.a);`:""}
    ${e.output===j.Color?x`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===j.Color&&e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${e.output===j.Highlight?x`gl_FragColor = vec4(1.0);`:""}
    ${e.output===j.Depth?x`outputDepth(linearDepth);`:""}
  }
  `),t}(function(e){e[e.BUTT=0]="BUTT",e[e.SQUARE=1]="SQUARE",e[e.ROUND=2]="ROUND",e[e.COUNT=3]="COUNT"})(qh||(qh={}));const KZe=Object.freeze({__proto__:null,NUM_ROUND_JOIN_SUBDIVISIONS:WL,get CapType(){return qh},build:JZe}),PW={func:Li.LESS},XL={func:Li.ALWAYS},Ip={mask:255},qve={mask:0},eQe=e=>({function:{func:Li.NOTEQUAL,ref:e,mask:e},operation:{fail:Ui.KEEP,zFail:Ui.KEEP,zPass:Ui.KEEP}}),tQe=e=>({function:{func:Li.ALWAYS,ref:e,mask:e},operation:{fail:Ui.KEEP,zFail:Ui.KEEP,zPass:Ui.REPLACE}}),W0={function:{func:Li.ALWAYS,ref:Ea.OutlineVisualElementMask,mask:Ea.OutlineVisualElementMask},operation:{fail:Ui.KEEP,zFail:Ui.KEEP,zPass:Ui.ZERO}},D0={function:{func:Li.ALWAYS,ref:Ea.OutlineVisualElementMask,mask:Ea.OutlineVisualElementMask},operation:{fail:Ui.KEEP,zFail:Ui.KEEP,zPass:Ui.REPLACE}},Wve={function:{func:Li.EQUAL,ref:Ea.OutlineVisualElementMask,mask:Ea.OutlineVisualElementMask},operation:{fail:Ui.KEEP,zFail:Ui.KEEP,zPass:Ui.KEEP}},Xve={function:{func:Li.NOTEQUAL,ref:Ea.OutlineVisualElementMask,mask:Ea.OutlineVisualElementMask},operation:{fail:Ui.KEEP,zFail:Ui.KEEP,zPass:Ui.KEEP}},Yve=new Map([[E.POSITION,0],[E.SUBDIVISIONFACTOR,1],[E.UV0,2],[E.AUXPOS1,3],[E.AUXPOS2,4],[E.SIZE,6],[E.SIZEFEATUREATTRIBUTE,6],[E.COLOR,5],[E.COLORFEATUREATTRIBUTE,5],[E.OPACITYFEATUREATTRIBUTE,7]]);class T4 extends Gi{constructor(t,i,r){super(t,i,r),this.stippleTextureRepository=t.stippleTextureRepository}get stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==j.Highlight}initializeProgram(t){const i=T4.shader.get(),r=this.configuration,s=i.build({oitEnabled:r.transparencyPassType===lt.Color,output:r.output,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:r.draped,stippleEnabled:this.stippleEnabled,stippleOffColorEnabled:r.stippleOffColorEnabled,stippleRequiresClamp:!0,stippleScaleWithLineWidth:r.stippleScaleWithLineWidth,stipplePreferContinuous:r.stipplePreferContinuous,capType:r.capType,roundJoins:r.roundJoins,vvColor:r.vvColor,vvSize:r.vvSize,vvInstancingEnabled:!0,vvOpacity:r.vvOpacity,falloffEnabled:r.falloffEnabled,innerColorEnabled:r.innerColorEnabled,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround,wireframe:r.wireframe});return new Mi(t.rctx,s,Yve)}destroy(){super.destroy(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(t,i){if(Ol(this.program,i.camera.projectionMatrix),this.configuration.output===j.Highlight&&Hp(this.program,i),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),Jm(this.program,i)),this.program.setUniform1f("intrinsicWidth",t.width),this.program.setUniform4fv("intrinsicColor",t.color),this.program.setUniform1f("miterLimit",t.join!=="miter"?0:t.miterLimit),this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniform1f("pixelRatio",i.camera.pixelRatio),this.program.setUniform2f("screenSize",i.camera.fullViewport[2],i.camera.fullViewport[3]),F0e(this.program,t),this.stipplePattern!==t.stipplePattern){const r=t.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,r),this.stipplePattern=r}if(this.stippleEnabled){const{pixelSize:r,sdfNormalizer:s,pixels:n}=_(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};if(this.program.setUniform1f("stipplePatternSDFNormalizer",s),this.program.setUniform1f("stipplePatternTextureSize",n),this.program.setUniform1f("stipplePatternPixelSize",r),this.program.setUniform1f("stipplePatternPixelSizeInv",1/r),this.configuration.draped?this.program.setUniform1f("worldToScreenRatio",1/i.screenToPCSRatio):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/i.camera.perScreenPixelRatio),this.configuration.stippleOffColorEnabled){const o=t.stippleOffColor;this.program.setUniform4f("stippleOffColor",o[0],o[1],o[2],o.length>3?o[3]:1)}}this.configuration.falloffEnabled&&this.program.setUniform1f("falloff",t.falloff),this.configuration.innerColorEnabled&&(this.program.setUniform4fv("innerColor",gt(t.innerColor,t.color)),this.program.setUniform1f("innerWidth",t.innerWidth*i.camera.pixelRatio))}bindDraw(t){Gp(this.program,t),this.stippleEnabled&&!this.configuration.draped&&j0(this.program,t.origin,t.camera.viewInverseTransposeMatrix),I0(this.program,this.configuration,t.slicePlane,{origin:t.origin,view:t.camera.viewMatrix}),this.program.setUniformMatrix4fv("inverseProjectionMatrix",fr(pO.get(),t.camera.projectionMatrix)),this.program.rebindTextures()}_makePipelineState(t,i){const r=this.configuration,s=t===lt.NONE,n=t===lt.FrontFace;return Ot({blending:r.output===j.Color||r.output===j.Alpha?s?gl:Km(t):null,depthTest:{func:H0(t)},depthWrite:s?r.writeDepth&&Ma:a4(t),colorWrite:Ft,stencilWrite:r.sceneHasOcludees?Ip:null,stencilTest:r.sceneHasOcludees?i?D0:W0:null,polygonOffset:s||n?r.polygonOffset&&hie:c4})}initializePipeline(){const t=this.configuration,i=t.polygonOffset&&hie;return t.occluder&&(this._occluderPipelineTransparent=Ot({blending:gl,polygonOffset:i,depthTest:XL,depthWrite:null,colorWrite:Ft,stencilWrite:null,stencilTest:Xve}),this._occluderPipelineOpaque=Ot({blending:gl,polygonOffset:i,depthTest:XL,depthWrite:null,colorWrite:Ft,stencilWrite:qve,stencilTest:Wve}),this._occluderPipelineMaskWrite=Ot({blending:null,polygonOffset:i,depthTest:PW,depthWrite:null,colorWrite:null,stencilWrite:Ip,stencilTest:D0})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?Tt.LINES:Tt.TRIANGLE_STRIP}getPipelineState(t,i){return i?this._occludeePipelineState:this.configuration.occluder?t===ve.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:t===ve.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(t,i)}}T4.shader=new Ni(KZe,()=>import("./RibbonLine.glsl.51bc9fa6.js"));const hie={factor:0,units:-4};class Vr extends mr{constructor(){super(...arguments),this.output=j.Color,this.occluder=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.polygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.capType=qh.BUTT,this.roundJoins=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.sceneHasOcludees=!1,this.transparencyPassType=lt.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1,this.wireframe=!1}}u([Z({count:j.COUNT})],Vr.prototype,"output",void 0),u([Z()],Vr.prototype,"occluder",void 0),u([Z()],Vr.prototype,"slicePlaneEnabled",void 0),u([Z()],Vr.prototype,"transparent",void 0),u([Z()],Vr.prototype,"polygonOffset",void 0),u([Z()],Vr.prototype,"writeDepth",void 0),u([Z()],Vr.prototype,"draped",void 0),u([Z()],Vr.prototype,"stippleEnabled",void 0),u([Z()],Vr.prototype,"stippleOffColorEnabled",void 0),u([Z()],Vr.prototype,"stippleScaleWithLineWidth",void 0),u([Z()],Vr.prototype,"stipplePreferContinuous",void 0),u([Z({count:qh.COUNT})],Vr.prototype,"capType",void 0),u([Z()],Vr.prototype,"roundJoins",void 0),u([Z()],Vr.prototype,"vvSize",void 0),u([Z()],Vr.prototype,"vvColor",void 0),u([Z()],Vr.prototype,"vvOpacity",void 0),u([Z()],Vr.prototype,"falloffEnabled",void 0),u([Z()],Vr.prototype,"innerColorEnabled",void 0),u([Z()],Vr.prototype,"sceneHasOcludees",void 0),u([Z({count:lt.COUNT})],Vr.prototype,"transparencyPassType",void 0),u([Z()],Vr.prototype,"multipassTerrainEnabled",void 0),u([Z()],Vr.prototype,"cullAboveGround",void 0),u([Z()],Vr.prototype,"wireframe",void 0);const iQe=he.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");var Xa;(function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(Xa||(Xa={}));class Bx extends od{constructor(t){super(t,sQe),this._vertexAttributeLocations=Yve,this.techniqueConfig=new Vr,this.layout=this.createLayout()}isClosed(t,i){return Zve(this.parameters,t,i)}dispose(){}getPassParameters(){return this.parameters}getTechniqueConfig(t,i){this.techniqueConfig.output=t,this.techniqueConfig.draped=i.slot===ve.DRAPED_MATERIAL;const r=_(this.parameters.stipplePattern);return this.techniqueConfig.stippleEnabled=r,this.techniqueConfig.stippleOffColorEnabled=r&&_(this.parameters.stippleOffColor),this.techniqueConfig.stippleScaleWithLineWidth=r&&this.parameters.stippleScaleWithLineWidth,this.techniqueConfig.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.roundJoins=this.parameters.join==="round",this.techniqueConfig.capType=this.parameters.cap,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.innerColorEnabled=this.parameters.innerWidth>0&&_(this.parameters.innerColor),this.techniqueConfig.falloffEnabled=this.parameters.falloff>0,this.techniqueConfig.occluder=this.parameters.renderOccluded===Cr.OccludeAndTransparentStencil,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig.wireframe=this.parameters.wireframe,this.techniqueConfig}intersect(t,i,r,s,n,o,a,l,c){_(c)?this._intersectDrapedLineGeometry(t,s,c,o,a):this._intersectLineGeometry(t,i,r,s,a)}_intersectDrapedLineGeometry(t,i,r,s,n){if(!i.options.selectionMode)return;const o=t.vertexAttributes.get(E.POSITION).data,a=t.vertexAttributes.get(E.SIZE);let l=this.parameters.width;if(this.parameters.vvSizeEnabled){const y=t.vertexAttributes.get(E.SIZEFEATUREATTRIBUTE).data[0];l*=Be(this.parameters.vvSizeOffset[0]+y*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else a&&(l*=a.data[0]);const c=s[0],h=s[1],p=(l/2+4)*t.screenToWorldRatio;let f=Number.MAX_VALUE,g=0;for(let y=0;y<o.length-5;y+=3){const v=o[y],b=o[y+1],w=c-v,S=h-b,T=o[y+3]-v,A=o[y+4]-b,C=Be((T*w+A*S)/(T*T+A*A),0,1),O=T*C-w,L=A*C-S,U=O*O+L*L;U<f&&(f=U,g=y/3)}f<p*p&&n(r.dist,r.normal,g,!1)}_intersectLineGeometry(t,i,r,s,n){if(!s.options.selectionMode||IO(i))return;if(!Yge(r))return void iQe.error("intersection assumes a translation-only matrix");const o=t.vertexAttributes,a=o.get(E.POSITION).data;let l=this.parameters.width;if(this.parameters.vvSizeEnabled){const w=o.get(E.SIZEFEATUREATTRIBUTE).data[0];l*=Be(this.parameters.vvSizeOffset[0]+w*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else o.has(E.SIZE)&&(l*=o.get(E.SIZE).data[0]);const c=s.camera,h=oQe;zs(h,s.point);const p=l*c.pixelRatio/2+4*c.pixelRatio;oe(q2[0],h[0]-p,h[1]+p,0),oe(q2[1],h[0]+p,h[1]+p,0),oe(q2[2],h[0]+p,h[1]-p,0),oe(q2[3],h[0]-p,h[1]-p,0);for(let w=0;w<4;w++)if(!c.unprojectFromRenderScreen(q2[w],sf[w]))return;co(c.eye,sf[0],sf[1],Lk),co(c.eye,sf[1],sf[2],Nk),co(c.eye,sf[2],sf[3],Fk),co(c.eye,sf[3],sf[0],Uk);let f=Number.MAX_VALUE,g=0;const y=iG(this.parameters,o,t.indices)?a.length-2:a.length-5;for(let w=0;w<y;w+=3){Qo[0]=a[w]+r[12],Qo[1]=a[w+1]+r[13],Qo[2]=a[w+2]+r[14];const S=(w+3)%a.length;if(Jo[0]=a[S]+r[12],Jo[1]=a[S+1]+r[13],Jo[2]=a[S+2]+r[14],tr(Lk,Qo)<0&&tr(Lk,Jo)<0||tr(Nk,Qo)<0&&tr(Nk,Jo)<0||tr(Fk,Qo)<0&&tr(Fk,Jo)<0||tr(Uk,Qo)<0&&tr(Uk,Jo)<0)continue;if(c.projectToRenderScreen(Qo,dv),c.projectToRenderScreen(Jo,pv),dv[2]<0&&pv[2]>0){de(gd,Qo,Jo);const A=c.frustum,C=-tr(A[Wi.NEAR],Qo)/_e(gd,A[Wi.NEAR]);ae(gd,gd,C),pe(Qo,Qo,gd),c.projectToRenderScreen(Qo,dv)}else if(dv[2]>0&&pv[2]<0){de(gd,Jo,Qo);const A=c.frustum,C=-tr(A[Wi.NEAR],Jo)/_e(gd,A[Wi.NEAR]);ae(gd,gd,C),pe(Jo,Jo,gd),c.projectToRenderScreen(Jo,pv)}else if(dv[2]<0&&pv[2]<0)continue;dv[2]=0,pv[2]=0;const T=zj(u1(dv,pv,fie),h);T<f&&(f=T,ne(die,Qo),ne(pie,Jo),g=w/3)}const v=s.rayBegin,b=s.rayEnd;if(f<p*p){let w=Number.MAX_VALUE;if(Iue(u1(die,pie,fie),u1(v,b,aQe),hv)){de(hv,hv,v);const S=Pe(hv);ae(hv,hv,1/S),w=S/xi(v,b)}n(w,hv,g,!1)}}computeAttachmentOrigin(t,i){const r=t.vertexAttributes;if(!r)return null;const s=t.indices,n=r.get(E.POSITION);return Iq(n,s?s.get(E.POSITION):null,s&&iG(this.parameters,r,s),i)}createLayout(){const t=kr().vec3f(E.POSITION).f32(E.SUBDIVISIONFACTOR).vec2f(E.UV0).vec3f(E.AUXPOS1).vec3f(E.AUXPOS2);return this.parameters.vvSizeEnabled?t.f32(E.SIZEFEATUREATTRIBUTE):t.f32(E.SIZE),this.parameters.vvColorEnabled?t.f32(E.COLORFEATUREATTRIBUTE):t.vec4f(E.COLOR),this.parameters.vvOpacityEnabled&&t.f32(E.OPACITYFEATUREATTRIBUTE),t}createBufferWriter(){return new nQe(this.layout,this.parameters)}requiresSlot(t,i){if(t===ve.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===Cr.OccludeAndTransparentStencil)return t===ve.OPAQUE_MATERIAL||t===ve.OCCLUDER_MATERIAL||t===ve.TRANSPARENT_OCCLUDER_MATERIAL;const r=Q1(i);return r===j.Color||r===j.Alpha?t===(this.parameters.writeDepth?ve.TRANSPARENT_MATERIAL:ve.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):t===ve.OPAQUE_MATERIAL}createGLMaterial(t){return t.output===j.Color||t.output===j.Alpha||t.output===j.Highlight||t.output===j.Depth?new rQe(t):null}validateParameters(t){t.join!=="miter"&&(t.miterLimit=0),this._requiresTransparent(t)&&(t.transparent=!0)}_requiresTransparent(t){return!!((t.color&&t.color[3])<1||t.innerWidth>0&&this._colorRequiresTransparent(t.innerColor)||t.stipplePattern&&this._colorRequiresTransparent(t.stippleOffColor)||t.falloff>0)}_colorRequiresTransparent(t){return _(t)&&t[3]<1&&t[3]>0}}class rQe extends Zm{updateParameters(t){return this.ensureTechnique(T4,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}beginSlot(t){return this._output!==j.Color&&this._output!==j.Alpha||this._updateOccludeeState(t),this.updateParameters(t)}bind(t,i){i.bindPass(this._material.getPassParameters(),t)}}const sQe=I(I({width:0,color:[1,1,1,1],join:"miter",cap:qh.BUTT,miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleOffColor:null,stippleScaleWithLineWidth:!1,stipplePreferContinuous:!0,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1,wireframe:!1},ju),MW);class nQe{constructor(t,i){this.parameters=i,this.numJoinSubdivisions=0,this.vertexBufferLayout=t;const r=i.stipplePattern?1:0;switch(this.parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=r;break;case"round":this.numJoinSubdivisions=WL+r}}_isClosed(t){return iG(this.parameters,t.vertexAttributes,t.indices)}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){const r=t.indices.get(E.POSITION).length/2+1,s=this._isClosed(t);let n=s?2:2*2;return n+=((s?r:r-1)-(s?0:1))*(2*this.numJoinSubdivisions+4),n+=2,this.parameters.wireframe&&(n=2+4*(n-2)),n}write(t,i,r,s){var n;const o=lQe,a=cQe,l=uQe,c=i.vertexAttributes.get(E.POSITION).data,h=i.indices&&i.indices.get(E.POSITION),p=(n=i.vertexAttributes.get(E.DISTANCETOSTART))==null?void 0:n.data;h&&h.length!==2*(c.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let f=1,g=0;this.parameters.vvSizeEnabled?g=i.vertexAttributes.get(E.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(E.SIZE)&&(f=i.vertexAttributes.get(E.SIZE).data[0]);let y=[1,1,1,1],v=0;this.parameters.vvColorEnabled?v=i.vertexAttributes.get(E.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(E.COLOR)&&(y=i.vertexAttributes.get(E.COLOR).data);let b=0;this.parameters.vvOpacityEnabled&&(b=i.vertexAttributes.get(E.OPACITYFEATUREATTRIBUTE).data[0]);const w=c.length/3,S=t.transformation,T=new Float32Array(r.buffer),A=this.vertexBufferLayout.stride/4;let C=s*A;const O=C;let L=0;const U=p?(J,Q,te)=>L=p[te]:(J,Q,te)=>L+=xi(J,Q),N=(J,Q,te,ie,$,F,k)=>{if(T[C++]=Q[0],T[C++]=Q[1],T[C++]=Q[2],T[C++]=ie,T[C++]=k,T[C++]=$,T[C++]=J[0],T[C++]=J[1],T[C++]=J[2],T[C++]=te[0],T[C++]=te[1],T[C++]=te[2],this.parameters.vvSizeEnabled?T[C++]=g:T[C++]=f,this.parameters.vvColorEnabled)T[C++]=v;else{const G=Math.min(4*F,y.length-4);T[C++]=y[G+0],T[C++]=y[G+1],T[C++]=y[G+2],T[C++]=y[G+3]}this.parameters.vvOpacityEnabled&&(T[C++]=b)};C+=A,oe(a,c[0],c[1],c[2]),S&&ke(a,a,S);const z=this._isClosed(i);if(z){const J=c.length-3;oe(o,c[J],c[J+1],c[J+2]),S&&ke(o,o,S)}else oe(l,c[3],c[4],c[5]),S&&ke(l,l,S),N(a,a,l,1,Xa.LEFT_CAP_START,0,0),N(a,a,l,1,Xa.RIGHT_CAP_START,0,0),ne(o,a),ne(a,l);const V=z?0:1,B=z?w:w-1;for(let J=V;J<B;J++){const Q=(J+1)%w*3;oe(l,c[Q+0],c[Q+1],c[Q+2]),S&&ke(l,l,S),U(o,a,J),N(o,a,l,0,Xa.LEFT_JOIN_END,J,L),N(o,a,l,0,Xa.RIGHT_JOIN_END,J,L);const te=this.numJoinSubdivisions;for(let ie=0;ie<te;++ie){const $=(ie+1)/(te+1);N(o,a,l,$,Xa.LEFT_JOIN_END,J,L),N(o,a,l,$,Xa.RIGHT_JOIN_END,J,L)}N(o,a,l,1,Xa.LEFT_JOIN_START,J,L),N(o,a,l,1,Xa.RIGHT_JOIN_START,J,L),ne(o,a),ne(a,l)}z?(oe(l,c[3],c[4],c[5]),S&&ke(l,l,S),L=U(o,a,B),N(o,a,l,0,Xa.LEFT_JOIN_END,V,L),N(o,a,l,0,Xa.RIGHT_JOIN_END,V,L)):(L=U(o,a,B),N(o,a,a,0,Xa.LEFT_CAP_END,B,L),N(o,a,a,0,Xa.RIGHT_CAP_END,B,L)),Dk(T,O+A,T,O,A),C=Dk(T,C-A,T,C,A),this.parameters.wireframe&&this._addWireframeVertices(r,O,C,A)}_addWireframeVertices(t,i,r,s){const n=new Float32Array(t.buffer,r*Float32Array.BYTES_PER_ELEMENT),o=new Float32Array(t.buffer,i*Float32Array.BYTES_PER_ELEMENT,r-i);let a=0;const l=c=>a=Dk(o,c,n,a,s);for(let c=0;c<o.length-1;c+=2*s)l(c),l(c+2*s),l(c+1*s),l(c+2*s),l(c+1*s),l(c+3*s)}}function Dk(e,t,i,r,s){for(let n=0;n<s;n++)i[r++]=e[t++];return r}function iG(e,t,i){return Zve(e,t.get(E.POSITION).data,i?i.get(E.POSITION):null)}function Zve(e,t,i){return!!e.isClosed&&(i?i.length>2:t.length>6)}const Qo=M(),Jo=M(),gd=M(),hv=M(),oQe=M(),dv=zn(),pv=zn(),die=M(),pie=M(),fie=z0(),aQe=z0(),lQe=M(),cQe=M(),uQe=M(),q2=[zn(),zn(),zn(),zn()],sf=[M(),M(),M(),M()],Lk=ii(),Nk=ii(),Fk=ii(),Uk=ii();class IW{constructor(t,i=125e4){this._originSR=t,this._gridSize=i,this._origins=new Map,this._objects=new Map,this._rootOriginId="root/"+Ta()}getOrigin(t){const i=this._origins.get(this._rootOriginId);if(i==null){if(_(k3))return this._origins.set(this._rootOriginId,vC(k3[0],k3[1],k3[2],this._rootOriginId)),this.getOrigin(t);const h=vC(t[0]+Math.random()-.5,t[1]+Math.random()-.5,t[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,h),h}const r=this._gridSize,s=Math.round(t[0]/r),n=Math.round(t[1]/r),o=Math.round(t[2]/r),a=`${s}/${n}/${o}`;let l=this._origins.get(a);const c=.5*r;if(de(sn,t,i.vec3),sn[0]=Math.abs(sn[0]),sn[1]=Math.abs(sn[1]),sn[2]=Math.abs(sn[2]),sn[0]<c&&sn[1]<c&&sn[2]<c){if(l){const h=Math.max(...sn);if(de(sn,t,l.vec3),sn[0]=Math.abs(sn[0]),sn[1]=Math.abs(sn[1]),sn[2]=Math.abs(sn[2]),Math.max(...sn)<h)return l}return i}return l||(l=vC(s*r,n*r,o*r,a),this._origins.set(a,l)),l}_drawOriginBox(t,i=[1,1,0,1]){const r=window.view,s=r._stage,n=i.toString();if(!this._objects.has(n)){this._material=new Bx({width:2,color:i}),s.add(this._material);const g=new Gve({isPickable:!1}),y=new tg({castShadow:!1});s.add(y),g.add(y),s.add(g),this._objects.set(n,y)}const o=this._objects.get(n),a=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],l=a.length,c=new Array(3*l),h=new Uint16Array(2*(l-1)),p=.5*this._gridSize;for(let g=0;g<l;g++)c[3*g+0]=t[0]+(1&a[g]?p:-p),c[3*g+1]=t[1]+(2&a[g]?p:-p),c[3*g+2]=t[2]+(4&a[g]?p:-p),g>0&&(h[2*g+0]=g-1,h[2*g+1]=g);br(c,this._originSR,0,c,r.renderSpatialReference,0,l);const f=new lr([[E.POSITION,{size:3,data:c,exclusive:!0}]],[[E.POSITION,h]],Aa.Line);s.add(f),o.addGeometry(f,this._material,ls)}}let k3=null;const sn=M();class Qve{constructor(t){this.rctx=t,this.camera=null,this.lastFrameCamera=new wi,this.pass=Le.MATERIAL,this.slot=ve.OPAQUE_MATERIAL,this.highlightDepthTexture=null,this.renderOccludedMask=mie,this.hasOccludees=!1,this.hasFillLights=!0}resetRenderOccludedMask(){this.renderOccludedMask=mie}get isHighlightPass(){return this.pass===Le.MATERIAL_HIGHLIGHT}}class hQe extends Qve{constructor(t,i,r,s,n,o){super(t),this.offscreenRenderingHelper=i,this.scenelightingData=r,this.shadowMap=s,this.ssaoHelper=n,this.sliceHelper=o}}const mie=Cr.Occlude|Cr.OccludeAndTransparent|Cr.OccludeAndTransparentStencil;function dQe(){const e=new Oi;return e.include(G0),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("uColor","vec4"),e.fragment.code.add(x`void main() {
vec4 texColor = texture2D(tex, uv);
gl_FragColor = texColor * uColor;
}`),e}const pQe=Object.freeze({__proto__:null,build:dQe});class qO extends Gi{initializeProgram(t){const i=qO.shader.get().build();return new Mi(t.rctx,i,mi)}initializePipeline(){return this.configuration.hasAlpha?Ot({blending:Xn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Ft}):Ot({colorWrite:Ft})}}qO.shader=new Ni(pQe,()=>import("./TextureOnly.glsl.1a0a2bdc.js"));class $W extends mr{constructor(){super(...arguments),this.hasAlpha=!1}}u([Z()],$W.prototype,"hasAlpha",void 0);function fQe(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t[r];return i}function kk(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t;return i}function lT(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]+t[r];return i}function Jve(e){return(e+1)*(e+1)}function mQe(e){return Be(Math.floor(Math.sqrt(e)-1),0,2)}function Kve(e,t,i){const r=e[0],s=e[1],n=e[2],o=i||[];return o.length=Jve(t),t>=0&&(o[0]=.28209479177),t>=1&&(o[1]=.4886025119*r,o[2]=.4886025119*n,o[3]=.4886025119*s),t>=2&&(o[4]=1.09254843059*r*s,o[5]=1.09254843059*s*n,o[6]=.31539156525*(3*n*n-1),o[7]=1.09254843059*r*n,o[8]=.54627421529*(r*r-s*s)),o}function gQe(e,t){const i=Jve(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=i;for(let s=0;s<i;s++)r.r[s]=r.g[s]=r.b[s]=0;return r}function yQe(e,t){const i=mQe(t.r.length);for(const r of e)mo(rG,r.direction),Kve(rG,i,sm),fQe(sm,x$),kk(sm,r.intensity[0],Gb),lT(t.r,Gb),kk(sm,r.intensity[1],Gb),lT(t.g,Gb),kk(sm,r.intensity[2],Gb),lT(t.b,Gb);return t}function vQe(e,t){Kve(rG,0,sm);for(const i of e)t.r[0]+=sm[0]*x$[0]*i.intensity[0]*4*Math.PI,t.g[0]+=sm[0]*x$[0]*i.intensity[1]*4*Math.PI,t.b[0]+=sm[0]*x$[0]*i.intensity[2]*4*Math.PI;return t}function _Qe(e,t,i,r){gQe(t,r),oe(i.intensity,0,0,0);let s=!1;const n=bQe,o=wQe,a=xQe;n.length=0,o.length=0,a.length=0;for(const l of e)l instanceof D9&&!s?(ne(i.direction,l.direction),ne(i.intensity,l.intensity),i.specularStrength=l.specularStrength,i.environmentStrength=l.environmentStrength,i.castShadows=l.castShadows,s=!0):l instanceof D9||l instanceof rye?n.push(l):l instanceof Dq?o.push(l):l instanceof sye&&a.push(l);yQe(n,r),vQe(o,r);for(const l of a)lT(r.r,l.r),lT(r.g,l.g),lT(r.b,l.b)}const bQe=[],wQe=[],xQe=[],sm=[0],Gb=[0],rG=M(),x$=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class e_e{constructor(){this._shOrder=2,this._ambientBoost=.4,this._oldSunlight={direction:M(),ambient:{color:M(),intensity:1},diffuse:{color:M(),intensity:1}},this.globalFactor=.5,this.groundLightingFactor=.5,this._sphericalHarmonics=new sye,this._mainLight={intensity:M(),direction:je(1,0,0),castShadows:!1,specularStrength:1,environmentStrength:1}}get lightingMainDirection(){return this._mainLight.direction}setLightDirectionUniform(t){t.setUniform3fv("lightingMainDirection",this._mainLight.direction)}setUniforms(t,i,r){const s=i?(1-this.groundLightingFactor)*(1-this.globalFactor):0;t.setUniform1f("lightingFixedFactor",s),t.setUniform1f("lightingGlobalFactor",this.globalFactor),this.setLightDirectionUniform(t),t.setUniform3fv("lightingMainIntensity",this._mainLight.intensity),t.setUniform1f("lightingSpecularStrength",this._mainLight.specularStrength),t.setUniform1f("lightingEnvironmentStrength",this._mainLight.environmentStrength),t.setUniform1f("ambientBoostFactor",this._ambientBoost),t.setUniform1b("hasFillLights",r);const n=this._sphericalHarmonics;this._shOrder===0?t.setUniform3f("lightingAmbientSH0",n.r[0],n.g[0],n.b[0]):this._shOrder===1?(t.setUniform4f("lightingAmbientSH_R",n.r[0],n.r[1],n.r[2],n.r[3]),t.setUniform4f("lightingAmbientSH_G",n.g[0],n.g[1],n.g[2],n.g[3]),t.setUniform4f("lightingAmbientSH_B",n.b[0],n.b[1],n.b[2],n.b[3])):this._shOrder===2&&(t.setUniform3f("lightingAmbientSH0",n.r[0],n.g[0],n.b[0]),t.setUniform4f("lightingAmbientSH_R1",n.r[1],n.r[2],n.r[3],n.r[4]),t.setUniform4f("lightingAmbientSH_G1",n.g[1],n.g[2],n.g[3],n.g[4]),t.setUniform4f("lightingAmbientSH_B1",n.b[1],n.b[2],n.b[3],n.b[4]),t.setUniform4f("lightingAmbientSH_R2",n.r[5],n.r[6],n.r[7],n.r[8]),t.setUniform4f("lightingAmbientSH_G2",n.g[5],n.g[6],n.g[7],n.g[8]),t.setUniform4f("lightingAmbientSH_B2",n.b[5],n.b[6],n.b[7],n.b[8]))}set(t){_Qe(t,this._shOrder,this._mainLight,this._sphericalHarmonics),ne(this._oldSunlight.direction,this._mainLight.direction);const i=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*i,this._oldSunlight.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*i,this._oldSunlight.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*i,ae(this._oldSunlight.diffuse.color,this._mainLight.intensity,i),ne(z3,this._oldSunlight.diffuse.color),ae(z3,z3,this._ambientBoost*this.globalFactor),pe(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,z3)}get old(){return this._oldSunlight}}const z3=M();class t_e{constructor(t){this._rctx=t,this.cache=new Map}dispose(){this.cache.forEach(t=>t.texture=tt(t.texture)),this.cache.clear()}_acquire(t){if(R(t))return null;const i=this._patternId(t),r=this.cache.get(i);if(r)return r.refCount++,r.bind;const s=t.pixelRatio,{encodedData:n,sdfNormalizer:o,pixels:a,paddedPixels:l}=TQe(t.pattern,s),c=a/s,h={refCount:1,texture:null,bind:p=>(R(h.texture)&&(h.texture=new Qe(this._rctx,{width:l,height:1,internalFormat:$e.RGBA,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE},n)),p.bindTexture(h.texture,"stipplePatternTexture"),{pixelSize:c,sdfNormalizer:o,pixels:a})};return this.cache.set(i,h),h.bind}release(t){if(R(t))return;const i=this._patternId(t),r=this.cache.get(i);r&&(r.refCount--,r.refCount===0&&(_(r.texture)&&r.texture.dispose(),this.cache.delete(i)))}swap(t,i){const r=this._acquire(i);return this.release(t),r}_patternId(t){return`${t.pattern.join(",")}-r${t.pixelRatio}`}}function TQe(e,t){const i=e.map(y=>Math.round(y*t)),r=1/t,s=Math.floor(i.reduce((y,v)=>y+v)),n=i.reduce((y,v)=>Math.max(y,v)),o=(Math.floor(.5*(n-1))+.5)*r,a=[];let l=1;for(const y of i){for(let v=0;v<y;v++){const b=l*(Math.min(v,y-1-v)+.5)*r/o*.5+.5;a.push(b)}l=-l}const c=Math.round(i[0]/2),h=[...a.slice(c),...a.slice(0,c)],p=s+2,f=new Uint8Array(4*p);let g=4;for(const y of h)zL(y,f,g),g+=4;return f.copyWithin(0,g-4,g),f.copyWithin(g,4,8),{encodedData:f,sdfNormalizer:o,paddedPixels:p,pixels:s}}var xa;function SQe(e){const t=new Oi;return t.include(G0),t.fragment.uniforms.add("tex","sampler2D"),e.function===xa.Standard&&(e.hasOpacityFactor?(t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(x`void main() {
gl_FragColor = texture2D(tex, uv) * opacity;
}`)):t.fragment.code.add(x`void main() {
gl_FragColor = texture2D(tex, uv);
}`)),e.function===xa.OverlayWithTransparency&&(t.fragment.uniforms.add("overlayIdx","int"),e.hasOpacityFactor&&t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(x`
      void main() {
        vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
        gl_FragColor = texture2D(tex, overlayUV) ${e.hasOpacityFactor?"* opacity":""};
      }`)),e.function===xa.TransparentToHUDVisibility&&t.fragment.code.add(x`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`),e.function===xa.Transparency&&(t.fragment.uniforms.add("colorTexture","sampler2D"),t.fragment.uniforms.add("alphaTexture","sampler2D"),t.fragment.uniforms.add("frontFaceTexture","sampler2D"),t.fragment.code.add(x`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`)),t}(function(e){e[e.Standard=0]="Standard",e[e.TransparentToHUDVisibility=1]="TransparentToHUDVisibility",e[e.Transparency=2]="Transparency",e[e.OverlayWithTransparency=3]="OverlayWithTransparency",e[e.COUNT=4]="COUNT"})(xa||(xa={}));const EQe=Object.freeze({__proto__:null,get CompositingFunction(){return xa},build:SQe});var kn;(function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.COUNT=3]="COUNT"})(kn||(kn={}));class LR extends Gi{initializeProgram(t){const i=LR.shader.get().build(this.configuration);return new Mi(t.rctx,i,mi)}initializePipeline(){if(this.configuration.function===xa.TransparentToHUDVisibility)return Ot({colorWrite:{r:!1,g:!0,b:!1,a:!1}});switch(this.configuration.alphaMode){case kn.None:return Ot({colorWrite:Ft});case kn.Alpha:return Ot({blending:Xn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Ft});default:return Ot({blending:Sc(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Ft})}}}LR.shader=new Ni(EQe,()=>import("./Compositing.glsl.2bd2b557.js"));class T$ extends mr{constructor(){super(...arguments),this.function=xa.Standard,this.alphaMode=kn.None,this.hasOpacityFactor=!1}}u([Z({count:xa.COUNT})],T$.prototype,"function",void 0),u([Z({count:kn.COUNT})],T$.prototype,"alphaMode",void 0),u([Z()],T$.prototype,"hasOpacityFactor",void 0);const gie=he.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");let bh=class extends g4(we){constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new e_e,this._handles=new Ut,this._frameTask=rS,this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new $t,this._geometries=new Map,this.worldToPCSRatio=1,this.events=new xr,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView;this._rctx=e.renderingContext,this._renderContext=new Qve(this._rctx);const t=e.waterTextureRepository;this._stippleTextureRepository=new t_e(e.renderingContext),this._shaderTechniqueRepository=new Cve({rctx:this._rctx,viewingMode:Ie.Local,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:t}),this._handles.add([Wt(t,"loadingState",()=>this.events.emit("content-changed")),Wt(this,"spatialReference",i=>this._localOrigins=new IW(i))]),this._materialRepository=new kve(e.textureRepository,this._shaderTechniqueRepository,i=>{(i.renderOccluded&YL)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating")},()=>this.events.emit("content-changed")),this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new Dq(je(1,1,1))]),this._bindParameters={slot:ve.DRAPED_MATERIAL,highlightDepthTexture:Tge(this._rctx),camera:K_,inverseViewport:Ye(),origin:null,screenToWorldRatio:null,screenToPCSRatio:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:ls,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:lt.NONE,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:!0},this._frameTask=this.view.resourceController.scheduler.registerTask(ht.STAGE,this),this._handles.add(this._frameTask)}dispose(){this._handles.destroy(),this._layerRenderers.forEach(e=>e.destroy()),this._layerRenderers.clear(),this._debugTextureTechnique=Xi(this._debugTextureTechnique),this._debugPatternTexture=tt(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=tt(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=tt(this._shaderTechniqueRepository),this._temporaryFBO=tt(this._temporaryFBO),this._quadVAO=tt(this._quadVAO),this.disposeOverlays()}get updating(){return this._sortedLayerRenderersDirty||this._frameTask.updating||qr(this._layerRenderers,e=>e.updating)}get hasOverlays(){return _(this._overlays)&&_(this._overlayRenderTarget)}get gpuMemoryUsage(){return _(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}collectUnusedRenderTargetMemory(e){let t=!1;if(_(this._overlayRenderTarget))for(const i of this._overlayRenderTarget.renderTargets){const r=this.overlays[0].validTargets[i.type]||!this.overlays[1].validTargets[i.type];t=this._overlayRenderTarget.validateUsageForTarget(r,i,e)||t}return t}get overlays(){return gt(this._overlays,[])}ensureDrapeTargets(e){_(this._overlays)&&this._overlays.forEach(t=>{t.hasTargetWithoutRasterImage=Woe(e,i=>i.drapeTargetType===J9.WithoutRasterImage)})}ensureDrapeSources(e){_(this._overlays)&&this._overlays.forEach(t=>{t.hasDrapedFeatureSource=qr(e,(i,r)=>r.drapeSourceType===yC.Features),t.hasDrapedRasterSource=qr(e,(i,r)=>r.drapeSourceType===yC.RasterImage)})}ensureOverlays(e,t){R(this._overlays)&&(this._overlayRenderTarget=new HYe(this._rctx),this._overlays=[new Qte(is.INNER,this._overlayRenderTarget),new Qte(is.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}disposeOverlays(){this._overlays=null,this._overlayRenderTarget=tt(this._overlayRenderTarget),this.events.emit("textures-disposed")}get running(){return this.updating}runTask(e,t=()=>!0){this._frameTask.processQueue(e),e.done||this._processLayers(e,t)}_processLayers(e,t){let i=!1;for(const[r,s]of this._layerRenderers){if(e.done)break;(r.destroyed||t(r))&&(s.commitChanges()&&(i=!0,e.madeProgress()),s.isEmpty&&(i=!0,this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(r),this._handles.remove(r),s.destroy()))}this._updateSortedLayerRenderers(),i&&(_(this._overlays)&&this._layerRenderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())}processSyncLayers(){this._processLayers(e2,e=>e.updatePolicy===aS.SYNC)}addGeometries(e,t,i,r=!1){for(const s of e)R(s.origin)&&(s.origin=this._localOrigins.getOrigin(s.boundingSphere)),this._geometries.set(s.id,s);this._ensureLayerRenderer(t,r).add(e),i===Gt.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(e,t)}removeGeometries(e,t,i){for(const s of e)this._geometries.delete(s.id);const r=this._layerRenderers.get(t);r&&(r.remove(e),i===Gt.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(e,t))}updateGeometries(e,t,i){const r=this._layerRenderers.get(t);if(r)switch(r.modify(e,i),i){case Gt.State.TRANSFORMATION:case Gt.State.VERTEXATTRS:return this._notifyGraphicGeometryChanged(e,t);case Gt.State.VISIBILITIES:return this._notifyGraphicVisibilityChanged(e,t)}else gie.warn("Attempted to update geometry for nonexistent layer")}_notifyGraphicGeometryChanged(e,t){if(R(t.notifyGraphicGeometryChanged))return;let i;for(const r of e){const s=r.graphicUid;_(s)&&s!==i&&(t.notifyGraphicGeometryChanged(s),i=s)}}_notifyGraphicVisibilityChanged(e,t){if(R(t.notifyGraphicVisibilityChanged))return;let i;for(const r of e){const s=r.graphicUid;_(s)&&s!==i&&(t.notifyGraphicVisibilityChanged(s),i=s)}}updateHighlights(e,t){const i=this._layerRenderers.get(t);i?i.modify(e,Gt.State.HIGHLIGHTS):gie.warn("Attempted to update highlights for nonexistent layer")}isEmpty(){return this._geometries.size===0&&!hi.OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateAnimation(e){let t=!1;return this._layerRenderers.forEach(i=>t=i.updateAnimation(e)||t),t}updateLayerOrder(){this._sortedLayerRenderersDirty=!0}drawTarget(e,t,i){const r=e.canvasGeometries;if(r.numViews===0)return!1;this._screenToWorldRatio=i*e.mapUnitsPerPixel;const s=t.renderPass;if(this.isEmpty()||s===Le.MATERIAL_HIGHLIGHT&&!this.hasHighlights||s===Le.MATERIAL_NORMAL&&!this.hasWater||!e.hasSomeSizedView())return!1;const n=t.fbo;if(!n.isValid())return!1;const o=2*e.resolution,a=e.resolution;n.resize(o,a);const l=this._rctx;K_.pixelRatio=e.pixelRatio*i,this._renderContext.pass=s,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=s===Le.MATERIAL_NORMAL?ve.DRAPED_WATER:ve.DRAPED_MATERIAL,e.applyViewport(this._rctx),n.bind(l),e.index===is.INNER&&(l.setClearColor(0,0,0,0),l.clearSafe(bi.COLOR_BUFFER_BIT));const c=t.type===dn.ColorNoRasterImage?Ey.ExcludeRasterImage:t.type===dn.Occluded?Ey.OccludedOnly:Ey.Normal;if(c===Ey.OccludedOnly&&(this._renderContext.renderOccludedMask=YL),hi.OVERLAY_DRAW_DEBUG_TEXTURE&&c!==Ey.OccludedOnly)for(let h=0;h<r.numViews;h++)this._setViewParameters(r.extents[h],e,K_),this._drawDebugTexture(e.resolution,CQe[e.index]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll(({overlayLayer:h,renderer:p})=>{if(c===Ey.ExcludeRasterImage&&h.drapeSourceType===yC.RasterImage)return;const{fullOpacity:f}=h,g=_(f)&&f<1&&s===Le.MATERIAL;g&&(this.bindTemporaryFramebuffer(this._rctx,o,a),l.clearSafe(bi.COLOR_BUFFER_BIT));for(let y=0;y<r.numViews;y++)this._setViewParameters(r.extents[y],e,K_),p.render(this._renderContext,this._bindParameters);g&&_(this._temporaryFBO)&&(n.bind(l),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),kn.PremultipliedAlpha,f,xa.OverlayWithTransparency,e.index))}),l.bindFramebuffer(null),n.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,i){R(this._temporaryFBO)&&(this._temporaryFBO=new Ave(e,!1)),this._temporaryFBO.resize(t,i),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}intersect(e,t,i,r){let s=0;this._geometries.forEach(n=>{if(r&&!r(n))return;this._intersectRenderGeometry(n,i,t,0,e,s);const o=this.longitudeCyclical;o&&(n.boundingSphere[0]-n.boundingSphere[3]<o.min&&this._intersectRenderGeometry(n,i,t,o.range,e,s),n.boundingSphere[0]+n.boundingSphere[3]>o.max&&this._intersectRenderGeometry(n,i,t,-o.range,e,s)),s++})}_intersectRenderGeometry(e,t,i,r,s,n){if(!e.instanceParameters.visible)return;let o=0;_(e.transformation)&&(r+=e.transformation[12],o=e.transformation[13]),B3[0]=i[0]-r,B3[1]=i[1]-o,B3[2]=1,V3[0]=i[0]-r,V3[1]=i[1]-o,V3[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),s,B3,V3,(a,l,c)=>{RQe(t,c,e.material.renderPriority,n,s,e.layerUid,e.graphicUid)},e.calculateShaderTransformation,t)}_ensureLayerRenderer(e,t){let i=this._layerRenderers.get(e);return i&&t===i instanceof HL||(i=t?new HL({rctx:this._rctx,materialRepository:this._materialRepository}):new k_({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,i),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",()=>this.events.emit("content-changed")),e),this._handles.add(Wt(i,"updating",()=>this.notifyChange("updating")),e)),i}_updateSortedLayerRenderers(){if(!this._sortedLayerRenderersDirty||(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),this._layerRenderers.size===0))return;const e=this.view.map.allLayers;this._layerRenderers.forEach((t,i)=>{const r=e.indexOf(i.layer);this._sortedLayerRenderers.push(new AQe(i,t,r<0?1/0:r))}),this._sortedLayerRenderers.sort((t,i)=>t.index-i.index)}_setViewParameters(e,t,i){i.viewport[0]=i.viewport[1]=0,i.viewport[2]=i.viewport[3]=t.resolution,Cj(i.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],i.near,i.far),rF(i.viewMatrix,[-e[0],-e[1],0]),this._renderContext.camera=i,this._bindParameters.camera=i,this._bindParameters.inverseViewport[0]=1/i.fullViewport[2],this._bindParameters.inverseViewport[1]=1/i.fullViewport[3]}_updateHasWater(){const e=qr(this._layerRenderers,t=>t.hasWater);e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_updateHasHighlights(){const e=qr(this._layerRenderers,t=>t.hasHighlights);e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))}_updateRendersOccluded(){const e=qr(this._layerRenderers,t=>t.rendersOccluded);e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}_drawDebugTexture(e,t){this._ensureDebugPatternResources(e,e);const i=this._rctx,r=i.useTechnique(this._debugTextureTechnique);r.setUniform4f("uColor",t[0],t[1],t[2],1),r.bindTexture(this._debugPatternTexture,"tex"),i.bindVAO(this._quadVAO),i.drawArrays(Tt.TRIANGLE_STRIP,0,vn(this._quadVAO,"geometry"))}_ensureDebugPatternResources(e,t){if(this._debugPatternTexture)return;const i=new Uint8Array(e*t*4);let r=0;for(let n=0;n<t;n++)for(let o=0;o<e;o++){const a=Math.floor(o/10),l=Math.floor(n/10);a<2||l<2||10*a>e-20||10*l>t-20?(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=255):(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=1&a&&1&l?1&o^1&n?0:255:1&a^1&l?0:128)}this._debugPatternTexture=new Qe(this._rctx,{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.NEAREST,width:e,height:t},i);const s=new $W;s.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(qO,s),this._quadVAO=bo(this._rctx)}get test(){return{layerRenderers:this._layerRenderers}}};var Ey;u([d()],bh.prototype,"_frameTask",void 0),u([d()],bh.prototype,"_sortedLayerRenderersDirty",void 0),u([Dn()],bh.prototype,"_shaderTechniqueRepository",void 0),u([Dn()],bh.prototype,"_stippleTextureRepository",void 0),u([d({constructOnly:!0})],bh.prototype,"view",void 0),u([d()],bh.prototype,"worldToPCSRatio",void 0),u([d()],bh.prototype,"spatialReference",void 0),u([d({type:Boolean,readOnly:!0})],bh.prototype,"updating",null),bh=u([P("esri.views.3d.terrain.OverlayRenderer")],bh),function(e){e[e.Normal=0]="Normal",e[e.OccludedOnly=1]="OccludedOnly",e[e.ExcludeRasterImage=2]="ExcludeRasterImage"}(Ey||(Ey={}));class AQe{constructor(t,i,r){this.overlayLayer=t,this.renderer=i,this.index=r}}const CQe=[[1,.5,.5],[.5,.5,1]];function RQe(e,t,i,r,s,n,o){const a={layerUid:n,graphicUid:o,triangleNr:t},l=c=>{c.set(ur.OVERLAY,a,e.dist,e.normal,e.transformation,i,r)};if((s.results.min.drapedLayerOrder==null||i>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&l(s.results.min),s.options.store!==Wn.MIN&&(s.results.max.drapedLayerOrder==null||i<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&l(s.results.max),s.options.store===Wn.ALL){const c=QF(s.ray);l(c),s.results.all.push(c)}}const K_=new wi;K_.near=1,K_.far=1e4,K_.relativeElevation=null;const B3=M(),V3=M(),DW=-2,YL=Cr.OccludeAndTransparent;function yie(e){const t=[[E.POSITION,e.indices]],i=[[E.POSITION,{size:3,data:e.attributeData.position,exclusive:!0}]];return _(e.attributeData.color)&&(i.push([E.COLOR,{size:4,data:e.attributeData.color,exclusive:!0}]),t.push([E.COLOR,new Uint32Array(e.indices.length)])),_(e.attributeData.uvMapSpace)&&(i.push([E.UVMAPSPACE,{size:4,data:e.attributeData.uvMapSpace,exclusive:!0}]),t.push([E.UVMAPSPACE,e.indices])),_(e.attributeData.boundingRect)&&(i.push([E.BOUNDINGRECT,{size:9,data:e.attributeData.boundingRect,exclusive:!0}]),t.push([E.BOUNDINGRECT,e.indices])),_(e.attributeData.mapPosition)&&(i.push([E.MAPPOS,{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push([E.MAPPOS,e.indices])),new lr(i,t)}function vie(e){const t=[[E.POSITION,e.indices],[E.UV0,e.indices]],i=[[E.POSITION,{size:3,data:e.attributeData.position,exclusive:!0}],[E.UV0,{size:2,data:e.attributeData.uv0,exclusive:!0}]];return _(e.attributeData.mapPosition)&&(i.push([E.MAPPOS,{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push([E.MAPPOS,e.indices])),new lr(i,t)}function NR(e){switch(e.type){case"extent":if(e instanceof Xt)return bc.fromExtent(e);break;case"polygon":return e}return null}function LW(e,t,i,r){const s=jO(e.rings,e.hasZ,Pp.CCW_IS_HOLE),n=new Float64Array(s.position.length),o=ave(s.position,e.spatialReference,0,n,0,s.position,0,s.position.length/3,t,i,r),a=o!=null;return{position:s.position,mapPosition:n,polygons:s_e(s.polygons,s.position,n),outlines:r_e(s.outlines,s.position,n),projectionSuccess:a,sampledElevation:o}}function i_e(e,t){const i=jO(e.rings,!1,Pp.CCW_IS_HOLE),r=br(i.position,e.spatialReference,0,i.position,t,0,i.position.length/3);for(let s=2;s<i.position.length;s+=3)i.position[s]=DW;return{position:i.position,polygons:s_e(i.polygons,i.position),outlines:r_e(i.outlines,i.position),projectionSuccess:r}}function r_e(e,t,i){const r=new Array;for(const{index:s,count:n}of e){if(n<=1)continue;const o=3*s,a=o+3*n;r.push({index:s,count:n,position:t.subarray(o,a),mapPosition:i?i.subarray(o,a):void 0})}return r}function s_e(e,t,i){const r=new Array;for(const{index:s,count:n,holeIndices:o,pathLengths:a}of e){if(n<=1)continue;const l=3*s,c=l+3*n,h=o.map(p=>p-s);r.push({index:s,count:n,holeIndices:h,pathLengths:a,position:t.subarray(l,c),mapPosition:i?i.subarray(l,c):void 0})}return r}function n_e(e,t){const i=e.fragment;switch(i.code.add(x`struct ShadingNormalParameters {
vec3 normalView;
vec3 viewDirection;
} shadingParams;`),t.doubleSidedMode){case hr.None:i.code.add(x`vec3 shadingNormal(ShadingNormalParameters params) {
return normalize(params.normalView);
}`);break;case hr.View:i.code.add(x`vec3 shadingNormal(ShadingNormalParameters params) {
return dot(params.normalView, params.viewDirection) > 0.0 ? normalize(-params.normalView) : normalize(params.normalView);
}`);break;case hr.WindingOrder:i.code.add(x`vec3 shadingNormal(ShadingNormalParameters params) {
return gl_FrontFacing ? normalize(params.normalView) : normalize(-params.normalView);
}`);break;default:t.doubleSidedMode;case hr.COUNT:}}var hr;(function(e){e[e.None=0]="None",e[e.View=1]="View",e[e.WindingOrder=2]="WindingOrder",e[e.COUNT=3]="COUNT"})(hr||(hr={}));function NW({code:e},t){t.doublePrecisionRequiresObfuscation?e.add(x`vec3 dpPlusFrc(vec3 a, vec3 b) {
return mix(a, a + b, vec3(notEqual(b, vec3(0))));
}
vec3 dpMinusFrc(vec3 a, vec3 b) {
return mix(vec3(0), a - b, vec3(notEqual(a, b)));
}
vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = dpPlusFrc(hiA, hiB);
vec3 e = dpMinusFrc(t1, hiA);
vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
return t1 + t2;
}`):e.add(x`vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = hiA + hiB;
vec3 e = t1 - hiA;
vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
return t1 + t2;
}`)}function S4(e){return!!ue("force-double-precision-obfuscation")||e.driverTest.doublePrecisionRequiresObfuscation}function o_e(e,t){t.instanced&&t.instancedDoublePrecision&&(e.attributes.add(E.MODELORIGINHI,"vec3"),e.attributes.add(E.MODELORIGINLO,"vec3"),e.attributes.add(E.MODEL,"mat3"),e.attributes.add(E.MODELNORMAL,"mat3")),t.instancedDoublePrecision&&(e.vertex.include(NW,t),e.vertex.uniforms.add("viewOriginHi","vec3"),e.vertex.uniforms.add("viewOriginLo","vec3"));const i=[x`
    vec3 calculateVPos() {
      ${t.instancedDoublePrecision?"return model * localPosition().xyz;":"return localPosition().xyz;"}
    }
    `,x`
    vec3 subtractOrigin(vec3 _pos) {
      ${t.instancedDoublePrecision?x`
          vec3 originDelta = dpAdd(viewOriginHi, viewOriginLo, -modelOriginHi, -modelOriginLo);
          return _pos - originDelta;`:"return vpos;"}
    }
    `,x`
    vec3 dpNormal(vec4 _normal) {
      ${t.instancedDoublePrecision?"return normalize(modelNormal * _normal.xyz);":"return normalize(_normal.xyz);"}
    }
    `,x`
    vec3 dpNormalView(vec4 _normal) {
      ${t.instancedDoublePrecision?"return normalize((viewNormal * vec4(modelNormal * _normal.xyz, 1.0)).xyz);":"return normalize((viewNormal * _normal).xyz);"}
    }
    `,t.vertexTangents?x`
    vec4 dpTransformVertexTangent(vec4 _tangent) {
      ${t.instancedDoublePrecision?"return vec4(modelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"}

    }
    `:x``];e.vertex.code.add(i[0]),e.vertex.code.add(i[1]),e.vertex.code.add(i[2]),t.output===j.Normal&&e.vertex.code.add(i[3]),e.vertex.code.add(i[4])}function OQe(e,t){h7e(t,_ie,bie,3),e.setUniform3fv("viewOriginHi",_ie),e.setUniform3fv("viewOriginLo",bie)}const _ie=M(),bie=M();function MQe(e){const t=x`vec3 decodeNormal(vec2 f) {
float z = 1.0 - abs(f.x) - abs(f.y);
return vec3(f + sign(f) * min(z, 0.0), z);
}`;e.fragment.code.add(t),e.vertex.code.add(t)}function E4(e,t){t.normalType===Mr.Attribute&&(e.attributes.add(E.NORMAL,"vec3"),e.vertex.code.add(x`vec3 normalModel() {
return normal;
}`)),t.normalType===Mr.CompressedAttribute&&(e.include(MQe),e.attributes.add(E.NORMALCOMPRESSED,"vec2"),e.vertex.code.add(x`vec3 normalModel() {
return decodeNormal(normalCompressed);
}`)),t.normalType===Mr.ScreenDerivative&&(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(x`vec3 screenDerivativeNormal(vec3 positionView) {
return normalize(cross(dFdx(positionView), dFdy(positionView)));
}`))}var Mr;(function(e){e[e.Attribute=0]="Attribute",e[e.CompressedAttribute=1]="CompressedAttribute",e[e.Ground=2]="Ground",e[e.ScreenDerivative=3]="ScreenDerivative",e[e.COUNT=4]="COUNT"})(Mr||(Mr={}));function a_e(e){e.vertex.code.add(x`vec4 offsetBackfacingClipPosition(vec4 posClip, vec3 posWorld, vec3 normalWorld, vec3 camPosWorld) {
vec3 camToVert = posWorld - camPosWorld;
bool isBackface = dot(camToVert, normalWorld) > 0.0;
if (isBackface) {
posClip.z += 0.0000003 * posClip.w;
}
return posClip;
}`)}function A4(e){e.attributes.add(E.POSITION,"vec3"),e.vertex.code.add(x`vec3 positionModel() { return position; }`)}var ws;function PQe(e){switch(e){case"multiply":default:return ws.Multiply;case"ignore":return ws.Ignore;case"replace":return ws.Replace;case"tint":return ws.Tint}}function l_e(e,t,i){if(R(e)||t===ws.Ignore)return i[0]=255,i[1]=255,i[2]=255,void(i[3]=255);const r=Be(Math.round(e[3]*ZL),0,ZL),s=r===0||t===ws.Tint?0:t===ws.Replace?IQe:$Qe;i[0]=Be(Math.round(e[0]*jb),0,jb),i[1]=Be(Math.round(e[1]*jb),0,jb),i[2]=Be(Math.round(e[2]*jb),0,jb),i[3]=r+s}(function(e){e[e.Multiply=1]="Multiply",e[e.Ignore=2]="Ignore",e[e.Replace=3]="Replace",e[e.Tint=4]="Tint"})(ws||(ws={}));const jb=255,ZL=85,IQe=ZL,$Qe=2*ZL;function c_e(e){e.vertex.code.add(x`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${x.int(ws.Multiply)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${x.int(ws.Replace)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${x.int(ws.Tint)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${x.int(ws.Multiply)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)}function u_e(e,t){t.symbolColor?(e.include(c_e),e.attributes.add(E.SYMBOLCOLOR,"vec4"),e.varyings.add("colorMixMode","mediump float")):e.fragment.uniforms.add("colorMixMode","int"),t.symbolColor?e.vertex.code.add(x`int symbolColorMixMode;
vec4 getSymbolColor() {
return decodeSymbolColor(symbolColor, symbolColorMixMode) * 0.003921568627451;
}
void forwardColorMixMode() {
colorMixMode = float(symbolColorMixMode) + 0.5;
}`):e.vertex.code.add(x`vec4 getSymbolColor() { return vec4(1.0); }
void forwardColorMixMode() {}`)}function xb(e,t){t.attributeColor?(e.attributes.add(E.COLOR,"vec4"),e.varyings.add("vColor","vec4"),e.vertex.code.add(x`void forwardVertexColor() { vColor = color; }`),e.vertex.code.add(x`void forwardNormalizedVertexColor() { vColor = color * 0.003921568627451; }`)):e.vertex.code.add(x`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)}function cT(e,t){e.include(A4),e.vertex.include(NW,t),e.varyings.add("vPositionWorldCameraRelative","vec3"),e.varyings.add("vPosition_view","vec3"),e.vertex.uniforms.add("transformWorldFromModelRS","mat3"),e.vertex.uniforms.add("transformWorldFromModelTH","vec3"),e.vertex.uniforms.add("transformWorldFromModelTL","vec3"),e.vertex.uniforms.add("transformWorldFromViewTH","vec3"),e.vertex.uniforms.add("transformWorldFromViewTL","vec3"),e.vertex.uniforms.add("transformViewFromCameraRelativeRS","mat3"),e.vertex.uniforms.add("transformProjFromView","mat4"),e.vertex.code.add(x`vec3 positionWorldCameraRelative() {
vec3 rotatedModelPosition = transformWorldFromModelRS * positionModel();
vec3 transform_CameraRelativeFromModel = dpAdd(
transformWorldFromModelTL,
transformWorldFromModelTH,
-transformWorldFromViewTL,
-transformWorldFromViewTH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}
vec3 position_view() {
return transformViewFromCameraRelativeRS * positionWorldCameraRelative();
}
void forwardPosition() {
vPositionWorldCameraRelative = positionWorldCameraRelative();
vPosition_view = position_view();
gl_Position = transformProjFromView * vec4(vPosition_view, 1.0);
}
vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`),e.fragment.uniforms.add("transformWorldFromViewTL","vec3"),e.fragment.code.add(x`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`)}class DQe{constructor(){this.transformWorldFromModelRS=wr(),this.transformWorldFromModelTH=M(),this.transformWorldFromModelTL=M()}}class h_e{constructor(){this.transformWorldFromViewTH=M(),this.transformWorldFromViewTL=M(),this.transformViewFromCameraRelativeRS=wr(),this.transformProjFromView=Te()}}function d_e(e,t){e.setUniformMatrix3fv("transformWorldFromModelRS",t.transformWorldFromModelRS),e.setUniform3fv("transformWorldFromModelTH",t.transformWorldFromModelTH),e.setUniform3fv("transformWorldFromModelTL",t.transformWorldFromModelTL)}function p_e(e,t){e.setUniform3fv("transformWorldFromViewTH",t.transformWorldFromViewTH),e.setUniform3fv("transformWorldFromViewTL",t.transformWorldFromViewTL),e.setUniformMatrix4fv("transformProjFromView",t.transformProjFromView),e.setUniformMatrix3fv("transformViewFromCameraRelativeRS",t.transformViewFromCameraRelativeRS)}function C4(e,t){t.normalType===Mr.Attribute||t.normalType===Mr.CompressedAttribute?(e.include(E4,t),e.varyings.add("vNormalWorld","vec3"),e.varyings.add("vNormalView","vec3"),e.vertex.uniforms.add("transformNormalGlobalFromModel","mat3"),e.vertex.uniforms.add("transformNormalViewFromGlobal","mat3"),e.vertex.code.add(x`void forwardNormal() {
vNormalWorld = transformNormalGlobalFromModel * normalModel();
vNormalView = transformNormalViewFromGlobal * vNormalWorld;
}`)):t.normalType===Mr.Ground?(e.include(cT,t),e.varyings.add("vNormalWorld","vec3"),e.vertex.code.add(x`
    void forwardNormal() {
      vNormalWorld = ${t.viewingMode===Ie.Global?x`normalize(vPositionWorldCameraRelative);`:x`vec3(0.0, 0.0, 1.0);`}
    }
    `)):e.vertex.code.add(x`void forwardNormal() {}`)}function LQe(e,t){e.setUniformMatrix4fv("viewNormal",t)}function f_e(e,t){const i=e.vertex.code,r=e.fragment.code,s=t.hasModelTransformation;t.output!==j.Depth&&t.output!==j.Shadow||(e.include(Gn,{linearDepth:!0,hasModelTransformation:s}),e.include(gm,t),e.include(aT,t),e.include(q0,t),e.include(Or,t),e.vertex.uniforms.add("nearFar","vec2"),e.varyings.add("depth","float"),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),i.add(x`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPositionWithDepth(proj, view, ${s?"model,":""} vpos, nearFar, depth);
        forwardTextureCoordinates();
      }
    `),e.include(vm,t),r.add(x`
      void main(void) {
        discardBySlice(vpos);
        ${t.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}
        outputDepth(depth);
      }
    `)),t.output===j.Normal&&(e.include(Gn,{linearDepth:!1,hasModelTransformation:s}),e.include(E4,t),e.include(C4,t),e.include(gm,t),e.include(aT,t),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),e.vertex.uniforms.add("viewNormal","mat4"),e.varyings.add("vPositionView","vec3"),i.add(x`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        ${t.normalType===Mr.Attribute?x`
        vNormalWorld = dpNormalView(vvLocalNormal(normalModel()));`:""}
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, ${s?"model,":""} vpos);
        forwardTextureCoordinates();
      }
    `),e.include(Or,t),e.include(vm,t),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${t.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}

        ${t.normalType===Mr.ScreenDerivative?x`
            vec3 normal = screenDerivativeNormal(vPositionView);`:x`
            vec3 normal = normalize(vNormalWorld);
            if (gl_FrontFacing == false) normal = -normal;`}
        gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
      }
    `)),t.output===j.Highlight&&(e.include(Gn,{linearDepth:!1,hasModelTransformation:s}),e.include(gm,t),e.include(aT,t),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),i.add(x`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, ${s?"model,":""} vpos);
        forwardTextureCoordinates();
      }
    `),e.include(Or,t),e.include(vm,t),e.include(Qm),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${t.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}
        outputHighlight();
      }
    `))}function m_e(e,t){const i=e.fragment;t.vertexTangents?(e.attributes.add(E.TANGENT,"vec4"),e.varyings.add("vTangent","vec4"),t.doubleSidedMode===hr.WindingOrder?i.code.add(x`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = gl_FrontFacing ? vTangent.w : -vTangent.w;
vec3 tangent = normalize(gl_FrontFacing ? vTangent.xyz : -vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`):i.code.add(x`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = vTangent.w;
vec3 tangent = normalize(vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`)):(e.extensions.add("GL_OES_standard_derivatives"),i.code.add(x`mat3 computeTangentSpace(vec3 normal, vec3 pos, vec2 st) {
vec3 Q1 = dFdx(pos);
vec3 Q2 = dFdy(pos);
vec2 stx = dFdx(st);
vec2 sty = dFdy(st);
float det = stx.t * sty.s - sty.t * stx.s;
vec3 T = stx.t * Q2 - sty.t * Q1;
T = T - normal * dot(normal, T);
T *= inversesqrt(max(dot(T,T), 1.e-10));
vec3 B = sign(det) * cross(normal, T);
return mat3(T, B, normal);
}`)),t.attributeTextureCoordinates!==_n.None&&(e.include(vq,t),i.uniforms.add("normalTexture","sampler2D"),i.uniforms.add("normalTextureSize","vec2"),i.code.add(x`
    vec3 computeTextureNormal(mat3 tangentSpace, vec2 uv) {
      vtc.uv = uv;
      ${t.supportsTextureAtlas?"vtc.size = normalTextureSize;":""}
      vec3 rawNormal = textureLookup(normalTexture, vtc).rgb * 2.0 - 1.0;
      return tangentSpace * rawNormal;
    }
  `))}function R4(e,t){const i=e.fragment;t.receiveAmbientOcclusion?(i.uniforms.add("ssaoTex","sampler2D"),i.uniforms.add("viewportPixelSz","vec4"),i.code.add(x`float evaluateAmbientOcclusion() {
return 1.0 - texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
}
float evaluateAmbientOcclusionInverse() {
float ssao = texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
return viewportPixelSz.z < 0.0 ? 1.0 : ssao;
}`)):i.code.add(x`float evaluateAmbientOcclusion() { return 0.0; }
float evaluateAmbientOcclusionInverse() { return 1.0; }`)}function J1(e,t){const i=e.fragment;e.include(GF),e.include(R4,t),t.pbrMode!==xt.Disabled&&e.include(v4,t),e.include(bq,t),t.receiveShadows&&e.include(Lm,t),i.uniforms.add("lightingGlobalFactor","float"),i.uniforms.add("ambientBoostFactor","float"),i.uniforms.add("hasFillLights","bool"),e.include(jF),i.code.add(x`
    const float GAMMA_SRGB = 2.1;
    const float INV_GAMMA_SRGB = 0.4761904;
    ${t.pbrMode===xt.Disabled?"":"const vec3 GROUND_REFLECTANCE = vec3(0.2);"}
  `),i.code.add(x`
    float additionalDirectedAmbientLight(vec3 vPosWorld) {
      float vndl = dot(${t.viewingMode===Ie.Global?x`normalize(vPosWorld)`:x`vec3(0.0, 0.0, 1.0)`}, lightingMainDirection);
      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
    }
  `),i.code.add(x`vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {
float additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);
return (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * lightingMainIntensity;
}`),t.pbrMode===xt.Disabled||t.pbrMode===xt.WaterOnIntegratedMesh?i.code.add(x`vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight)
{
vec3 mainLighting = evaluateMainLighting(normalWorld, shadow);
vec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);
vec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
vec3 totalLight = mainLighting + ambientLighting + additionalLight;
totalLight = min(totalLight, vec3(PI));
vec3 outColor = vec3((albedoLinear / PI) * totalLight);
return pow(outColor, vec3(INV_GAMMA_SRGB));
}`):t.pbrMode!==xt.Normal&&t.pbrMode!==xt.Schematic||(i.code.add(x`const float fillLightIntensity = 0.25;
const float horizonLightDiffusion = 0.4;
const float additionalAmbientIrradianceFactor = 0.02;
vec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight, vec3 viewDir, vec3 normalGround, vec3 mrr, vec3 _emission, float additionalAmbientIrradiance)
{
vec3 viewDirection = -viewDir;
vec3 mainLightDirection = lightingMainDirection;
vec3 h = normalize(viewDirection + mainLightDirection);
PBRShadingInfo inputs;
inputs.NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);
inputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);
inputs.NdotH = clamp(dot(normal, h), 0.0, 1.0);
inputs.VdotH = clamp(dot(viewDirection, h), 0.0, 1.0);
inputs.NdotNG = clamp(dot(normal, normalGround), -1.0, 1.0);
vec3 reflectedView = normalize(reflect(viewDirection, normal));
inputs.RdotNG = clamp(dot(reflectedView, normalGround), -1.0, 1.0);
inputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
inputs.ssao = ssao;
inputs.metalness = mrr[0];
inputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);`),i.code.add(x`inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;
inputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));
inputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);`),i.code.add(x`vec3 ambientDir = vec3(5.0 * normalGround[1] - normalGround[0] * normalGround[2], - 5.0 * normalGround[0] - normalGround[2] * normalGround[1], normalGround[1] * normalGround[1] + normalGround[0] * normalGround[0]);
ambientDir = ambientDir != vec3(0.0)? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));
inputs.NdotAmbDir = hasFillLights ? abs(dot(normal, ambientDir)) : 1.0;
vec3 mainLightIrradianceComponent = inputs.NdotL * (1.0 - shadow) * lightingMainIntensity;
vec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * lightingMainIntensity * fillLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;
inputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
inputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;`),i.code.add(x`vec3 horizonRingDir = inputs.RdotNG * normalGround - reflectedView;
vec3 horizonRingH = normalize(viewDirection + horizonRingDir);
inputs.NdotH_Horizon = dot(normal, horizonRingH);
vec3 mainLightRadianceComponent = lightingSpecularStrength * normalDistribution(inputs.NdotH, inputs.roughness) * lightingMainIntensity * (1.0 - shadow);
vec3 horizonLightRadianceComponent = lightingEnvironmentStrength * normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * lightingMainIntensity * fillLightIntensity;
vec3 ambientLightRadianceComponent = lightingEnvironmentStrength * calculateAmbientRadiance(ssao) + additionalLight;
inputs.skyRadianceToSurface = ambientLightRadianceComponent + mainLightRadianceComponent + horizonLightRadianceComponent;
inputs.groundRadianceToSurface = GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) + mainLightRadianceComponent;
inputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE[1]);`),i.code.add(x`
        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);
        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;
        vec3 emissionComponent = pow(_emission, vec3(GAMMA_SRGB));
        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;
        ${t.pbrMode===xt.Schematic?x`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`:x`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs), vec3(INV_GAMMA_SRGB));`}
        return outColor;
      }
    `))}function g_e(e,t){const i=x`
  /*
  *  ${t.name}
  *  ${t.output===j.Color?"RenderOutput: Color":t.output===j.Depth?"RenderOutput: Depth":t.output===j.Shadow?"RenderOutput: Shadow":t.output===j.Normal?"RenderOutput: Normal":t.output===j.Highlight?"RenderOutput: Highlight":""}
  */
  `;aR()&&(e.fragment.code.add(i),e.vertex.code.add(i))}function FR(e){e.include(Vp),e.code.add(x`
    vec3 mixExternalColor(vec3 internalColor, vec3 textureColor, vec3 externalColor, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      vec3 internalMixed = internalColor * textureColor;
      vec3 allMixed = internalMixed * externalColor;

      if (mode == ${x.int(ws.Multiply)}) {
        return allMixed;
      }
      else if (mode == ${x.int(ws.Ignore)}) {
        return internalMixed;
      }
      else if (mode == ${x.int(ws.Replace)}) {
        return externalColor;
      }
      else {
        // tint (or something invalid)
        float vIn = rgb2v(internalMixed);
        vec3 hsvTint = rgb2hsv(externalColor);
        vec3 hsvOut = vec3(hsvTint.x, hsvTint.y, vIn * hsvTint.z);
        return hsv2rgb(hsvOut);
      }
    }

    float mixExternalOpacity(float internalOpacity, float textureOpacity, float externalOpacity, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      float internalMixed = internalOpacity * textureOpacity;
      float allMixed = internalMixed * externalOpacity;

      if (mode == ${x.int(ws.Ignore)}) {
        return internalMixed;
      }
      else if (mode == ${x.int(ws.Replace)}) {
        return externalOpacity;
      }
      else {
        // multiply or tint (or something invalid)
        return allMixed;
      }
    }
  `)}function NQe(e){const t=new Oi,i=t.vertex.code,r=t.fragment.code;t.include(g_e,{name:"Default Material Shader",output:e.output}),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("cameraPosition","vec3").add("localOrigin","vec3");const s=e.hasModelTransformation;return s&&t.vertex.uniforms.add("model","mat4"),t.include(A4),t.varyings.add("vpos","vec3"),t.include(aT,e),t.include(o_e,e),t.include(k0e,e),e.output!==j.Color&&e.output!==j.Alpha||(t.include(E4,e),t.include(Gn,{linearDepth:!1,hasModelTransformation:s}),e.normalType===Mr.Attribute&&e.offsetBackfaces&&t.include(a_e),t.include(m_e,e),t.include(C4,e),e.instancedColor&&t.attributes.add(E.INSTANCECOLOR,"vec4"),t.varyings.add("localvpos","vec3"),t.include(gm,e),t.include(HO,e),t.include(u_e,e),t.include(xb,e),t.vertex.uniforms.add("externalColor","vec4"),t.varyings.add("vcolorExt","vec4"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),i.add(x`
      void main(void) {
        forwardNormalizedVertexColor();
        vcolorExt = externalColor;
        ${e.instancedColor?"vcolorExt *= instanceColor;":""}
        vcolorExt *= vvColor();
        vcolorExt *= getSymbolColor();
        forwardColorMixMode();

        if (vcolorExt.a < ${x.float(Hn)}) {
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        }
        else {
          vpos = calculateVPos();
          localvpos = vpos - view[3].xyz;
          vpos = subtractOrigin(vpos);
          ${e.normalType===Mr.Attribute?x`
          vNormalWorld = dpNormal(vvLocalNormal(normalModel()));`:""}
          vpos = addVerticalOffset(vpos, localOrigin);
          ${e.vertexTangents?"vTangent = dpTransformVertexTangent(tangent);":""}
          gl_Position = transformPosition(proj, view, ${s?"model,":""} vpos);
          ${e.normalType===Mr.Attribute&&e.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":""}
        }

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        forwardLinearDepth();
        forwardTextureCoordinates();
      }
    `)),e.output===j.Alpha&&(t.include(Or,e),t.include(vm,e),e.multipassTerrainEnabled&&(t.fragment.include(Os),t.include(Ec,e)),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("opacity","float").add("layerOpacity","float"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.fragment.include(FR),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${e.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        ${e.attributeColor?x`
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        gl_FragColor = vec4(opacity_);
      }
    `)),e.output===j.Color&&(t.include(Or,e),t.include(J1,e),t.include(R4,e),t.include(vm,e),e.receiveShadows&&t.include(Lm,e),e.multipassTerrainEnabled&&(t.fragment.include(Os),t.include(Ec,e)),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("opacity","float").add("layerOpacity","float"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.include(_q,e),t.include(v4,e),t.fragment.include(FR),t.include(n_e,e),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${e.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        shadingParams.viewDirection = normalize(vpos - cameraPosition);
        ${e.normalType===Mr.ScreenDerivative?x`
        vec3 normal = screenDerivativeNormal(localvpos);`:x`
        shadingParams.normalView = vNormalWorld;
        vec3 normal = shadingNormal(shadingParams);`}
        ${e.pbrMode===xt.Normal?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.viewingMode===Ie.Global?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${e.attributeColor?x`
        vec3 albedo_ = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`
        vec3 albedo_ = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        ${e.hasNormalTexture?x`
              mat3 tangentSpace = ${e.vertexTangents?"computeTangentSpace(normal);":"computeTangentSpace(normal, vpos, vuv0);"}
              vec3 shadedNormal = computeTextureNormal(tangentSpace, vuv0);`:"vec3 shadedNormal = normal;"}
        ${e.pbrMode===xt.Normal||e.pbrMode===xt.Schematic?e.viewingMode===Ie.Global?x`vec3 normalGround = normalize(vpos + localOrigin);`:x`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:x``}
        ${e.pbrMode===xt.Normal||e.pbrMode===xt.Schematic?x`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * lightingMainIntensity[2];
            vec3 shadedColor = evaluateSceneLightingPBR(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:"vec3 shadedColor = evaluateSceneLighting(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight);"}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),t.include(f_e,e),t}const FQe=Object.freeze({__proto__:null,build:NQe}),UQe=he.getLogger("esri.views.3d.webgl-engine.shaders.DefaultTechnique");class WO extends Gi{initializeProgram(t){const i=WO.shader.get(),r=this.configuration,s=i.build({oitEnabled:r.transparencyPassType===lt.Color,output:r.output,viewingMode:t.viewingMode,receiveShadows:r.receiveShadows,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:r.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,symbolColor:r.symbolColors,vvSize:r.vvSize,vvColor:r.vvColor,vvInstancingEnabled:!0,instanced:r.instanced,instancedColor:r.instancedColor,instancedDoublePrecision:r.instancedDoublePrecision,pbrMode:r.usePBR?r.isSchematic?xt.Schematic:xt.Normal:xt.Disabled,hasMetalnessAndRoughnessTexture:r.hasMetalnessAndRoughnessTexture,hasEmissionTexture:r.hasEmissionTexture,hasOcclusionTexture:r.hasOcclusionTexture,hasNormalTexture:r.hasNormalTexture,hasColorTexture:r.hasColorTexture,hasModelTransformation:r.hasModelTransformation,receiveAmbientOcclusion:r.receiveAmbientOcclusion,useCustomDTRExponentForWater:!1,normalType:r.normalsTypeDerivate?Mr.ScreenDerivative:Mr.Attribute,doubleSidedMode:r.doubleSidedMode,vertexTangents:r.vertexTangents,attributeTextureCoordinates:r.hasMetalnessAndRoughnessTexture||r.hasEmissionTexture||r.hasOcclusionTexture||r.hasNormalTexture||r.hasColorTexture?_n.Default:_n.None,textureAlphaPremultiplied:r.textureAlphaPremultiplied,attributeColor:r.vertexColors,screenSizePerspectiveEnabled:r.screenSizePerspective,verticalOffsetEnabled:r.verticalOffset,offsetBackfaces:r.offsetBackfaces,doublePrecisionRequiresObfuscation:S4(t.rctx),alphaDiscardMode:r.alphaDiscardMode,supportsTextureAtlas:!1,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Mi(t.rctx,s,mi)}bindPass(t,i){var r,s;Ol(this.program,i.camera.projectionMatrix);const n=this.configuration.output;this.configuration.hasModelTransformation&&(_(t.modelTransformation)?this.program.setUniformMatrix4fv("model",t.modelTransformation):UQe.warnOnce("hasModelTransformation true, but no modelTransformation found.")),(this.configuration.output===j.Depth||i.multipassTerrainEnabled||n===j.Shadow)&&this.program.setUniform2fv("nearFar",i.camera.nearFar),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),Jm(this.program,i)),n===j.Alpha&&(this.program.setUniform1f("opacity",t.opacity),this.program.setUniform1f("layerOpacity",t.layerOpacity),this.program.setUniform4fv("externalColor",t.externalColor),this.program.setUniform1i("colorMixMode",Y9[t.colorMixMode])),n===j.Color?(i.lighting.setUniforms(this.program,!1,i.hasFillLights),this.program.setUniform3fv("ambient",t.ambient),this.program.setUniform3fv("diffuse",t.diffuse),this.program.setUniform4fv("externalColor",t.externalColor),this.program.setUniform1i("colorMixMode",Y9[t.colorMixMode]),this.program.setUniform1f("opacity",t.opacity),this.program.setUniform1f("layerOpacity",t.layerOpacity),this.configuration.usePBR&&Fge(this.program,t,this.configuration.isSchematic)):n===j.Highlight&&Hp(this.program,i),wWe(this.program,t),fW(this.program,t,i),MR(t.screenSizePerspective,this.program,"screenSizePerspectiveAlignment"),t.textureAlphaMode!==Ri.Mask&&t.textureAlphaMode!==Ri.MaskBlend||this.program.setUniform1f("textureAlphaCutoff",t.textureAlphaCutoff),(r=i.shadowMap)==null||r.bind(this.program),(s=i.ssaoHelper)==null||s.bind(this.program,i.camera)}bindDraw(t){const i=this.configuration.instancedDoublePrecision?je(t.camera.viewInverseTransposeMatrix[3],t.camera.viewInverseTransposeMatrix[7],t.camera.viewInverseTransposeMatrix[11]):t.origin;qge(this.program,i,t.camera.viewMatrix),this.program.rebindTextures(),(this.configuration.output===j.Color||this.configuration.output===j.Alpha||this.configuration.output===j.Depth&&this.configuration.screenSizePerspective||this.configuration.output===j.Normal&&this.configuration.screenSizePerspective||this.configuration.output===j.Highlight&&this.configuration.screenSizePerspective)&&j0(this.program,i,t.camera.viewInverseTransposeMatrix),this.configuration.output===j.Normal&&this.program.setUniformMatrix4fv("viewNormal",t.camera.viewInverseTransposeMatrix),this.configuration.instancedDoublePrecision&&OQe(this.program,i),I0(this.program,this.configuration,t.slicePlane,{origin:i}),this.configuration.output===j.Color&&QYe(this.program,t,i)}_convertDepthTestFunction(t){return t===F1.Lequal?Li.LEQUAL:Li.LESS}_setPipeline(t,i){const r=this.configuration,s=t===lt.NONE,n=t===lt.FrontFace;return Ot({blending:r.output!==j.Color&&r.output!==j.Alpha||!r.transparent?null:s?gl:Km(t),culling:kQe(r)&&VF(r.cullFace),depthTest:{func:H0(t,this._convertDepthTestFunction(r.customDepthTest))},depthWrite:s||n?r.writeDepth&&Ma:null,colorWrite:Ft,stencilWrite:r.sceneHasOcludees?Ip:null,stencilTest:r.sceneHasOcludees?i?D0:W0:null,polygonOffset:s||n?null:u4(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipeline(this.configuration.transparencyPassType,!0),this._setPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(t,i){return i?this._occludeePipelineState:super.getPipelineState(t,i)}}function kQe(e){return e.cullFace?e.cullFace!==Di.None:!e.slicePlaneEnabled&&!e.transparent&&!e.doubleSidedMode}WO.shader=new Ni(FQe,()=>import("./DefaultMaterial.glsl.22db7ccf.js"));class ci extends mr{constructor(){super(...arguments),this.output=j.Color,this.alphaDiscardMode=Ri.Opaque,this.doubleSidedMode=hr.None,this.isSchematic=!1,this.vertexColors=!1,this.offsetBackfaces=!1,this.symbolColors=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.sliceHighlightDisabled=!1,this.receiveAmbientOcclusion=!1,this.screenSizePerspective=!1,this.textureAlphaPremultiplied=!1,this.hasColorTexture=!1,this.usePBR=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.instanced=!1,this.instancedColor=!1,this.instancedDoublePrecision=!1,this.vertexTangents=!1,this.normalsTypeDerivate=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparent=!1,this.enableOffset=!0,this.cullFace=Di.None,this.transparencyPassType=lt.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1,this.hasModelTransformation=!1,this.customDepthTest=F1.Less}}u([Z({count:j.COUNT})],ci.prototype,"output",void 0),u([Z({count:Ri.COUNT})],ci.prototype,"alphaDiscardMode",void 0),u([Z({count:hr.COUNT})],ci.prototype,"doubleSidedMode",void 0),u([Z()],ci.prototype,"isSchematic",void 0),u([Z()],ci.prototype,"vertexColors",void 0),u([Z()],ci.prototype,"offsetBackfaces",void 0),u([Z()],ci.prototype,"symbolColors",void 0),u([Z()],ci.prototype,"vvSize",void 0),u([Z()],ci.prototype,"vvColor",void 0),u([Z()],ci.prototype,"verticalOffset",void 0),u([Z()],ci.prototype,"receiveShadows",void 0),u([Z()],ci.prototype,"slicePlaneEnabled",void 0),u([Z()],ci.prototype,"sliceHighlightDisabled",void 0),u([Z()],ci.prototype,"receiveAmbientOcclusion",void 0),u([Z()],ci.prototype,"screenSizePerspective",void 0),u([Z()],ci.prototype,"textureAlphaPremultiplied",void 0),u([Z()],ci.prototype,"hasColorTexture",void 0),u([Z()],ci.prototype,"usePBR",void 0),u([Z()],ci.prototype,"hasMetalnessAndRoughnessTexture",void 0),u([Z()],ci.prototype,"hasEmissionTexture",void 0),u([Z()],ci.prototype,"hasOcclusionTexture",void 0),u([Z()],ci.prototype,"hasNormalTexture",void 0),u([Z()],ci.prototype,"instanced",void 0),u([Z()],ci.prototype,"instancedColor",void 0),u([Z()],ci.prototype,"instancedDoublePrecision",void 0),u([Z()],ci.prototype,"vertexTangents",void 0),u([Z()],ci.prototype,"normalsTypeDerivate",void 0),u([Z()],ci.prototype,"writeDepth",void 0),u([Z()],ci.prototype,"sceneHasOcludees",void 0),u([Z()],ci.prototype,"transparent",void 0),u([Z()],ci.prototype,"enableOffset",void 0),u([Z({count:Di.COUNT})],ci.prototype,"cullFace",void 0),u([Z({count:lt.COUNT})],ci.prototype,"transparencyPassType",void 0),u([Z()],ci.prototype,"multipassTerrainEnabled",void 0),u([Z()],ci.prototype,"cullAboveGround",void 0),u([Z()],ci.prototype,"hasModelTransformation",void 0),u([Z({count:F1.COUNT})],ci.prototype,"customDepthTest",void 0);function zQe(e){const t=new Oi,i=t.vertex.code,r=t.fragment.code;return t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("cameraPosition","vec3").add("localOrigin","vec3"),t.include(A4),t.varyings.add("vpos","vec3"),t.include(aT,e),t.include(o_e,e),t.include(k0e,e),e.output!==j.Color&&e.output!==j.Alpha||(t.include(E4,e),t.include(Gn,{linearDepth:!1}),e.offsetBackfaces&&t.include(a_e),e.instancedColor&&t.attributes.add(E.INSTANCECOLOR,"vec4"),t.varyings.add("vNormalWorld","vec3"),t.varyings.add("localvpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.include(gm,e),t.include(HO,e),t.include(u_e,e),t.include(xb,e),t.vertex.uniforms.add("externalColor","vec4"),t.varyings.add("vcolorExt","vec4"),i.add(x`
        void main(void) {
          forwardNormalizedVertexColor();
          vcolorExt = externalColor;
          ${e.instancedColor?"vcolorExt *= instanceColor;":""}
          vcolorExt *= vvColor();
          vcolorExt *= getSymbolColor();
          forwardColorMixMode();

          if (vcolorExt.a < ${x.float(Hn)}) {
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          }
          else {
            vpos = calculateVPos();
            localvpos = vpos - view[3].xyz;
            vpos = subtractOrigin(vpos);
            vNormalWorld = dpNormal(vvLocalNormal(normalModel()));
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, vpos);
            ${e.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":""}
          }
          ${e.multipassTerrainEnabled?x`depth = (view * vec4(vpos, 1.0)).z;`:""}
          forwardLinearDepth();
          forwardTextureCoordinates();
        }
      `)),e.output===j.Alpha&&(t.include(Or,e),t.include(vm,e),e.multipassTerrainEnabled&&(t.fragment.include(Os),t.include(Ec,e)),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("opacity","float").add("layerOpacity","float"),t.fragment.uniforms.add("view","mat4"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.fragment.include(FR),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?x`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${e.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        ${e.attributeColor?x`
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}

        gl_FragColor = vec4(opacity_);
      }
    `)),e.output===j.Color&&(t.include(Or,e),t.include(J1,e),t.include(R4,e),t.include(vm,e),e.receiveShadows&&t.include(Lm,e),e.multipassTerrainEnabled&&(t.fragment.include(Os),t.include(Ec,e)),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("opacity","float").add("layerOpacity","float"),t.fragment.uniforms.add("view","mat4"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.include(_q,e),t.include(v4,e),t.fragment.include(FR),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?x`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${e.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        vec3 viewDirection = normalize(vpos - cameraPosition);
        ${e.pbrMode===xt.Normal?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.viewingMode===Ie.Global?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${e.attributeColor?x`
        vec3 albedo_ = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`
        vec3 albedo_ = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        ${x`
        vec3 shadedNormal = normalize(vNormalWorld);
        albedo_ *= 1.2;
        vec3 viewForward = vec3(view[0][2], view[1][2], view[2][2]);
        float alignmentLightView = clamp(dot(viewForward, -lightingMainDirection), 0.0, 1.0);
        float transmittance = 1.0 - clamp(dot(viewForward, shadedNormal), 0.0, 1.0);
        float treeRadialFalloff = vColor.r;
        float backLightFactor = 0.5 * treeRadialFalloff * alignmentLightView * transmittance * (1.0 - shadow);
        additionalLight += backLightFactor * lightingMainIntensity;`}
        ${e.pbrMode===xt.Normal||e.pbrMode===xt.Schematic?e.viewingMode===Ie.Global?x`vec3 normalGround = normalize(vpos + localOrigin);`:x`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:x``}
        ${e.pbrMode===xt.Normal||e.pbrMode===xt.Schematic?x`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * lightingMainIntensity[2];
            vec3 shadedColor = evaluateSceneLightingPBR(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight, viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:"vec3 shadedColor = evaluateSceneLighting(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight);"}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),t.include(f_e,e),t}const BQe=Object.freeze({__proto__:null,build:zQe});class O4 extends WO{initializeProgram(t){const i=O4.shader.get(),r=this.configuration,s=i.build({oitEnabled:r.transparencyPassType===lt.Color,output:r.output,viewingMode:t.viewingMode,receiveShadows:r.receiveShadows,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:r.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,symbolColor:r.symbolColors,vvSize:r.vvSize,vvColor:r.vvColor,vvInstancingEnabled:!0,instanced:r.instanced,instancedColor:r.instancedColor,instancedDoublePrecision:r.instancedDoublePrecision,pbrMode:r.usePBR?xt.Normal:xt.Disabled,hasMetalnessAndRoughnessTexture:!1,hasEmissionTexture:!1,hasOcclusionTexture:!1,hasNormalTexture:!1,hasColorTexture:r.hasColorTexture,hasModelTransformation:!1,receiveAmbientOcclusion:r.receiveAmbientOcclusion,useCustomDTRExponentForWater:!1,normalType:Mr.Attribute,doubleSidedMode:hr.WindingOrder,vertexTangents:!1,attributeTextureCoordinates:r.hasColorTexture?_n.Default:_n.None,textureAlphaPremultiplied:r.textureAlphaPremultiplied,attributeColor:r.vertexColors,screenSizePerspectiveEnabled:r.screenSizePerspective,verticalOffsetEnabled:r.verticalOffset,offsetBackfaces:r.offsetBackfaces,doublePrecisionRequiresObfuscation:S4(t.rctx),alphaDiscardMode:r.alphaDiscardMode,supportsTextureAtlas:!1,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Mi(t.rctx,s,mi)}}O4.shader=new Ni(BQe,()=>import("./RealisticTree.glsl.d7a5e591.js"));class K1 extends od{constructor(t){super(t,GQe),this.supportsEdges=!0,this.techniqueConfig=new ci,this.vertexBufferLayout=HQe(this.parameters),this.instanceBufferLayout=t.instanced?y_e(this.parameters):null}isVisibleInPass(t){return t!==Le.MATERIAL_DEPTH_SHADOWMAP_ALL&&t!==Le.MATERIAL_DEPTH_SHADOWMAP_DEFAULT&&t!==Le.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT||this.parameters.castShadows}isVisible(){const t=this.parameters;if(!super.isVisible()||t.layerOpacity===0)return!1;const i=t.instanced,r=t.vertexColors,s=t.symbolColors,n=!!i&&i.indexOf("color")>-1,o=t.vvColorEnabled,a=t.colorMixMode==="replace",l=t.opacity>0,c=t.externalColor&&t.externalColor[3]>0;return r&&(n||o||s)?!!a||l:r?a?c:l:n||o||s?!!a||l:a?c:l}getTechniqueConfig(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.hasNormalTexture=!!this.parameters.normalTextureId,this.techniqueConfig.hasColorTexture=!!this.parameters.textureId,this.techniqueConfig.vertexTangents=this.parameters.vertexTangents,this.techniqueConfig.instanced=!!this.parameters.instanced,this.techniqueConfig.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.verticalOffset=this.parameters.verticalOffset!==null,this.techniqueConfig.screenSizePerspective=this.parameters.screenSizePerspective!==null,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sliceHighlightDisabled=this.parameters.sliceHighlightDisabled,this.techniqueConfig.alphaDiscardMode=this.parameters.textureAlphaMode,this.techniqueConfig.normalsTypeDerivate=this.parameters.normals==="screenDerivative",this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,_(this.parameters.customDepthTest)&&(this.techniqueConfig.customDepthTest=this.parameters.customDepthTest),this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.cullFace=this.parameters.slicePlaneEnabled?Di.None:this.parameters.cullFace,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig.hasModelTransformation=_(this.parameters.modelTransformation),t!==j.Color&&t!==j.Alpha||(this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.symbolColors=this.parameters.symbolColors,this.parameters.treeRendering?this.techniqueConfig.doubleSidedMode=hr.WindingOrder:this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?hr.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?hr.WindingOrder:hr.None,this.techniqueConfig.instancedColor=!!this.parameters.instanced&&this.parameters.instanced.indexOf("color")>-1,this.techniqueConfig.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this.techniqueConfig.receiveAmbientOcclusion=!!i.ssaoEnabled&&this.parameters.receiveSSAO,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this.techniqueConfig.usePBR=this.parameters.usePBR,this.techniqueConfig.hasMetalnessAndRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this.techniqueConfig.hasEmissionTexture=!!this.parameters.emissiveTextureId,this.techniqueConfig.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this.techniqueConfig.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this.techniqueConfig.isSchematic=this.parameters.usePBR&&this.parameters.isSchematic,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.enableOffset=i.camera.relativeElevation<l4),this.techniqueConfig}intersect(t,i,r,s,n,o,a){if(this.parameters.verticalOffset!==null){const l=s.camera;oe(Bk,r[12],r[13],r[14]);let c=null;switch(s.viewingMode){case Ie.Global:c=be(wie,Bk);break;case Ie.Local:c=ne(wie,XQe)}let h=0;if(this.parameters.verticalOffset!==null){const p=de(YQe,Bk,l.eye),f=Pe(p),g=ae(p,p,1/f);let y=null;this.parameters.screenSizePerspective&&(y=_e(c,g)),h+=_0e(l,f,this.parameters.verticalOffset,y,this.parameters.screenSizePerspective)}ae(c,c,h),al(zk,c,s.transform.inverseRotation),n=de(qQe,n,zk),o=de(WQe,o,zk)}n4(t,i,s,n,o,L9(s.verticalOffset),a)}requiresSlot(t){return t===(this.parameters.transparent?this.parameters.writeDepth?ve.TRANSPARENT_MATERIAL:ve.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:ve.OPAQUE_MATERIAL)||t===ve.DRAPED_MATERIAL}createGLMaterial(t){return t.output===j.Color||t.output===j.Alpha||t.output===j.Depth||t.output===j.Normal||t.output===j.Shadow||t.output===j.Highlight?new VQe(t):null}createBufferWriter(){return new jQe(this.vertexBufferLayout,this.instanceBufferLayout)}}class VQe extends lW{constructor(t){super(I(I({},t),t.material.parameters))}updateParameters(t){const i=this._material.parameters;return this.updateTexture(i.textureId),this.ensureTechnique(i.treeRendering?O4:WO,t)}_updateShadowState(t){t.shadowMappingEnabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:t.shadowMappingEnabled})}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}beginSlot(t){return this._output!==j.Color&&this._output!==j.Alpha||(this._updateShadowState(t),this._updateOccludeeState(t)),this.updateParameters(t)}bind(t,i){i.bindPass(this._material.parameters,t),this.bindTextures(i.program)}}const GQe=I({textureId:void 0,initTextureTransparent:!1,isSchematic:!1,usePBR:!1,normalTextureId:void 0,vertexTangents:!1,occlusionTextureId:void 0,emissiveTextureId:void 0,metallicRoughnessTextureId:void 0,emissiveFactor:[0,0,0],mrrFactors:[0,1,.5],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,vertexColors:!1,symbolColors:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:Di.Back,instanced:void 0,instancedDoublePrecision:!1,normals:"default",receiveSSAO:!0,fillLightsEnabled:!0,receiveShadows:!0,castShadows:!0,shadowMappingEnabled:!1,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,sliceHighlightDisabled:!1,offsetTransparentBackfaces:!1,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvSizeValue:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:wr(),modelTransformation:null,transparent:!1,writeDepth:!0,customDepthTest:F1.Less,textureAlphaMode:Ri.Blend,textureAlphaCutoff:BL,textureAlphaPremultiplied:!1,sceneHasOcludees:!1},ju);class jQe{constructor(t,i){this.vertexBufferLayout=t,this.instanceBufferLayout=i}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(E.POSITION).length}write(t,i,r,s){o4(i,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,r,s)}}function HQe(e){const t=e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId,i=kr().vec3f(E.POSITION).vec3f(E.NORMAL);return e.vertexTangents&&i.vec4f(E.TANGENT),t&&i.vec2f(E.UV0),e.vertexColors&&i.vec4u8(E.COLOR),e.symbolColors&&i.vec4u8(E.SYMBOLCOLOR),i}function y_e(e){let t=kr();return t=e.instancedDoublePrecision?t.vec3f(E.MODELORIGINHI).vec3f(E.MODELORIGINLO).mat3f(E.MODEL).mat3f(E.MODELNORMAL):t.mat4f(E.MODEL).mat4f(E.MODELNORMAL),e.instanced&&e.instanced.indexOf("color")>-1&&(t=t.vec4f(E.INSTANCECOLOR)),e.instanced&&e.instanced.indexOf("featureAttribute")>-1&&(t=t.vec4f(E.INSTANCEFEATUREATTRIBUTE)),t}const qQe=M(),WQe=M(),XQe=je(0,0,1),wie=M(),zk=M(),Bk=M(),YQe=M(),ZQe=["polygon","extent"];class QQe extends Wp{constructor(t,i,r,s){super(t,i,r,s),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const a=h4(this._getSymbolSize());if(a)throw new q("graphics3dextrudesymbollayer:invalid-size",a)}const t=Pr(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(t),r=da(i),s=i[3],n=s<1||this.needsDrivenTransparentPass,o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:r,ambient:r,opacity:s,transparent:n,cullFace:n?Di.None:Di.Back,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new K1(o),this._bottomMaterial=new K1(me(I({},o),{cullFace:Di.Back})),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,ZQe,this.symbolLayer.type))return null;const r=this._getVertexOpacityAndColor(t.renderingInfo,255),s=this.setGraphicElevationContext(i,new Mc);return this._createAs3DShape(i,t.renderingInfo,r,s,i.uid)}layerOpacityChanged(t,i){const r=Pr(this.symbolLayer,"material","color"),s=this._getCombinedOpacity(r),n=s<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:s,transparent:n}),this._bottomMaterial.setParameters({opacity:s,transparent:n});const o=this._getLayerOpacity();return t.forEach(a=>{const l=i(a);_(l)&&l.layerOpacityChanged(o,this._context.isAsync)}),!0}layerElevationInfoChanged(t,i){return this.updateGraphics3DGraphicElevationInfo(t,i,$0)}slicePlaneEnabledChanged(t,i){return this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),t.forEach(r=>{const s=i(r);_(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}_getExtrusionSize(t){let i;var r;return t.size&&this._drivenProperties.size?i=(r=LYe(t.size,2))!=null?r:0:i=this._getSymbolSize(),i/=this._context.renderCoordsHelper.unitInMeters,i}applyRendererDiff(t,i){return this._drivenPropertiesChanged(i)?Es.Recreate_Symbol:Es.Recreate_Graphics}_getSymbolSize(){var t;return(t=this.symbolLayer.size)!=null?t:1}_createAs3DShape(t,i,r,s,n){const o=NR(t.geometry);if(R(o))return null;const a=LW(o,this._context.elevationProvider,this._context.renderCoordsHelper,s);if(this._logGeometryCreationWarnings(a,o.rings,"rings","ExtrudeSymbol3DLayer"),o.rings.length===0||!o.rings.some(te=>te.length>0))return null;const l=yW(o);if(R(l))return null;const c=new Array,h=new Array,p=new Array,f=cs(),g=Te(),y=M(),v=this._context.renderCoordsHelper.viewingMode===Ie.Global;v||this._context.renderCoordsHelper.worldUpAtPosition(null,y),Kh(o.spatialReference,[l.x,l.y,0],g,this._context.renderCoordsHelper.spatialReference);const b=Te();fr(b,g);const w=wr();cS(w,b);const{polygons:S,mapPosition:T,position:A}=a,C=A.length/3,O=new Float64Array(3*C*6),L=new Float64Array(3*C*6),U=new Float64Array(3*C*6),N=new Float64Array(1*C*6);let z=0;for(let te=0;te<S.length;++te){const ie=S[te],$=ie.count;if(this._context.clippingExtent&&(ki(f),uc(f,ie.mapPosition),!Uh(f,this._context.clippingExtent)))continue;const F=ES(ie.mapPosition,ie.holeIndices,3);if(F.length===0)continue;const k=3*$*2+F.length,G=new Uint32Array(k),W=new Uint32Array(F.length),K=6*$,H=3*O.BYTES_PER_ELEMENT,ee=new Xr(O.buffer,z*H,H,(z+K)*H),ye=3*L.BYTES_PER_ELEMENT,Ae=new Xr(L.buffer,z*ye,ye,(z+K)*ye),Ve=new Float64Array(U.buffer,3*z*U.BYTES_PER_ELEMENT,3*K),Se=new Float64Array(N.buffer,1*z*N.BYTES_PER_ELEMENT,1*K),xe=this._getExtrusionSize(i);JQe(A,T,F,ie,ee.typedBuffer,Ve,Ae.typedBuffer,Se,0,G,W,xe,y,v),GO(ee,ee,b),Z1(Ae,Ae,w),z+=6*$;const Re=xie(G,G.length-W.length,{positions:ee.typedBuffer,elevation:Ve,normals:Ae.typedBuffer,heights:Se},r);c.push(Re),h.push(this._material),p.push(ls);const ze=xie(W,0,{positions:ee.typedBuffer,elevation:Ve,normals:Ae.typedBuffer,heights:Se},r);c.push(ze),h.push(this._bottomMaterial),p.push(ls)}if(c.length===0)return null;const V=new tg({geometries:c,materials:h,transformations:p,metadata:{layerUid:this._context.layer.uid,graphicUid:n,isElevationSource:!0}});V.transformation=g;const B=mve(this.symbolLayer,{opacity:this._getLayerOpacity()}),J=_(B)?{baseMaterial:this._material,edgeMaterials:[B],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,Q=new qp(this,V,c,null,null,tJe,s,J);return Q.alignedSampledElevation=a.sampledElevation,Q.needsElevationUpdates=$0(s.mode),Q}}function xie(e,t,i,r){const s=new Uint32Array(e.length),n=[[E.POSITION,{size:3,data:i.positions,exclusive:!0}],[E.NORMAL,{size:3,data:i.normals,exclusive:!0}],[E.COLOR,{size:4,data:r,exclusive:!0}],[E.SIZE,{size:1,data:i.heights,exclusive:!0}]],o=[[E.POSITION,e],[E.NORMAL,e],[E.COLOR,s]];return i.elevation&&(n.push([E.MAPPOS,{size:3,data:i.elevation}]),o.push([E.MAPPOS,e])),new lr(n,o,Aa.Triangle,t)}function JQe(e,t,i,r,s,n,o,a,l,c,h,p,f,g){const y=i.length/3;let v=0,b=2*r.count;KQe(e,t,r.index,r.count,i,0,y,s,n,o,a,l,c,h,b,p,f,g),l+=2*r.count,b=0,Tie(s,n,a,o,v,r.pathLengths[0],r.count,l,c,b,p),l+=4*r.pathLengths[0],b+=2*r.pathLengths[0],v+=r.pathLengths[0];for(let w=1;w<r.pathLengths.length;++w)Tie(s,n,a,o,v,r.pathLengths[w],r.count,l,c,b,p),l+=4*r.pathLengths[w],b+=2*r.pathLengths[w],v+=r.pathLengths[w]}function KQe(e,t,i,r,s,n,o,a,l,c,h,p,f,g,y,v,b,w){ne(Ko,b);const S=v>0?1:-1;let T=3*i,A=p,C=3*A,O=p+r,L=3*O;for(let z=0;z<r;++z)w&&(Ko[0]=e[T+0],Ko[1]=e[T+1],Ko[2]=e[T+2],be(Ko,Ko)),a[C+0]=e[T+0],a[C+1]=e[T+1],a[C+2]=e[T+2],l[C+0]=t[T+0],l[C+1]=t[T+1],l[C+2]=t[T+2],c[C+0]=-S*Ko[0],c[C+1]=-S*Ko[1],c[C+2]=-S*Ko[2],h[A]=0,a[L+0]=e[T+0]+v*Ko[0],a[L+1]=e[T+1]+v*Ko[1],a[L+2]=e[T+2]+v*Ko[2],l[L+0]=t[T+0],l[L+1]=t[T+1],l[L+2]=t[T+2],c[L+0]=S*Ko[0],c[L+1]=S*Ko[1],c[L+2]=S*Ko[2],h[O]=v,C+=3,L+=3,T+=3,A+=1,O+=1;T=3*n,C=0,L=3*y;const U=v<0?Oie:Rie,N=v<0?Rie:Oie;for(let z=0;z<o;++z)g[C+0]=s[T+U[0]],g[C+1]=s[T+U[1]],g[C+2]=s[T+U[2]],f[L+0]=s[T+N[0]]+r,f[L+1]=s[T+N[1]]+r,f[L+2]=s[T+N[2]]+r,C+=3,L+=3,T+=3}function G3(e,t,i,r,s,n,o){r[n]=r[o],o*=3,e[(n*=3)+0]=e[o+0],e[n+1]=e[o+1],e[n+2]=e[o+2],t[n+0]=t[o+0],t[n+1]=t[o+1],t[n+2]=t[o+2],i[n+0]=s[0],i[n+1]=s[1],i[n+2]=s[2]}const W2=M();function Tie(e,t,i,r,s,n,o,a,l,c,h){let p=s,f=s+1,g=s+o,y=s+o+1,v=a,b=a+1,w=a+2*n,S=a+2*n+1;h<0&&(p=s+o+1,y=s),c*=3;for(let T=0;T<n;++T)T===n-1&&(h>0?(f=s,y=s+o):(f=s,p=s+o)),eJe(e,p,f,g,W2),G3(e,t,r,i,W2,v,p),G3(e,t,r,i,W2,b,f),G3(e,t,r,i,W2,w,g),G3(e,t,r,i,W2,S,y),l[c++]=v,l[c++]=w,l[c++]=S,l[c++]=v,l[c++]=S,l[c++]=b,p++,f++,g++,y++,v+=2,b+=2,w+=2,S+=2}const Vk=M(),Sie=M(),Eie=M(),Aie=M(),Cie=M();function eJe(e,t,i,r,s){t*=3,i*=3,r*=3,oe(Vk,e[t++],e[t++],e[t++]),oe(Sie,e[i++],e[i++],e[i++]),oe(Eie,e[r++],e[r++],e[r++]),de(Aie,Sie,Vk),de(Cie,Eie,Vk),pt(s,Cie,Aie),be(s,s)}const Hb=M();function tJe(e,t,i,r){const s=e.stageObject,n=s.geometryRecords,o=n.length,a=t.mode!=="absolute-height";let l=0;const c=s.transformation,h=fr(Te(),c);for(let p=0;p<o;p+=2){const f=n[p].geometry,g=f.getMutableAttribute(E.POSITION).data,y=f.vertexAttributes.get(E.SIZE).data,v=f.vertexAttributes.get(E.MAPPOS).data,b=new Tme(v),w=g.length/3;let S=0,T=!1,A=0;const C=i.spatialReference;for(let O=0;O<w;O++){Hb[0]=g[S],Hb[1]=g[S+1],Hb[2]=g[S+2],Dm(b,i,t,r,j3),a&&(A+=j3.sampledElevation),hi.TESTS_DISABLE_OPTIMIZATIONS?(oe(Da,b.array[b.offset+0],b.array[b.offset+1],j3.z+y[S/3]),r.toRenderCoords(Da,C,Da),ke(Da,Da,h)):(oe(Da,g[S+0],g[S+1],g[S+2]),ke(Da,Da,c),r.setAltitude(Da,j3.z+y[S/3]),ke(Da,Da,h)),g[S]=Da[0],g[S+1]=Da[1],g[S+2]=Da[2];const L=iJe/r.unitInMeters;(Math.abs(Hb[0]-g[S])>=L||Math.abs(Hb[1]-g[S+1])>=L||Math.abs(Hb[2]-g[S+2])>=L)&&(T=!0),b.offset+=3,S+=3}T&&(f.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(n[p]),n[p+1].geometry.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(n[p+1])),l+=A/w}return l/o}const Da=M(),Ko=M(),j3=new VO,Rie=[0,2,1],Oie=[0,1,2],iJe=.01;function rJe(e,t,i,r,s){const n=e.referencesGeometry()&&s?sJe(t,r,s):t,o=e.repurposeFeature(n);try{return e.evaluate(me(I({},i),{$feature:o}))}catch(a){return he.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",a),null}}const Gk=new Map;function sJe(e,t,i){const{transform:r,hasZ:s,hasM:n}=i;Gk.has(t)||Gk.set(t,nJe(t));const o=Gk.get(t)(e.geometry,r,s,n);return me(I({},e),{geometry:o})}function nJe(e){const t={};switch(e){case"esriGeometryPoint":return(i,r,s,n)=>Y0e(r,t,i,s,n);case"esriGeometryPolygon":return(i,r,s,n)=>Z0e(r,t,i,s,n);case"esriGeometryPolyline":return(i,r,s,n)=>Q0e(r,t,i,s,n);case"esriGeometryMultipoint":return(i,r,s,n)=>X0e(r,t,i,s,n);default:return he.getLogger("esri.views.2d.support.arcadeOnDemand").error(new q("mapview-arcade",`Unable to handle geometryType: ${e}`)),i=>i}}const Vyt=1.2,oJe=c1,aJe=ap;class M4{constructor(t,i,r){this.graphics3DSymbolLayer=t,this.renderGeometries=i,this.boundingBox=r,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this._graphicsCoreOwner=null,this.isElevationSource=!1}initialize(t,i,r){this.stage=t,this._graphicsCoreOwner=r,this._overlayRenderer=this._graphicsCoreOwner.view.basemapTerrain.overlayManager.renderer}setVisibility(t){if(this.stage!=null&&this._visible!==t){if(this._visible=t,t&&!this._addedToStage)return this._addedToStage=!0,void this._overlayRenderer.addGeometries(this.renderGeometries,this._graphicsCoreOwner,Gt.Geometry.ADD);if(t||this._addedToStage){for(const i of this.renderGeometries)i.instanceParameters.visible=this._visible;this._overlayRenderer.updateGeometries(this.renderGeometries,this._graphicsCoreOwner,Gt.State.VISIBILITIES)}}}destroy(){this.stage&&this._addedToStage&&this._overlayRenderer.removeGeometries(this.renderGeometries,this._graphicsCoreOwner,Gt.Geometry.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(t=M()){return oe(t,0,0,0)}getBoundingBoxObjectSpace(t=cs()){return ki(t)}addObjectState(t,i){t===Im.Highlight&&(this.renderGeometries.forEach(r=>{const s=r.addHighlight();i.addRenderGeometry(r,s,this)}),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._graphicsCoreOwner))}removeObjectState(t){this.renderGeometries.forEach(i=>{t.removeRenderGeometry(i)})}removeRenderGeometryObjectState(t,i){t.removeHighlight(i),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._graphicsCoreOwner)}computeAttachmentOrigin(t){for(const i of this.renderGeometries)i.computeAttachmentOrigin(qb)&&(t.draped.origin[0]+=qb[0],t.draped.origin[1]+=qb[1],t.draped.num++)}async getProjectedBoundingBox(t,i,r,s,n){ki(n);for(let o=0;o<this.renderGeometries.length;o++){const a=this.renderGeometries[o];this._getRenderGeometryProjectedBoundingRect(a,t,Mie,r),YEe(n,Mie)}if(i){let o;Fh(n,qb);const a=vW(n,i);try{o=await i.service.queryElevation(qb[0],qb[1],s,a,"ground")}catch{}_(o)&&(n[2]=Math.min(n[2],o),n[5]=Math.max(n[5],o))}return n}_getRenderGeometryProjectedBoundingRect(t,i,r,s){if(this.boundingBox)GN(yd,this.boundingBox);else{const n=t.boundingSphere,o=n[3];yd[0]=n[0]-o,yd[1]=n[1]-o,yd[2]=n[2]-o,yd[3]=n[0]+o,yd[4]=n[1]+o,yd[5]=n[2]+o}return i(yd,0,2),this.calculateRelativeScreenBounds&&s.push({location:Fh(yd),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),ij(yd,r)}}const Mie=Dt(),yd=cs(),qb=M();class v_e{constructor(t,i,r,s=2048){this.text=t,this._alignment=i,this._parameters=r,this.maxSize=s,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._displayWidth=null,this._heightMetrics=null,this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${t}`,this._lines=t.split(/\r?\n/)}get displayWidth(){return Math.ceil(this._ensureTextWidth()+2*this.backgroundHorizontalPadding)}get displayHeight(){const t=this.lineSpacing*(this._lines.length-1),i=this.lineHeight;return Math.ceil(t+i+2*this.haloSize+this.backgroundTopPadding+this.backgroundBottomPadding)}get renderedWidth(){return Math.ceil(this._toRenderUnit(this.displayWidth))}get renderedHeight(){return Math.ceil(this._toRenderUnit(this.displayHeight))}get firstRenderedBaselinePosition(){return this._toRenderUnit(this.firstLineYOffset+this.baselinePosition)}get firstLineYOffset(){return this.backgroundTopPadding+this.haloSize}get heightMetrics(){return this._ensureHeightMetrics()}get lineSpacing(){return(this.lineHeight+this.linePadding)*this._parameters.definition.lineSpacingFactor}get lineHeight(){return this.heightMetrics.lineHeight}get linePadding(){return this.lineHeight*lJe}get baselinePosition(){return this.heightMetrics.baselinePosition}get renderedFontSize(){return this._toRenderUnit(this.fontSize)}get fontSize(){return this._parameters.definition.size}get renderedHaloSize(){return this._toRenderUnit(this.haloSize)}get haloSize(){return this._parameters.haloSize}get backgroundHorizontalPadding(){return this.hasBackground?this._parameters.definition.background.padding[0]:0}get backgroundVerticalPadding(){return this.hasBackground?this._parameters.definition.background.padding[1]:0}get backgroundTopPadding(){return Math.max(0,this.backgroundVerticalPadding-this.heightMetrics.paddingTop)}get backgroundBottomPadding(){return Math.max(0,this.backgroundVerticalPadding-this.heightMetrics.paddingBottom)}get hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(R(this._renderPixelRatio)){const t=this._parameters.definition.pixelRatio;this.maxSize>0?this._renderPixelRatio=Math.min(t,Math.min(this.maxSize/this.displayWidth,this.maxSize/this.displayHeight)):this._renderPixelRatio=t}return this._renderPixelRatio}_getLineXOffset(t){switch(this._alignment){case d0.Left:return this.backgroundHorizontalPadding;case d0.Center:return(this.displayWidth-this._lineWidths[t])/2;case d0.Right:return this.displayWidth-this.backgroundHorizontalPadding-this._lineWidths[t]}}render(t,i=0,r=0){t.save();const s=i/=this.renderPixelRatio,n=r/=this.renderPixelRatio,o=this.haloSize,a=this.firstLineYOffset;i+=o,r+=a+this.baselinePosition;const l=this.haloSize>0;l&&this._renderHalo(t,s,n,o,a),this._setFontProperties(t,this.renderedFontSize);for(let c=0;c<this._lines.length;++c){const h=this._lines[c],p=this._getLineXOffset(c);l&&(t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)",this._fillText(t,h,i+p,r),this._renderLineDecoration(t,i+p,r,this._textWidths[c])),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.textStyle,this._fillText(t,h,i+this._getLineXOffset(c),r),this._renderLineDecoration(t,i+p,r,this._textWidths[c]),r+=this.lineSpacing}if(hi.TEXT_SHOW_BASELINE){t.strokeStyle=Pie,t.setLineDash([2,2]),t.lineWidth=1;let c=n+a;for(let h=0;h<this._lines.length;++h){const p=c+this.baselinePosition;this._drawLine(t,[s,p],[s+this.displayWidth,p]),c+=this.lineSpacing}}if(hi.TEXT_SHOW_BORDER&&(t.strokeStyle=Pie,t.setLineDash([]),t.lineWidth=1,this._drawBox(t,[s,n],[this.displayWidth,this.displayHeight])),this.hasBackground){const c=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(t,s,n,c),t.globalCompositeOperation="destination-over",t.fillStyle=this._parameters.backgroundStyle,t.fill()}t.restore()}_renderLineDecoration(t,i,r,s,n=!1){if(this._parameters.definition.font.decoration==="none"||s===0)return;const o=1,a=Math.max(this._parameters.definition.size/16,o);switch(this._parameters.definition.font.decoration){case"underline":r+=2*a;break;case"line-through":r-=.33*this.baselinePosition}const l=n?this.haloSize:0;t.strokeStyle=n?this._parameters.haloStyle:this._parameters.textStyle,t.lineWidth=this._toRenderUnit(a+2*l),t.beginPath(),t.moveTo(this._toRenderUnit(i-l),this._toRenderUnit(r)),t.lineTo(this._toRenderUnit(i+s+l),this._toRenderUnit(r)),t.stroke()}_roundedRect(t,i,r,s){i=this._toRenderUnit(i),r=this._toRenderUnit(r);const n=this.renderedWidth,o=this.renderedHeight;s!==0?(s=Be(s,0,Math.floor(o/2)),t.beginPath(),t.moveTo(i,r+s),t.arcTo(i,r,i+s,r,s),t.lineTo(i+n-s,r),t.arcTo(i+n,r,i+n,r+s,s),t.lineTo(i+n,r+o-s),t.arcTo(i+n,r+o,i+n-s,r+o,s),t.lineTo(i+s,r+o),t.arcTo(i,r+o,i,r+o-s,s),t.closePath()):t.rect(i,r,n,o)}_renderHalo(t,i,r,s,n){const o=this.renderedWidth,a=this.renderedHeight,l=S$(jk,Math.max(o,Wb),Math.max(a,Wb)),c=l.getContext("2d");c.clearRect(0,0,o,a),this._setFontProperties(c,this.renderedFontSize),c.fillStyle=this._parameters.haloStyle,c.strokeStyle=this._parameters.haloStyle;const h=this.renderedHaloSize<3;c.lineJoin=h?"miter":"round",h?this._renderHaloEmulated(c,s,n):this._renderHaloNative(c,s,n);let p=n+this.baselinePosition;for(let f=0;f<this._lines.length;++f){const g=this._getLineXOffset(f);this._renderLineDecoration(c,s+g,p,this._textWidths[f],!0),p+=this.lineSpacing}t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(l,0,0,o,a,this._toRenderUnit(i),this._toRenderUnit(r),o,a),t.globalAlpha=1}_renderHaloEmulated(t,i,r){r+=this.baselinePosition;for(let s=0;s<this._lines.length;++s){const n=this._lines[s],o=this._getLineXOffset(s);for(const[a,l]of __e)this._fillText(t,n,i+o+this.haloSize*a,r+this.haloSize*l);r+=this.lineSpacing}}_renderHaloNative(t,i,r){const s=2*this.haloSize;r+=this.baselinePosition;for(let n=0;n<this._lines.length;++n){const o=this._lines[n],a=this._getLineXOffset(n),l=5,c=.1;for(let h=0;h<l;h++){const p=1-(l-1)*c+h*c;t.lineWidth=this._toRenderUnit(p*s),this._strokeText(t,o,i+a,r)}r+=this.lineSpacing}}_setFontProperties(t,i){t.font=this._parameters.fontString(i),t.textAlign="left",t.textBaseline="alphabetic"}_ensureTextWidth(){if(_(this._displayWidth))return this._displayWidth;const t=S$(jk,Wb,Wb).getContext("2d");this._setFontProperties(t,this.fontSize);let i=2*this.haloSize;const r=this._parameters.definition.font;r.style!=="italic"&&r.style!=="oblique"&&r.weight!=="bold"&&r.weight!=="bolder"||(i+=.3*t.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let s=0;for(const n of this._lines){const o=t.measureText(n).width,a=o+i;this._textWidths.push(o),this._lineWidths.push(a),s=Math.max(s,a)}return this._displayWidth=s,this._displayWidth}_ensureHeightMetrics(){if(R(this._heightMetrics)){const t=S$(jk,Wb,Wb).getContext("2d");this._setFontProperties(t,this.fontSize);const i=t.measureText(this.text+cJe),r=this.hasBackground?t.measureText(this._lines[0]):i,s=this._lines.length===1?r:this.hasBackground?t.measureText(this._lines[this._lines.length-1]):i,n=i.actualBoundingBoxAscent+i.actualBoundingBoxDescent;this._heightMetrics={paddingTop:i.actualBoundingBoxAscent-r.actualBoundingBoxAscent,paddingBottom:i.actualBoundingBoxDescent-s.actualBoundingBoxDescent,lineHeight:n,baselinePosition:i.actualBoundingBoxAscent}}return this._heightMetrics}_toRenderUnit(t){return t*this.renderPixelRatio}_toRoundedRenderUnit(t){return Math.round(t*this.renderPixelRatio)}_fillText(t,i,r,s){t.fillText(i,this._toRenderUnit(r),this._toRenderUnit(s))}_strokeText(t,i,r,s){t.strokeText(i,this._toRenderUnit(r),this._toRenderUnit(s))}_drawLine(t,i,r){t.beginPath(),t.moveTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),t.lineTo(this._toRoundedRenderUnit(r[0])+.5,this._toRoundedRenderUnit(r[1])+.5),t.stroke()}_drawBox(t,i,r){const s=this._toRenderUnit(i[0]),n=this._toRenderUnit(i[1]),o=this._toRenderUnit(r[0]),a=this._toRenderUnit(r[1]),l=Math.floor(s)+.5,c=Math.ceil(s+o)-.5,h=Math.floor(n)+.5,p=Math.ceil(n+a)-.5;t.beginPath(),t.moveTo(l,h),t.lineTo(c,h),t.lineTo(c,p),t.lineTo(l,p),t.lineTo(l,h),t.stroke()}}const __e=[];for(let t=0;t<360;t+=360/16)__e.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)]);var d0;function S$(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}(function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"})(d0||(d0={}));const jk={canvas:null},lJe=.2,Wb=512,Pie="rgb(255, 0, 255, 0.5)",cJe=(()=>{let e="";for(let t=32;t<127;t++)e+=String.fromCharCode(t);return e})(),uJe={left:0,center:.5,right:1},E$={"bottom-left":vi(0,0),bottom:vi(.5,0),"bottom-right":vi(1,0),left:vi(0,.5),center:vi(.5,.5),right:vi(1,.5),"top-left":vi(0,1),top:vi(.5,1),"top-right":vi(1,1)};function b_e(e){switch(e){case"left":return d0.Left;case"right":return d0.Right;default:return d0.Center}}function Iie(e){switch(e){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}function hJe(e){switch(e){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}function dJe(e,t){switch(t){case"bottom":return e==="left"?"bottom-left":e==="right"?"bottom-right":"bottom";case"center":return e;case"top":return e==="left"?"top-left":e==="right"?"top-right":"top"}}function pJe(e){return e==="justify"?"center":e}function fJe(e){return e==="middle"?"center":e}var ho,$ie,QL;function X2(e){return e!=null}function Xb(e){return typeof e=="number"}function P4(e){return typeof e=="string"}function mJe(e){return e==null||P4(e)}function xs(e,t){e&&e.push(t)}function gJe(e,t,i,r=Te()){const s=e||0,n=t||0,o=i||0;return s!==0&&GT(r,r,-s/180*Math.PI),n!==0&&VT(r,r,n/180*Math.PI),o!==0&&iF(r,r,o/180*Math.PI),r}function _g(e,t,i,r,s){const n=e.minSize,o=e.maxSize;if(e.expression)return xs(s,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue){const a=r.symbolSize[i];return t.minSize[i]=a,t.maxSize[i]=a,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=ho.DefinedSize,!0}if(X2(e.field))return X2(e.stops)?e.stops.length===2&&Xb(e.stops[0].size)&&Xb(e.stops[1].size)?(Die(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,i),t.type[i]=ho.DefinedSize,!0):(xs(s,"Could not convert size info: stops only supported with 2 elements"),!1):Xb(n)&&Xb(o)&&X2(e.minDataValue)&&X2(e.maxDataValue)?(Die(n,o,e.minDataValue,e.maxDataValue,t,i),t.type[i]=ho.DefinedSize,!0):KT[e.valueUnit]!=null?(t.minSize[i]=-1/0,t.maxSize[i]=1/0,t.offset[i]=0,t.factor[i]=1/KT[e.valueUnit],t.type[i]=ho.DefinedSize,!0):e.valueUnit==="unknown"?(xs(s,"Could not convert size info: proportional size not supported"),!1):(xs(s,"Could not convert size info: scale-dependent size not supported"),!1);if(!X2(e.field)){if(e.stops&&e.stops[0]&&Xb(e.stops[0].size))return t.minSize[i]=e.stops[0].size,t.maxSize[i]=e.stops[0].size,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=ho.DefinedSize,!0;if(Xb(n))return t.minSize[i]=n,t.maxSize[i]=n,t.offset[i]=n,t.factor[i]=0,t.type[i]=ho.DefinedSize,!0}return xs(s,"Could not convert size info: unsupported variant of sizeInfo"),!1}function Die(e,t,i,r,s,n){const o=Math.abs(r-i)>0?(t-e)/(r-i):0;s.minSize[n]=o>0?e:t,s.maxSize[n]=o>0?t:e,s.offset[n]=e-i*o,s.factor[n]=o}function yJe(e,t,i,r){if(e.normalizationField||e.valueRepresentation)return xs(r,"Could not convert size info: unsupported property"),null;if(!mJe(e.field))return xs(r,"Could not convert size info: field is not a string"),null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return xs(r,"Could not convert size info: multiple fields in use"),null}else t.size.field=e.field}else t.size={field:e.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[ho.Undefined,ho.Undefined,ho.Undefined]};let s;switch(e.axis){case"width":return s=_g(e,t.size,0,i,r),s?t:null;case"height":return s=_g(e,t.size,2,i,r),s?t:null;case"depth":return s=_g(e,t.size,1,i,r),s?t:null;case"width-and-depth":return s=_g(e,t.size,0,i,r),s&&_g(e,t.size,1,i,r),s?t:null;case null:case void 0:case"all":return s=_g(e,t.size,0,i,r),s=s&&_g(e,t.size,1,i,r),s=s&&_g(e,t.size,2,i,r),s?t:null;default:return xs(r,`Could not convert size info: unknown axis "${e.axis}""`),null}}function vJe(e,t,i){for(let s=0;s<3;++s){let n=t.unitInMeters;e.type[s]===ho.DefinedSize&&(n*=t.modelSize[s],e.type[s]=ho.DefinedScale),e.minSize[s]=e.minSize[s]/n,e.maxSize[s]=e.maxSize[s]/n,e.offset[s]=e.offset[s]/n,e.factor[s]=e.factor[s]/n}let r;if(e.type[0]!==ho.Undefined)r=0;else if(e.type[1]!==ho.Undefined)r=1;else{if(e.type[2]===ho.Undefined)return xs(i,"No size axis contains a valid size or scale"),!1;r=2}for(let s=0;s<3;++s)e.type[s]===ho.Undefined&&(e.minSize[s]=e.minSize[r],e.maxSize[s]=e.maxSize[r],e.offset[s]=e.offset[r],e.factor[s]=e.factor[r],e.type[s]=e.type[r]);return!0}function Lie(e,t,i){e[4*t+0]=i.r/255,e[4*t+1]=i.g/255,e[4*t+2]=i.b/255,e[4*t+3]=i.a}function _Je(e,t,i){if(e.normalizationField)return xs(i,"Could not convert color info: unsupported property"),null;if(P4(e.field)){if(!e.stops)return xs(i,"Could not convert color info: missing stops or colors"),null;{if(e.stops.length>8)return xs(i,"Could not convert color info: too many color stops"),null;t.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const r=e.stops;for(let s=0;s<8;++s){const n=r[Math.min(s,r.length-1)];t.color.values[s]=n.value,Lie(t.color.colors,s,n.color)}}}else{if(!(e.stops&&e.stops.length>=0))return xs(i,"Could not convert color info: no field and no colors/stops"),null;{const r=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)t.color.values[s]=1/0,Lie(t.color.colors,s,r)}}return t}function bJe(e,t,i){if(e.normalizationField)return xs(i,"Could not convert opacity info: unsupported property"),null;if(P4(e.field)){if(!e.stops)return xs(i,"Could not convert opacity info: missing stops or opacities"),null;{if(e.stops.length>8)return xs(i,"Could not convert opacity info: too many opacity stops"),null;t.opacity={field:e.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const r=e.stops;for(let s=0;s<8;++s){const n=r[Math.min(s,r.length-1)];t.opacity.values[s]=n.value,t.opacity.opacityValues[s]=n.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return xs(i,"Could not convert opacity info: no field and no opacities/stops"),null;{const r=e.stops&&e.stops.length>=0&&e.stops[0].opacity;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)t.opacity.values[s]=1/0,t.opacity.opacityValues[s]=r}}return t}function Hk(e,t,i){const r=i===2&&e.rotationType==="arithmetic";t.offset[i]=r?90:0,t.factor[i]=r?-1:1,t.type[i]=1}function wJe(e,t,i){if(!P4(e.field))return xs(i,"Could not convert rotation info: field is not a string"),null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return xs(i,"Could not convert rotation info: multiple fields in use"),null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return Hk(e,t.rotation,0),t;case"roll":return Hk(e,t.rotation,1),t;case null:case void 0:case"heading":return Hk(e,t.rotation,2),t;default:return xs(i,`Could not convert rotation info: unknown axis "${e.axis}""`),null}}function w_e(e,t,i){if(!e)return null;const r=!t.supportedTypes||!!t.supportedTypes.size,s=!t.supportedTypes||!!t.supportedTypes.color,n=!t.supportedTypes||!!t.supportedTypes.rotation,o=!!t.supportedTypes&&!!t.supportedTypes.opacity,a=e.reduce((l,c)=>{if(!l)return l;if(c.valueExpression)return xs(i,"Could not convert visual variables: arcade expressions not supported"),null;switch(c.type){case"size":return r?yJe(c,l,t,i):l;case"color":return s?_Je(c,l,i):l;case"opacity":return o?bJe(c,l,i):null;case"rotation":return n?wJe(c,l,i):l;default:return null}},{size:null,color:null,opacity:null,rotation:null});return!(e.length>0&&a)||a.size||a.color||a.opacity||a.rotation?a&&a.size&&!vJe(a.size,t,i)?null:a:null}function FW(e){return e&&e.size!=null}function UR(e,t){if(!e)return{enabled:!1};if(hi.TESTS_DISABLE_FAST_UPDATES)return{enabled:!1};const i=w_e(e.visualVariables,t);return i?{enabled:!0,visualVariables:i,materialParameters:x_e(i,t),requiresShaderTransformation:FW(i)}:{enabled:!1}}function kR(e,t,i){if(!t||!e.enabled)return!1;const r=e.visualVariables,s=w_e(t.visualVariables,i);return!!s&&!!(H3(r.size,s.size,"size")&&H3(r.color,s.color,"color")&&H3(r.rotation,s.rotation,"rotation")&&H3(r.opacity,s.opacity,"opacity"))&&(e.visualVariables=s,e.materialParameters=x_e(s,i),e.requiresShaderTransformation=FW(s),!0)}function H3(e,t,i){if(!!e!=!!t||e&&e.field!==t.field)return!1;if(e&&i==="rotation"){const r=e,s=t;for(let n=0;n<3;n++)if(r.type[n]!==s.type[n]||r.offset[n]!==s.offset[n]||r.factor[n]!==s.factor[n])return!1}return!0}function x_e(e,t){const i={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},r=FW(e);return e&&e.size?(i.vvSizeEnabled=!0,i.vvSizeMinSize=e.size.minSize,i.vvSizeMaxSize=e.size.maxSize,i.vvSizeOffset=e.size.offset,i.vvSizeFactor=e.size.factor):e&&r&&(i.vvSizeValue=t.transformation.scale),e&&r&&(i.vvSymbolAnchor=t.transformation.anchor,i.vvSymbolRotationMatrix=wr(),Ap(_C),gJe(t.transformation.rotation[2],t.transformation.rotation[0],t.transformation.rotation[1],_C),Lu(i.vvSymbolRotationMatrix,_C)),e&&e.color&&(i.vvColorEnabled=!0,i.vvColorValues=e.color.values,i.vvColorColors=e.color.colors),e&&e.opacity&&(i.vvOpacityEnabled=!0,i.vvOpacityValues=e.opacity.values,i.vvOpacityOpacities=e.opacity.opacityValues),i}(function(e){e[e.Undefined=0]="Undefined",e[e.DefinedSize=1]="DefinedSize",e[e.DefinedScale=2]="DefinedScale"})(ho||(ho={})),function(e){e[e.Undefined=0]="Undefined",e[e.DefinedAngle=1]="DefinedAngle"}($ie||($ie={})),function(e){const t=Te(),i=M();function r(n,o,a){if(!n.vvSizeEnabled)return a;Ur(t,a);const l=n.vvSymbolRotationMatrix;kp(_C,l[0],l[1],l[2],0,l[3],l[4],l[5],0,l[6],l[7],l[8],0,0,0,0,1),dr(t,t,_C);for(let c=0;c<3;++c){const h=n.vvSizeOffset[c]+o[0]*n.vvSizeFactor[c];i[c]=Be(h,n.vvSizeMinSize[c],n.vvSizeMaxSize[c])}return tF(t,t,i),Wo(t,t,n.vvSymbolAnchor),t}function s(n,o,a){if(!o.vvSizeEnabled)return oe(n,1,1,1);for(let l=0;l<3;++l){const c=o.vvSizeOffset[l]+a[0]*o.vvSizeFactor[l];n[l]=Be(c,o.vvSizeMinSize[l],o.vvSizeMaxSize[l])}return n}e.evaluateModelTransform=r,e.evaluateModelTransformScale=s}(QL||(QL={}));const _C=Te(),sG=QL.evaluateModelTransform,xJe=QL.evaluateModelTransformScale;class TJe{constructor(){this.visible=!0}}class CS{constructor(t,i,r={}){this.data=t,this.material=i,this.boundingSphere=ni(),this.instanceParameters=new TJe,this._transformation=Te(),this._shaderTransformationDirty=!0,this.layerUid=gt(r.layerUid,null),this.graphicUid=gt(r.graphicUid,null),this.id=r.id?r.id:Ta(),this.boundingInfo=gt(r.boundingInfo,null),this.calculateShaderTransformation=gt(this.calculateShaderTransformation,null),this.castShadow=!!r.castShadow&&r.castShadow}get transformation(){return this._transformation}updateTransformation(t){t(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}shaderTransformationChanged(){this._shaderTransformationDirty=!0}computeBoundingSphere(t,i,r=w1(t)){R(this.boundingInfo)||(ke(i,this.boundingInfo.getCenter(),t),i[3]=this.boundingInfo.getBSRadius()*r)}get hasShaderTransformation(){return _(this.calculateShaderTransformation)}get primitiveType(){return this.data.primitiveType}getShaderTransformation(){return R(this.calculateShaderTransformation)?gt(this.transformation,ls):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=Te()),Ur(this._shaderTransformation,this.calculateShaderTransformation(gt(this.transformation,ls))),this._shaderTransformationDirty=!1),this._shaderTransformation)}computeAttachmentOrigin(t){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,t)&&(_(this._transformation)&&ke(t,t,this._transformation),!0);const i=this.indices.get(E.POSITION),r=this.vertexAttributes.get(E.POSITION);return!!Qge(r,i,t)&&(_(this._transformation)&&ke(t,t,this._transformation),!0)}get indices(){return this.data.indices}get vertexAttributes(){return this.data.vertexAttributes}addHighlight(){const t=new jL(Im.Highlight),i=this.instanceParameters;return i.highlights=N9(i.highlights,t),t}removeHighlight(t){const i=this.instanceParameters;i.highlights=F9(i.highlights,t)}}const SJe=Te(),Nie=je(0,0,1),EJe=16,AJe=1.5,e1=dW,CJe=[e1/2,e1/2,1-e1/2,1-e1/2],RJe=[PR*e1,PR*e1];class zR extends Wp{constructor(t,i,r,s){super(t,i,r,s),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}getCachedSize(){return{size:this._getIconSize()}}async doLoad(t){this._validateOrThrow();const i=this._prepareMaterialParameters(),r=this._getPrimitive();if(_(r))this._prepareResourcesPrimitive(i,r);else{const s=s6e(this.symbol,this.symbolLayer),n=WN(s);n&&n.mediaType==="application/json"?await this._prepareResourcesCIM(i,JSON.parse(n.data),t):await this._prepareResourcesHref(i,s,t)}}_validateOrThrow(){if(this._drivenProperties.size)return;const t=h4(this._getIconSize());if(t)throw new q("graphics3diconsymbollayer:invalid-size",t)}_getIconSize(){const t=this.symbolLayer,i=Math.round(t.size!=null?fo(t.size):EJe);return this._drivenProperties.size?Math.max(i,64):i}_generateTextureCIM(t){const i=this._getGraphicHash(t);let r=i===""?null:this._cimSymbolTextures.get(i);if(!r){const s={scaleFactor:this._cimScaleFactorOrFunction},n=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,t,"esriGeometryPoint",s,null,null);this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",n.anchorPosition);const o={width:n.imageData.width,height:n.imageData.height,powerOfTwoResizeMode:l0.PAD};r=new rs(n.imageData,o),this._cimSymbolTextures.set(i,r),this._context.stage.add(r)}return r}_computeSize(t,i){const r=t.width/t.height;return r>1?[i,Math.round(i/r)]:[Math.round(i*r),i]}_prepareMaterialParameters(){const t={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},i=this.symbol;if(OJe(i)){const{screenLength:r,minWorldLength:s,maxWorldLength:n}=i.verticalOffset;t.verticalOffset={screenLength:fo(r),minWorldLength:s||0,maxWorldLength:n!=null?n:1/0}}return this._context.screenSizePerspectiveEnabled&&(t.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),t.occlusionTest=!0,t.slicePlaneEnabled=this._context.slicePlaneEnabled,t}_prepareResourcesPrimitive(t,i){const r=this._getOutlineSize();if(qk(i)&&r===0)throw new Error("Nothing to render");this._outlineSize=r,t.color=this._getFillColor(),t.outlineColor=this._getOutlineColor(),t.outlineSize=this._outlineSize;const s=this._context.sharedResources.textures.fromData(i,()=>O0e(i));this._texture=s.texture,this._releaseTexture=s,t.textureIsSignedDistanceField=!0,t.distanceFieldBoundingBox=CJe,t.textureId=this._texture.id;const n=this._getIconSize();this._size=[n,n],this._symbolTextureRatio=1/e1,this._createMaterialAndAddToStage(t,this._context.stage)}async _prepareResourcesHref(t,i,r){if(!ue("esri-canvas-svg-support")&&uj(i))throw new q("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)");this._outlineSize=this._getOutlineSize(),t.color=this._getFillColor(),t.outlineColor=this._getOutlineColor(),t.outlineSize=this._outlineSize,t.textureIsSignedDistanceField=!1;const s=this._getIconSize(),n=s*this._context.graphicsCoreOwner.view.pixelRatio,o=await wl(this._context.sharedResources.textures.fromUrl(i,n,{signal:r}));if(o.ok===!1)throw zm(o.error),new q("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${i})`);this._releaseTexture=o.value;const a=o.value.texture,l=a.params;this._size=this._computeSize(l,s),t.textureId=a.id,this._createMaterialAndAddToStage(t,this._context.stage)}async _prepareResourcesCIM(t,i,r){const s=new $S({data:i});if(!this._context.sharedResources.cimSymbolRasterizer){const h=(await import("./CIMSymbolRasterizer.0b5bd356.js")).CIMSymbolRasterizer;Qt(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new h(this._context.renderCoordsHelper.spatialReference,!0))}const n=this._context.layer.fields?this._context.layer.fields.map(h=>h.toJSON()):null;let o,a;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(s,n,this._context.renderer&&this._context.renderer.type==="dictionary"?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r}),this._context.renderer&&this._context.renderer.type==="dictionary"&&this._context.renderer.scaleExpression){const h=this._context.renderer;if(isNaN(h.scaleExpression)){const p=h.scaleExpression,f=await k2e(p,this._context.layer.spatialReference,n);a=(g,y,v)=>{const b=rJe(f,g,{$view:v},"esriGeometryPoint",y);return b!==null?b:1}}else o=Number(h.scaleExpression)}this._cimScaleFactorOrFunction=o||a||1;const l=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];Qt(r);const c=this._context.layer.fieldsIndex;this._cimRequiredFields=l.map(h=>c.get(h).name),this._cimMaterialParametersInfo=t,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||QAe}_getOutlineSize(){let t=0;const i=this.symbolLayer;return _(i.outline)&&i.outline.size!=null?Math.max(fo(i.outline.size),0):(t=qk(this._getPrimitive())?AJe:0,Math.max(t,0))}_getOutlineColor(){const t=this._getLayerOpacity(),i=this.symbolLayer,r=Pr(i,"outline","color");if(_(r)){const s=Je.toUnitRGB(r),n=r.a*t;return[s[0],s[1],s[2],n]}return[0,0,0,0]}_getFillColor(){if(qk(this._getPrimitive()))return oJe;const t=R(this._getPrimitive()),i=Pr(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(i,{hasIntrinsicColor:t})}_getAnchorPos(t,i){return t==="relative"?vi((i.x||0)+.5,.5-(i.y||0)):t in E$?E$[t]:E$.center}_createMaterialAndAddToStage(t,i){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=UR(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(t,this._fastUpdates.materialParameters),this._cimLayers){let r=this._cimSymbolMaterials.get(t.textureId);return r||(r=new TS(t),this._cimSymbolMaterials.set(t.textureId,r),i.add(r)),r}return this._material=new TS(t),i.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(t=>{t.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0,isDraped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial(t=>this._context.stage.remove(t)),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(t=>this._context.stage.remove(t)),this._cimSymbolTextures.clear(),this._releaseTexture=Xi(this._releaseTexture)}_getScaleFactor(t,i){if(this._drivenProperties.size&&t.size){for(let r=0;r<3;r++){const s=t.size[r];s&&s!=="symbol-value"&&s!=="proportional"&&(t.size[r]=fo(s))}if(t.size[0]==="symbol-value")return 1;if(isFinite(+t.size[0]))return+t.size[0]/i;if(isFinite(+t.size[2]))return+t.size[2]/i}return 1}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry))return null;let r,s;if(this._cimLayers){if(!this._cimLayers.length)return null;const p=this._generateTextureCIM(i),f=I({textureId:p.id},this._cimMaterialParametersInfo);s=this._createMaterialAndAddToStage(f,this._context.stage),r=[p.params.width,p.params.height]}else r=this._size,s=this._material;const n=DR(i.geometry);if(R(n))return this.logger.warn(`unsupported geometry type for icon symbol: ${i.geometry.type}`),null;const o=t.renderingInfo,a=this._getVertexOpacityAndColor(o);let l=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const p=r[0]>r[1]?r[0]:r[1];l=this._getScaleFactor(o,p)}l*=this._symbolTextureRatio;const c=[r[0]*l,r[1]*l],h=this.setGraphicElevationContext(i,new Mc);return this.ensureDrapedStatus(h.mode==="on-the-ground")&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(i,n,s,a,c,t.layer.uid):this._createAs3DShape(i,n,s,a,c,h,i.uid)}layerOpacityChanged(){const t=this._getFillColor(),i=this._getOutlineColor();return this._forEachMaterial(r=>{r.setParameters({color:t}),r.setParameters({outlineColor:i})}),!0}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=BO(zR.elevationModeChangeTypes,r,s);if(n!==_r.UPDATE)return n;const o=zu(s)||s==="absolute-height";return this.updateGraphics3DGraphicElevationInfo(t,i,()=>o)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(t=>{t.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}applyRendererDiff(t,i){for(const r in t.diff){if(r!=="visualVariables"||!kR(this._fastUpdates,i,this._fastVisualVariableConvertOptions()))return Es.Recreate_Symbol;_(this._material)&&this._material.setParameters(this._fastUpdates.materialParameters)}return Es.Fast_Update}_defaultElevationInfoNoZ(){return MJe}_createAs3DShape(t,i,r,s,n,o,a){const l=this.getFastUpdateAttrValues(t),c=l?g=>sG(this._fastUpdates.materialParameters,l,g):null,h=[Qa.createPointGeometry(Nie,null,s,n,PJe,null,l)],p=EW(this._context,i,h,[r],o,this._context.layer.uid,a,c);if(p===null)return null;const f=new qp(this,p.object,h,null,null,IR,o);return f.alignedSampledElevation=p.sampledElevation,f.needsElevationUpdates=zu(o.mode)||o.mode==="absolute-height",f.getScreenSize=this._createScreenSizeGetter(n,c),f.calculateRelativeScreenBounds=g=>r.calculateRelativeScreenBounds(f.getScreenSize(),1,g),$R(f,i,this._context.elevationProvider),f}_createAsOverlay(t,i,r,s,n,o){r.renderPriority=this._renderPriority;const a=ni();tn(i,a,this._context.overlaySR),a[2]=DW;const l=this._context.clippingExtent;if(_(l)&&!tj(l,a))return null;const c=this.getFastUpdateAttrValues(t),h=c?y=>sG(this._fastUpdates.materialParameters,c,y):null,p=Qa.createPointGeometry(Nie,a,s,n,null,null,c),f=new CS(p,r,{layerUid:o,graphicUid:t.uid,calculateShaderTransformation:h});a[3]=0,_a(f.boundingSphere,a);const g=new M4(this,[f],null);return g.getScreenSize=this._createScreenSizeGetter(n,h),g.calculateRelativeScreenBounds=y=>r.calculateRelativeScreenBounds(g.getScreenSize(),1,y),g}_createScreenSizeGetter(t,i){const r=this._outlineSize+2;if(this._fastUpdates.enabled){const s=t[0]/this._symbolTextureRatio,n=t[1]/this._symbolTextureRatio;return(o=Ye())=>{const a=i(SJe);return o[0]=a[0]*s+r,o[1]=a[5]*n+r,o}}{const s=t[0]/this._symbolTextureRatio+r,n=t[1]/this._symbolTextureRatio+r;return(o=Ye())=>(o[0]=s,o[1]=n,o)}}_fastVisualVariableConvertOptions(){const t=this._size[0]>this._size[1]?this._size[0]:this._size[1],i=je(t,t,t),r=Qh(1),s=t*r;return{modelSize:i,symbolSize:je(s,s,s),unitInMeters:r,transformation:{anchor:pl,scale:up,rotation:pl}}}_getGraphicHash(t){let i="";for(const r of this._cimRequiredFields)i+=r+t.attributes[r];return i}_forEachMaterial(t){_(this._material)&&t(this._material),this._cimSymbolMaterials.forEach(t)}get test(){return{material:this._material}}}function OJe(e){return e&&e.type==="point-3d"&&e.hasVisibleVerticalOffset()}function qk(e){return!!_(e)&&(e==="cross"||e==="x")}zR.PRIMITIVE_SIZE=RJe,zR.elevationModeChangeTypes={definedChanged:_r.UPDATE,staysOnTheGround:_r.NONE,onTheGroundChanged:_r.RECREATE};const MJe={mode:"relative-to-ground",offset:0},PJe=yi(0,0,0,1);function nG(e){const t=[],i=[];DJe(e,i,t);const r=i[0][1].data,s=t[0][1].length,n=new Uint16Array(s);return LJe(e,i,t),NJe(e,i,t,n),UJe(e,i,t,n),FJe(e,i,t,n),kJe(e,i,t,n),zJe(e,i,t,n),BJe(e,i,t,r),new lr(i,t,Aa.Line)}function IJe(e,t,i,r){const s=e.type==="polygon"?Pp.CCW_IS_HOLE:Pp.NONE,n=e.type==="polygon"?e.rings:e.paths,{position:o,outlines:a}=jO(n,e.hasZ,s),l=new Float64Array(o.length),c=ave(o,e.spatialReference,0,l,0,o,0,o.length/3,t,i,r),h=c!=null;return{lines:h?T_e(a,o,l):[],projectionSuccess:h,sampledElevation:c}}function T_e(e,t,i){const r=new Array;for(const{index:s,count:n}of e){if(n<=1)continue;const o=3*s,a=o+3*n;r.push({position:t.subarray(o,a),mapPosition:i?i.subarray(o,a):void 0})}return r}function $Je(e,t){const i=e.type==="polygon"?Pp.CCW_IS_HOLE:Pp.NONE,r=e.type==="polygon"?e.rings:e.paths,{position:s,outlines:n}=jO(r,!1,i),o=br(s,e.spatialReference,0,s,t,0,s.length/3);for(let a=2;a<s.length;a+=3)s[a]=DW;return{lines:o?T_e(n,s):[],projectionSuccess:o}}function DJe(e,t,i){const{attributeData:{position:r},removeDuplicateStartEnd:s}=e,n=VJe(r)&&s===eb.REMOVE,o=r.length/3-(n?1:0),a=new Uint32Array(2*(o-1)),l=n?y7(r,0,r.length-3):r;let c=0;for(let h=0;h<o-1;h++)a[c++]=h,a[c++]=h+1;t.push([E.POSITION,{size:3,data:l,exclusive:n}]),i.push([E.POSITION,a])}function LJe(e,t,i){const r=e.attributeData.mapPosition;R(r)||(i.push([E.MAPPOS,i[0][1]]),t.push([E.MAPPOS,{size:3,data:r}]))}function NJe(e,t,i,r){if(_(e.attributeData.colorFeature))return;const s=e.attributeData.color;t.push([E.COLOR,{size:4,data:gt(s,aJe)}]),i.push([E.COLOR,r])}function FJe(e,t,i,r){const s=e.attributeData.colorFeature;R(s)||(t.push([E.COLORFEATUREATTRIBUTE,{size:1,data:new Float32Array([s])}]),i.push([E.COLOR,r]))}function UJe(e,t,i,r){if(_(e.attributeData.sizeFeature))return;const s=e.attributeData.size;t.push([E.SIZE,{size:1,data:[gt(s,1)]}]),i.push([E.SIZE,r])}function kJe(e,t,i,r){const s=e.attributeData.sizeFeature;R(s)||(t.push([E.SIZEFEATUREATTRIBUTE,{size:1,data:new Float32Array([s])}]),i.push([E.SIZEFEATUREATTRIBUTE,r]))}function zJe(e,t,i,r){const s=e.attributeData.opacityFeature;R(s)||(t.push([E.OPACITYFEATUREATTRIBUTE,{size:1,data:new Float32Array([s])}]),i.push([E.OPACITYFEATUREATTRIBUTE,r]))}function BJe(e,t,i,r){if(R(e.overlayInfo)||e.overlayInfo.renderCoordsHelper.viewingMode!==Ie.Global||!e.overlayInfo.spatialReference.isGeographic)return;const s=new Float64Array(r.length),n=di(e.overlayInfo.spatialReference);for(let f=0;f<s.length;f+=3)Pj(r,f,s,f,n);const o=r.length/3,a=new Float32Array(o+1);let l=GJe,c=jJe,h=0,p=0;oe(l,s[p++],s[p++],s[p++]),a[0]=0;for(let f=1;f<o+1;++f)f===o&&(p=0),oe(c,s[p++],s[p++],s[p++]),h+=oge(l,c),a[f]=h,[l,c]=[c,l];t.push([E.DISTANCETOSTART,{size:1,data:a}]),i.push([E.DISTANCETOSTART,i[0][1]])}function VJe(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}var eb;(function(e){e[e.KEEP=0]="KEEP",e[e.REMOVE=1]="REMOVE"})(eb||(eb={}));const GJe=M(),jJe=M();function oG(e){switch(e){case"butt":return qh.BUTT;case"square":return qh.SQUARE;case"round":return qh.ROUND;default:return null}}const JL=64,S_e=JL/2,E_e=S_e/5;function HJe(e,t){return _(t)?qJe(e,WJe(t.style)):null}function qJe(e,t){return e.fromData(t,()=>O0e(t,JL,S_e,E_e))}function WJe(e){return e==="diamond"?"kite":e}function XJe(e){const t=new Oi;return t.include(jve,e),e.output===j.Depth&&t.include(q0,e),t.fragment.include(nd),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("nearFar","vec2").add("pixelRatio","float").add("screenSize","vec2").add("inverseProjectionMatrix","mat4"),t.fragment.uniforms.add("tex","sampler2D"),t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.UV0,"vec2"),t.attributes.add(E.AUXPOS1,"vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vUV","vec2"),t.varyings.add("vSize","float"),t.varyings.add("linearDepth","float"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(x`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}`),t.vertex.code.add(x`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= screenSize / posNdc.w;
return posNdc;
}`),t.vertex.code.add(x`
    void clipAndTransform(inout vec4 pos, inout vec4 prev) {
      float vnp = nearFar[0] * 0.99;

      if (prev.z > -nearFar[0]) {
        //previous behind ncp
        prev = mix(pos, prev, interp(vnp, pos, prev));
      }

      ${e.multipassTerrainEnabled?"depth = pos.z;":""}
      linearDepth = (-pos.z - nearFar[0]) / (nearFar[1] - nearFar[0]);

      pos = projectAndScale(pos);
      prev = projectAndScale(prev);
    }
  `),t.vertex.code.add(x`
    void main(void) {
      float coverage = 1.0;

      // Check for special value of uv0.y which is used by the Renderer when graphics
      // are removed before the VBO is recompacted. If this is the case, then we just
      // project outside of clip space.
      if (uv0.y == 0.0) {
        // Project out of clip space
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      }
      else {
        float lineSize = getSize();
        float lineWidth = max(lineSize, 1.0) * pixelRatio;

        vec4 pos  = view * vec4(position.xyz, 1.0);
        vec4 prev = view * vec4(auxpos1.xyz, 1.0);
        clipAndTransform(pos, prev);

        // normalize vector along line segment
        vec2 segment = pos.xy - prev.xy;
        float segmentLen = length(segment);
        segment = (segmentLen > 0.001) ? segment / segmentLen : vec2(0.0, 0.0);

        // displace according to position in the texture
        vec2 displacementDirU = uv0.x * PERPENDICULAR(segment);
        vec2 displacementDirV = uv0.y * segment;

        vSize = ${x.float(JL/E_e)} * lineWidth;
        pos.xy += displacementDirU * vSize + displacementDirV * vSize;

        // Convert back into NDC
        pos.xy = (pos.xy / screenSize) * pos.w;

        // Convert texture coordinate into [0,1]
        vUV = (uv0 + 1.0) / 2.0;

        vColor = getColor();
        vColor.a *= coverage;

        // transform final position to camera space for slicing
        vpos = (inverseProjectionMatrix * pos).xyz;
        gl_Position = pos;
      }
    }
  `),e.multipassTerrainEnabled&&(t.fragment.include(Os),t.include(Ec,e)),t.include(Or,e),t.fragment.uniforms.add("intrinsicColor","vec4"),t.fragment.include(Vp),t.fragment.code.add(x`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

    vec4 finalColor = intrinsicColor * vColor;

    // Offset texture coordinate s.t. we sample texel centers
    float texelSize = ${x.float(1/JL)};
    vec2 samplePos = vUV + vec2(0.5, -0.5) * texelSize;

    // Evaluate sdf
    float sdf = rgba2float(texture2D(tex, samplePos)) - 0.5;
    float distance = sdf * vSize;

    // Grow by a halfpixel to make sure the line is fully covered by the cross marker
    // (otherwise there will be a halo if they are different colours)
    distance -= 0.5;

    finalColor.a *= clamp(0.5 - distance, 0.0, 1.0);

    if (finalColor.a < ${x.float(Hn)}) {
      discard;
    }

    ${e.output===j.Alpha?x`gl_FragColor = vec4(finalColor.a);`:""}
    ${e.output===j.Color?x`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===j.Color&&e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${e.output===j.Highlight?x`gl_FragColor = vec4(1.0);`:""}
    ${e.output===j.Depth?x`outputDepth(linearDepth);`:""}
  }
  `),t}const YJe=Object.freeze({__proto__:null,build:XJe}),A_e=new Map([[E.POSITION,0],[E.UV0,2],[E.AUXPOS1,3],[E.SIZE,6],[E.SIZEFEATUREATTRIBUTE,6],[E.COLOR,5],[E.COLORFEATUREATTRIBUTE,5],[E.OPACITYFEATUREATTRIBUTE,7]]);class I4 extends Gi{constructor(t,i,r){super(t,i,r)}initializeProgram(t){const i=I4.shader.get(),r=this.configuration,s=i.build({oitEnabled:r.transparencyPassType===lt.Color,output:r.output,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:r.draped,vvColor:r.vvColor,vvSize:r.vvSize,vvInstancingEnabled:!0,vvOpacity:r.vvOpacity,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Mi(t.rctx,s,A_e)}bindPass(t,i){Ol(this.program,i.camera.projectionMatrix),this.configuration.output===j.Highlight&&Hp(this.program,i),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),Jm(this.program,i)),this.program.setUniform1f("intrinsicWidth",t.width),this.program.setUniform4fv("intrinsicColor",t.color),this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniform1f("pixelRatio",i.camera.pixelRatio),this.program.setUniform2f("screenSize",i.camera.fullViewport[2],i.camera.fullViewport[3]),F0e(this.program,t)}bindDraw(t){Gp(this.program,t),I0(this.program,this.configuration,t.slicePlane,{origin:t.origin,view:t.camera.viewMatrix}),this.program.setUniformMatrix4fv("inverseProjectionMatrix",fr(pO.get(),t.camera.projectionMatrix)),this.program.rebindTextures()}_makePipelineState(t,i){const r=this.configuration,s=t===lt.NONE;return Ot({blending:r.output===j.Color||r.output===j.Alpha?s?gl:Km(t):null,depthTest:{func:H0(t)},depthWrite:s?r.writeDepth&&Ma:a4(t),colorWrite:Ft,stencilWrite:r.sceneHasOcludees?Ip:null,stencilTest:r.sceneHasOcludees?i?D0:W0:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=Ot({blending:gl,depthTest:XL,depthWrite:null,colorWrite:Ft,stencilWrite:null,stencilTest:Xve}),this._occluderPipelineOpaque=Ot({blending:gl,depthTest:XL,depthWrite:null,colorWrite:Ft,stencilWrite:qve,stencilTest:Wve}),this._occluderPipelineMaskWrite=Ot({blending:null,depthTest:PW,depthWrite:null,colorWrite:null,stencilWrite:Ip,stencilTest:D0})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(t,i){return i?this._occludeePipelineState:this.configuration.occluder?t===ve.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:t===ve.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(t,i)}}I4.shader=new Ni(YJe,()=>import("./LineMarker.glsl.57fffdab.js"));class ja extends mr{constructor(){super(...arguments),this.output=j.Color,this.occluder=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.writeDepth=!1,this.draped=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.sceneHasOcludees=!1,this.transparencyPassType=lt.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Z({count:j.COUNT})],ja.prototype,"output",void 0),u([Z()],ja.prototype,"occluder",void 0),u([Z()],ja.prototype,"slicePlaneEnabled",void 0),u([Z()],ja.prototype,"transparent",void 0),u([Z()],ja.prototype,"writeDepth",void 0),u([Z()],ja.prototype,"draped",void 0),u([Z()],ja.prototype,"vvSize",void 0),u([Z()],ja.prototype,"vvColor",void 0),u([Z()],ja.prototype,"vvOpacity",void 0),u([Z()],ja.prototype,"sceneHasOcludees",void 0),u([Z({count:lt.COUNT})],ja.prototype,"transparencyPassType",void 0),u([Z()],ja.prototype,"multipassTerrainEnabled",void 0),u([Z()],ja.prototype,"cullAboveGround",void 0);class ZJe extends od{constructor(t){super(t,JJe),this._vertexAttributeLocations=A_e,this.techniqueConfig=new ja,this.layout=this.createLayout()}dispose(){}getTechniqueConfig(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.draped=i.slot===ve.DRAPED_MATERIAL,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.occluder=this.parameters.renderOccluded===Cr.OccludeAndTransparentStencil,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}intersect(){}createLayout(){const t=kr().vec3f(E.POSITION).vec2f(E.UV0).vec3f(E.AUXPOS1);return this.parameters.vvSizeEnabled?t.f32(E.SIZEFEATUREATTRIBUTE):t.f32(E.SIZE),this.parameters.vvColorEnabled?t.f32(E.COLORFEATUREATTRIBUTE):t.vec4f(E.COLOR),this.parameters.vvOpacityEnabled&&t.f32(E.OPACITYFEATUREATTRIBUTE),t}createBufferWriter(){return new KJe(this.layout,this.parameters)}requiresSlot(t,i){if(t===ve.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===Cr.OccludeAndTransparentStencil)return t===ve.OPAQUE_MATERIAL||t===ve.OCCLUDER_MATERIAL||t===ve.TRANSPARENT_OCCLUDER_MATERIAL;const r=Q1(i);return r===j.Color||r===j.Alpha?t===(this.parameters.writeDepth?ve.TRANSPARENT_MATERIAL:ve.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):t===ve.OPAQUE_MATERIAL}createGLMaterial(t){return t.output===j.Color||t.output===j.Alpha||t.output===j.Highlight||t.output===j.Depth?new QJe(t):null}validateParameters(t){t.color&&t.color[3]<1&&(t.transparent=!0)}}class QJe extends lW{constructor(t){super(I(I({},t),t.material.parameters))}updateParameters(t){return this.updateTexture(this._material.parameters.textureId),this.ensureTechnique(I4,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}beginSlot(t){return this._output!==j.Color&&this._output!==j.Alpha||this._updateOccludeeState(t),this.updateParameters(t)}bind(t,i){this.bindTextures(i.program),this.bindTextureScale(i.program),i.bindPass(this._material.parameters,t)}}const JJe=I(I({width:0,color:[1,1,1,1],placement:"end",textureId:null,writeDepth:!0,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,sceneHasOcludees:!1},ju),MW);class KJe{constructor(t,i){this.vertexBufferLayout=t,this.parameters=i}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(){return this.parameters.placement==="begin-end"?12:6}write(t,i,r,s){const n=i.vertexAttributes.get(E.POSITION).data,o=n.length/3;let a=1,l=0;this.parameters.vvSizeEnabled?l=i.vertexAttributes.get(E.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(E.SIZE)&&(a=i.vertexAttributes.get(E.SIZE).data[0]);let c=[1,1,1,1],h=0;this.parameters.vvColorEnabled?h=i.vertexAttributes.get(E.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(E.COLOR)&&(c=i.vertexAttributes.get(E.COLOR).data);let p=0;this.parameters.vvOpacityEnabled&&(p=i.vertexAttributes.get(E.OPACITYFEATUREATTRIBUTE).data[0]);const f=t.transformation,g=new Float32Array(r.buffer);let y=s*(this.vertexBufferLayout.stride/4);const v=(T,A,C,O)=>{if(g[y++]=T[0],g[y++]=T[1],g[y++]=T[2],g[y++]=C[0],g[y++]=C[1],g[y++]=A[0],g[y++]=A[1],g[y++]=A[2],this.parameters.vvSizeEnabled?g[y++]=l:g[y++]=a,this.parameters.vvColorEnabled)g[y++]=h;else{const L=Math.min(4*O,c.length-4);g[y++]=c[L+0],g[y++]=c[L+1],g[y++]=c[L+2],g[y++]=c[L+3]}this.parameters.vvOpacityEnabled&&(g[y++]=p)};let b;(function(T){T[T.ASCENDING=1]="ASCENDING",T[T.DESCENDING=-1]="DESCENDING"})(b||(b={}));const w=(T,A)=>{const C=oe(eKe,n[3*T],n[3*T+1],n[3*T+2]),O=tKe;let L=T+A;do oe(O,n[3*L],n[3*L+1],n[3*L+2]),L+=A;while(bT(C,O)&&L>=0&&L<o);f&&(ke(C,C,f),ke(O,O,f)),v(C,O,[-1,-1],T),v(C,O,[1,-1],T),v(C,O,[1,1],T),v(C,O,[-1,-1],T),v(C,O,[1,1],T),v(C,O,[-1,1],T)},S=this.parameters.placement;S!=="begin"&&S!=="begin-end"||w(0,b.ASCENDING),S!=="end"&&S!=="begin-end"||w(o-1,b.DESCENDING)}}const eKe=M(),tKe=M(),eo={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},iKe={dash:eo.dash,"dash-dot":[...eo.dash,...eo.dot],dot:eo.dot,"long-dash":eo["long-dash"],"long-dash-dot":[...eo["long-dash"],...eo.dot],"long-dash-dot-dot":[...eo["long-dash"],...eo.dot,...eo.dot],none:null,"short-dash":eo["short-dash"],"short-dash-dot":[...eo["short-dash"],...eo["short-dot"]],"short-dash-dot-dot":[...eo["short-dash"],...eo["short-dot"],...eo["short-dot"]],"short-dot":eo["short-dot"],solid:null},rKe=8;function sKe(e,t=2){return R(e)?e:{pattern:e.slice(),pixelRatio:t}}function Gyt(e,t=2){return{pattern:[e,e],pixelRatio:t}}function C_e(e){return _(e)&&e.type==="style"?nKe(e.style):null}function nKe(e){return _(e)?sKe(iKe[e],rKe):null}const oKe=["polyline","polygon","extent"];class $4 extends Wp{constructor(t,i,r,s){super(t,i,r,s),this._uniformSize=1}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=UR(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const t=this.symbolLayer.size!=null?this.symbolLayer.size:Qh(1);if(t<0)throw new q("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=t}this._markerTexture=HJe(this._context.sharedResources.textures,this.symbolLayer.marker)}_getMaterialParameters(t,i=!1){var r;const s=po(this.symbolLayer.marker,c=>c.color),n=po(this.symbolLayer.material,c=>c.color),o=this._getCombinedOpacityAndColor(i&&s||n);this._patternHidesLine&&!i&&(o[3]=0);const a=o[3],l={width:this._computeMaterialWidth((r=this.symbolLayer)==null?void 0:r.size),color:o,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:oG(this.symbolLayer.cap||"butt"),transparent:a<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:t,stipplePattern:C_e(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?I(I({},l),this._fastUpdates.materialParameters):l}get lineMaterial(){return R(this._lineMaterial)&&(this._lineMaterial=new Bx(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial)),this._lineMaterial}get ringMaterial(){return R(this._ringMaterial)&&(this._ringMaterial=new Bx(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial)),this._ringMaterial}get wireframeLineMaterial(){return R(this._wireframeLineMaterial)&&(this._wireframeLineMaterial=new Bx(me(I({},this._getMaterialParameters(!1)),{wireframe:!0})),this._context.stage.add(this._wireframeLineMaterial)),this._wireframeLineMaterial}get wireframeRingMaterial(){return R(this._wireframeRingMaterial)&&(this._wireframeRingMaterial=new Bx(me(I({},this._getMaterialParameters(!0)),{wireframe:!0})),this._context.stage.add(this._wireframeRingMaterial)),this._wireframeRingMaterial}get markerMaterial(){return R(this._markerMaterial)&&_(this.symbolLayer.marker)&&_(this._markerTexture)&&(this._markerMaterial=new ZJe(me(I({},this._getMaterialParameters(!1,!0)),{placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id})),this._context.stage.add(this._markerMaterial)),this._markerMaterial}destroy(){super.destroy(),this._forEachMaterial(t=>this._context.stage.remove(t)),this._lineMaterial=null,this._ringMaterial=null,this._wireframeLineMaterial=null,this._wireframeRingMaterial=null,this._markerMaterial=null,this._markerTexture=Xi(this._markerTexture)}_getDrivenSize(t){return this._drivenProperties.size&&t.size?fo(NYe(t.size)):1}_getSizeFeatureAttributeData(t){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?_m(this._fastUpdates.visualVariables.size.field,t):null}_getDrivenColor(t){const i=yi(1,1,1,1);return this._drivenProperties.color&&t.color&&(i[0]=t.color[0],i[1]=t.color[1],i[2]=t.color[2],t.color.length>0&&(i[3]=t.color[3])),this._drivenProperties.opacity&&t.opacity&&(i[3]=t.opacity),i}_getColorFeatureAttributeData(t){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?_m(this._fastUpdates.visualVariables.color.field,t):null}_getOpacityFeatureAttributeData(t){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?_m(this._fastUpdates.visualVariables.opacity.field,t):null}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,oKe,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(i,new Mc);return this.ensureDrapedStatus(r.mode==="on-the-ground"),this.draped?this._createAsOverlay(t,this._context.layer.uid):this._createAs3DShape(t,r,i.uid)}applyRendererDiff(t,i){for(const r in t.diff){if(r!=="visualVariables"||!kR(this._fastUpdates,i,this._vvConvertOptions))return Es.Recreate_Symbol;this._forEachMaterial(s=>s.setParameters(this._fastUpdates.materialParameters))}return Es.Fast_Update}prepareSymbolLayerPatch(t){var i,r;if(t.diff.type!=="partial")return;const s=t.diff.diff,n={};((i=s.size)==null?void 0:i.type)==="complete"&&(n.width=this._computeMaterialWidth(s.size.newValue),delete s.size),((r=s.cap)==null?void 0:r.type)==="complete"&&(n.cap=oG(gt(s.cap.newValue,"butt")),delete s.cap);const o=this._prepareMarkerPatch(t,s);this._prepareMaterialPatch(t,s,o),t.symbolLayerStatePatches.push(()=>this._forEachMaterial(a=>a.setParameters(n)))}layerOpacityChanged(){return this._forEachMaterial((t,i)=>this._updateMaterialLayerOpacity(t,i)),!0}_forEachMaterial(t){_(this._lineMaterial)&&t(this._lineMaterial),_(this._ringMaterial)&&t(this._ringMaterial),_(this._wireframeLineMaterial)&&t(this._wireframeLineMaterial),_(this._wireframeRingMaterial)&&t(this._wireframeRingMaterial),_(this._markerMaterial)&&t(this._markerMaterial,!0)}_updateMaterialLayerOpacity(t,i=!1){const r=t.parameters.color,s=Pr(this.symbolLayer,"material","color"),n=this._patternHidesLine&&!i?0:this._getCombinedOpacity(s),o=n<1||this.needsDrivenTransparentPass,a=[r[0],r[1],r[2],n];t.setParameters({color:a,transparent:o})}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=BO($4.elevationModeChangeTypes,r,s);if(n!==_r.UPDATE)return n;const o=zu(s);return this.updateGraphics3DGraphicElevationInfo(t,i,()=>o)}slicePlaneEnabledChanged(){const t={slicePlaneEnabled:this._context.slicePlaneEnabled};return this._forEachMaterial(i=>i.setParameters(t)),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_getGeometryAsPolygonOrPolyline(t){switch(t.type){case"extent":if(t instanceof Xt)return bc.fromExtent(t);break;case"polygon":case"polyline":return t}return null}_createAs3DShape(t,i,r){const s=t.graphic,n=this._getGeometryAsPolygonOrPolyline(s.geometry),o=n.type==="polygon"?n.rings:n.paths,a=new Array,l=new Array,c=new Array,h=cs(),p=IJe(n,this._context.elevationProvider,this._context.renderCoordsHelper,i),f=n.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(p,o,f,"LineSymbol3DLayer");for(let v=0;v<p.lines.length;v++){const{position:b,mapPosition:w}=p.lines[v];if(_(this._context.clippingExtent)&&(ki(h),uc(h,w),!Uh(h,this._context.clippingExtent)))continue;const S=this._createGeometry(t,b,w,n.type,bC.ELEVATED);a.push(S),l.push(n.type==="polygon"?this.ringMaterial:this.lineMaterial),c.push(ls),hi.LINE_WIREFRAMES&&(a.push(S.cloneShallow()),l.push(n.type==="polygon"?this.wireframeRingMaterial:this.wireframeLineMaterial),c.push(ls));const T=this.markerMaterial;_(T)&&(a.push(S.cloneShallow()),l.push(T),c.push(ls))}if(a.length===0)return null;const g=new tg({geometries:a,materials:l,transformations:c,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),y=new qp(this,g,a,null,null,VXe,i);return y.alignedSampledElevation=p.sampledElevation,y.needsElevationUpdates=zu(i.mode),y}_createGeometry(t,i,r,s,n){const o=s==="polygon"?eb.REMOVE:eb.KEEP,a=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,l=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return nG({overlayInfo:n===bC.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:o,uniformSize:this._uniformSize,attributeData:{position:i,mapPosition:r,size:l?null:this._getDrivenSize(t.renderingInfo),color:a?null:this._getDrivenColor(t.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(t.graphic),colorFeature:this._getColorFeatureAttributeData(t.graphic),opacityFeature:this._getOpacityFeatureAttributeData(t.graphic)}})}_createAsOverlay(t,i){const r=t.graphic,s=this._getGeometryAsPolygonOrPolyline(r.geometry),n=s.type==="polygon"?s.rings:s.paths,o=s.type==="polygon"?this.ringMaterial:this.lineMaterial;o.renderPriority=this._renderPriority;const a=hi.LINE_WIREFRAMES?s.type==="polygon"?this.wireframeRingMaterial:this.wireframeLineMaterial:null,l=this.markerMaterial;_(a)&&(a.renderPriority=this._renderPriority-.001),_(l)&&(l.renderPriority=this._renderPriority-.002);const c=new Array,h=cs(),p=ki(),f=$Je(s,this._context.overlaySR),g=s.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(f,n,g,"LineSymbol3DLayer");for(const y of f.lines){if(ki(h),uc(h,y.position),!Uh(h,this._context.clippingExtent))continue;FT(p,h);const v=this._createGeometry(t,y.position,null,s.type,bC.DRAPED),b=S=>{const T=new CS(v,S,{layerUid:i,graphicUid:r.uid});return c.push(T),T};if(_(l)){const S=b(l),T=this.symbolLayer.marker.placement;T!=="begin"&&T!=="begin-end"||uc(h,y.position,0,1),T!=="end"&&T!=="begin-end"||uc(h,y.position,y.position.length-3,1),this._updateBoundingSphere(S,h)}const w=b(o);if(this._updateBoundingSphere(w,h),hi.LINE_WIREFRAMES){const S=b(a);this._updateBoundingSphere(S,h)}}return new M4(this,c,p)}_updateBoundingSphere(t,i){Ho(t.boundingSphere,.5*(i[0]+i[3]),.5*(i[1]+i[4]),0,.5*Math.sqrt((i[3]-i[0])*(i[3]-i[0])+(i[4]-i[1])*(i[4]-i[1])))}get _patternHidesLine(){const t=this.symbolLayer.pattern;return _(t)&&t.type==="style"&&t.style==="none"}_computeMaterialWidth(t){return t=gt(t,Qh(1)),this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?fo(1):1:fo(t)}_prepareMaterialPatch(t,i,r){const s=i.material;if(R(s)||s.type==="collection")return;const n=s.type==="complete"?po(s.newValue,a=>a.color):s.diff.color.type==="complete"?s.diff.color.newValue:null,o=this._getCombinedOpacityAndColor(n);r&&this._patchMaterialColor(aF(o),this._markerMaterial,t),this._patternHidesLine&&(o[3]=0),this._patchMaterialColor(o,this._lineMaterial,t),delete i.material}_prepareMarkerPatch(t,i){const r=i.marker;if(R(r)||r.type!=="partial"||_(r.diff.style)||_(r.diff.placement)||_(r.diff.color)&&r.diff.color.type!=="complete")return!1;const s=r.diff.color;if(R(s))return delete i.marker,R(this.symbolLayer)||R(this.symbolLayer.marker)||R(this.symbolLayer.marker.color);const n=s.newValue;return R(n)?(delete i.marker,!0):(this._patchMaterialColor(this._getCombinedOpacityAndColor(n),this._markerMaterial,t),delete i.marker,!1)}_patchMaterialColor(t,i,r){if(R(i))return;const s=t[3];r.symbolLayerStatePatches.push(()=>i.setParameters({color:t,transparent:s<1||this.needsDrivenTransparentPass}))}}var bC;$4.elevationModeChangeTypes={definedChanged:_r.RECREATE,staysOnTheGround:_r.NONE,onTheGroundChanged:_r.RECREATE},function(e){e[e.DRAPED=0]="DRAPED",e[e.ELEVATED=1]="ELEVATED"}(bC||(bC={}));const Fie=2048,aKe=1.5,lKe=8;function cKe(e,t){const{format:i,quality:r,rotation:s,disableDecorations:n}=e||{},o=UW(e,t.padding),a=vKe(e,{width:t.width-o.left-o.right,height:t.height-o.top-o.bottom}),{width:l,height:c}=yKe(e,a),h=wKe(i),p=AKe[h];return{format:h,quality:Be(r!=null?r:p,0,100),area:a,width:l,height:c,rotation:s,disableDecorations:!!n,ignoreBackground:!(!e||!e.ignoreBackground),ignorePadding:!(!e||!e.ignorePadding)}}function uKe(e,t){const i=cKe(e,t),r=i.area,s=i.width/r.width,n=UW(i,t.padding),o=n.left+n.right,a=n.top+n.bottom,l=t.width-o,c=t.height-a,h=Math.floor(l*s+o),p=Math.floor(c*s+a),f=e&&e.layers?e.layers:[],g=i.ignoreBackground,y=i.ignorePadding;return{framebufferWidth:h,framebufferHeight:p,region:{x:Math.floor(r.x*s)+n.left,y:Math.floor(r.y*s)+n.top,width:i.width,height:i.height},format:i.format,quality:i.quality,rotation:i.rotation,pixelRatio:s,layers:f,disableDecorations:i.disableDecorations,ignoreBackground:g,ignorePadding:y}}function hKe(e,t,i,r){r.premultipliedAlpha&&TKe(e),i.width=e.width,i.height=e.height;const s=i.getContext("2d");s.putImageData(e,0,0),r.flipY&&xKe(s);const n=s.getImageData(0,0,e.width,e.height),o=dKe(i,t);return i.width=0,i.height=0,{dataUrl:o,data:n}}function dKe(e,t){const i=SKe[t.format],r=t.quality/100;return e.toDataURL(i,r)}function Wk(e,t,i){if(!e||!t)throw new Error("Cannot construct image data without dimensions");if(KL)try{return new ImageData(e,t)}catch{KL=!1}return R_e(e,t,i)}function pKe(e,t,i,r){if(!t||!i)throw new Error("Cannot construct image data without dimensions");if(KL)try{return new ImageData(e,t,i)}catch{KL=!1}const s=R_e(t,i,r);return s.data.set(e,0),s}function fKe(e,t,i,r=0,s=0,n=e.width-r,o=e.height-s,a=!1){const{data:l}=e,{width:c,height:h,data:p}=t,f=n/c,g=o/h,y=Math.ceil(f/2),v=Math.ceil(g/2),b=e.width;for(let w=0;w<h;w++)for(let S=0;S<c;S++){const T=4*(S+(a?h-w-1:w)*c);let A=0,C=0,O=0,L=0,U=0,N=0;const z=(w+.5)*g;for(let V=Math.floor(w*g);V<(w+1)*g;V++){const B=Math.abs(z-(V+.5))/v,J=(S+.5)*f,Q=B*B;for(let te=Math.floor(S*f);te<(S+1)*f;te++){const ie=Math.abs(J-(te+.5))/y,$=Math.sqrt(Q+ie*ie);if($>=1)continue;let F=2*$*$*$-3*$*$+1;const k=4*(r+te+(s+V)*b);N+=F*l[k+3],C+=F,!i&&l[k+3]<255&&(F=F*l[k+3]/255),O+=F*l[k],L+=F*l[k+1],U+=F*l[k+2],A+=F}}p[T]=O/A,p[T+1]=L/A,p[T+2]=U/A,p[T+3]=N/C}return t}function mKe(e,t,i){if(!t)return e;const{framebufferWidth:r,framebufferHeight:s,pixelRatio:n,region:o}=e,a=UW(e,i),l=a.left+a.right,c=a.top+a.bottom,h=r-l,p=s-c,f=Math.min(lKe,Math.min((Fie-l)/h,(Fie-c)/p));return f<aKe?e:me(I({},e),{framebufferWidth:Math.round(h*f)+l,framebufferHeight:Math.round(p*f)+c,pixelRatio:n*f,resample:{region:{x:Math.round((o.x-a.left)*f)+a.left,y:Math.round((o.y-a.top)*f)+a.top,width:Math.round(o.width*f),height:Math.round(o.height*f)},width:r,height:s}})}function R_e(e,t,i){return i||(i=gKe()),i.getContext("2d").createImageData(e,t)}let Y2=null,KL=!0;function gKe(){return Y2||(Y2=document.createElement("canvas"),Y2.width=1,Y2.height=1),Y2}function yKe(e,t){if(!e)return t;const i=e.width,r=e.height;if(i!=null&&r!=null)return{width:Math.floor(i),height:Math.floor(r)};if(i==null&&r==null)return t;const s=t.width/t.height;return r==null?{width:Math.floor(i),height:Math.floor(i/s)}:{width:Math.floor(r*s),height:Math.floor(r)}}function vKe(e,t){const i={x:0,y:0,width:t.width,height:t.height};if(e&&e.area){e.area.x!=null&&(i.x=Math.floor(e.area.x)),e.area.y!=null&&(i.y=Math.floor(e.area.y));const r=e.area.width!=null?Math.floor(e.area.width):null,s=e.area.height!=null?Math.floor(e.area.height):null;if(i.width=t.width-i.x,i.height=t.height-i.y,r!=null&&s!=null)i.width=Math.min(i.width,r),i.height=Math.min(i.height,s);else if(r==null&&s!=null){const n=Math.min(i.width,r);i.height=n/i.width*i.height,i.width=n}else if(r!=null&&s==null){const n=Math.min(i.height,s);i.width=n/i.height*i.width,i.height=n}}return _Ke(bKe(i,e),t)}function _Ke(e,t){const i=Math.floor(Math.max(e.x,0)),r=Math.floor(Math.max(e.y,0)),s={x:i,y:r,width:Math.floor(Math.min(e.width,t.width-i)),height:Math.floor(Math.min(e.height,t.height-r))},n=s.width/s.height,o=e.width/e.height;if(o===n)return s;if(o>n){const c=Math.floor(s.width/o),h=s.height-c;return{x:s.x,y:Math.floor(s.y+h/2),width:s.width,height:c}}const a=Math.floor(s.height*o),l=s.width-a;return{x:Math.floor(s.x+l/2),y:s.y,width:a,height:s.height}}function bKe(e,t){if(!t||t.width==null||t.height==null)return e;const i=t.width/t.height,r=e.width/e.height;if(r===i)return e;if(r<i){const n=Math.floor(e.height*i);return e.x-=(n-e.width)/2,e.width=n,e}const s=Math.floor(e.width/i);return e.y-=(s-e.height)/2,e.height=s,e}function UW(e,t){return!t||e&&e.ignorePadding?CKe:t}function wKe(e){switch(e){case"png":case"jpg":case"jpeg":return e;default:return EKe}}function xKe(e){e.save(),e.globalCompositeOperation="copy",e.scale(1,-1),e.translate(0,-e.canvas.height),e.drawImage(e.canvas,0,0),e.restore()}function TKe(e){const t=e.data,i=t.length;for(let r=0;r<i;r+=4){const s=t[r+3];if(s>0){const n=s/255;t[r+0]=t[r+0]/n,t[r+1]=t[r+1]/n,t[r+2]=t[r+2]/n}}}const SKe={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},Uie=98,EKe="png",AKe={png:100,jpg:Uie,jpeg:Uie},CKe={top:0,right:0,bottom:0,left:0};var ox;const Xk=new WeakMap;let RKe=0,Gd=ox=class extends fe{constructor(e){super(e),this.wrap="repeat"}get url(){return this._get("url")||null}set url(e){this._set("url",e),e&&this._set("data",null)}get data(){return this._get("data")||null}set data(e){this._set("data",e),e&&this._set("url",null)}writeData(e,t,i,r){if(e instanceof HTMLImageElement){const s={type:"image-element",src:R1(e.src,r),crossOrigin:e.crossOrigin};t[i]=s}else if(e instanceof HTMLCanvasElement){const s=e.getContext("2d").getImageData(0,0,e.width,e.height),n={type:"canvas-element",imageData:this._encodeImageData(s)};t[i]=n}else if(e instanceof HTMLVideoElement){const s={type:"video-element",src:R1(e.src,r),autoplay:e.autoplay,loop:e.loop,muted:e.muted,crossOrigin:e.crossOrigin,preload:e.preload};t[i]=s}else{const s={type:"image-data",imageData:this._encodeImageData(e)};t[i]=s}}readData(e){switch(e.type){case"image-element":{const t=new Image;return t.src=e.src,t.crossOrigin=e.crossOrigin,t}case"canvas-element":{const t=this._decodeImageData(e.imageData),i=document.createElement("canvas");return i.width=t.width,i.height=t.height,i.getContext("2d").putImageData(t,0,0),i}case"image-data":return this._decodeImageData(e.imageData);case"video-element":{const t=document.createElement("video");return t.src=e.src,t.crossOrigin=e.crossOrigin,t.autoplay=e.autoplay,t.loop=e.loop,t.muted=e.muted,t.preload=e.preload,t}default:return}}get transparent(){const e=this.data,t=this.url;if(e instanceof HTMLCanvasElement)return this._imageDataContainsTransparent(e.getContext("2d").getImageData(0,0,e.width,e.height));if(e instanceof ImageData)return this._imageDataContainsTransparent(e);if(t){const i=t.substr(t.length-4,4).toLowerCase(),r=t.substr(0,15).toLocaleLowerCase();if(i===".png"||r==="data:image/png;")return!0}return!1}set transparent(e){e!=null?this._override("transparent",e):this._clearOverride("transparent")}get contentHash(){const e=typeof this.wrap=="string"?this.wrap:typeof this.wrap=="object"?`${this.wrap.horizontal}/${this.wrap.vertical}`:"",t=(i="")=>`d:${i},t:${this.transparent},w:${e}`;return this.url!=null?t(this.url):this.data!=null?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?t(this.data.src):(Xk.has(this.data)||Xk.set(this.data,++RKe),t(Xk.get(this.data))):t()}clone(){const e={url:this.url,data:this.data,wrap:this._cloneWrap()};return new ox(e)}cloneWithDeduplication(e){const t=e.get(this);if(t)return t;const i=this.clone();return e.set(this,i),i}_cloneWrap(){return typeof this.wrap=="string"?this.wrap:{horizontal:this.wrap.horizontal,vertical:this.wrap.vertical}}_encodeImageData(e){let t="";for(let i=0;i<e.data.length;i++)t+=String.fromCharCode(e.data[i]);return{data:btoa(t),width:e.width,height:e.height}}_decodeImageData(e){const t=atob(e.data),i=new Uint8ClampedArray(t.length);for(let r=0;r<t.length;r++)i[r]=t.charCodeAt(r);return pKe(i,e.width,e.height)}_imageDataContainsTransparent(e){for(let t=3;t<e.data.length;t+=4)if(e.data[t]!==255)return!0;return!1}static from(e){return typeof e=="string"?new ox({url:e}):e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof ImageData||e instanceof HTMLVideoElement?new ox({data:e}):ST(ox,e)}};u([d({type:String,json:{write:v0}})],Gd.prototype,"url",null),u([d({json:{write:{overridePolicy(){return{enabled:!this.url}}}}}),d()],Gd.prototype,"data",null),u([Fe("data")],Gd.prototype,"writeData",null),u([De("data")],Gd.prototype,"readData",null),u([d({type:Boolean,json:{write:{overridePolicy(){return{enabled:this._isOverridden("transparent")}}}}})],Gd.prototype,"transparent",null),u([d({json:{write:!0}})],Gd.prototype,"wrap",void 0),u([d({readOnly:!0})],Gd.prototype,"contentHash",null),Gd=ox=u([P("esri.geometry.support.MeshTexture")],Gd);const wC=Gd;var aG;let Nf=aG=class extends fe{constructor(e){super(e),this.color=null,this.colorTexture=null,this.normalTexture=null,this.alphaMode="auto",this.alphaCutoff=.5,this.doubleSided=!0}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(e,t){const i=_(e)?e.get(this):null;if(i)return i;const r=new aG(this.clonePropertiesWithDeduplication(t));return _(e)&&e.set(this,r),r}clonePropertiesWithDeduplication(e){return{color:_(this.color)?this.color.clone():null,colorTexture:_(this.colorTexture)?this.colorTexture.cloneWithDeduplication(e):null,normalTexture:_(this.normalTexture)?this.normalTexture.cloneWithDeduplication(e):null,alphaMode:this.alphaMode,alphaCutoff:this.alphaCutoff,doubleSided:this.doubleSided}}};u([d({type:Je,json:{write:!0}})],Nf.prototype,"color",void 0),u([d({type:wC,json:{write:!0}})],Nf.prototype,"colorTexture",void 0),u([d({type:wC,json:{write:!0}})],Nf.prototype,"normalTexture",void 0),u([d({nonNullable:!0,json:{write:!0}})],Nf.prototype,"alphaMode",void 0),u([d({nonNullable:!0,json:{write:!0}})],Nf.prototype,"alphaCutoff",void 0),u([d({nonNullable:!0,json:{write:!0}})],Nf.prototype,"doubleSided",void 0),Nf=aG=u([P("esri.geometry.support.MeshMaterial")],Nf);const kW=Nf;var lG;let Ff=lG=class extends kW{constructor(e){super(e),this.emissiveColor=null,this.emissiveTexture=null,this.occlusionTexture=null,this.metallic=1,this.roughness=1,this.metallicRoughnessTexture=null}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(e,t){const i=_(e)?e.get(this):null;if(i)return i;const r=new lG(this.clonePropertiesWithDeduplication(t));return _(e)&&e.set(this,r),r}clonePropertiesWithDeduplication(e){return me(I({},super.clonePropertiesWithDeduplication(e)),{emissiveColor:_(this.emissiveColor)?this.emissiveColor.clone():null,emissiveTexture:_(this.emissiveTexture)?this.emissiveTexture.cloneWithDeduplication(e):null,occlusionTexture:_(this.occlusionTexture)?this.occlusionTexture.cloneWithDeduplication(e):null,metallic:this.metallic,roughness:this.roughness,metallicRoughnessTexture:_(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.cloneWithDeduplication(e):null})}};u([d({type:Je,json:{write:!0}})],Ff.prototype,"emissiveColor",void 0),u([d({type:wC,json:{write:!0}})],Ff.prototype,"emissiveTexture",void 0),u([d({type:wC,json:{write:!0}})],Ff.prototype,"occlusionTexture",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],Ff.prototype,"metallic",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],Ff.prototype,"roughness",void 0),u([d({type:wC,json:{write:!0}})],Ff.prototype,"metallicRoughnessTexture",void 0),Ff=lG=u([P("esri.geometry.support.MeshMaterialMetallicRoughness")],Ff);const O_e=Ff;var A$;const Yb=he.getLogger("esri.geometry.support.MeshVertexAttributes");let Fc=A$=class extends fe{constructor(e){super(e),this.color=null,this.position=new Float64Array(0),this.uv=null,this.normal=null,this.tangent=null}castColor(e){return ax(e,Uint8Array,[Uint8ClampedArray],{loggerTag:".color=",stride:4},Yb)}castPosition(e){return e&&e instanceof Float32Array&&Yb.warn(".position=","Setting position attribute from a Float32Array may cause precision problems. Consider storing data in a Float64Array or a regular number array"),ax(e,Float64Array,[Float32Array],{loggerTag:".position=",stride:3},Yb)}castUv(e){return ax(e,Float32Array,[Float64Array],{loggerTag:".uv=",stride:2},Yb)}castNormal(e){return ax(e,Float32Array,[Float64Array],{loggerTag:".normal=",stride:3},Yb)}castTangent(e){return ax(e,Float32Array,[Float64Array],{loggerTag:".tangent=",stride:4},Yb)}clone(){const e={position:se(this.position),uv:se(this.uv),normal:se(this.normal),tangent:se(this.tangent),color:se(this.color)};return new A$(e)}clonePositional(){const e={position:se(this.position),normal:se(this.normal),tangent:se(this.tangent),uv:this.uv,color:this.color};return new A$(e)}};function Yk(e,t,i,r){const{loggerTag:s,stride:n}=t;return e.length%n!=0?(r.error(s,`Invalid array length, expected a multiple of ${n}`),new i([])):e}function ax(e,t,i,r,s){if(!e)return e;if(e instanceof t)return Yk(e,r,t,s);for(const n of i)if(e instanceof n)return Yk(new t(e),r,t,s);if(Array.isArray(e))return Yk(new t(e),r,t,s);{const n=i.map(o=>`'${o.name}'`);return s.error(`Failed to set property, expected one of ${n}, but got ${e.constructor.name}`),new t([])}}function Z2(e,t,i){t[i]=OKe(e)}function OKe(e){const t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=e[i];return t}u([d({json:{write:Z2}})],Fc.prototype,"color",void 0),u([At("color")],Fc.prototype,"castColor",null),u([d({nonNullable:!0,json:{write:Z2}})],Fc.prototype,"position",void 0),u([At("position")],Fc.prototype,"castPosition",null),u([d({json:{write:Z2}})],Fc.prototype,"uv",void 0),u([At("uv")],Fc.prototype,"castUv",null),u([d({json:{write:Z2}})],Fc.prototype,"normal",void 0),u([At("normal")],Fc.prototype,"castNormal",null),u([d({json:{write:Z2}})],Fc.prototype,"tangent",void 0),u([At("tangent")],Fc.prototype,"castTangent",null),Fc=A$=u([P("esri.geometry.support.MeshVertexAttributes")],Fc);var SA;const MKe=he.getLogger("esri.geometry.support.MeshComponent");let Uf=SA=class extends fe{constructor(e){super(e),this.faces=null,this.material=null,this.shading="source",this.trustSourceNormals=!1}static from(e){return ST(SA,e)}castFaces(e){return ax(e,Uint32Array,[Uint16Array],{loggerTag:".faces=",stride:3},MKe)}castMaterial(e){return ST(e&&typeof e=="object"&&("metallic"in e||"roughness"in e||"metallicRoughnessTexture"in e)?O_e:kW,e)}clone(){return new SA({faces:se(this.faces),shading:this.shading,material:se(this.material),trustSourceNormals:this.trustSourceNormals})}cloneWithDeduplication(e,t){const i={faces:se(this.faces),shading:this.shading,material:this.material?this.material.cloneWithDeduplication(e,t):null,trustSourceNormals:this.trustSourceNormals};return new SA(i)}};u([d({json:{write:!0}})],Uf.prototype,"faces",void 0),u([At("faces")],Uf.prototype,"castFaces",null),u([d({type:kW,json:{write:!0}})],Uf.prototype,"material",void 0),u([At("material")],Uf.prototype,"castMaterial",null),u([d({type:String,json:{write:!0}})],Uf.prototype,"shading",void 0),u([d({type:Boolean})],Uf.prototype,"trustSourceNormals",void 0),Uf=SA=u([P("esri.geometry.support.MeshComponent")],Uf);const PKe=Uf,D4=he.getLogger("esri.geometry.support.meshUtils.normalProjection");function IKe(e,t,i,r,s){return N4(r)?(L4(bm.TO_PCPF,Si.fromTypedArray(e),Xr.fromTypedArray(t),Xr.fromTypedArray(i),r,Si.fromTypedArray(s)),s):(D4.error("Cannot convert spatial reference to PCPF"),s)}function jyt(e,t,i,r,s){return N4(r)?(L4(bm.FROM_PCPF,Si.fromTypedArray(e),Xr.fromTypedArray(t),Xr.fromTypedArray(i),r,Si.fromTypedArray(s)),s):(D4.error("Cannot convert to spatial reference from PCPF"),s)}function Hyt(e,t,i){return br(e,t,0,i,eF(t),0,e.length/3),i}function qyt(e,t,i){return br(e,eF(i),0,t,i,0,e.length/3),t}function $Ke(e,t,i){if(R(e))return t;const r=Xr.fromTypedArray(e),s=Xr.fromTypedArray(t);return GO(s,r,i),t}function DKe(e,t,i){if(R(e))return t;cS(Hs,i);const r=Si.fromTypedArray(e),s=Si.fromTypedArray(t);return Z1(s,r,Hs),Aq(Hs)||CW(s,s),t}function LKe(e,t,i){if(R(e))return t;cS(Hs,i);const r=Si.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),s=Si.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT);if(Z1(s,r,Hs),Aq(Hs)||CW(s,s),e!==t)for(let n=3;n<e.length;n+=4)t[n]=e[n];return t}function NKe(e,t,i,r,s){if(!N4(r))return D4.error("Cannot convert spatial reference to PCPF"),s;L4(bm.TO_PCPF,Si.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),Xr.fromTypedArray(t),Xr.fromTypedArray(i),r,Si.fromTypedArray(s,4*Float32Array.BYTES_PER_ELEMENT));for(let n=3;n<e.length;n+=4)s[n]=e[n];return s}function Wyt(e,t,i,r,s){if(!N4(r))return D4.error("Cannot convert to spatial reference from PCPF"),s;L4(bm.FROM_PCPF,Si.fromTypedArray(e,16),Xr.fromTypedArray(t),Xr.fromTypedArray(i),r,Si.fromTypedArray(s,16));for(let n=3;n<e.length;n+=4)s[n]=e[n];return s}function L4(e,t,i,r,s,n){if(!t)return;const o=i.count,a=eF(s);if(M_e(s))for(let l=0;l<o;l++)r.getVec(l,q3),t.getVec(l,vd),Kh(a,q3,W3,a),Lu(Hs,W3),e===bm.FROM_PCPF&&Nu(Hs,Hs),al(vd,vd,Hs),n.setVec(l,vd);else for(let l=0;l<o;l++){r.getVec(l,q3),t.getVec(l,vd),Kh(a,q3,W3,a),Lu(Hs,W3);const c=bD(i.get(l,1));let h=Math.cos(c);e===bm.TO_PCPF&&(h=1/h),Hs[0]*=h,Hs[1]*=h,Hs[2]*=h,Hs[3]*=h,Hs[4]*=h,Hs[5]*=h,e===bm.FROM_PCPF&&Nu(Hs,Hs),al(vd,vd,Hs),be(vd,vd),n.setVec(l,vd)}return n}function N4(e){return M_e(e)||FKe(e)}function M_e(e){return e.isWGS84||Rae(e)||Lp(e)||Np(e)}function FKe(e){return e.isWebMercator}var bm;(function(e){e[e.TO_PCPF=0]="TO_PCPF",e[e.FROM_PCPF=1]="FROM_PCPF"})(bm||(bm={}));const q3=M(),vd=M(),W3=Te(),Hs=wr();function UKe(e){const t=new Oi;return t.include(Gn,{linearDepth:!1}),t.include(xb,e),t.include(Hve,me(I({},e),{stippleRequiresStretchMeasure:!1})),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),e.stippleEnabled&&(t.vertex.uniforms.add("ndcToPixel","vec2"),t.attributes.add(E.UV0,"vec2"),t.attributes.add(E.AUXPOS1,"vec3")),t.attributes.add(E.POSITION,"vec3"),t.varyings.add("vpos","vec3"),t.vertex.code.add(x`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),e.stippleEnabled&&(t.vertex.code.add(x`vec4 vpos2 = transformPosition(proj, view, auxpos1);
float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);`),e.draped||t.vertex.code.add(x`vec3 segmentCenter = (position + auxpos1) * 0.5;
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),t.vertex.code.add(x`float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);`),e.draped?t.vertex.code.add(x`float startPseudoScreen = uv0.y * discreteWorldToScreenRatio - mix(0.0, lineSegmentPixelSize, uv0.x);
float segmentLengthPseudoScreen = lineSegmentPixelSize;`):t.vertex.code.add(x`float segmentLengthRender = length(position - auxpos1);
float startPseudoScreen = mix(uv0.y, uv0.y - segmentLengthRender, uv0.x) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),t.vertex.code.add(x`vec2 stippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, lineSegmentPixelSize, stipplePatternPixelSize);
vStippleDistance = mix(stippleDistanceLimits.x, stippleDistanceLimits.y, uv0.x);
vStippleDistance *= gl_Position.w;`)),t.vertex.code.add(x`}`),e.output===j.Highlight&&t.include(Qm),t.include(Or,e),t.fragment.uniforms.add("constantColor","vec4").add("alphaCoverage","float"),t.fragment.code.add(x`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${e.attributeColor?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    if (finalColor.a < ${x.float(Hn)}) {
      discard;
    }

    ${e.output===j.Color?x`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===j.Highlight?x`outputHighlight();`:""}
  }
  `),t}const kKe=Object.freeze({__proto__:null,build:UKe});class F4 extends Gi{constructor(t,i,r){super(t,i,r),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=t.stippleTextureRepository}get stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==j.Highlight}initializeProgram(t){const i=F4.shader.get(),r=this.configuration,s=i.build({output:r.output,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:r.draped,stippleEnabled:this.stippleEnabled,stippleOffColorEnabled:r.stippleOffColorEnabled,stippleRequiresClamp:!1,stippleScaleWithLineWidth:!1,stipplePreferContinuous:r.stipplePreferContinuous});return new Mi(t.rctx,s,mi)}destroy(){super.destroy(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(t,i){if(Ol(this.program,i.camera.projectionMatrix),this.stipplePattern!==t.stipplePattern){const r=t.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,r),this.stipplePattern=r}if(this.stippleEnabled){const{pixelSize:r,sdfNormalizer:s,pixels:n}=_(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};this.program.setUniform1f("stipplePatternSDFNormalizer",s),this.program.setUniform1f("stipplePatternTextureSize",n),this.program.setUniform1f("stipplePatternPixelSize",r),this.program.setUniform1f("stipplePatternPixelSizeInv",1/r),this.program.setUniform1f("pixelRatio",i.camera.pixelRatio),this.configuration.draped?this.program.setUniform1f("worldToScreenRatio",1/i.screenToPCSRatio):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/i.camera.perScreenPixelRatio),this.program.setUniform2f("ndcToPixel",i.camera.fullViewport[2]/2,i.camera.fullViewport[3]/2)}if(this.program.setUniform4fv("constantColor",t.color),this.program.setUniform1f("alphaCoverage",Math.min(1,t.width*i.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const r=t.stippleOffColor;this.program.setUniform4f("stippleOffColor",r[0],r[1],r[2],r.length>3?r[3]:1)}this.configuration.output===j.Highlight&&Hp(this.program,i)}bindDraw(t){Gp(this.program,t),this.stippleEnabled&&!this.configuration.draped&&j0(this.program,t.origin,t.camera.viewInverseTransposeMatrix),wb(this.program,this.configuration,t),this.program.rebindTextures()}initializePipeline(){const t=this.configuration,i=Xn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),r=(s,n=null,o=null)=>Ot({blending:n,depthTest:PW,depthWrite:o,colorWrite:Ft,stencilWrite:t.sceneHasOcludees?Ip:null,stencilTest:t.sceneHasOcludees?s?D0:W0:null});return t.output===j.Color?(this._occludeePipelineState=r(!0,t.transparent||this.stippleEnabled?i:null,Ma),r(!1,t.transparent||this.stippleEnabled?i:null,Ma)):r(!1)}get primitiveType(){return Tt.LINES}getPipelineState(t,i){return i?this._occludeePipelineState:super.getPipelineState(t,i)}}F4.shader=new Ni(kKe,()=>import("./NativeLine.glsl.8c0a76a7.js"));class jd extends mr{constructor(){super(...arguments),this.output=j.Color,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.sceneHasOcludees=!1}}u([Z({count:j.COUNT})],jd.prototype,"output",void 0),u([Z()],jd.prototype,"slicePlaneEnabled",void 0),u([Z()],jd.prototype,"vertexColors",void 0),u([Z()],jd.prototype,"transparent",void 0),u([Z()],jd.prototype,"draped",void 0),u([Z()],jd.prototype,"stippleEnabled",void 0),u([Z()],jd.prototype,"stippleOffColorEnabled",void 0),u([Z()],jd.prototype,"stipplePreferContinuous",void 0),u([Z()],jd.prototype,"sceneHasOcludees",void 0);const zKe=he.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");var eN;(function(e){e[e.START=0]="START",e[e.END=1]="END"})(eN||(eN={}));class kie extends od{constructor(t){super(t,GKe),this._techniqueConfig=new jd}getTechniqueConfig(t,i){this._techniqueConfig.output=t,this._techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this._techniqueConfig.vertexColors=this.parameters.vertexColors,this._techniqueConfig.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._techniqueConfig.draped=i.slot===ve.DRAPED_MATERIAL;const r=_(this.parameters.stipplePattern);return this._techniqueConfig.stippleEnabled=r,this._techniqueConfig.stippleOffColorEnabled=r&&_(this.parameters.stippleOffColor),this._techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this._techniqueConfig.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._techniqueConfig}getPassParameters(){return this.parameters}intersect(t,i,r,s,n,o,a,l,c){_(c)?Mqe(t,s,c,o,1,a):this._intersectLineGeometry(t,i,r,s,a)}_intersectLineGeometry(t,i,r,s,n){if(!s.options.selectionMode||IO(i))return;if(!Yge(r))return void zKe.error("intersection assumes a translation-only matrix");const o=t.vertexAttributes.get(E.POSITION).data,a=s.camera,l=HKe;zs(l,s.point);const c=2;oe(Q2[0],l[0]-c,l[1]+c,0),oe(Q2[1],l[0]+c,l[1]+c,0),oe(Q2[2],l[0]+c,l[1]-c,0),oe(Q2[3],l[0]-c,l[1]-c,0);for(let y=0;y<4;y++)if(!a.unprojectFromRenderScreen(Q2[y],nf[y]))return;co(a.eye,nf[0],nf[1],Zk),co(a.eye,nf[1],nf[2],Qk),co(a.eye,nf[2],nf[3],Jk),co(a.eye,nf[3],nf[0],Kk);let h=Number.MAX_VALUE,p=0;for(let y=0;y<o.length-5;y+=3){if(Po[0]=o[y]+r[12],Po[1]=o[y+1]+r[13],Po[2]=o[y+2]+r[14],Io[0]=o[y+3]+r[12],Io[1]=o[y+4]+r[13],Io[2]=o[y+5]+r[14],tr(Zk,Po)<0&&tr(Zk,Io)<0||tr(Qk,Po)<0&&tr(Qk,Io)<0||tr(Jk,Po)<0&&tr(Jk,Io)<0||tr(Kk,Po)<0&&tr(Kk,Io)<0)continue;if(a.projectToRenderScreen(Po,mv),a.projectToRenderScreen(Io,gv),mv[2]<0&&gv[2]>0){de(_d,Po,Io);const b=a.frustum,w=-tr(b[Wi.NEAR],Po)/_e(_d,b[Wi.NEAR]);ae(_d,_d,w),pe(Po,Po,_d),a.projectToRenderScreen(Po,mv)}else if(mv[2]>0&&gv[2]<0){de(_d,Io,Po);const b=a.frustum,w=-tr(b[Wi.NEAR],Io)/_e(_d,b[Wi.NEAR]);ae(_d,_d,w),pe(Io,Io,_d),a.projectToRenderScreen(Io,gv)}else if(mv[2]<0&&gv[2]<0)continue;mv[2]=0,gv[2]=0;const v=zj(u1(mv,gv,Vie),l);v<h&&(h=v,ne(zie,Po),ne(Bie,Io),p=y/3)}const f=s.rayBegin,g=s.rayEnd;if(h<c*c){let y=Number.MAX_VALUE;if(Iue(u1(zie,Bie,Vie),u1(f,g,jKe),fv)){de(fv,fv,f);const v=Pe(fv);ae(fv,fv,1/v),y=v/xi(f,g)}n(y,fv,p,!1)}}computeAttachmentOrigin(t,i){const r=t.vertexAttributes;if(!r)return!1;const s=r.get(E.POSITION);return Iq(s,null,!1,i)}requiresSlot(t){return t===ve.OPAQUE_MATERIAL||t===ve.DRAPED_MATERIAL}createGLMaterial(t){return t.output===j.Color||t.output===j.Highlight?new BKe(t):null}createBufferWriter(){const t=this.parameters.vertexColors?Ive:lZe;return R(this.parameters.stipplePattern)?new b4(t):new VKe(t.clone().vec3f(E.AUXPOS1).vec2f(E.UV0))}}class BKe extends Zm{updateParameters(t){return this.ensureTechnique(F4,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}beginSlot(t){return this._output===j.Color&&this._updateOccludeeState(t),this.updateParameters(t)}bind(t,i){i.bindPass(this._material.getPassParameters(),t)}}class VKe{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(E.POSITION).length}write(t,i,r,s){o4(i,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,r,s),this._writeAuxpos1(t,i,r,s),this._writeUV0(t,i,r,s)}_writeAuxpos1(t,i,r,s){const n=r.getField(E.AUXPOS1,Si),o=i.indices.get(E.POSITION),a=i.vertexAttributes.get(E.POSITION).data,l=t.transformation,c=n.typedBufferStride,h=n.typedBuffer;s*=c;for(let p=0;p<o.length-1;p+=2)for(const f of[1,0]){const g=3*o[p+f],y=a[g],v=a[g+1],b=a[g+2],w=l[0]*y+l[4]*v+l[8]*b+l[12],S=l[1]*y+l[5]*v+l[9]*b+l[13],T=l[2]*y+l[6]*v+l[10]*b+l[14];h[s]=w,h[s+1]=S,h[s+2]=T,s+=c}}_writeUV0(t,i,r,s){var n;const o=r.getField(E.UV0,Uu),a=i.indices.get(E.POSITION),l=i.vertexAttributes.get(E.POSITION).data,c=(n=i.vertexAttributes.get(E.DISTANCETOSTART))==null?void 0:n.data,h=t.transformation,p=o.typedBufferStride,f=o.typedBuffer;let g=0;f[s*=p]=eN.START,f[s+1]=g,s+=p;const y=3*a[0],v=oe(Po,l[y],l[y+1],l[y+2]);h&&ke(v,v,h);const b=Io,w=a.length-1;let S=1;const T=c?(C,O,L)=>g=c[L]:(C,O,L)=>g+=xi(C,O);for(let C=1;C<w;C+=2){const O=3*a[C];oe(b,l[O],l[O+1],l[O+2]),h&&ke(b,b,h),T(v,b,S++);for(let L=0;L<2;++L)f[s]=1-L,f[s+1]=g,s+=p;ne(v,b)}const A=3*a[w];oe(b,l[A],l[A+1],l[A+2]),h&&ke(b,b,h),T(v,b,S),f[s]=eN.END,f[s+1]=g}}const GKe=I({color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleOffColor:null,stipplePreferContinuous:!0,sceneHasOcludees:!1},ju),Po=M(),Io=M(),_d=M(),fv=M(),mv=zn(),gv=zn(),zie=M(),Bie=M(),Vie=z0(),jKe=z0(),HKe=M(),Q2=[zn(),zn(),zn(),zn()],nf=[M(),M(),M(),M()],Zk=ii(),Qk=ii(),Jk=ii(),Kk=ii(),qKe=["mesh"];class WKe extends Wp{constructor(t,i,r,s){super(t,i,r,s),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){hi.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new kie({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new kie({color:[0,1,1,1]}))}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),t=>t.material)),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,qKe,"fill on mesh-3d"))return null;const r=this.setGraphicElevationContext(i,new Mc),s=t.renderingInfo;return this._createAs3DShape(i,s,r,i.uid)}layerOpacityChanged(t,i){const r=this._getLayerOpacity();return this._materials.forEach(s=>{s.material.setParameters({layerOpacity:r});const n=s.material.parameters;this._setMaterialTransparentParameter(n,s),s.material.setParameters({transparent:n.transparent})}),t.forEach(s=>{const n=i(s);_(n)&&n.layerOpacityChanged(r,this._context.isAsync)}),!0}layerElevationInfoChanged(t,i){return this.updateGraphics3DGraphicElevationInfo(t,i,$0)}slicePlaneEnabledChanged(t,i){return this._materials.forEach(r=>{r.material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})}),t.forEach(r=>{const s=i(r);_(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const t=this._usePBR();return this._materials.forEach(i=>i.material.setParameters({usePBR:t})),!0}pixelRatioChanged(){return!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(t){return R(t)?"-":t instanceof Je?t.toHex():t.contentHash}_materialPropertiesDefault(t,i){const r=this._requiresSymbolVertexColors(),s=!!t.vertexAttributes.color,n=!!t.vertexAttributes.tangent;return{hasSymbolVertexColors:r,hasVertexColors:s,hasVertexTangents:n,uid:`vc:${s},vt:${n},vct${i},svc:${r}`}}_materialProperties(t,i,r){const s=this._materialPropertiesDefault(t,r);if(!i.material)return s;const{color:n,colorTexture:o,normalTexture:a,doubleSided:l,alphaCutoff:c,alphaMode:h}=i.material,p=this._colorOrTextureUid(n),f=this._colorOrTextureUid(o),g=this._colorOrTextureUid(a);if(s.color=n,s.colorTexture=o,s.normalTexture=a,s.uid=`${s.uid},cmuid:${p},ctmuid:${f},ntmuid:${g},ds:${l},ac:${c},am:${h}`,i.material instanceof O_e){const{metallic:y,roughness:v,metallicRoughnessTexture:b,emissiveColor:w,emissiveTexture:S,occlusionTexture:T}=i.material,A=this._colorOrTextureUid(b),C=this._colorOrTextureUid(w),O=this._colorOrTextureUid(S),L=this._colorOrTextureUid(T);s.metallic=y,s.roughness=v,s.metallicRoughnessTexture=b,s.emissiveColor=w,s.emissiveTexture=S,s.occlusionTexture=T,s.uid=`${s.uid},mrm:${y},mrr:${v},mrt:${A},emuid:${C},etmuid:${O},otmuid:${L}`}return s}_setInternalColorValueParameters(t,i){i.diffuse=Je.toUnitRGB(t),i.opacity=t.a}_getLoadableTextureResource(t){return t.data?t.data:t.url}_getInternalTextureId(t){const i=this._getInternalTexture(t,Ri.Opaque);return _(i)?i.id:null}_getInternalTexture(t,i){const r=this._getLoadableTextureResource(t);if(!r)return null;const s=`${t.contentHash}/${i}`;let n=this._textures.get(s);return n||(n=new rs(r,{mipmap:!0,wrap:this._castTextureWrap(t.wrap),noUnpackFlip:!0,preMultiplyAlpha:i!==Ri.Opaque}),this._textures.set(s,n),this._context.stage.add(n),this._context.stage.loadImmediate(n)),n}_castTextureWrap(t="repeat"){if(typeof t=="string"){const i=this._castTextureWrapIndividual(t);return{s:i,t:i}}return{s:this._castTextureWrapIndividual(t.horizontal),t:this._castTextureWrapIndividual(t.vertical)}}_castTextureWrapIndividual(t){switch(t){case"clamp":return ct.CLAMP_TO_EDGE;case"mirror":return ct.MIRRORED_REPEAT;default:return ct.REPEAT}}_setInternalMaterialParameters(t,i){if(_(t.color)&&this._setInternalColorValueParameters(t.color,i),_(t.colorTexture)){const r=this._getInternalTexture(t.colorTexture,i.textureAlphaMode);_(r)?(i.textureId=r.id,i.textureAlphaPremultiplied=!!r.params.preMultiplyAlpha):i.textureId=void 0}_(t.normalTexture)&&(i.normalTextureId=this._getInternalTextureId(t.normalTexture)),_(t.emissiveColor)&&(i.emissiveFactor=Je.toUnitRGB(t.emissiveColor)),_(t.emissiveTexture)&&(i.emissiveTextureId=this._getInternalTextureId(t.emissiveTexture)),_(t.occlusionTexture)&&(i.occlusionTextureId=this._getInternalTextureId(t.occlusionTexture)),_(t.metallicRoughnessTexture)&&(i.metallicRoughnessTextureId=this._getInternalTextureId(t.metallicRoughnessTexture))}_setExternalMaterialParameters(t){const i=this._drivenProperties.color;let r=_(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(i)t.externalColor=ap;else{const s=_(this.symbolLayer.material)?this.symbolLayer.material.color:null;_(s)?t.externalColor=Je.toUnitRGBA(s):(r=null,t.externalColor=ap)}r&&(t.colorMixMode=r),t.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(t){const i=t.vertexAttributes.color;if(R(i))return!1;for(let r=3;r<i.length;r+=4)if(i[r]!==255)return!0;return!1}_getOrCreateMaterial(t,i){var r,s,n;const o=(r=i.material)==null?void 0:r.color,a=(s=i.material)==null?void 0:s.colorTexture,l=(n=i.material)==null?void 0:n.alphaMode,c=l==="blend",h=l!=="opaque"&&(this._hasTransparentVertexColors(t)||_(o)&&o.a<1||_(a)&&a.transparent||c),p=this._materialProperties(t,i,h),f=this._materials.get(p.uid);if(f)return f.material;const g={material:null,isComponentTransparent:h,alphaMode:i.material?i.material.alphaMode:"opaque"},y=p.metallicRoughnessTexture==null&&p.metallic==null&&p.roughness==null,v={usePBR:this._usePBR(),isSchematic:y,vertexColors:p.hasVertexColors,symbolColors:p.hasSymbolVertexColors,vertexTangents:p.hasVertexTangents,ambient:pl,diffuse:up,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:Di.None,layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,initTextureTransparent:!0};y||(v.mrrFactors=[p.metallic!=null?p.metallic:1,p.roughness!=null?p.roughness:1,.5]),i.material&&(v.doubleSided=i.material.doubleSided,v.cullFace=i.material.doubleSided?Di.None:Di.Back,v.textureAlphaCutoff=i.material.alphaCutoff),this._setExternalMaterialParameters(v),this._setMaterialTransparentParameter(v,g),this._setInternalMaterialParameters(p,v);const b=new K1(v);return g.material=b,this._materials.set(p.uid,g),this._context.stage.add(b),b}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(t,i){t.transparent=this.needsDrivenTransparentPass||i.isComponentTransparent||t.layerOpacity<1||t.opacity<1||t.externalColor&&t.externalColor[3]<1,i.alphaMode==="auto"?t.textureAlphaMode=t.transparent?Ri.MaskBlend:Ri.Opaque:t.textureAlphaMode=i.alphaMode==="opaque"?Ri.Opaque:i.alphaMode==="mask"?Ri.Mask:Ri.Blend}_addDebugNormals(t,i,r,s){const n=i.length,o=t.spatialReference.isGeographic?20015077/180:1,a=.1*Math.max(t.extent.width*o,t.extent.height*o,t.extent.zmax-t.extent.zmin),l=[],c=[],h=[],p=[];for(let y=0;y<n;y++){const v=i[y],b=v.vertexAttributes.get(E.POSITION),w=v.vertexAttributes.get(E.NORMAL),S=v.indices.get(E.POSITION),T=v.indices.get(E.NORMAL),A=b.data,C=w.data;for(let O=0;O<S.length;O++){const L=3*S[O],U=3*T[O];for(let N=0;N<3;N++)l.push(A[L+N]);for(let N=0;N<3;N++)l.push(A[L+N]+C[U+N]*a);if(c.push(c.length),c.push(c.length),O%3==0){this._calculateFaceNormal(A,S,O,Jb),this._getFaceVertices(A,S,O,Cn,Zb,Qb),pe(Cn,Cn,Zb),pe(Cn,Cn,Qb),ae(Cn,Cn,1/3);for(let N=0;N<3;N++)h.push(Cn[N]);for(let N=0;N<3;N++)h.push(Cn[N]+Jb[N]*a);p.push(p.length),p.push(p.length)}}}const f=new lr([[E.POSITION,{data:l,size:3,exclusive:!0}]],[[E.POSITION,new Uint32Array(c)]],Aa.Line);i.push(f),r.push(this._debugVertexNormalMaterial),s.push(l1(s[0]));const g=new lr([[E.POSITION,{data:h,size:3,exclusive:!0}]],[[E.POSITION,new Uint32Array(p)]],Aa.Line);i.push(g),r.push(this._debugFaceNormalMaterial),s.push(l1(s[0]))}_createAs3DShape(t,i,r,s){const n=t.geometry;if(n.type!=="mesh")return null;const o=this._createGeometryInfo(n,i);if(!o)return null;const{geometries:a,materials:l,transformations:c,objectTransformation:h}=o;hi.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(n,a,l,c);const p=new tg({geometries:a,materials:l,transformations:c,metadata:{layerUid:this._context.layer.uid,graphicUid:s}});p.transformation=h;const f=this._createEdgeMaterial(),g=_(f)?{baseMaterial:l[0],edgeMaterials:[f],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,y=new qp(this,p,a,null,null,IR,r,g);return y.needsElevationUpdates=$0(r.mode),y.useObjectOriginAsAttachmentOrigin=!0,y.elevationContext.centerPointInElevationSR=this._getCenterPointInElevationSR(p),y.alignedSampledElevation=IR(y,y.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),y}_getCenterPointInElevationSR(t){const i=eg(0,0,0,this._context.elevationProvider.spatialReference);return sue([t.transformation[12],t.transformation[13],t.transformation[14]],this._context.renderCoordsHelper.spatialReference,i),i}_createComponentNormals(t,i,r,s){switch(r.shading||"flat"){case"source":return this._createComponentNormalsSource(t,i,r,s);case"flat":return this._createComponentNormalsFlat(t,s);case"smooth":return this._createComponentNormalsSmooth(t,s);default:return}}_createComponentNormalsSource(t,i,r,s){if(R(i))return this._createComponentNormalsFlat(t,s);let n=!1;if(!r.trustSourceNormals)for(let o=0;o<s.length;o+=3){this._calculateFaceNormal(t,s,o,Jb);for(let a=0;a<3;a++){const l=3*s[o+a];Cn[0]=i[l+0],Cn[1]=i[l+1],Cn[2]=i[l+2],_e(Jb,Cn)<0&&(i[l+0]=-i[l+0],i[l+1]=-i[l+1],i[l+2]=-i[l+2],n=!0)}}return{normals:i,indices:s,didFlipNormals:n}}_createComponentNormalsFlat(t,i){const r=new Float32Array(i.length),s=new Uint32Array(3*i.length);for(let n=0;n<i.length;n+=3){const o=this._calculateFaceNormal(t,i,n,Jb);for(let a=0;a<3;a++)r[n+a]=o[a],s[n+a]=n/3}return{normals:r,indices:s,didFlipNormals:!1}}_createComponentNormalsSmooth(t,i){const r={};for(let o=0;o<i.length;o+=3){const a=this._calculateFaceNormal(t,i,o,Jb);for(let l=0;l<3;l++){const c=i[o+l];let h=r[c];h||(h={normal:M(),count:0},r[c]=h),pe(h.normal,h.normal,a),h.count++}}const s=new Float32Array(3*i.length),n=new Uint32Array(3*i.length);for(let o=0;o<i.length;o++){const a=r[i[o]];a.count!==1&&(be(a.normal,a.normal),a.count=1);for(let l=0;l<3;l++)s[3*o+l]=a.normal[l];n[o]=o}return{normals:s,indices:n,didFlipNormals:!1}}_getFaceVertices(t,i,r,s,n,o){const a=3*i[r+0],l=3*i[r+1],c=3*i[r+2];s[0]=t[a+0],s[1]=t[a+1],s[2]=t[a+2],n[0]=t[l+0],n[1]=t[l+1],n[2]=t[l+2],o[0]=t[c+0],o[1]=t[c+1],o[2]=t[c+2]}_calculateFaceNormal(t,i,r,s){return this._getFaceVertices(t,i,r,Cn,Zb,Qb),de(Zb,Zb,Cn),de(Qb,Qb,Cn),pt(Cn,Zb,Qb),be(s,Cn),s}_getOrCreateComponents(t){return gt(t.components,XKe)}_createPositionBuffer(t,i){let r=t.vertexAttributes.position;const s=i.reprojection===Hl.ECEF?i.transformBeforeProject:null;if(_(s)&&(r=$Ke(r,new Float64Array(r.length),s)),i.reprojection===Hl.NONE)return i.needsBufferCopy?new Float64Array(r):r;const n=_(s)?r:new Float64Array(r.length);return br(r,t.spatialReference,0,n,this._context.renderCoordsHelper.spatialReference,0,r.length/3),n}_createNormalBuffer(t,i,r){let s=t.vertexAttributes.normal;if(R(s))return null;const n=r.reprojection===Hl.ECEF?r.transformBeforeProject:null;if(_(n)&&(s=DKe(s,new Float32Array(s.length),n)),this._context.graphicsCoreOwner.view.viewingMode==="local"||r.reprojection===Hl.NONE)return r.needsBufferCopy&&t.vertexAttributes.normal===s?new Float32Array(s):s;const o=t.vertexAttributes.position,a=_(n)?s:new Float32Array(s.length);return IKe(s,o,i,t.spatialReference,a)}_createTangentBuffer(t,i,r){let s=t.vertexAttributes.tangent;if(R(s))return null;const n=r.reprojection===Hl.ECEF?r.transformBeforeProject:null;if(_(n)&&(s=LKe(s,new Float32Array(s.length),n)),this._context.graphicsCoreOwner.view.viewingMode==="local"||r.reprojection===Hl.NONE)return r.needsBufferCopy&&t.vertexAttributes.normal===s?new Float32Array(s):s;const o=t.vertexAttributes.position,a=_(n)?s:new Float32Array(s.length);return NKe(s,o,i,t.spatialReference,a)}_createColorBuffer(t){return t.vertexAttributes.color}_createSymbolColorBuffer(t){if(this._requiresSymbolVertexColors()){const i=this._getVertexOpacityAndColor(t),r=PQe(Pr(this.symbolLayer,"material","colorMixMode")),s=new Uint8Array(4);return l_e(i,r,s),s}return null}_createBuffers(t,i){const r=t.vertexAttributes&&t.vertexAttributes.position;if(!r)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const s=t.vertexAttributes.normal,n=t.vertexAttributes.uv,o=t.vertexAttributes.tangent;if(_(s)&&s.length!==r.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(_(o)&&o.length/4!=r.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(_(n)&&n.length/2!=r.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const a=this._computeReprojectionInfo(t),l=this._createPositionBuffer(t,a),c=this._createColorBuffer(t),h=this._createSymbolColorBuffer(i),p=this._createNormalBuffer(t,l,a),f=this._createTangentBuffer(t,l,a);return{positionBuffer:l,normalBuffer:p,tangentBuffer:f,uvBuffer:n,colorBuffer:c,symbolColorBuffer:h,objectTransformation:a.reprojection===Hl.NONE&&_(a.objectTransformation)?a.objectTransformation:this._transformOriginLocal(t,l,p,f),geometryTransformation:a.reprojection===Hl.NONE&&_(a.geometryTransformation)?a.geometryTransformation:Te()}}_computeReprojectionInfo(t){const i=_(t.transform),r=i&&t.transform.geographic||this._context.renderCoordsHelper.viewingMode===Ie.Local?Hl.NONE:Hl.ECEF;if(i){if(r===Hl.NONE){const n=Te();return Kh(t.spatialReference,t.transform.origin,n,this._context.renderCoordsHelper.spatialReference),{reprojection:r,objectTransformation:n,geometryTransformation:l1(t.transform.localMatrix),needsBufferCopy:!1}}const s=rF(Te(),t.transform.origin);return dr(s,s,t.transform.localMatrix),{reprojection:r,transformBeforeProject:s,needsBufferCopy:!0}}return{reprojection:r,needsBufferCopy:!0}}_transformOriginLocal(t,i,r,s){const n=this._context.renderCoordsHelper.spatialReference,o=t.anchor;X3[0]=o.x,X3[1]=o.y,X3[2]=o.z;const a=Te();Kh(t.spatialReference,X3,a,n);const l=Xr.fromTypedArray(i);if(fr(Gie,a),GO(l,l,Gie),_(r)||_(s)){if(Lu(J2,a),Nu(J2,J2),_(r)){const c=Si.fromTypedArray(r);Z1(c,c,J2)}if(_(s)){const c=Si.fromTypedArray(s,4*s.BYTES_PER_ELEMENT);Z1(c,c,J2)}}return a}_validateFaces(t,i){const r=t.vertexAttributes.position.length/3,s=i.faces;if(s){let n=-1;for(let o=0;o<s.length;o++){const a=s[o];a>n&&(n=a)}if(r<=n)return this.logger.warn(`Vertex index ${n} is out of bounds of the mesh position buffer`),!1}else if(r%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(t,i){return i.faces?i.faces:vS(t.vertexAttributes.position.length/3)}_isOutsideClippingArea(t){if(!this._context.clippingExtent)return!1;const i=t.vertexAttributes&&t.vertexAttributes.position;if(!i)return!1;const r=this._context.elevationProvider.spatialReference;let s;const n=i.length/3;return t.spatialReference.equals(r)?s=i:(s=new Float64Array(i.length),br(t.vertexAttributes.position,t.spatialReference,0,s,r,0,n)),ki(ez),uc(ez,s,0,n),!Uh(ez,this._context.clippingExtent)}_createGeometryInfo(t,i){if(!M1(t.spatialReference,this._context.graphicsCoreOwner.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(t))return null;const r=this._createBuffers(t,i);if(R(r))return null;const{positionBuffer:s,uvBuffer:n,colorBuffer:o,symbolColorBuffer:a,normalBuffer:l,tangentBuffer:c,objectTransformation:h,geometryTransformation:p}=r,f=this._getOrCreateComponents(t),g=[],y=[],v=[];let b=!1;for(const w of f){if(!this._validateFaces(t,w))return null;const S=this._getOrCreateFaces(t,w);if(S.length===0)continue;const T=this._createComponentNormals(s,l,w,S);T.didFlipNormals&&(b=!0);const A=[[E.POSITION,{size:3,data:s,exclusive:!0}],[E.NORMAL,{size:3,data:T.normals,exclusive:!0}]],C=[[E.POSITION,S],[E.NORMAL,T.indices]];_(o)&&(A.push([E.COLOR,{size:4,data:o,exclusive:!0}]),C.push([E.COLOR,S])),_(a)&&(A.push([E.SYMBOLCOLOR,{size:4,data:a,exclusive:!0}]),C.push([E.SYMBOLCOLOR,new Uint16Array(S.length)])),_(n)&&(A.push([E.UV0,{size:2,data:n,exclusive:!0}]),C.push([E.UV0,S])),_(c)&&(A.push([E.TANGENT,{size:4,data:c,exclusive:!0}]),C.push([E.TANGENT,S]));const O=new lr(A,C);g.push(O),y.push(p),v.push(this._getOrCreateMaterial(t,w))}return b&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:g,transformations:y,materials:v,objectTransformation:h}}_createEdgeMaterial(){const t={opacity:this._getLayerOpacity()};return mve(this.symbolLayer,t)}}const X3=M(),Cn=M(),Zb=M(),Qb=M(),Jb=M(),Gie=Te(),J2=wr(),ez=cs(),XKe=[new PKe];var Hl;(function(e){e[e.NONE=0]="NONE",e[e.ECEF=1]="ECEF"})(Hl||(Hl={}));class YKe{constructor(t,i,r,s){this.graphics3DSymbolLayer=t,this.instanceIndex=i,this.elevationAligner=r,this.elevationContext=s,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(t){const i=this.lodRenderer.instanceData;t!==i.getVisible(this.instanceIndex)&&i.setVisible(this.instanceIndex,t)}destroy(){this.instanceIndex!=null&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(t,i,r){if(this.elevationAligner){bW(this.elevationContext.featureExpressionInfoContext,r);const s=this.elevationAligner(this,this.elevationContext,t,i);_(s)&&(this.alignedSampledElevation=s)}}getCenterObjectSpace(t=M()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,bd),ke(t,this.lodRenderer.baseBoundingSphere.center,bd)}getBoundingBoxObjectSpace(t=cs()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,bd);const i=this.lodRenderer.baseBoundingBox;ki(t);for(let r=0;r<8;++r)oe(Uc,(1&r)==0?i[0]:i[3],(2&r)==0?i[1]:i[4],(4&r)==0?i[2]:i[5]),ke(Uc,Uc,bd),Tp(t,Uc);return t}computeAttachmentOrigin(t){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,bd),t.render.origin[0]+=bd[12],t.render.origin[1]+=bd[13],t.render.origin[2]+=bd[14],t.render.num++}async getProjectedBoundingBox(t,i,r,s,n){const o=this.getBoundingBoxObjectSpace(n),a=ZKe,l=jN(o)?1:a.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,bd);for(let h=0;h<l;h++){const p=a[h];Uc[0]=o[p[0]],Uc[1]=o[p[1]],Uc[2]=o[p[2]],ke(Uc,Uc,bd),yv[3*h+0]=Uc[0],yv[3*h+1]=Uc[1],yv[3*h+2]=Uc[2]}if(!t(yv,0,l))return null;ki(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],yv[h+p]),o[p+3]=Math.max(o[p+3],yv[h+p]);c&&r.push({location:yv.slice(h,h+3),screenSpaceBoundingRect:c})}if(i&&(Fh(o,tz),this.elevationContext.mode!=="absolute-height")){let h;const p=vW(o,i);try{h=await i.service.queryElevation(tz[0],tz[1],s,p,"ground")}catch{}_(h)&&Dle(o,0,0,-this.alignedSampledElevation+h)}return o}addObjectState(t,i){if(t===Im.Highlight){const r=new jL(t);this._addHighlightId(r),i.addExternal(s=>{this._removeHighlightId(s)},r)}}removeObjectState(t){this._highlights.forEach(i=>t.remove(i))}_addHighlightId(t){this._highlights.add(t),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(t){this._highlights.delete(t),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const yv=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Uc=M(),tz=M(),ZKe=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],bd=Te();function QKe(e){const t=[];return e.stageResources.geometries.forEach((i,r)=>{const s=e.stageResources.materials[r],n=e.stageResources.textures;t.push({material:s,geometry:i,textures:n})}),{components:t,minScreenSpaceRadius:e.lodThreshold,pivotOffset:e.pivotOffset}}function JKe(e){return{levels:e.map(t=>QKe(t))}}function KKe(e,t=tet){const i=aYe(e);return Math.sqrt(i/(t*Math.PI))}function eet(e){e.levels.forEach(t=>{t.minScreenSpaceRadius||(t.minScreenSpaceRadius=KKe(t))})}const tet=.05;function Xyt(e){return e=e||globalThis.location.hostname,ret.some(t=>{var i;return((i=e)==null?void 0:i.match(t))!=null})}function iet(e,t){return e&&(t=t||globalThis.location.hostname)?t.match(P_e)!=null||t.match($_e)!=null?e.replace("static.arcgis.com","staticdev.arcgis.com"):t.match(I_e)!=null||t.match(D_e)!=null?e.replace("static.arcgis.com","staticqa.arcgis.com"):e:e}const P_e=/^devext.arcgis.com$/,I_e=/^qaext.arcgis.com$/,$_e=/^[\w-]*\.mapsdevext.arcgis.com$/,D_e=/^[\w-]*\.mapsqa.arcgis.com$/,ret=[/^([\w-]*\.)?[\w-]*\.zrh-dev-local.esri.com$/,P_e,I_e,/^jsapps.esri.com$/,$_e,D_e];function set(e,t,i){if(e.count!==t.count)return void f4.error("source and destination buffers need to have the same number of elements");const r=e.count,s=i[0],n=i[1],o=i[2],a=i[3],l=i[4],c=i[5],h=i[6],p=i[7],f=i[8],g=i[9],y=i[10],v=i[11],b=i[12],w=i[13],S=i[14],T=i[15],A=e.typedBuffer,C=e.typedBufferStride,O=t.typedBuffer,L=t.typedBufferStride;for(let U=0;U<r;U++){const N=U*C,z=U*L,V=O[z],B=O[z+1],J=O[z+2],Q=O[z+3];A[N]=s*V+l*B+f*J+b*Q,A[N+1]=n*V+c*B+g*J+w*Q,A[N+2]=o*V+h*B+y*J+S*Q,A[N+3]=a*V+p*B+v*J+T*Q}}function L_e(e,t,i){if(e.count!==t.count)return void f4.error("source and destination buffers need to have the same number of elements");const r=e.count,s=i[0],n=i[1],o=i[2],a=i[3],l=i[4],c=i[5],h=i[6],p=i[7],f=i[8],g=e.typedBuffer,y=e.typedBufferStride,v=t.typedBuffer,b=t.typedBufferStride;for(let w=0;w<r;w++){const S=w*y,T=w*b,A=v[T],C=v[T+1],O=v[T+2],L=v[T+3];g[S]=s*A+a*C+h*O,g[S+1]=n*A+l*C+p*O,g[S+2]=o*A+c*C+f*O,g[S+3]=L}}function cG(e,t,i){const r=Math.min(e.count,t.count),s=e.typedBuffer,n=e.typedBufferStride,o=t.typedBuffer,a=t.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=i*o[h],s[c+1]=i*o[h+1],s[c+2]=i*o[h+2],s[c+3]=i*o[h+3]}}function net(e,t,i){const r=Math.min(e.count,t.count),s=e.typedBuffer,n=e.typedBufferStride,o=t.typedBuffer,a=t.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=o[h]>>i,s[c+1]=o[h+1]>>i,s[c+2]=o[h+2]>>i,s[c+3]=o[h+3]>>i}}Object.freeze({__proto__:null,transformMat4:set,transformMat3:L_e,scale:cG,shiftRight:net});function oet(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h){for(let p=0;p<9;++p)r[l+p]=n[c+p];l+=s,c+=o}}Object.freeze({__proto__:null,copy:oet});function aet(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h){for(let p=0;p<16;++p)r[l+p]=n[c+p];l+=s,c+=o}}Object.freeze({__proto__:null,copy:aet});function cet(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],l+=s,c+=o}function C$(e,t){const i=e.count;t||(t=new e.TypedArrayConstructor(i));for(let r=0;r<i;r++)t[r]=e.get(r);return t}Object.freeze({__proto__:null,copy:cet,makeDense:C$});function N_e(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],r[l+1]=n[c+1],l+=s,c+=o}function F_e(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;if(z9e(t.elementType)){const h=B9e(t.elementType);if(k9e(t.elementType))for(let p=0;p<a;++p)r[l]=Math.max(n[c]/h,-1),r[l+1]=Math.max(n[c+1]/h,-1),l+=s,c+=o;else for(let p=0;p<a;++p)r[l]=n[c]/h,r[l+1]=n[c+1]/h,l+=s,c+=o}else N_e(e,t,i);return e}function uet(e,t,i,r){var s,n;const o=e.typedBuffer,a=e.typedBufferStride,l=(s=r==null?void 0:r.count)!=null?s:e.count;let c=((n=r==null?void 0:r.dstIndex)!=null?n:0)*a;for(let h=0;h<l;++h)o[c]=t,o[c+1]=i,c+=a}Object.freeze({__proto__:null,copy:N_e,normalizeIntegerBuffer:F_e,fill:uet});function zW(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],r[l+1]=n[c+1],r[l+2]=n[c+2],l+=s,c+=o}function het(e,t,i,r,s){var n,o;const a=e.typedBuffer,l=e.typedBufferStride,c=(n=s==null?void 0:s.count)!=null?n:e.count;let h=((o=s==null?void 0:s.dstIndex)!=null?o:0)*l;for(let p=0;p<c;++p)a[h]=t,a[h+1]=i,a[h+2]=r,h+=l}Object.freeze({__proto__:null,copy:zW,fill:het});function U_e(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],r[l+1]=n[c+1],r[l+2]=n[c+2],r[l+3]=n[c+3],l+=s,c+=o}function k_e(e,t,i,r,s,n){var o,a;const l=e.typedBuffer,c=e.typedBufferStride,h=(o=n==null?void 0:n.count)!=null?o:e.count;let p=((a=n==null?void 0:n.dstIndex)!=null?a:0)*c;for(let f=0;f<h;++f)l[p]=t,l[p+1]=i,l[p+2]=r,l[p+3]=s,p+=c}Object.freeze({__proto__:null,copy:U_e,fill:k_e});function z_(e,t){return new e(new ArrayBuffer(t*e.ElementCount*Hge(e.ElementType)))}class z_e{constructor(t){this.streamDataRequester=t}async loadJSON(t,i){return this._load("json",t,i)}async loadBinary(t,i){return Up(t)?(Qt(i),Xle(t)):this._load("binary",t,i)}async loadImage(t,i){return this._load("image",t,i)}async _load(t,i,r){if(R(this.streamDataRequester))return(await Ti(i,{responseType:det[t]})).data;const s=await wl(this.streamDataRequester.request(i,t,r));if(s.ok===!0)return s.value;throw zm(s.error),new q("",`Request for resource failed: ${s.error}`)}}const det={image:"image",binary:"array-buffer",json:"json"},pet=he.getLogger("esri.views.3d.glTF");class fet{error(t){throw new q("gltf-loader-error",t)}errorUnsupported(t){throw new q("gltf-loader-unsupported-feature",t)}errorUnsupportedIf(t,i){t&&this.errorUnsupported(i)}assert(t,i){t||this.error(i)}warn(t){pet.warn(t)}warnUnsupported(t){this.warn("[Unsupported Feature] "+t)}warnUnsupportedIf(t,i){t&&this.warnUnsupported(i)}}function met(e={}){return I({color:[1,1,1],opacity:1,alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1,castShadows:!0,receiveShadows:!0,receiveAmbientOcclustion:!0,textureColor:null,textureNormal:null,textureOcclusion:null,textureEmissive:null,textureMetallicRoughness:null,emissiveFactor:[0,0,0],metallicFactor:1,roughnessFactor:1,colorMixMode:"multiply"},e)}function get(e,t={}){return{data:e,parameters:I({wrap:I({s:ct.REPEAT,t:ct.REPEAT},t.wrap),noUnpackFlip:!0,mipmap:!1},t)}}class L0{constructor(t,i,r=""){this.major=t,this.minor=i,this._context=r}lessThan(t,i){return this.major<t||t===this.major&&this.minor<i}since(t,i){return!this.lessThan(t,i)}validate(t){if(this.major!==t.major){const i=this._context&&this._context+":",r=this._context&&this._context+" ";throw new q(i+"unsupported-version",`Required major ${r}version is '${this.major}', but got '\${version.major}.\${version.minor}'`,{version:t})}}clone(){return new L0(this.major,this.minor,this._context)}static parse(t,i=""){const[r,s]=t.split("."),n=/^\s*\d+\s*$/;if(!r||!r.match||!r.match(n))throw new q((i&&i+":")+"invalid-version","Expected major version to be a number, but got '${version}'",{version:t});if(!s||!s.match||!s.match(n))throw new q((i&&i+":")+"invalid-version","Expected minor version to be a number, but got '${version}'",{version:t});const o=parseInt(r,10),a=parseInt(s,10);return new L0(o,a,i)}}class jie{constructor(t){this.data=t,this.offset4=0,this.dataUint32=new Uint32Array(this.data,0,Math.floor(this.data.byteLength/4))}readUint32(){const t=this.offset4;return this.offset4+=1,this.dataUint32[t]}readUint8Array(t){const i=4*this.offset4;return this.offset4+=t/4,new Uint8Array(this.data,i,t)}remainingBytes(){return this.data.byteLength-4*this.offset4}}var xC,Hie;(function(e){e.SCALAR="SCALAR",e.VEC2="VEC2",e.VEC3="VEC3",e.VEC4="VEC4",e.MAT2="MAT2",e.MAT3="MAT3",e.MAT4="MAT4"})(xC||(xC={})),function(e){e[e.ARRAY_BUFFER=34962]="ARRAY_BUFFER",e[e.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"}(Hie||(Hie={}));const B_e={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1},yet={pbrMetallicRoughness:B_e,emissiveFactor:[0,0,0],alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1},vet={ESRI_externalColorMixMode:"tint"},qie=(e={})=>{const t=I(I({},B_e),e.pbrMetallicRoughness),i=_et(I(I({},vet),e.extras));return me(I(I({},yet),e),{pbrMetallicRoughness:t,extras:i})};function _et(e){switch(e.ESRI_externalColorMixMode){case"multiply":case"tint":case"ignore":case"replace":break;default:e.ESRI_externalColorMixMode,e.ESRI_externalColorMixMode="tint"}return e}const bet={magFilter:Ge.LINEAR,minFilter:Ge.LINEAR_MIPMAP_LINEAR,wrapS:ct.REPEAT,wrapT:ct.REPEAT},wet=e=>I(I({},bet),e);function xet(e){let t,i;return e.replace(/^(.*\/)?([^/]*)$/,(r,s,n)=>(t=s||"",i=n||"","")),{dirPart:t,filePart:i}}const Y3={MAGIC:1179937895,CHUNK_TYPE_JSON:1313821514,CHUNK_TYPE_BIN:5130562,MIN_HEADER_LENGTH:20};class Yf{constructor(t,i,r,s,n){this.context=t,this.errorContext=i,this.uri=r,this.json=s,this.glbBuffer=n,this.bufferLoaders=new Map,this.textureLoaders=new Map,this.textureCache=new Map,this.materialCache=new Map,this.nodeParentMap=new Map,this.nodeTransformCache=new Map,this.baseUri=xet(this.uri).dirPart,this._checkVersionSupported(),this._checkRequiredExtensionsSupported(),i.errorUnsupportedIf(s.scenes==null,"Scenes must be defined."),i.errorUnsupportedIf(s.meshes==null,"Meshes must be defined"),i.errorUnsupportedIf(s.nodes==null,"Nodes must be defined."),this._computeNodeParents()}static async load(t,i,r,s){if(Up(r)){const a=WN(r);if(a.mediaType!=="model/gltf-binary")try{const c=JSON.parse(a.isBase64?atob(a.data):a.data);return new Yf(t,i,r,c)}catch{}const l=Xle(r);if(Yf._isGLBData(l))return this._fromGLBData(t,i,r,l)}if(r.endsWith(".gltf")){const a=await t.loadJSON(r,s);return new Yf(t,i,r,a)}const n=await t.loadBinary(r,s);if(Yf._isGLBData(n))return this._fromGLBData(t,i,r,n);const o=await t.loadJSON(r,s);return new Yf(t,i,r,o)}static _isGLBData(t){const i=new jie(t);return i.remainingBytes()>=4&&i.readUint32()===Y3.MAGIC}static async _fromGLBData(t,i,r,s){const n=await Yf._parseGLBData(i,s);return new Yf(t,i,r,n.json,n.binaryData)}static async _parseGLBData(t,i){const r=new jie(i);t.assert(r.remainingBytes()>=12,"GLB binary data is insufficiently large.");const s=r.readUint32(),n=r.readUint32(),o=r.readUint32();t.assert(s===Y3.MAGIC,"Magic first 4 bytes do not fit to expected GLB value."),t.assert(i.byteLength>=o,"GLB binary data is smaller than header specifies."),t.errorUnsupportedIf(n!==2,"An unsupported GLB container version was detected. Only version 2 is supported.");let a,l,c=0;for(;r.remainingBytes()>=8;){const h=r.readUint32(),p=r.readUint32();c===0?(t.assert(p===Y3.CHUNK_TYPE_JSON,"First GLB chunk must be JSON."),t.assert(h>=0,"No JSON data found."),a=await Oet(r.readUint8Array(h))):c===1?(t.errorUnsupportedIf(p!==Y3.CHUNK_TYPE_BIN,"Second GLB chunk expected to be BIN."),l=r.readUint8Array(h)):t.warnUnsupported("More than 2 GLB chunks detected. Skipping."),c+=1}return a||t.error("No GLB JSON chunk detected."),{json:a,binaryData:l}}async getBuffer(t,i){const r=this.json.buffers[t],s=this.errorContext;if(r.uri==null)return s.assert(this.glbBuffer!=null,"GLB buffer not present"),this.glbBuffer;const n=await this._getBufferLoader(t,i);return s.assert(n.byteLength===r.byteLength,"Buffer byte lengths should match."),n}async _getBufferLoader(t,i){const r=this.bufferLoaders.get(t);if(r)return r;const s=this.json.buffers[t],n=this.context.loadBinary(this._resolveUri(s.uri),i).then(o=>new Uint8Array(o));return this.bufferLoaders.set(t,n),n}async getAccessor(t,i){const r=this.errorContext;r.errorUnsupportedIf(!this.json.accessors,"Accessors missing.");const s=this.json.accessors[t];r.errorUnsupportedIf((s==null?void 0:s.bufferView)==null,"Some accessor does not specify a bufferView."),r.errorUnsupportedIf(s.type in[xC.MAT2,xC.MAT3,xC.MAT4],`AttributeType ${s.type} is not supported`);const n=this.json.bufferViews[s.bufferView],o=await this.getBuffer(n.buffer,i),a=Aet[s.type],l=Cet[s.componentType],c=a*l,h=n.byteStride||c;return{raw:o.buffer,byteStride:h,byteOffset:o.byteOffset+(n.byteOffset||0)+(s.byteOffset||0),entryCount:s.count,isDenselyPacked:h===c,componentCount:a,componentByteSize:l,componentType:s.componentType,min:s.min,max:s.max,normalized:!!s.normalized}}async getIndexData(t,i){if(t.indices==null)return null;const r=await this.getAccessor(t.indices,i);if(r.isDenselyPacked)switch(r.componentType){case ot.UNSIGNED_BYTE:return new Uint8Array(r.raw,r.byteOffset,r.entryCount);case ot.UNSIGNED_SHORT:return new Uint16Array(r.raw,r.byteOffset,r.entryCount);case ot.UNSIGNED_INT:return new Uint32Array(r.raw,r.byteOffset,r.entryCount)}else switch(r.componentType){case ot.UNSIGNED_BYTE:return C$(this._wrapAccessor($m,r));case ot.UNSIGNED_SHORT:return C$(this._wrapAccessor(V1,r));case ot.UNSIGNED_INT:return C$(this._wrapAccessor(j1,r))}}async getPositionData(t,i){const r=this.errorContext;r.errorUnsupportedIf(t.attributes.POSITION==null,"No POSITION vertex data found.");const s=await this.getAccessor(t.attributes.POSITION,i);return r.errorUnsupportedIf(s.componentType!==ot.FLOAT,"Expected type FLOAT for POSITION vertex attribute, but found "+Q3[s.componentType]),r.errorUnsupportedIf(s.componentCount!==3,"POSITION vertex attribute must have 3 components, but found "+s.componentCount.toFixed()),this._wrapAccessor(Si,s)}async getNormalData(t,i){const r=this.errorContext;r.assert(t.attributes.NORMAL!=null,"No NORMAL vertex data found.");const s=await this.getAccessor(t.attributes.NORMAL,i);return r.errorUnsupportedIf(s.componentType!==ot.FLOAT,"Expected type FLOAT for NORMAL vertex attribute, but found "+Q3[s.componentType]),r.errorUnsupportedIf(s.componentCount!==3,"NORMAL vertex attribute must have 3 components, but found "+s.componentCount.toFixed()),this._wrapAccessor(Si,s)}async getTangentData(t,i){const r=this.errorContext;r.assert(t.attributes.TANGENT!=null,"No TANGENT vertex data found.");const s=await this.getAccessor(t.attributes.TANGENT,i);return r.errorUnsupportedIf(s.componentType!==ot.FLOAT,"Expected type FLOAT for TANGENT vertex attribute, but found "+Q3[s.componentType]),r.errorUnsupportedIf(s.componentCount!==4,"TANGENT vertex attribute must have 4 components, but found "+s.componentCount.toFixed()),new rn(s.raw,s.byteOffset,s.byteStride,s.byteOffset+s.byteStride*s.entryCount)}async getTextureCoordinates(t,i){const r=this.errorContext;r.assert(t.attributes.TEXCOORD_0!=null,"No TEXCOORD_0 vertex data found.");const s=await this.getAccessor(t.attributes.TEXCOORD_0,i);return r.errorUnsupportedIf(s.componentCount!==2,"TEXCOORD_0 vertex attribute must have 2 components, but found "+s.componentCount.toFixed()),s.componentType===ot.FLOAT?this._wrapAccessor(Uu,s):(r.errorUnsupportedIf(!s.normalized,"Integer component types are only supported for a normalized accessor for TEXCOORD_0."),Ret(s))}async getVertexColors(t,i){const r=this.errorContext;r.assert(t.attributes.COLOR_0!=null,"No COLOR_0 vertex data found.");const s=await this.getAccessor(t.attributes.COLOR_0,i);if(r.errorUnsupportedIf(s.componentCount!==4&&s.componentCount!==3,"COLOR_0 attribute must have 3 or 4 components, but found "+s.componentCount.toFixed()),s.componentCount===4){if(s.componentType===ot.FLOAT)return this._wrapAccessor(rn,s);if(s.componentType===ot.UNSIGNED_BYTE)return this._wrapAccessor(Pa,s);if(s.componentType===ot.UNSIGNED_SHORT)return this._wrapAccessor(A0,s)}else if(s.componentCount===3){if(s.componentType===ot.FLOAT)return this._wrapAccessor(Si,s);if(s.componentType===ot.UNSIGNED_BYTE)return this._wrapAccessor(E0,s);if(s.componentType===ot.UNSIGNED_SHORT)return this._wrapAccessor(G1,s)}r.errorUnsupported("Unsupported component type for COLOR_0 attribute: "+Q3[s.componentType])}hasPositions(t){return t.attributes.POSITION!==void 0}hasNormals(t){return t.attributes.NORMAL!==void 0}hasVertexColors(t){return t.attributes.COLOR_0!==void 0}hasTextureCoordinates(t){return t.attributes.TEXCOORD_0!==void 0}hasTangents(t){return t.attributes.TANGENT!==void 0}async getMaterial(t,i,r){let s=this.materialCache.get(t.material);if(!s){const n=t.material!=null?qie(this.json.materials[t.material]):qie(),o=n.pbrMetallicRoughness,a=this.hasVertexColors(t),l=this.getTexture(o.baseColorTexture,i),c=this.getTexture(n.normalTexture,i),h=r?this.getTexture(n.occlusionTexture,i):null,p=r?this.getTexture(n.emissiveTexture,i):null,f=r?this.getTexture(o.metallicRoughnessTexture,i):null,g=t.material!=null?t.material:-1;s={alphaMode:n.alphaMode,alphaCutoff:n.alphaCutoff,color:o.baseColorFactor,doubleSided:!!n.doubleSided,colorTexture:await l,normalTexture:await c,name:n.name,id:g,occlusionTexture:await h,emissiveTexture:await p,emissiveFactor:n.emissiveFactor,metallicFactor:o.metallicFactor,roughnessFactor:o.roughnessFactor,metallicRoughnessTexture:await f,vertexColors:a,ESRI_externalColorMixMode:n.extras.ESRI_externalColorMixMode}}return s}async getTexture(t,i){if(!t)return null;this.errorContext.errorUnsupportedIf((t.texCoord||0)!==0,"Only TEXCOORD with index 0 is supported.");const r=t.index,s=this.errorContext,n=this.json.textures[r],o=wet(n.sampler!=null?this.json.samplers[n.sampler]:{});s.errorUnsupportedIf(n.source==null,"Source is expected to be defined for a texture.");const a=this.json.images[n.source],l=await this._loadTextureImageData(r,n,i);return $oe(this.textureCache,r,()=>{const c=p=>p===33071||p===33648||p===10497,h=p=>(s.error(`Unexpected TextureSampler WrapMode: ${p}. Using default REPEAT(10497).`),10497);return{data:l,wrapS:c(o.wrapS)?o.wrapS:h(o.wrapS),wrapT:c(o.wrapT)?o.wrapT:h(o.wrapT),minFilter:o.minFilter,name:a.name,id:r}})}getNodeTransform(t){if(t===void 0)return Eet;let i=this.nodeTransformCache.get(t);if(!i){const r=this.getNodeTransform(this._getNodeParent(t)),s=this.json.nodes[t];s.matrix?i=dr(Te(),r,s.matrix):s.translation||s.rotation||s.scale?(i=l1(r),s.translation&&Wo(i,i,s.translation),s.rotation&&(Z3[3]=Ege(Z3,s.rotation),cl(i,i,Z3[3],Z3)),s.scale&&tF(i,i,s.scale)):i=r,this.nodeTransformCache.set(t,i)}return i}_wrapAccessor(t,i){return new t(i.raw,i.byteOffset,i.byteStride,i.byteOffset+i.byteStride*(i.entryCount-1)+i.componentByteSize*i.componentCount)}_resolveUri(t){return Au(t,this.baseUri)}_getNodeParent(t){return this.nodeParentMap.get(t)}_checkVersionSupported(){const t=L0.parse(this.json.asset.version,"glTF");Tet.validate(t)}_checkRequiredExtensionsSupported(){const t=this.json,i=this.errorContext;t.extensionsRequired&&t.extensionsRequired.length!==0&&i.errorUnsupported("gltf loader was not able to load unsupported feature. Required extensions: "+t.extensionsRequired.join(", "))}_computeNodeParents(){this.json.nodes.forEach((t,i)=>{t.children&&t.children.forEach(r=>{this.nodeParentMap.set(r,i)})})}async _loadTextureImageData(t,i,r){const s=this.textureLoaders.get(t);if(s)return s;const n=this._createTextureLoader(i,r);return this.textureLoaders.set(t,n),n}async _createTextureLoader(t,i){const r=this.json.images[t.source];if(r.uri)return this.context.loadImage(this._resolveUri(r.uri),i);const s=this.errorContext;s.errorUnsupportedIf(r.bufferView==null,"Image bufferView must be defined."),s.errorUnsupportedIf(r.mimeType==null,"Image mimeType must be defined.");const n=this.json.bufferViews[r.bufferView],o=await this.getBuffer(n.buffer,i);return s.errorUnsupportedIf(n.byteStride!=null,"byteStride not supported for image buffer"),Met(new Uint8Array(o.buffer,o.byteOffset+(n.byteOffset||0),n.byteLength),r.mimeType)}}const Tet=new L0(2,0,"glTF"),Eet=jce(Te(),Math.PI/2),Z3=k0(),Aet={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},Cet={[ot.BYTE]:1,[ot.UNSIGNED_BYTE]:1,[ot.SHORT]:2,[ot.UNSIGNED_SHORT]:2,[ot.FLOAT]:4,[ot.UNSIGNED_INT]:4};function Ret(e){switch(e.componentType){case ot.BYTE:return new H1(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case ot.UNSIGNED_BYTE:return new B1(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case ot.SHORT:return new q1(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case ot.UNSIGNED_SHORT:return new mS(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case ot.UNSIGNED_INT:return new gS(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case ot.FLOAT:return new Uu(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);default:return void(e.componentType,void 0)}}async function Oet(e){return new Promise((t,i)=>{const r=new Blob([e]),s=new FileReader;s.onload=()=>{const n=s.result;t(JSON.parse(n))},s.onerror=n=>{i(n)},s.readAsText(r)})}async function Met(e,t){return new Promise((i,r)=>{const s=new Blob([e],{type:t}),n=URL.createObjectURL(s),o=new Image;o.addEventListener("load",()=>{URL.revokeObjectURL(n),"decode"in o?o.decode().then(()=>i(o),()=>i(o)):i(o)}),o.addEventListener("error",a=>{URL.revokeObjectURL(n),r(a)}),o.src=n})}const Q3={5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5125:"UNSIGNED_INT",5126:"FLOAT"};let Pet=0;async function V_e(e,t,i={},r=!0){const s=await Yf.load(e,R$,t,i),n="gltf_"+Pet++,o={lods:[],materials:new Map,textures:new Map,meta:Iet(s)},a=!(!s.json.asset.extras||s.json.asset.extras.ESRI_type!=="symbolResource"),l=new Map;await $et(s,async(c,h,p,f)=>{var g;const y=(g=l.get(p))!=null?g:0;l.set(p,y+1);const v=c.mode!==void 0?c.mode:Tt.TRIANGLES,b=v===Tt.TRIANGLES||v===Tt.TRIANGLE_STRIP||v===Tt.TRIANGLE_FAN?v:null;if(R(b))return void R$.warnUnsupported("Unsupported primitive mode ("+Fet[v]+"). Skipping primitive.");if(!s.hasPositions(c))return void R$.warn("Skipping primitive without POSITION vertex attribute.");const w=s.getPositionData(c,i),S=s.getMaterial(c,i,r),T=s.hasNormals(c)?s.getNormalData(c,i):null,A=s.hasTangents(c)?s.getTangentData(c,i):null,C=s.hasTextureCoordinates(c)?s.getTextureCoordinates(c,i):null,O=s.hasVertexColors(c)?s.getVertexColors(c,i):null,L=s.getIndexData(c,i),U={transform:l1(h),attributes:{position:await w,normal:T?await T:null,texCoord0:C?await C:null,color:O?await O:null,tangent:A?await A:null},indices:await L,primitiveType:b,material:Let(o,await S,n)};let N=null;_(o.meta)&&_(o.meta.ESRI_lod)&&o.meta.ESRI_lod.metric==="screenSpaceRadius"&&(N=o.meta.ESRI_lod.thresholds[p]),o.lods[p]=o.lods[p]||{parts:[],name:f,lodThreshold:N},o.lods[p].parts[y]=U});for(const c of o.lods)c.parts=c.parts.filter(h=>!!h);return{model:o,meta:{isEsriSymbolResource:a,uri:s.uri},customMeta:{}}}function Iet(e){const t=e.json;let i=null;return t.nodes.forEach(r=>{const s=r.extras;_(s)&&(s.ESRI_proxyEllipsoid||s.ESRI_lod)&&(i=s)}),i}async function $et(e,t){const i=e.json,r=i.scenes[i.scene||0].nodes,s=r.length>1,n=[];for(const a of r){const l=i.nodes[a];n.push(o(a,0)),Det(l)&&!s&&l.extensions.MSFT_lod.ids.forEach((c,h)=>o(c,h+1))}async function o(a,l){const c=i.nodes[a],h=e.getNodeTransform(a);if(R$.warnUnsupportedIf(c.weights!=null,"Morph targets are not supported."),c.mesh!=null){const p=i.meshes[c.mesh];for(const f of p.primitives)n.push(t(f,h,l,p.name))}for(const p of c.children||[])n.push(o(p,l))}await Promise.all(n)}function Det(e){return e.extensions&&e.extensions.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}function Let(e,t,i){const r=n=>{const o=`${i}_tex_${n&&n.id}${n&&n.name?"_"+n.name:""}`;if(n&&!e.textures.has(o)){const a=get(n.data,{wrap:{s:n.wrapS,t:n.wrapT},mipmap:Net.some(l=>l===n.minFilter),noUnpackFlip:!0});e.textures.set(o,a)}return o},s=`${i}_mat_${t.id}_${t.name}`;if(!e.materials.has(s)){const n=met({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,textureColor:t.colorTexture?r(t.colorTexture):void 0,textureNormal:t.normalTexture?r(t.normalTexture):void 0,textureOcclusion:t.occlusionTexture?r(t.occlusionTexture):void 0,textureEmissive:t.emissiveTexture?r(t.emissiveTexture):void 0,textureMetallicRoughness:t.metallicRoughnessTexture?r(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor});e.materials.set(s,n)}return s}const R$=new fet,Net=[Ge.LINEAR_MIPMAP_LINEAR,Ge.LINEAR_MIPMAP_NEAREST],Fet=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"];function Uet(e,t=vS){return typeof e=="number"?t(e):rD(e)||E_(e)?new Uint32Array(e):e}function ket(e){const t=typeof e=="number"?e:e.length;if(t<3)return new Uint16Array(0);const i=t-2,r=i<=65536?new Uint16Array(3*i):new Uint32Array(3*i);if(typeof e=="number"){let s=0;for(let n=0;n<i;n+=1)n%2==0?(r[s++]=n,r[s++]=n+1,r[s++]=n+2):(r[s++]=n+1,r[s++]=n,r[s++]=n+2)}else{let s=0;for(let n=0;n<i;n+=1)if(n%2==0){const o=e[n],a=e[n+1],l=e[n+2];r[s++]=o,r[s++]=a,r[s++]=l}else{const o=e[n+1],a=e[n],l=e[n+2];r[s++]=o,r[s++]=a,r[s++]=l}}return r}function zet(e){const t=typeof e=="number"?e:e.length;if(t<3)return new Uint16Array(0);const i=t-2,r=i<=65536?new Uint16Array(3*i):new Uint32Array(3*i);if(typeof e=="number"){let s=0;for(let n=0;n<i;++n)r[s++]=0,r[s++]=n+1,r[s++]=n+2;return r}{const s=e[0];let n=e[1],o=0;for(let a=0;a<i;++a){const l=e[a+2];r[o++]=s,r[o++]=n,r[o++]=l,n=l}return r}}const kf=he.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function G_e(e,t){const i=await Bet(e,t);return{resource:i,textures:await qet(i.textureDefinitions,t)}}async function Bet(e,t){const i=_(t)&&t.streamDataRequester;if(i)return Vet(e,i,t);const r=await wl(Ti(e,t));if(r.ok===!0)return r.value.data;zm(r.error),j_e(r.error)}async function Vet(e,t,i){const r=await wl(t.request(e,"json",i));if(r.ok===!0)return r.value;zm(r.error),j_e(r.error.details.url)}function j_e(e){throw new q("",`Request for object resource failed: ${e}`)}function Get(e){const t=e.params,i=t.topology;let r=!0;switch(t.vertexAttributes||(kf.warn("Geometry must specify vertex attributes"),r=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const n=t.faces;if(n){if(t.vertexAttributes)for(const o in t.vertexAttributes){const a=n[o];a&&a.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(kf.warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),r=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(kf.warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),r=!1)):(kf.warn(`Indexed geometry does not specify face indices for '${o}' attribute`),r=!1)}}else kf.warn("Indexed geometries must specify faces"),r=!1;break}default:kf.warn(`Unsupported topology '${i}'`),r=!1}e.params.material||(kf.warn("Geometry requires material"),r=!1);const s=e.params.vertexAttributes;for(const n in s)s[n].values||(kf.warn("Geometries with externally defined attributes are not yet supported"),r=!1);return r}function jet(e,t){const i=[],r=[],s=[],n=[],o=e.resource,a=L0.parse(o.version||"1.0","wosr");Xet.validate(a);const l=o.model.name,c=o.model.geometries,h=o.materialDefinitions,p=e.textures;let f=0;const g=new Map;for(let y=0;y<c.length;y++){const v=c[y];if(!Get(v))continue;const b=Wet(v),w=v.params.vertexAttributes,S=[];for(const N in w){const z=w[N],V=z.values;S.push([N,{data:V,size:z.valuesPerElement,exclusive:!0}])}const T=[];if(v.params.topology!=="PerAttributeArray"){const N=v.params.faces;for(const z in N)T.push([z,new Uint32Array(N[z].values)])}const A=p&&p[b.texture];if(A&&!g.has(b.texture)){const{image:N,params:z}=A,V=new rs(N,z);n.push(V),g.set(b.texture,V)}const C=g.get(b.texture),O=C?C.id:void 0;let L=s[b.material]?s[b.material][b.texture]:null;if(!L){const N=h[b.material.substring(b.material.lastIndexOf("/")+1)].params;N.transparency===1&&(N.transparency=0);const z=A&&A.alphaChannelUsage,V=N.transparency>0||z==="transparency"||z==="maskAndTransparency",B=A?H_e(A.alphaChannelUsage):void 0,J={ambient:da(N.diffuse),diffuse:da(N.diffuse),opacity:1-(N.transparency||0),transparent:V,textureAlphaMode:B,textureAlphaCutoff:.33,textureId:O,initTextureTransparent:!0,doubleSided:!0,cullFace:Di.None,colorMixMode:N.externalColorMixMode||"tint",textureAlphaPremultiplied:!!A&&!!A.params.preMultiplyAlpha};_(t)&&t.materialParamsMixin&&Object.assign(J,t.materialParamsMixin),L=new K1(J),s[b.material]||(s[b.material]={}),s[b.material][b.texture]=L}r.push(L);const U=new lr(S,T);f+=T.position?T.position.length:0,i.push(U)}return{name:l,stageResources:{textures:n,materials:r,geometries:i},pivotOffset:o.model.pivotOffset,boundingBox:Het(i),numberOfVertices:f,lodThreshold:null}}function Het(e){const t=ki();return e.forEach(i=>{const r=i.boundingInfo;_(r)&&(Tp(t,r.getBBMin()),Tp(t,r.getBBMax()))}),t}async function qet(e,t){const i=[];for(const n in e){const o=e[n],a=o.images[0].data;if(!a){kf.warn("Externally referenced texture data is not yet supported");continue}const l=o.encoding+";base64,"+a,c="/textureDefinitions/"+n,h=o.channels==="rgba"?o.alphaChannelUsage||"transparency":"none",p={noUnpackFlip:!0,wrap:{s:ct.REPEAT,t:ct.REPEAT},preMultiplyAlpha:H_e(h)!==Ri.Opaque},f=_(t)&&t.disableTextures?Promise.resolve(null):Fu(l,t);i.push(f.then(g=>({refId:c,image:g,params:p,alphaChannelUsage:h})))}const r=await Promise.all(i),s={};for(const n of r)s[n.refId]=n;return s}function H_e(e){switch(e){case"mask":return Ri.Mask;case"maskAndTransparency":return Ri.MaskBlend;case"none":return Ri.Opaque;default:return Ri.Blend}}function Wet(e){const t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const Xet=new L0(1,2,"wosr"),Kb=2.1;async function q_e(e,t){const i=W_e(iet(e));if(i.fileType==="wosr"){const l=await(t.cache?t.cache.loadWOSR(i.url,t):G_e(i.url,t)),c=jet(l,t);return{lods:[c],referenceBoundingBox:c.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:l.remove}}const r=await(t.cache?t.cache.loadGLTF(i.url,t,t.usePBR):V_e(new z_e(t.streamDataRequester),i.url,t,t.usePBR)),s=Pr(r.model.meta,"ESRI_proxyEllipsoid");r.meta.isEsriSymbolResource&&_(s)&&r.meta.uri.indexOf("/RealisticTrees/")!==-1&&Qet(r,s);const n=r.meta.isEsriSymbolResource?{usePBR:t.usePBR,isSchematic:!1,treeRendering:r.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:t.usePBR,isSchematic:!1,mrrFactors:[0,1,.5]},o=me(I({},t.materialParamsMixin),{treeRendering:r.customMeta.esriTreeRendering});if(i.specifiedLodIndex!=null){const l=O$(r,n,o,i.specifiedLodIndex);let c=l[0].boundingBox;return i.specifiedLodIndex!==0&&(c=O$(r,n,o,0)[0].boundingBox),{lods:l,referenceBoundingBox:c,isEsriSymbolResource:r.meta.isEsriSymbolResource,isWosr:!1,remove:r.remove}}const a=O$(r,n,o);return{lods:a,referenceBoundingBox:a[0].boundingBox,isEsriSymbolResource:r.meta.isEsriSymbolResource,isWosr:!1,remove:r.remove}}function W_e(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:t[4]!=null?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function O$(e,t,i,r){const s=e.model,n=wr(),o=new Array,a=new Map,l=new Map;return s.lods.forEach((c,h)=>{if(r!==void 0&&h!==r)return;const p={name:c.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:_(c.lodThreshold)?c.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:ki()};o.push(p),c.parts.forEach(f=>{const g=f.material+(f.attributes.normal?"_normal":"")+(f.attributes.color?"_color":"")+(f.attributes.texCoord0?"_texCoord0":"")+(f.attributes.tangent?"_tangent":""),y=s.materials.get(f.material),v=_(f.attributes.texCoord0),b=_(f.attributes.normal),w=Yet(y.alphaMode);if(!a.has(g)){if(v){if(_(y.textureColor)&&!l.has(y.textureColor)){const ie=s.textures.get(y.textureColor),$=me(I({},ie.parameters),{preMultiplyAlpha:w!==Ri.Opaque});l.set(y.textureColor,new rs(ie.data,$))}if(_(y.textureNormal)&&!l.has(y.textureNormal)){const ie=s.textures.get(y.textureNormal);l.set(y.textureNormal,new rs(ie.data,ie.parameters))}if(_(y.textureOcclusion)&&!l.has(y.textureOcclusion)){const ie=s.textures.get(y.textureOcclusion);l.set(y.textureOcclusion,new rs(ie.data,ie.parameters))}if(_(y.textureEmissive)&&!l.has(y.textureEmissive)){const ie=s.textures.get(y.textureEmissive);l.set(y.textureEmissive,new rs(ie.data,ie.parameters))}if(_(y.textureMetallicRoughness)&&!l.has(y.textureMetallicRoughness)){const ie=s.textures.get(y.textureMetallicRoughness);l.set(y.textureMetallicRoughness,new rs(ie.data,ie.parameters))}}const N=y.color[0]**(1/Kb),z=y.color[1]**(1/Kb),V=y.color[2]**(1/Kb),B=y.emissiveFactor[0]**(1/Kb),J=y.emissiveFactor[1]**(1/Kb),Q=y.emissiveFactor[2]**(1/Kb),te=_(y.textureColor)&&v?l.get(y.textureColor):null;a.set(g,new K1(I(me(I({},t),{transparent:w===Ri.Blend,customDepthTest:F1.Lequal,textureAlphaMode:w,textureAlphaCutoff:y.alphaCutoff,diffuse:[N,z,V],ambient:[N,z,V],opacity:y.opacity,doubleSided:y.doubleSided,doubleSidedType:"winding-order",cullFace:y.doubleSided?Di.None:Di.Back,vertexColors:!!f.attributes.color,vertexTangents:!!f.attributes.tangent,normals:b?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,fillLightsEnabled:!0,textureId:_(te)?te.id:void 0,colorMixMode:y.colorMixMode,normalTextureId:_(y.textureNormal)&&v?l.get(y.textureNormal).id:void 0,textureAlphaPremultiplied:_(te)&&!!te.params.preMultiplyAlpha,occlusionTextureId:_(y.textureOcclusion)&&v?l.get(y.textureOcclusion).id:void 0,emissiveTextureId:_(y.textureEmissive)&&v?l.get(y.textureEmissive).id:void 0,metallicRoughnessTextureId:_(y.textureMetallicRoughness)&&v?l.get(y.textureMetallicRoughness).id:void 0,emissiveFactor:[B,J,Q],mrrFactors:[y.metallicFactor,y.roughnessFactor,t.mrrFactors[2]],isSchematic:!1}),i)))}const S=Zet(f.indices||f.attributes.position.count,f.primitiveType),T=f.attributes.position.count,A=z_(Si,T);GO(A,f.attributes.position,f.transform);const C=[[E.POSITION,{data:A.typedBuffer,size:A.elementCount,exclusive:!0}]],O=[[E.POSITION,S]];if(_(f.attributes.normal)){const N=z_(Si,T);cS(n,f.transform),Z1(N,f.attributes.normal,n),C.push([E.NORMAL,{data:N.typedBuffer,size:N.elementCount,exclusive:!0}]),O.push([E.NORMAL,S])}if(_(f.attributes.tangent)){const N=z_(rn,T);cS(n,f.transform),L_e(N,f.attributes.tangent,n),C.push([E.TANGENT,{data:N.typedBuffer,size:N.elementCount,exclusive:!0}]),O.push([E.TANGENT,S])}if(_(f.attributes.texCoord0)){const N=z_(Uu,T);F_e(N,f.attributes.texCoord0),C.push([E.UV0,{data:N.typedBuffer,size:N.elementCount,exclusive:!0}]),O.push([E.UV0,S])}if(_(f.attributes.color)){const N=z_(Pa,T);if(f.attributes.color.elementCount===4)f.attributes.color instanceof rn?cG(N,f.attributes.color,255):f.attributes.color instanceof Pa?U_e(N,f.attributes.color):f.attributes.color instanceof A0&&cG(N,f.attributes.color,1/256);else{k_e(N,255,255,255,255);const z=new E0(N.buffer,0,4);f.attributes.color instanceof Si?Q9(z,f.attributes.color,255):f.attributes.color instanceof E0?zW(z,f.attributes.color):f.attributes.color instanceof G1&&Q9(z,f.attributes.color,1/256)}C.push([E.COLOR,{data:N.typedBuffer,size:N.elementCount,exclusive:!0}]),O.push([E.COLOR,S])}const L=new lr(C,O);p.stageResources.geometries.push(L),p.stageResources.materials.push(a.get(g)),v&&(_(y.textureColor)&&p.stageResources.textures.push(l.get(y.textureColor)),_(y.textureNormal)&&p.stageResources.textures.push(l.get(y.textureNormal)),_(y.textureOcclusion)&&p.stageResources.textures.push(l.get(y.textureOcclusion)),_(y.textureEmissive)&&p.stageResources.textures.push(l.get(y.textureEmissive)),_(y.textureMetallicRoughness)&&p.stageResources.textures.push(l.get(y.textureMetallicRoughness))),p.numberOfVertices+=T;const U=L.boundingInfo;_(U)&&(Tp(p.boundingBox,U.getBBMin()),Tp(p.boundingBox,U.getBBMax()))})}),o}function Yet(e){switch(e){case"BLEND":return Ri.Blend;case"MASK":return Ri.Mask;case"OPAQUE":case null:case void 0:return Ri.Opaque}}function Zet(e,t){switch(t){case Tt.TRIANGLES:return Uet(e);case Tt.TRIANGLE_STRIP:return ket(e);case Tt.TRIANGLE_FAN:return zet(e)}}function Qet(e,t){for(let i=0;i<e.model.lods.length;++i){const r=e.model.lods[i];e.customMeta.esriTreeRendering=!0;for(const s of r.parts){const n=s.attributes.normal;if(R(n))return;const o=s.attributes.position,a=o.count,l=M(),c=M(),h=M(),p=z_(Pa,a),f=z_(Si,a),g=fr(Te(),s.transform);for(let y=0;y<a;y++){o.getVec(y,c),n.getVec(y,l),ke(c,c,s.transform),de(h,c,t.center),tD(h,h,t.radius);const v=h[2],b=Pe(h),w=Math.min(.45+.55*b*b,1);tD(h,h,t.radius),ke(h,h,g),be(h,h),i+1!==e.model.lods.length&&e.model.lods.length>1&&Cs(h,h,l,v>-1?.2:Math.min(-4*v-3.8,1)),f.setVec(y,h),p.set(y,0,255*w),p.set(y,1,255*w),p.set(y,2,255*w),p.set(y,3,255)}s.attributes.normal=f,s.attributes.color=p}}}var Yyt=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",fetch:q_e,gltfToEngineResources:O$,parseUrl:W_e}),Ki;function Jet(e){let t=kr().mat4f64(E.LOCALTRANSFORM).mat4f64(E.GLOBALTRANSFORM).vec4f64(E.BOUNDINGSPHERE).vec3f64(E.MODELORIGIN).mat3f(E.MODEL).mat3f(E.MODELNORMAL).vec2f(E.MODELSCALEFACTORS);return e.indexOf("color")>=0&&(t=t.vec4f(E.COLOR)),e.indexOf("featureAttribute")>=0&&(t=t.vec4f(E.FEATUREATTRIBUTE)),t=t.u8(E.STATE).u8(E.LODLEVEL).alignTo(8),t}(function(e){e[e.ALLOCATED=1]="ALLOCATED",e[e.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",e[e.ACTIVE=18]="ACTIVE"})(Ki||(Ki={}));class Ket{constructor(t){this.localTransform=t.getField(E.LOCALTRANSFORM,S0),this.globalTransform=t.getField(E.GLOBALTRANSFORM,S0),this.modelOrigin=t.getField(E.MODELORIGIN,Xr),this.model=t.getField(E.MODEL,id),this.modelNormal=t.getField(E.MODELNORMAL,id),this.modelScaleFactors=t.getField(E.MODELSCALEFACTORS,Uu),this.boundingSphere=t.getField(E.BOUNDINGSPHERE,z1),this.color=t.getField(E.COLOR,rn),this.featureAttribute=t.getField(E.FEATUREATTRIBUTE,rn),this.state=t.getField(E.STATE,$m),this.lodLevel=t.getField(E.LODLEVEL,$m)}}class ett extends xr{constructor(t,i){super(),this._capacity=0,this._size=0,this._next=0,this._layout=Jet(t),this._shaderTransformation=i}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const t=this._findSlot();return this._view.state.set(t,Ki.ALLOCATED),this._size++,this.emit("instance-added",{index:t}),t}removeInstance(t){const i=this._view.state;at(t>=0&&t<this._capacity&&i.get(t)&Ki.ALLOCATED,"invalid instance handle"),this._getStateFlag(t,Ki.ACTIVE)?this._setStateFlags(t,Ki.REMOVE):this.freeInstance(t),this.emit("instance-removed",{index:t})}freeInstance(t){const i=this._view.state;at(t>=0&&t<this._capacity&&i.get(t)&Ki.ALLOCATED,"invalid instance handle"),i.set(t,0),this._size--}setLocalTransform(t,i,r=!0){this._view.localTransform.setMat(t,i),r&&this.updateModelTransform(t)}getLocalTransform(t,i){this._view.localTransform.getMat(t,i)}setGlobalTransform(t,i,r=!0){this._view.globalTransform.setMat(t,i),r&&this.updateModelTransform(t)}getGlobalTransform(t,i){this._view.globalTransform.getMat(t,i)}updateModelTransform(t){const i=this._view,r=bg,s=Ju;i.localTransform.getMat(t,Wie),i.globalTransform.getMat(t,iz);const n=dr(iz,iz,Wie);oe(r,n[12],n[13],n[14]),i.modelOrigin.setVec(t,r),Lu(s,n),i.model.setMat(t,s);const o=KSe(bg,n);o.sort(),i.modelScaleFactors.set(t,0,o[1]),i.modelScaleFactors.set(t,1,o[2]),k1(s,s),Nu(s,s),i.modelNormal.setMat(t,s),this._setStateFlags(t,Ki.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:t})}getModelTransform(t,i){const r=this._view;r.model.getMat(t,Ju),r.modelOrigin.getVec(t,bg),i[0]=Ju[0],i[1]=Ju[1],i[2]=Ju[2],i[3]=0,i[4]=Ju[3],i[5]=Ju[4],i[6]=Ju[5],i[7]=0,i[8]=Ju[6],i[9]=Ju[7],i[10]=Ju[8],i[11]=0,i[12]=bg[0],i[13]=bg[1],i[14]=bg[2],i[15]=1}applyShaderTransformation(t,i){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,i)}getCombinedModelTransform(t,i){return this.getModelTransform(t,i),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,i),i}getCombinedLocalTransform(t,i){return this._view.localTransform.getMat(t,i),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,i),i}getCombinedMaxScaleFactor(t){let i=this._view.modelScaleFactors.get(t,1);if(this._shaderTransformation){const r=this._shaderTransformation.scaleFactor(bg,this,t);i*=Math.max(r[0],r[1],r[2])}return i}getCombinedMedianScaleFactor(t){let i=this._view.modelScaleFactors.get(t,0);if(this._shaderTransformation){const r=this._shaderTransformation.scaleFactor(bg,this,t);r.sort(),i*=r[1]}return i}getModel(t,i){this._view.model.getMat(t,i)}setFeatureAttribute(t,i){this._view.featureAttribute.setVec(t,i)}getFeatureAttribute(t,i){this._view.featureAttribute.getVec(t,i)}setColor(t,i){this._view.color.setVec(t,i)}getColor(t,i){this._view.color.getVec(t,i)}setVisible(t,i){i!==this.getVisible(t)&&(this._setStateFlag(t,Ki.VISIBLE,i),this.emit("instance-visibility-changed",{index:t}))}getVisible(t){return this._getStateFlag(t,Ki.VISIBLE)}setHighlight(t,i){i!==this.getHighlight(t)&&(this._setStateFlag(t,Ki.HIGHLIGHT,i),this.emit("instance-highlight-changed",{index:t}))}getHighlight(t){return this._getStateFlag(t,Ki.HIGHLIGHT)}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let i=0;for(let r=0;r<this._capacity;++r)this.getState(r)&t&&++i;return i}_setStateFlags(t,i){const r=this._view.state;i=r.get(t)|i,r.set(t,i)}_clearStateFlags(t,i){const r=this._view.state;i=r.get(t)&~i,r.set(t,i)}_setStateFlag(t,i,r){r?this._setStateFlags(t,i):this._clearStateFlags(t,i)}_getStateFlag(t,i){return!!(this._view.state.get(t)&i)}_grow(){const t=Math.max(ttt,Math.floor(this._capacity*itt)),i=this._layout.createBuffer(t);if(this._buffer){const r=new Uint8Array(this._buffer.buffer);new Uint8Array(i.buffer).set(r)}this._capacity=t,this._buffer=i,this._view=new Ket(this._buffer)}_findSlot(){const t=this._view.state;let i=this._next;for(;t.get(i)&Ki.ALLOCATED;)i=(i+1)%this._capacity;return this._next=(i+1)%this._capacity,i}}const ttt=1024,itt=2,bg=M(),Ju=wr(),Wie=Te(),iz=Te();class rtt extends zve{constructor(t,i){super(r=>this._instanceData.view.boundingSphere.getVec(r,this._tmpSphere),{maximumDepth:25}),this._tmpSphere=xn(),this._tmpMat4=Te(),this._instanceData=t,this._boundingSphere=i}addInstance(t){const i=this._instanceData.view.boundingSphere,r=this._instanceData.getCombinedModelTransform(t,this._tmpMat4);ke(this._tmpSphere,this._boundingSphere.center,r),this._tmpSphere[3]=this._boundingSphere.radius*w1(r),i.setVec(t,this._tmpSphere),this.add([t])}removeInstance(t){this.remove([t])}}class stt{constructor(t,i){this.thresholdScale=1,this._camera=new wi,this._worldSpaceRadius=t,this._thresholds=i.map(r=>r)}updateCamera(t){this._camera.copyFrom(t)}selectLevel(t,i){const r=this._camera.computeScreenPixelSizeAt(t),s=this._worldSpaceRadius*i/r,n=this._thresholds;let o=-1;for(let a=0;a<n.length;++a)s>=n[a]*this.thresholdScale&&(o=a);return o}}class ntt{constructor(t,i){const r=t.renderContext.rctx,{geometry:s,material:n}=i;this._materialRepository=t.materialRep,n.setParameters({instancedDoublePrecision:!0});const o=n.createBufferWriter(),a=o.vertexBufferLayout,l=o.elementCount(s),c=o.allocate(l);o.write({},s,c,0),this.geometry=s,this.material=n,this.glMaterials=new Mve(n,this._materialRepository),this.vertexBufferLayout=a,this.vbo=jt.createVertex(r,ri.STATIC_DRAW,c.buffer),this.vao=new us(r,mi,{geometry:Rl(a)},{geometry:this.vbo}),this.vertexCount=l}destroy(){this.glMaterials.destroy(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(t,i,r,s,n,o){const a=this.geometry.id;this.material.intersect(this.geometry,null,t.transform.transform,t,r,s,(l,c,h,p,f)=>{if(l>=0){if(i!=null&&!i(t.rayBegin,t.rayEnd,l))return;const g={layerUid:o.layerUid,graphicUid:o.graphicUid(n),geometryId:a,triangleNr:h};if((t.results.min.drapedLayerOrder==null||f>=t.results.min.drapedLayerOrder)&&(t.results.min.dist==null||l<t.results.min.dist)&&t.results.min.set(ur.LOD,g,l,c,t.transform.transform,f),t.options.store!==Wn.MIN&&(t.results.max.drapedLayerOrder==null||f>=t.results.max.drapedLayerOrder)&&(t.results.max.dist==null||l>t.results.max.dist)&&t.results.max.set(ur.LOD,g,l,c,t.transform.transform,f),t.options.store===Wn.ALL){const y=QF(t.results.min.ray);y.set(ur.LOD,g,l,c,t.transform.transform,f),t.results.all.push(y)}}})}}class BW{constructor(t,i){this.minScreenSpaceRadius=t,this.components=i}static async create(t,i,r){const s=await Promise.allSettled(i.components.map(o=>t.schedule(()=>new ntt(t,o),r))),n=s.map(o=>o.status==="fulfilled"?o.value:null).filter(o=>o);if(Us(r)||n.length!==s.length){n.forEach(o=>o.destroy()),Qt(r);for(const o of s)if(o.status==="rejected")throw o.reason}return new BW(i.minScreenSpaceRadius,n)}destroy(){this.components.forEach(t=>t.destroy())}intersect(t,i,r,s,n,o){this.components.forEach(a=>a.intersect(t,i,r,s,n,o))}get boundingBox(){if(R(this._boundingBox)){const t=ki();this.components.forEach(i=>{_(i.boundingInfo)&&(Tp(t,i.boundingInfo.bbMin),Tp(t,i.boundingInfo.bbMax))}),this._boundingBox=t}return this._boundingBox}get boundingSphere(){if(R(this._boundingSphere)){const t=this.boundingBox,i=M();Fh(t,i),this._boundingSphere={center:i,radius:.5*JEe(t)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((t,i)=>t+i.triangleCount,0)}}class ott{constructor(t,i,r){this._elementSize=i,this._buffer=jt.createVertex(t,ri.STATIC_DRAW),this.resize(r)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(t,i,r,s=0){const n=new Uint8Array(this.array,t*this.elementSize,(i-t)*this.elementSize);new Uint8Array(r.array,s*this.elementSize).set(n)}transferAll(){this._buffer.setData(this._array)}transferRange(t,i){const r=t*this._elementSize,s=i*this._elementSize;this._buffer.setSubData(this._array,r,r,s)}resize(t){const i=t*this._elementSize,r=new ArrayBuffer(i);this._array&&(t>=this._capacity?new Uint8Array(r).set(new Uint8Array(this._array)):new Uint8Array(r).set(new Uint8Array(this._array).subarray(0,t*this._elementSize))),this._array=r,this._buffer.setSize(i),this._capacity=t}}class att{constructor(t){this.modelOriginHi=t.getField(E.MODELORIGINHI,Si),this.modelOriginLo=t.getField(E.MODELORIGINLO,Si),this.model=t.getField(E.MODEL,id),this.modelNormal=t.getField(E.MODELNORMAL,id),this.color=t.getField(E.INSTANCECOLOR,rn),this.featureAttribute=t.getField(E.INSTANCEFEATUREATTRIBUTE,rn)}}class Xie{constructor(t,i){this._headIndex=0,this._tailIndex=0,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=t,this._instanceBufferLayout=i,this._elementSize=i.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const t=this._headIndex,i=this._tailIndex;return t>=i?t-i:t+this._capacity-i}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCylce(){this._captureFirstIndex=!0}beginUpdate(){at(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){at(this._updating,"not updating"),this.size<ctt*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){at(this._updating,"not updating"),this.isFull&&this._grow();const t=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=t,this._captureFirstIndex=!1),this._incrementHead(),at(this._headIndex!==this._tailIndex,"invalid pointers"),t}freeTail(){at(this._updating,"not updating"),at(this.size>0,"invalid size");const t=this._tailIndex===this._firstIndex;this._incrementTail(),t&&(this._firstIndex=this._tailIndex)}_grow(){const t=Math.max(Yie,Math.floor(this._capacity*ltt));this._resize(t)}_shrink(){const t=Math.max(Yie,Math.floor(this._capacity*utt));this._resize(t)}_resize(t){if(at(this._updating,"not updating"),t===this._capacity)return;const i=new ott(this._rctx,this._elementSize,t);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const r=this.size,s=this._compactInstances(i);at(s===r,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=s,this._prevHeadIndex=0}this._resized=!0,this._capacity=t,this._buffer=i,this._view=new att(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(t){const i=this._headIndex,r=this._tailIndex;return r<i?(this._buffer.copyRange(r,i,t),i-r):r>i?(this._buffer.copyRange(r,this._capacity,t),i>0&&this._buffer.copyRange(0,i,t,this._capacity-r),i+(this._capacity-r)):0}_incrementHead(t=1){this._headIndex=(this._headIndex+t)%this._capacity}_incrementTail(t=1){this._tailIndex=(this._tailIndex+t)%this._capacity}_transferRange(t,i){t<i?this._buffer.transferRange(t,i):t>i&&(i>0&&this._buffer.transferRange(0,i),this._buffer.transferRange(t,this._capacity))}}const Yie=1024,ltt=2,ctt=.3,utt=.5;let htt=function(e){const t=e.baseBoundingSphere.radius,i=e.levels.map(r=>r.minScreenSpaceRadius);return new stt(t,i)};class dtt{constructor(t,i,r,s){this.type=ur.LOD,this.isGround=!1,this._inverseViewport=Ye(),this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new wi,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.slots=[ve.OPAQUE_PLUGIN,ve.TRANSPARENT_PLUGIN],this.canRender=!0,this._symbol=t,this._optionalFields=i,this._metadata=r,this._instanceBufferLayout=y_e({instancedDoublePrecision:!0,instanced:i}),this._glInstanceBufferLayout=Rl(this._instanceBufferLayout,1),this._instanceData=new ett(this._optionalFields,s),this._instanceData.on("instance-added",()=>this._requestUpdateCycle()),this._instanceData.on("instance-removed",()=>this._requestUpdateCycle()),this._instanceData.on("instance-transform-changed",n=>{this._requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(n.index)}),this._instanceData.on("instance-visibility-changed",n=>{this._requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(n.index)}),this._instanceData.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0)),this._enableLevelSelection=this._symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerUid(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const t={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach(i=>{const r=i.memoryUsage;t.cpu+=r.cpu,t.gpu+=r.gpu}),this._highlightRenderInstanceData.forEach(i=>{const r=i.memoryUsage;t.cpu+=r.cpu,t.gpu+=r.gpu}),t}get renderStats(){const t=this._instanceData.size,i=[];return this._levels.forEach((r,s)=>{const n=this._defaultRenderInstanceData[s],o=this._highlightRenderInstanceData[s],a=n.size+o.size,l=r.triangleCount;i.push({renderedInstances:a,renderedTriangles:a*l,trianglesPerInstance:l})}),{totalInstances:t,renderedInstances:i.reduce((r,s)=>r+s.renderedInstances,0),renderedTriangles:i.reduce((r,s)=>r+s.renderedTriangles,0),levels:i}}async initializeRenderContext(t,i){this._context=t;const r=t.renderContext.rctx,s=await Promise.allSettled(this._symbol.levels.map(o=>(this._defaultRenderInstanceData.push(new Xie(r,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new Xie(r,this._instanceBufferLayout)),BW.create(t,o,i)))),n=s.map(o=>o.status==="fulfilled"?o.value:null).filter(o=>o);if(Us(i)||n.length!==s.length){n.forEach(o=>o.destroy()),Qt(i);for(const o of s)if(o.status==="rejected")throw o.reason}this._levels=n,this._levelSelector=htt(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(t=>t.destroy()),this._defaultRenderInstanceData.forEach(t=>t.destroy()),this._highlightRenderInstanceData.forEach(t=>t.destroy())}get needsTransparentPass(){return this._levels.some(t=>t.components.some(i=>i.material.requiresSlot(ve.TRANSPARENT_MATERIAL)))}get needsHighlight(){return this._highlightRenderInstanceData.some(t=>t.size>0)}prepareRender(t,i){if(hi.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const s=i.equals(this._lastCamera);this._lastCamera.copyFrom(i),s||this._requestUpdateCycle()}const r=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this._updateInstances(i,r),this.needsUpdates&&this._context.requestRender()}render(t){var i,r,s,n;const o=t.slot===ve.OPAQUE_PLUGIN?ve.OPAQUE_MATERIAL:t.slot===ve.TRANSPARENT_PLUGIN?ve.TRANSPARENT_MATERIAL:null;if(!o||!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(t.pass))return;const a=t.camera;this._inverseViewport[0]=1/a.fullViewport[2],this._inverseViewport[1]=1/a.fullViewport[3];const l={slot:o,origin:[0,0,0],camera:a,inverseViewport:this._inverseViewport,shadowMap:t.shadowMap,shadowMappingEnabled:t.shadowMap.enabled,ssaoHelper:t.ssaoHelper,ssaoEnabled:t.ssaoHelper.enabled,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:t.sliceHelper&&t.sliceHelper.plane,hudVisibilityTexture:(i=(r=t.offscreenRenderingHelper)==null?void 0:r.hudVisibilityTexture)!=null?i:null,highlightDepthTexture:(s=(n=t.offscreenRenderingHelper)==null?void 0:n.depthTexture)!=null?s:null,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:ls,ssrEnabled:!1,lighting:t.scenelightingData,transparencyPassType:t.transparencyPassType,terrainLinearDepthTexture:t.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:t.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:t.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:t.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:t.multipassGeometryParams.multipassGeometryEnabled,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:t.hasFillLights};t.rctx.bindVAO();const c=t.pass!==Le.MATERIAL_HIGHLIGHT&&t.pass!==Le.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT,h=t.pass!==Le.MATERIAL_DEPTH_SHADOWMAP_DEFAULT;c&&this._renderComponents(t,o,l,this._defaultRenderInstanceData),h&&this._renderComponents(t,o,l,this._highlightRenderInstanceData)}intersect(t,i,r,s){if(!this.baseMaterial.isVisible())return;const n=M();de(n,s,r);const o=a=>{this._instanceData.getCombinedModelTransform(a,Jie),t.transform.set(Jie),ke(Kie,r,t.transform.inverse),ke(ere,s,t.transform.inverse);const l=this._instanceData.getState(a),c=this._instanceData.getLodLevel(a);at(l&Ki.ACTIVE,"invalid instance state"),at(c>=0&&c<this._levels.length,"invaid lod level"),this._levels[c].intersect(t,i,Kie,ere,a,this._metadata)};this.baseMaterial.parameters.verticalOffset?this.octree.forEach(o):this.octree.forEachAlongRay(r,n,o)}queryDepthRange(t){return this._queryDepthRangeOctree(t)}notifyShaderTransformationChanged(){this._invalidateOctree()}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,t&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender()}get needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}get octree(){return this._octree||(this._octree=this._buildOctree()),this._octree}_invalidateOctree(){this._octree&&(this._octree.destroy(),this._octree=null)}_buildOctree(){const t=new rtt(this._instanceData,this.baseBoundingSphere),i=this._instanceData,r=i.view?i.view.state:null;for(let s=0;s<this._instanceData.capacity;++s)r.get(s)&Ki.ACTIVE&&t.addInstance(s);return t}_queryDepthRangeOctree(t){const i=t.eye,r=t.viewForward,s=this.octree.findClosest(r,hc.FRONT_TO_BACK,t.frustum),n=this.octree.findClosest(r,hc.BACK_TO_FRONT,t.frustum);if(s!=null&&n!=null){this._instanceData.view.boundingSphere.getVec(s,wd),de(wd,wd,i);const o=_e(wd,r)-wd[3];this._instanceData.view.boundingSphere.getVec(n,wd),de(wd,wd,i);const a=_e(wd,r)+wd[3];return{near:Math.max(t.near,o),far:Math.min(t.far,a)}}return{near:1/0,far:-1/0}}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach(t=>{t.startUpdateCylce()}),this._highlightRenderInstanceData.forEach(t=>{t.startUpdateCylce()}),this.needsUpdates&&this._context.requestRender()}_updateInstances(t,i){const r=this._enableLevelSelection,s=this._levelSelector;s.updateCamera(t),this._defaultRenderInstanceData.forEach(h=>{h.beginUpdate()}),this._highlightRenderInstanceData.forEach(h=>{h.beginUpdate()});const n=this._instanceData,o=this._instanceData.view,a=n.size,l=n.capacity;let c=this._instanceIndex;i=Math.min(a,i);for(let h=0;h<i;++h){c===0&&this._startUpdateCycle();const p=o.state.get(c);let f=0;if(!(p&Ki.ALLOCATED)){c=(c+1)%l,i++;continue}const g=o.lodLevel.get(c);if(p&Ki.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[g].freeTail(),p&Ki.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[g].freeTail(),p&Ki.REMOVE)n.freeInstance(c);else if(p&Ki.VISIBLE){let y=0;r&&(o.modelOrigin.getVec(c,Qie),y=s.selectLevel(Qie,n.getCombinedMedianScaleFactor(c))),f=p&~(Ki.ACTIVE|Ki.TRANSFORM_CHANGED),y>=0&&(p&Ki.HIGHLIGHT?(Zie(this._highlightRenderInstanceData[y],o,c),f|=Ki.HIGHLIGHT_ACTIVE):(Zie(this._defaultRenderInstanceData[y],o,c),f|=Ki.DEFAULT_ACTIVE)),o.state.set(c,f),o.lodLevel.set(c,y)}else f=p&~(Ki.ACTIVE|Ki.TRANSFORM_CHANGED),o.state.set(c,f);if(this._octree){const y=!!(p&Ki.ACTIVE),v=!!(f&Ki.ACTIVE);!y&&v?this._octree.addInstance(c):y&&!v?this._octree.removeInstance(c):y&&v&&p&Ki.TRANSFORM_CHANGED&&(this._octree.removeInstance(c),this._octree.addInstance(c))}c=(c+1)%l}this._instanceIndex=c,this._defaultRenderInstanceData.forEach(h=>{h.endUpdate()}),this._highlightRenderInstanceData.forEach(h=>{h.endUpdate()})}_renderComponents(t,i,r,s){this.levels.forEach((n,o)=>{n.components.forEach(a=>{this._renderComponent(t,i,r,s[o],a,o)})})}_renderComponent(t,i,r,s,n,o){if(s.size===0||!n.material.requiresSlot(i))return;const{rctx:a,pass:l}=t,c=n.glMaterials.load(a,l);if(R(c))return;const h=c.beginSlot(r),p=a.useTechnique(h,i);c.bind(r,h),a.bindVAO(n.vao),h.ensureAttributeLocations(n.vao),t.isHighlightPass&&Hp(p,r),h.bindDraw(r),hi.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.pass===Le.MATERIAL&&(p.setUniform4fv("externalColor",tre[Math.min(o,tre.length-1)]),p.setUniform1i("colorMixMode",Y9.replace));const f=a.capabilities.instancing,g=s.capacity,y=s.headIndex,v=s.tailIndex,b=s.firstIndex,w=this._glInstanceBufferLayout,S=(T,A)=>{fq(a,mi,s.buffer,w,T),f.drawArraysInstanced(h.primitiveType,0,n.vertexCount,A-T),mq(a,mi,s.buffer,w)};n.material.parameters.transparent&&b!=null?y>v?(at(b>=v&&b<=y,"invalid firstIndex"),S(b,y),S(v,b)):y<v&&(b<=y?(at(b>=0&&b<=y,"invalid firstIndex"),S(b,y),S(v,g),S(0,b)):(at(b>=v&&b<=g,"invalid firstIndex"),S(b,g),S(0,y),S(v,b))):y>v?S(v,y):y<v&&(S(0,y),S(v,g)),a.bindVAO(null)}}function Zie(e,t,i){const r=e.allocateHead();ptt(t,i,e.view,r)}function ptt(e,t,i,r){p7e(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,r),i.model.copyFrom(r,e.model,t),i.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(r,e.color,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(r,e.featureAttribute,t)}const Qie=M(),wd=ni(),Jie=Te(),Kie=M(),ere=M(),tre=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];class ftt extends Wp{constructor(t,i,r,s){super(t,i,r,s),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this.hasLoadedPBRTextures=!1,this.ensureDrapedStatus(!1),this.hasLoadedPBRTextures=r.physicalBasedRenderingEnabled}getCachedSize(){const[t,i,r]=_(this._resources)?this._resources.symbolSize:[1,1,1];return{width:t,depth:i,height:r}}async doLoad(t){if(!this._drivenProperties.size&&h4(this.symbolLayer))throw new Error;const i=this.symbolLayer;if(this.isPrimitive){const r=i.resource?i.resource.primitive:nce;this._resources=await this._createResourcesForPrimitive(r,t)}else this._resources=await this._createResourcesForUrl(i.resource.href,t);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return _(this._resources)?this._resources.extentPadding:0}get isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return Pr(this._resources,"lodRenderer")}_setMaterialTransparencyParams(t,i=Pr(this.symbolLayer,"material","color")){const r=this._getCombinedOpacity(i),s=r<1||this.needsDrivenTransparentPass;return t.transparent=s,t.opacity=r,t.cullFace=s?Di.None:Di.Back,t}async _createResourcesForPrimitive(t,i){if(!YXe(t))throw new Error(`Unknown object symbol primitive: ${t}`);const r=this.symbolLayer,s=cs(oAe(t)),n=da(mM(s)),o=da(R5(n,r)),a=Pe(o),l=!1,c=!1,h={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:up,diffuse:up,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},p=h.usePBR;this._setMaterialTransparencyParams(h);const f=this.symbol;if(f.type==="point-3d"&&f.verticalOffset){const{screenLength:w,minWorldLength:S,maxWorldLength:T}=f.verticalOffset;h.verticalOffset={screenLength:fo(w),minWorldLength:S||0,maxWorldLength:T!=null?T:1/0},h.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(h.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)h.externalColor=ap;else{const w=_(r.material)&&r.material.color,S=_(w)?Je.toUnitRGBA(w):ap;h.externalColor=S}this._fastUpdates=UR(this._context.renderer,this._fastVisualVariableConvertOptions(s,o,n,Fg)),this._fastUpdates.enabled?(Object.assign(h,this._fastUpdates.materialParameters),h.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(h.instanced.push("color"),this._optionalFields.push("color"));const g=new K1(h),y=fve(t,g);if(!y)throw new Error(`Unknown object symbol primitive: ${t}`);const v=$3(y).map(w=>({opacity:1,transparent:w.parameters.transparent})),b=await this._createStageResources(y,p);return{lodResources:y,lodRenderer:await this._createLodRenderer(y,i),stageResources:b,symbolSize:o,extentPadding:a,isEsriSymbolResource:l,isWosr:c,originalMaterialParameters:v,physicalBasedRenderingEnabled:p,resourceBoundingBox:s,resourceSize:n,dispose:Fg,pivotOffset:Fg}}async _createResourcesForUrl(t,i){const r=["transformation"],s={materialParamsMixin:{instanced:r,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=UR(this._context.renderer,this._fastVisualVariableConvertOptions(Fg,Fg,Fg,Fg)),this._fastUpdates.enabled?(Object.assign(s.materialParamsMixin,this._fastUpdates.materialParameters),r.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(r.push("color"),this._optionalFields.push("color"));const n=this.symbol;if(n.type==="point-3d"&&n.verticalOffset){const{screenLength:z,minWorldLength:V,maxWorldLength:B}=n.verticalOffset;s.materialParamsMixin.verticalOffset={screenLength:fo(z),minWorldLength:V||0,maxWorldLength:B!=null?B:1/0},s.materialParamsMixin.castShadows=!1}s.signal=i,s.usePBR=this._context.physicalBasedRenderingEnabled;const o=s.usePBR,a=await q_e(t,s),l=a.isEsriSymbolResource,c=a.isWosr,h=a.remove,p=JKe(a.lods);eet(p),p.levels.sort((z,V)=>z.minScreenSpaceRadius-V.minScreenSpaceRadius),p.levels[0].minScreenSpaceRadius=Math.min(2,p.levels[0].minScreenSpaceRadius);const f=this._context,g=this.symbolLayer.material,y=this._getExternalColorParameters(g),v=Pr(this.symbolLayer,"material","color"),b=this._getCombinedOpacity(v,{hasIntrinsicColor:!0}),w=this.needsDrivenTransparentPass,S=$3(p),T=$3(p).map(z=>({opacity:z.parameters.opacity||1,transparent:z.parameters.transparent}));S.forEach(z=>{const V=z.parameters;z.setParameters(y);const B=V.opacity*b,J=B<1||w||V.transparent;z.setParameters({opacity:B,transparent:J}),f.screenSizePerspectiveEnabled&&z.setParameters({screenSizePerspective:f.sharedResources.screenSizePerspectiveSettings})});const A=a.referenceBoundingBox,C=da(mM(A)),O=da(p.levels[0].pivotOffset),L=da(R5(C,this.symbolLayer)),U=Pe(L);kR(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(A,L,C,O))&&S.forEach(z=>z.setParameters(this._fastUpdates.materialParameters));const N=await this._createStageResources(p,o);return{lodResources:p,lodRenderer:await this._createLodRenderer(p,i),stageResources:N,symbolSize:L,extentPadding:U,isEsriSymbolResource:l,isWosr:c,originalMaterialParameters:T,physicalBasedRenderingEnabled:o,resourceBoundingBox:A,resourceSize:C,dispose:h,pivotOffset:O}}async _createStageResources(t,i){const r=this._context.stage,s=$3(t);i!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),r.addMany(s);const n=nYe(t);r.addMany(n),await r.load(n);const o=oYe(t);return r.addMany(o),{materials:s,textures:n,geometries:o}}async _createLodRenderer(t,i){const r=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:a=>this._instanceIndexToGraphicUid.get(a),notifyGraphicGeometryChanged:a=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(a)),notifyGraphicVisibilityChanged:a=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(a))},n=this._fastUpdates.enabled?{applyTransform:(a,l,c)=>{a.getFeatureAttribute(l,J3),Ur(c,sG(this._fastUpdates.materialParameters,J3,c))},scaleFactor:(a,l,c)=>(l.getFeatureAttribute(c,J3),xJe(a,this._fastUpdates.materialParameters,J3))}:null,o=new dtt(t,this._optionalFields,s,n);return o.slicePlaneEnabled=this._context.slicePlaneEnabled,await r.addRenderPlugin(o.slots,o,i),o}_getExternalColorParameters(t){const i={};return this._drivenProperties.color?i.externalColor=ap:_(t)&&_(t.color)?i.externalColor=Je.toUnitRGBA(t.color):(i.externalColor=ap,i.colorMixMode="ignore"),i}destroy(){if(super.destroy(),_(this._resources)){const t=this._context.stage;t.removeRenderPlugin(this._resources.lodRenderer);const i=this._resources.stageResources;t.removeMany(i.materials),t.removeMany(i.textures),t.removeMany(i.geometries),_(this._resources.dispose)&&this._resources.dispose(),this._resources=null}}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry))return null;const r=DR(i.geometry);if(R(r))return this.logger.warn(`unsupported geometry type for icon symbol: ${i.geometry.type}`),null;const s=this.setGraphicElevationContext(i,new Mc),n=t.renderingInfo;return this._createAs3DShape(i,r,n,s,i.uid)}notifyDestroyGraphicLayer(t){this._instanceIndexToGraphicUid.delete(t.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(R(this._resources))return!0;const t=this._drivenProperties.opacity,i=!this.isPrimitive,r=this._resources.stageResources.materials,s=this._resources.originalMaterialParameters;for(let n=0;n<r.length;n++){const o=r[n],a=Pr(this.symbolLayer,"material","color"),l=s[n],c=this._getCombinedOpacity(a,{hasIntrinsicColor:i})*l.opacity,h=c<1||t||l.transparent;o.setParameters({opacity:c,transparent:h}),this.isPrimitive&&o.setParameters({cullFace:h?Di.None:Di.Back})}return!0}layerElevationInfoChanged(t,i){return this.updateGraphics3DGraphicElevationInfo(t,i,$0)}slicePlaneEnabledChanged(){if(R(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const t of this._resources.stageResources.materials)t.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(R(this._resources))return!0;const{stageResources:t,isWosr:i}=this._resources;for(const r of t.materials)this.isPrimitive?r.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):i||r.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return this.hasLoadedPBRTextures!==!1||this._context.physicalBasedRenderingEnabled!==!0||(this.hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}applyRendererDiff(t,i){if(R(this._resources))return Es.Recreate_Symbol;const{stageResources:{materials:r},lodRenderer:s,resourceBoundingBox:n,symbolSize:o,resourceSize:a,pivotOffset:l}=this._resources;for(const c in t.diff){if(c!=="visualVariables"||!kR(this._fastUpdates,i,this._fastVisualVariableConvertOptions(n,o,a,l)))return Es.Recreate_Symbol;for(const h of r)h.setParameters(this._fastUpdates.materialParameters);s.notifyShaderTransformationChanged()}return Es.Fast_Update}computeComplexity(){return R(this._resources)?super.computeComplexity():{primitivesPerFeature:xW(this._resources.lodResources.levels[0]).reduce((t,i)=>t+i.indices.get(E.POSITION).length,0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:yve(this.symbol,this.symbolLayer)}}_hasLodRenderer(){return _(this._resources)}_createAs3DShape(t,i,r,s,n){if(!this._hasLodRenderer()||R(this._resources))return null;const o=this.getFastUpdateAttrValues(t),a=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?gC(r.color,r.opacity):null,l=this._context.clippingExtent;if(tn(i,ew,this._context.elevationProvider.spatialReference),_(l)&&!tj(l,ew))return null;const c=this._requiresTerrainElevation(s),h=this._computeGlobalTransform(i,s,rz,K3),p=this._computeLocalTransform(this._resources,this.symbolLayer,r,ire),f=this._resources.lodRenderer.instanceData,g=f.addInstance();this._instanceIndexToGraphicUid.set(g,n),f.setLocalTransform(g,p,!1),f.setGlobalTransform(g,h),o&&f.setFeatureAttribute(g,o),a&&f.setColor(g,a);const y=new YKe(this,g,BXe,s);return c&&(y.alignedSampledElevation=K3.sampledElevation),y.needsElevationUpdates=$0(s.mode),$R(y,i,this._context.elevationProvider),y}_computeGlobalTransform(t,i,r,s){return Dm(t,this._context.elevationProvider,i,this._context.renderCoordsHelper,s),ew[0]=t.x,ew[1]=t.y,ew[2]=s.z,Kh(t.spatialReference,ew,r,this._context.renderCoordsHelper.spatialReference),r}_computeLocalTransform(t,i,r,s){return Ap(s),this._applyObjectRotation(r,!1,s),this._applyObjectRotation(i,!0,s),this._applyObjectScale(t,r,s),this._applyAnchor(t,i,s),s}_applyObjectScale(t,i,r){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._drivenProperties.size&&i.size?i.size:t.symbolSize,n=Ute(s,t.symbolSize,t.resourceSize,this._context.renderCoordsHelper.unitInMeters);n[0]===1&&n[1]===1&&n[2]===1||tF(r,r,n)}prepareSymbolLayerPatch(t){if(t.diff.type!=="partial")return;const i=t.diff.diff;this._preparePatchTransform(t,i),this._preparePatchColor(t,i)}updateGeometry(t,i){if(R(this._resources))return!0;const r=i&&DR(i);if(R(r))return!1;const s=this.getGeometryElevationMode(i);return t.elevationContext.mode===s&&(this._computeGlobalTransform(r,t.elevationContext,rz,K3),this._requiresTerrainElevation(t.elevationContext)&&(t.alignedSampledElevation=K3.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(t.instanceIndex,rz,!0),$R(t,r,this._context.elevationProvider),!0)}_preparePatchTransform(t,i){if(!(i.heading||i.tilt||i.roll||i.width||i.height||i.depth||i.anchor||i.anchorPosition)||R(this._resources))return;const r=(y,v,b)=>gt(y!=null&&y.type==="complete"?y.newValue:v,b),s=r(i.heading,this.symbolLayer.heading,0),n=r(i.tilt,this.symbolLayer.tilt,0),o=r(i.roll,this.symbolLayer.roll,0),a=r(i.width,this.symbolLayer.width,void 0),l=r(i.height,this.symbolLayer.height,void 0),c=r(i.depth,this.symbolLayer.depth,void 0),h=r(i.anchor,this.symbolLayer.anchor,void 0),p=r(i.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete i.heading,delete i.tilt,delete i.roll,delete i.width,delete i.height,delete i.depth,delete i.anchor,delete i.anchorPosition;const f={heading:s,tilt:n,roll:o,anchor:h,anchorPosition:p},g=this._resources;this.loadStatus===ic.LOADED&&t.symbolLayerStatePatches.push(()=>{g.symbolSize=da(R5(g.resourceSize,{width:a,height:l,depth:c,isPrimitive:this.symbolLayer.isPrimitive}))}),t.graphics3DGraphicPatches.push((y,v)=>{const b=this._computeLocalTransform(g,f,v,ire),w=y.instanceIndex;g.lodRenderer.instanceData.setLocalTransform(w,b,!0)})}_preparePatchColor(t,i){if(!i.material||i.material.type!=="partial")return;const r=i.material.diff;if(!r.color||r.color.type!=="complete"||r.color.newValue==null||r.color.oldValue==null)return;const s=r.color.newValue,n=_(s)?Je.toUnitRGBA(s):ap;delete r.color;const o=this._resources;R(o)||t.graphics3DGraphicPatches.push(a=>{let l;this._hasPerInstanceColor()?(o.lodRenderer.instanceData.setColor(a.instanceIndex,n),l=this._setMaterialTransparencyParams({},s)):l=this._setMaterialTransparencyParams({externalColor:n},s);for(const c of o.stageResources.materials)c.setParameters(l)})}_requiresTerrainElevation(t){return t.mode!=="absolute-height"}_applyObjectRotation(t,i,r){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&i))return MXe(t.heading,t.tilt,t.roll,r)}_computeAnchor(t,i,r){const s=M();switch(r.anchor){case"center":ne(s,Fh(t)),mo(s,s);break;case"top":{const n=Fh(t);oe(s,-n[0],-n[1],-t[5]);break}case"bottom":{const n=Fh(t);oe(s,-n[0],-n[1],-t[2]);break}case"relative":{const n=Fh(t),o=mM(t),a=r.anchorPosition,l=a?je(a.x,a.y,a.z):pl;l7(s,o,l),pe(s,s,n),mo(s,s);break}default:_(i)?mo(s,i):ne(s,pl)}return s}_applyAnchor(t,i,r){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._computeAnchor(t.resourceBoundingBox,t.pivotOffset,i);s&&Wo(r,r,s)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(t,i,r,s){const n=_(t)?da(mM(t)):up,o=_(t)?this._computeAnchor(t,s,this.symbolLayer):pl,a=this._context.renderCoordsHelper.unitInMeters,l=Ute(_(i)?i:void 0,i,r,a),c=je(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:n,symbolSize:_(i)?i:up,unitInMeters:a,transformation:{anchor:o,scale:l,rotation:c}}}}const ew=M(),ire=Te(),rz=Te(),J3=ni(),K3=new VO;function mtt(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function gtt(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e}function VW(e,t,i,r,s){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e}function ytt(e,t){if(e===t){const i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e}function vtt(e,t){const i=t[0],r=t[1],s=t[2],n=t[3];let o=i*n-s*r;return o?(o=1/o,e[0]=n*o,e[1]=-r*o,e[2]=-s*o,e[3]=i*o,e):null}function _tt(e,t){const i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e}function btt(e){return e[0]*e[3]-e[2]*e[1]}function X_e(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=i[0],l=i[1],c=i[2],h=i[3];return e[0]=r*a+n*l,e[1]=s*a+o*l,e[2]=r*c+n*h,e[3]=s*c+o*h,e}function wtt(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=r*l+n*a,e[1]=s*l+o*a,e[2]=r*-a+n*l,e[3]=s*-a+o*l,e}function xtt(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=i[0],l=i[1];return e[0]=r*a,e[1]=s*a,e[2]=n*l,e[3]=o*l,e}function Ttt(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=-i,e[3]=r,e}function Stt(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e}function Ett(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}function Att(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2)}function Ctt(e,t,i,r){return e[2]=r[2]/r[0],i[0]=r[0],i[1]=r[1],i[3]=r[3]-e[2]*i[1],[e,t,i]}function Rtt(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e}function Y_e(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}function Ott(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function Mtt(e,t){const i=e[0],r=e[1],s=e[2],n=e[3],o=t[0],a=t[1],l=t[2],c=t[3];return Math.abs(i-o)<=wt*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-a)<=wt*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(s-l)<=wt*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=wt*Math.max(1,Math.abs(n),Math.abs(c))}function Ptt(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e}function Itt(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e}const $tt=X_e,Dtt=Y_e;Object.freeze({__proto__:null,copy:mtt,identity:gtt,set:VW,transpose:ytt,invert:vtt,adjoint:_tt,determinant:btt,multiply:X_e,rotate:wtt,scale:xtt,fromRotation:Ttt,fromScaling:Stt,str:Ett,frob:Att,LDU:Ctt,add:Rtt,subtract:Y_e,exactEquals:Ott,equals:Mtt,multiplyScalar:Ptt,multiplyScalarAndAdd:Itt,mul:$tt,sub:Dtt});class Ltt extends lr{constructor(t,i,r,s,n,o){super(t,i),this.path=r,this.geometrySR=s,this.upVectorAlignment=n,this.stencilWidth=o}}function Z_e(e){return"upVectorAlignment"in e}function Q_e(){return[1,0,0,1]}function Ntt(e){return[e[0],e[1],e[2],e[3]]}function Ftt(e,t,i,r){return[e,t,i,r]}function Utt(e,t){return new Float64Array(e,t,4)}Object.freeze({__proto__:null,create:Q_e,clone:Ntt,fromValues:Ftt,createView:Utt});function uG(){return{up:M(),right:M()}}function ktt(e,t,i){ke(e.up,t.up,i),ke(e.right,t.right,i)}function ztt(e,t,i){rr(e,_e(i,t.right),_e(i,t.up))}class Btt{constructor(){this.pos=M(),this.posES=M(),this.posGS=M(),this.vRight=M(),this.vLeft=M(),this.frame=uG(),this.rotationFrame=uG(),this.rotationRight=Ye(),this.rotationAngle=0,this.miterStretch=Q_e()}setFrameFromUpVector(t){ne(this.frame.up,t),pe(tu,this.vLeft,this.vRight),be(tu,tu),ae(wh,this.frame.up,_e(tu,this.frame.up)),de(tP,tu,wh),be(tP,tP),pt(this.frame.right,tP,this.frame.up)}computeRotationAxisAndAngleFromUpVector(){ne(this.rotationFrame.up,this.frame.up),ne(this.rotationFrame.right,this.frame.right),rr(this.rotationRight,1,0),ae(wh,this.frame.up,_e(this.frame.up,this.vLeft)),de(wh,this.vLeft,wh),mo(wh,wh),be(wh,wh),ae(tu,this.frame.up,_e(this.frame.up,this.vRight)),de(tu,this.vRight,tu),be(tu,tu),pt(hG,this.rotationFrame.up,this.vLeft);const t=Math.sign(_e(hG,this.vRight));if(this.rotationAngle=t*(Math.PI-Rs(_e(wh,tu))),Math.abs(this.rotationAngle)>0){const r=e6(Math.cos(.5*this.rotationAngle));VW(this.miterStretch,r-1+1,0,0,1)}const i=Math.PI-this.rotationAngle;this.maxStretchDistance=Math.abs(Math.min(this.vLeftLength,this.vRightLength)/Math.cos(.5*i))}}class BR{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[],this.uvs=null,this.uvIndices=null}addVertex(t,i){return this.vertices.push(WE(t)),this.vertexNormals.push(WE(i)),this.vertices.length-1}addUV(t){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(t),this.uvs.length-1}addPole(t,i=null){return this.poles.push({position:WE(t),normal:i?WE(i):null}),this.poles.length-1}addSegment(t,i=null,r=null){this.vertexIndices.push(t.v0),this.vertexIndices.push(t.v1),i&&(this.uvIndices.push(i.v0),this.uvIndices.push(i.v1)),r&&(this.poleIndices.push(r.v0),this.poleIndices.push(r.v1))}get numSegments(){return this.vertexIndices.length/2}hasUV(){return this.uvs!=null}translate(t,i){for(const r of this.vertices)r[0]+=t,r[1]+=i;for(const r of this.poles)r.position[0]+=t,r.position[1]+=i}static circle(t=20){const r=new BR,s={v0:0,v1:0};r.addPole(vi(0,0));for(let a=0;a<t;++a){const l=2*a*Math.PI/t,c=Math.cos(l),h=Math.sin(l),p=vi(c*.5,h*.5),f=vi(c,h);r.addVertex(p,f),r.addUV(a/t)}r.addUV(1);for(let a=0;a<t-1;++a){const l={v0:a,v1:a+1},c=l;r.addSegment(l,c,s)}const n={v0:t-1,v1:0},o={v0:t-1,v1:t};return r.addSegment(n,o,s),r}static rect(){const r=new BR,s=vi(.5*-1,.5*-1),n=vi(.5*1,.5*-1),o=vi(.5*1,.5*1),a=vi(.5*-1,.5*1),l=vi(0,-1),c=vi(1,0),h=vi(0,1),p=vi(-1,0);r.addUV(0),r.addUV(1),r.addPole(vi(0,.5*1),h),r.addPole(vi(0,.5*1)),r.addPole(vi(0,.5*-1)),r.addPole(vi(0,.5*-1),l);const f={v0:0,v1:1};return r.addVertex(s,l),r.addVertex(n,l),r.addSegment({v0:0,v1:1},f,{v0:3,v1:3}),r.addVertex(n,c),r.addVertex(o,c),r.addSegment({v0:2,v1:3},f,{v0:2,v1:1}),r.addVertex(o,h),r.addVertex(a,h),r.addSegment({v0:4,v1:5},f,{v0:0,v1:0}),r.addVertex(a,p),r.addVertex(s,p),r.addSegment({v0:6,v1:7},f,{v0:1,v1:2}),r}}class Vtt{constructor(t){this.vertices=[],this.offset=M(),this.xform=Te(),this.vertices=t;const i=Math.floor((t.length-1)/2);ne(this.offset,this.vertices[i].pos);for(const r of this.vertices)de(r.pos,r.pos,this.offset);Wo(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}updatePathVertexInformation(){const t=this.vertices.length;let i=this.vertices[0];i.index=0,oe(i.vLeft,0,0,0),i.vLeftLength=0,de(i.vRight,this.vertices[1].pos,i.pos),i.vRightLength=Pe(i.vRight),be(i.vRight,i.vRight);let r=i;for(let s=1;s<t;++s)i=this.vertices[s],i.index=s,ne(i.vLeft,r.vRight),i.vLeftLength=r.vRightLength,s<t-1?(de(i.vRight,this.vertices[s+1].pos,i.pos),i.vRightLength=Pe(i.vRight),be(i.vRight,i.vRight)):(ne(i.vRight,i.vLeft),i.vRightLength=i.vLeftLength),r=i}}function Gtt(e,t){let i=null;const r=e.vertices.length,s=.99619469809,n=M(),o=M(),a=M(),l=M(),c=M(),h=M(),p=ii();let f=e.vertices[0];ne(o,t),oe(n,0,1,0),Qa.makeOrthoBasisDirUpFallback(f.vRight,o,n,n,a,o,s),ne(f.frame.up,o),ne(f.frame.right,a),i=f;for(let g=1;g<r;++g){f=e.vertices[g],pe(c,f.vLeft,f.vRight);let y=Pe(c);y>0?(y=1/Math.sqrt(y),c[0]=c[0]*y,c[1]=c[1]*y,c[2]=c[2]*y):(c[0]=f.vRight[0],c[1]=f.vRight[1],c[2]=f.vRight[2]),pe(h,i.pos,i.frame.up),WT(f.pos,c,p),db(p,xc(h,f.vLeft),l)?(de(l,l,f.pos),be(o,l),pt(a,c,o),be(a,a)):Qa.makeOrthoBasisDirUpFallback(c,i.frame.up,i.frame.right,n,a,o,s),ne(f.frame.up,o),ne(f.frame.right,a),i=f}}class jtt{numProfilesPerJoin(){return 1}extrude(t,i,r){for(let s=0;s<i.vertices.length;++s)r(t.index,t.frame,i.vertices[s],i.vertexNormals[s],!1)}}class sz{constructor(t=.8*Math.PI,i=1){this.cutoffAngle=t,this.numBendSubdivisions=i}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(t,i,r){const s=Qtt;if(Math.abs(t.rotationAngle)>=this.cutoffAngle)for(let n=0;n<this.numBendSubdivisions+1;++n){Tl(nre,.5*-t.rotationAngle+n*t.rotationAngle/this.numBendSubdivisions,t.rotationFrame.up),ktt(s,t.frame,nre);for(let o=0;o<i.vertices.length;++o)gs(i.vertices[o],t.rotationRight)*t.rotationAngle>=0?r(t.index,s,i.vertices[o],i.vertexNormals[o],!1):(R9(t1,i.vertices[o],t.miterStretch),r(t.index,t.frame,t1,i.vertexNormals[o],!0))}else for(let n=0;n<this.numBendSubdivisions+1;++n)for(let o=0;o<i.vertices.length;++o){const a=gs(i.vertices[o],t.rotationRight)*t.rotationAngle>=0;R9(t1,i.vertices[o],t.miterStretch),r(t.index,t.frame,t1,i.vertexNormals[o],!a)}}}const Htt={generateUV:!1};class GW{rebuildConnectingProfileGeometry(t,i,r){for(let s=0;s<i.vertices.length;++s)r(t.index,t.frame,i.vertices[s],i.vertexNormals[s],0,0)}}class rre extends GW{constructor(){super()}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}}class eP extends GW{constructor(t,i=0,r=!1){super(),this.profile=t,this.profilePlaneOffset=i,this.flip=r}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(t,i,r){for(let s=0;s<i.vertices.length;++s)r(t.index,t.frame,i.vertices[s],i.vertexNormals[s],this.profilePlaneOffset,0)}rebuildCapGeometry(t,i){const r=jW;rr(r,0,0);const s=this.flip?1:-1;for(let n=0;n<this.profile.vertices.length;++n)i(t.index,t.frame,this.profile.vertices[n],r,this.profilePlaneOffset,s)}buildTopology(t,i){const r=this.vertexBufferStart+this.profile.vertexIndices[0];for(let s=1;s<this.profile.numSegments;++s){const n=this.profile.vertexIndices[2*s+0],o=this.profile.vertexIndices[2*s+1],a=this.vertexBufferStart+n,l=this.vertexBufferStart+o;this.flip?i(l,a,r):i(r,a,l)}}}class sre extends GW{constructor(t){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=t.profile,this.flip=t.flip,this.sign=this.flip?1:-1,this.breakNormals=t.breakNormals,this.numSegments=t.subdivisions}getNumVertices(){let t=0;return t=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(t+=this.profile.vertices.length),t+=this.profile.poles.length,t}getNumIndices(){let t=0;t+=2*this.profile.numSegments*(this.numSegments-1);for(let i=0;i<this.profile.numSegments;++i){const r=this.profile.vertexIndices[2*i+0],s=this.profile.vertexIndices[2*i+1];this.profile.poleIndices[r]===this.profile.poleIndices[s]?t+=1:t+=2}return 3*t}rebuildCapGeometry(t,i){const r=t.frame,s=.5*this.sign,n=t1,o=jW;rr(o,0,0);for(let a=0;a<this.profile.poles.length;++a){const l=this.profile.poles[a];l.normal?i(t.index,r,l.position,l.normal,s,0):i(t.index,r,l.position,o,s,this.sign)}if(this.breakNormals)for(let a=0;a<this.profile.vertices.length;++a)i(t.index,r,this.profile.vertices[a],this.profile.vertexNormals[a],0,0);for(let a=0;a<this.numSegments-1;++a){const l=(1-(a+1)/this.numSegments)*Math.PI*.5,c=Math.sin(l),h=Math.cos(l);for(let p=0;p<this.profile.vertices.length;++p){const f=this.profile.poles[this.profile.poleIndices[p]];lp(n,this.profile.vertices[p],f.position),nl(n,n,c),f.normal?(Mh(n,n,f.position),i(t.index,r,n,f.normal,s*h,0)):(oR(o,n),nl(o,o,c),Mh(n,n,f.position),i(t.index,r,n,o,s*h,this.sign*h))}}}buildTopology(t,i){const r=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,s=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let n=0;n<this.profile.numSegments;++n){const o=this.profile.vertexIndices[2*n+0],a=this.profile.vertexIndices[2*n+1],l=this.vertexBufferStart+this.profile.poleIndices[o],c=this.vertexBufferStart+this.profile.poleIndices[a];let h=r+o,p=r+a;for(let f=0;f<this.numSegments-1;++f){const g=s+f*this.profile.vertices.length+o,y=s+f*this.profile.vertices.length+a;this.flip?(i(g,p,h),i(p,g,y)):(i(h,p,g),i(y,g,p)),h=g,p=y}this.flip?(i(l,p,h),l!==c&&i(l,c,p)):(i(h,p,l),l!==c&&i(p,c,l))}}}class qtt{constructor(t,i,r,s,n,o=Htt){this.options=o,this._extrusionVertexCount=0,this._triangleCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this.profile=i,this.path=t,this.extruder=r,this.startCap=s,this.endCap=n;const a=this.path.vertices.length-2;this.numExtrusionProfiles=r.numProfilesPerJoin()*a+2,this.numVerticesTotal=i.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const l=this.startCap.getNumVertices();this.numVerticesTotal+=l,this.numNormalsTotal+=l,this.endCap.vertexBufferStart=this.numVerticesTotal;const c=this.endCap.getNumVertices();this.numVerticesTotal+=c,this.numNormalsTotal+=c,this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.profileRightAxisData=new Float32Array(4*this.numVerticesTotal),this.profileUpAxisData=new Float32Array(4*this.numVerticesTotal),this.profileVertexAndNormalData=new Float32Array(4*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.originData=new Float32Array(3*this.path.vertices.length),this._rebuildGeometry(),this.buildTopology()}emitVertex(t,i,r,s,n){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=i.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=i.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=i.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=i.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=i.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=i.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=r[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=t,n){const o=this.path.vertices[t];this.profileRightAxisData[4*this._extrusionVertexCount+3]=o.rotationRight[0]*o.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=o.rotationRight[1]*o.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}emitCapVertex(t,i,r,s,n,o){this.profileRightAxisData[4*this._extrusionVertexCount+0]=i.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=i.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=i.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=i.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=i.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=i.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=r[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=t,this.profileRightAxisData[4*this._extrusionVertexCount+3]=n,this.profileUpAxisData[4*this._extrusionVertexCount+3]=o,++this._extrusionVertexCount}emitTriangle(t,i,r){this.vertexIndices[3*this._triangleCount+0]=t,this.vertexIndices[3*this._triangleCount+1]=i,this.vertexIndices[3*this._triangleCount+2]=r,this.pathVertexIndices[3*this._triangleCount+0]=this.pathVertexData[t],this.pathVertexIndices[3*this._triangleCount+1]=this.pathVertexData[i],this.pathVertexIndices[3*this._triangleCount+2]=this.pathVertexData[r],this.normalIndices[3*this._triangleCount+0]=t,this.normalIndices[3*this._triangleCount+1]=i,this.normalIndices[3*this._triangleCount+2]=r,++this._triangleCount}_rebuildGeometry(){const t=(r,s,n,o,a)=>this.emitVertex(r,s,n,o,a),i=(r,s,n,o,a,l)=>this.emitCapVertex(r,s,n,o,a,l);this._extrusionVertexCount=0;for(const r of this.path.vertices)this.originData[3*r.index+0]=r.pos[0],this.originData[3*r.index+1]=r.pos[1],this.originData[3*r.index+2]=r.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,i);for(let r=1;r<this.path.vertices.length-1;++r)this.extruder.extrude(this.path.vertices[r],this.profile,t);if(this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,i),this.startCap.rebuildCapGeometry(this.path.vertices[0],i),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],i),this.profile.hasUV()&&this.options.generateUV)for(let r=0;r<this.profile.uvs.length;++r)this.uvData[2*r+0]=this.profile.uvs[r],this.uvData[2*r+1]=0}buildTopology(){const t=(o,a,l)=>this.emitTriangle(o,a,l);this._triangleCount=0;const i=this.profile.vertices.length,r=this.profile.numSegments,s=this.numExtrusionProfiles-1;let n=3*(2*(r*s));this.startCap.indexBufferStart=n,this.startCap.firstProfileVertexIndex=0,n+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=n,this.endCap.firstProfileVertexIndex=i*(this.numExtrusionProfiles-1),n+=this.endCap.getNumIndices(),this.vertexIndices=new Uint32Array(n),this.normalIndices=new Uint32Array(n),this.pathVertexIndices=new Uint32Array(n),this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Uint32Array(n));for(let o=0;o<r;++o){const a=this.profile.vertexIndices[2*o],l=this.profile.vertexIndices[2*o+1];for(let c=0;c<s;++c){const h=c*i+a,p=(c+1)*i+l,f=c*i+l;t(h,(c+1)*i+a,p),t(h,p,f)}}this.startCap.buildTopology(this.path.vertices[0],t),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],t)}onPathChanged(){this._rebuildGeometry()}}class J_e{constructor(t){this.builder=t}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged()}}class K_e extends J_e{constructor(t){super(t),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=new Float32Array(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Float32Array(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255}bakeVertexColors(t){this.vertexAttributeColor[0]=255*t[0],this.vertexAttributeColor[1]=255*t[1],this.vertexAttributeColor[2]=255*t[2],this.vertexAttributeColor[3]=255*(t.length>3?t[3]:1)}bake(t){this.size=t;for(let i=0;i<this.builder.numVerticesTotal;++i){let r=this.builder.pathVertexData[i];const s=r===0||r===this.builder.path.vertices.length-1;r*=3;const n=Xtt;oe(n,this.builder.originData[r++],this.builder.originData[r++],this.builder.originData[r]);const o=4*i,a=wh,l=t1,c=tu,h=hG,p=Ztt;let f=0,g=0;if(oe(h,this.builder.profileRightAxisData[o],this.builder.profileRightAxisData[o+1],this.builder.profileRightAxisData[o+2]),oe(p,this.builder.profileUpAxisData[o],this.builder.profileUpAxisData[o+1],this.builder.profileUpAxisData[o+2]),rr(l,this.builder.profileVertexAndNormalData[o]*t[0],this.builder.profileVertexAndNormalData[o+1]*t[1]),s)pt(c,p,h),f=this.builder.profileRightAxisData[o+3]*t[0],g=this.builder.profileUpAxisData[o+3];else{const v=jW,b=Ytt;rr(v,this.builder.profileRightAxisData[o+3],this.builder.profileUpAxisData[o+3]);const w=uq(v);oR(v,v);const S=gs(l,v);if(Math.abs(S)>w){rr(b,-v[1],v[0]);const T=gs(l,b);nl(v,v,w*Math.sign(S)),nl(b,b,T),Mh(l,v,b)}oe(c,0,0,0)}oe(a,h[0]*l[0]+p[0]*l[1],h[1]*l[0]+p[1]*l[1],h[2]*l[0]+p[2]*l[1]),this.vertexAttributePosition[3*i+0]=n[0]+a[0]+c[0]*f,this.vertexAttributePosition[3*i+1]=n[1]+a[1]+c[1]*f,this.vertexAttributePosition[3*i+2]=n[2]+a[2]+c[2]*f;const y=t1;rr(y,this.builder.profileVertexAndNormalData[o+2],this.builder.profileVertexAndNormalData[o+3]),this.vertexAttributeNormal[3*i+0]=h[0]*y[0]+p[0]*y[1]+c[0]*g,this.vertexAttributeNormal[3*i+1]=h[1]*y[0]+p[1]*y[1]+c[1]*g,this.vertexAttributeNormal[3*i+2]=h[2]*y[0]+p[2]*y[1]+c[2]*g}}createGeometryData(){const t=[[E.POSITION,this.builder.vertexIndices],[E.NORMAL,this.builder.normalIndices]],i=[[E.POSITION,{size:3,data:this.vertexAttributePosition,exclusive:!0}],[E.NORMAL,{size:3,data:this.vertexAttributeNormal,exclusive:!0}]];if(this.vertexAttributeColor){const r=this.builder.vertexIndices.length;t.push([E.COLOR,new Uint32Array(r)]),i.push([E.COLOR,{size:4,data:this.vertexAttributeColor}])}return{vertexAttributes:i,indices:t}}onPathChanged(){super.onPathChanged(),this.bake(this.size)}intersect(t,i,r){const s=this.builder.vertexIndices,n={size:3,data:this.vertexAttributePosition},o=s.length/3;LO(t,i,0,o,s,n,void 0,void 0,r)}}class Wtt extends J_e{constructor(t,i,r,s){super(t),this.sizeAttributeValue=i,this.colorAttributeValue=r,this.opacityAttributeValue=s,this.vvData=null,this.baked=new K_e(t),this.vvData=new Float32Array(4*this.builder.path.vertices.length);for(let n=0;n<this.builder.path.vertices.length;++n){this.vvData[4*n+0]=i,this.vvData[4*n+1]=r,this.vvData[4*n+2]=s;const o=n===0||n===this.builder.path.vertices.length-1;this.vvData[4*n+3]=o?1:0}}createGeometryData(){return{vertexAttributes:[[E.POSITION,{size:3,data:this.builder.originData,exclusive:!0}],[E.PROFILERIGHT,{size:4,data:this.builder.profileRightAxisData,exclusive:!0}],[E.PROFILEUP,{size:4,data:this.builder.profileUpAxisData,exclusive:!0}],[E.PROFILEVERTEXANDNORMAL,{size:4,data:this.builder.profileVertexAndNormalData,exclusive:!0}],[E.FEATUREVALUE,{size:4,data:this.vvData,exclusive:!0}]],indices:[[E.POSITION,this.builder.pathVertexIndices],[E.PROFILERIGHT,this.builder.vertexIndices],[E.PROFILEUP,this.builder.vertexIndices],[E.PROFILEVERTEXANDNORMAL,this.builder.vertexIndices],[E.FEATUREVALUE,this.builder.pathVertexIndices]]}}}const Xtt=M(),t1=Ye(),jW=Ye(),Ytt=Ye(),wh=M(),tu=M(),hG=M(),Ztt=M(),tP=M(),Qtt=uG(),nre=Te();function Jtt(e,t){e.attributes.add(E.FEATUREVALUE,"vec4"),e.vertex.code.add(x`bool isCapVertex() {
return featureValue.w == 1.0;
}`),e.vertex.uniforms.add("size","vec3"),t.vvSize?(e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.code.add(x`vec2 getSize() {
return size.xy*clamp(vvSizeOffset + featureValue.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
}`)):e.vertex.code.add(x`vec2 getSize(){
return size.xy;
}`),t.vvOpacity?(e.vertex.constants.add("vvOpacityNumber","int",8),e.vertex.code.add(x`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
vec4 applyOpacity(vec4 color) {
float value = featureValue.z;
if (value <= vvOpacityValues[0]) {
return vec4( color.xyz, vvOpacityOpacities[0]);
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
}
}
return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
}`)):e.vertex.code.add(x`vec4 applyOpacity(vec4 color){
return color;
}`),t.vvColor?(e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(x`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 getColor() {
float value = featureValue.y;
if (value <= vvColorValues[0]) {
return applyOpacity(vvColorColors[0]);
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
}
}
return applyOpacity(vvColorColors[vvColorNumber - 1]);
}`)):e.vertex.code.add(x`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),e.include(A4),e.attributes.add(E.PROFILERIGHT,"vec4"),e.attributes.add(E.PROFILEUP,"vec4"),e.attributes.add(E.PROFILEVERTEXANDNORMAL,"vec4"),e.vertex.code.add(x`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),e.vertex.code.add(x`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),e.vertex.code.add(x`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),e.vertex.code.add(x`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}function Ktt(e,t){t.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",t.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",t.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",t.vvSizeOffset),e.setUniform3fv("vvSizeFactor",t.vvSizeFactor)),t.vvColorEnabled&&(e.setUniform1fv("vvColorValues",t.vvColorValues),e.setUniform4fv("vvColorColors",t.vvColorColors)),t.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",t.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",t.vvOpacityOpacities))}function eit(e){const t=new Oi;return t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("cameraPosition","vec3").add("localOrigin","vec3"),t.varyings.add("vpos","vec3"),t.include(Jtt,e),e.output!==j.Color&&e.output!==j.Alpha||(t.include(Gn,{linearDepth:!1}),e.receiveShadows&&t.include(Lm,e),t.include(HO,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vcolor","vec4"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(x`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${e.output===j.Color?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(Os),t.include(Ec,e)),e.output===j.Alpha&&(t.include(Or,e),t.fragment.uniforms.add("cameraPosition","vec3"),t.fragment.uniforms.add("localOrigin","vec3"),t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `)),e.output===j.Color&&(t.include(Or,e),t.include(J1,e),t.include(R4,e),e.receiveShadows&&t.include(Lm,e),t.include(n_e,e),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("specular","vec3").add("opacity","float"),t.fragment.include(Vp),t.fragment.code.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

        shadingParams.viewDirection = normalize(vpos - cameraPosition);
        shadingParams.normalView = vnormal;
        vec3 normal = shadingNormal(shadingParams);
        float ssao = evaluateAmbientOcclusionInverse();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.viewingMode===Ie.Global?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
        float combinedOpacity = vcolor.a * opacity;
        albedo += 0.25 * specular; // don't completely ignore specular for now

        vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
        gl_FragColor = vec4(shadedColor, combinedOpacity);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.output!==j.Depth&&e.output!==j.Shadow||(t.include(Gn,{linearDepth:!0}),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("depth","float"),t.vertex.code.add(x`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),t.include(Or,e),t.include(q0,e),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(x`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`)),e.output===j.Normal&&(t.include(Gn,{linearDepth:!1}),t.include(e0,e),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vnormal","vec3"),t.vertex.code.add(x`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(Or,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(x`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`)),e.output===j.Highlight&&(t.include(Gn,{linearDepth:!1}),t.include(e0,e),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vnormal","vec3"),t.vertex.code.add(x`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(Or,e),t.include(Qm),t.fragment.code.add(x`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}const tit=Object.freeze({__proto__:null,build:eit}),e1e=new Map([[E.POSITION,0],[E.PROFILERIGHT,1],[E.PROFILEUP,2],[E.PROFILEVERTEXANDNORMAL,3],[E.FEATUREVALUE,4]]);class U4 extends Gi{initializeProgram(t){const i=U4.shader.get(),r=this.configuration,s=i.build({oitEnabled:r.transparencyPassType===lt.Color,output:r.output,viewingMode:t.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:r.receiveShadows,vvSize:r.vvSize,vvColor:r.vvColor,vvInstancingEnabled:!0,vvOpacity:r.vvOpacity,pbrMode:xt.Disabled,useCustomDTRExponentForWater:!1,receiveAmbientOcclusion:r.receiveSSAO,doubleSidedMode:r.doubleSidedMode,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Mi(t.rctx,s,e1e)}bindPass(t,i){var r,s;Ol(this.program,i.camera.projectionMatrix),this.program.setUniform3fv("size",t.size),i.multipassTerrainEnabled&&(this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniform2fv("inverseViewport",i.inverseViewport),Jm(this.program,i)),this.configuration.output!==j.Color&&this.configuration.output!==j.Alpha||this.program.setUniform1f("opacity",t.opacity),this.configuration.output===j.Color?(i.lighting.setUniforms(this.program,!1,!1),this.program.setUniform3fv("ambient",t.ambient),this.program.setUniform3fv("diffuse",t.diffuse),this.program.setUniform3fv("specular",t.specular),this.program.setUniform1f("opacity",t.opacity)):this.configuration.output!==j.Depth&&this.configuration.output!==j.Shadow||this.program.setUniform2fv("nearFar",i.camera.nearFar),Ktt(this.program,t),(r=i.shadowMap)==null||r.bind(this.program),(s=i.ssaoHelper)==null||s.bind(this.program,i.camera)}bindDraw(t){Gp(this.program,t),wb(this.program,this.configuration,t),this.program.rebindTextures(),this.configuration.output!==j.Color&&this.configuration.output!==j.Alpha||j0(this.program,t.origin,t.camera.viewInverseTransposeMatrix),this.configuration.output===j.Color&&JYe(this.program,t),this.configuration.output===j.Normal&&LQe(this.program,t.camera.viewInverseTransposeMatrix)}_setPipelineState(t){const i=this.configuration,r=t===lt.NONE,s=t===lt.FrontFace,n=o=>!o.slicePlaneEnabled&&!(o.transparent||o.doubleSidedMode===hr.None);return Ot({blending:i.output!==j.Color&&i.output!==j.Alpha||!i.transparent?null:r?gl:Km(t),culling:n(i)&&uge,depthTest:{func:H0(t)},depthWrite:r||s?Ma:null,colorWrite:Ft,stencilWrite:i.sceneHasOcludees?Ip:null,stencilTest:i.sceneHasOcludees?W0:null,polygonOffset:r||s?null:c4})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}U4.shader=new Ni(tit,()=>import("./Path.glsl.3ca8c09c.js"));class Ha extends mr{constructor(){super(...arguments),this.output=j.Color,this.doubleSidedMode=hr.None,this.receiveShadows=!1,this.receiveSSAO=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.sceneHasOcludees=!1,this.transparencyPassType=lt.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Z({count:j.COUNT})],Ha.prototype,"output",void 0),u([Z({count:hr.COUNT})],Ha.prototype,"doubleSidedMode",void 0),u([Z()],Ha.prototype,"receiveShadows",void 0),u([Z()],Ha.prototype,"receiveSSAO",void 0),u([Z()],Ha.prototype,"vvSize",void 0),u([Z()],Ha.prototype,"vvColor",void 0),u([Z()],Ha.prototype,"vvOpacity",void 0),u([Z()],Ha.prototype,"slicePlaneEnabled",void 0),u([Z()],Ha.prototype,"transparent",void 0),u([Z()],Ha.prototype,"sceneHasOcludees",void 0),u([Z({count:lt.COUNT})],Ha.prototype,"transparencyPassType",void 0),u([Z()],Ha.prototype,"multipassTerrainEnabled",void 0),u([Z()],Ha.prototype,"cullAboveGround",void 0);class HW extends od{constructor(t){super(t,rit),this.supportsEdges=!0,this._vertexAttributeLocations=e1e,this.techniqueConfig=new Ha,this.vertexBufferLayout=HW.getVertexBufferLayout(this.parameters)}getTechniqueConfig(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,t!==j.Color&&t!==j.Alpha||(this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?hr.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?hr.WindingOrder:hr.None,this.techniqueConfig.receiveShadows=this.parameters.receiveShadows,this.techniqueConfig.receiveSSAO=!!i.ssaoEnabled&&this.parameters.receiveSSAO),this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}isVisibleInPass(t){return t!==Le.MATERIAL_DEPTH_SHADOWMAP_ALL&&t!==Le.MATERIAL_DEPTH_SHADOWMAP_DEFAULT&&t!==Le.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT||this.parameters.castShadows}isVisible(){const t=this.parameters;return!!super.isVisible()&&t.opacity>0}intersect(t,i,r,s,n,o,a){const l=t;if(!Z_e(l))return;const c=l.path,h=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSizeEnabled){const w=this.parameters.vvSizeOffset,S=this.parameters.vvSizeFactor,T=this.parameters.vvSizeMinSize,A=this.parameters.vvSizeMaxSize,C=c.sizeAttributeValue;h[0]*=Be(w[0]+C*S[0],T[0],A[0]),h[1]*=Be(w[2]+C*S[2],T[2],A[2])}const p=Math.max(h[0],h[1]),f=t.boundingInfo;if(R(f))return void this._intersectTriangles(c,h,n,o,a);const g=C1(f.bbMin[0]-p,f.bbMin[1]-p,f.bbMin[2]-p,f.bbMax[0]+p,f.bbMax[1]+p,f.bbMax[2]+p),y=[o[0]-n[0],o[1]-n[1],o[2]-n[2]],v=Math.sqrt(y[0]*y[0]+y[1]*y[1]+y[2]*y[2]),b=[v/y[0],v/y[1],v/y[2]];nW(g,n,b,s.tolerance)&&this._intersectTriangles(c,h,n,o,a)}_intersectTriangles(t,i,r,s,n){t.baked.size&&t.baked.size[0]===i[0]&&t.baked.size[1]===i[1]||t.baked.bake(i),t.baked.intersect(r,s,n)}computeAttachmentOrigin(t,i){const r=t.vertexAttributes;if(!r)return null;const s=r.get(E.POSITION);return Iq(s,null,!1,i)}createBufferWriter(){return new sit(this.vertexBufferLayout)}requiresSlot(t){return t===(this.parameters.transparent?ve.TRANSPARENT_MATERIAL:ve.OPAQUE_MATERIAL)||t===ve.DRAPED_MATERIAL}createGLMaterial(t){return t.output===j.Color||t.output===j.Alpha||t.output===j.Depth||t.output===j.Normal||t.output===j.Highlight||t.output===j.Shadow&&this.parameters.castShadows?new iit(t):null}static getVertexBufferLayout(t){let i=kr().vec3f(E.POSITION).vec4f(E.PROFILERIGHT).vec4f(E.PROFILEUP).vec4f(E.PROFILEVERTEXANDNORMAL);return(t.vvColorEnabled||t.vvSizeEnabled||t.vvOpacityEnabled)&&(i=i.vec4f(E.FEATUREVALUE)),i}}class iit extends Zm{updateParameters(t){return this.ensureTechnique(U4,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}_updateShadowState(t){(R(this.technique)||t.shadowMappingEnabled!==this.technique.configuration.receiveShadows)&&this._material.setParameters({receiveShadows:t.shadowMappingEnabled})}beginSlot(t){return this._output!==j.Color&&this._output!==j.Alpha||(this._updateShadowState(t),this._updateOccludeeState(t)),this.updateParameters(t)}bind(t,i){i.bindPass(this._material.getPassParameters(),t)}}const rit=I(I({size:[1,1,1],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],opacity:1,doubleSided:!1,doubleSidedType:"normal",receiveSSAO:!0,receiveShadows:!1,castShadows:!0,slicePlaneEnabled:!1,transparent:!1,sceneHasOcludees:!1},MW),ju);class sit{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(E.POSITION).length}write(t,i,r,s){const n=o=>{if(i.vertexAttributes.has(o)){const a=i.vertexAttributes.get(o),l=i.indices.get(o);at(a.size===4);const c=r.getField(o,rn);if(!c)throw new Error("unable to acquire view for "+o);xS(l,a.data,c,s)}};n(E.PROFILERIGHT),n(E.PROFILEUP),n(E.PROFILEVERTEXANDNORMAL),this.vertexBufferLayout.hasField(E.FEATUREVALUE)&&n(E.FEATUREVALUE),o4(i,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,r,s)}}const nit=["polyline"];class oit extends Wp{constructor(t,i,r,s){super(t,i,r,s),this._intrinsicSize=vi(1,1),this.upVectorAlignment="path",this.stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const t=_(this.symbolLayer.width)?this.symbolLayer.width:this.symbolLayer.height,i=_(this.symbolLayer.height)?this.symbolLayer.height:t;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[t,1,i],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=UR(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const r=this.symbolLayer.anchor||"center";this.upVectorAlignment="path",this.symbolLayer.profileRotation==="heading"&&(this.upVectorAlignment="world");const s=this.symbolLayer.profile||"circle";switch(s){case"circle":default:this._profile=BR.circle(hit);break;case"quad":this._profile=BR.rect()}let n=[0,0];switch(r!=="center"&&(n={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[r],this._profile.translate(n[0],n[1])),this.symbolLayer.join||"simple"){case"round":this._extruder=new sz(0,uit);break;case"bevel":this._extruder=new sz(0,1);break;case"miter":this._extruder=new sz(.8*Math.PI,1);break;default:this._extruder=new jtt}const o=this.symbolLayer.cap||"butt";switch(o){case"none":this._startCap=new rre,this._endCap=new rre;break;case"butt":default:this._startCap=new eP(this._profile,0),this._endCap=new eP(this._profile,0,!0);break;case"square":this._startCap=new eP(this._profile,-.5),this._endCap=new eP(this._profile,.5,!0);break;case"round":{const g=s==="quad";this._startCap=new sre({profile:this._profile,flip:!1,breakNormals:g,subdivisions:lre}),this._endCap=new sre({profile:this._profile,flip:!0,breakNormals:g,subdivisions:lre});break}}const a=Pr(this.symbolLayer,"material","color"),l=this._getCombinedOpacityAndColor(a),c=da(l),h=l[3],p=h<1||this.needsDrivenTransparentPass,f={diffuse:c,ambient:c,opacity:h,transparent:p,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:p||o==="none"?Di.None:Di.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(rr(this._intrinsicSize,t,i),!GL(this._intrinsicSize[0])||!GL(this._intrinsicSize[1])))throw new q("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||nl(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(Object.assign(f,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new HW(f)):(f.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new K1(f)),this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,nit,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(i,new Mc),s=t.renderingInfo;return this._createAs3DShape(i,s,r,i.uid)}layerOpacityChanged(){const t=Pr(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(t),r=i<1||this.needsDrivenTransparentPass;return this._material.setParameters({opacity:i,transparent:r}),!0}layerElevationInfoChanged(t,i){return this.updateGraphics3DGraphicElevationInfo(t,i,$0)}slicePlaneEnabledChanged(){return this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}applyRendererDiff(t,i){for(const r in t.diff){if(r!=="visualVariables"||!kR(this._fastUpdates,i,this._vvConvertOptions))return Es.Recreate_Symbol;this._material.setParameters(this._fastUpdates.materialParameters)}return Es.Fast_Update}getVertexData(t){let i=0;const r=t.paths,s=[],n=t.spatialReference,o=this._context.elevationProvider.spatialReference,a=this._context.renderCoordsHelper.spatialReference;for(const g of r)i+=g.length;const l=new Float64Array(3*i),c=new Float64Array(3*i),h=new Float64Array(3*i);let p=0;for(const g of r){s.push({index:p,numVertices:g.length});for(const y of g)l[p++]=y[0],l[p++]=y[1],l[p++]=t.hasZ?y[2]:0}let f=!0;return n.equals(o)?this._copyVertices(l,0,c,0,i):f=br(l,n,0,c,o,0,i),o.equals(a)?this._copyVertices(c,0,h,0,i):br(c,o,0,h,a,0,i),{pathVertexDataInfos:s,vertexDataGS:l,vertexDataES:c,vertexDataRS:h,projectionSuccess:f,terrainElevation:0}}_copyVertices(t,i,r,s,n){i*=3,s*=3;for(let o=0;o<n;++o)r[s++]=t[i++],r[s++]=t[i++],r[s++]=t[i++]}_createAs3DShape(t,i,r,s){const n=t.geometry,o=new Array,a=new Array,l=new Array,c=n.spatialReference,h=cs(),p=this._context.renderCoordsHelper;i1e.spatialReference=c;const f=this.getVertexData(n);if(!f.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(f.pathVertexDataInfos.length>0){for(let g=0;g<f.pathVertexDataInfos.length;++g){const y=f.pathVertexDataInfos[g],v=y.index,b=y.numVertices;if(b<2||_(this._context.clippingExtent)&&(ki(h),uc(h,f.vertexDataES,3*v,b),!Uh(h,this._context.clippingExtent)))continue;const w=[];for(let U=v;U<v+3*b;){const N=U++,z=U++,V=U++,B=new Btt;oe(B.posGS,f.vertexDataGS[N],f.vertexDataGS[z],f.vertexDataGS[V]),oe(B.posES,f.vertexDataES[N],f.vertexDataES[z],f.vertexDataES[V]);const J=PXe(B.posES,this._context.elevationProvider,r,p);oe(Su,f.vertexDataRS[N],f.vertexDataRS[z],f.vertexDataRS[V]),p.setAltitude(Su,J),oe(B.pos,Su[0],Su[1],Su[2]),w.push(B)}const S=new Vtt(w);t1e(S,this.upVectorAlignment,this._context.renderCoordsHelper);const T=new qtt(S,this._profile,this._extruder,this._startCap,this._endCap);let A=null;if(this._fastUpdates.enabled){const U=this._fastUpdates.visualVariables,N=U.size?_m(U.size.field,t):0,z=U.color?_m(U.color.field,t):0,V=U.opacity?_m(U.opacity.field,t):0;A=new Wtt(T,N,z,V)}else{const U=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(U[0]*=ore(i.size[0],i.size[2]==="symbol-value"?this.symbolLayer.height||0:i.size[2],this.symbolLayer.width||0),U[1]*=ore(i.size[2],i.size[0]==="symbol-value"?this.symbolLayer.width||0:i.size[0],this.symbolLayer.height||0));let N=null;this._drivenProperties.color&&(N=i.color),this._drivenProperties.opacity&&i.opacity!=null&&(N=N?[N[0],N[1],N[2],i.opacity]:[1,1,1,i.opacity]);const z=new K_e(T);z.bake(U),N&&z.bakeVertexColors(N),A=z}const{vertexAttributes:C,indices:O}=A.createGeometryData(),L=new Ltt(C,O,A,c,this.upVectorAlignment,this.stencilWidth);o.push(L),a.push(this._material),l.push(A.xform)}if(o.length>0){const g={layerUid:this._context.layer.uid,graphicUid:s},y=new tg({geometries:o,materials:a,transformations:l,metadata:g}),v=new qp(this,y,o,null,null,lit,r);return v.alignedSampledElevation=f.terrainElevation,v.needsElevationUpdates=$0(r.mode),v}}else n.paths.length!==0&&n.paths.some(g=>g.length>0)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null}}function t1e(e,t,i){switch(t){case"world":for(const r of e.vertices)pe(xd,r.pos,e.offset),i.worldUpAtPosition(xd,Su),r.setFrameFromUpVector(Su),r.computeRotationAxisAndAngleFromUpVector();break;case"path":pe(xd,e.vertices[0].pos,e.offset),i.worldUpAtPosition(xd,Su),Gtt(e,Su);for(const r of e.vertices){const s=Math.sign(_e(r.frame.right,r.vRight));pt(r.rotationFrame.up,r.vRight,r.vLeft),ae(r.rotationFrame.up,r.rotationFrame.up,s),be(r.rotationFrame.up,r.rotationFrame.up);const n=_e(r.rotationFrame.up,r.frame.up),o=_e(r.rotationFrame.up,r.frame.right);if(ae(xd,r.frame.up,-o),ae(are,r.frame.right,n),pe(xd,xd,are),be(r.rotationFrame.right,xd),ztt(r.rotationRight,r.frame,r.rotationFrame.right),mo(xd,r.vLeft),r.rotationAngle=-s*(Math.PI-Rs(_e(xd,r.vRight))),Math.abs(r.rotationAngle)>0){const l=e6(Math.cos(.5*r.rotationAngle));VW(r.miterStretch,1+(l-1)*r.rotationRight[0]*r.rotationRight[0],(l-1)*r.rotationRight[0]*r.rotationRight[1],(l-1)*r.rotationRight[0]*r.rotationRight[1],1+(l-1)*r.rotationRight[1]*r.rotationRight[1])}const a=Math.PI-r.rotationAngle;r.maxStretchDistance=Math.abs(Math.min(r.vLeftLength,r.vRightLength)*e6(Math.cos(.5*a)))}}}function ore(e,t,i){switch(e){case"symbol-value":return i;case"proportional":return t;default:return e}}function ait(e,t,i,r){let s=0;for(const n of e.vertices)Dm(n.posES,i,t,r,nz),s+=nz.sampledElevation,pe(Su,n.pos,e.offset),r.setAltitude(Su,nz.z),de(n.pos,Su,e.offset);return e.updatePathVertexInformation(),s/e.vertices.length}function lit(e,t,i,r){const s=e.stageObject,n=s.geometryRecords;let o=0;cit.spatialReference=r.spatialReference;for(const a of n){const l=a.geometry;if(!Z_e(l))continue;const c=l.path,h=c.builder.path,p=l.geometrySR;i1e.spatialReference=p,o+=ait(h,t,i,r),l.upVectorAlignment!=="world"&&t1e(h,l.upVectorAlignment,r),c.onPathChanged(),l.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(a)}return o/n.length}const cit=eg(0,0,0,null),i1e=eg(0,0,0,null),Su=M(),xd=fi(),are=fi(),nz=new VO,uit=3,lre=3,hit=10;function dit(e,t,i,r,s=1){if(i.isGeographic&&r===Ie.Global){const a=new Float64Array(t.typedBuffer.length),l=3*t.count,c=di(i);for(let h=0;h<l;h+=3)Pj(t.typedBuffer,h,a,h,c);t=Xr.fromTypedArray(a)}rr(vs,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let a=0;a<t.count;a++)t.getVec(a,rl),vs[0]=Math.min(vs[0],rl[0]),vs[1]=Math.min(vs[1],rl[1]);const n=vs[0]%s,o=vs[1]%s;vu[0]=vs[0]-n,vu[1]=vs[1]-o;for(let a=0;a<t.count;a++)t.getVec(a,rl),e.setValues(a,(rl[0]-vu[0])/s,(rl[1]-vu[1])/s,vu[0]/s,vu[1]/s)}function r1e(e,t,i,r,s=1){oe(vv,1,0,0),oe(_v,0,1,0),oe(tw,0,0,1),mit(oz,t),pit(t,cre)&&fit(cre,vv,_v,tw,i,oz),rr(vs,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),rr(bv,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let l=0;l<t.count;l++){t.getVec(l,rl);const c=_e(vv,rl),h=_e(_v,rl);vs[0]=Math.min(vs[0],c),vs[1]=Math.min(vs[1],h),bv[0]=Math.max(bv[0],c),bv[1]=Math.max(bv[1],h)}const n=_e(tw,oz);lz(wg,vs[0],vs[1],n,vv,_v,tw),lz(wv,bv[0],vs[1],n,vv,_v,tw),lz(xv,vs[0],bv[1],n,vv,_v,tw),de(wv,wv,wg),ae(wv,wv,.5),de(xv,xv,wg),ae(xv,xv,.5),pe(wg,wg,wv),pe(wg,wg,xv);const o=vs[0]%s,a=vs[1]%s;vu[0]=vs[0]-o,vu[1]=vs[1]-a;for(let l=0;l<t.count;l++){t.getVec(l,rl),e.setValues(l,(_e(vv,rl)-vu[0])/s,(_e(_v,rl)-vu[1])/s,vu[0]/s,vu[1]/s);for(let c=0;c<3;c++)r.set(l,c,wg[c]),r.set(l,c+3,wv[c]),r.set(l,c+6,xv[c])}}const oz=M(),rl=M(),cre=ii(),vv=M(),_v=M(),tw=M(),vs=Ye(),bv=Ye(),vu=Ye(),wg=M(),wv=M(),xv=M();function pit(e,t){const i=e.count-1;return Gue(e,t,0,Math.floor(i/3),Math.floor(i*(2/3)))}function fit(e,t,i,r,s,n){_(s)?(s.basisMatrixAtPosition(n,Td),oe(iP,Td[0],Td[1],Td[2]),oe(rP,Td[4],Td[5],Td[6]),oe(az,Td[8],Td[9],Td[10])):(oe(iP,1,0,0),oe(rP,0,1,0),oe(az,0,0,1));const o=e;_e(o,az)<0&&ae(o,o,-1),ne(r,o);const a=_e(o,rP),l=_e(o,iP);Math.abs(a)<Math.abs(l)?(Jz(t,iP,o,-l),be(t,t),pt(i,t,o),be(i,i),ae(i,i,-1)):(Jz(i,rP,o,-a),be(i,i),pt(t,i,o),be(t,t))}const Td=Te(),iP=M(),rP=M(),az=M();function mit(e,t){oe(sP,0,0,0);for(let i=0;i<t.count-1;i++)t.getVec(i,rl),pe(sP,sP,rl);ae(e,sP,1/(t.count-1))}const sP=M();function lz(e,t,i,r,s,n,o){oe(e,t*s[0]+i*n[0]+r*o[0],t*s[1]+i*n[1]+r*o[1],t*s[2]+i*n[2]+r*o[2])}function git(e){const t=new Oi,i=e.output===j.Depth;return t.include(Gn,{linearDepth:i}),t.include(xb,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add(E.POSITION,"vec3"),t.varyings.add("vpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),i&&(t.include(q0,e),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("linearDepth","float")),t.vertex.code.add(x`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${i?x`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:x`transformPosition(proj, view, vpos);`}
    }
  `),t.include(Or,e),t.fragment.include(Vp),e.multipassTerrainEnabled&&(t.fragment.include(Os),t.include(Ec,e)),t.fragment.uniforms.add("eColor","vec4"),e.output===j.Highlight&&t.include(Qm),t.fragment.code.add(x`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 fColor = ${e.attributeColor?"vColor * eColor;":"eColor;"}

    if (fColor.a < ${x.float(Hn)}) {
      discard;
    }

    ${e.output===j.Alpha?x`gl_FragColor = vec4(fColor.a);`:""}

    ${e.output===j.Color?x`gl_FragColor = highlightSlice(fColor, vpos); ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${e.output===j.Highlight?x`outputHighlight();`:""};
    ${e.output===j.Depth?x`outputDepth(linearDepth);`:""};
  }
  `),t}const yit=Object.freeze({__proto__:null,build:git});class k4 extends Gi{initializeProgram(t){const i=k4.shader.get(),r=this.configuration,s=i.build({output:r.output,oitEnabled:r.transparencyPassType===lt.Color,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Mi(t.rctx,s,mi)}bindPass(t,i){Ol(this.program,i.camera.projectionMatrix),this.program.setUniform4fv("eColor",t.color),this.configuration.output===j.Highlight&&Hp(this.program,i),(this.configuration.output===j.Depth||i.multipassTerrainEnabled)&&this.program.setUniform2fv("nearFar",i.camera.nearFar),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),Jm(this.program,i))}bindDraw(t){Gp(this.program,t),this.program.rebindTextures(),wb(this.program,this.configuration,t)}_createPipeline(t,i){const r=this.configuration,s=t===lt.NONE,n=t===lt.FrontFace;return Ot({blending:r.output!==j.Color&&r.output!==j.Alpha||!r.transparent?null:s?gl:Km(t),culling:VF(r.cullFace),depthTest:{func:H0(t)},depthWrite:s||n?r.writeDepth&&Ma:null,colorWrite:Ft,stencilWrite:r.sceneHasOcludees?Ip:null,stencilTest:r.sceneHasOcludees?i?D0:W0:null,polygonOffset:s||n?r.polygonOffset&&vit:u4(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(t,i){return i?this._occludeePipelineState:super.getPipelineState(t,i)}}k4.shader=new Ni(yit,()=>import("./ColorMaterial.glsl.e178f020.js"));const vit={factor:1,units:1};class Vl extends mr{constructor(){super(...arguments),this.output=j.Color,this.cullFace=Di.None,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparencyPassType=lt.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Z({count:j.COUNT})],Vl.prototype,"output",void 0),u([Z({count:Di.COUNT})],Vl.prototype,"cullFace",void 0),u([Z()],Vl.prototype,"slicePlaneEnabled",void 0),u([Z()],Vl.prototype,"vertexColors",void 0),u([Z()],Vl.prototype,"transparent",void 0),u([Z()],Vl.prototype,"polygonOffset",void 0),u([Z()],Vl.prototype,"enableOffset",void 0),u([Z()],Vl.prototype,"writeDepth",void 0),u([Z()],Vl.prototype,"sceneHasOcludees",void 0),u([Z({count:lt.COUNT})],Vl.prototype,"transparencyPassType",void 0),u([Z()],Vl.prototype,"multipassTerrainEnabled",void 0),u([Z()],Vl.prototype,"cullAboveGround",void 0);class ure extends od{constructor(t){super(t,bit),this.supportsEdges=!0,this.techniqueConfig=new Vl}getTechniqueConfig(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.enableOffset=i.camera.relativeElevation<l4,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(t,i,r,s,n,o,a){n4(t,i,s,n,o,void 0,a)}requiresSlot(t,i){return t===ve.DRAPED_MATERIAL?!0:Q1(i)===j.Highlight?t===ve.OPAQUE_MATERIAL:t===(this.parameters.transparent?this.parameters.writeDepth?ve.TRANSPARENT_MATERIAL:ve.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:ve.OPAQUE_MATERIAL)}createGLMaterial(t){return t.output===j.Color||t.output===j.Alpha||t.output===j.Highlight||t.output===j.Depth&&this.parameters.writeLinearDepth?new _it(t):null}createBufferWriter(){return new b4(Ive)}}class _it extends Zm{updateParameters(t){return this.ensureTechnique(k4,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}beginSlot(t){return this._output!==j.Color&&this._output!==j.Alpha||this._updateOccludeeState(t),this.updateParameters(t)}bind(t,i){i.bindPass(this._material.getPassParameters(),t)}}const bit=I({color:[1,1,1,1],transparent:!1,writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:Di.None,sceneHasOcludees:!1},ju);var gn;(function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.Cross=2]="Cross",e[e.ForwardDiagonal=3]="ForwardDiagonal",e[e.BackwardDiagonal=4]="BackwardDiagonal",e[e.DiagonalCross=5]="DiagonalCross",e[e.COUNT=6]="COUNT"})(gn||(gn={}));const dG=.70710678118,hre=dG,wit=.08715574274;function xit(e){const t=new Oi;e.draped||t.extensions.add("GL_OES_standard_derivatives");const i=e.output===j.Depth;t.include(Gn,{linearDepth:i}),t.include(xb,e),t.vertex.uniforms.add("proj","mat4"),t.vertex.uniforms.add("view","mat4"),i&&(t.include(q0,e),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("linearDepth","float")),e.draped?t.vertex.uniforms.add("worldToScreenRatio","float"):(t.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),t.vertex.uniforms.add("cameraPosition","vec3"),t.attributes.add(E.BOUNDINGRECT,"mat3")),t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.UVMAPSPACE,"vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),e.multipassTerrainEnabled&&t.varyings.add("depth","float");const r=e.style===gn.ForwardDiagonal||e.style===gn.BackwardDiagonal||e.style===gn.DiagonalCross;return r&&t.vertex.code.add(x`
      const mat2 rotate45 = mat2(${x.float(dG)}, ${x.float(-hre)},
                                 ${x.float(hre)}, ${x.float(dG)});
    `),e.draped||(t.vertex.code.add(x`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),t.vertex.code.add(x`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),t.vertex.code.add(x`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${x.float(wit)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - cameraPosition);
      }
    `)),t.vertex.code.add(x`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${r?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${r?" * rotate45":""};

      ${e.draped?"":x`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${x.float(e.patternSpacing)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `),t.vertex.code.add(x`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${i?x`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:x`transformPosition(proj, view, vpos);`}
    }
  `),t.include(Or,e),t.fragment.include(Vp),t.fragment.uniforms.add("uColor","vec4"),e.draped&&t.fragment.uniforms.add("texelSize","float"),e.output===j.Highlight&&t.include(Qm),e.multipassTerrainEnabled&&(t.fragment.include(Os),t.include(Ec,e)),e.output!==j.Highlight&&(t.fragment.code.add(x`
      const float lineWidth = ${x.float(e.lineWidth)};
      const float spacing = ${x.float(e.patternSpacing)};
      const float spacingINV = ${x.float(1/e.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),e.draped||t.fragment.code.add(x`const int maxSamples = 5;
float sample(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),t.fragment.code.add(x`
    void main() {
      discardBySlice(vpos);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${e.attributeColor?"vColor * uColor;":"uColor;"}
      color = highlightSlice(color, vpos);

      ${e.output!==j.Highlight?x`color.a *= ${Tit(e)};`:""}

      if (color.a < ${x.float(Hn)}) {
        discard;
      }

      ${e.output===j.Alpha?x`gl_FragColor = vec4(color.a);`:""}

      ${e.output===j.Color?x`gl_FragColor = color; ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${e.output===j.Highlight?x`outputHighlight();`:""}
      ${e.output===j.Depth?x`outputDepth(linearDepth);`:""};
    }
  `),t}function Tit(e){function t(i){return e.draped?x`coverage(vuv.${i}, texelSize)`:x`sample(vuv.${i})`}switch(e.style){case gn.ForwardDiagonal:case gn.Horizontal:return t("y");case gn.BackwardDiagonal:case gn.Vertical:return t("x");case gn.DiagonalCross:case gn.Cross:return x`
        1.0 - (1.0 - ${t("x")}) * (1.0 - ${t("y")})
      `;default:return"0.0"}}const Sit=Object.freeze({__proto__:null,build:xit});class z4 extends Gi{initializeProgram(t){const i=z4.shader.get(),r=this.configuration,s=i.build({output:r.output,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,style:r.style,patternSpacing:r.patternSpacing,lineWidth:r.lineWidth,draped:r.draped,oitEnabled:r.transparencyPassType===lt.Color,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Mi(t.rctx,s,s1e)}bindPass(t,i){Ol(this.program,i.camera.projectionMatrix),this.program.setUniform4fv("uColor",t.color),this.configuration.draped?(this.program.setUniform1f("worldToScreenRatio",1/i.screenToPCSRatio),this.program.setUniform1f("texelSize",1/i.camera.pixelRatio)):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/i.camera.perScreenPixelRatio),this.configuration.output===j.Highlight&&Hp(this.program,i),(this.configuration.output===j.Depth||i.multipassTerrainEnabled)&&this.program.setUniform2fv("nearFar",i.camera.nearFar),i.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",i.inverseViewport),Jm(this.program,i))}bindDraw(t){Gp(this.program,t),j0(this.program,t.origin,t.camera.viewInverseTransposeMatrix),wb(this.program,this.configuration,t),this.program.rebindTextures()}_setPipelineState(t,i){const r=this.configuration,s=t===lt.NONE,n=t===lt.FrontFace;return Ot({blending:r.output===j.Color||r.output===j.Alpha?s?gl:Km(t):null,culling:VF(r.cullFace),depthTest:{func:H0(t)},depthWrite:s?r.writeDepth&&Ma:a4(t),colorWrite:Ft,stencilWrite:r.sceneHasOcludees?Ip:null,stencilTest:r.sceneHasOcludees?i?D0:W0:null,polygonOffset:s||n?r.polygonOffset&&Eit:u4(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(t,i){return i?this._occludeePipelineState:super.getPipelineState(t,i)}}z4.shader=new Ni(Sit,()=>import("./Pattern.glsl.7bf1ec8b.js"));const Eit={factor:1,units:1};class $o extends mr{constructor(){super(...arguments),this.output=j.Color,this.cullFace=Di.None,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.polygonOffset=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.enableOffset=!0,this.transparencyPassType=lt.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Z({count:j.COUNT})],$o.prototype,"output",void 0),u([Z({count:Di.COUNT})],$o.prototype,"cullFace",void 0),u([Z()],$o.prototype,"slicePlaneEnabled",void 0),u([Z()],$o.prototype,"vertexColors",void 0),u([Z()],$o.prototype,"polygonOffset",void 0),u([Z()],$o.prototype,"writeDepth",void 0),u([Z()],$o.prototype,"sceneHasOcludees",void 0),u([Z({count:gn.COUNT})],$o.prototype,"style",void 0),u([Z()],$o.prototype,"patternSpacing",void 0),u([Z()],$o.prototype,"lineWidth",void 0),u([Z()],$o.prototype,"enableOffset",void 0),u([Z()],$o.prototype,"draped",void 0),u([Z({count:lt.COUNT})],$o.prototype,"transparencyPassType",void 0),u([Z()],$o.prototype,"multipassTerrainEnabled",void 0),u([Z()],$o.prototype,"cullAboveGround",void 0);const s1e=new Map([[E.POSITION,0],[E.COLOR,3],[E.UVMAPSPACE,4],[E.BOUNDINGRECT,5]]);class qW extends od{constructor(t){super(t,Rit),this.supportsEdges=!0,this._vertexAttributeLocations=s1e,this.techniqueConfig=new $o}getTechniqueConfig(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.style=this.parameters.style,this.techniqueConfig.patternSpacing=this.parameters.patternSpacing,this.techniqueConfig.lineWidth=this.parameters.lineWidth,this.techniqueConfig.draped=this.parameters.draped,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.enableOffset=i.camera.relativeElevation<l4,this.techniqueConfig.multipassTerrainEnabled=i.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=i.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(t,i,r,s,n,o,a){n4(t,i,s,n,o,void 0,a)}requiresSlot(t,i){return t===ve.DRAPED_MATERIAL?!0:Q1(i)===j.Highlight?t===ve.OPAQUE_MATERIAL:t===(this.parameters.writeDepth?ve.TRANSPARENT_MATERIAL:ve.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)}createGLMaterial(t){return t.output===j.Color||t.output===j.Alpha||t.output===j.Highlight||t.output===j.Depth&&this.parameters.writeLinearDepth?new Ait(t):null}createBufferWriter(){const t=kr().vec3f(E.POSITION).vec4u8(E.COLOR).vec4f(E.UVMAPSPACE);return this.parameters.draped||t.mat3f(E.BOUNDINGRECT),new Cit(t)}}class Ait extends Zm{updateParameters(t){return this.ensureTechnique(z4,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}beginSlot(t){return this._output!==j.Color&&this._output!==j.Alpha||this._updateOccludeeState(t),this.updateParameters(t)}bind(t,i){i.bindPass(this._material.getPassParameters(),t)}}class Cit extends b4{write(t,i,r,s){for(const n of this.vertexBufferLayout.fieldNames){const o=i.vertexAttributes.get(n),a=i.indices.get(n);if(o&&a)switch(n){case E.POSITION:{at(o.size===3);const l=r.getField(n,Si);l&&FO(a,o.data,t.transformation,l,s);break}case E.COLOR:{at(o.size===3||o.size===4);const l=r.getField(n,Pa);l&&kL(a,o.data,o.size,l,s);break}case E.UVMAPSPACE:{at(o.size===4);const l=r.getField(n,rn);l&&xS(a,o.data,l,s);break}case E.BOUNDINGRECT:{at(o.size===9);const l=r.getField(n,id);l&&this.writeBoundingRect(a,o.data,t.transformation,l,s);break}}}}writeBoundingRect(t,i,r,s,n){const o=r,a=s.typedBuffer,l=s.typedBufferStride,c=t.length;n*=l;for(let h=0;h<c;++h){const p=9*t[h],f=i[p],g=i[p+1],y=i[p+2];a[n]=o[0]*f+o[4]*g+o[8]*y+o[12],a[n+1]=o[1]*f+o[5]*g+o[9]*y+o[13],a[n+2]=o[2]*f+o[6]*g+o[10]*y+o[14];for(let v=3;v<9;++v)a[n+v]=i[p+v];n+=l}}}const Rit=I({color:[1,1,1,1],writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:Di.None,sceneHasOcludees:!1,style:gn.Cross,patternSpacing:10,lineWidth:1,draped:!0},ju);function Oit(e,t,i){return Pit(Mit(e),t,i)}function Mit(e){return e&&e.pattern||null}function Pit(e,t,i){return _(e)?e.style==="none"||e.style==="solid"?(e.style==="none"&&(t.color=yi(0,0,0,0),t.transparent=!0),new ure(t)):(t.style=Iit(e.style),t.draped=i.isDraped,new qW(t)):new ure(t)}function Iit(e){switch(e){case"horizontal":return gn.Horizontal;case"vertical":return gn.Vertical;case"cross":return gn.Cross;case"forward-diagonal":return gn.ForwardDiagonal;case"backward-diagonal":return gn.BackwardDiagonal;case"diagonal-cross":return gn.DiagonalCross;default:return}}function $it(e){return e.material instanceof qW&&!e.material.parameters.draped}function Dit(e,t){if($it(e)){const i=e.geometry.vertexAttributes,r=i.get(E.POSITION).data,s=i.get(E.UVMAPSPACE).data,n=i.get(E.BOUNDINGRECT).data;r1e(rn.fromTypedArray(s),Xr.fromTypedArray(r),t,T0.fromTypedArray(n))}}function Lit(e,t,i,r){const s=lve(e,t,i,r),n=e.stageObject.geometryRecords;for(let o=0;o<n.length;o++)Dit(n[o],r);return s}const Nit=["polyline","polygon","extent"];class B4 extends Wp{constructor(t,i,r,s){super(t,i,r,s),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}_ensureMaterials(){this._ensureFillMaterial(),this._ensureOutlineMaterial()}_ensureFillMaterial(){if(_(this._material))return;const t=Pr(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(t);this._material=Oit(this.symbolLayer,{color:i,transparent:i[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof qW,this._context.stage.add(this._material)}_ensureOutlineMaterial(){const t=this.symbolLayer.outline;if(_(this._outlineMaterial)||!this._isValidOutline(t))return;this._hasOutline=!0;const i=r=>{const s=C_e(t.pattern);return new Bx({width:r,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:s,stippleScaleWithLineWidth:!0,cap:oG(t.patternCap||"butt")})};this._outlineMaterial=i(fo(t.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(t){return _(t)&&t.size&&t.size>0&&_(t.color)&&(R(t.pattern)||t.pattern.type!=="style"||t.pattern.style!=="none")}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,Nit,this.symbolLayer.type))return null;const r=this._getVertexOpacityAndColor(t.renderingInfo,255),s=this.setGraphicElevationContext(i,new Mc);return this.ensureDrapedStatus(s.mode==="on-the-ground"),this._ensureMaterials(),this.draped?this._createAsOverlay(i,r):this._createAs3DShape(i,r,s)}layerOpacityChanged(){if(_(this._material)){const t=this._material.parameters.color,i=Pr(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(i);this._material.setParameters({color:[t[0],t[1],t[2],r],transparent:r<1||this.needsDrivenTransparentPass})}if(_(this._outlineMaterial)){const t=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[t[0],t[1],t[2],this._getOutlineOpacity()]})}return!0}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=BO(B4.elevationModeChangeTypes,r,s);if(n!==_r.UPDATE)return n;const o=zu(s);return this.updateGraphics3DGraphicElevationInfo(t,i,()=>o)}slicePlaneEnabledChanged(){if(_(this._material)&&this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),_(this._outlineMaterial)){const t={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameters(t)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(t,i,r){const s=NR(t.geometry);if(R(s))return null;$s.renderData=LW(s,this._context.elevationProvider,this._context.renderCoordsHelper,r),$s.color=i;const n=$s.renderData.position.length/3;if(this._needsUV&&($s.uvMapSpace=new Float32Array(4*n),$s.boundingRect=new Float64Array(9*n)),$s.outNum=0,$s.outGeometries=[],$s.outTransforms=[],$s.outMaterials=[],this._createAs3DShapeFill($s),this._hasOutline&&this._createAs3DShapeOutline($s),this._logGeometryCreationWarnings($s.renderData,s.rings,"rings","FillSymbol3DLayer"),$s.outNum===0)return null;this._needsUV&&r1e(rn.fromTypedArray($s.uvMapSpace),Xr.fromTypedArray($s.renderData.position),this._context.renderCoordsHelper,T0.fromTypedArray($s.boundingRect));const o=new tg({geometries:$s.outGeometries,materials:$s.outMaterials,transformations:$s.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:t.uid}}),a=new qp(this,o,$s.outGeometries,null,null,Lit,r);return a.alignedSampledElevation=$s.renderData.sampledElevation,a.needsElevationUpdates=zu(r.mode),a}_createAs3DShapeFill(t){const i=t.renderData.polygons;for(const{position:r,mapPosition:s,holeIndices:n,index:o,count:a}of i){if(_(this._context.clippingExtent)&&(ki(To),uc(To,s),!Uh(To,this._context.clippingExtent)))continue;const l=ES(s,n,3);if(l.length===0)continue;const c=new Uint32Array(l),h=yie({indices:c,attributeData:{position:r,color:t.color,mapPosition:s,uvMapSpace:this._needsUV?new Float32Array(t.uvMapSpace.buffer,4*o*t.uvMapSpace.BYTES_PER_ELEMENT,4*a):null,boundingRect:this._needsUV?new Float64Array(t.boundingRect.buffer,9*o*t.boundingRect.BYTES_PER_ELEMENT,9*a):null}});t.outGeometries.push(h),t.outMaterials.push(this._material),t.outTransforms.push(ls),t.outNum++}}_createAs3DShapeOutline(t){if(!this._hasOutline)return;const i=t.renderData.outlines;for(let r=0;r<i.length;++r){const{mapPosition:s,position:n}=i[r];if(_(this._context.clippingExtent)&&(ki(To),uc(To,s),!Uh(To,this._context.clippingExtent)))continue;const o=nG({overlayInfo:null,removeDuplicateStartEnd:eb.REMOVE,attributeData:{position:n,mapPosition:s}}),a=o.vertexAttributes.get(E.POSITION);a.data===n&&(a.data=new Float64Array(n)),t.outGeometries.push(o),t.outMaterials.push(this._outlineMaterial),t.outTransforms.push(ls),t.outNum++}}_createAsOverlay(t,i){const r=NR(t.geometry);if(R(r))return null;this._material.renderPriority=this._renderPriority+this._renderPriorityStep/2,_(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),Rn.renderData=i_e(r,this._context.overlaySR),Rn.color=i;const s=Rn.renderData.position.length/3;return this._needsUV&&(Rn.uvMapSpace=new Float32Array(4*s)),Rn.outNum=0,Rn.outGeometries=[],Rn.outBoundingBox=ki(),Rn.layerUid=this._context.layer.uid,Rn.graphicsUid=t.uid,this._createAsOverlayFill(Rn),this._hasOutline&&this._createAsOverlayOutline(Rn),this._logGeometryCreationWarnings(Rn.renderData,r.rings,"rings","FillSymbol3DLayer"),Rn.outNum===0?null:(this._needsUV&&dit(rn.fromTypedArray(Rn.uvMapSpace),Xr.fromTypedArray(Rn.renderData.position),this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode),Rn.outNum>0?new M4(this,Rn.outGeometries,Rn.outBoundingBox):null)}_createAsOverlayFill(t){const i=t.renderData.polygons;for(const{position:r,holeIndices:s,index:n,count:o}of i){if(ki(To),uc(To,r),!Uh(To,this._context.clippingExtent))continue;const a=ES(r,s,3);if(a.length===0)continue;FT(t.outBoundingBox,To);const l=new Uint32Array(a),c=yie({indices:l,attributeData:{position:r,color:t.color,uvMapSpace:this._needsUV?new Float32Array(t.uvMapSpace.buffer,4*n*t.uvMapSpace.BYTES_PER_ELEMENT,4*o):null}}),h=new CS(c,this._material,{layerUid:t.layerUid,graphicUid:t.graphicsUid}),p=To;Ho(h.boundingSphere,.5*(p[0]+p[3]),.5*(p[1]+p[4]),0,.5*Math.sqrt((p[3]-p[0])*(p[3]-p[0])+(p[4]-p[1])*(p[4]-p[1]))),t.outGeometries.push(h),t.outNum++}}_createAsOverlayOutline(t){if(!this._hasOutline)return;const i=t.renderData.outlines;for(let r=0;r<i.length;++r){const{position:s}=i[r];if(ki(To),uc(To,s),!Uh(To,this._context.clippingExtent))continue;FT(t.outBoundingBox,To);const n=nG({overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:eb.REMOVE,attributeData:{position:s}}),o=new CS(n,this._outlineMaterial,{layerUid:t.layerUid,graphicUid:t.graphicsUid}),a=To;Ho(o.boundingSphere,.5*(a[0]+a[3]),.5*(a[1]+a[4]),0,.5*Math.sqrt((a[3]-a[0])*(a[3]-a[0])+(a[4]-a[1])*(a[4]-a[1]))),t.outGeometries.push(o),t.outNum++}}_getOutlineOpacity(){const t=Pr(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(_(t)?t.a:0)}_getOutlineColor(){const t=Pr(this.symbolLayer,"outline","color"),i=this._getOutlineOpacity();return gC(_(t)?Je.toUnitRGB(t):null,i)}get test(){return{createAsOverlay:(t,i)=>this._createAsOverlay(t,i),createAs3DShape:(t,i,r)=>this._createAs3DShape(t,i,r)}}}B4.elevationModeChangeTypes={definedChanged:_r.RECREATE,staysOnTheGround:_r.NONE,onTheGroundChanged:_r.RECREATE};const To=cs(),$s={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Rn={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Fit=he.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters");class V4{constructor(t){this.definition=t,this.key=JSON.stringify(t),this.haloSize=Math.round(t.halo.size),this.textStyle=this._colorToRGBA(t.color),this.haloStyle=this._colorToRGB(t.halo.color),this.backgroundStyle=t.background.color[3]!==0?this._colorToRGBA(t.background.color):null}fontString(t){const i=this.definition.font;return`${i.style} ${i.weight} ${t}px ${i.family}, sans-serif`}_colorToRGB(t){return`rgb(${t.slice(0,3).map(i=>Math.floor(255*i)).toString()})`}_colorToRGBA(t){return`rgba(${t.slice(0,3).map(i=>Math.floor(255*i)).toString()},${t[3]})`}static async fromSymbol(t,i=1){const r=Pr(t,"material","color"),s=tl(r,c1,Je.toUnitRGBA),n=tl(t.size,12,fo),o=t.lineHeight,a=_(t.background)?Je.toUnitRGBA(t.background.color):c1,l={family:tl(t.font,"sans-serif",g=>g.family),decoration:tl(t.font,"none",g=>g.decoration),weight:tl(t.font,"normal",g=>g.weight),style:tl(t.font,"normal",g=>g.style)},c=t.halo,h=_(c)&&_(c.color)&&c.size>0?{size:fo(c.size),color:Je.toUnitRGBA(c.color)}:{size:0,color:c1},p=new V4({color:s,size:n,background:{color:a,padding:_(t.background)?[.65*n,.5*n]:[0,0],borderRadius:_(t.background)?n*(6/16):0},lineSpacingFactor:o,font:l,halo:h,pixelRatio:i}),f=p.fontString(n);try{await document.fonts.load(f)}catch{Fit.warnOnce(`Failed to preload font '${f}'. Some text symbology may be rendered using the default browser font.`)}return p}}class Uit{constructor(t,i,r){this._renderer=new v_e(t,i,r)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const t=S$(kit,this._renderer.renderedWidth,this._renderer.renderedHeight),i=t.getContext("2d");return i.save(),this._renderer.render(i,0,0),i.restore(),new rs(t,{wrap:{s:ct.CLAMP_TO_EDGE,t:ct.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0,powerOfTwoResizeMode:l0.PAD})}}const kit={canvas:null},zit=[0,0,1];class Bit extends Wp{constructor(t,i,r,s){super(t,i,r,s),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const t=h4(this.symbolLayer.size);if(t)throw new q("graphics3dtextsymbollayer:invalid-size",t)}await this._createTextRenderParameters()}async _createTextRenderParameters(){const t=this._context.graphicsCoreOwner.view.pixelRatio;this._textRenderParameters=await V4.fromSymbol(this.symbolLayer,t)}destroy(){super.destroy()}createGraphics3DGraphic(t){const i=t.graphic,r=DR(i.geometry);if(R(r))return this.logger.warn(`unsupported geometry type for text symbol: ${i.geometry.type}`),null;const s=this.symbolLayer.text;if(R(s)||s==="")return null;const n=bj(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(_(n)&&!uce(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const o=me(I({},jit),{verticalOffset:n,horizontalPlacement:pJe(this.symbolLayer.horizontalAlignment),verticalPlacement:fJe(this.symbolLayer.verticalAlignment)});return this._createAs3DShape(i,r,s,o)}createLabel(t,i,r,s){const n=t.graphic,o=DR(n.geometry);if(R(o))return this.logger.warn(`unsupported geometry type for label: ${n.geometry.type}`),null;const a=i.text;return!a||/^\s+$/.test(a)?null:this._createAs3DShape(n,o,a,i,r,s)}setGraphicElevationContext(t,i,r=0){const s=super.setGraphicElevationContext(t,i);return s.addOffsetRenderUnits(r),s}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(t,i){return dre(t,i,(r,s)=>{this.updateGraphicElevationContext(s,r)}),_r.UPDATE}slicePlaneEnabledChanged(t,i){return dre(t,i,r=>{for(const s of r.stageObject.geometryRecords)s.material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!1}updateGraphicElevationContext(t,i){this.setGraphicElevationContext(t,i.elevationContext,i.metadata.elevationOffset),i.needsElevationUpdates=zu(i.elevationContext.mode)||i.elevationContext.mode==="absolute-height"}_defaultElevationInfoNoZ(){return Git}_createAs3DShape(t,i,r,s,n,o){const a=this.setGraphicElevationContext(t,new Mc,s.elevationOffset),l=Pr(t.geometry,"type")==="polyline",c=t.uid;let h=null,p=null;if(R(o)){const B=b_e(s.horizontalPlacement);h=new Uit(r,B,this._textRenderParameters);let J=null;p=this._context.sharedResources.textures.fromData(h.key,()=>h.create(),()=>{_(J)&&J.release()});const Q=this._context.stage.renderView.textureRepository.acquire(p.texture.id);if(R(Q)||Cc(Q))return p.release(),null;J=Q}const f=Vit(h,s),g={occlusionTest:!0,screenOffset:s.screenOffset,anchorPos:f,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:s.centerOffsetUnits,debugDrawLabelBorder:s.debugDrawLabelBorder,drawInSecondSlot:!0};if(_(p)&&(g.textureId=p.texture.id),_(o)&&(g.textureId=o.id),_(s.verticalOffset)){const{screenLength:B,minWorldLength:J,maxWorldLength:Q}=s.verticalOffset;g.verticalOffset={screenLength:fo(B),minWorldLength:J||0,maxWorldLength:Q!=null?Q:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:B,screenSizePerspectiveSettingsLabels:J}=this._context.sharedResources;g.screenSizePerspective=J.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]),g.screenSizePerspectiveAlignment=B}let y;if(l&&(g.shaderPolygonOffset=1e-4),g.slicePlaneEnabled=this._context.slicePlaneEnabled,_(n)){const B=JSON.stringify(g);y=n.get(B),R(y)&&(y=new TS(g),n.add(B,y))}else y=new TS(g);const v=[y],b=s.translation,w=_(h)?[h.displayWidth,h.displayHeight]:[0,0],S=s.centerOffset,T=zit,A=[0,0],C=[Qa.createPointGeometry(T,b,null,w,S,A,null)],O=this._context.layer.uid,L=EW(this._context,i,C,v,a,O,c);if(L===null)return null;const U=new qp(this,L.object,C,R(n)?v:null,p,IR,a);U.alignedSampledElevation=L.sampledElevation,U.needsElevationUpdates=zu(a.mode)||a.mode==="absolute-height";const{displayWidth:N,displayHeight:z}=_(h)?h:s;U.getScreenSize=(B=Ye())=>(B[0]=N,B[1]=z,B);const V={labelText:r,elevationOffset:s.elevationOffset};return U.metadata=V,$R(U,i,this._context.elevationProvider),U}}function dre(e,t,i){e&&e.forEach(r=>{const s=t(r);_(s)&&i(s,r.graphic)})}function Vit(e,t){if(t.verticalPlacement==="baseline"){const r=uJe[t.horizontalPlacement],s=_(e)?e.baselineAnchorY:0;return vi(r,s)}const i=dJe(t.horizontalPlacement,t.verticalPlacement);return E$[i]}const Git={mode:"relative-to-ground",offset:0},jit={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],horizontalPlacement:"center",verticalPlacement:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawLabelBorder:!1,displayWidth:0,displayHeight:0},Hit=["polyline","polygon","extent"];class sp extends Wp{constructor(t,i,r,s){super(t,i,r,s)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,Hit,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(i,new Mc);return this.ensureDrapedStatus(r.mode==="on-the-ground"),this.ensureMaterial(),this.draped?this._createAsOverlay(i):this._createAs3DShape(i,r,i.uid)}ensureMaterial(){if(_(this._material))return;const t=I({},$ve),i=this.symbolLayer.color;_(i)&&(t.color=Je.toUnitRGBA(i));const r=this._getCombinedOpacity(i,{hasIntrinsicColor:!0});t.color=[t.color[0],t.color[1],t.color[2],r],t.transparent=r<1||this.needsDrivenTransparentPass,t.waveDirection=_(this.symbolLayer.waveDirection)?sp.headingVectorFromAngle(this.symbolLayer.waveDirection):vi(0,0);const s=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,n=uZe[s];t.waveStrength=n.waveStrength,t.waveTextureRepeat=n.textureRepeat,t.waveVelocity=n.waveVelocity,t.flowStrength=n.perturbationStrength,t.slicePlaneEnabled=this._context.slicePlaneEnabled,t.isDraped=this.draped,this._material=new Dve(t),this._context.stage.add(this._material)}layerOpacityChanged(){if(R(this._material))return!0;const t=this._material.parameters.color,i=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),r=i<1||this.needsDrivenTransparentPass;return this._material.setParameters({color:[t[0],t[1],t[2],i],transparent:r}),!0}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=BO(sp.elevationModeChangeTypes,r,s);if(n!==_r.UPDATE)return n;const o=zu(s);return this.updateGraphics3DGraphicElevationInfo(t,i,()=>o)}slicePlaneEnabledChanged(){return _(this._material)&&this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(t,i,r){const s=NR(t.geometry);if(R(s))return null;to.renderData=LW(s,this._context.elevationProvider,this._context.renderCoordsHelper,i);const n=to.renderData.position.length/3;if(to.uvCoords=new Float64Array(2*n),to.outNum=0,to.outGeometries=[],to.outTransforms=[],to.outMaterials=[],this._create3DShapeGeometries(to),this._logGeometryCreationWarnings(to.renderData,s.rings,"rings","WaterSymbol3DLayer"),to.outNum===0)return null;this._createUVCoordsFromVertices(to.uvCoords,to.renderData.mapPosition,n,this._context.elevationProvider.spatialReference);const o=new tg({geometries:to.outGeometries,materials:to.outMaterials,transformations:to.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),a=new qp(this,o,to.outGeometries,null,null,lve,i);return a.alignedSampledElevation=to.renderData.sampledElevation,a.needsElevationUpdates=zu(i.mode),a}_createUVCoordsFromVertices(t,i,r,s){const n=Cl(s);$u(xg);for(let l=0;l<r;l++)rr(pre,i[3*l+0],i[3*l+1]),Ile(xg,pre);JR(xg,xg,n);const o=xg[0]%sp.unitSizeOfTexture,a=xg[1]%sp.unitSizeOfTexture;nP[0]=xg[0]-o,nP[1]=xg[1]-a;for(let l=0;l<r;l++)t[2*l+0]=(i[3*l+0]*n-nP[0])/sp.unitSizeOfTexture,t[2*l+1]=(i[3*l+1]*n-nP[1])/sp.unitSizeOfTexture}_create3DShapeGeometries(t){const i=t.renderData.polygons,r=t.uvCoords;for(const{count:s,index:n,position:o,mapPosition:a,holeIndices:l}of i){if(_(this._context.clippingExtent)&&(ki(Tg),uc(Tg,a),!Uh(Tg,this._context.clippingExtent)))continue;const c=ES(a,l,3);if(c.length===0)continue;const h=new Uint32Array(c),p=new Float64Array(r.buffer,2*n*r.BYTES_PER_ELEMENT,2*s),f=vie({indices:h,attributeData:{position:o,uv0:p,mapPosition:a}});t.outGeometries.push(f),t.outMaterials.push(this._material),t.outTransforms.push(ls),t.outNum++}}_createAsOverlay(t){const i=NR(t.geometry);if(R(i))return null;this._material.renderPriority=this._renderPriority,So.renderData=i_e(i,this._context.overlaySR);const r=So.renderData.position.length/3;return So.uvCoords=new Float64Array(2*r),So.outNum=0,So.outGeometries=[],So.outBoundingBox=ki(),So.layerUid=this._context.layer.uid,So.graphicsUid=t.uid,this._createAsOverlayWater(So),this._logGeometryCreationWarnings(So.renderData,i.rings,"rings","WaterSymbol3DLayer"),So.outNum===0?null:(this._createUVCoordsFromVertices(So.uvCoords,So.renderData.position,r,this._context.overlaySR),So.outNum>0?new M4(this,So.outGeometries,So.outBoundingBox):null)}_createAsOverlayWater(t){const i=t.uvCoords,r=t.renderData.polygons;for(const{position:s,holeIndices:n,index:o,count:a}of r){if(ki(Tg),uc(Tg,s),!Uh(Tg,this._context.clippingExtent))continue;FT(t.outBoundingBox,Tg);const l=ES(s,n,3);if(l.length===0)continue;const c=new Uint32Array(l),h=new Float64Array(i.buffer,2*o*i.BYTES_PER_ELEMENT,2*a),p=vie({indices:c,attributeData:{position:s,uv0:h}}),f=new CS(p,this._material,{layerUid:t.layerUid,graphicUid:t.graphicsUid}),g=Tg;Ho(f.boundingSphere,.5*(g[0]+g[3]),.5*(g[1]+g[4]),0,.5*Math.sqrt((g[3]-g[0])*(g[3]-g[0])+(g[4]-g[1])*(g[4]-g[1]))),t.outGeometries.push(f),t.outNum++}}static headingVectorFromAngle(t){const i=Ye(),r=xN(t);return i[0]=Math.sin(r),i[1]=Math.cos(r),i}get test(){return{create3DShape:t=>this._createAs3DShape(t.graphic,t.elevationContext,t.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}sp.unitSizeOfTexture=100,sp.elevationModeChangeTypes={definedChanged:_r.RECREATE,staysOnTheGround:_r.NONE,onTheGroundChanged:_r.RECREATE};const nP=Ye(),xg=Dt(),pre=Ye(),Tg=cs(),to={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},So={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},qit=he.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory");function Wit(e,t,i,r){const s=fre[e.type]&&fre[e.type][t.type]||Xit[t.type];return s?new s(e,t,i,r):(qit.error("GraphicsLayerFactory#make",`unknown symbol type ${t.type}`),null)}const Xit={icon:zR,object:ftt,line:$4,path:oit,fill:B4,extrude:QQe,text:Bit,water:sp},fre={"mesh-3d":{fill:WKe}};class Yit extends wW{constructor(t,i,r){super(i.schedule),this._symbol=t,this._context=i,this._backgroundLayers=r,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}set symbol(t){this._symbol=t;for(let i=0;i<t.symbolLayers.length;i++){const r=this.symbolLayers[i];R(r)||(r.symbol=t,r.symbolLayer=t.symbolLayers.items[i])}}get symbol(){return this._symbol}async doLoad(t){let i=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(i=this._backgroundLayers.concat(i));const r=i.length;for(;this.symbolLayers.length<i.length;)this.symbolLayers.push(null);this.symbolLayers.length=i.length;const s=[];for(let n=0;n<r;n++){const o=i.getItemAt(n);if(o.enabled===!1)continue;oP.renderPriority=1-(1+n)/r,oP.renderPriorityStep=1/r,oP.ignoreDrivers=o._ignoreDrivers;const a=Wit(this.symbol,o,this._context,oP);s.push(tO(t,()=>{this.symbolLayers[n]=null,a.destroy()})),this.symbolLayers[n]=a}await JN(this.symbolLayers,async(n,o)=>{if(_(n))try{await n.load(),this._extentPadding+=Math.max(this._extentPadding,n.extentPadding)}catch{this.symbolLayers[o]=null}});for(const n of s)n==null||n.remove();if(s.length=0,Qt(t),this.symbolLayers.length&&!this.symbolLayers.some(n=>!!n))throw new Error}getSymbolLayerSize(t){const i=this.symbolLayers[t];return _(i)?i.getCachedSize():null}get extentPadding(){return this._extentPadding}createGraphics3DGraphic(t,i){const r=t.graphic,s=new Array(this.symbolLayers.length);for(let o=0;o<this.symbolLayers.length;o++){const a=this.symbolLayers[o];s[o]=_(a)?a.createGraphics3DGraphic(t):null}const n=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new MYe(r,i||this,s,t.layer,n)}get complexity(){return SW(this.symbolLayers.map(t=>Pr(t,"complexity")))}globalPropertyChanged(t,i){const r=this.symbolLayers.length;for(let s=0;s<r;s++){const n=this.symbolLayers[s],o=a=>{const l=a.graphics[s];return l instanceof qp?l:null};if(_(n)&&!n.globalPropertyChanged(t,i,o))return!1}return!0}applyRendererDiff(t,i){return this.loadStatus!==ic.LOADED?Es.Recreate_Symbol:this.symbolLayers.reduce((r,s)=>r!==Es.Recreate_Symbol&&_(s)?Math.min(r,s.applyRendererDiff(t,i)):r,Es.Fast_Update)}prepareSymbolPatch(t){if(this.loadStatus===ic.FAILED||t.diff.type!=="partial")return;const i=t.diff.diff;if(!i.symbolLayers||i.symbolLayers.type!=="partial")return;const r=i.symbolLayers.diff;this.symbolLayers.forEach((s,n)=>{if(R(s))return;const o=r[n];if(o){const a={diff:o,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};s.prepareSymbolLayerPatch(a),t.symbolStatePatches.push(...a.symbolLayerStatePatches),a.graphics3DGraphicPatches.length&&t.graphics3DGraphicPatches.push((l,c)=>{const h=l.graphics[n];_(h)&&a.graphics3DGraphicPatches.forEach(p=>p(h,c))})}})}updateGeometry(t,i){for(let r=0;r<this.symbolLayers.length;r++){const s=this.symbolLayers[r];if(R(s))continue;const n=t.graphics[r];if(R(n)||!s.updateGeometry(n,i))return!1}return!0}onRemoveGraphic(t){for(let i=0;i<this.symbolLayers.length;i++){const r=this.symbolLayers[i];if(R(r))continue;const s=t.graphics[i];_(s)&&r.onRemoveGraphic(s)}}getFastUpdateStatus(){let t=0,i=0,r=0;return this.symbolLayers.forEach(s=>{R(s)||(s.loadStatus===ic.LOADING?t++:s.isFastUpdatesEnabled()?r++:i++)}),{loading:t,slow:i,fast:r}}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const t of this.symbolLayers)_(t)&&t.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const oP={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};class Zit extends wW{constructor(t,i,r){super(i),this.symbol=t,this.convert=r,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(t){return _(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(t):null}get symbolLayers(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(t){const i=await this.symbol.fetchSymbol({signal:t});i.id=this.symbol.id,this.graphics3DSymbol=this.convert(i),_(this.graphics3DSymbol)&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(t){return _(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(t,this):null}get complexity(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:TW}globalPropertyChanged(t,i){return!!_(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(t,i)}applyRendererDiff(t,i){return _(this.graphics3DSymbol)?this.graphics3DSymbol.applyRendererDiff(t,i):Es.Recreate_Symbol}prepareSymbolPatch(t){_(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(t)}updateGeometry(t,i){return!!_(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(t,i)}onRemoveGraphic(){}getFastUpdateStatus(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){_(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return this.graphics3DSymbol===void 0}}function WW(e){return e instanceof Zit?e.graphics3DSymbol:e instanceof Yit?e:null}const VR=he.getLogger("esri.views.3d.layers.graphics.labelPlacement");function Qit(e){const t=ort(e);if(R(t))return null;const i=Jit(e,t);if(R(i))return null;const r=i.anchor,s=!!t.hasLabelVerticalOffset;return ert({anchor:r,verticalOffset:t.verticalOffset,screenOffset:Ye(),centerOffset:yi(0,0,0,-1),centerOffsetUnits:"world",translation:M(),elevationOffset:0,hasLabelVerticalOffset:s},i,e)}function Jit(e,t){if(t.anchor)return t;const i=e.labelClass.labelPlacement,r=Gh[i],s=r||tN(e);return i&&!r&&VR.warnOncePerTick(`the requested label placement '${i}' is not currently supported in SceneView`),Kit(s,e)}function XW(e){const t=e.graphics3DGraphic.graphics3DSymbol,i=WW(t);return _(i)?i.symbol.symbolLayers.getItemAt(0):null}function Kit(e,t){const i=t.graphics3DGraphic.graphic.geometry;if(R(i))return null;if(_(t.disablePlacement))return t.labelClass.labelPlacement?(VR.warnOncePerTick(mre(e.placement,t.disablePlacement.logEntityDescription)),tN(t)):e;const r=i.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return VR.warnOncePerTick(mre(e.placement,`'${r}' geometries`)),tN(t);break;case"point":case"mesh":return e}return e}function mre(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView`}function tN(e){const t=e.graphics3DGraphic.graphic.geometry;if(R(t))return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const i=XW(e);return _(i)&&i.type==="extrude"?Gh["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return Gh["above-center"];default:return}}function ert(e,t,i){const r=i.graphics3DGraphic.graphic.geometry;if(R(r))return null;switch(r.type){case"point":irt(e,t,i);break;case"polygon":trt(e,t,i);break;case"mesh":YW(e,t,i.graphics3DGraphic.graphics[0])}return e}function trt(e,t,i){const r=XW(i);if(!R(r))switch(r.type){case"extrude":{const s=i.graphics3DGraphic.graphics[0];_(s)?(s.getBoundingBoxObjectSpace(TC),Fh(TC,e.translation),e.translation[2]=lb(TC)/2):oe(e.translation,0,0,0),YW(e,t,s);break}}}function irt(e,t,i){const r=XW(i);if(R(r))return;const s=i.graphics3DGraphic.graphics[0];switch(_(s)?s.getCenterObjectSpace(e.translation):oe(e.translation,0,0,0),r.type){case"icon":case"text":rrt(e,t,i,s);break;case"object":YW(e,t,s)}}function rrt(e,t,i,r){const{graphics3DGraphic:s}=i,n=_(r)?r.getScreenSize():null;if(!s.isDraped&&_(n)){const o=srt(i);K2[0]=n[0]/2*(t.normalizedOffset[0]-o[0]),K2[1]=n[1]/2*(t.normalizedOffset[1]-o[1]),e.screenOffset[0]=K2[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=K2[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=K2[1]}else e.hasLabelVerticalOffset||e.anchor==="center"||(Gh[i.labelClass.labelPlacement]&&VR.warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center")}function srt(e,t=art){const{graphics3DGraphic:i}=e,r=i.graphics[0],s=_(r)?r.stageObject.geometryRecords[0].material:null;if(s&&s instanceof TS){const n=s.parameters.anchorPos;t[0]=2*(n[0]-.5),t[1]=2*(n[1]-.5)}else t[0]=0,t[1]=0;return t}function YW(e,t,i){const r=_(i)?i.getBoundingBoxObjectSpace(TC):TC,s=je(r[3]-r[0],r[4]-r[1],r[5]-r[2]),n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);e.centerOffset[0]=n/2*t.normalizedOffset[0];const o=e.translation[2],a=s[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=o+a;const l=Pe(s);e.centerOffset[2]=l/2*t.normalizedOffset[2]}function nrt(e){return e==="above-center"}function ort(e){const t=e.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:r}=e,s=WW(r.graphics3DSymbol),n=po(s,a=>a.symbol.type==="point-3d"?a.symbol:null),o=Gh[t]||tN(e);return _(n)&&n.supportsCallout()&&n.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:gre(n.verticalOffset),anchor:null,normalizedOffset:null}:i&&i.hasVisibleVerticalOffset()&&(R(n)||!n.supportsCallout()||!n.verticalOffset||r.isDraped)?nrt(o.placement)?{placement:"above-center",verticalOffset:gre(i.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(VR.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null):{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}}function gre(e){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:i,maxWorldLength:r}}const Gh={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},yre={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in yre){const t=yre[e],i=Gh[e];t.forEach(r=>{Gh[r]=i})}Object.freeze&&(Object.freeze(Gh),Object.keys(Gh).forEach(function(e){Object.freeze(Gh[e]),Object.freeze(Gh[e].normalizedOffset)}));const K2=[0,0],art=[0,0],TC=cs();class vre{constructor(t){this._stage=t,this._materials=new Map}get(t){return this._materials.get(t)}add(t,i){this._materials.set(t,i),this._stage.add(i)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}var pG;const cz=512,uz=4096,lrt=.85,crt=.95;let lx=pG=class extends we{constructor(e){super(e),this.type=rd.Texture,this.id=Ta(),this.events=new xr,this._glTexture=null,this.needsClear=!1,this.elementsToAddOrUpdate=new Map,this.elementsToRemove=new Map,this.elementsToRender=new Map,this.elements=new Map,this.stageObjects=new Map,this.updating=!1}initialize(){this.stage=this.view._stage,this.canvas=this._create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(this);const e=this._computeAtlasResolution(this.view.width,this.view.height);this._createAtlasRegion(e),this._update2DCanvasSize(),this._resetAtlasCursor()}unload(){this._glTexture=tt(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get width(){return this.atlas.size.width}get height(){return this.atlas.size.height}get requiresFrameUpdates(){return!1}_createDescriptor(e){return{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE,flipped:!0,samplingMode:Ge.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}get glTexture(){return this._glTexture}load(e){return _(this._glTexture)||(this._glTexture=new Qe(e,this._createDescriptor(e),this.canvas),this.frameWorker=this.view.resourceController.scheduler.registerTask(ht.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture}dispose(){this.elements=null,this.elementsToAddOrUpdate=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker=Js(this.frameWorker),this._glTexture&&(this.stage.remove(this),this._glTexture=tt(this._glTexture)),this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null}_create2DCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",cz.toString()),e.setAttribute("height",cz.toString()),e}_update2DCanvasSize(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString())}_createAtlasRegion(e=cz){this.atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}}_computeAtlasResolution(e,t){let i=Math.max(e,t);return i+=256,i=wT(i),i=Math.min(i,uz),i}_resizeAtlas(e,t){t=t||e;const i=this.atlas;i.size.width=e,i.size.height=t,_(this._glTexture)&&this._glTexture.resize(e,t),this._update2DCanvasSize()}_resetAtlasCursor(){const e=this.atlas;e.cursor.x=eE,e.cursor.y=eE+_re,e.lineHeight=0,this.needsClear=!0}_getAtlasUsage(){const e=this.atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}_getExpectedAtlasUsage(){const e=this.elementsToRemove.size,t=this.elementsToAddOrUpdate.size,i=this.elements.size;return this._getAtlasUsage()/i*(i+t-e)}_addAtlasElement(e,t,i,r){const s=this.atlas,{renderedWidth:n,renderedHeight:o,displayWidth:a,displayHeight:l}=e.textRenderer;e.placement.offset.x=s.cursor.x,e.placement.offset.y=s.cursor.y,e.placement.size.width=n,e.placement.size.height=o,e.placement.size.displayWidth=a,e.placement.size.displayHeight=l,e.placement.uvMinMax=[e.placement.offset.x/s.size.width,1-(e.placement.offset.y+o)/s.size.height,(e.placement.offset.x+n)/s.size.width,1-e.placement.offset.y/s.size.height],s.cursor.x+=i,s.lineHeight=Math.max(s.lineHeight,r),this.elements.set(t,e)}_removeAtlasElement(e){if(e&&this.elements.has(e.textId)){const t=e.placement.offset,i=e.placement.size;this.ctx.clearRect(t.x,t.y,i.width,i.height),this.elements.delete(e.textId)}}_ensureStageObjects(e){const t=this.stageObjects.get(e);if(t)return t;const i=new Set;return this.stageObjects.set(e,i),i}_addStageObject(e,t){this._ensureStageObjects(e).add(t)}_removeStageObject(e,t){const i=this.stageObjects.get(e);i&&i.delete(t)&&(t.geometries[0].vertexAttributes.get(E.SIZE).data=[0,0],t.geometryVertexAttrsUpdated(t.geometryRecords[0]))}_processAddition(e,t){const i=this.atlas,r=e.textId,s=e.textRenderer.renderedWidth,n=e.textRenderer.renderedHeight,o=s+eE,a=n+eE+_re;if(i.cursor.x+o<i.size.width&&i.cursor.y+a<i.size.height)this._addAtlasElement(e,r,o,a),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r);else{if(!(i.cursor.y+a+i.lineHeight<i.size.height)){const l=this._getExpectedAtlasUsage(),c=l>lrt&&i.size.width<uz;return c&&this._resizeAtlas(2*i.size.width,2*i.size.height),!t||!c&&l>crt&&i.size.width===uz?(this._processRemovals(),Vx.OK):(this._repack(),Vx.REPACK)}i.cursor.x=eE,i.cursor.y+=i.lineHeight,i.lineHeight=0,this._addAtlasElement(e,r,o,a),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r)}return Vx.OK}_processRemovals(){this.elementsToRemove.forEach((e,t)=>{const i=this.stageObjects.get(t);i&&i.size!==0||this._removeAtlasElement(e),i&&i.size===0&&this.stageObjects.delete(t)}),this.elementsToRemove.clear()}_repack(){this._processRemovals(),this.elements.forEach((e,t)=>{e.rendered=!1,this.elementsToAddOrUpdate.set(t,e)}),this.elements.clear(),this._resetAtlasCursor(),this.elementsToRender.clear()}_processRenderingRequest(e){this.ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this.ctx,e.placement.offset.x,e.placement.offset.y);const t=this.stageObjects.get(e.textId);t&&t.forEach(i=>{i.geometries[0].vertexAttributes.get(E.UV0).data=new Float32Array(e.placement.uvMinMax),i.geometries[0].vertexAttributes.get(E.SIZE).data=[e.placement.size.displayWidth,e.placement.size.displayHeight],i.geometryVertexAttrsUpdated(i.geometryRecords[0])}),e.rendered=!0}get running(){return this.updating}runTask(e,t=!0){if(!this._glTexture)return;let i=!1;if(qr(this.elementsToAddOrUpdate,(s,n)=>{const o=this.elements.get(n);if(o&&o.rendered){const a=this.stageObjects.get(n);return a&&a.forEach(l=>{const c=l.geometries[0].vertexAttributes,h=this.elements.get(n);c.get(E.UV0).data=new Float32Array(h.placement.uvMinMax),c.get(E.SIZE).data=new Float32Array([h.placement.size.displayWidth,h.placement.size.displayHeight]),l.geometryVertexAttrsUpdated(l.geometryRecords[0])}),this.elementsToAddOrUpdate.delete(n),!1}return this._processAddition(this.elementsToAddOrUpdate.get(n),t)===Vx.REPACK&&(i=!0,!0)}),i)return void this.runTask(e2,!1);let r=!1;this.elementsToRender.size>0&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1),qr(this.elementsToRender,(s,n)=>(this._processRenderingRequest(s),this.elementsToRender.delete(n),r=!0,e.madeProgress(),e.done)),r&&_(this._glTexture)&&this._glTexture.setData(this.canvas),this.updating=this.elementsToRender.size>0,!this.updating&&pG.test.orderedRepackingEnabled&&this.repackOrdered()}addTextTexture(e,t){const i=e.key;this.elementsToAddOrUpdate.has(i)||this.elementsToAddOrUpdate.set(i,{textId:i,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this._addStageObject(i,t),this.elementsToRemove.delete(i),this.setDirty()}removeTextTexture(e,t){const i=e.key;this.elementsToRemove.set(i,this.elements.get(i)),this._removeStageObject(i,t)}setDirty(){this._glTexture&&(this.updating=!0)}repackOrdered(){if(this.elements.size===0)return;const e=[];this.elements.forEach((i,r)=>e.push({element:i,key:r}));let t=!0;for(let i=0;i<e.length-1;i++)if(e[i].key.localeCompare(e[i+1].key)>0){t=!1;break}if(!t||this.elementsToRemove.size){e.sort((i,r)=>i.key.localeCompare(r.key)),this.elements.clear();for(const{element:i,key:r}of e)this.elements.set(r,i);this._repack(),this.setDirty()}}get test(){const{elements:e,stageObjects:t,elementsToRemove:i,atlas:r}=this,s=this;return{elements:e,stageObjects:t,elementsToRemove:i,atlas:r,_resizeAtlas:(n,o)=>s._resizeAtlas(n,o),run:(n,o)=>s.runTask(n,o)}}};lx.test={orderedRepackingEnabled:!1},u([d({constructOnly:!0})],lx.prototype,"view",void 0),u([d({type:Boolean})],lx.prototype,"updating",void 0),lx=pG=u([P("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],lx);const eE=2,_re=2;var Vx;(function(e){e[e.OK=0]="OK",e[e.REPACK=1]="REPACK"})(Vx||(Vx={}));const urt=lx,bre=he.getLogger("esri.views.3d.layers.graphics.Labeler");let m_=class extends we{constructor(){super(...arguments),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this._handles=new Ut,this._handles.add([this.view.watch("state.camera",()=>this.setDirty()),this.view.watch("pixelRatio",()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(ht.LABELER,this)]),this._textTextureAtlas=new urt({view:this.view}),this._hudMaterialCollection=new vre(this.view._stage),this._calloutMaterialCollection=new vre(this.view._stage)}dispose(){this._handles=rt(this._handles),this._textTextureAtlas=tt(this._textTextureAtlas),this._hudMaterialCollection=tt(this._hudMaterialCollection),this._calloutMaterialCollection=tt(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}_activateLabelingContext(e){e.labels.forEach((t,i)=>{this._labels.set(i,t),t.graphics3DGraphic.setVisibilityFlag(ac.USER_SETTING,!0,mn.LABEL)}),e.active=!0}_deactivateLabelingContext(e){e.labels.forEach((t,i)=>{t.graphics3DGraphic.setVisibilityFlag(ac.USER_SETTING,!1,mn.LABEL),this.setLabelGraphicVisibility(t.graphics3DGraphic,!1),this._labels.delete(i)}),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textTextureResources.textRenderers[t._labelIndex];_(i)&&this._textTextureAtlas.addTextTexture(i,t.stageObject)}e.rendered=!0}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textTextureResources.textRenderers[t._labelIndex];_(i)&&this._textTextureAtlas.removeTextTexture(i,t.stageObject)}e.rendered=!1}get running(){var e;return this.view.ready&&(this._dirty||((e=this._textTextureAtlas)==null?void 0:e.updating)||this.deconflictor.running)}runTask(e){this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e)}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(hrt(t)){if(!wre(t)){if(drt(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),hz(t)){this._dirty=!0;continue}if(!wre(t))continue}qr(t.labelsToInitialize,(i,r)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(r,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textTextureResources.initialized||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done))&&(this._dirty=!0)}this._labelsToRemove.forEach(t=>this._removeLabelTextureFromAtlas(t)),this._labelsToAdd.forEach(t=>this._addLabelTextureToAtlas(t)),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController.signal;await e.layer.when(),Qt(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,s=r.labelingInfo&&r.labelingInfo.filter(a=>!!a.symbol);if(!s||s.length===0)return;const n=new Array(s.length);let o=!1;await JN(s,async(a,l)=>{const c=a.symbol,h=WW(i.getOrCreateGraphics3DSymbol(c));if(R(h))return void bre.error("Failed to create Graphics3DSymbol for label");await h.load(),Qt(t);let p=null;bj(c)&&c.hasVisibleCallout()&&(p=AYe(c,i.symbolCreationContext),await p.load(),Qt(t));const f=await wl(sve(a,e.layer.fieldsIndex,this.view.spatialReference));if(Qt(t),f.ok===!0){const g=await this._createTextRenderParameters(h.symbol);Qt(t),n[l]={labelClass:a,labelFunction:f.value,graphics3DSymbol:h,graphics3DCalloutSymbolLayer:p,calloutSymbolLayerIndex:0,textRenderParameters:g}}else bre.error(`Label expression failed to evaluate: ${f.error}`),o=!0}),Qt(t),o||(e.labelClassContexts=n)}async _createLabelClassContext(e){return e.labelClassPromise||(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(t=>{if(pr(t))throw t;e.labelClassContexts=null}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.getItemAt(0);return t&&t.type==="text"?V4.fromSymbol(t,this.view.pixelRatio):null}_destroyLabelClassContext(e){for(const i of e.labelClassContexts)--i.graphics3DSymbol.referenced,i.graphics3DSymbol=null;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,t&&t.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,s){const n={text:e.text,centerOffset:i.centerOffset,translation:i.translation,elevationOffset:i.elevationOffset,screenOffset:i.screenOffset,centerOffsetUnits:i.centerOffsetUnits,horizontalPlacement:Iie(i.anchor),verticalPlacement:hJe(i.anchor),verticalOffset:i.verticalOffset,debugDrawLabelBorder:hi.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return Sg.graphic=t,Sg.renderingInfo=null,Sg.layer=r,s.createLabel(Sg,n,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(e,t,i,r,s){const n={symbol:t,translation:r.translation,elevationOffset:r.elevationOffset,screenOffset:r.screenOffset,centerOffset:r.centerOffset,centerOffsetUnits:r.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};return Sg.graphic=e,Sg.renderingInfo=n,Sg.layer=s,i.createGraphics3DGraphic(Sg)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const{textTextureResources:i}=e,r=e.labelingContext,s=r.labelClassContexts;if(!s||s.length===0||!r.emptySymbolLabelSupported&&t.graphics.length===0)return!1;let n=!1;const o=t.graphic,a=r.layer,l=gV(r.layer),c=this.view._stage;for(let h=0;h<s.length;h++){const p=i.textRenderers[h],f=i.labelPlacements[h];if(R(p)||R(f))continue;const g=s[h],y=g.graphics3DSymbol,v=y.symbol&&y.symbol.type==="label-3d"?y.symbol:null,b=y.symbolLayers[0];if(!b)continue;b.setElevationInfoOverride(r.elevationInfoOverride);const w=this._createTextSymbolGraphic(p,o,f,a,b);if(!w)return!1;w._labelClass=g.labelClass,w._labelIndex=h,t.addLabelGraphic(w,c,r.stageLayer),t.setVisibilityFlag(ac.USER_SETTING,l,mn.LABEL),t.clearVisibilityFlag(ac.SCALE_RANGE,mn.LABEL),t.setVisibilityFlag(ac.DECONFLICTION,!1,mn.LABEL),n=!0;const S=g.graphics3DCalloutSymbolLayer;if(S&&f.hasLabelVerticalOffset){S.setElevationInfoOverride(r.elevationInfoOverride);const T=this._createLineCalloutGraphic(o,v,S,f,a);_(T)&&(g.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(T,c,r.stageLayer))}break}return r.scaleVisibility&&n&&r.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelGraphics){if(i._labelClass==null)continue;const r=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];r!=null&&r.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){const{textTextureResources:t}=e;if(t.initialized)return;const i=e.labelingContext,r=i.labelClassContexts;if(!r||r.length===0)return;const s=e.graphics3DGraphic.graphic;for(let n=0;n<r.length;n++){const o=r[n];if(t.textRenderers[n]=null,t.labelPlacements[n]=null,!o.textRenderParameters)continue;const a=o.labelFunction;let l;if(a.type==="arcade")try{const w=a.needsHydrationToEvaluate()?wXe(s,i.layer):s;l=a.evaluate(w)}catch{l=null}else l=a.evaluate(s);if(R(l)||l===""||/^\s+$/.test(l))continue;const c=o.graphics3DSymbol,h=c.symbol&&c.symbol.type==="label-3d"?c.symbol:null;if(!c.symbolLayers[0])continue;const p=e.graphics3DGraphic,f=o.labelClass,g=i.disablePlacement,y=Qit({graphics3DGraphic:p,labelSymbol:h,labelClass:f,disablePlacement:g});if(R(y))continue;const v=Iie(y.anchor),b=b_e(v);t.textRenderers[n]=new v_e(l,b,o.textRenderParameters),t.labelPlacements[n]=y}t.initialized=!0}_destroyTextTextureResources(e){const{textTextureResources:t}=e;t.initialized=!1,t.textRenderers=[],t.labelPlacements=[]}_addGraphic(e,t){const i={hasGraphics3DResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textTextureResources:{initialized:!1,textRenderers:[],labelPlacements:[]}},r=t.graphic.uid;e.labels.set(r,i),e.labelsToInitialize.set(r,i),this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const i=t.graphic.uid,r=e.labels.get(i);r&&(this._destroyGraphic(r,i),e.labels.delete(i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.textTextureResources.initialized&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const r=e.labels.get(i);r&&(this._removeGraphic(e,r.graphics3DGraphic),this._addGraphic(e,r.graphics3DGraphic))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.labels.forEach(n=>{const o=n.graphics3DGraphic;r.set(o.graphic.uid,o)});const s=n=>n.labelGraphics[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,s),i.graphics3DCalloutSymbolLayer){const n=o=>o.labelGraphics[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,n)}}}_visibilityInfoChange(e){const t=e.layer.labelsVisible;t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.labels.forEach((t,i)=>{this._destroyGraphic(t,i),t.visible=!1,t.rendered=!1,e.labelsToInitialize.set(i,t)}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i&&i.emptySymbolLabelSupported||!1,s=i&&i.elevationInfoOverride||null,n=i&&i.disablePlacement||null;if(this._findLabelingContext(e))return;const o=e.layer,a={graphics3DCore:e,layer:o,scaleVisibility:t,emptySymbolLabelSupported:r,elevationInfoOverride:s,disablePlacement:n,active:o.labelsVisible,labelClassPromise:null,labelClassAbortController:new AbortController,labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new Gve({isPickable:!0},o.uid)};return this.view._stage.add(a.stageLayer),this._labelingContexts.push(a),this.setDirty(),{addGraphic:l=>this._addGraphic(a,l),removeGraphic:l=>this._removeGraphic(a,l),featureReductionChange:()=>{},layerLabelsEnabled:()=>gV(a.layer),labelingInfoChange:l=>this._labelingInfoChange(a,l),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",a),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",a),visibilityInfoChange:()=>this._visibilityInfoChange(a),reset:()=>this._resetLabels(a),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.labels.forEach(r=>this._removeGraphic(t,r.graphics3DGraphic)),this.view._stage.remove(t.stageLayer),t.stageLayer=null,this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.rendered?(this._labelsToAdd.set(i,r),this._labelsToRemove.delete(i),r.textTextureResources.initialized||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.rendered&&(this._labelsToRemove.set(i,r),this._labelsToAdd.delete(i)),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||((e=this._textTextureAtlas)==null?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some(t=>hz(t))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((t,i)=>t+(hz(i)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function hrt(e){return e.active&&gV(e.layer)}function hz(e){return e.labelClassPromise&&!!e.labelClassAbortController}function wre(e){return e.labelClassContexts&&e.labelClassContexts.length}function drt(e){return e.labelClassContexts===null}u([d({constructOnly:!0})],m_.prototype,"view",void 0),u([d({constructOnly:!0})],m_.prototype,"deconflictor",void 0),u([d()],m_.prototype,"_textTextureAtlas",void 0),u([d({type:Boolean,readOnly:!0})],m_.prototype,"updating",null),m_=u([P("esri.views.3d.layers.graphics.Labeler")],m_);const Sg=new RYe(null,null,null);class prt{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new Ut}loadGLTF(t,i,r){const s=r?`gltfPBR:${t}`:`gltf:${t}`;return this._fromCache(this.gltfCache,s,n=>V_e(new z_e(n.streamDataRequester),t,n,r),i)}loadWOSR(t,i){const r=`wosr:${t}:${i.disableTextures}`;return this._fromCache(this.wosrCache,r,s=>G_e(t,s),i)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear()}get size(){return this.wosrCache.size+this.gltfCache.size}_fromCache(t,i,r,s){return new Promise((n,o)=>{if(Us(s))return void o(pi());const a=go(s,()=>{this._remove(t,i),o(pi())}),l=t.get(i);if(l)return this.evictHandles.remove(i),l.refCount++,void l.item.then(n,o);const c=new AbortController,h=me(I({},s),{signal:c.signal}),p={refCount:1,abortController:c,item:r(h).then(f=>(p.abortController=null,f.remove=()=>this._remove(t,i),f))};t.set(i,p),p.item.then(f=>{_(a)&&a.remove(),n(f)},f=>{_(a)&&a.remove(),o(f)})})}_remove(t,i){const r=t.get(i);r&&(r.refCount--,r.refCount===0&&this.evictHandles.add(pTe(()=>{t.delete(i),_(r.abortController)&&r.abortController.abort()},mrt),i))}}const frt=1e4;let mrt=frt;class Lh{constructor(t,i,r,s=null){this.lij=[0,0,0],this.extent=Dt(),this.resolution=0,this.loadPriority=0,this.measures={visibility:ao.VISIBLE_ON_SURFACE,screenRect:Dt(),distance:0,shouldSplit:!1},this.used=!1,s&&this.acquire(t,i,r,s)}acquire(t,i,r,s){this.tilingScheme=s,this.id=Lh.id(t,i,r),this.lij[0]=t,this.lij[1]=i,this.lij[2]=r,s.getExtent(t,i,r,this.extent),this.resolution=s.resolutionAtLevel(t)}release(){this.tilingScheme=null}getChildren(t){const i=this.lij[0]+1,r=2*this.lij[1],s=2*this.lij[2];return t?(t[0].acquire(i,r,s,this.tilingScheme),t[1].acquire(i,r+1,s,this.tilingScheme),t[2].acquire(i,r,s+1,this.tilingScheme),t[3].acquire(i,r+1,s+1,this.tilingScheme),t):[new Lh(i,r,s,this.tilingScheme),new Lh(i,r+1,s,this.tilingScheme),new Lh(i,r,s+1,this.tilingScheme),new Lh(i,r+1,s+1,this.tilingScheme)]}copyMeasurementsFrom(t){this.measures.visibility=t.measures.visibility,this.measures.shouldSplit=t.measures.shouldSplit,this.measures.distance=t.measures.distance,y0(t.measures.screenRect,this.measures.screenRect)}static id(t,i,r){return`${t}/${i}/${r}`}}var ao;(function(e){e[e.INVISIBLE=0]="INVISIBLE",e[e.VISIBLE_WHEN_EXTENDED=1]="VISIBLE_WHEN_EXTENDED",e[e.VISIBLE_ON_SURFACE=2]="VISIBLE_ON_SURFACE"})(ao||(ao={}));class $y{constructor(t){this.renderCoordsHelper=t,this.frustum=AR(),this._points=yye(),this.lines=new Array(12),this._origin=M(),this._direction=M(),this._altitude=null;for(let i=0;i<12;i++)this.lines[i]={origin:null,direction:M(),endpoint:null}}get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}update(t){vye(t.viewMatrix,t.projectionMatrix,this.frustum,this._points),ne(this._origin,t.eye),ne(this._direction,t.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(t){for(let i=0;i<this._points.length;i++)ne(this._points[i],t[i]);_ye(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(t){return Qy(this.frustum,t)}intersectsRay(t){return sje(this.frustum,t)}intersectsLineSegment(t,i){return nje(this.frustum,t,i)}intersectsPoint(t){return bye(this.frustum,t)}_updateLines(){const t=this._points;for(let i=0;i<4;i++){const r=i+4;dz(this.lines[i],t[i],t[r]),dz(this.lines[i+4],t[i],i===3?t[0]:t[i+1]),dz(this.lines[i+8],t[r],i===3?t[4]:t[r+1])}}}function dz(e,t,i){e.origin=t,e.endpoint=i,Um(e.direction,t,i)}$y.planePointIndices=aje,$y.nearFarLineIndices=[[Xe.NEAR_BOTTOM_LEFT,Xe.FAR_BOTTOM_LEFT],[Xe.NEAR_BOTTOM_RIGHT,Xe.FAR_BOTTOM_RIGHT],[Xe.NEAR_TOP_RIGHT,Xe.FAR_TOP_RIGHT],[Xe.NEAR_TOP_LEFT,Xe.FAR_TOP_LEFT]];const n1e=.5*Math.PI,grt=n1e/Math.PI*180;class yrt{constructor(t){this.renderCoordsHelper=t.renderCoordsHelper,this.extent=new Array(4),this.planes=new Array(6),this.maxSpan=0,this.center={origin:M(),direction:M()};for(let i=0;i<4;i++)this.extent[i]={origin:M(),direction:M(),cap:{next:null,direction:M()}},this.planes[i]=ii();this.planes[Wi.NEAR]=ii(),this.planes[Wi.FAR]=ii(),this.planesWithoutFar=this.planes.slice(0,5)}update(t,i,r,s=!0){const n=this.extent;this._toRenderBoundingExtent(t,i,r),pe(this.center.origin,n[0].origin,n[2].origin),ae(this.center.origin,this.center.origin,.5),this.renderCoordsHelper.worldUpAtPosition(this.center.origin,this.center.direction),s||ae(this.center.direction,this.center.direction,-1);for(let o=0;o<4;o++){const a=n[o];this.renderCoordsHelper.worldUpAtPosition(a.origin,a.direction);const l=n[o===3?0:o+1];a.cap.next=l.origin,Um(a.cap.direction,a.origin,l.origin),WC(a.direction,a.cap.direction,a.origin,this.planes[o]),s||ae(a.direction,a.direction,-1)}WC(n[0].cap.direction,n[1].cap.direction,n[0].origin,this.planes[Wi.NEAR]),s?dV(this.planes[Wi.NEAR],this.planes[Wi.FAR]):(cF(this.planes[Wi.FAR],this.planes[Wi.NEAR]),dV(this.planes[Wi.NEAR],this.planes[Wi.NEAR])),this.maxSpan=Math.max(Math.abs(t[0]-t[2]),Math.abs(t[1]-t[3])),this.maxSpanSpatialReference=i,this.minGlobalAltitude=.9*di(this.maxSpanSpatialReference).radius}isVisibleInFrustum(t,i,r=!1){if(t==null)return!1;if(this.renderCoordsHelper.viewingMode===Ie.Global){const n=this.maxSpanSpatialReference.isGeographic?grt:n1e*i;if(this.maxSpan>n)return!0;if(t.altitude>=this.minGlobalAltitude)return this._isVisibleInFrustumGlobal(t)}if(this.maxSpan===0){const n=this.extent[0];return!(r||!t.intersectsRay(xc(n.origin,n.direction)))}for(let n=0;n<this.extent.length;n++){const o=this.extent[n];if(!r&&t.intersectsRay(xc(o.origin,o.direction))||t.intersectsLineSegment(u1(o.origin,o.cap.next,_rt),o.cap.direction))return!0}const s=r?this.planes:this.planesWithoutFar;for(let n=0;n<t.lines.length;n++){const o=t.lines[n];if(FGe(s,o.origin,o.endpoint,o.direction))return!0}return!1}_toRenderBoundingExtentGlobal(t,i,r){K7(t,Ku),Ku[2]=r,Kh(i,Ku,pz,this.renderCoordsHelper.spatialReference),fr(xre,pz),ki(La);for(const{x0:n,x1:o,y0:a,y1:l}of vrt)for(let c=0;c<5;c++){const h=c/4;Ku[0]=qt(t[n],t[o],h),Ku[1]=qt(t[a],t[l],h),Ku[2]=r,wn(Ku,i,Ku,this.renderCoordsHelper.spatialReference),ke(Ku,Ku,xre),Tp(La,Ku)}oe(this.extent[0].origin,La[0],La[1],La[2]),oe(this.extent[1].origin,La[3],La[1],La[2]),oe(this.extent[2].origin,La[3],La[4],La[2]),oe(this.extent[3].origin,La[0],La[4],La[2]);for(let n=0;n<4;++n)ke(this.extent[n].origin,this.extent[n].origin,pz)}_toRenderBoundingExtentLocal(t,i,r){nF(t,i,of,this.renderCoordsHelper.spatialReference),oe(this.extent[0].origin,of[0],of[1],r),oe(this.extent[1].origin,of[2],of[1],r),oe(this.extent[2].origin,of[2],of[3],r),oe(this.extent[3].origin,of[0],of[3],r)}_toRenderBoundingExtent(t,i,r){switch(this.renderCoordsHelper.viewingMode){case Ie.Global:this._toRenderBoundingExtentGlobal(t,i,r);break;case Ie.Local:this._toRenderBoundingExtentLocal(t,i,r);break;default:this.renderCoordsHelper.viewingMode}}_isVisibleInFrustumGlobal(t){if(_e(this.center.direction,t.direction)<0)return!0;for(let i=0;i<4;i++){const r=this.extent[i];if(_e(r.direction,t.direction)<0)return!0}return!1}}const vrt=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],Ku=M(),pz=Te(),xre=Te(),La=cs(),of=Dt(),_rt=z0();class brt{constructor(t){this.renderCoordsHelper=t,this.surfaceElevation=0,this.cache=new Map,this.frustum=new $y(t),this.extendedFrustum=new $y(t),this.intersector=new yrt({renderCoordsHelper:t}),this.renderCoordsHelper=t}begin(t,i){this.surfaceElevation=i,this.aboveGround=this.renderCoordsHelper.getAltitude(t.eye)>i,this.frustum.update(t),this._shortenFrustumFarPlane(this.frustum),this._updateExtendedFrustum(t)}end(){this.cache.clear()}calculate(t){if(this.allTilesInvisible)return ao.INVISIBLE;const i=this.renderCoordsHelper.viewingMode===Ie.Global&&t.lij[0]>=wrt&&t.lij[0]<xrt,r=this._getOrCalculateSingleTileVisibility(t,!i);return r!==ao.INVISIBLE&&i?this._calculateAggregatedChildrenVisibility(t):r}_shortenFrustumFarPlane(t){const i=$y.nearFarLineIndices,r=t.mutablePoints;for(const s of i){const[n,o]=s,a=r[n],l=r[o];de($l,l,a),ae($l,$l,Srt),pe(r[o],a,$l)}t.updatePoints(r)}_calculateAggregatedChildrenVisibility(t){let i=ao.INVISIBLE;const r=this.cache.get(t.id);if(r!=null)return r;const s=Are.acquire();t.getChildren(s);for(const n of s){const o=this.calculate(n);if(o!==ao.INVISIBLE&&(i=o,o===ao.VISIBLE_ON_SURFACE))break}return Are.release(s),this.cache.set(t.id,i),i}_getOrCalculateSingleTileVisibility(t,i){const r=this.cache.get(t.id);if(r!=null)return r;const s=this._calculateSingleTileVisibility(t);return i&&this.cache.set(t.id,s),s}_calculateSingleTileVisibility(t){return!this.aboveGround&&this.renderCoordsHelper.viewingMode===Ie.Global&&t.lij[0]<Trt?this._calculateSingleTileVisibilitySided(t,!1)===ao.INVISIBLE?this._calculateSingleTileVisibilitySided(t,!0):void 0:this._calculateSingleTileVisibilitySided(t,this.aboveGround)}_calculateSingleTileVisibilitySided(t,i){this.intersector.update(t.extent,t.tilingScheme.spatialReference,this.surfaceElevation,i);const r=di(t.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,r)?this.intersector.isVisibleInFrustum(this.frustum,r,!0)?ao.VISIBLE_ON_SURFACE:ao.VISIBLE_WHEN_EXTENDED:ao.INVISIBLE}_updateExtendedFrustum(t){this.extendedFrustum.update(t),this._shortenFrustumFarPlane(this.extendedFrustum);const i=this.renderCoordsHelper.worldUpAtPosition(t.eye,$l);this.aboveGround||mo(i,i);const r=Rs(-_e(i,t.viewForward));if(this.allTilesInvisible=r>(Math.PI+t.fovY)/2,this.allTilesInvisible||(this.hasExtendedFrustum=r>t.fovY/2,!this.hasExtendedFrustum))return;const s=this._extendedFrustumParameters(),n=this.extendedFrustum.mutablePoints;for(let o=0;o<4;o++){const a=s.pointIndices[o],l=n[a],c=this.renderCoordsHelper.getAltitude(l);if(s.needsAltitudeAdjustment(c)){switch(this.renderCoordsHelper.worldUpAtPosition(l,$l),a){case Xe.FAR_BOTTOM_LEFT:case Xe.FAR_TOP_LEFT:case Xe.NEAR_BOTTOM_LEFT:case Xe.NEAR_TOP_LEFT:pV(this.extendedFrustum.planes[Wi.LEFT],$l,$l);break;case Xe.FAR_BOTTOM_RIGHT:case Xe.FAR_TOP_RIGHT:case Xe.NEAR_BOTTOM_RIGHT:case Xe.NEAR_TOP_RIGHT:pV(this.extendedFrustum.planes[Wi.RIGHT],$l,$l)}ae($l,$l,s.direction),this.renderCoordsHelper.intersectInfiniteManifold(xc(l,$l),s.zWithMargin,l)}}if(this.extendedFrustum.updatePoints(n),co(n[Xe.NEAR_BOTTOM_LEFT],n[Xe.NEAR_BOTTOM_RIGHT],n[Xe.NEAR_TOP_RIGHT],Sre),co(n[Xe.NEAR_BOTTOM_RIGHT],n[Xe.NEAR_TOP_RIGHT],n[Xe.NEAR_TOP_LEFT],Ere),_e(Sre,Ere)<0){const o=this.extendedFrustum.mutablePoints;this.aboveGround?[o[Xe.NEAR_BOTTOM_LEFT],o[Xe.NEAR_BOTTOM_RIGHT]]=[o[Xe.NEAR_BOTTOM_RIGHT],o[Xe.NEAR_BOTTOM_LEFT]]:[o[Xe.NEAR_TOP_LEFT],o[Xe.NEAR_TOP_RIGHT]]=[o[Xe.NEAR_TOP_RIGHT],o[Xe.NEAR_TOP_LEFT]],this.extendedFrustum.updatePoints(o)}}_extendedFrustumParameters(){return this.aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const t=this.surfaceElevation-Tre;return{zWithMargin:t,pointIndices:$y.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:i=>i>t}}_extendedFrustumParametersBelowSurface(){const t=this.surfaceElevation+Tre;return{zWithMargin:t,pointIndices:$y.planePointIndices.top,direction:1,needsAltitudeAdjustment:i=>i<t}}}const wrt=2,xrt=6,Trt=12,Srt=.95,Tre=1,$l=M(),Sre=ii(),Ere=ii(),Are=new Wr(Array,e=>{e.length!==4&&(e[0]=new Lh,e[1]=new Lh,e[2]=new Lh,e[3]=new Lh)},e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()});class Ert{constructor(t){this.camera=new wi,this.focusOnMap=[0,0],this.screenRect=Dt(),this.tileSize=t.tileSize,this.renderCoordsHelper=t.renderCoordsHelper,this.tilingScheme=t.tilingScheme,this.visibility=new brt(t.renderCoordsHelper)}begin(t,i,r){this.camera.copyFrom(t),this.surfaceElevation=r,this.focusOnMap[0]=i.x,this.focusOnMap[1]=i.y,GEe(0,0,t.fullWidth,t.fullHeight,this.screenRect),this.visibility.begin(this.camera,r)}end(){this.visibility.end()}updateTile(t){t.measures.visibility=this.visibility.calculate(t),t.measures.distance=qEe(t.extent,this.focusOnMap),t.measures.visibility!==ao.INVISIBLE&&this._updateScreenMeasure(t)}_updateScreenMeasure(t){const i=Art,r=1<<i,s=t.measures.screenRect;$u(s);let n=0;const o=t.lij[0]+i,a=t.lij[1]<<i,l=t.lij[2]<<i,c=this._tileSizeWithBias(t),h=c*c;for(let p=0;p<r;p++)for(let f=0;f<r;f++)if(n+=this._computeScreenArea(t,o,a+p,l+f,s),n>h)return void(t.measures.shouldSplit=!0);t.measures.shouldSplit=!1}_tileSizeWithBias(t){return t.measures.visibility===ao.VISIBLE_WHEN_EXTENDED?this.tileSize*Crt:this.tileSize}_computeScreenArea(t,i,r,s,n){const o=t.measures.visibility===ao.VISIBLE_WHEN_EXTENDED;this._projectToScreen(i,r,s,o,Eg),$u(fz);for(let a=0;a<4;a++)Ile(fz,Eg[a]);return n0(n,fz,n),bee(Eg[0],Eg[1],Eg[2])+bee(Eg[0],Eg[2],Eg[3])}_projectToScreen(t,i,r,s,n){this.tilingScheme.ensureMaxLod(t),this.tilingScheme.getExtent(t,i,r,tE),this._toRenderCoords(tE,0,3,Ag[0]),this._toRenderCoords(tE,2,3,Ag[1]),this._toRenderCoords(tE,2,1,Ag[2]),this._toRenderCoords(tE,0,1,Ag[3]),s&&(this._projectToPlane(Ag,this.camera.frustum[Wi.NEAR]),this._projectToPlane(Ag,this.camera.frustum[Wi.TOP]),this._projectToPlane(Ag,this.camera.frustum[Wi.BOTTOM]));for(let o=0;o<4;o++)this.camera.projectToRenderScreen(Ag[o],Cre),this.camera.renderToScreen(Cre,n[o])}_projectToPlane(t,i){for(let s=0;s<4;s++)rE[s]=tr(i,t[s]);const r=Math.max(rE[0],rE[1],rE[2],rE[3]);if(r>0){const s=ae(iE,i,-r);for(let n=0;n<4;n++)pe(t[n],t[n],s)}}_toRenderCoords(t,i,r,s){return iE[0]=t[i],iE[1]=t[r],iE[2]=this.surfaceElevation,this.renderCoordsHelper.toRenderCoords(iE,this.tilingScheme.spatialReference,s),s}}const fz=Dt(),Art=2,Crt=5,Eg=[Rr(),Rr(),Rr(),Rr()],tE=Dt(),iE=M(),Ag=[M(),M(),M(),M()],rE=[0,0,0,0],Cre=zn();function Zyt(e,t,i){if(R(e)||R(i))return!1;let r=!0;return ys[0]=e.xmin!=null?e.xmin:0,ys[1]=e.ymin!=null?e.ymin:0,ys[2]=e.zmin!=null?e.zmin:0,r=r&&br(ys,e.spatialReference,0,t,i,0,1),ys[0]=e.xmax!=null?e.xmax:0,ys[1]=e.ymax!=null?e.ymax:0,ys[2]=e.zmax!=null?e.zmax:0,r=r&&br(ys,e.spatialReference,0,t,i,3,1),e.xmin==null&&(t[0]=-1/0),e.ymin==null&&(t[1]=-1/0),e.zmin==null&&(t[2]=-1/0),e.xmax==null&&(t[3]=1/0),e.ymax==null&&(t[4]=1/0),e.zmax==null&&(t[5]=1/0),r}function o1e(e,t,i){if(R(e)||R(i))return!1;let r=!0;return ys[0]=e.xmin!=null?e.xmin:0,ys[1]=e.ymin!=null?e.ymin:0,ys[2]=e.zmin!=null?e.zmin:0,r=r&&br(ys,e.spatialReference,0,ys,i,0,1),t[0]=ys[0],t[1]=ys[1],ys[0]=e.xmax!=null?e.xmax:0,ys[1]=e.ymax!=null?e.ymax:0,ys[2]=e.zmax!=null?e.zmax:0,r=r&&br(ys,e.spatialReference,0,ys,i,0,1),t[2]=ys[0],t[3]=ys[1],e.xmin==null&&(t[0]=-1/0),e.ymin==null&&(t[1]=-1/0),e.xmax==null&&(t[2]=1/0),e.ymax==null&&(t[3]=1/0),r}const ys=M(),Rrt=he.getLogger("esri.views.3d.layers.support.FeatureTileTree3D");let Mn=class extends we{constructor(e){super(e),this.tiles=new it,this.tileSize=512,this._idToTile=new Map,this._handles=new Ut,this._clients=new Set,this._dirty=!1,this._newTiles=new $t}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(_(e)&&!e.spatialReference.equals(this.viewState.spatialReference))return void Rrt.error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||_(t)&&e&&t.equals(e))return;const i=_(e)?e.clone():null;this._set("filterExtent",i),this._setDirty()}get filterExtentRect(){if(R(this.filterExtent)||!this.tilingScheme)return null;const e=Dt();return o1e(this.filterExtent,e,this.tilingScheme.spatialReference),e}get rootTileIds(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}initialize(){this._handles.add(this.watch(["tilingScheme","tileSize"],()=>this._reset(),!0)),this._handles.add(Wt(this,["tileSize","cameraOnSurface.location","tilingScheme","viewState.contentCamera","focus.location"],()=>this._setDirty(),!0)),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(ht.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=Js(this._frameWorker),this._handles=rt(this._handles)}addClient(){const e=Mrt();return this._clients.add(e),this._clients.size===1&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(e2))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),_(this._frameWorker)&&(this._frameWorker.priority=ht.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&_(this._frameWorker)&&(this._frameWorker.priority=ht.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new Ert({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){return this.rootTileIds.map(e=>new Lh(e[0],e[1],e[2],this.tilingScheme))}_purgeHorizonTiles(e){e.sort((t,i)=>{const r=t.measures.screenRect,s=i.measures.screenRect;return r[1]+r[3]-(s[1]+s[3])}),$u(aP);for(let t=0;t<e.length;t++)if(n0(aP,e.data[t].measures.screenRect,aP),A1(aP)>Prt)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!e.done;){const t=this._pendingTiles.pop();e.madeProgress(),this.filterExtentRect&&!VN(this.filterExtentRect,t.extent)||(this._tileMeasurements.updateTile(t),t.measures.visibility!==ao.INVISIBLE&&(t.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(t.lij[0]+1),this._pendingTiles.push(...t.getChildren())):this._newTiles.push(t)))}this._pendingTiles.length===0&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}_updateTiles(e){for(const r of this.tiles.items)r.used=!1;const t=e.filter(r=>{const s=this._idToTile.get(r.id);return s?(s.copyMeasurementsFrom(r),s.used=!0):this._idToTile.set(r.id,r),!s}),i=this.tiles.items.filter(r=>!r.used&&(this._idToTile.delete(r.id),!0));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles()}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,t)=>e.measures.visibility!==t.measures.visibility?e.measures.visibility===ao.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance),this.tiles.forEach((e,t)=>e.loadPriority=t)}};u([d({constructOnly:!0})],Mn.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Mn.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],Mn.prototype,"tilingSchemeOwner",void 0),u([d({constructOnly:!0})],Mn.prototype,"cameraOnSurface",void 0),u([d({constructOnly:!0})],Mn.prototype,"focus",void 0),u([d({constructOnly:!0})],Mn.prototype,"viewState",void 0),u([d({constructOnly:!0})],Mn.prototype,"terrain",void 0),u([d()],Mn.prototype,"tiles",void 0),u([d()],Mn.prototype,"tileSize",void 0),u([d({readOnly:!0})],Mn.prototype,"tilingScheme",null),u([d()],Mn.prototype,"filterExtent",null),u([d({readOnly:!0})],Mn.prototype,"filterExtentRect",null),u([d({readOnly:!0})],Mn.prototype,"rootTileIds",null),u([d({value:!1})],Mn.prototype,"suspended",null),u([d({readOnly:!0})],Mn.prototype,"updating",null),Mn=u([P("esri.views.3d.layers.support.FeatureTileTree3D")],Mn);let Ort=0;function Mrt(){return Ort++}const aP=Dt(),Prt=10,a1e=Mn;class N0{constructor(t,i){this.owner=i,this.properties={},this.afterDispatchHandle=null;for(const r in t){const s=t[r],n=new Boe(s,null,null,2,2);this.properties[r]={pool:n,acquired:[]}}this.afterDispatchHandle=aae(()=>this._release())}destroy(){this.afterDispatchHandle&&(this.afterDispatchHandle.remove(),this.afterDispatchHandle=null);for(const t in this.properties){const i=this.properties[t];for(const r of i.acquired)KX(r)||i.pool.release(r);i.pool.destroy(),i.pool=null,i.acquired=null}this.properties=null,this.owner=null}get(t){const i=this.owner._get(t),r=this.properties[t];let s=r.pool.acquire();for(r.acquired.push(s);s===i;)r.acquired.push(s),s=r.pool.acquire();return s}_release(){for(const t in this.properties){const i=this.properties[t];let r=0;for(const s of i.acquired)KX(s)?i.acquired[r++]=s:i.pool.release(s);i.acquired.length=r}}}let Pn=class extends we{constructor(){super(...arguments),this._propertiesPool=new N0({camera:wi},this),this._lastSeenCameraProjectionValues=new wi,this.events=new xr,this.viewingMode=Ie.Global,this._cameraChanged=!1,this.updateQueue=new Array,this.processingUpdates=!1}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new nVe({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new N0({camera:wi},this)}createInitialCamera(){if(this.viewingMode===Ie.Global){const e=di(this.spatialReference).radius;this.camera=new wi(je(4*e,0,0),je(e,0,0),je(0,0,1))}else this.camera=new wi(je(0,0,100),je(0,0,0),je(0,1,0))}get animation(){return this.cameraController instanceof CR&&_(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(e){e!==kc&&kc.copyFrom(e),kc.computeUp(this.viewingMode),Rre.camera=kc,this.events.emit("before-camera-change",Rre);const t=this._get("camera");if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,kc)&&(this._lastSeenCameraProjectionValues.copyFrom(kc),Ore.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",Ore)),(!t||!t.equals(kc))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(kc)),this._cameraChanged=!t||!t.almostEquals(kc),this._cameraChanged)){const i=aae(()=>{this._cameraChanged=!1,i.remove()})}}get contentCamera(){return _(this._contentCamera)?this._contentCamera:this.camera}set contentCamera(e){this._contentCamera=_(e)?e.clone():null}get fixedContentCamera(){return!!_(this._contentCamera)}get isGlobal(){return this.viewingMode===Ie.Global}get isLocal(){return this.viewingMode===Ie.Local}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(e&&(e.watch("state",t=>{t!==cr.Finished&&t!==cr.Stopped||(this._set("cameraController",null),this.updateCamera(i=>e.onControllerEnd(i)))},!0),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=cr.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==cr.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this.updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(this.updateQueue.length===0||this.processingUpdates)return;this.processingUpdates=!0;const e=this.updateQueue.shift();kc.copyFrom(this._get("camera")),e(kc),this.camera=kc,this.processingUpdates=!1,this._processUpdateQueue()}_cameraProjectionChanged(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[bt.TOP]!==t.padding[bt.TOP]||e.padding[bt.RIGHT]!==t.padding[bt.RIGHT]||e.padding[bt.BOTTOM]!==t.padding[bt.BOTTOM]||e.padding[bt.LEFT]!==t.padding[bt.LEFT]}};u([d({readOnly:!0,type:sS})],Pn.prototype,"animation",null),u([d({type:wi})],Pn.prototype,"camera",null),u([d({})],Pn.prototype,"_contentCamera",void 0),u([d({type:wi})],Pn.prototype,"contentCamera",null),u([d({readOnly:!0})],Pn.prototype,"fixedContentCamera",null),u([d({readOnly:!0})],Pn.prototype,"constraints",void 0),u([d({readOnly:!0})],Pn.prototype,"events",void 0),u([d({readOnly:!0})],Pn.prototype,"isGlobal",null),u([d({readOnly:!0})],Pn.prototype,"isLocal",null),u([d({readOnly:!0})],Pn.prototype,"viewingMode",void 0),u([d({readOnly:!0})],Pn.prototype,"spatialReference",void 0),u([d({readOnly:!0})],Pn.prototype,"navigating",null),u([d({readOnly:!0})],Pn.prototype,"stationary",null),u([d()],Pn.prototype,"_cameraChanged",void 0),u([d()],Pn.prototype,"cameraController",null),Pn=u([P("esri.views.3d.state.ViewState")],Pn);const Irt=Pn,kc=new wi,Rre={camera:null},Ore={camera:null};function $rt(e,t,i){return e===Ie.Global?new Lrt(i):new Drt(t,i)}class Drt{constructor(t,i){this.elevationProvider=t,this._referenceEllipsoid=di(i),this.unitInMeters=Cl(i,this._referenceEllipsoid.metersPerDegree)}compute(t,i,r,s,n){n||(n={near:0,far:0});let o=t[2]*this.unitInMeters;const a=o,l=o-s,c=this.elevationProvider?this.elevationProvider.elevationBounds:null;c&&(o=l>=0?a-this.unitInMeters*c.min:this.unitInMeters*c.max-a);const h={x:(r=_(r)?r:new Xt({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-r.xmin,y:r.ymax-r.ymin,z:4*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},p=Math.max(h.x,h.y,h.z);de(Tv,i,t),iw[0]=Tv[0]>0?r.xmax:r.xmin,iw[1]=Tv[1]>0?r.ymax:r.ymin,iw[2]=Tv[2]>0?p/2:-p/2,de(iw,iw,t),be(Tv,Tv);const f=1.1*_e(iw,Tv)*this.unitInMeters,g=Math.sqrt(o*(o+2*this._referenceEllipsoid.radius)),y=Math.max(r.xmax-r.xmin,r.ymax-r.ymin),v=y*Urt*this.unitInMeters,b=y*krt*this.unitInMeters;let w=Be((o-b)/(v-b),0,1);w*=w*w;let S=qt(g,f,w);return S*=Math.max(Math.log(Math.abs(l)),1),S=Math.min(S,Math.max(34064e4,p)),S/=this.unitInMeters,l1e(S,Nrt,this.unitInMeters,n)}}class Lrt{constructor(t){this._referenceEllipsoid=di(t)}compute(t,i,r,s,n){n||(n={near:0,far:0});const o=Pe(t)-this._referenceEllipsoid.radius,a=this._referenceEllipsoid.radius+Math.min(0,s),l=Math.abs(o-s),c=Math.max(l,Math.abs(o));return l1e(1.2*Math.sqrt(c*(c+2*a)),Be(2e4-(Math.log(c)-7.983)/9.011*19e3,1e3,2e4),1,n)}}function l1e(e,t,i,r){const s=Frt/i;return e/t>s?(r.far=e,r.near=r.far/t):(r.near=s,r.far=r.near*t),r}const Nrt=2e4,Frt=2,Urt=.001,krt=1e-4,iw=M(),Tv=M();let M$=class extends we{constructor(e){super(e),this.handles=new Ut}initialize(){this.handles.add(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;aye(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>{i2(this.view,e,Ru.EYE_AND_CENTER)})}};u([d({constructOnly:!0})],M$.prototype,"view",void 0),M$=u([P("esri.views.3d.state.ElevationCollisionConstraint")],M$);const zrt=M$;let EA=class extends we{constructor(e){super(e),this._handles=new Ut,this.nearFarHeuristic=$rt(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this._handles.add([this.view.watch(["constraints.clipDistance.near","constraints.clipDistance.far"],()=>this._clipDistanceNearFarChanged()),this.view.watch("constraints.clipDistance.mode",()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",e=>this._updateCameraNearFar(e.camera)),this.view.watch("renderDataExtent",()=>this._updateNearFar(),!0),this.view.watch(["constraints.altitude.min","constraints.altitude.max"],()=>this._updateAltitude(),!0),this.view.watch("constraints.tilt.max",()=>this._updateTiltMax(),!0),this.view.watch("constraints.tilt.mode",()=>this._updateTilt(),!0),this.view.watch("state.camera",()=>this._updateTiltAutoMax(),!0),this.view.watch(["map.ground.navigationConstraint.type","constraints.collision.enabled"],()=>this._updateCollision(),!0)]),this.view.state.isLocal&&this._handles.add(Wt(this.view,"renderDataExtent",e=>this._updateLocalSurfaceDistance(e))),this._updateNearFar(),this.view.state.viewingMode!==Ie.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new zrt({view:this.view}))}destroy(){this._handles=rt(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var e;const t=(e=this.view.constraints)==null?void 0:e.clipDistance;t&&t.mode!=="auto"&&this.view.state.updateCamera(i=>(this._updateCameraNearFarManual(i,t),!0))}_updateNearFar(){this.view.state.updateCamera(e=>(this._updateCameraNearFar(e),!0))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;(t?t.mode:"auto")==="manual"?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,JF(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,t){t&&(e.near=t.near,e.far=t.far)}_updateCollision(){var e,t,i;const r=(e=this.view.map)==null||(t=e.ground)==null||(i=t.navigationConstraint)==null?void 0:i.type,s=!r||r==="stay-above",n=this.view.state.constraints.collision;if(s!==n.enabled){n.enabled=s,s&&this._reapplyConstraints(Yi.COLLISION);const o=this.view.constraints&&this.view.constraints.tilt;o&&o.mode!=="auto"||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==Ie.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&e.mode!=="auto"&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;(e?e.mode:"auto")==="manual"?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(Rt(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||e.mode!=="auto")return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(yl(i))}}_updateLocalSurfaceDistance(e){if(R(e))return;let t=Math.max(e.width,e.height);if(t<=0)return;e.hasZ&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=Yi.ALL){this.view.state.updateCamera(t=>Fr(this.view,t,{selection:e,interactionType:Mt.NONE,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:en.TUMBLE}))}};u([d({constructOnly:!0})],EA.prototype,"view",void 0),u([d({readOnly:!0})],EA.prototype,"surfaceCollisionConstraint",void 0),EA=u([P("esri.views.3d.state.ConstraintsManager")],EA);const Brt=EA;let Gx=class extends Q_{constructor(e){super(e),this.handles=new Ut}set desiredCamera(e){this._set("desiredCamera",e.clone())}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=cr.Running,this.handles.add(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this.handles.removeAll()}stepController(){}_handleElevationChangeEvent(e){aye(this.view,this.desiredCamera,e.extent,e.spatialReference)&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),i2(this.view,e,Ru.EYE_AND_CENTER)||this.constraintEnabled||(this.state=cr.Stopped)})}};u([d({constructOnly:!0})],Gx.prototype,"view",void 0),u([d({constructOnly:!0})],Gx.prototype,"desiredCamera",null),Gx=u([P("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],Gx);const Vrt=.66;function c1e(e){return 360-D7.normalize(e)}function G4(e){return D7.normalize(360-e)}function lP(e){return _(e)&&e.resolver&&e.resolver.reject(),null}function Grt(e,t){return _(e)&&e.resolver&&e.resolver.resolve(t),t}function ZW(e,t,i,r=null){if(!t)return lP(r);const s=e.spatialReference||He.WGS84;if(_(t.camera)){const c=sb(t.camera.position,s);if(R(c))return lP(r);const h=t.camera.clone();return h.position=c,Grt(r,h)}if(R(t.targetGeometry))return lP(r);const n=t.get("targetGeometry.spatialReference");if(n&&!pm(n,s))return lP(r);const o=wS(e,e.state.camera);let a=jn.ADJUST;if(t.rotation!=null&&(o.heading=c1e(t.rotation),a=jn.LOCKED),i!=null&&(o.tilt=i),t.targetGeometry.type==="point"){const c=t.targetGeometry;let h;const p=t.targetGeometry.clone();return h=t.scale!=null?iW(e,t.scale,c.latitude):e.state.camera.distance,Zye(e,p,h,o,a,r)}const l=t.targetGeometry.extent;return dC(e,l,o.heading,o.tilt,a,r)}function jrt(e,t,i=null){return R(i)&&(i=new xl),KW(e,null,t.clone(),i)}async function Hrt(e,t,i){const r=tst(e,t);if(!r)throw new q("viewpointutils-create:no-target","Missing target for creating viewpoint");const s=new _l({fov:e.camera.fov}),n=new xl({camera:s});if(r.target instanceof xl)return Sv(await Xrt(e,r.target,r,i,n));if(r.target instanceof _l)return Sv(h1e(e,r.target,n));const o=r.scale!=null||r.zoom!=null;if(r.target instanceof Xt){const c=r.target.xmin===r.target.xmax||r.target.ymin===r.target.ymax;return Sv(o||c?await fG(e,r,r.target.center,s,i,n):await Jrt(e,r,r.target,s,i,n))}const a={boundingBox:ki(),hasZ:!1,screenSpaceObjects:[]},l=o?qrt(e,r):void 0;if(await u1e(e,r.target,l,a),isFinite(a.boundingBox[0])){let c;if(Fh(a.boundingBox,Nr),Jl.x=Nr[0],Jl.y=Nr[1],Jl.z=Nr[2],Jl.spatialReference=e.spatialReference,isFinite(Jl.z)&&a.hasZ?c=jN(a.boundingBox):(Jl.z=void 0,c=WEe(ij(a.boundingBox,rst))),o||c)return Sv(await fG(e,r,Jl,s,i,n));const h=ist(e,a.screenSpaceObjects);return Sv(await est(e,r,Jl,a.boundingBox,h,s,i,n))}return r.position?Sv(Zrt(e,r,s,n)):Sv(await Qrt(e,r,s,i,n))}function QW(e,t){return t.scale==null&&t.zoom!=null?Kye(e,t.zoom):t.scale}function qrt(e,t){return OHe(e,QW(e,t))}function JW(e,t){let i=!1;return t.heading!=null?(e.heading=t.heading,i=!0):t.rotation!=null&&(e.heading=c1e(t.rotation),i=!0),t.tilt!=null&&(e.tilt=t.tilt,i=!0),t.fov!=null&&(e.fov=t.fov),i}function KW(e,t,i,r){const s=e.spatialReference||He.WGS84;return t=_(t)?t:Xf(e,i),R(t)||(r.targetGeometry=_0(t.center,e.renderSpatialReference,s),r.scale=e0e(e,t),r.rotation=G4(i.heading),r.camera=i),r}function iN(e,t,i){if(!t)return;if(!pm(t.spatialReference,e.spatialReference))throw new q("viewpointutils:incompatible-spatialreference",`Spatial reference (${t.spatialReference?t.spatialReference.wkid:"unknown"}) is incompatible with the view (${e.spatialReference.wkid})`,{geometry:t});const r=[];if(!t.hasZ&&e.basemapTerrain){let o;switch(t.type){case"point":o=t;break;case"multipoint":case"polyline":o=t.extent.center;break;case"mesh":o=t.origin;break;case"extent":o=t.center;break;case"polygon":o=t.centroid}o&&pm(o,e.basemapTerrain.spatialReference)?Nr[2]=gt(Vh(e.elevationProvider,o),0):Nr[2]=0}(0,sst[t.type])(t,o=>{r.push(o[0],o[1],o[2])},Nr);const s=r.length/3;if(s===0)return;const n=new Array(r.length);if(br(r,t.spatialReference,0,n,e.spatialReference,0,s)){t.hasZ&&(i.hasZ=!0);for(let o=0;o<n.length;o+=3)t.hasZ?(Nr[0]=n[o+0],Nr[1]=n[o+1],Nr[2]=n[o+2]):(Nr[0]=n[o+0],Nr[1]=n[o+1]),Tp(i.boundingBox,Nr)}}async function Wrt(e,t,i,r){const s=await wl(e.whenViewForGraphic(t));if(s.ok===!1||R(s.value)||!("whenGraphicBounds"in s.value))return void iN(e,t.geometry,r);const n=s.value,o=await wl(n.whenGraphicBounds(t,{minDemResolution:i}));if(o.ok===!1)return void iN(e,t.geometry,r);const{screenSpaceObjects:a,boundingBox:l}=o.value;FT(r.boundingBox,l),a&&a.forEach(c=>{r.screenSpaceObjects.push(c)}),isFinite(l[2])&&(r.hasZ=!0)}async function u1e(e,t,i,r){if(Array.isArray(t)&&t.length===2){const s=t[0],n=t[1];if(typeof s=="number"&&typeof n=="number")return Jl.x=s,Jl.y=n,Jl.z=void 0,Jl.spatialReference=e.spatialReference.isGeographic?e.spatialReference:He.WGS84,void iN(e,Jl,r)}t&&typeof t.map=="function"?await Ks(t.map(s=>u1e(e,s,i,r))):t instanceof vl?iN(e,t,r):t instanceof qo&&await Wrt(e,t,i,r)}async function Xrt(e,t,i,r,s){if(_(t.camera))return h1e(e,t.camera,s);s.scale=t.scale,s.rotation=t.rotation,s.targetGeometry=_(t.targetGeometry)?t.targetGeometry.clone():null,s.camera=null,i.heading!=null?s.rotation=G4(i.heading):i.rotation!=null&&(s.rotation=i.rotation);const n=QW(e,i);n!=null&&(s.scale=n);const o=new n2(r);return ZW(e,s,i.tilt,o),s.camera=await o.resolver.promise,s}function h1e(e,t,i){const r=e.spatialReference,s=sb(t.position,r);return R(s)?null:((t=t.clone()).fov=e.camera.fov,t.position=s,KW(e,null,t,i))}function Yrt(e,t,i,r,s,n){const o=e.renderSpatialReference;return tn(i.position,uP,o),tn(t,mz,o),n.targetGeometry=new et(t),s.position=new et(i.position),de(rN,mz,uP),t4(e,uP,rN,r.up,s),n.scale=X1(e,xi(uP,mz),n.targetGeometry.latitude),n.rotation=G4(s.heading),n.camera=s,n}async function fG(e,t,i,r,s,n){if(R(i))throw new q("createfromcenter","invalid point");n.targetGeometry=i.clone();const o=bb(e);if(t.position)return Yrt(e,n.targetGeometry,t,o,r,n);if(t.zoomFactor){const l=o.distance/t.zoomFactor,c=ae(Nr,o.viewForward,-l);o.eye=pe(Nr,o.center,c),n.scale=X1(e,l,i.latitude)}wS(e,o,r);const a=JW(r,t)?jn.LOCKED:jn.ADJUST;if(!t.zoomFactor){n.scale=QW(e,t),n.scale==null&&(tn(i,Nr,e.renderSpatialReference),bye(o.frustum,Nr)?n.scale=X1(e,xi(o.eye,Nr),i.latitude):n.scale=e0e(e,o));const l=new n2(s);Yye(e,n.targetGeometry,n.scale,r,a,l),n.camera=await l.resolver.promise}return n}function Zrt(e,t,i,r){const s=bb(e);return ne(rN,s.viewForward),t4(e,s.eye,rN,s.up,gz),i.position=new et(t.position),i.heading=t.heading!=null?t.heading:gz.heading,i.tilt=t.tilt!=null?t.tilt:gz.tilt,KW(e,null,i,r)}async function Qrt(e,t,i,r,s){const n=bb(e);return fG(e,t,_0(n.center,e.renderSpatialReference,e.spatialReference),i,r,s)}async function Jrt(e,t,i,r,s,n){n.targetGeometry=i.clone();const o=bb(e);wS(e,o,r);const a=JW(r,t)?jn.LOCKED:jn.ADJUST,l=new n2(s);return dC(e,i,r.heading,r.tilt,a,l),n.camera=await l.resolver.promise,n}function Krt(e,t,i,r,s){let n=0;i.hasZ?n=i.z:e.basemapTerrain&&(n=Vh(e.elevationProvider,i)),oe(Nr,i.x,i.y,n),Kh(e.spatialReference,Nr,Mre,e.renderSpatialReference),Lu(cP,Mre),Nu(cP,cP),ki(sE);const o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let y=0;y<o.length;y++){const v=o[y];let b=r[v[2]];isFinite(b)||(b=n),oe(Nr,r[v[0]],r[v[1]],b),wn(Nr,e.spatialReference,Nr,e.renderSpatialReference),Tp(sE,al(Nr,Nr,cP))}const a=DS(sE),l=lb(sE),c=LS(sE),h=1/Math.tan(t.fovX/2),p=1/Math.tan(t.fovY/2),f=.5*Math.sqrt(a*a+c*c)*Math.max(p,h)+.5*l,g=.5*l*p+.5*Math.max(a,c);return Math.max(f,g)/s}async function est(e,t,i,r,s,n,o,a){a.targetGeometry=i.clone();const l=bb(e),c=Krt(e,l,i,r,s);wS(e,l,n);const h=JW(n,t)?jn.LOCKED:jn.ADJUST;a.scale=X1(e,c,a.targetGeometry.latitude);const p=new n2(o);return Yye(e,a.targetGeometry,a.scale,n,h,p),a.camera=await p.resolver.promise,a}function tst(e,t){if(!t||!e.spatialReference)return null;const i={target:null};if("declaredClass"in t||Array.isArray(t))i.target=t;else{for(const r in t)i[r]=t[r];t.center&&!i.target&&(i.target=t.center)}return i}function Sv(e){return e&&_(e.camera)&&(e.rotation=G4(e.camera.heading)),e}function ist(e,t){const i=Vrt;if(!t.length)return i;let r=Number.NEGATIVE_INFINITY;for(let s=0;s<t.length;s++){const n=t[s].screenSpaceBoundingRect;r=Math.max(r,Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2]),Math.abs(n[3]))}return i-r/Math.min(e.width,e.height)*2}const Nr=M(),Mre=Te(),cP=wr(),sE=cs(),rst=Dt(),rN=M(),uP=M(),mz=M(),gz={heading:0,tilt:0},Jl=new et,sst={point(e,t,i){i[0]=e.x,i[1]=e.y,e.hasZ&&(i[2]=e.z),t(i)},polygon(e,t,i){const r=e.hasZ;for(let s=0;s<e.rings.length;s++){const n=e.rings[s];for(let o=0;o<n.length;o++)i[0]=n[o][0],i[1]=n[o][1],r&&(i[2]=n[o][2]),t(i)}},polyline(e,t,i){const r=e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s];for(let o=0;o<n.length;o++)i[0]=n[o][0],i[1]=n[o][1],r&&(i[2]=n[o][2]),t(i)}},multipoint(e,t,i){const r=e.points,s=e.hasZ;for(let n=0;n<r.length;n++)i[0]=r[n][0],i[1]=r[n][1],s&&(i[2]=r[n][2]),t(i)},extent(e,t,i){e.hasZ?(t(oe(i,e.xmin,e.ymin,e.zmin)),t(oe(i,e.xmax,e.ymin,e.zmin)),t(oe(i,e.xmin,e.ymax,e.zmin)),t(oe(i,e.xmax,e.ymax,e.zmin)),t(oe(i,e.xmin,e.ymin,e.zmax)),t(oe(i,e.xmax,e.ymin,e.zmax)),t(oe(i,e.xmin,e.ymax,e.zmax)),t(oe(i,e.xmax,e.ymax,e.zmax))):(t(oe(i,e.xmin,e.ymin,i[2])),t(oe(i,e.xmax,e.ymin,i[2])),t(oe(i,e.xmin,e.ymax,i[2])),t(oe(i,e.xmax,e.ymax,i[2])))},mesh(e,t,i){const r=e.vertexAttributes&&e.vertexAttributes.position;if(r)for(let s=0;s<r.length;s+=3)t(oe(i,r[s+0],r[s+1],r[s+2]))}};class nst{constructor(t,i,r){this.target=t,this.options=i,this.view=r,this.state="pending",this.abortController=null,this.animationController=null,this.promise=new Promise((s,n)=>{this.resolveCallback=s,this.rejectCallback=n;const o=new AbortController;_(this.options.signal)&&go(this.options.signal,()=>{this.abort()}),this.abortController=o,this.waitForReady()})}then(t,i){return this.promise.then(t,i)}catch(t){return this.promise.catch(t)}resolve(t){return this.state="finished",this.resolveCallback(t)}reject(t){return this.state="finished",this.rejectCallback(t)}abort(t=!1){switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":this.reject(pi());break;case"wait-for-animation-finish":!t&&_(this.animationController)&&this.view.state.cameraController===this.animationController&&this.animationController.active&&this.animationController.stopController(),this.reject(pi())}}waitForReady(){this.state="wait-for-ready",this.view.ready?this.createViewPoint():Nhe(this.view,"ready",this.abortController.signal).then(()=>{this.createViewPoint()},t=>{this.reject(t)})}createViewPoint(){this.state!=="finished"&&(this.state="wait-for-viewpoint",this.animationController=this.options.animate?this._getAnimationController():null,Hrt(this.view,this.target,this.abortController.signal).then(t=>{if(this.state==="finished")return;const i=this._getCameraFromViewpoint(t);if(!R(i))if(this.options.animate){if(R(this.animationController))return;this.startAnimation(i,this.animationController)}else this.view.stateManager.setStateCamera(i.camera,{applyConstraints:!i.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()},t=>{this.reject(t)}))}_getCameraFromViewpoint(t){const i=!!(this.target instanceof xl&&this.target.camera||this.target instanceof _l),r=t.camera;if(R(r))return null;if(!this.view.stateManager.isCompatible(r)){const n=r.position,o=n&&n.spatialReference,a=o?o.wkid:"none",l=this.view.spatialReference.wkid;return this.reject(new q("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${a}, view: ${l})`,{camera:r})),null}const s=Xf(this.view,r);return R(s)?(this.reject(new q("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:t,camera:s,isFullySpecified:i}}startAnimation(t,i){this.state="wait-for-animation-finish";const r=i.viewAnimation;if(R(r))return void this.reject(new q("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(r.update(t.viewpoint,"running"),!i.active||R(i.viewAnimation)||i.viewAnimation.target!==t.viewpoint||this.view.state.cameraController!==i)return this.abort();let s;t.isFullySpecified?(s=new Gx({view:this.view,desiredCamera:t.camera}),i2(this.view,t.camera,Ru.EYE_AND_CENTER)):Fr(this.view,t.camera),i.begin(t.camera,this.options);const n=()=>{const a=this.view.state.cameraController;s&&(a&&a.active?a instanceof um&&_(a.viewAnimation)&&a.viewAnimation.target===t.viewpoint&&(this.view.state.cameraController=s):_(i.viewAnimation)&&i.viewAnimation.target===t.viewpoint&&i.state==="finished"&&(this.view.state.cameraController=s))},o=a=>{if(!R(this.view.state))switch(i.state){case cr.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case cr.Ready:case cr.Rejected:case cr.Running:case cr.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(a)}}};r.when(n,a=>o(a)),i.asyncResult={resolve:()=>o(),reject:a=>o(a)}}_getAnimationController(){let t,i=null;const r=this.view.state.cameraController;return r instanceof um&&(r.updateStateFromViewAnimation(),r.active&&(t=r,i=t.viewAnimation)),t!=null||(t=new um({view:this.view,mode:"animation"}),i=t.viewAnimation,this.view.state.switchCameraController(t))?t:(_(i)&&i.stop(),this.reject(new q("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}const zc=he.getLogger("esri.views.3d.state.ViewStateManager");let so=class extends we{constructor(e){super(e),this.propertiesPool=new N0({frustum:$y},this),this.handles=new Ut,this.cameraSetByUser=!1,this.gotoOperation=null,this.ready=!1,this.updateDevicePixelRatio=null,this.test={contentCameraResetState:new Map}}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=wS(this.view,this.view.state.camera);return t&&e&&t.equals(e)?e:t}set camera(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider.enableElevationCache(!0),this.setStateCamera(Xf(this.view,e),{applyConstraints:!1})||zc.error("#camera=","Invalid camera",e),this.view.elevationProvider.enableElevationCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=wS(this.view,this.view.state.contentCamera);return t&&e&&t.equals(e)?e:t}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=Xf(this.view,e);R(t)?this.view.state.contentCamera=null:(this._updateElevation(t),this.view.state.contentCamera=t)}installContentCameraReset(e){if(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=da(this.view.state.camera.center),s=e.sticky?this.contentCamera.clone():null;return this.handles.add([this.watch("contentCamera",()=>{e.sticky||(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear())}),this.watch("zoom",n=>{this.test.contentCameraResetState.set("view.zoom",Math.abs(n-t)/2),Math.abs(n-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)}),this.view.state.watch("camera",n=>{const o=qn(r,n.center);this.test.contentCameraResetState.set("camera.center",o/i),o>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)})],"contentCameraReset"),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():zc.error("#center=","Invalid center",e):zc.error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):zc.error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=SHe(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return _(t)?t:this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||zc.error("#extent=","Invalid extent",e):zc.error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):zc.error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this.propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return X1(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||zc.error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),s=Math.round(t[bt.TOP]/i),n=Math.round(t[bt.RIGHT]/i),o=Math.round(t[bt.BOTTOM]/i),a=Math.round(t[bt.LEFT]/i);return r!=null&&r.top===s&&r.right===n&&r.bottom===o&&r.left===a?r:{top:s,right:n,bottom:o,left:a}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,hP),this.view.state.updateCamera(t=>t.padding=hP))}_paddingToArray(e,t,i){e?Ho(i,e.top||0,e.right||0,e.bottom||0,e.left||0):Ho(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*t)}get screenCenter(){const e=this.padding;return Jh((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?jrt(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||zc.error("#viewpoint=","Invalid viewpoint",e);else{const t=_(e.camera)?e.camera.position:e.targetGeometry,i=_(t)&&t.spatialReference;zc.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e)}else zc.error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?Jye(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||zc.error("#zoom=","Invalid zoom",e)}initialize(){this.handles.add([Rp(this.view,"state.events","before-camera-change",e=>this._updateElevation(e.camera))]),LPe(this.view.state,"camera",e=>this._updateElevation(e),!0),this.handles.add(_1({prepare:()=>this._prepareFrame()})),this.handles.add(this.view.state.watch("cameraController",()=>{this.cameraSetByUser=!0,this.handles.remove(dP)})),this.handles.add(Rp(this.view,"state.events","camera-projection-changed",()=>this.notifyChange("scale")))}destroy(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)}init(){this.constraintsManager=new Brt({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this.cameraSetByUser){const t=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;t&&this.isCompatible(t)?this._setInitialView(t):this.view.state.viewingMode===Ie.Local&&this.handles.add(Nhe(this.view.basemapTerrain,"ready",()=>{this.handles.remove(dP),this._setInitialView(this.view.dataExtent)}),dP)}}deinit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.cameraSetByUser=!1,this.handles.remove(dP),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))}async goTo(e,t){const i=I({animate:!0},t);return _(this.gotoOperation)&&this.gotoOperation.abort(i.animate),this.gotoOperation=new nst(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this.gotoOperation}debugSetCameraOnContent(){this.setStateCamera(bb(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t&&this.view.state.cameraController;i&&(t.updateCamera(r=>{i.stepController(e,r)}),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){_(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of lst){const s=e.has(i),n=this._isOverridden(i);!s&&n&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(s||n)&&r.forEach(o=>e.add(o))}return t}_setInitialView(e){if(R(e)||this.cameraSetByUser)return;if(e instanceof _l)return void this.setStateCamera(Xf(this.view,e),{applyConstraints:!1});if(e instanceof xl){if(e.targetGeometry instanceof Xt){const s=dC(this.view,e.targetGeometry,0,.5,jn.LOCKED);return void(_(s)&&this.setStateCamera(Xf(this.view,s),{applyConstraints:!0}))}const i={applyConstraints:!e.camera},r=this._viewpointToCamera(e);return void this.setStateCamera(r,i)}const t=dC(this.view,e,0,.5,jn.LOCKED);_(t)&&this.setStateCamera(Xf(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&ast.indexOf(e)!==-1&&this._override("hasInitialView",!0),!0)}isCompatible(e){return!R(e)&&(e instanceof xl?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof _l?this.isCompatible(e.position):e.spatialReference&&pm(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=cst){return this.cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,i=Cg){const{heading:r,tilt:s}=this._getPreservingHeadingTilt(),n=OR(this.view,r,s,e,t,jn.ADJUST);return R(n)?null:(i.copyFrom(this.view.state.camera),i.eye=n.eye,i.center=n.center,i.up=n.up,i)}_centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this._centerPointAtDistanceToCamera(e,i)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),r=dC(this.view,e,t,i,jn.ADJUST,ust);return _(r)?Xf(this.view,r):null}_scaleToCamera(e){if(e==null)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,r=t.location.latitude,s=iW(this.view,e,r);return this._centerPointAtDistanceToCamera(i,s)}_zoomToCamera(e){return this._scaleToCamera(Kye(this.view,e))}_viewpointToCamera(e){return Xf(this.view,ZW(this.view,e))}setStateCamera(e,t){return!(R(e)||!this.view.state.stopActiveCameraController())&&(this.cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&Fr(this.view,i)}),t.applyConstraints||(this.view.state.cameraController=new Gx({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{container:e,canvas:t}=this.view;if(!e||!t)return;_(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();const i=this.view.pixelRatio,r=Math.round(e.clientWidth*i),s=Math.round(e.clientHeight*i);if(r!==0&&s!==0&&(t.width===r&&t.height===s||(t.width=r,t.height=s),this.view.state)){const n=this.view.state.camera;n.fullWidth===r&&n.fullHeight===s&&n.pixelRatio===i||(Cg.copyFrom(n),Cg.pixelRatio!==i&&(this._paddingToArray(this.padding,i,hP),Cg.padding=hP),Cg.fullWidth=r,Cg.fullHeight=s,Cg.pixelRatio=i,this.view.state.camera=Cg)}}_updateElevation(e){const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(e.eye),r=t?JF(this.view,e.eye):0;e.relativeElevation=i-r}};u([d({type:_l,dependsOn:["view.state.camera","ready"]})],so.prototype,"camera",null),u([d({type:_l,dependsOn:["view.state.contentCamera","ready"]})],so.prototype,"contentCamera",null),u([d({type:et})],so.prototype,"center",null),u([d({type:Xt})],so.prototype,"extent",null),u([d({readOnly:!0})],so.prototype,"frustum",null),u([d({readOnly:!0})],so.prototype,"hasInitialView",null),u([d({readOnly:!0,type:Boolean})],so.prototype,"ready",void 0),u([d({type:Number})],so.prototype,"scale",null),u([d()],so.prototype,"padding",null),u([d({readOnly:!0})],so.prototype,"screenCenter",null),u([d({constructOnly:!0})],so.prototype,"view",void 0),u([d({type:xl})],so.prototype,"viewpoint",null),u([d({type:Number})],so.prototype,"zoom",null),u([d({constructOnly:!0})],so.prototype,"updateDevicePixelRatio",void 0),so=u([P("esri.views.3d.state.ViewStateManager")],so);const ost=so,ast=["camera","viewpoint","extent","scale","center","zoom"],lst=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],cst={heading:0,tilt:0},ust=new _l,Cg=new wi,hP=ni(),dP="pending-initial-view";class hst{constructor(t,i,r){this.viewingMode=t,this._forEachLayer=i,this.view=r,this.externalIntersectionHandlers=new $t,this.tolerance=_S,this.tmpRay=Vn(),this.validateHUDIntersector=ku(this.viewingMode),this.validateHUDIntersector.options.hud=!1}intersectScreen(t,i){return this.intersectRay(this._getPickRay(t,this.tmpRay),Pre(this.viewingMode),i)}intersectScreenFreePointFallback(t,i){return this.intersectRayFreePointFallback(this._getPickRay(t,this.tmpRay),i)}intersectRayFreePointFallback(t,i){return this.intersectRay(t,Pre(this.viewingMode),i)||this._intersectRayFreePointLocal(t,i)}intersectRay(t,i,r,s){return i.options.selectionMode=!1,i.options.store=Wn.MIN,this.computeIntersection(t,i,s),!!i.results.min&&i.results.min.getIntersectionPoint(r)}getCenterRayWithSubpixelOffset(t,i,r=.5,s=.5){return t.getRenderCenter(mP,r,s),mP[0]+=.0466,mP[1]-=.0123,Yq(t,mP,i)}intersectIntersectorScreen(t,i,r){this.computeIntersection(this._getPickRay(t,this.tmpRay),i,r)}intersectToolIntersectorScreen(t,i,r){const s=this._getPickRay(t,this.tmpRay);this.intersectToolIntersectorRay(s,i,r)}intersectToolIntersectorRay(t,i,r){i.options.selectionMode=!0,this.computeIntersection(t,i,r);const s=i.results.min;!!this.view.basemapTerrain&&this.view.basemapTerrain.opaque||jp(s)&&s.intersector!==ur.TERRAIN||(i.options.selectionMode=!1,this.computeIntersection(t,i,r))}setTolerance(t=_S){this.tolerance=t}addIntersectionHandler(t){this.externalIntersectionHandlers.push(t),this.externalIntersectionHandlers.sort((i,r)=>i.type===ur.TERRAIN?1:r.type===ur.TERRAIN?-1:0)}removeIntersectionHandler(t){this.externalIntersectionHandlers.removeUnordered(t),this.externalIntersectionHandlers.sort((i,r)=>i.type===ur.TERRAIN?1:r.type===ur.TERRAIN?-1:0)}_getPickRay(t,i){const r=this.view.state.camera;return Tye(r,t,i)}_intersectRayFreePointLocal(t,i){if(this.viewingMode!==Ie.Local||R(t))return!1;const r=this.view.renderDataExtent;if(R(r))return pe(i,t.origin,be(Ne.get(),t.direction)),!0;const s={x:r.xmax-r.xmin,y:r.ymax-r.ymin,z:8*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},n=Math.max(s.x,s.y,s.z);if(n===0)return pe(i,t.origin,be(Ne.get(),t.direction)),!0;const o=this.view.state.camera,a=Math.max(0,r.xmin-o.eye[0],o.eye[0]-r.xmax),l=Math.max(0,r.ymin-o.eye[1],o.eye[1]-r.ymax),c=Math.sqrt(a*a+l*l),h=Math.abs(o.relativeElevation)+Number.MIN_VALUE,p=Math.max(0,Math.log(n/h))**2;let f=n/Math.max(1,p);f=Math.max(f,Math.min(c,n));const g=ae(Ne.get(),t.direction,f/Pe(t.direction));return pe(i,t.origin,g),!0}intersectElevationFromScreen(t,i,r=0,s=null){return this._intersectElevation(this._getPickRay(t,this.tmpRay),i,r,s)}_intersectElevation(t,i,r=0,s=null){if(R(t))return null;const n=_(i)?i.mode:"absolute-height",o=_(i)?gt(i.offset,0):0,a=n!=="on-the-ground"?o+r:0,l=a/this.view.renderCoordsHelper.unitInMeters;if(n==="absolute-height"){if(this.view.renderCoordsHelper.intersectInfiniteManifold(t,a,fP)){const S=this.view.computeMapPointFromVec3d(fP);return S.z-=o,S}return null}const c=this.view.state.camera,h=Ne.get();c.projectToRenderScreen(t.origin,h);const p=new Ire(null,this._forEachLayer),f=this.view.slicePlane,g=_(f)?zee(f):null,y=ku(this.viewingMode);y.options.store=Wn.MIN,y.options.verticalOffset=l;const v=t.origin,b=pe(Ne.get(),v,t.direction);y.reset(v,b,c),y.point=h;const w=_(s)?"type"in s&&s.type==="graphics"?S=>S.metadata.layerUid!==s.uid:S=>S.metadata.graphicUid!==s.uid:null;switch(n){case"relative-to-scene":{const S=T=>(R(w)||w(T))&&T.metadata&&T.metadata.isElevationSource;y.intersect(p.layers,h,this.tolerance,null,S),this.externalIntersectionHandlers.forAll(T=>{if(T.type===ur.I3S||T.type===ur.TERRAIN){const A=T.slicePlaneEnabled?g:null;T.intersect(y,A,y.rayBegin,y.rayEnd,h)}})}break;case"on-the-ground":case"relative-to-ground":this.externalIntersectionHandlers.forAll(S=>{if(S.isGround){const T=S.slicePlaneEnabled?g:null;S.intersect(y,T,y.rayBegin,y.rayEnd,h)}})}if(y.results.min.getIntersectionPoint(fP)){const S=this.view.computeMapPointFromVec3d(fP);return S.z=r,S}return null}computeIntersection(t,i,r){if(R(t))return;const s=this.view.state.camera,n=Ne.get();s.projectToRenderScreen(t.origin,n);const o=new Ire(r,this._forEachLayer);i.options.selectOpaqueTerrainOnly=!r||!("include"in r||"exclude"in r);const a=t.origin,l=pe(Ne.get(),t.origin,t.direction);i.reset(a,l,s),i.intersect(o.layers,n,this.tolerance);const c=this.view.slicePlane,h=_(c)?zee(c):null;i.intersect(o.sliceableLayers,n,this.tolerance,h);const p=r&&(r.requiresGroundFeedback||r.enableDraped);this.externalIntersectionHandlers.forAll(y=>{if(i.options.isFiltered=!o.filterLayerUid(y.layerUid),y.isGround&&p||!i.options.isFiltered){const v=y.slicePlaneEnabled?h:null;y.intersect(i,v,a,l,n)}});const f=Ne.get();if(r&&r.enableDraped&&i.results.ground.getIntersectionPoint(f)){const y=this.view.basemapTerrain.overlayManager.renderer,v=this.view.renderCoordsHelper.spatialReference,b=Ne.get();this.view.renderCoordsHelper.fromRenderCoords(f,b,this.view.spatialReference),b[2]=gt(this.view.elevationProvider.getElevation(f[0],f[1],f[2],v,"ground"),0),y.intersect(i,b,i.results.ground,w=>o.filterRenderGeometry(w))}i.sortResults();const g=i.results.hud;if(Uq(g)){const y=Ne.get(),v=Ne.get(),b=Ne.get();this._unprojectHUDResultRay(g.target.center,y,v,b);const w=xi(g.target.center,v)/xi(v,b)*.99;this.validateHUDIntersector.reset(v,b,s),this.validateHUDIntersector.intersect(o.layers,y,this.tolerance),this.validateHUDIntersector.intersect(o.sliceableLayers,y,this.tolerance,h),this.externalIntersectionHandlers.forAll(T=>{if(!o.filterLayerUid(T.layerUid))return;const A=T.slicePlaneEnabled?h:null;T.intersect(this.validateHUDIntersector,A,v,b,y)});const S=this.validateHUDIntersector.results.min;(S.dist==null||w<=S.dist)&&(i.results.min.copy(g),i.results.all.splice(0,0,g))}}_unprojectHUDResultRay(t,i,r,s){const n=this.view.state.camera;n.projectToRenderScreen(t,i);const o=Ne.get();o[0]=i[0],o[1]=i[1],o[2]=0,n.unprojectFromRenderScreen(o,r),o[2]=1,n.unprojectFromRenderScreen(o,s)}}let pP;function Pre(e){return pP&&pP.viewingMode===e||(pP=ku(e)),pP}class Ire{constructor(t,i){this.layers=new Array,this.sliceableLayers=new Array,this.include=t==null?void 0:t.include,this.exclude=t==null?void 0:t.exclude,i(r=>{r.isPickable&&this.filterLayerUid(r.apiLayerUid)&&(r.isSliceable?this.sliceableLayers:this.layers).push(r)})}filterLayerUid(t){const{include:i,exclude:r}=this;return R(t)?i==null&&r==null:(i==null||i.has(t))&&(r==null||!r.has(t))}filterRenderGeometry(t){return this.filterLayerUid(t.layerUid)}}function $re(e){return typeof e=="object"&&"intersect"in e}const fP=M(),mP=zn();class Qyt{constructor(t,i){this.spatialReference=t,this.view=i}getElevation(t,i,r){return this.view.elevationProvider.getElevation(t,i,0,this.spatialReference,r)}async queryElevation(t,i,r,s,n){return this.view.elevationProvider.queryElevation(t,i,0,this.spatialReference,n,r,s)}}class dst{constructor(t,i,r,s){this.spatialReference=i,this._getElevationQueryProvider=r,this._queries=new Array,this._queryOptions=me(I({},s),{ignoreInvisibleLayers:!0}),this._frameTask=t.registerTask(ht.ELEVATION_QUERY,this)}destroy(){this._frameTask.remove()}queryElevation(t,i,r,s=0){return new Promise((n,o)=>{const a={x:t,y:i,minDemResolution:s,result:{resolve:n,reject:o},signal:r};this._queries.push(a),go(r,()=>{g7(this._queries,a),o(pi())})})}get running(){return this._queries.length>0}runTask(){const t=this._queries;this._queries=[];const i=this._getElevationQueryProvider();if(!i)return void t.forEach(c=>c.result.reject());const r=t.map(c=>[c.x,c.y]),s=t.reduce((c,h)=>Math.min(c,h.minDemResolution),1/0),n=new nb({points:r,spatialReference:this.spatialReference}),o=t.length>1&&t.some(c=>!!c.signal)?new AbortController:null,a=_(o)?o.signal:t[0].signal;if(_(o)){let c=0;t.forEach(h=>go(h.signal,()=>{c++,h.result.reject(pi()),c===t.length&&o.abort()}))}const l=me(I({},this._queryOptions),{minDemResolution:s,signal:a});i.queryElevation(n,l).then(c=>{t.forEach((h,p)=>{_(h.signal)&&h.signal.aborted?h.result.reject(pi()):h.result.resolve(c.geometry.points[p][2])})}).catch(c=>{t.forEach(h=>h.result.reject(c))})}get test(){const t=this;return{update:()=>t._queries.length>0&&t.runTask()}}}let AA=class extends xr.EventedMixin(we){constructor(e){super(e),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQuery=rt(this._elevationQuery)}get elevationQuery(){return R(this._elevationQuery)&&(this._elevationQuery=new dst(this.view.resourceController.scheduler,this.view.spatialReference,()=>this.view.map&&this.view.map.ground,{maximumAutoTileRequests:4})),this._elevationQuery}enableElevationCache(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}getElevation(e,t,i,r,s){if(this.elevationCacheEnabled&&this.lastElevationQuery!=null){const o=this.lastElevationQuery;if(e===o.x&&t===o.y&&i===o.z&&r.equals(o.spatialReference)&&s===o.queryContext)return o.result}let n=null;return n=gP(n,this.im,e,t,i,r,s),R(n)&&(n=gP(n,this.ground,e,t,i,r,s)),s==="scene"&&(n=gP(n,this.scene,e,t,i,r,s)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:r,queryContext:s,result:n}),n}queryElevation(e,t,i,r,s,n=null,o=0){const a=Sm();return this.elevationQuery.queryElevation(e,t,n,o).then(l=>{s==="scene"&&(l=gP(l,this.scene,e,t,i,r,s)),a.resolve(l)}).catch(l=>{pr(l)?a.reject(l):a.resolve(this.getElevation(e,t,i,r,s))}),a.promise}register(e,t){this.handles.set(t,t.on("elevation-change",i=>this.emit("elevation-change",i))),this[e].push(t)}unregister(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const t of[this.im,this.ground,this.scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}};function gP(e,t,i,r,s,n,o){for(const a of t){const l=a.getElevation(i,r,s,n,o);_(l)&&(e=_(e)?Math.max(l,e):l)}return e}u([d({constructOnly:!0})],AA.prototype,"view",void 0),u([d({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],AA.prototype,"spatialReference",void 0),AA=u([P("esri.views.3d.support.CombinedElevationProvider")],AA);class t0{static isValidProfile(t){return t in t0.profiles}static getDefaultProfile(){return ue("trident")||ue("esri-iPhone")?"low":"medium"}static apply(t,i){const r=t0.profiles[t];i.graphics3D.maxTotalNumberOfFeatures=r.graphics3D.maxTotalNumberOfFeatures,i.graphics3D.maxTotalNumberOfPrimitives=r.graphics3D.maxTotalNumberOfPrimitives,i.graphics3D.polygonLodFactor=r.graphics3D.polygonLodFactor,i.graphics3D.polylineLodFactor=r.graphics3D.polylineLodFactor,i.graphics3D.snapshotAvailable=r.graphics3D.snapshotAvailable;{const s=i.sceneService["3dObject"],n=r.sceneService["3dObject"];s.lodFactor=n.lodFactor,s.lodCrossfadeinDuration=n.lodCrossfadeinDuration,s.lodCrossfadeoutDuration=n.lodCrossfadeoutDuration,s.lodCrossfadeUncoveredDuration=n.lodCrossfadeUncoveredDuration}i.sceneService.point.lodFactor=r.sceneService.point.lodFactor,i.sceneService.integratedMesh.lodFactor=r.sceneService.integratedMesh.lodFactor,i.sceneService.pointCloud.lodFactor=r.sceneService.pointCloud.lodFactor,i.sceneService.uncompressedTextureDownsamplingEnabled=r.sceneService.uncompressedTextureDownsamplingEnabled,i.tiledSurface.lodBias=r.tiledSurface.lodBias,i.tiledSurface.angledSplitBias=r.tiledSurface.angledSplitBias,i.tiledSurface.reduceTileLevelDifferences=r.tiledSurface.reduceTileLevelDifferences,i.tiledSurface.textureFadeDuration=r.tiledSurface.textureFadeDuration,i.heatmap.pixelRatio=r.heatmap.pixelRatio,i.heatmap.maxTotalNumberOfFeatures=r.heatmap.maxTotalNumberOfFeatures,i.antialiasingEnabled=r.antialiasingEnabled,i.physicallyBasedRenderingEnabled=r.physicalBasedRenderingEnabled,i.highQualityTransparency=r.highQualityTransparency,i.memoryLimit=r.memoryLimit,i.additionalCacheMemory=r.additionalCacheMemory,i.frameRate=r.frameRate,i.maximumRenderResolution=r.maximumRenderResolution,i.maximumPixelRatio=r.maximumPixelRatio}}function Dre(){const e=!!ue("esri-mobile"),t=!!ue("ios");return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:25e3},sceneService:{"3dObject":{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:5e4},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!ue("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?600:750,additionalCacheMemory:e?0:150,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:5e4},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!ue("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?900:1500,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:e?null:4096,maximumPixelRatio:e?1:null}}}t0.debug={reset(){const e=Dre();for(const t in e)t0.profiles[t]=e[t]}},function(e){e.profiles=Dre()}(t0||(t0={}));const P$=t0;function eX(){return new Float32Array(4)}function pst(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function Ca(e,t,i,r){const s=new Float32Array(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function fst(e,t){return new Float32Array(e,t,4)}function d1e(){return eX()}function p1e(){return Ca(1,1,1,1)}function f1e(){return Ca(1,0,0,0)}function m1e(){return Ca(0,1,0,0)}function g1e(){return Ca(0,0,1,0)}function y1e(){return Ca(0,0,0,1)}const mst=d1e(),gst=p1e(),yst=f1e(),vst=m1e(),_st=g1e(),bst=y1e();Object.freeze({__proto__:null,create:eX,clone:pst,fromValues:Ca,createView:fst,zeros:d1e,ones:p1e,unitX:f1e,unitY:m1e,unitZ:g1e,unitW:y1e,ZEROS:mst,ONES:gst,UNIT_X:yst,UNIT_Y:vst,UNIT_Z:_st,UNIT_W:bst});let Hd=class extends we{constructor(){super(...arguments),this.color=new Je([0,255,255]),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=new Je([0,0,0]),this.shadowDifference=.2}static toEngineOptions(e){const t=Je.toUnitRGBA(e.color),i=_(e.haloColor)?Je.toUnitRGBA(e.haloColor):t,r=Je.toUnitRGBA(e.shadowColor);return{color:Ca(t[0],t[1],t[2],t[3]),haloColor:Ca(i[0],i[1],i[2],i[3]),haloOpacity:e.haloOpacity,haloOpacityOccluded:.25*e.haloOpacity,fillOpacity:e.fillOpacity,fillOpacityOccluded:.25*e.fillOpacity,shadowOpacity:e.shadowOpacity,shadowColor:Ca(r[0],r[1],r[2],r[3]),occludedShadowOpacity:e.shadowOpacity*(1-e.shadowDifference)}}};u([d({type:Je})],Hd.prototype,"color",void 0),u([d({type:Je})],Hd.prototype,"haloColor",void 0),u([d()],Hd.prototype,"haloOpacity",void 0),u([d()],Hd.prototype,"fillOpacity",void 0),u([d()],Hd.prototype,"shadowOpacity",void 0),u([d({type:Je})],Hd.prototype,"shadowColor",void 0),u([d()],Hd.prototype,"shadowDifference",void 0),Hd=u([P("esri.views.3d.support.HighlightOptions")],Hd);const mG=Hd;function Jyt(e){return{geometryType:F0(e[0]),geometries:e.map(t=>t.toJSON())}}function wst(e,t,i){const r=Jae(t);return e.map(s=>{const n=r.fromJSON(s);return n.spatialReference=i,n})}let g_=class extends fe{constructor(e){super(e),this.geometries=null,this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const e=this.geometries.map(function(r){return r.toJSON()}),t=this.geometries[0],i={};return i.outSR=this.outSpatialReference.wkid||JSON.stringify(this.outSpatialReference.toJSON()),i.inSR=t.spatialReference.wkid||JSON.stringify(t.spatialReference.toJSON()),i.geometries=JSON.stringify({geometryType:F0(t),geometries:e}),this.transformation&&(i.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),this.transformForward!=null&&(i.transformForward=this.transformForward),i}};u([d()],g_.prototype,"geometries",void 0),u([d({json:{read:{source:"outSR"}}})],g_.prototype,"outSpatialReference",void 0),u([d()],g_.prototype,"transformation",void 0),u([d()],g_.prototype,"transformForward",void 0),g_=u([P("esri.rest.support.ProjectParameters")],g_);const tX=g_,xst=Ir(tX);async function v1e(e,t,i){t=xst(t);const r=Oc(e),s=I(me(I({},r.query),{f:"json"}),t.toJSON()),n=t.outSpatialReference,o=F0(t.geometries[0]),a=rDe(s,i);return Ti(r.path+"/project",a).then(({data:{geometries:l}})=>wst(l,o,n))}async function iX(e=null,t){var i,r;if(Bi.geometryServiceUrl)return Bi.geometryServiceUrl;if(!e)throw new q("internal:geometry-service-url-not-configured");let s;s="portal"in e?e.portal||Bn.getDefault():e,await s.load({signal:t});const n=(i=s.helperServices)==null||(r=i.geometry)==null?void 0:r.url;if(!n)throw new q("internal:geometry-service-url-not-configured");return n}async function Tst(e,t,i=null,r){const s=await iX(i,r),n=new tX;n.geometries=[e],n.outSpatialReference=t;const o=await v1e(s,n,{signal:r});if(o&&Array.isArray(o)&&o.length===1)return o[0];throw new q("internal:geometry-service-projection-failed")}var Sst=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",getGeometryServiceURL:iX,projectGeometry:Tst});class Est{constructor(t,i){this.spatialReference=i,this.unitInMeters=Cl(this.spatialReference,di(this.spatialReference).metersPerDegree),this._geometryServiceURLPromise=iX(t&&t.get("portalItem")).catch(()=>{throw new q("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")})}async toGeographic(t){const i=await this._geometryServiceURLPromise;let r,s=!0;Array.isArray(t[0])&&typeof t[0]!="number"?r=t:(r=[t],s=!1);const n=r.map(l=>l instanceof et?l:new et(l,this.spatialReference)),o=new tX({geometries:n,outSpatialReference:He.WGS84}),a=(await v1e(i,o)).map(l=>l.type==="point"?[l.x,l.y]:void 0);return s?a:a[0]}}let Kd=class extends we{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1}};u([d()],Kd.prototype,"minTotalNumberOfFeatures",void 0),u([d()],Kd.prototype,"maxTotalNumberOfFeatures",void 0),u([d()],Kd.prototype,"maxTotalNumberOfPrimitives",void 0),u([d()],Kd.prototype,"snapshotAvailable",void 0),u([d()],Kd.prototype,"polygonLodFactor",void 0),u([d()],Kd.prototype,"polylineLodFactor",void 0),Kd=u([P("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Kd);let gp=class extends we{constructor(){super(...arguments),this.lodFactor=1}};u([d()],gp.prototype,"lodFactor",void 0),gp=u([P("esri.views.3d.support.QualitySettings.LoDFactorSettings")],gp);let sN=class extends gp{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0}};sN=u([P("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],sN);let Zf=class extends we{constructor(){super(...arguments),this["3dObject"]=new sN,this.point=new gp,this.integratedMesh=new gp,this.pointCloud=new gp,this.uncompressedTextureDownsamplingEnabled=!1}};u([d({type:sN})],Zf.prototype,"3dObject",void 0),u([d({type:gp})],Zf.prototype,"point",void 0),u([d({type:gp})],Zf.prototype,"integratedMesh",void 0),u([d({type:gp})],Zf.prototype,"pointCloud",void 0),u([d()],Zf.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Zf=u([P("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Zf);let Ay=class extends we{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=500}};u([d()],Ay.prototype,"lodBias",void 0),u([d()],Ay.prototype,"angledSplitBias",void 0),u([d()],Ay.prototype,"reduceTileLevelDifferences",void 0),u([d()],Ay.prototype,"textureFadeDuration",void 0),Ay=u([P("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],Ay);let jx=class extends we{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};u([d()],jx.prototype,"pixelRatio",void 0),u([d()],jx.prototype,"maxTotalNumberOfFeatures",void 0),jx=u([P("esri.views.3d.support.QualitySettings.HeatmapSettings")],jx);let na=class extends we{constructor(){super(...arguments),this.graphics3D=new Kd,this.sceneService=new Zf,this.tiledSurface=new Ay,this.heatmap=new jx,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0}};u([d({type:Kd})],na.prototype,"graphics3D",void 0),u([d({type:Zf})],na.prototype,"sceneService",void 0),u([d({type:Ay})],na.prototype,"tiledSurface",void 0),u([d({type:jx})],na.prototype,"heatmap",void 0),u([d()],na.prototype,"antialiasingEnabled",void 0),u([d()],na.prototype,"physicallyBasedRenderingEnabled",void 0),u([d()],na.prototype,"highQualityTransparency",void 0),u([d()],na.prototype,"memoryLimit",void 0),u([d()],na.prototype,"additionalCacheMemory",void 0),u([d()],na.prototype,"frameRate",void 0),u([d()],na.prototype,"maximumRenderResolution",void 0),u([d()],na.prototype,"maximumPixelRatio",void 0),na=u([P("esri.views.3d.support.QualitySettings.QualitySettings")],na);const Lre=na;class nN{constructor(t,i,r,s){this.viewingMode=t,this.spatialReference=i,this.unitInMeters=r,this.coordinateSystem=s,this._coordinateSystem=jMe(s)}set extent(t){t&&HMe(this.coordinateSystem,t,this.coordinateSystem)}getAltitude(t){return KMe(this.coordinateSystem,t)}setAltitude(t,i,r=t){return she(this.coordinateSystem,r,i,t)}setAltitudeOfTransformation(t,i){e3e(this.coordinateSystem,i,t,i)}worldUpAtPosition(t,i){return YMe(this.coordinateSystem,t,i)}worldBasisAtPosition(t,i,r){return ZMe(this.coordinateSystem,t,i,r)}basisMatrixAtPosition(t,i){const r=this.worldBasisAtPosition(t,mc.X,Ne.get()),s=this.worldBasisAtPosition(t,mc.Y,Ne.get()),n=this.worldBasisAtPosition(t,mc.Z,Ne.get());return kp(i,r[0],r[1],r[2],0,s[0],s[1],s[2],0,n[0],n[1],n[2],0,0,0,0,1),i}intersectManifoldClosestSilhouette(t,i,r){return z5(this.coordinateSystem,i,this._coordinateSystem),JMe(this._coordinateSystem,t,r),r}intersectManifold(t,i,r){z5(this.coordinateSystem,i,this._coordinateSystem);const s=Ne.get();return QMe(this._coordinateSystem,t,s)?ne(r,s):null}intersectInfiniteManifold(t,i,r){if(this.viewingMode===Ie.Global)return this.intersectManifold(t,i,r);z5(this.coordinateSystem,i,this._coordinateSystem);const s=this._coordinateSystem.value,n=Ne.get();return db(s.plane,t,n)?ne(r,n):null}toRenderCoords(t,i,r){return mL(t)?tn(t,i,this.spatialReference):wn(t,i,r,this.spatialReference)}fromRenderCoords(t,i,r=null){return mL(i)?(_(r)&&(i.spatialReference=r),sue(t,this.spatialReference,i)):i instanceof He?_0(t,this.spatialReference,i):wn(t,this.spatialReference,i,r)?i:null}static create(t,i){switch(t){case Ie.Local:return new nN(Ie.Local,i,Cl(i),XMe());case Ie.Global:return new nN(Ie.Global,i,1,WMe(i))}}static renderUnitScaleFactor(t,i){return Nre(t)/Nre(i)}}function Nre(e){if(bS(e,Ie.Global))return 1;const t=nhe(!1,e);return Cl(t)}var cp;(function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"})(cp||(cp={}));const Ast=(()=>{const e=new Array;return e[cp.ELEVATION]=10,e[cp.BASEMAP]=10,e[cp.I3S_INDEX]=10,e[cp.I3S_DATA]=10,e[cp.SYMBOLOGY]=5,e})(),Cst=30;function _1e(e){return typeof e.getUsedMemory=="function"}const Rst=he.getLogger("esri.views.3d.support.MemoryController");function Ost(e){return new Ist(e)}const yP=1,yz=1,Mst=.75,Pst=.6,Fre=1.3;class Ist{constructor(t){this._view=t,this.events=new xr,this.minQuality=.1,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new BH,this._numQualityChanges=0,this._updating=!1}destroy(){this.events=null,this._cacheStorage.destroy()}newCache(t,i){return new g5e(t,this._cacheStorage,i)}set maxMemory(t){t!=null&&t>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<t&&this._updateQuality(yP),this._maxMemory=t)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(t){t!=null&&t>=0&&(this._additionalCacheMemory=t)}disableMemCache(){this._additionalCacheMemory=-4096}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}resetStableQuality(){this._stableQuality=0}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let t=this._layersUpdating();if(this._memoryPredicted<Pst&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(yP);else if(t)(this._memoryPredicted>1.1*yz||this._memoryUsed>yz)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/Fre),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>yz)this._stableQuality=0,this._canFastRecover=!1,t=this._updateQuality(this._quality/Fre),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<Mst&&this._quality<yP){this._stableQuality=this._quality;const i=.05;t=this._updateQuality(this._quality+i)}else this._quality<1&&(this._canFastRecover=!0);this.updating!==t&&(this._updating=t,this.events.emit("updating-changed",this.updating))}_updateQuality(t){return(t=Math.min(Math.max(t,this.minQuality),yP))!==this._quality&&(this._quality=t,this.events.emit("quality-changed",this._quality),++this._numQualityChanges,!0)}_layersUpdating(){return this._view.allLayerViews.some(t=>!!t.updating)}_updateMemory(){let t=0,i=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(t+=this._view.basemapTerrain.getUsedMemory());const r=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;_(r)&&(t+=r.usedMemory),this._view.allLayerViews&&this._view.allLayerViews.forEach(a=>{if(_1e(a)){const l=a.ignoresMemoryFactor()?this._quality:1;t+=a.getUsedMemory()*l,i+=a.getUnloadedMemory()*l}});const s=this._warnMemoryUsage==null||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),n=1048576*this._maxMemory;if(t>n&&s){this._warnMemoryUsage=t;const a=c=>(c/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",l=Math.round(100*this._quality);Rst.warn(`Memory Limit exceeded! Limit: ${a(n)} Current: ${a(t)} Projected: ${a(t+i)} Quality: ${l}%`)}this._memoryUsed=t/n,this._memoryPredicted=(t+i)/n;const o=n-t;this._cacheStorage.maxSize=Math.max(0,o+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed)}get test(){const t=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const i=t._numQualityChanges;return t._numQualityChanges=0,i}}}}class $st{constructor(t){this.client=t,this._cancelled=!1,this.size=0,this.duration=0}}class Dst{constructor(t){this.typeWorkerQuota=t,this.tasks=new Array,this.numWorkers=0,this.statistics=new Lst}}class Lst{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class Nst{constructor(t,i,r,s){this._workerFunc=t,this._callbackFunc=i,this._maxTotalNumWorkers=r,this._totalNumWorkers=0,this._clients=s.map(n=>new Dst(n))}hasQuota(t){const i=this._clients[t];return!!i&&(this._totalNumWorkers<this._maxTotalNumWorkers||i.numWorkers+i.tasks.length<i.typeWorkerQuota)}push(t){const i=this._clients[t.client];i&&(this._totalNumWorkers<this._maxTotalNumWorkers?(i.numWorkers++,this._totalNumWorkers++,this._workerFunc(t,(r,s)=>this._taskCallback(r,s))):i.tasks.push(t))}cancel(t){this._taskFinished(t),t._cancelled=!0}destroy(){this._clients.length=0}_taskFinished(t){const i=this._clients[t.client];this._totalNumWorkers--,i.numWorkers--,i.statistics.requests++,i.statistics.size+=t.size||0,i.statistics.duration+=t.duration||0,i.statistics.speed=i.statistics.duration>0?i.statistics.size/i.statistics.duration:0,at(i.numWorkers>=0),this._next()}_next(){for(const t of this._clients)if(t&&t.numWorkers<t.typeWorkerQuota&&this._processQueue(t))return;for(const t of this._clients)if(t&&this._processQueue(t))return}_processQueue(t){for(;t.tasks.length>0;)if(this._workerFunc(t.tasks.shift(),(i,r)=>this._taskCallback(i,r)))return t.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(t,i){t._cancelled||(this._callbackFunc(t,i),this._taskFinished(t))}getStatsForType(t){const i=this._clients[t];return i?{quota:i.typeWorkerQuota,workers:i.numWorkers,queueSize:i.tasks.length,requestStats:i.statistics}:null}get test(){const t=this;return{set workerFunc(i){t._workerFunc=i}}}}let I$=class extends we{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,i){this._loadQueue=new Nst((r,s)=>this._startLoading(r,s),(r,s)=>this._doneLoadingCB(r,s),e,t),i&&(this._frameTask=i.registerTask(ht.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=Js(this._frameTask),this._tasks.forEach(e=>Iu(e.abortController)),this._loadQueue=rt(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,i,r={}){const s=Sm();s.__signal=_(r)?r.signal:null;const n=this._createOrUpdateTask(e,t,i,r,s);return go(r,()=>this._cancelRequest(n,s)),s.promise}_createTask(e,t,i,r,s,n){const o=new kst(e,t,i,r,s);return this._updateTask(o,n),this._tasks.set(s,o),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,t){SN(e.resolvers,t),t.reject(pi()),e.resolvers.length===0&&(e.status===au.DOWNLOADING&&(e.status=au.CANCELLED,this._loadQueue.cancel(e),e.abortController.abort(),e.request=null,e.abortController=null),e.status=au.CANCELLED,this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,i,r,s){const n=zst(_(r)&&r.uid||e,t,i),o=this._tasks.get(n);return o?(this._updateTask(o,s),o):this._createTask(e,r,t,i,n,s)}_doneLoadingCB(e,t){this._loadQueue&&(at(e.status===au.DOWNLOADING),e.status=au.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();Qt(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==au.DOWNLOADED&&(t.err=t.err||pi()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!pr(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)pr(t)?r.reject(t):r.reject(new q("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--i;const s=i<=0?e.result:se(e.result);r.resolve(s)}this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1)}_startLoading(e,t){if(e.status===au.CANCELLED)return!1;let i,r;switch(e.startTime=performance.now(),e.status=au.DOWNLOADING,e.docType){case"binary":r="array-buffer",i=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=new AbortController;const s=e.abortController.signal;e.request=Ti(e.url,me(I({},e.options),{responseType:r,timeout:i,signal:s}));let n=()=>{};const o=l=>{e.duration=performance.now()-e.startTime,e.size=l instanceof ArrayBuffer?l.byteLength:e.size||0,e.result=l,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=l=>{e.status===au.DOWNLOADING&&t(e,l),n()};return e.docType!=="image+type"?(e.request.then(l=>o(l.data),a),!0):(e.request.then(l=>{const c=l.data,h=Ust(c);if(r="image",e.size=c.byteLength,h==="unknown")return e.request=Ti(e.url,{responseType:r,timeout:i,signal:s}),void e.request.then(g=>o(g.data),a);const p=new Blob([c],{type:h}),f=window.URL.createObjectURL(p);n=()=>window.URL.revokeObjectURL(f),e.request=Ti(f,{responseType:r,timeout:i,signal:s}),e.request.then(g=>o(new GR(g.data,h,n)),a)},a),!0)}get test(){return{loadQueue:this._loadQueue}}};u([d({readOnly:!0})],I$.prototype,"updating",void 0),I$=u([P("esri.views.3d.support.StreamDataLoader")],I$);const Fst={numRetries:0};function Ust(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return t[0]===137&&t[1]===80?"image/png":t[0]===71&&t[1]===73?"image/gif":t[0]===66&&t[1]===77?"image/bmp":t[0]===255&&t[1]===216?"image/jpeg":"unknown"}class GR{constructor(t,i,r){this.image=t,this.type=i,this.release=r}get isOpaque(){return this.type==="image/jpeg"}}class kst extends $st{constructor(t,i,r,s,n){super(s),this.url=t,this.options=i,this.docType=r,this.key=n,this.result=null,this.status=au.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=Fst.numRetries}}function zst(e,t,i){return`${e}:${t}:${i}`}var au;(function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"})(au||(au={}));let vP=class extends we{constructor(){super(...arguments),this.updating=!1}};function Bst(e,t=()=>performance.now()){return new gG.ResourceController({view:e,now:t})}var gG;u([d({readOnly:!0})],vP.prototype,"updating",void 0),vP=u([P("esri.views.3d.support.ResourceController")],vP),function(e){let t=class extends vP{constructor(){super(...arguments),this._scheduler=null,this._memoryController=null,this._streamDataLoader=null,this._cameraChangeTime=0,this._handles=new Ut,this._frameTask=null,this._scheduleTask=rS,this._state=Ws.IDLE}initialize(){this._cameraChangeTime=this.now(),this._scheduler=PBe(this.now),this._memoryController=Ost(this.view),this._streamDataLoader=new I$,this._streamDataLoader.setup(Cst,Ast,this._scheduler),this._handles.add([this.view.watch("state.camera",(r,s)=>this._cameraChangedHandler(r,s),!0),this.view.watch("stationary",()=>this._stationaryChangedHandler()),this._memoryController.events.on("updating-changed",()=>this.notifyChange("updating"))]),this._frameTask=_1({update:r=>this._frame(r)}),this._scheduleTask=this._scheduler.registerTask(ht.RESOURCE_CONTROLLER)}destroy(){this._handles=rt(this._handles),this._scheduleTask.remove(),this._frameTask=Js(this._frameTask),this._streamDataLoader=rt(this._streamDataLoader),this._memoryController=rt(this._memoryController),this._scheduler=rt(this._scheduler)}get updating(){var r,s;return!!((r=this._memoryController)!=null&&r.updating||(s=this._streamDataLoader)!=null&&s.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}schedule(r,s,n){return this._scheduleTask.schedule(r,s,n)}createStreamDataRequester(r){const s=this._streamDataLoader;return{request:(n,o,a)=>s.request(n,o,r,a),get busy(){return!s.hasDownloadSlots(r)}}}_frame(r){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(Goe(r.deltaTime)),!this._scheduler)||(this._updateState(),this._scheduler.state=this._state,this._scheduler.updateBudget(r)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_cameraChangedHandler(r,s){r&&s&&r.almostEquals(s)||(this._cameraChangeTime=this._scheduler.now,this._updateState(),this._scheduler.state=this._state)}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}_updateState(){this.view.animation?this._state=Ws.ANIMATING:this.view.interacting?this._state=Ws.INTERACTING:(this._state===Ws.ANIMATING&&(this._cameraChangeTime=0),this._scheduler.now-this._cameraChangeTime<=i?this._state=Ws.INTERACTING:this._state=Ws.IDLE)}get test(){return{getQueueStats:r=>this._streamDataLoader.test.loadQueue.getStatsForType(r),state:this._state}}};u([d({constructOnly:!0})],t.prototype,"view",void 0),u([d({constructOnly:!0})],t.prototype,"now",void 0),u([d()],t.prototype,"_scheduler",void 0),u([d()],t.prototype,"_memoryController",void 0),u([d()],t.prototype,"_streamDataLoader",void 0),u([d({readOnly:!0})],t.prototype,"updating",null),t=u([P("esri.views.3d.support.ResourceController")],t),e.ResourceController=t;const i=300}(gG||(gG={}));function Vst(e){return"performanceInfo"in e}const rw=M(),Gst=M(),af=M(),lf=M();function jst(e,t,i=0){const r=e.extent;if(R(r))return!1;if(i===0)return ej(r,t);const s=Math.min(r[2]-r[0],r[3]-r[1]);return HEe(r,t,i*s)}function _P(e,t,i,r){ne(rw,i),rw[r]=t[r];const s=de(rw,rw,t),n=de(Gst,e,t),o=_e(n,s),a=_e(s,s);let l;l=o<=0?t:a<=o?i:pe(rw,t,ae(s,s,o/a));const c=de(rw,e,l);return Math.PI/2-Math.atan(c[2]/Math.sqrt(c[0]*c[0]+c[1]*c[1]))}function Hst(e,t,i){const r=e.extent;if(R(r))return 0;af[0]=r[0],af[1]=r[1],af[2]=i,lf[0]=r[2],lf[1]=r[3],lf[2]=i;let s=1/0,n=1/0;return t[0]<af[0]?s=_P(t,af,lf,0):t[0]>lf[0]&&(s=_P(t,lf,af,0)),t[1]<af[1]?n=_P(t,af,lf,1):t[1]>lf[1]&&(n=_P(t,lf,af,1)),Math.min(s,n)}function qst(e,t,i){if(R(e))return oq();if(e.spatialReference.isGeographic&&!I1(e.spatialReference))return new q("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const r=or.checkUnsupported(e);if(_(r))return r;const s=Wst(e,i);if(s)return s;const n=e.spatialReference;return t&&!(n.equals(t)||t.isWGS84&&n.isWebMercator)?new q("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null}function Wst(e,t){const i=e.lods,r=i[0].resolution*2**i[0].level,s=[r*e.size[0],r*e.size[1]],n=[e.origin.x,e.origin.y],o=Ple(t),a=Dt();or.computeRowColExtent(o,s,n,a);const l=(a[2]-a[0])*(a[3]-a[1]);if(l>Ix){const c=i[0].scale*2**i[0].level;let h=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*c/r;const p=Math.floor(Math.log(h)/Math.log(10));return h=Math.ceil(h/10**p)*10**p,new q("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(c).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+h.toLocaleString()+".",{level0Scale:c,suggestedLevel0Scale:h,requiredNumRootTiles:l,allowedNumRootTiles:Ix})}return null}const Xst=Object.freeze({__proto__:null,isInsideExtent:jst,tiltToExtentEdge:Hst,checkIfTileInfoSupportedForViewSR:qst});function Yst(){return!0}function Zst(){return 0}function Qst(e,t){if(R(e))return oq();const i=e.lods.length-1,r=e.spatialReference,s=I1(r)||Lp(r)||Np(r);if(r.isWebMercator){if(!or.makeWebMercatorAuxiliarySphere(i).compatibleWith(e))return new q("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!s)return new q("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!or.makeGCSWithTileSize(e.spatialReference,e.size[0],i).compatibleWith(e))return e.spatialReference.isWGS84?new q("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new q("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return t&&!e.spatialReference.equals(t)?new q("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene"):void 0}const Jst=Object.freeze({__proto__:null,isInsideExtent:Yst,tiltToExtentEdge:Zst,checkIfTileInfoSupportedForViewSR:Qst}),b1e={[Ie.Global]:Jst,[Ie.Local]:Xst};function Rh(e,t){e||console.warn("Terrain: "+t)}const Kst=1.2,ent=80/180*Math.PI,tnt=110/180*Math.PI;function int(e,t,i){const r=b1e[e.viewingMode];let s;if(r.isInsideExtent(e,t))s=gt(e.getElevation(t[0],t[1],t[1],e.spatialReference),0);else{if(!r.isInsideExtent(e,t,Kst))return 0;const o=e.getTileWithElevation(t[0],t[1],t[1],e.spatialReference);s=.5*((_(o)?o.elevationBounds[0]:e.elevationBounds.min)+(_(o)?o.elevationBounds[1]:e.elevationBounds.max));const a=r.tiltToExtentEdge(e,t,s);if(a>ent&&a<tnt)return 0}const n=t[2]-s;return Math.abs(n)<i?0:n<0?-1:1}function yG(e){return rX(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function w1e(e){return(e==null?void 0:e.type)==="vector-tile"}function oN(e){return(e==null?void 0:e.type)==="imagery-tile"||(e==null?void 0:e.type)==="wcs"}function rX(e){return(e==null?void 0:e.type)==="imagery-tile-3d"}function x1e(e){return(e==null?void 0:e.type)==="tile-3d"}function aN(e){return(e==null?void 0:e.type)==="vector-tile-3d"}function rnt(e){return(e==null?void 0:e.type)==="wmts-3d"}function $$(e){return(e==null?void 0:e.type)==="elevation-3d"}function uT(e){return e&&(x1e(e)||rX(e)||$$(e)||aN(e)||rnt(e))}function snt(e){var t;const i=e==null||(t=e.sourceLayerInfo)==null?void 0:t.data;return _(i)&&"type"in i&&i.type==="raster-tile"}function nnt(e){var t;const i=e==null||(t=e.sourceLayerInfo)==null?void 0:t.data;return _(i)&&"type"in i&&i.type==="vector-tile"}function ont(e){var t;const i=e==null||(t=e.sourceLayerInfo)==null?void 0:t.data;return _(i)&&"type"in i&&i.type==="tile-texture"}function ant(e){var t;const i=e==null||(t=e.sourceLayerInfo)==null?void 0:t.data;return i instanceof HTMLImageElement||i instanceof GR||i instanceof HTMLCanvasElement||i instanceof ImageData}function hT(e){return _(e)&&"release"in e&&e.release(),null}function Ure(e){return e.fetchTile&&e.hasOverriddenFetchTile!==!1}function j4(e,t,i,r){return b1e[r].checkIfTileInfoSupportedForViewSR(e,i,t)}function H4(e,t,i){let r=null,s=null;if(l3e(e)){const n=lnt(e,t,i);r=n.tileInfo,s=n.fullExtent}else{s=oN(e)?e.getCompatibleFullExtent(t):e.fullExtent;const n=i===Ie.Local;if(oN(e))r=e.getCompatibleTileInfo(t,s,n);else if(w1e(e)){const o=n&&!cnt(t)||unt.force512VTL,a=e.tileInfo.spatialReference.isGeographic;r=o?e.tileInfo:e.tileInfo.getOrCreateCompatible(256,a?1:2)}else r=e.tileInfo}return _(r)&&_(s)&&j4(r,s,t,i)==null?{tileInfo:r,fullExtent:s}:null}function lnt(e,t,i){const r=c3e(e);if(_(r)){if(!it.isCollection(r))return{tileInfo:r.tileInfo,fullExtent:r.fullExtent};{const s=r.find(n=>j4(n.tileInfo,n.fullExtent,t,i)==null);if(s)return{tileInfo:s.tileInfo,fullExtent:s.fullExtent}}}return{tileInfo:null,fullExtent:null}}function cnt(e){return e.isWGS84||e.isWebMercator||Rae(e)||!OT(e)}const unt={force512VTL:!1};class hnt{constructor(t,i){if(this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=t.layer,this.memory=uT(t)?i.basemapTerrain.getUsedMemoryForLayerView(t):t.getUsedMemory(),Vst(t)){const r=t.performanceInfo;this.displayedNumberOfFeatures=r.displayedNumberOfFeatures,this.maximumNumberOfFeatures=r.maximumNumberOfFeatures,this.totalNumberOfFeatures=r.totalNumberOfFeatures}}}class dnt{constructor(t){this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array;const i=t.resourceController.memoryController;this.totalMemory=i.maxMemory*HT.MEGABYTES,this.usedMemory=Math.round(i.usedMemory*this.totalMemory),this.quality=i.memoryFactor,this.load=t.resourceController.scheduler.load,this.terrainMemory=t.basemapTerrain?t.basemapTerrain.getUsedMemory():0;const r=t._stage&&t._stage.renderView&&t._stage.renderView.edgeView;this.edgesMemory=_(r)?r.usedMemory:0,t.allLayerViews.items.forEach(s=>{(_1e(s)||uT(s))&&this.layerPerformanceInfos.push(new hnt(s,t))}),this.layerPerformanceInfos.sort((s,n)=>n.memory-s.memory)}}class pnt extends $x{constructor(t,i,r,s){super(i,s),this._streamDataRequester=t,this._parameters=r}async fromUrl(t,i,r){Qt(r);const s=_(r)&&r.signal,n=this.makeUid(t,i);let o=this._textureRequests.get(n);if(!o){const a=new AbortController,l=this._streamDataRequester.request(t,"image",{uid:n,signal:a.signal});o={referenceCount:0,texture:null,textureAsync:null,abortController:a},this._textureRequests.set(n,o),o.textureAsync=l.then(async c=>{const h=this._createTexture(t,c,i);return o.texture=h,o.abortController=null,this._stage.add(h),await this._stage.load(h),{uid:n,texture:h,release:()=>this._release(n)}},c=>{throw o.abortController=null,c})}return o.referenceCount++,new Promise((a,l)=>{go(s,()=>{l(pi())}),o.textureAsync.then(a,l)}).catch(a=>{throw this._release(n),a})}_createTexture(t,i,r){const s=me(I({},this._parameters),{powerOfTwoResizeMode:l0.PAD});if(uj(t)){if(r||i.width===0&&i.height===0){const n=i.width?i.height/i.width:1;r=r||64,n>1?(i.width=Math.round(r/n),i.height=r):(i.width=r,i.height=Math.round(r*n))}this._stage.renderView&&this._stage.renderView.renderingContext.driverTest.svgAlwaysPremultipliesAlpha&&(s.preMultiplyAlpha=!1)}return s.width=i.width,s.height=i.height,new rs(i,s)}}class fnt{constructor(t){this.textures=null,this.streamDataRequester=null,this.graphicsOwners=[],this.screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this.viewState=t.viewState,this.view=t.view,this.pointsOfInterest=t.pointsOfInterest,this.objectResourceCache=t.objectResourceCache,this.streamDataRequester=t.resourceController.createStreamDataRequester(cp.SYMBOLOGY),this.textures=new pnt(this.streamDataRequester,t.view._stage,{preMultiplyAlpha:!0,wrap:{s:ct.CLAMP_TO_EDGE,t:ct.CLAMP_TO_EDGE}},t.resourceController.scheduler);const i=di(this.view.spatialReference).radius;this.screenSizePerspectiveSettings=h0e(t.viewingMode,i),this.screenSizePerspectiveSettingsLabels=_qe(t.viewingMode,i)}destroy(){this.textures.destroy(),this.textures=null,this.streamDataRequester=null}addGraphicsOwner(t){if(!t)return{remove(){}};this.graphicsOwners.push(t);const i="layer"in t?t.watch("layer.screenSizePerspectiveEnabled",()=>this._updateScreenSizePerspectiveEnabled()):null;return this._updateScreenSizePerspectiveEnabled(),{remove:()=>{i&&(i.remove(),SN(this.graphicsOwners,t),this._updateScreenSizePerspectiveEnabled())}}}_updateScreenSizePerspectiveEnabled(){const t=this.graphicsOwners.some(i=>i.get("layer.screenSizePerspectiveEnabled")===!0);if(t&&!this.screenSizePerspectiveHandles){this.screenSizePerspectiveHandles=new Ut;const i=()=>this._updateScreenSizePerspectiveSettings();this.screenSizePerspectiveHandles.add([this.pointsOfInterest.centerOnSurfaceInfrequent.watch("distance",i,!0),this.viewState.events.on("camera-projection-changed",i)]),this._updateScreenSizePerspectiveSettings()}else!t&&this.screenSizePerspectiveHandles&&(this.screenSizePerspectiveHandles.destroy(),this.screenSizePerspectiveHandles=null)}_updateScreenSizePerspectiveSettings(){const t=this.pointsOfInterest;bP.distance=t.centerOnSurfaceInfrequent.distance,bP.fovY=this.viewState.camera.fovY,this.screenSizePerspectiveSettings.update(bP),this.screenSizePerspectiveSettingsLabels.update(bP),this.view._stage.renderView.requestRender()}}const bP={distance:0,fovY:0};class hy{constructor(t,i,r=""){this.graphics=t,this._symbol=new ky({symbolLayers:[new om({material:{color:i},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new cb({text:r,halo:{color:"white",size:1/.75},material:{color:i},size:12})]})}show(t,i){if(R(i))return;this.hide();const r=new et({x:t[0],y:t[1],z:t[2],spatialReference:i});this._graphic=new qo({geometry:r,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){_(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}}let Dy=class extends we{constructor(e){super(e),this.handles=new Ut}destroy(){this.handles.destroy()}};u([d({constructOnly:!0})],Dy.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],Dy.prototype,"surface",void 0),u([d({constructOnly:!0})],Dy.prototype,"state",void 0),Dy=u([P("esri.views.3d.support.PointOfInterest")],Dy);const mnt=Array;let iu=class extends Dy{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new N0({location:et,renderLocation:mnt},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.cameraName="camera",this.renderLocation=M(),this.tmpPoint=new et}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.handles.add(Rp(this.map,"ground.layers","change",e,e,e))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool.destroy(),this._propertiesPool=null}get _camera(){return this.state[this.cameraName]}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get scale(){const e=this._camera,t=xi(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return X1(i,t,0)}get updating(){return this._dirty||this._pendingElevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return void this._updateSurfaceAltitude(0);this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this.tmpPoint,this.state.spatialReference);let e=new AbortController;this.map.ground.queryElevation(this.tmpPoint,{signal:e.signal,cache:this.cache}).then(t=>this._updateSurfaceAltitude(t.geometry.z)).catch(t=>{pr(t)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===e&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),e=null}),this._pendingElevationQueryController=e}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(vz,this._estimatedSurfaceAltitude,this._camera.eye),ll(this._get("renderLocation"),vz)||this._set("renderLocation",ne(this._propertiesPool.get("renderLocation"),vz))}};u([d({constructOnly:!0})],iu.prototype,"scheduler",void 0),u([d({constructOnly:!0})],iu.prototype,"cache",void 0),u([d({constructOnly:!0})],iu.prototype,"task",void 0),u([d({constructOnly:!0})],iu.prototype,"cameraName",void 0),u([d({readOnly:!0})],iu.prototype,"location",null),u([d({constructOnly:!0})],iu.prototype,"map",void 0),u([d({readOnly:!0})],iu.prototype,"renderLocation",void 0),u([d({readOnly:!0})],iu.prototype,"scale",null),u([d({readOnly:!0})],iu.prototype,"updating",null),iu=u([P("esri.views.3d.support.CameraOnSurface")],iu);const vz=M(),kre=iu,gnt=Array;let xh=class extends Dy{constructor(e){super(e),this._propertiesPool=new N0({location:et,renderLocation:gnt},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.cameraName="camera",this.distance=0,this.renderLocation=M(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=Js(this._frameWorker),this._propertiesPool=rt(this._propertiesPool)}get _camera(){return this.state[this.cameraName]}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1}_updateRenderLocation(){const e=vnt;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=_nt;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(ne(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=xi(this._camera.eye,e):(ae(e,this._camera.viewForward,this._get("distance")),pe(e,e,this._camera.eye)),ll(this._get("renderLocation"),e)||this._set("renderLocation",ne(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=di(this.renderCoordsHelper.spatialReference).radius,s=r+e,n=Go(i.eye),o=n<s*s,a=xi(i.eye,t);if(o&&a>r/4){const l=s-Math.sqrt(n);return ae(t,i.viewForward,l),pe(t,t,i.eye),!0}}else{const r=this.surface.ready?this.surface.extent:null;_(r)&&nF(r,this.surface.spatialReference,nE,this.renderCoordsHelper.spatialReference)&&(t[0]=Be(t[0],nE[0],nE[2]),t[1]=Be(t[1],nE[1],nE[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||e==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(hi.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,r=xi(i,e),s=xi(i,t);if(Math.abs(s-r)/r>ynt)return!0}return!1}};u([d({constructOnly:!0})],xh.prototype,"scheduler",void 0),u([d({constructOnly:!0})],xh.prototype,"task",void 0),u([d({constructOnly:!0})],xh.prototype,"cameraName",void 0),u([d()],xh.prototype,"distance",void 0),u([d({constructOnly:!0})],xh.prototype,"estimateSurfaceAltitudeAtCenter",void 0),u([d({readOnly:!0})],xh.prototype,"location",null),u([d({readOnly:!0})],xh.prototype,"renderLocation",void 0),u([d()],xh.prototype,"updating",void 0),xh=u([P("esri.views.3d.support.CenterOnSurface")],xh);const ynt=.05,vnt=M(),_nt=M(),nE=Dt(),wP=xh;class bnt{constructor(t){this.handles=new Ut,this.events=new xr,this.contentLayerViews=t.contentLayerViews,this.handles.add(this.contentLayerViews.on("change",i=>this._layerViewsChanged(i))),this._layerViewsChanged({added:this.contentLayerViews.toArray(),removed:[],moved:[],target:this.contentLayerViews})}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}_layerViewsChanged(t){t.added.forEach(i=>{i.declaredClass==="esri.views.3d.layers.SceneLayerView3D"&&this.handles.add(i.on("visible-geometry-changed",()=>this._contentChanged()),i.uid)}),t.removed.forEach(i=>this.handles.remove(i.uid))}_contentChanged(){this.events.emit("request-update",wnt)}}const wnt={},xnt=Array;let qd=class extends Dy{constructor(e){super(e),this._propertiesPool=new N0({location:et,renderLocation:xnt},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.handles.add([this.centerOnSurface.watch("renderLocation",()=>this.updateRenderLocation()),this.state.watch("contentCamera",()=>this.updateRenderLocation())]),this.scheduler&&this.handles.add(this.scheduler.registerTask(ht.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool.destroy(),this._propertiesPool=null}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,zre);const s=Math.max(0,(Math.acos(_e(zre,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(s)){if(!e||!bT(e,t)){const l=this._propertiesPool.get("renderLocation");ne(l,t),this._set("renderLocation",l)}return}const n=1-Be(s/(.5*Math.PI),0,1),o=n*n*n;this._calculateScreenHorizontalEdgeOnSurface(Bre);const a=this._propertiesPool.get("renderLocation");Cs(a,t,Bre,o),e&&bT(e,a)||this._set("renderLocation",a)}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter(zn());if(i[1]=t.aboveGround?t.padding[bt.BOTTOM]:t.fullHeight-t.padding[bt.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,oE)){de(oE,oE,t.eye);const s=be(oE,oE);if(this.renderCoordsHelper.intersectManifold(xc(t.eye,s),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};u([d()],qd.prototype,"_dirty",void 0),u([d({constructOnly:!0})],qd.prototype,"scheduler",void 0),u([d({constructOnly:!0})],qd.prototype,"centerOnSurface",void 0),u([d({constructOnly:!0})],qd.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),u([d({readOnly:!0})],qd.prototype,"updating",null),u([d({readOnly:!0})],qd.prototype,"location",null),u([d({readOnly:!0})],qd.prototype,"renderLocation",void 0),qd=u([P("esri.views.3d.support.CenterOnSurface")],qd);const zre=M(),oE=M(),Bre=M(),Tnt=qd;let zf=class extends we{constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new Ut}get renderLocation(){if(!this.location)return null;const e=M();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}initialize(){this.view.state.isLocal&&(this._handles.add([this.watch(["surfaceView.spatialReference","surfaceView.extent"],()=>this._update()),Rp(this,"surface.layers","change",()=>this._update())]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||R(this.surfaceView.extent)||!this.surfaceView.spatialReference)return void this._set("location",null);const e=K7(this.surfaceView.extent),t=new et({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(i=>{this._updateController=null,this._set("location",i.geometry)}).catch(i=>{pr(i)||i&&i.name==="elevation-query:invalid-layer"||console.error("StableSurfaceCenter failed to update: ",i)})):this._set("location",t)}};u([d({constructOnly:!0})],zf.prototype,"view",void 0),u([d({constructOnly:!0})],zf.prototype,"cache",void 0),u([d({readOnly:!0,aliasOf:"view.map.ground"})],zf.prototype,"surface",void 0),u([d({readOnly:!0,aliasOf:"view.basemapTerrain"})],zf.prototype,"surfaceView",void 0),u([d({readOnly:!0})],zf.prototype,"location",void 0),u([d({readOnly:!0})],zf.prototype,"renderLocation",null),zf=u([P("esri.views.3d.terrain.StableSurfaceCenter")],zf);let Bf=class extends we{constructor(){super(...arguments),this.handles=new Ut,this._tileGeometryUpdateExtent=$u(),this._tileGeometryUpdateSpatialReference=null,this.events=new xr,this.updating=!1}initialize(){this.handles.add([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(ht.SURFACE_GEOMETRY_UPDATES,this)])}destroy(){this.handles=rt(this.handles)}get running(){return this.updating}runTask(){this.updating&&(this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",Snt),$u(this._tileGeometryUpdateExtent),this._set("updating",!1))}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,n0(this._tileGeometryUpdateExtent,e.tile.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.camera.eye,r=Ent,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,Ev,t),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,Av,t),Ev[0]<Av[0]?(r[0]=Ev[0],r[2]=Av[0]):(r[0]=Av[0],r[2]=Ev[0]),Ev[1]<Av[1]?(r[1]=Ev[1],r[3]=Av[1]):(r[1]=Av[1],r[3]=Ev[1]),VN(r,e)}};u([d({constructOnly:!0})],Bf.prototype,"state",void 0),u([d({constructOnly:!0})],Bf.prototype,"centerOnSurfaces",void 0),u([d({constructOnly:!0})],Bf.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],Bf.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Bf.prototype,"surface",void 0),u([d({readOnly:!0})],Bf.prototype,"updating",void 0),Bf=u([P("esri.views.3d.support.SurfaceGeometryUpdates")],Bf);const Snt={},Ev=M(),Av=M(),Ent=$u();let Do=class extends we{constructor(e){super(e),this._handles=new Ut,this._tmpRay=Vn(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new N0({renderPointOfView:Ant},this),this.renderPointOfView=M(),this._pois=new Array,this._debugCenters=new Map}initialize(){var e;const{state:t,basemapTerrain:i,renderCoordsHelper:r,map:s}=this.view;this._surfaceIntersector=ku(t.viewingMode),t.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=Wn.MIN,this._contentIntersector=ku(t.viewingMode);const n=()=>this._estimateSurfaceAltitudeAtCenter(),o=this.view.resourceController.scheduler,a=(e=this.view.basemapTerrain)==null?void 0:e.elevationQueryCache,l={state:t,scheduler:o,surface:i,renderCoordsHelper:r};this._set("centerOnSurfaceInfrequent",new wP(me(I({},l),{task:ht.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n}))),this._set("centerOnSurfaceFrequent",new wP(me(I({},l),{task:ht.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n}))),this._set("contentCenterOnSurface",new wP(me(I({},l),{task:ht.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n,cameraName:"contentCamera"}))),this._set("centerOnContent",new wP(me(I({},l),{task:ht.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}))),this._set("cameraOnSurface",new kre(me(I({},l),{cache:a,task:ht.POINT_OF_INTEREST_INFREQUENT,map:s}))),this._set("contentCameraOnSurface",new kre(me(I({},l),{cache:a,task:ht.POINT_OF_INTEREST_INFREQUENT,map:s,cameraName:"contentCamera"}))),this._set("surfaceGeometryUpdates",new Bf(me(I({},l),{centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}))),this._set("contentGeometryUpdates",new bnt({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:r})),this._set("surfaceOrigin",new zf({cache:a,view:this.view})),this._set("focus",new Tnt({state:t,scheduler:o,surface:i,renderCoordsHelper:r,centerOnSurface:this.contentCenterOnSurface,estimateSurfaceIntersectionAtRenderPoint:(h,p)=>this._estimateSurfaceIntersectionAtRenderPoint(h,this.view.state.contentCamera,p)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.contentCenterOnSurface,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);const c=this.view.graphics;this._debugCenters.set(this.centerOnContent,new hy(c,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new hy(c,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new hy(c,"red","CenterOnSurface")),this._debugCenters.set(this.contentCenterOnSurface,new hy(c,"red","ContentCenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new hy(c,"blue","CameraOnSurface")),this._debugCenters.set(this.contentCameraOnSurface,new hy(c,"blue","ContentCameraOnSurface")),this._debugCenters.set(this.focus,new hy(c,"green","Focus")),this._handles.add([t.watch("camera",h=>this._cameraChanged(h),!0),i.watch("extent",()=>this._updateCenterPointsOfInterest()),HD(i,"updating",()=>this._updateCenterPointsOfInterest(),!0),this.surfaceGeometryUpdates.events.on("request-update",()=>this._updateCenterPointsOfInterest()),this.contentGeometryUpdates.events.on("request-update",()=>this._updateCenterOnContent()),Wt(hi,"SHOW_POI",h=>this._setDebug(h))]),this._cameraChanged(this.view.state.camera);for(const h of this._pois)h.runTask()}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!!((e=this.surfaceGeometryUpdates)!=null&&e.updating||this._pois.some(t=>t.updating))}get centerRay(){return this._centerRayDirty&&(this._centerRay=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1),this._centerRay}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this.centerRay;return R(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,sw,Rnt)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(sw):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this.centerRay;if(R(e))return this._surfaceAltitudeAtCenter;const t=e.origin,i=pe(sw,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.camera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(sw)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(sw)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const r=Yq(t,e,Cnt);if(R(r))return null;const s=r.origin,n=pe(sw,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,n),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;ll(this.renderPointOfView,t)||this._set("renderPointOfView",ne(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach(t=>t.hide()),void this._handles.remove("debug");for(const t of this._pois)this._handles.add(Wt(t,"renderLocation",i=>this._debugCenters.get(t).show(i,t.renderCoordsHelper.spatialReference)),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};u([d({readOnly:!0})],Do.prototype,"centerOnContent",void 0),u([d({readOnly:!0})],Do.prototype,"centerOnSurfaceFrequent",void 0),u([d({readOnly:!0})],Do.prototype,"centerOnSurfaceInfrequent",void 0),u([d({readOnly:!0})],Do.prototype,"contentCenterOnSurface",void 0),u([d({readOnly:!0})],Do.prototype,"cameraOnSurface",void 0),u([d({readOnly:!0})],Do.prototype,"contentCameraOnSurface",void 0),u([d({readOnly:!0})],Do.prototype,"focus",void 0),u([d({readOnly:!0})],Do.prototype,"renderPointOfView",void 0),u([d({readOnly:!0})],Do.prototype,"surfaceOrigin",void 0),u([d({readOnly:!0})],Do.prototype,"contentGeometryUpdates",void 0),u([d({readOnly:!0})],Do.prototype,"surfaceGeometryUpdates",void 0),u([d({constructOnly:!0})],Do.prototype,"view",void 0),u([d({readOnly:!0})],Do.prototype,"updating",null),Do=u([P("esri.views.3d.support.PointsOfInterest")],Do);const Ant=Array,sw=M(),Cnt=Vn(),Rnt={exclude:new Set([N_])},T1e=Do;class Ont{constructor(t){this.store=t}destroy(){this.store.destroy()}get(t){return this.store.get(t)}put(t,i){this.store.put(t,i,i.values.byteLength+256)}}const Mnt=he.getLogger("esri.core.workers.WorkerHandle");class S1e{constructor(t,i,r,s={}){this._mainMethod=i,this._listeners=[],this._promise=Mce(t,me(I({},s),{schedule:r})).then(n=>{if(this._thread===void 0){this._thread=n,this._promise=null,s.hasInitialize&&this.broadcast({},"initialize");for(const o of this._listeners)this._connectListener(o)}else n.close()}),this._promise.catch(n=>Mnt.error(`Failed to initialize ${t} worker: ${n}`))}on(t,i){const r={removed:!1,eventName:t,callback:i,threadHandle:null};return this._listeners.push(r),this._connectListener(r),km(()=>{r.removed=!0,g7(this._listeners,r),this._thread&&_(r.threadHandle)&&r.threadHandle.remove()})}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null}invoke(t,i){return this.invokeMethod(this._mainMethod,t,i)}invokeMethod(t,i,r){if(this._thread){const s=this.getTransferList(i,t);return this._thread.invoke(t,i,{transferList:s,signal:r})}return this._promise?this._promise.then(()=>(Qt(r),this.invokeMethod(t,i,r))):Promise.reject(null)}broadcast(t,i){return this._thread?Promise.all(this._thread.broadcast(i,t)).then(()=>{}):this._promise?this._promise.then(()=>this.broadcast(t,i)):Promise.reject()}get promise(){return this._promise}_connectListener(t){this._thread&&this._thread.on(t.eventName,t.callback).then(i=>{t.removed||(t.threadHandle=i)})}}class Vre extends S1e{constructor(t=null){super("LercWorker","_decode",t,{strategy:"dedicated"}),this.schedule=t,this.ref=0}decode(t,i,r){return t&&t.byteLength!==0?this.invoke({buffer:t,options:i},r):Promise.resolve(null)}getTransferList(t){return[t.buffer]}release(){--this.ref<=0&&(SC.forEach((t,i)=>{t===this&&SC.delete(i)}),this.destroy())}}const SC=new Map;function Pnt(e=null){let t=SC.get(e);return t||(_(e)?(t=new Vre(i=>e.schedule(i)),SC.set(e,t)):(t=new Vre,SC.set(null,t))),++t.ref,t}function wm(){const e=new Float32Array(9);return e[0]=1,e[4]=1,e[8]=1,e}function E1e(e){const t=new Float32Array(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function Int(e,t,i,r,s,n,o,a,l){const c=new Float32Array(9);return c[0]=e,c[1]=t,c[2]=i,c[3]=r,c[4]=s,c[5]=n,c[6]=o,c[7]=a,c[8]=l,c}function $nt(e,t){return new Float32Array(e,t,9)}Object.freeze({__proto__:null,create:wm,clone:E1e,fromValues:Int,createView:$nt});var Gre,el,jre,Hre,qre;(function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.FILL_VERTEX=1]="FILL_VERTEX",e[e.FILL_DD_VERTEX=2]="FILL_DD_VERTEX",e[e.FILL_INDEX=3]="FILL_INDEX",e[e.OUTLINE_VERTEX=4]="OUTLINE_VERTEX",e[e.OUTLINE_DD_VERTEX=5]="OUTLINE_DD_VERTEX",e[e.OUTLINE_INDEX=6]="OUTLINE_INDEX",e[e.LINE_VERTEX=7]="LINE_VERTEX",e[e.LINE_DD_VERTEX=8]="LINE_DD_VERTEX",e[e.LINE_INDEX=9]="LINE_INDEX",e[e.ICON_VERTEX=10]="ICON_VERTEX",e[e.ICON_DD_VERTEX=11]="ICON_DD_VERTEX",e[e.ICON_INDEX=12]="ICON_INDEX",e[e.TEXT_VERTEX=13]="TEXT_VERTEX",e[e.TEXT_DD_VERTEX=14]="TEXT_DD_VERTEX",e[e.TEXT_INDEX=15]="TEXT_INDEX",e[e.CIRCLE_VERTEX=16]="CIRCLE_VERTEX",e[e.CIRCLE_INDEX=17]="CIRCLE_INDEX"})(Gre||(Gre={})),function(e){e[e.FILL=1]="FILL",e[e.LINE=2]="LINE",e[e.SYMBOL=3]="SYMBOL",e[e.CIRCLE=4]="CIRCLE"}(el||(el={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.OPAQUE=1]="OPAQUE",e[e.TRANSLUCENT=2]="TRANSLUCENT",e[e.SYMBOLS=3]="SYMBOLS",e[e.HITTEST=4]="HITTEST"}(jre||(jre={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.FILL=1]="FILL",e[e.OUTLINE=2]="OUTLINE",e[e.LINE=3]="LINE",e[e.ICON=4]="ICON",e[e.CIRCLE=5]="CIRCLE",e[e.TEXT=6]="TEXT",e[e.TILEINFO=7]="TILEINFO"}(Hre||(Hre={})),function(e){e[e.PAINTER_CHANGED=0]="PAINTER_CHANGED",e[e.LAYOUT_CHANGED=1]="LAYOUT_CHANGED",e[e.LAYER_CHANGED=2]="LAYER_CHANGED",e[e.LAYER_REMOVED=3]="LAYER_REMOVED",e[e.SPRITES_CHANGED=4]="SPRITES_CHANGED"}(qre||(qre={}));class Dnt{constructor(t){this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=t}}class Kyt{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function e0t(e,t,i,r,s,n){const o=i-s;if(o>=0)return(t>>o)+(r-(n<<o))*(e>>o);const a=-o;return t-(n-(r<<a))*(e>>a)<<a}class t0t{constructor(t,i,r){this._rows=Math.ceil(i/r),this._columns=Math.ceil(t/r),this._cellSize=r,this.cells=new Array(this._rows);for(let s=0;s<this._rows;s++){this.cells[s]=new Array(this._columns);for(let n=0;n<this._columns;n++)this.cells[s][n]=[]}}getCell(t,i){const r=Math.min(Math.max(Math.floor(i/this._cellSize),0),this._rows-1),s=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._columns-1);return this.cells[r]&&this.cells[r][s]||null}getCellSpan(t,i,r,s){return[Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function Lnt(e,t,i,r,s,n){const o=t[r++];for(let a=0;a<o;a++){const l=new Dnt(n);l.xTile=t[r++],l.yTile=t[r++],l.hash=t[r++],l.priority=t[r++];const c=t[r++];for(let f=0;f<c;f++){const g=t[r++],y=t[r++],v=t[r++],b=t[r++],w=!!t[r++],S=t[r++],T=i[r++],A=i[r++],C=t[r++],O=t[r++];l.colliders.push({xTile:g,yTile:y,dxPixels:v,dyPixels:b,hard:w,partIndex:S,width:C,height:O,minLod:T,maxLod:A})}const h=e[r++];for(let f=0;f<h;f++)l.textVertexRanges.push([e[r++],e[r++]]);const p=e[r++];for(let f=0;f<p;f++)l.iconVertexRanges.push([e[r++],e[r++]]);s.push(l)}return r}function i0t(e,t,i){for(const[r,s]of e.symbols)Nnt(e,t,i,s,r)}function Nnt(e,t,i,r,s){const n=e.layerData.get(s);if(n.type===el.SYMBOL){for(const o of r){const a=o.unique;let l;if(o.selectedForRendering){const c=a.parts[0],h=c.startOpacity,p=c.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&p===0;const f=i?Math.floor(127*h)|p<<7:p?255:0;l=f<<24|f<<16|f<<8|f}else l=0;for(const[c,h]of o.iconVertexRanges)for(let p=c;p<c+h;p+=4)n.iconOpacity[p/4]=l;if(o.selectedForRendering){const c=a.parts[1],h=c.startOpacity,p=c.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&p===0;const f=i?Math.floor(127*h)|p<<7:p?255:0;l=f<<24|f<<16|f<<8|f}else l=0;for(const[c,h]of o.textVertexRanges)for(let p=c;p<c+h;p+=4)n.textOpacity[p/4]=l}n.lastOpacityUpdate=t,n.opacityChanged=!0}}class q4{constructor(t,i){this.layerUIDs=[],this.isDestroyed=!1,this.data=t,this.memoryUsed=t.byteLength;let r=1;const s=new Uint32Array(t);this.layerUIDs=[];const n=s[r++];for(let o=0;o<n;o++)this.layerUIDs[o]=s[r++];this.bufferDataOffset=r,i&&(this.layer=i.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return R(this.data)}get offset(){return this.bufferDataOffset}destroy(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)}prepareForRendering(t){R(this.data)||(this.doPrepareForRendering(t,this.data,this.bufferDataOffset),this.data=null)}}class Fnt extends q4{constructor(t,i){super(t,i),this.type=el.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const r=new Uint32Array(t);let s=this.bufferDataOffset;this.lineIndexStart=r[s++],this.lineIndexCount=r[s++];const n=r[s++];if(n>0){const o=new Map;for(let a=0;a<n;a++){const l=r[s++],c=r[s++],h=r[s++];o.set(l,[c,h])}this.patternMap=o}this.bufferDataOffset=s}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){_(this.lineVertexArrayObject)&&this.lineVertexArrayObject.dispose(),_(this.lineVertexBuffer)&&this.lineVertexBuffer.dispose(),_(this.lineIndexBuffer)&&this.lineIndexBuffer.dispose(),this.lineVertexArrayObject=null,this.lineVertexBuffer=null,this.lineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(t,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.lineVertexBuffer=jt.createVertex(t,ri.STATIC_DRAW,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.lineIndexBuffer=jt.createIndex(t,ri.STATIC_DRAW,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=this.layer.lineMaterial;this.lineVertexArrayObject=new us(t,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.lineVertexBuffer},this.lineIndexBuffer)}}class Unt extends q4{constructor(t,i){super(t,i),this.type=el.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const r=new Uint32Array(t);let s=this.bufferDataOffset;this.fillIndexStart=r[s++],this.fillIndexCount=r[s++],this.outlineIndexStart=r[s++],this.outlineIndexCount=r[s++];const n=r[s++];if(n>0){const o=new Map;for(let a=0;a<n;a++){const l=r[s++],c=r[s++],h=r[s++];o.set(l,[c,h])}this.patternMap=o}this.bufferDataOffset=s}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){_(this.fillVertexArrayObject)&&this.fillVertexArrayObject.dispose(),_(this.fillVertexBuffer)&&this.fillVertexBuffer.dispose(),_(this.fillIndexBuffer)&&this.fillIndexBuffer.dispose(),this.fillVertexArrayObject=null,this.fillVertexBuffer=null,this.fillIndexBuffer=null,_(this.outlineVertexArrayObject)&&this.outlineVertexArrayObject.dispose(),_(this.outlineVertexBuffer)&&this.outlineVertexBuffer.dispose(),_(this.outlineIndexBuffer)&&this.outlineIndexBuffer.dispose(),this.outlineVertexArrayObject=null,this.outlineVertexBuffer=null,this.outlineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(t,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.fillVertexBuffer=jt.createVertex(t,ri.STATIC_DRAW,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.fillIndexBuffer=jt.createIndex(t,ri.STATIC_DRAW,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=s[r++];this.outlineVertexBuffer=jt.createVertex(t,ri.STATIC_DRAW,new Int32Array(n.buffer,4*r,l)),r+=l;const c=s[r++];this.outlineIndexBuffer=jt.createIndex(t,ri.STATIC_DRAW,new Uint32Array(s.buffer,4*r,c)),r+=c;const h=this.layer,p=h.fillMaterial,f=h.outlineMaterial;this.fillVertexArrayObject=new us(t,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:this.fillVertexBuffer},this.fillIndexBuffer),this.outlineVertexArrayObject=new us(t,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.outlineVertexBuffer},this.outlineIndexBuffer)}}class knt extends q4{constructor(t,i,r){super(t,i),this.type=el.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const s=new Uint32Array(t),n=new Int32Array(t),o=new Float32Array(t);let a=this.bufferDataOffset;this.isIconSDF=!!s[a++];const l=s[a++];for(let f=0;f<l;f++){const g=s[a++],y=s[a++],v=s[a++];this.iconPerPageElementsMap.set(g,[y,v])}const c=s[a++];for(let f=0;f<c;f++){const g=s[a++],y=s[a++],v=s[a++];this.glyphPerPageElementsMap.set(g,[y,v])}const h=s[a++],p=s[a++];this.iconOpacity=new Int32Array(h),this.textOpacity=new Int32Array(p),a=Lnt(s,n,o,a,this.symbols,r),this.bufferDataOffset=a}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let t=0;for(const[i,r]of this.iconPerPageElementsMap)t+=r[1];for(const[i,r]of this.glyphPerPageElementsMap)t+=r[1];return t/3}doDestroy(){_(this.iconVertexArrayObject)&&this.iconVertexArrayObject.dispose(),_(this.iconVertexBuffer)&&this.iconVertexBuffer.dispose(),_(this.iconOpacityBuffer)&&this.iconOpacityBuffer.dispose(),_(this.iconIndexBuffer)&&this.iconIndexBuffer.dispose(),this.iconVertexArrayObject=null,this.iconVertexBuffer=null,this.iconOpacityBuffer=null,this.iconIndexBuffer=null,_(this.textVertexArrayObject)&&this.textVertexArrayObject.dispose(),_(this.textVertexBuffer)&&this.textVertexBuffer.dispose(),_(this.textOpacityBuffer)&&this.textOpacityBuffer.dispose(),_(this.textIndexBuffer)&&this.textIndexBuffer.dispose(),this.textVertexArrayObject=null,this.textVertexBuffer=null,this.textOpacityBuffer=null,this.textIndexBuffer=null,this.memoryUsed=0}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const t=this.iconOpacity,i=this.iconOpacityBuffer;t.length>0&&t.byteLength===i.size&&i.setSubData(t);const r=this.textOpacity,s=this.textOpacityBuffer;r.length>0&&r.byteLength===s.size&&s.setSubData(r)}doPrepareForRendering(t,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.iconVertexBuffer=jt.createVertex(t,ri.STATIC_DRAW,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.iconIndexBuffer=jt.createIndex(t,ri.STATIC_DRAW,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=s[r++];this.textVertexBuffer=jt.createVertex(t,ri.STATIC_DRAW,new Int32Array(n.buffer,4*r,l)),r+=l;const c=s[r++];this.textIndexBuffer=jt.createIndex(t,ri.STATIC_DRAW,new Uint32Array(s.buffer,4*r,c)),r+=c,this.iconOpacityBuffer=jt.createVertex(t,ri.STATIC_DRAW,this.iconOpacity.buffer),this.textOpacityBuffer=jt.createVertex(t,ri.STATIC_DRAW,this.textOpacity.buffer);const h=this.layer,p=h.iconMaterial,f=h.textMaterial;this.iconVertexArrayObject=new us(t,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:this.iconVertexBuffer,opacity:this.iconOpacityBuffer},this.iconIndexBuffer),this.textVertexArrayObject=new us(t,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.textVertexBuffer,opacity:this.textOpacityBuffer},this.textIndexBuffer)}}class znt extends q4{constructor(t,i){super(t,i),this.type=el.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const r=new Uint32Array(t);let s=this.bufferDataOffset;this.circleIndexStart=r[s++],this.circleIndexCount=r[s++],this.bufferDataOffset=s}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){_(this.circleVertexArrayObject)&&this.circleVertexArrayObject.dispose(),_(this.circleVertexBuffer)&&this.circleVertexBuffer.dispose(),_(this.circleIndexBuffer)&&this.circleIndexBuffer.dispose(),this.circleVertexArrayObject=null,this.circleVertexBuffer=null,this.circleIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(t,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.circleVertexBuffer=jt.createVertex(t,ri.STATIC_DRAW,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.circleIndexBuffer=jt.createIndex(t,ri.STATIC_DRAW,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=this.layer.circleMaterial;this.circleVertexArrayObject=new us(t,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.circleVertexBuffer},this.circleIndexBuffer)}}const r0t=!0,s0t=32,Wre=200,Bnt=1/ue("mapview-transitions-duration");class Vnt extends xr{constructor(){super(...arguments),this._fadeOutResolver=null,this._fadeInResolver=null,this._clips=null,this.computedVisible=!0,this.computedOpacity=1,this.fadeTransitionEnabled=!1,this.inFadeTransition=!1,this._isReady=!1,this._opacity=1,this._stage=null,this._visible=!0}get clips(){return this._clips}set clips(t){this._clips=t,this.requestRender()}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(t){this._opacity!==t&&(this._opacity=Math.min(1,Math.max(t,0)),this.requestRender())}get stage(){return this._stage}set stage(t){if(this._stage===t)return;const i=this._stage;this._stage=t,t?this._stage.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):i.trashDisplayObject(this)}get transforms(){return this._getTransforms()}_getTransforms(){return R(this._transforms)&&(this._transforms=this._createTransforms()),this._transforms}get visible(){return this._visible}set visible(t){this._visible!==t&&(this._visible=t,this.requestRender())}fadeIn(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=Sm(),this.requestRender()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=Sm(),this.requestRender()),this._fadeOutResolver.promise}beforeRender(t){this.updateTransitionProperties(t.deltaTime,t.state.scale)}afterRender(t){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&this.computedOpacity===0&&(this._fadeOutResolver(),this._fadeOutResolver=null)}remove(){var t;(t=this.parent)==null||t.removeChild(this)}setTransform(t){}processRender(t){this.stage&&this.computedVisible&&this.doRender(t)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.onDetach(),this.emit("detach")}updateTransitionProperties(t,i){if(this.fadeTransitionEnabled){const r=this._fadeOutResolver||!this.visible?0:this.opacity,s=this.computedOpacity;if(s===r)this.computedVisible=this.visible;else{const n=t*Bnt;this.computedOpacity=s>r?Math.max(r,s-n):Math.min(r,s+n),this.computedVisible=this.computedOpacity>0;const o=r===this.computedOpacity;this.inFadeTransition=!o,o||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}onAttach(){}onDetach(){}doRender(t){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}class np{constructor(t,i,r,s){this.set(t,i,r,s)}static getId(t,i,r,s){return typeof t=="object"?`${t.level}/${t.row}/${t.col}/${t.world}`:`${t}/${i}/${r}/${s}`}get key(){return this}get id(){return this.toString()}set id(t){this.set(t)}get hash(){const t=4095&this.row,i=4095&this.col,r=63&this.level;return(3&this.world)<<30|i<<22|t<<8|r}acquire(t,i,r,s){this.set(t,i,r,s)}contains(t){const i=t.level-this.level;return this.row===t.row>>i&&this.col===t.col>>i&&this.world===t.world}equals(t){return this.level===t.level&&this.row===t.row&&this.col===t.col&&this.world===t.world}clone(){return new np(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(t,i,r,s){if(t==null)this.level=0,this.row=0,this.col=0,this.world=0;else if(typeof t=="object")this.level=t.level||0,this.row=t.row||0,this.col=t.col||0,this.world=t.world||0;else if(typeof t=="string"){const[n,o,a,l]=t.split("/");this.level=parseFloat(n),this.row=parseFloat(o),this.col=parseFloat(a),this.world=parseFloat(l)}else this.level=+t,this.row=+i,this.col=+r,this.world=+s||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new np(this.level-1,this.row>>1,this.col>>1,this.world)}getChildKeys(){const t=this.level+1,i=this.row<<1,r=this.col<<1,s=this.world;return[new np(t,i,r,s),new np(t,i,r+1,s),new np(t,i+1,r,s),new np(t,i+1,r+1,s)]}compareRowMajor(t){return this.row<t.row?-1:this.row>t.row?1:this.col<t.col?-1:this.col>t.col?1:0}}np.pool=new Wr(np,null,null,25,50);class Gnt extends Vnt{constructor(t,i,r,s,n,o=s,a=n){super(),this.triangleCountReportedInDebug=0,this.triangleCount=0,this.texture=null,this.key=new np(t),this.x=i,this.y=r,this.width=s,this.height=n,this.rangeX=o,this.rangeY=a}destroy(){this.texture&&(this.texture.dispose(),this.texture=null)}setTransform(t,i){const r=i/(t.resolution*t.pixelRatio),s=this.transforms.tileMat3,[n,o]=t.toScreenNoRotation([0,0],[this.x,this.y]),a=this.width/this.rangeX*r,l=this.height/this.rangeY*r;wq(s,a,0,0,0,l,0,n,o,1),qF(this.transforms.dvs,t.displayViewMat3,s)}}class lN extends Gnt{constructor(t,i,r,s,n,o,a=null){super(t,i,r,s,n,4096,4096),this._memCache=a,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.layerCount=0,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.invalidating=!1,this.parentTile=null,this.childrenTiles=new Set,this._processed=!1,this._referenced=1,this.styleRepository=o,this.id=t.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<Wre}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<Wre)}get wasRequested(){return this.status==="errored"||this.status==="loaded"||this.status==="reloading"}setData(t){this.changeDataImpl(t),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0}deleteLayerData(t){let i=!1;for(const r of t)if(this.layerData.has(r)){const s=this.layerData.get(r);this._memoryUsedByLayerData-=s.memoryUsed,s.type===el.SYMBOL&&this.symbols.has(r)&&(this.symbols.delete(r),i=!0),s.destroy(),this.layerData.delete(r),this.layerCount--}_(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData),i&&this.emit("symbols-changed"),this.requestRender()}processed(){return this._processed}hasData(){return this.layerCount>0}dispose(){this.status!=="unloaded"&&(A1e.delete(this),lN._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return--this._referenced==0&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get memoryUsage(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)}changeDataImpl(t){let i=!1;if(t){const{bucketsWithData:r,emptyBuckets:s}=t,n=this._createRenderBuckets(r);if(s&&s.byteLength>0){const o=new Uint32Array(s);for(const a of o)this._deleteLayerData(a)}for(const[o,a]of n)this._deleteLayerData(o),a.type===el.SYMBOL&&(this.symbols.set(o,a.symbols),i=!0),this._memoryUsedByLayerData+=a.memoryUsed,this.layerData.set(o,a),this.layerCount++;_(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;for(const[r,s]of this.layerData)s.type===el.SYMBOL&&(this._hasSymbolBuckets=!0);i&&this.emit("symbols-changed")}attachWithContext(t){this.stage={context:t,trashDisplayObject(i){i.processDetach()},untrashDisplayObject:()=>!1}}setTransform(t,i){super.setTransform(t,i);const r=i/(t.resolution*t.pixelRatio),s=this.width/this.rangeX*r,n=this.height/this.rangeY*r,o=[0,0];t.toScreen(o,[this.x,this.y]);const a=this.transforms.tileUnitsToPixels;xq(a),wL(a,a,o),Tq(a,a,Math.PI*t.rotation/180),Sq(a,a,[s,n,1])}_createTransforms(){return{dvs:wm(),tileMat3:wm(),tileUnitsToPixels:wm()}}static _destroyRenderBuckets(t){if(!t)return;const i=new Set;t.forEach(r=>{i.has(r)||(r.destroy(),i.add(r))}),t.clear()}_createRenderBuckets(t){const i=new Map,r=new Map;for(const s of t){const n=this._deserializeBucket(s,r);for(const o of n.layerUIDs)i.set(o,n)}return i}_deserializeBucket(t,i){let r=i.get(t);if(r)return r;switch(new Uint32Array(t)[0]){case el.FILL:r=new Unt(t,this.styleRepository);break;case el.LINE:r=new Fnt(t,this.styleRepository);break;case el.SYMBOL:r=new knt(t,this.styleRepository,this);break;case el.CIRCLE:r=new znt(t,this.styleRepository)}return i.set(t,r),r}_deleteLayerData(t){if(!this.layerData.has(t))return;const i=this.layerData.get(t);this._memoryUsedByLayerData-=i.memoryUsed,i.destroy(),this.layerData.delete(t),this.layerCount--}}const A1e=new Map;function jnt(){A1e.forEach((e,t)=>{console.log(`
${t.key}:`),e[0].forEach(i=>console.log(i)),console.log("========"),e[1].forEach(i=>console.log(i))})}const Hnt=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(i){super.postscript(i),Vme(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const i=Fhe(this.view.defaultsFromMap,"heightModelInfoReady");this.handles.add(i),await i;const r=WBe(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(r)throw r}canResume(){const i=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return super.canResume()&&(!i||!i.minScale||!i.maxScale||i.minScale>=i.maxScale)}getSuspendInfo(){const i=super.getSuspendInfo(),r=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return r&&r.minScale&&r.maxScale&&r.minScale<r.maxScale&&(i.outsideScaleRange=!0),i}};return u([d()],t.prototype,"view",void 0),u([d()],t.prototype,"slicePlaneEnabled",void 0),t=u([P("esri.views.3d.layers.LayerView3D")],t),t},qnt={value:.5,readOnly:!0},C1e={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}},Wnt=e=>{let t=class extends e{get imageFormatIsOpaque(){return!1}get fullExtent(){return this.layer.fullExtent}get isOpaque(){return this.fullOpacity>=1&&this.imageFormatIsOpaque}get dataLevelRange(){const i=this.tileInfo.lods,r=i[0].scale,s=i[i.length-1].scale;return this.levelRangeFromScaleRange(r,s)}get displayLevelRange(){const i=this.tileInfo.lods,r=this.layer.minScale||i[0].scale,s=this.layer.maxScale||i[i.length-1].scale,n=this.levelRangeFromScaleRange(r,s);return this.layer.maxScale&&n.maxLevel++,n}getTileUrl(i,r,s){return this.layer.getTileUrl(i,r,s)}_addTilingSchemeMatchPromise(){if(R(this.fullExtent))return this.addResolvingPromise(Promise.reject(new q("tilingscheme:extent-not-defined","This layer doesn't define a fullExtent.")));const i=this._getTileInfoSupportError(this.tileInfo,this.fullExtent);if(_(i))return this.addResolvingPromise(Promise.reject(i));const r=Fhe(this.view,"basemapTerrain.tilingSchemeLocked").then(()=>{const s=this.view.basemapTerrain.tilingScheme,n=this._getTileInfoCompatibilityError(this.tileInfo,s);if(n)throw n});this.addResolvingPromise(r)}_getTileInfoSupportError(i,r){const s=j4(i,r,this.view.spatialReference,this.view.state.viewingMode);if(s){const n={layer:this.layer,error:s};let o;switch(s.name){case"tilingscheme:spatial-reference-mismatch":case"tilingscheme:global-unsupported-spatial-reference":case"tilingscheme:local-unsupported-spatial-reference":o=new q("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",n);break;default:o=new q("layerview:tiling-scheme-unsupported","The tiling scheme of this layer is not supported by SceneView",n)}return o}return null}_getTileInfoCompatibilityError(i,r){return r.compatibleWith(i)?null:new q("layerview:tiling-scheme-incompatible","The tiling scheme of this layer is incompatible with the tiling scheme of the surface")}levelRangeFromScaleRange(i,r){const s={minLevel:0,maxLevel:1/0},n=this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.tilingScheme;if(!n)return s;const o=n.levels[0],a=l=>{const c=Math.log(o.scale/l)/Math.LN2;return .5-Math.abs(.5-c%1)<1e-9?Math.round(c):Math.ceil(c)};return i!=null&&i>0&&(s.minLevel=Math.max(0,a(i))),r!=null&&r>0&&(s.maxLevel=Math.max(0,a(r))),s}isUpdating(){return!!(this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.updating)}};return u([d({readOnly:!0})],t.prototype,"imageFormatIsOpaque",null),u([d({readOnly:!0})],t.prototype,"updating",void 0),u([d(C1e)],t.prototype,"updatingProgress",void 0),u([d(qnt)],t.prototype,"updatingProgressValue",void 0),u([d()],t.prototype,"fullExtent",null),u([d({readOnly:!0})],t.prototype,"isOpaque",null),u([d({readOnly:!0})],t.prototype,"dataLevelRange",null),u([d({readOnly:!0})],t.prototype,"displayLevelRange",null),u([d()],t.prototype,"layer",void 0),u([d()],t.prototype,"tileInfo",void 0),t=u([P("esri.views.3d.layers.TiledLayerView3D")],t),t};let Gl=class extends Vm(FN(kS(xr.EventedMixin(we)))){constructor(e){super(e),this.layer=null,this.parent=null}initialize(){this.when().catch(e=>{if(e.name!=="layerview:create-error"){const t=this.layer&&this.layer.id||"no id",i=this.layer&&this.layer.title||"no title";throw he.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${i}', id: '${t}')`,e),e}})}get fullOpacity(){return gt(this.get("layer.opacity"),1)*gt(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&this.layer.legendEnabled===!0}get updating(){var e;return!!((e=this.updatingHandles)!=null&&e.updating||this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){var e;return((e=this.layer)==null?void 0:e.visible)===!0}set visible(e){e!==void 0?this._override("visible",e):this._clearOverride("visible")}canResume(){var e,t,i;return this.visible&&((e=this.layer)==null?void 0:e.loaded)&&!((t=this.parent)!=null&&t.suspended)&&((i=this.view)==null?void 0:i.ready)||!1}getSuspendInfo(){const e=this.parent&&this.parent.suspended?this.parent.suspendInfo:{},t=this;return t.view&&t.view.ready||(e.viewNotReady=!0),this.layer&&this.layer.loaded||(e.layerNotLoaded=!0),this.visible||(e.layerInvisible=!0),e}isUpdating(){return!1}};u([d()],Gl.prototype,"fullOpacity",null),u([d()],Gl.prototype,"layer",void 0),u([d()],Gl.prototype,"parent",void 0),u([d({readOnly:!0})],Gl.prototype,"suspended",null),u([d({readOnly:!0})],Gl.prototype,"suspendInfo",null),u([d({readOnly:!0})],Gl.prototype,"legendEnabled",null),u([d({type:Boolean,readOnly:!0})],Gl.prototype,"updating",null),u([d({readOnly:!0})],Gl.prototype,"updatingProgress",null),u([d()],Gl.prototype,"visible",null),u([d()],Gl.prototype,"view",void 0),Gl=u([P("esri.views.layers.LayerView")],Gl);const Xnt=Gl;let CA=class extends Wnt(Hnt(Xnt)){constructor(){super(...arguments),this.type="elevation-3d"}initialize(){var e,t,i,r,s;const n=(e=this.view)==null||(t=e.map)==null?void 0:t.allLayers,o=n&&n.includes(this.layer),a=(i=this.view)==null||(r=i.map)==null||(s=r.ground)==null?void 0:s.layers,l=a&&a.includes(this.layer);if(o&&!l){const c=new q("layerview:elevation-layer-only","3D elevation layer '"+this.layer.id+"' can only be added to layers in map.ground");this.addResolvingPromise(Promise.reject(c))}this._addTilingSchemeMatchPromise()}};u([d()],CA.prototype,"layer",void 0),u([d({readOnly:!0,aliasOf:"layer.tileInfo"})],CA.prototype,"tileInfo",void 0),CA=u([P("esri.views.3d.layers.ElevationLayerView3D")],CA);const R1e=CA;var Ynt=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:R1e});class sX{constructor(t=0,i=0){this.min=t,this.max=i,this.level=0,this.hasNoDataValues=!1}copyFrom(t){this.min=t.min,this.max=t.max,this.level=t.level,this.hasNoDataValues=t.hasNoDataValues}}class Znt{constructor(t,i,r){this.type="elevation",this.samplerData=null,this.level=t[0],this.i=t[1],this.j=t[2],this.extent=i;const s=r.noDataValue,n=r.values;let o=1/0,a=-1/0,l=!0,c=!1;for(let h=0;h<n.length;h++){const p=n[h];p!==s?(o=p<o?p:o,a=p>a?p:a,l=!1):c=!0}l&&(o=0,a=0),a=a>-3e38?a:0,this.samplerData={pixelData:r.values,width:r.width,height:r.height,noDataValue:s,safeWidth:.99999999*(r.width-1),dx:(r.width-1)/(i[2]-i[0]),dy:(r.width-1)/(i[3]-i[1]),x0:i[0],y1:i[3]},this.bounds=[o,a],this.hasNoDataValues=c}release(){this.samplerData=null,this.bounds=null}computeMinMaxValue(t,i,r,s){s.min=1/0,s.max=-1/0,s.hasNoDataValues=!1;const n=t-this.level;if(n<=0)return s;const o=2**n;if(!(Math.floor(i/o)===this.i&&Math.floor(r/o)===this.j))return s;let a=1/0,l=-1/0;const c=this.samplerData.width,h=this.samplerData.pixelData,p=.5*sR;let f=(c-1)/o,g=(r-this.j*o)*f,y=(i-this.i*o)*f;if(f<1){const v=Math.floor(g),b=Math.floor(y),w=v+b*c,S=h[w],T=h[w+1],A=h[w+c],C=h[w+c+1];if(S+T+A+C<p){const O=g-v,L=y-b,U=fM(S,T,A,C,O,L),N=fM(S,T,A,C,O+f,L),z=fM(S,T,A,C,O,L+f),V=fM(S,T,A,C,O+f,L+f);return s.min=Math.min(U,N,z,V),s.max=Math.max(U,N,z,V),s}g=v,y=b,f=1}else g=Math.floor(g),y=Math.floor(y),f=Math.ceil(f);for(let v=g;v<=g+f;v++)for(let b=y;b<=y+f;b++){const w=h[v+b*c];w<p?(a=Math.min(a,w),l=Math.max(l,w)):s.hasNoDataValues=!0}return s.min=a,s.max=l,s}}function nX(e,t,i){if(R(i))return null;for(const r of i){if(!r)continue;const s=r.safeWidth;let n=Be(r.dy*(r.y1-t),0,s),o=Be(r.dx*(e-r.x0),0,s);const a=Math.floor(n),l=Math.floor(o),c=r.width,h=a*c+l,p=r.pixelData,f=p[h],g=p[h+1],y=h+c,v=p[y],b=p[y+1];if(f+v+g+b<.5*sR){n-=a,o-=l;const w=f+(g-f)*o;return w+(v+(b-v)*o-w)*n}}return null}let nu=class extends we{constructor(e){super(e),this._handles=new Ut}initialize(){this._handles.add([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){this._handles.destroy(),this._handles=null}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(t=>{const i=t.layer;if(i.operationalLayerType==="IntegratedMeshLayer"&&this.viewSpatialReference!=null){const r=O1e(i.fullExtent,this.viewSpatialReference);_(r)&&e.push(Ple(r))}}),e}};function Qnt(e,t){return e===Ie.Global?new vG(t):new _G(t)}u([d({readOnly:!0})],nu.prototype,"layerViewsExtent",null),u([d({readOnly:!0})],nu.prototype,"tiledLayersExtent",null),u([d({readOnly:!0})],nu.prototype,"stencilEnabledExtents",null),u([d()],nu.prototype,"viewSpatialReference",void 0),u([d()],nu.prototype,"tilingScheme",void 0),u([d()],nu.prototype,"defaultTiledLayersExtent",void 0),u([d({constructOnly:!0})],nu.prototype,"layers",void 0),u([d({constructOnly:!0})],nu.prototype,"layerViews",void 0),nu=u([P("esri.views.3d.terrain.ExtentHelper")],nu);let vG=class extends nu{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?Cme:J6e}};vG=u([P("esri.views.3d.terrain.ExtentHelperGlobal")],vG);let _G=class extends nu{_computeLayerViewsExtent(){const e=$u(),t=this.viewSpatialReference;this.layerViews.forEach(s=>{const n=s.layer;if(s.isResolved()&&(n.type!=="graphics"||!n.internal)){const o=O1e("fullExtentInLocalViewSpatialReference"in s&&s.fullExtentInLocalViewSpatialReference||s.layer.fullExtent,t);n0(e,o,e)}});const i=oB(e)?e:null,r=this._get("layerViewsExtent");return s1(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=$u();this.layers.forEach(n=>{if(n.loaded&&eC(n)){const o=H4(n,t,Ie.Local);if(R(o))return;const{tileInfo:a,fullExtent:l}=o;(_(a)&&oN(n)&&_(l)||_(a)&&e.compatibleWith(a)&&_(l)&&l.spatialReference.equals(e.spatialReference))&&n0(i,l,i)}}),n0(i,this.defaultTiledLayersExtent,i);const r=oB(i)?i:null,s=this._get("tiledLayersExtent");return s1(r,s)?s:r}};function O1e(e,t){return _(e)&&!e.spatialReference.equals(t)?tue(e,e.spatialReference,t):e}_G=u([P("esri.views.3d.terrain.ExtentHelperLocal")],_G);var Lt;(function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"})(Lt||(Lt={}));const y_=[Lt.ELEVATION,Lt.MAP];function M1e(){var e;const t=(e=globalThis.require)==null?void 0:e.modules;if(t){const i=Object.keys(t);for(const r of i)r.search(".glsl")!==-1&&delete t[r]}}const Jnt=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let Rg,Lo=class extends we{constructor(e){super(e),this._handles=new Ut,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Map,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._layerViewsDirty=!0,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=ue("esri-mobile")?2048:4096,this._animationTimeLast=0}get running(){return(this._placementDirty||this._layerViewsDirty)&&(this._drapeSources.size>0||this.view.graphics.length>0||hi.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return _(this._spatialReference)&&this._spatialReference.isGeographic&&!this.view.state.isLocal?di(this._spatialReference).metersPerDegree:1}get view(){return this.surface.view}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}initialize(){const e=this.view;this.renderer=new bh({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),this._groundIntersector=ku(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",()=>{this._setDrawTexturesDirty(),this.notifyChange("hasHighlights")}),this.renderer.events.on("has-water",t=>{var i;return(i=e._stage)==null?void 0:i.renderView.setRenderParameters({hasOverlayWater:t})}),this.renderer.events.on("renders-occluded",()=>{this._setDrawTexturesDirty(),this.notifyChange("rendersOccluded")}),this.renderer.events.on("content-changed",()=>this._setDrawTexturesDirty()),this.renderer.events.on("textures-disposed",()=>this.updateDrapeTargets()),e.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],()=>this.setPlacementDirty()),this.surface.on("elevation-change",()=>this.setPlacementDirty()),e.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0),e.watch("graphicsView",()=>this._layerViewsDirty=!0),e.on("resize",()=>this.setPlacementDirty()),_1({preRender:t=>{this._contentUpdated=!1,this.renderer.processSyncLayers(),this._updateLayerViews(),this.renderer.hasOverlays&&(this._dispatchAnimationUpdate(t),this._drawOverlayTextures(this.renderer.overlays,ns.UPDATE)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}}),e.resourceController.scheduler.registerTask(ht.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",t=>{this._updateOverlays(t,ns.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays,ns.BACKGROUND,t)})]),this._updateLayerViews()}destroy(){this._drapeSources.forEach((e,t)=>this.unregisterDrapeSource(t)),this._drapeTargets.forEach(e=>this._unregisterDrapeTarget(e)),this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),_(Rg)&&(Rg.hide(),Rg=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;_(e)&&_(t)?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new m0(-20037508342787e-6,20037508342787e-6):new m0(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}get gpuMemoryUsage(){return this.renderer.gpuMemoryUsage}_updateLayerViews(){if(!this._layerViewsDirty)return;const e=new Set;for(const i of this.view.allLayerViews.items)e.add(i.uid),"drapeSourceType"in i&&!this._drapeSources.has(i)&&this._registerDrapeSource(i,zx.LAYER_VIEW),"drapeTargetType"in i&&!this._drapeTargets.has(i)&&this._registerDrapeTarget(i);const t=this.view.graphicsView;_(t)&&!this._drapeSources.has(t)&&(this._registerDrapeSource(t,zx.LAYER_VIEW),e.add(t.uid)),this._drapeSources.forEach((i,r)=>{i!==zx.LAYER_VIEW||e.has(r.uid)||this.unregisterDrapeSource(r)}),this._drapeTargets.forEach(i=>{e.has(i.uid)||this._unregisterDrapeTarget(i)}),this.renderer.updateLayerOrder(),this._setDrawTexturesDirty(),this._layerViewsDirty=!1}registerDrapeSource(e){this._registerDrapeSource(e,zx.EXTERNAL)}_registerDrapeSource(e,t){this._drapeSources.set(e,t),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running")}_updateDrapeSourceExtent(e){this.renderer.overlays.length===2&&_(e.setDrapingExtent)&&_(this._spatialReference)&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}_registerDrapeTarget(e){this._drapeTargets.add(e),this._updateDrapeTarget(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}updateDrapeTargets(){this._drapeTargets.forEach(e=>this._updateDrapeTarget(e))}_updateDrapeTarget(e){e.setDrapingTextures(this.renderer.overlays)}_unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this._setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(){this._updateOverlays(this.view.state.camera,ns.UPDATE)}_updateOverlays(e,t){if(!this._spatialReference)return;this._updateLayerViews();const i=GYe(e.fullWidth,e.fullHeight,this._maxResolution);this._computeOverlayExtents(e,i,cf);const r=tm(cf.inner)/tm(cf.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const s=this._updateOverlay(is.INNER,cf.inner,i,1*cf.pixelRatioAdjustment,cf.mapUnitsPerPixel),n=this._updateOverlay(is.OUTER,cf.outer,i,r*cf.pixelRatioAdjustment,cf.mapUnitsPerPixel);s!==ep.EXTENT&&n!==ep.EXTENT||(this._drapeSources.forEach((o,a)=>this._updateDrapeSourceExtent(a)),this.surface.updateTileOverlayParams(t)),s===ep.NONE&&n===ep.NONE||this._setDrawTexturesDirty(),this._placementDirty=!1}_updateOverlay(e,t,i,r,s){if(this.renderer.overlays.length===0)return ep.NONE;const n=this.renderer.overlays[e],o=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=s,n.pixelRatio=r,Knt(t,n.extent)&&i===n.resolution)return o===s?ep.NONE:ep.RERENDER_ONLY;y0(n.extent,t),n.resolution=i;const a=K7(n.extent);return n.renderLocalOrigin=vC(a[0],a[1],0,"OV_"+this._latestOriginId++),ep.EXTENT}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[is.INNER],r=this.renderer.overlays[is.OUTER],s=yI(e.extent,this.surface.extent,Xre);this._rectInsideRect(i.extent,s)||this._rectanglesOverlap(s,i.extent)||this._rectanglesOverlap(s,r.extent)?(this._setTileOverlayData(s,is.INNER,t),this._setTileOverlayData(s,is.OUTER,t)):(this._clearTileOverlayData(is.INNER,t),this._clearTileOverlayData(is.OUTER,t))}else this._clearTileOverlayData(is.INNER,t),this._clearTileOverlayData(is.OUTER,t)}overlayPixelSizeInMapUnits(e){if(this.renderer.overlays.length===0)return 0;const t=this.renderer.overlays[is.INNER],i=this.renderer.overlays[is.OUTER],r=this._pointIsInExtent(e,t.extent)?t:i;return(r.extent[2]-r.extent[0])/r.resolution}_setTileOverlayData(e,t,i){if(this.renderer.overlays.length===0)return;const r=this.renderer.overlays[t].extent,s=tm(r),n=A1(r);let o=e[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(r[0],o);const a=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);o>a&&(o=a-(e[2]-e[0]))}i.setScale(t,tm(e)/s,A1(e)/n),i.setOffset(t,(o-r[0])/s,(e[1]-r[1])/n)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}async reloadShaders(){M1e(),await this.renderer.reloadShaders(),this._setDrawTexturesDirty(),this.runTask()}_dispatchAnimationUpdate(e){const t=e.time-this._animationTimeLast;(t>=this.surface.view._stage.renderView.animationTimestep||_(this.forcedAnimationTime)||this._drawTexturesDirty||this._drawTexturesAnimateDirty)&&(this.renderer.updateAnimation({dt:t,forcedTime:this.forcedAnimationTime,camera:this.view.state.camera})&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e.time)}_setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,r){const s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,tot,t,i);if(R(s))return!1;const n=s.origin,o=pe(xP,s.origin,s.direction);return this._groundIntersector.reset(n,o,e),this._groundIntersector.intersect([],null),this.view.basemapTerrain.intersect(this._groundIntersector,null,n,o),this._groundIntersector.results.min.getIntersectionPoint(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,s=this.view.renderCoordsHelper.getAltitude(e.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,a=Be(n.estimatedSurfaceAltitude,e.aboveGround?-1/0:s+o,e.aboveGround?s-o:1/0),l=e.aboveGround;if(this.view.viewingMode==="global"){const c=xP;jS(di(this.view.spatialReference).radius+a,xc(e.eye,e.viewForward),c),de(c,c,e.eye);const h=g0.normalize(lMe(e.viewForward,c,e.viewRight))/e.fovY+.5,p=h<=0||h>=1?.5:r;i=l?p*h:h+p*(1-h)}else{const c=.5*Math.PI-Math.acos(-e.viewForward[2]),h=Math.tan(c),p=yi(0,h,1,0),f=Ou(p,p,e.projectionMatrix)[1],g=Be(.5+.5*f,0,1);i=g===1||g===0?.5:l?g*r:1-(1-g)*r}return!!this._intersectGroundFromView(e,.5,i,t)&&u7(t,e.eye)<n.distance*n.distance}_computeOverlayExtents(e,t,i){const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=M();this._findHorizonBasedPointOfInterest(e,s)||ne(s,r);const n=Math.max(.1,xi(e.eye,s)),o=R0(this.view.renderCoordsHelper,r,e.eye),a=Math.PI/2-Math.abs(o-Math.PI/2);hi.OVERLAY_SHOW_CENTER?(R(Rg)&&(Rg=new hy(this.view.graphics,"red")),Rg.show(s,this._renderSR)):_(Rg)&&Rg.hide(),this._overlaySREqualsRenderSR||wn(s,this._renderSR,s,this._spatialReference);const l=this.surface.extent,c=!this._isSpherical&&_(this._spatialReference)&&this._spatialReference.isGeographic,h=c&&_(this._spatialReference)?1/di(this._spatialReference).metersPerDegree:1,p=e.perRenderPixelRatio*n*h;i.mapUnitsPerPixel=p/this._worldToPCSRatio;let f=t*p/2,g=!1,y=c?90:1/0;this._isSpherical&&_(l)&&_(this._spatialReference)&&(this._spatialReference.isWebMercator?(f/=Math.cos(bD(s[1])),y=l[3]):(g=!0,f/=di(this._spatialReference).metersPerDegree,y=90),f>=y&&(f=y,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let v=1;g&&(v=1/Math.max(.2,Math.cos(Math.abs(Rt(s[1])))),f*v>180&&(v=180/f),i.mapUnitsPerPixel*=v);const b=Math.log(2)/12;f=Math.exp(Math.round(Math.log(f)/b)*b);const w=f*v,S=32,T=.5*t/(S*w),A=.5*t/(S*f);s[0]=Math.round(s[0]*T)/T,s[1]=Math.round(s[1]*A)/A;const C=i.inner;C[0]=s[0]-w,C[1]=s[1]-f,C[2]=s[0]+w,C[3]=s[1]+f,this._isSpherical&&this._shiftExtentToFitBounds(C,1/0,y);const O=i.outer;if(6*w>tm(l))y0(O,l);else if(a<=.25*Math.PI)O[0]=C[0]-w,O[1]=C[1]-f,O[2]=C[2]+w,O[3]=C[3]+f;else{wn(e.eye,this._renderSR,xP,this._spatialReference),lp(Cv,s,xP);let U=-Math.atan2(Cv[1],Cv[0])+.125*Math.PI;U<0&&(U+=2*Math.PI);const N=Math.floor(U/(.25*Math.PI));JR(Cv,Jnt[N],2*f),Cv[0]*=v,Cv[2]*=v,d7(O,C,Cv)}if(this._isSpherical)O[0]=this._longitudeCyclical.clamp(O[0]),O[2]=this._longitudeCyclical.clamp(O[2]),O[1]=Math.max(O[1],-y),O[3]=Math.min(O[3],y);else{const U=yI(C,l,Xre),N=yI(O,l,eot);MY(U,N)&&(O[2]=O[0],O[3]=O[1])}const L=Math.abs(C[2]-C[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,L),i.pixelRatioAdjustment=i.mapUnitsPerPixel/L}_drawOverlayTextures(e,t,i=this.view.state.camera){if(e.length===0||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const r=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;const s=this._drawOverlay(e[is.INNER],i),n=this._drawOverlay(e[is.OUTER],i);s!==lS.CHANGED&&n!==lS.CHANGED||this.surface.updateTileOverlayParams(ns.UPDATE),this._collectUnusedRenderTargetMemory(),this.updateDrapeTargets(),r?(this.surface.requestRender(t),t===ns.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(ns.BACKGROUND)}_drawOverlay(e,t){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,t.pixelRatio)}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e)}}_rectanglesOverlap(e,t){return!R(e)&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):VN(e,t))}_rectInsideRect(e,t){return!R(t)&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:MY(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,s=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?s=e[1]+i:e[3]>i&&(s=i-e[3]),SD(e,r,s)}get test(){return{renderer:this.renderer,update:()=>this.runTask()}}};function Knt(e,t){const r=hi.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=r&&Math.abs(t[1]-e[1])<=r&&Math.abs(t[2]-e[2])<=r&&Math.abs(t[3]-e[3])<=r}u([d()],Lo.prototype,"_spatialReference",void 0),u([d({readOnly:!0})],Lo.prototype,"running",null),u([d()],Lo.prototype,"_placementDirty",void 0),u([d()],Lo.prototype,"_contentUpdated",void 0),u([d()],Lo.prototype,"_layerViewsDirty",void 0),u([d()],Lo.prototype,"_isSpherical",null),u([d()],Lo.prototype,"_worldToPCSRatio",null),u([d()],Lo.prototype,"renderer",void 0),u([d({constructOnly:!0})],Lo.prototype,"surface",void 0),u([d({readOnly:!0,aliasOf:"surface.suspended"})],Lo.prototype,"suspended",void 0),u([d({readOnly:!0})],Lo.prototype,"updating",null),u([d({type:Boolean})],Lo.prototype,"hasHighlights",null),u([d({type:Boolean})],Lo.prototype,"rendersOccluded",null),Lo=u([P("esri.views.3d.terrain.OverlayManager")],Lo);const Cv=ni(),xP=M(),cf={inner:Dt(),outer:Dt(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},Xre=Dt(),eot=Dt(),tot=Vn();var ep;(function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"})(ep||(ep={}));class jR{constructor(t,i){this._factoryCallback=t,this._lengthCallback=i,this._pool=new Map}acquire(t){if(!jR.test.disabled){const i=this._pool.get(t);if(i&&i.length!==0)return i.pop()}try{return this._factoryCallback(t)}catch(i){const r=window.performance&&window.performance.memory;let s="";throw r&&(s=`
  totalJSHeapSize: ${r.totalJSHeapSize}, usedJSHeapSize: ${r.usedJSHeapSize}, jsHeapSizeLimit: ${r.jsHeapSizeLimit}`),console.log("Array allocation of size "+t+" failed: "+i+s),i}}release(t){if(jR.test.disabled)return;const i=this._lengthCallback(t);let r=this._pool.get(i);r||(r=new $t({shrink:!0}),this._pool.set(i,r)),r.push(t)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}}jR.test={disabled:!1};const iot=kr().vec3f(E.POSITION).vec2f(E.UV0),W4=new jR(e=>iot.createBuffer(e),e=>e.count);class rot{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=ki(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=ni()}}class sot{constructor(t,i,r){this.values=t,this.numSurfaceIndices=i,this.numSkirtIndices=r}}function not(){W4.clear(),bG.clear()}function oot(e){W4.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null}const aot=65536;function lot(e,t,i,r,s,n,o,a){const l=s[0],c=s[1],h=s[2],p=s[3],f=.1*o.radius*(p-c),g=e.numVertsPerSide-1,y=e.numVertsPerSide*e.numVertsPerSide,v=4*g,b=n&&(a===uo.HAS_SOUTH_POLE||a===uo.HAS_BOTH_POLES),w=n&&(a===uo.HAS_NORTH_POLE||a===uo.HAS_BOTH_POLES),S=W4.acquire(y+v),T=S.position.typedBuffer,A=S.uv0.typedBuffer,C=r.geometryInfo.boundingBox;ki(C);const O=t[2]-t[0],L=t[3]-t[1],U=h-l,N=i[0],z=i[1],V=i[2];for(let te=0;te<=g;te++){const ie=te/g,$=l+ie*U;Yre[te]=Math.sin($),Zre[te]=Math.cos($),Qre[te]=ie,Jre[te]=t[0]+ie*O}let B=0;const J=e.samplerData,Q=_(J)&&J.some(te=>_(te))?(te,ie)=>nX(Jre[te],ie,J):()=>0;for(let te=0;te<=g;te++){let ie=te/g;const $=qt(c,p,ie),F=Math.cos($),k=Math.sin($);let G;n?(G=o.halfSemiMajorAxis*Math.log((1+k)/(1-k)),ie=(G-t[1])/L):G=180*$/Math.PI;for(let W=0;W<=g;W++){const K=Qre[W],H=Yre[W],ee=Zre[W],ye=o.radius+Q(W,G),Ae=ee*F*ye-N,Ve=H*F*ye-z,Se=k*ye-V;wG(Ae,Ve,Se,C);const xe=gL*B;T[xe+0]=Ae,T[xe+1]=Ve,T[xe+2]=Se,A[xe+0]=K,A[xe+1]=ie;const Re=oX(W,te,g);if(_(Re)){const ze=gL*(y+Re),ji=b&&te===0?-1:w&&te===g?1:0,Yr=ji===0?Ae:-N,Ms=ji===0?Ve:-z,Ps=ji===0?Se:o.radius*ji-V;T[ze+0]=Yr,T[ze+1]=Ms,T[ze+2]=Ps,A[ze+0]=ji===0?I1e(K,ie):K,A[ze+1]=ji===0?f:ie,ji!==0&&wG(Yr,Ms,Ps,C)}++B}}r.geometryInfo.numVertsPerRow=e.numVertsPerSide,r.geometryInfo.vertexAttributes=S,r.geometryInfo.skirtLength=f,Ho(r.geometryInfo.uvOffsetAndScale,0,0,1,1),P1e(r.geometryInfo,e.numVertsPerSide,n?a:uo.REGULAR,e.wireframe),r.intersectionData=null,r.skirtIntersectionData=null}function cot(e,t,i,r,s,n){const o=t[0],a=t[1],l=t[2]-o,c=t[3]-a,h=e.clippingArea,p=_(h)?Math.max(0,(h[0]-t[0])/l):0,f=_(h)?Math.max(0,(h[1]-t[1])/c):0,g=_(h)?Math.min(1,(h[2]-t[0])/l):1,y=_(h)?Math.min(1,(h[3]-t[1])/c):1,v=g>p?1/(g-p):1,b=y>f?1/(y-f):1,w=-p*v,S=-f*b,T=l*r*.1,A=e.numVertsPerSide-1,C=e.numVertsPerSide*e.numVertsPerSide,O=4*A,L=W4.acquire(C+O),U=L.position.typedBuffer,N=L.uv0.typedBuffer,z=n.geometryInfo.boundingBox;ki(z);let V=0;const B=ai.radius,J=e.samplerData,Q=_(J)&&J.some(te=>_(te))?(te,ie)=>nX(te,ie,J):()=>0;for(let te=0;te<=A;te++){const ie=te/A;let $=S+ie*b,F=a+ie*c;_(h)&&(F<h[1]?(F=h[1],$=0):F>h[3]&&(F=h[3],$=1));const k=F,G=(s?(Math.PI/2-2*Math.atan(Math.exp(-k/B)))*B:k*r)-i[1];for(let W=0;W<=A;W++){const K=W/A;let H=w+K*v,ee=o+K*l;_(h)&&(ee<h[0]?(ee=h[0],H=0):ee>h[2]&&(ee=h[2],H=1));const ye=Q(ee,k),Ae=ee*r-i[0],Ve=ye-i[2];wG(Ae,G,Ve,z);const Se=gL*V;U[Se+0]=Ae,U[Se+1]=G,U[Se+2]=Ve,N[Se+0]=H,N[Se+1]=$;const xe=oX(W,te,A);if(_(xe)){const Re=gL*(C+xe);U[Re+0]=Ae,U[Re+1]=G,U[Re+2]=Ve,N[Re+0]=I1e(H,$),N[Re+1]=T}++V}}n.geometryInfo.numVertsPerRow=e.numVertsPerSide,n.geometryInfo.vertexAttributes=L,n.geometryInfo.skirtLength=T,Ho(n.geometryInfo.uvOffsetAndScale,p,f,g-p,y-f),P1e(n.geometryInfo,e.numVertsPerSide,uo.REGULAR,e.wireframe),n.intersectionData=null,n.skirtIntersectionData=null}const bG=new Map;function P1e(e,t,i,r){const s=i===uo.HAS_NORTH_POLE||i===uo.HAS_BOTH_POLES,n=t+(r?1024:0)+(s?2048:0);let o=bG.get(n);o||(o=uot(t,s,r),bG.set(n,o)),e.indices=o.values,e.numSurfaceIndices=o.numSurfaceIndices,e.numSkirtIndices=o.numSkirtIndices,e.numWithoutSkirtIndices=e.numSurfaceIndices+(i===uo.REGULAR?0:6*(t-1)*(r?2:1))}function uot(e,t,i){const r=e-1,s=e*e,n=4*r;let o=2*s*3,a=6*n,l=6*(2*r+r-1);i&&(o*=2,a*=2,l*=2);const c=s+n>aot?new Uint32Array(o+a):new Uint16Array(o+a);let h=0,p=0,f=o;for(let g=0;g<=r;g++){let y=0;t&&(y=g===0?l:g===r?-l:0),f+=y;for(let v=0;v<=r;v++){const b=oX(v,g,r);if(_(b)){const w=hot(v,g,r);if(w!==0){const S=h,T=s+b,A=s+(v===0&&g===1?0:b+1),C=h+w;i?(c[f++]=S,c[f++]=T,c[f++]=T,c[f++]=A,c[f++]=A,c[f++]=S,c[f++]=A,c[f++]=C,c[f++]=C,c[f++]=S,c[f++]=S,c[f++]=A):(c[f++]=S,c[f++]=T,c[f++]=A,c[f++]=A,c[f++]=C,c[f++]=S)}}if(++h,v<r&&g<r){const w=g*(r+1)+v,S=w+1,T=S+(r+1),A=T-1;i?(c[p++]=w,c[p++]=S,c[p++]=S,c[p++]=T,c[p++]=T,c[p++]=w,c[p++]=T,c[p++]=A,c[p++]=A,c[p++]=w,c[p++]=w,c[p++]=T):(c[p++]=w,c[p++]=S,c[p++]=T,c[p++]=T,c[p++]=A,c[p++]=w)}}f-=y}return new sot(c,o,a)}function wG(e,t,i,r){e<r[0]&&(r[0]=e),e>r[3]&&(r[3]=e),t<r[1]&&(r[1]=t),t>r[4]&&(r[4]=t),i<r[2]&&(r[2]=i),i>r[5]&&(r[5]=i)}function I1e(e,t){const i=t>e?1:0;return 2+4*i+(1-2*i)*(e+t)}function oX(e,t,i){return t===0?e:e===i?i+t:t===i?3*i-e:e===0&&t>0?4*i-t:null}function hot(e,t,i){return t===0&&e!==i?1:e===i&&t!==i?i+1:t===i&&e!==0?-1:e===0&&t!==0?-(i+1):0}function dot(e,t,i,r,s,n,o,a,l,c){const h=n.position,p=n.uv0,f=e[0],g=e[1],y=e[2],v=t[0]-f,b=t[1]-g,w=t[2]-y;r*=3;for(let S=i*=3;S<r;S+=3){const T=s[S],A=s[S+1],C=s[S+2];let O=h.get(T,0),L=h.get(T,1),U=h.get(T,2),N=h.get(A,0),z=h.get(A,1),V=h.get(A,2),B=h.get(C,0),J=h.get(C,1),Q=h.get(C,2);if(p.get(T,0)>=2){const Ms=O+a[0],Ps=L+a[1],ds=U+a[2],Is=o/Math.sqrt(Ms*Ms+Ps*Ps+ds*ds);O+=Ms*Is,L+=Ps*Is,U+=ds*Is}if(p.get(A,0)>=2){const Ms=N+a[0],Ps=z+a[1],ds=V+a[2],Is=o/Math.sqrt(Ms*Ms+Ps*Ps+ds*ds);N+=Ms*Is,z+=Ps*Is,V+=ds*Is}if(p.get(C,0)>=2){const Ms=B+a[0],Ps=J+a[1],ds=Q+a[2],Is=o/Math.sqrt(Ms*Ms+Ps*Ps+ds*ds);B+=Ms*Is,J+=Ps*Is,Q+=ds*Is}_(l)&&([O,L,U]=l.applyToVertex(O,L,U),[N,z,V]=l.applyToVertex(N,z,V),[B,J,Q]=l.applyToVertex(B,J,Q));const te=N-O,ie=z-L,$=V-U,F=B-O,k=J-L,G=Q-U,W=b*G-k*w,K=w*F-G*v,H=v*k-F*b,ee=te*W+ie*K+$*H;if(Math.abs(ee)<=Number.EPSILON)continue;const ye=f-O,Ae=g-L,Ve=y-U,Se=ye*W+Ae*K+Ve*H;if(ee>0){if(Se<0||Se>ee)continue}else if(Se>0||Se<ee)continue;const xe=Ae*$-ie*Ve,Re=Ve*te-$*ye,ze=ye*ie-te*Ae,ji=v*xe+b*Re+w*ze;if(ee>0){if(ji<0||Se+ji>ee)continue}else if(ji>0||Se+ji<ee)continue;const Yr=(F*xe+k*Re+G*ze)/ee;Yr>=0&&c(Yr,NO(te,ie,$,F,k,G,$1e))}}function pot(e,t,i,r,s,n){const o=r.position,a=r.uv0,l=new Map,c=3*t,h=3*i-c,p=new Uint32Array(h);let f=0;for(let y=0;y<h;++y){const v=e[y+c];if(l.has(v))p[y]=l.get(v);else{const b=f++;l.set(v,b),p[y]=b}}const g=new Float64Array(3*f);return l.forEach((y,v)=>{let b=o.get(v,0),w=o.get(v,1),S=o.get(v,2);if(a.get(v,0)>=2){const T=b+n[0],A=w+n[1],C=S+n[2],O=s/Math.sqrt(T*T+A*A+C*C);b+=T*O,w+=A*O,S+=C*O}g[3*y+0]=b,g[3*y+1]=w,g[3*y+2]=S}),{vertices:g,indices:p}}function fot(e,t,i,r,s,n,o,a,l){const c=n.position,h=n.uv0,p=e[0],f=e[1],g=e[2],y=t[0]-p,v=t[1]-f,b=t[2]-g;r*=3;for(let w=i*=3;w<r;w+=3){const S=s[w],T=s[w+1],A=s[w+2];let C=c.get(S,0),O=c.get(S,1),L=c.get(S,2),U=c.get(T,0),N=c.get(T,1),z=c.get(T,2),V=c.get(A,0),B=c.get(A,1),J=c.get(A,2);h.get(S,0)>=2&&(L+=o),h.get(T,0)>=2&&(z+=o),h.get(A,0)>=2&&(J+=o),_(a)&&([C,O,L]=a.applyToVertex(C,O,L),[U,N,z]=a.applyToVertex(U,N,z),[V,B,J]=a.applyToVertex(V,B,J));const Q=U-C,te=N-O,ie=z-L,$=V-C,F=B-O,k=J-L,G=v*k-F*b,W=b*$-k*y,K=y*F-$*v,H=Q*G+te*W+ie*K;if(Math.abs(H)<=Number.EPSILON)continue;const ee=p-C,ye=f-O,Ae=g-L,Ve=ee*G+ye*W+Ae*K;if(H>0){if(Ve<0||Ve>H)continue}else if(Ve>0||Ve<H)continue;const Se=ye*ie-te*Ae,xe=Ae*Q-ie*ee,Re=ee*te-Q*ye,ze=y*Se+v*xe+b*Re;if(H>0){if(ze<0||Ve+ze>H)continue}else if(ze>0||Ve+ze<H)continue;const ji=($*Se+F*xe+k*Re)/H;ji>=0&&l(ji,NO(Q,te,ie,$,F,k,$1e))}}const Yre=new Array(CO+1),Zre=new Array(CO+1),Qre=new Array(CO+1),Jre=new Array(CO+1),$1e=M();class D1e{constructor(){this._queue=new $t,this._last=null,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.isLeaf)}resetOne(t){this._queue.clear(),this._queue.push(t),this._last=null}reset(t=null){this._queue.clear(),_(t)&&this._queue.pushArray(t),this._last=null}skipSubtree(){this._last=null}next(){return this._last&&!this._last.isLeaf&&this._queue.pushArray(this._last.children),this._last=this._queue.pop(),this._last}}class mot{constructor(){this.q=new $t}get done(){return this.q.length===0}reset(t){if(this.q.clear(),!R(t)){this.q.pushArray(t);for(let i=0;i<this.q.length;++i){const r=this.q.data[i];r.isLeaf||this.q.pushArray(r.children)}}}next(){return this.q.pop()}}function EC(e,t,i){if(R(t)||R(t.fullExtent))return!1;const r=t.fullExtent,s=e.extent;if(i){if(s[0]<r.xmin||s[1]<r.ymin||s[2]>r.xmax||s[3]>r.ymax)return!1}else if(r.xmin>s[2]||r.ymin>s[3]||r.xmax<s[0]||r.ymax<s[1])return!1;const n=e.surface.tilingScheme.levels[e.level].scale;return!(t.minScale>0&&n>1.00000001*t.minScale)&&!(t.maxScale>0&&n<.99999999*t.maxScale)}function L1e(e,t){t.sort((i,r)=>N1e(i,r,e))}function N1e(e,t,i){const r=e.screenDepth,s=t.screenDepth;return r<s?-i:r>s?i:0}function got(e,t){const i=new Map;e.forAll(r=>i.set(r.lij,r.distanceToSquared(t))),e.sort((r,s)=>i.get(r.lij)-i.get(s.lij))}function yot(e,t,i){let r=1,s=0,n=0;for(;e!==t;)if(r*=.5,s*=.5,n*=.5,1&e.lij[2]&&(s+=.5),(1&e.lij[1])==0&&(n+=.5),(e=e.parent)==null)throw new Error("tile was not a descendant of upsampleTile");i.init(t,s,n,r)}function vot(e){for(let t=0;t<e.length;t++){const i=e[t],r=i.parent;if(r)for(let s=0;s<4;s++){const n=r.children[s];if(n&&n!==i&&n.loadable)return!0}}return!1}function n0t(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],r=i?e:t,s=i?t:e,n=1<<s[0]-r[0];return Math.floor(s[1]/n)===r[1]&&Math.floor(s[2]/n)===r[2]}class aX{get updating(){return!!this._tileRequested}init(t,i,r,s){this.tile=t,this._layerIdx=i,this._layerClass=r,this._suspended=s,this._tileLayerInfo=t.getLayerInfo(i,r),this._tileRequested=null;const n=this._findAncestorWithData();this._setUpsampleTile(n)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(t){t!==this._suspended&&(this._suspended=t,t?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const t=this._findAncestorWithData();return this._setUpsampleTile(t),this._requestNext()}dataArrived(t){this._setUpsampleTile(t),this._tileRequested=null,t===this.tile?this.tile.updateRenderData(this._layerClass,Qs.FADING):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const t=this._findNextDownload();if(this._tileRequested){if(t===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return _(t)?t.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=t):this._agentDone(),!!this._tileRequested}_findNextDownload(){const t=this._layerIdx,i=this._layerClass,r=this.tile.surface.layerViewByIndex(t,i),s=yG(r),{minLevel:n,maxLevel:o}=r.dataLevelRange,a=this._desiredMinLevelDelta,l=this._progressiveLevelModulo+a,c=this._scaleRangeEnabled?EC:()=>!0;let h=this.tile;const p=h.level;let f;const g=this._tileLayerInfo.upsampleInfo,y=g?g.tile.level:-1,v=Pr(s,"tilemapCache");for(;h&&c(h,s,!1)&&h.level>=n;){const b=h.level,w=p-b,S=h.layerInfo[i][t];if(S.data&&w>=a){b>y&&this._setUpsampleTile(h),S.dataInvalidated&&(f=h);break}if((R(v)||v.getAvailability(h.lij[0],h.lij[1],h.lij[2])!=="unavailable")&&b<=o&&!S.data&&!S.dataMissing&&((R(f)||h.level===n||b%Ame==0||p-f.level<a)&&(f=h),w>=l))break;h=h.parent}return _(f)&&p-f.level<a&&this._tileLayerInfo.upsampleInfo&&(f=null),f}_findAncestorWithData(){const t=this.tile.vlevel,i=this._desiredMinLevelDelta;let r;for(let s=this.tile;s;s=s.parent)if(s.hasLayerData(this._layerIdx,this._layerClass)){if(t-s.level>=i)return s;r=s}return r}_setUpsampleTile(t){this._tileLayerInfo.setUpsampleInfo(this.tile,t),this.tile.updateRenderData(this._layerClass,Qs.FADING)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}class _ot extends aX{get _desiredMinLevelDelta(){throw Kre}get _progressiveLevelModulo(){throw Kre}dispose(){}}const Kre=new Error("Abstract method called on TileAgent"),Na=new _ot;class F1e extends aX{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return s$(this.tile.level)-(this.tile.vlevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}class U1e extends aX{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return Ame}}function bot(e,t,i="nearest",r=!1){var s;const n=!(r&&t.pixelType==="u8"),o=n?yt.FLOAT:yt.UNSIGNED_BYTE,a=t.pixels==null||t.pixels.length===0?null:n?t.getAsRGBAFloat():t.getAsRGBA(),l=(s=e.capabilities.textureFloat)==null?void 0:s.textureFloatLinear,c={width:t.width,height:t.height,target:st.TEXTURE_2D,pixelFormat:$e.RGBA,internalFormat:e.type===Kt.WEBGL2&&n?nt.RGBA32F:$e.RGBA,samplingMode:!l||i!=="bilinear"&&i!=="cubic"?Ge.NEAREST:Ge.LINEAR,dataType:o,wrapMode:ct.CLAMP_TO_EDGE,flipped:!1};return new Qe(e,c,a)}function wot(e,t){const{spacing:i,offsets:r,coefficients:s,size:[n,o]}=t,a=i[0]>1,l={width:a?4*n:n,height:o,target:st.TEXTURE_2D,pixelFormat:$e.RGBA,internalFormat:e.type===Kt.WEBGL2?nt.RGBA32F:$e.RGBA,dataType:yt.FLOAT,samplingMode:Ge.NEAREST,wrapMode:ct.CLAMP_TO_EDGE,flipped:!1},c=new Float32Array(a?n*o*16:2*r.length);if(a)for(let h=0,p=0;h<s.length;h++)c[p++]=s[h],h%3==2&&(c[p++]=1);else for(let h=0;h<o;h++)for(let p=0;p<n;p++){const f=4*(h*n+p),g=2*(p*o+h);c[f]=r[g],c[f+1]=r[g+1],c[f+3]=r[g]===-1?0:1}return new Qe(e,l,c)}function ese(e,t){const i={width:t.length/4,height:1,target:st.TEXTURE_2D,pixelFormat:$e.RGBA,internalFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.NEAREST,wrapMode:ct.CLAMP_TO_EDGE,flipped:!1};return new Qe(e,i,t)}function xot(e,t,i,r=1,s=!0,n=!1){return{u_flipY:s,u_isFloatTexture:n,u_applyTransform:!!e,u_opacity:r,u_transformSpacing:e?e.spacing:null,u_transformGridSize:e?e.size:null,u_targetImageSize:t,u_srcImageSize:i}}function Tot(e,t){return{u_colormapOffset:t||0,u_colormapMaxIndex:e?e.length/4-1:null}}function Sot(e,t){return{u_scale:e,u_offset:t}}function Eot(e){return{u_bandCount:e.bandCount,u_minOutput:e.outMin,u_maxOutput:e.outMax,u_minCutOff:e.minCutOff,u_maxCutOff:e.maxCutOff,u_factor:e.factor,u_useGamma:e.useGamma,u_gamma:e.gamma,u_gammaCorrection:e.gammaCorrection}}function Aot(e){return{u_hillshadeType:e.hillshadeType,u_sinZcosAs:e.sinZcosAs,u_sinZsinAs:e.sinZsinAs,u_cosZs:e.cosZs,u_weights:e.weights,u_factor:e.factor,u_minValue:e.minValue,u_maxValue:e.maxValue}}function Cot(e,t){const i=e.gl,r=t.glName,s=i.getProgramParameter(r,i.ACTIVE_UNIFORMS),n=new Map;let o;for(let a=0;a<s;a++)o=i.getActiveUniform(r,a),o&&n.set(o.name,{location:i.getUniformLocation(r,o.name),info:o});return n}function aE(e,t,i){Object.keys(i).forEach(r=>{const s=t.get(r)||t.get(r+"[0]");s&&Rot(e,r,i[r],s)})}function Rot(e,t,i,r){if(r===null||i==null)return!1;const{info:s}=r;switch(s.type){case Fo.FLOAT:s.size>1?e.setUniform1fv(t,i):e.setUniform1f(t,i);break;case Fo.FLOAT_VEC2:e.setUniform2fv(t,i);break;case Fo.FLOAT_VEC3:e.setUniform3fv(t,i);break;case Fo.FLOAT_VEC4:e.setUniform4fv(t,i);break;case Fo.FLOAT_MAT3:e.setUniformMatrix3fv(t,i);break;case Fo.FLOAT_MAT4:e.setUniformMatrix4fv(t,i);break;case Fo.INT:s.size>1?e.setUniform1iv(t,i):e.setUniform1i(t,i);break;case Fo.BOOL:e.setUniform1i(t,i?1:0);break;case Fo.INT_VEC2:case Fo.BOOL_VEC2:e.setUniform2iv(t,i);break;case Fo.INT_VEC3:case Fo.BOOL_VEC3:e.setUniform3iv(t,i);break;case Fo.INT_VEC4:case Fo.BOOL_VEC4:e.setUniform4iv(t,i);break;default:return!1}return!0}const tse={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class ise{constructor(t,i,r=null,s=null){this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.scale=1,this.offset=[0,0],this.opacity=1,this.lij=t,this.source=i,this.width=r||i.width,this.height=s||i.height}get source(){return this._source}set source(t){this._source=t,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._memoryUsed=null)}get symbolizerParameters(){return this.isRendereredSource?me(I({},tse),{maxCutOff:[1,1,1],factor:[1,1,1]}):this._symbolizerParameters||tse}set symbolizerParameters(t){this._symbolizerParameters=t}get bandIds(){return this._bandIds}set bandIds(t){_(t)&&t.length>0?this._bandIds&&t.every((i,r)=>!!this._bandIds[r]&&i===this._bandIds[r])||(this._bandIds=t,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(t){if(this._interpolation=t,this._rasterTexture){const i=this._getRasterTextureInterpolation(t);this._rasterTexture.setSamplingMode(i==="bilinear"?Ge.LINEAR:Ge.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(t){this._transformGrid=t,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null)}bind(t){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(this._rasterTexture&&!this._dirty||this._updateRasterTexture(t,this.bandIds),this._rasterTexture&&(this._updateColormapTexture(t),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=wot(t,this.transformGrid))),!0)}getUniforms(){const t=Sot(this.scale,this.offset),{symbolizerParameters:i,transformGrid:r,width:s,height:n,opacity:o}=this;return{basic:t,common:xot(r,[s,n],[this.source.width,this.source.height],o),colormap:i.colormap?Tot(i.colormap,i.colormapOffset):null,stretch:this.symbolizerParameters.type==="stretch"?Eot(this.symbolizerParameters):null,hillshade:this.symbolizerParameters.type==="hillshade"?Aot(this.symbolizerParameters):null}}getTextures(){const t=new Array,i=[];return this._rasterTexture&&(i.push(this._rasterTexture),t.push("u_image"),this._transformGridTexture&&(i.push(this._transformGridTexture),t.push("u_transformGrid")),this._colormapTexture&&(i.push(this._colormapTexture),t.push("u_colormap"))),{names:t,textures:i}}get memoryUsage(){if(R(this._memoryUsed)){const t=this.getTextures();if(t==null)return 0;this._memoryUsed=t.textures.map(i=>i.descriptor.width*i.descriptor.height*4).reduce((i,r)=>i+r,0)}return this._memoryUsed}release(){return this._rasterTexture=tt(this._rasterTexture),this._transformGridTexture=tt(this._transformGridTexture),this._colormapTexture=tt(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(t,i){const r=this.source?this.source.extractBands(i):null;if(!(r&&r.pixels&&r.pixels.length>0))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null));const s=R(i)&&R(this.bandIds)||_(i)&&_(this.bandIds)&&i.join("")===this.bandIds.join("");if(this._rasterTexture){if(s)return;this._rasterTexture.dispose(),this._rasterTexture=null}const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=bot(t,r,n,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(t){return this.symbolizerParameters.type==="lut"||t==="nearest"||t==="majority"?"nearest":"bilinear"}_updateColormapTexture(t){const i=this._colormap,r=this.symbolizerParameters.colormap;return r?i?r.length!==i.length||r.some((s,n)=>s!==i[n])?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=ese(t,r),void(this._colormap=r)):void 0:(this._colormapTexture=ese(t,r),void(this._colormap=r)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))}}class D${constructor(){this.waitingAgents=new $t,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(t){const i=_z.acquire();return i._init(t),i}release(){this.dispose(),L$.delete(this),_z.release(this)}dispose(){this.loadingAgent=tt(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=hT(this._data)}static prune(){_z.prune(0)}_init(t){this.waitingAgents.clear(),this._data=hT(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=t,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=Iu(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){this._upsampleInfo&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(t,i){if(t===i||R(i))this._unsetUpsampleInfo();else{if(this._upsampleInfo==null)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===i)return;this._upsampleInfo.tile.unrefMapData()}i.refMapData(),yot(t,i,this._upsampleInfo)}}get data(){return this._data}set data(t){hT(this._data),this._data=t}}const _z=new Wr(D$,null,()=>{}),L$=new Map;function Oot(){L$.size>0&&(console.log(`${L$.size} live TilePerLayerInfo allocations:`),L$.forEach(e=>console.log(e,`
`)))}class Cy{constructor(t){this._texture=t,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,this._refCount===0&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}}var vt;(function(e){e[e.NONE=0]="NONE",e[e.NONE_HIT_MAXLOD=1]="NONE_HIT_MAXLOD",e[e.SPLIT=2]="SPLIT",e[e.VSPLITMERGE=4]="VSPLITMERGE",e[e.MERGE=8]="MERGE",e[e.RENDERDATA=16]="RENDERDATA",e[e.GEOMETRY=32]="GEOMETRY",e[e.TEXTURE_NOFADING=64]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=128]="TEXTURE_FADING"})(vt||(vt={}));const bz=M(),nw=M(),nn=M(),Mot=.1;class Pot{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}}class lX{constructor(){this.lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this._dirty=!0,this._previouslyRendered=!1,this.extent=Dt(),this._elevationBounds=Ye(),this.layerInfo=[[],[]],this.extentInRadians=Dt(),this.centerAtSeaLevel=M(),this._center=[M(),xn(),M()],this.up=a7(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=lE,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0}static prune(){cX.prune(0),uX.prune(0),D$.prune()}get usedMemory(){return this._usedMemory===lE&&this._updateMemoryUsed(),this._usedMemory+(this.isCached?0:this.mapTileMemory)}get cachedMemory(){return this.isCached?this.mapTileMemory:0}get mapTileMemory(){this._usedMemory===lE&&this._updateMemoryUsed();let t=this._mapTileMemory;for(const{data:i}of this.layerInfo[Lt.MAP])i instanceof lN&&(t+=i.memoryUsage);return t}get isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get key(){return`${this.lij[0]}/${this.lij[1]}/${this.lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[zo.MIDDLE][3]}get screenDepth(){return this._screenDepth}get visible(){return this._dirty&&this.computeVisibility(),this._visible}computeVisibility(){this._dirty=!1;const t=this._intersectsClippingArea&&this._isVisible(this.surface.frustum);return t!==this._visible&&(this._visible=t,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setNeedsRender(),this.updateAgentSuspension()),this._visible}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const t=!!this.renderData;return t!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=t,this._surface.renderer.setNeedsRender()),t}get shouldLoad(){if(!this.loadable)return!1;if(this._surface.lodSnapping===AS.ON){const t=this.level-this._surface.snapLevel;if(t===0)return!0;if(t===1)return!1}return this.isLeaf}init(t,i,r){this.lij[0]=t[0],this.lij[1]=t[1],this.lij[2]=t[2],this.ellipsoid=di(r.tilingScheme.spatialReference),r.tilingScheme.getExtent(t[0],t[1],t[2],this.extent),r.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,r.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[zo.MIDDLE][3]=0,this.vlevel=t?t[0]:0,i&&i.elevationBounds?zs(this._elevationBounds,i.elevationBounds):rr(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=i,this.unsetChildren(),this._surface=r,this.updateVisibility();for(const s of y_){const n=r.numLayers(s),o=this.layerInfo[s];for(const a of o)a.release();o.length=n;for(let a=0;a<n;a++)o[a]=D$.acquire(this._surface.upsampleInfoPool),s===Lt.ELEVATION&&this.findElevationBoundsForLayer(a,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(r.tilingScheme.pixelSize,CO)}release(){Rh(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const t of y_){for(const i of this.layerInfo[t])i.release();this.layerInfo[t].length=0}this._parent=null,this._surface=null,this._usedMemory=lE}refMapData(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this.isCached){const t=this.cachedMemory;t>0&&(this._surface.upsampleMapCache.put(this.key,this,t),this.setMemoryDirty())}}setMemoryDirty(){this._usedMemory=lE}get cpuImageMemorySize(){const i=this._surface.tilingScheme.pixelSize;return i*i*4}_updateMemoryUsed(){this._usedMemory=0,this._mapTileMemory=0;const t=this.cpuImageMemorySize;for(const{data:i}of this.layerInfo[Lt.MAP])i instanceof Cy?this._mapTileMemory+=c0(i.texture):i instanceof HTMLImageElement||i instanceof GR?this._mapTileMemory+=t:i instanceof ise&&(this._mapTileMemory+=i.memoryUsage);for(const i of this.layerInfo[Lt.ELEVATION])this._usedMemory+=i.data?t:0;this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemory+=c0(this.renderData.textureDescriptor)),this.isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this.cachedMemory)}getUsedMemoryForLayer(t,i){const r=this.layerInfo[t][i];if(!r||!r.data)return 0;if(t!==Lt.MAP||this.isCached){if(t===Lt.ELEVATION)return this.cpuImageMemorySize}else{const s=r.data;if(s instanceof Cy)return c0(s.texture);if(s instanceof HTMLImageElement||s instanceof GR)return this.cpuImageMemorySize;if(s instanceof lN||s instanceof ise)return s.memoryUsage}return 0}updateScreenDepth(t){const i=this._center[zo.MIDDLE],r=t,s=i[0],n=i[1],o=i[2],a=r[2]*s+r[6]*n+r[10]*o+r[14];this._screenDepth=a<0?0:a/(r[3]*s+r[7]*n+r[11]*o+r[15])}shouldSplit(t,i,r){if(_(t.frustum)&&(!this._intersectsClippingArea||!this._isVisible(t.frustum)))return vt.NONE;const s=this.level;de(bz,this._center[zo.MIDDLE],i);let n=Go(bz),o=zo.MIDDLE;de(nw,this._center[zo.TOP],i);const a=Go(nw);a<n&&(n=a,o=zo.TOP),de(nw,this._center[zo.BOTTOM],i);const l=Go(nw);if(l<n&&(n=l,o=zo.BOTTOM),this._edgeLen2>n&&s<t.maxLod)return vt.SPLIT;const c=Math.sqrt(n),h=t.fovX*c*2,p=this._edgeLen/h,f=()=>{const b=s+Math.ceil(-Math.log2(t.relativeWidthLimit/p));return b!==this.vlevel?(this.vlevel=b,vt.VSPLITMERGE):vt.NONE_HIT_MAXLOD};if(r===AS.ON&&this._surface.snapLevel-s===1)return s>=t.maxLod?f():vt.SPLIT;const g=_e(this.up,bz),y=this._elevationBounds[1]-this._elevationBounds[0],v=y/this.edgeLen;if(t.aboveGround&&g>0&&v<.001&&g/c-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-v>0)return vt.NONE;if(p<t.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,vt.VSPLITMERGE):vt.NONE;if(s>=t.maxLod)return f();if(s>6){de(nw,this._center[o],i),ae(nn,this.up,g),de(nn,nn,nw);const b=Go(nn);if(b>this.radius*this.radius){ae(nn,nn,this.radius/Math.sqrt(b)),pe(nn,nn,this._center[o]),de(nn,i,nn);const w=Math.min(1,(Math.abs(_e(nn,this.up))+.5*y+this._curvatureHeight)/Pe(nn)),S=Mot/t.angledSplitBias,T=t.fovY*c*2;if(w*(this._edgeLen/T)<S*t.relativeHeightLimit)return vt.NONE}}return vt.SPLIT}setChildren(t,i,r,s){Rh(!!(t&&i&&r&&s),"Null child passed"),this._children[0]=t,this._children[1]=i,this._children[2]=r,this._children[3]=s}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}load(t){this.refMapData();for(const i of y_)this._createOrUpdateAgents(0,i);t.loadTile(this)}unload(t){t.unloadTile(this);for(const i of y_){const r=this.layerInfo[i];for(const s of r)s.loadingAgent&&s.loadingAgent!==Na&&(TP(s.loadingAgent),s.loadingAgent=null),s.pendingUpdates=0}this.resetPendingUpdate(vt.GEOMETRY),this.resetPendingUpdate(vt.TEXTURE_NOFADING),this.resetPendingUpdate(vt.TEXTURE_FADING),this.unrefMapData()}unloadMapData(){const t=this.layerInfo[Lt.MAP];for(const i of t)i.loadingAgent&&i.loadingAgent!==Na&&(TP(i.loadingAgent),i.loadingAgent=null),i.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(t){if(s1(t,this._clippingArea))return!1;const i=this._intersectsClippingArea,r=this._isWithinClippingArea;_(t)?(this._intersectsClippingArea=this.intersectsExtent(t),this._isWithinClippingArea=this._isWithinExtent(t)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=t,this.updateVisibility();const s=r&&this._isWithinClippingArea,n=!(r||i||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||s||n||this.setPendingUpdate(vt.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(t,i){return this.layerInfo[i][t]}hasLayerData(t,i){const r=this.layerInfo[i][t];return!(!r||!r.data||r.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const t of y_){const i=this.layerInfo[t];for(const r of i)if(r.loadingAgent&&r.loadingAgent!==Na&&r.loadingAgent.updating)return!0}return!1}_isSuspended(t){return!!this.hasPendingUpdate(vt.SPLIT)||t!==Lt.ELEVATION&&!this.loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(t){return(this._pendingUpdates&t)===t}setPendingUpdate(t){this._pendingUpdates|=t,t===vt.SPLIT||t===vt.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate()}resetPendingUpdate(t){return!!this.hasPendingUpdate(t)&&(this._pendingUpdates&=~t,!0)}requestLayerData(t,i,r){const s=this.layerInfo[i][t];if(s.waitingAgents.has(r))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),r.tile.lij.toString(),i,t),!0;if(s.waitingAgents.push(r),s.data&&!s.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),r.tile.lij.toString(),i,t),r.dataArrived(this),!0;if(s.requestPromise)return!0;Iu(s.requestAbort),s.requestAbort=new AbortController;const n=this._surface.requestTileData(this,t,i,s.requestAbort);if(!n)return s.requestAbort=null,!1;const o=()=>{s.requestPromise===n&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=n,n.then(o,o),!0}get isLeaf(){return this._children[0]==null}hasLij(t){return this.lij[0]===t[0]&&this.lij[1]===t[1]&&this.lij[2]===t[2]}findByLij(t){return this.hasLij(t)?this:this.isLeaf?null:this._children[0].findByLij(t)||this._children[1].findByLij(t)||this._children[2].findByLij(t)||this._children[3].findByLij(t)||null}distanceToSquared(t){return Go(de(nn,this._center[zo.MIDDLE],t))}containsPoint(t){const i=this.extent;return t[0]>=i[0]&&t[1]>=i[1]&&t[0]<=i[2]&&t[1]<=i[3]}unrequestLayerData(t,i,r){const s=this.layerInfo[i][t],n=s.waitingAgents,o=n.removeUnordered(r)!=null;Rh(o,"agent has not requested this piece of map data"),n.length<1&&(s.abortRequest(),this._updateMemoryUsed())}dataArrived(t,i,r){const s=this.layerInfo[i][t];s.data=r,s.dataInvalidated=!1,s.waitingAgents.forAll(n=>n.dataArrived(this)),s.waitingAgents.clear(),this._updateMemoryUsed()}dataMissing(t,i,r){r.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${i}/${t} error ${r}`);const s=this.layerInfo[i][t];s.dataMissing=!0,s.waitingAgents.forAll(n=>n.dataMissing()),s.waitingAgents.clear(),this._updateMemoryUsed()}updateRenderData(t,i){switch(t){case Lt.MAP:return this._updateTexture(i);case Lt.ELEVATION:return this._updateGeometry()}}_updateTexture(t){this.renderData&&(this.resetPendingUpdate(t===Qs.FADING?vt.TEXTURE_NOFADING:vt.TEXTURE_FADING),this.setPendingUpdate(t===Qs.FADING?vt.TEXTURE_FADING:vt.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(vt.GEOMETRY);for(const t of this.layerInfo[Lt.ELEVATION])t.pendingUpdates|=vt.GEOMETRY}invalidateLayerData(t,i){this.layerInfo[i][t].invalidateSourceData(),this.restartAgents(i)}computeElevationBounds(){rr(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);const t=this.layerInfo[Lt.ELEVATION];let i=!0;for(const r of t)_(r.elevationBounds)&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],r.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],r.elevationBounds.max),r.elevationBounds.hasNoDataValues||(i=!1));i&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0)),this.updateRadiusAndCenter(),this._surface.setTileTreeDirty()}_updateCenter(){const t=.5*(this._elevationBounds[0]+this._elevationBounds[1]);ae(nn,this.up,t),pe(this._center[zo.MIDDLE],this.centerAtSeaLevel,nn),ae(nn,this.up,this._elevationBounds[0]),pe(this._center[zo.TOP],this.centerAtSeaLevel,nn),ae(nn,this.up,this._elevationBounds[1]),pe(this._center[zo.BOTTOM],this.centerAtSeaLevel,nn)}findElevationBoundsForLayer(t,i){const r=this.layerInfo[Lt.ELEVATION][t];if(_(r.elevationBounds)&&r.elevationBounds.level>=i)return;const s=this._surface.layerViewByIndex(t,Lt.ELEVATION),n=yG(s);if(!EC(this,n,!1))return;const o=$ot;let a=!1;if(r.data){const l=r.data;o.min=l.bounds[0],o.max=l.bounds[1],o.hasNoDataValues=l.hasNoDataValues,o.level=this.lij[0],a=!0}else{let l,c,h=0;for(let p=this._parent;p&&(!c||h<s$(this.level))&&(h=this.vlevel-p.level,l=c||l,c=p.layerInfo[Lt.ELEVATION][t].data,!(!c&&l&&h>=s$(this.level)));p=p.parent);c=c||l,c&&(c.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],o),o.min!==1/0&&(o.level=c.level,a=!0))}a&&(R(r.elevationBounds)&&(r.elevationBounds=new sX),r.elevationBounds.copyFrom(o))}modifyLayers(t,i,r){const s=this.layerInfo[r];for(const a of s)a.loadingAgent&&a.loadingAgent!==Na&&(TP(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<s.length;++a)t[a]===void 0&&s[a].release();const n=new Array(...s),o=i.length;s.length=o;for(let a=0;a<o;a++){const l=i[a];s[a]=l>-1?n[l]:D$.acquire(this._surface.upsampleInfoPool)}this._updateMemoryUsed()}restartAgents(t){this.renderData&&(this._createOrUpdateAgents(0,t),this.updateRenderData(t,Qs.FADING))}updateAgents(t){if(this.renderData){const i=this.layerInfo[t];for(const r of i)r.loadingAgent===Na&&(r.loadingAgent=null);this._createOrUpdateAgents(0,t)}}updateAgentSuspension(){for(const t of y_){const i=this._isSuspended(t);for(const r of this.layerInfo[t])r.loadingAgent&&r.loadingAgent!==Na&&(r.loadingAgent.setSuspension(i),r.loadingAgent===Na&&this.updateRenderData(t,Qs.FADING))}}removeLayerAgent(t,i){const r=this.layerInfo[i][t];r.loadingAgent&&r.loadingAgent!==Na&&r.loadingAgent.dispose(),r.loadingAgent=null}agentDone(t,i){const r=this.layerInfo[i][t];r.loadingAgent=Na,r.data||r.upsampleInfo||this._createOrUpdateAgents(t+1,i)}_createOrUpdateAgents(t,i){const r=this._isSuspended(i),s=this.layerInfo[i];for(let n=t;n<s.length;++n){const o=s[n];let a=!1;const l=this._surface.layerViewByIndex(n,i),c=yG(l);if(o.loadingAgent?EC(this,c,!1)?(o.loadingAgent!==Na&&o.loadingAgent.setSuspension(r),o.loadingAgent!==Na&&(a=o.loadingAgent.update())):o.dispose():EC(this,c,!1)&&(o.loadingAgent=Iot(this,n,i,r),a=o.loadingAgent.startLoading(),a?o.loadingAgent===Na&&this.setPendingUpdate(vt.GEOMETRY):(TP(o.loadingAgent),o.loadingAgent=Na)),o.loadingAgent===Na&&this.updateRenderData(i,Qs.FADING),a&&l.isOpaque)return}}_isWithinExtent(t){const i=this.extent;return i[0]>=t[0]&&t[2]>=i[2]&&i[1]>=t[1]&&t[3]>=i[3]}intersectsExtent(t){const i=this.extent;return i[2]>=t[0]&&t[2]>=i[0]&&i[3]>=t[1]&&t[3]>=i[1]}getElevationBasedVerticesPerRow(t){const i=this.vlevel-this.level,r=Math.max(this.level-t,s$(this.level)-i);return Be(1+(this.maxTesselation>>r),2,this.maxTesselation+1)}get test(){return{cachedMemory:this.cachedMemory}}}function Iot(e,t,i,r){const s=i===Lt.ELEVATION?uX.acquire():cX.acquire();return s.init(e,t,i,r),s}function TP(e){e.dispose(),e instanceof F1e?uX.release(e):e instanceof U1e&&cX.release(e)}const cX=new Wr(U1e),uX=new Wr(F1e),$ot=new sX,lE=-1;var zo;(function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"})(zo||(zo={}));class Dot extends lX{constructor(t,i,r){super(),this.horizontalScaleFactor=1,this.isWebmercatorOnPlateeCaree=!1,this.extentInRenderSR=Dt(),t!==void 0&&this.init(t,i,r)}init(t,i,r){super.init(t,i,r);const s=r.view.renderSpatialReference,n=r.spatialReference,o=_(s)&&Oae(s),a=o&&n.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this.horizontalScaleFactor=a,this.isWebmercatorOnPlateeCaree=o&&n.isWebMercator;const l=this.extentInRenderSR,c=this.extent;if(this.isWebmercatorOnPlateeCaree){const h=je(c[0],c[1],0);wn(h,He.WebMercator,h,He.PlateCarree);const p=je(c[2],c[3],0);wn(p,He.WebMercator,p,He.PlateCarree),l[0]=h[0],l[1]=h[1],l[2]=p[0],l[3]=p[1]}else for(let h=0;h<4;++h)l[h]=c[h]*a;this.centerAtSeaLevel[0]=.5*(l[0]+l[2]),this.centerAtSeaLevel[1]=.5*(l[1]+l[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(l[2]-l[0],l[3]-l[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const t=this.extentInRenderSR,i=.5*(t[2]-t[0]),r=.5*(t[3]-t[1]),s=Math.sqrt(i*i+r*r),n=.5*(this.elevationBounds[0]-this.elevationBounds[1]),o=Math.max(s,n);this._center[zo.MIDDLE][3]=o}_isVisible(t){return oje(t,this._aabb())}_aabb(){const t=this.extentInRenderSR;return tAe(t[0],t[1],this.elevationBounds[0],t[2],t[3],this.elevationBounds[1])}intersectsRay(t,i,r,s,n){SP[0]=1/i[0],SP[1]=1/i[1],SP[2]=1/i[2];const o=n*(this.extent[2]-this.extent[0])*this.horizontalScaleFactor*.1;return oW(this._aabb(),t,SP,r+o,s)}createGeometry(t,i){cot(t,this.extent,i,this.horizontalScaleFactor,this.isWebmercatorOnPlateeCaree,this.renderData),this.setMemoryDirty()}getDefaultVerticesPerRowOnLevel(){return this.level<9?3:2}}const SP=M();var HR;(function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"})(HR||(HR={}));class Lot extends lX{constructor(t,i,r){super(),this.obb=new Array(8),this.isWebMercator=!1;for(let s=0;s<8;s++)this.obb[s]=M();t!==void 0&&this.init(t,i,r)}init(t,i,r){super.init(t,i,r),this.isWebMercator=r.tilingScheme.spatialReference.isWebMercator;const s=this.ellipsoid.radius,n=this.extentInRadians[0],o=this.extentInRadians[1],a=this.extentInRadians[2],l=this.extentInRadians[3],c=t[0],h=qt(o,l,.5),p=qt(n,a,.5),f=c===0?0:Math.min(Math.abs(o),Math.abs(l));this._edgeLen=(a-n)*Math.cos(f)*s,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=s-Math.sqrt(s*s-this._edgeLen2/4),v2(this.centerAtSeaLevel,p,h,this.ellipsoid.radius,0);const g=da(this.centerAtSeaLevel);be(g,g),this.up=g,this._updateOBB(),this.updateRadiusAndCenter()}updateRadiusAndCenter(){if(this.lij[0]===0)oe(this._center[Eh.MIDDLE],0,0,0),oe(this._center[Eh.TOP],0,0,0),oe(this._center[Eh.BOTTOM],0,0,0),this.ellipsoid||(this.ellipsoid=di(this.surface.spatialReference)),this._center[Eh.MIDDLE][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const t=Math.max(qn(this._center[Eh.MIDDLE],this.obb[0]),qn(this._center[Eh.MIDDLE],this.obb[1]));this._center[Eh.MIDDLE][3]=Math.sqrt(t)}}_isVisible(t){if(!Qy(t,this._center[Eh.MIDDLE]))return!1;if(this.lij[0]<10)return!0;const i=this.obb;for(let r=0;r<O0.NUM;r++){const s=r===Wi.NEAR,n=t[r];s&&(cE[0]=n[0],cE[1]=n[1],cE[2]=n[2],cE[3]=n[3]-this.surface.view.state.camera.near);const o=s?cE:n;let a;for(a=0;a<8;a++){const l=i[a];if(o[0]*l[0]+o[1]*l[1]+o[2]*l[2]+o[3]<0)break}if(a===8)return!1}return!0}computeElevationBounds(){super.computeElevationBounds(),this._updateOBB()}createGeometry(t,i){const r=this._getPatchType(this.lij[1],this.lij[0]);lot(t,this.extent,i,this.renderData,this.extentInRadians,this.isWebMercator,this.ellipsoid,r),this.setMemoryDirty()}_updateOBB(){const t=this.extentInRadians,i=this.obb;for(let r=0;r<2;r++){const s=this.elevationBounds[r];let n=4*r;v2(i[n++],t[0],t[1],this.ellipsoid.radius,s),v2(i[n++],t[0],t[3],this.ellipsoid.radius,s),v2(i[n++],t[2],t[3],this.ellipsoid.radius,s),v2(i[n++],t[2],t[1],this.ellipsoid.radius,s)}if(this.isWebMercator)switch(this._getPatchType(this.lij[1],this.lij[0])){case uo.HAS_NORTH_POLE:oe(i[1],0,0,this.ellipsoid.radius),oe(i[2],0,0,this.ellipsoid.radius),oe(i[5],0,0,this.ellipsoid.radius),oe(i[6],0,0,this.ellipsoid.radius);break;case uo.HAS_SOUTH_POLE:oe(i[0],0,0,-this.ellipsoid.radius),oe(i[3],0,0,-this.ellipsoid.radius),oe(i[4],0,0,-this.ellipsoid.radius),oe(i[7],0,0,-this.ellipsoid.radius)}}_getPatchType(t,i){return t===(1<<i)-1?t===0?uo.HAS_BOTH_POLES:uo.HAS_SOUTH_POLE:t===0?uo.HAS_NORTH_POLE:uo.REGULAR}intersectsRay(t,i,r,s,n){const o=this._center[Eh.MIDDLE],a=o[3]+r+.2*this.ellipsoid.radius*Math.abs(n*(this.extentInRadians[3]-this.extentInRadians[1])),l=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],c=o[0]-t[0],h=o[1]-t[1],p=o[2]-t[2],f=(c*i[0]+h*i[1]+p*i[2])/l,g=i[0]*f-c,y=i[1]*f-h,v=i[2]*f-p;return g*g+y*y+v*v<a*a}getDefaultVerticesPerRowOnLevel(){return this.level<rse.length?rse[this.level]+1:2}}const rse=[128,64,32,16,16,8,8,4],cE=ii();var Eh;(function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"})(Eh||(Eh={}));class wz{constructor(){this.numVertsPerSide=0,this.wireframe=!1}}class dT{constructor(t){this._getFadeDuration=t,this._fadeStart=0,this._delayedTime=0}clear(){this._current=rt(this._current),this._next=rt(this._next),this._waiting=rt(this._waiting),this._delayed=rt(this._delayed)}get current(){if(R(this._current))return null;if(!this._isFadingEnabled){const i=this._delayed||this._waiting||this._next||this._current;i!==this._current&&(this._current=null,this.clear(),this._current=i)}let t=dT.test.fadeMoment;if(_(this._delayed)&&(t=t||performance.now(),t>=this._delayedTime&&(this._push(this._delayed,xm.Immediate),this._delayed=null)),_(this._next)){t=t||performance.now();const i=this._fadeDuration,r=_(this._current)&&this._next.texture===this._current.texture,s=this._next.type!==Qs.FADING,n=t-this._fadeStart>=i;(r||s||n)&&(rt(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(t))}return this._current}get next(){return this._next}get fadeFactor(){if(R(this._next))return 1;const t=dT.test.fadeMoment||performance.now(),i=Math.max(0,t-this._fadeStart),r=this._fadeDuration;return i>r?0:1-i/r}get isFading(){return _(this._next)||_(this._delayed)}push(t,i=xm.Immediate){this._delayed=rt(this._delayed),this._push(t,i)}_push(t,i){if(this._isFadingEnabled||this.clear(),R(this._current))return void(this._current=t);const r=dT.test.fadeMoment||performance.now();return i!==xm.Immediate?(this._delayed=t,void(this._delayedTime=r+i)):R(this._next)?(this._next=t,void(this._fadeStart=this._alignFadeStart(r))):void(R(t)||(rt(this._waiting),this._waiting=t))}get _fadeDuration(){return R(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(t){const i=this._getFadeDuration();return t+i-t%i}get _isFadingEnabled(){return this._getFadeDuration()>0}}var xm;dT.test={fadeMoment:0},function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(xm||(xm={}));class Not{constructor(){this._scales=[-1,-1,-1,-1],this._offsets=[-1,-1,-1,-1]}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(t,i,r){this._scales[2*t]=i,this._scales[2*t+1]=r}setOffset(t,i,r){this._offsets[2*t]=i,this._offsets[2*t+1]=r}get scales(){return this._scales}get offsets(){return this._offsets}}class Fot{constructor(){this.geometryInfo=new rot,this.intersectionData=null,this.skirtIntersectionData=null,this.geometryState=new wz,this._textureRef=new dT(()=>this.tile.surface.textureFadeDuration),this.overlay=new Not}init(t){this.tile=t,this.clear();const i=this.geometryInfo;i.indices=null,i.vertexAttributes=null,ki(i.boundingBox),i.numSurfaceIndices=0,i.numSkirtIndices=0,i.numWithoutSkirtIndices=0,i.numVertsPerRow=0,this.intersectionData=null,this.skirtIntersectionData=null,this.geometryState=new wz,this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear()}updateGeometry(t,i){return!!this._updateGeometryState(i)&&(this._releaseGeometry(),this._createGeometry(t),!0)}releaseGeometry(){return!!this._releaseGeometry()&&(this.geometryState=new wz,!0)}ensureTexture(t,i){return _(this._texture)&&this._texture.descriptor.width!==t&&this.releaseTexture(),R(this._texture)&&(this._texture=i(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){_(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_updateGeometryState(t){const i=this._getElevationInfo(),r=i.samplerData?this.tile.getElevationBasedVerticesPerRow(i.maxTileLevel):this.tile.getDefaultVerticesPerRowOnLevel();let s=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(s=null);const n=this.geometryState;let o=!1;return n.numVertsPerSide!==r&&(n.numVertsPerSide=r,o=!0),i.changed&&(n.samplerData=i.samplerData,o=!0),y1(n.clippingArea,s)||(n.clippingArea=s,o=!0),n.wireframe!==t&&(n.wireframe=t,o=!0),o}_createGeometry(t){this.tile.createGeometry(this.geometryState,this.localOrigin);const i=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,s=t.gl;this._vao=new us(t,mi,{geometry:Rl(i.layout)},{geometry:jt.createVertex(t,s.STATIC_DRAW,i.buffer)},jt.createIndex(t,s.STATIC_DRAW,r))}_releaseGeometry(){return!!this._vao&&(this._vao.dispose(),this._vao=null,oot(this.geometryInfo),!0)}get vao(){return this._vao}setTextureReference(t,i=xm.Immediate){_(t)&&t.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(t,i)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const t=this.geometryState.samplerData,i=this.tile.layerInfo[Lt.ELEVATION],r=i.length;let s=new Array(r),n=0,o=0,a=!1;for(let l=0;l<r;l++){const c=i[l];if(c.upsampleInfo){const h=c.upsampleInfo.tile,p=h.layerInfo[Lt.ELEVATION][l].data,f=p&&p.samplerData;t&&t[n]===f||(a=!0),s[n++]=f,o=Math.max(o,h.lij[0])}else if(c.data){const h=this.tile.surface.layerViewByIndex(l,Lt.ELEVATION);if(EC(this.tile,h.layer,!1)){const p=c.data;t&&t[n]===p.samplerData||(a=!0),s[n++]=p.samplerData,o=this.tile.level}}}return _(t)&&t.length!==n&&(a=!0),n>0?s.length=n:s=null,{changed:a,samplerData:s,maxTileLevel:o}}get estimatedGeometryMemoryUsage(){const t=tl(this.intersectionData,0,i=>i.estimatedMemoryUsage)+tl(this.skirtIntersectionData,0,i=>i.estimatedMemoryUsage+i.vertexPositionBuffer.byteLength);return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength+t}get textureDescriptor(){return _(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:this._texture!=null}}}class Uot{constructor(){this.extent=ni(),this.minLevel=0,this.maxLevel=0,this.callback=null}}class kot{constructor(){this._queries=new $t({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new $t({initialSize:30}),this._queryPool=new Wr(Uot)}queryVisibleLevelRange(t,i,r,s){const n=this._queryPool.acquire();_a(n.extent,t),n.minLevel=i||-Number.MAX_VALUE,n.maxLevel=r!=null?r:Number.MAX_VALUE,n.callback=s,this._queryQueue.push(n)}hasPendingQueries(){return this._queryQueue.length!==0}prepareQueries(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const t=this._queryQueue.pop();this._queries.push(t)}this._queriesInvPtr=this._queries.length}processQueries(){for(let t=0;t<this._queries.length;t++){const i=this._queries.data[t];this._queryPool.release(i),i.callback(t>=this._queriesInvPtr),i.callback=null}this._queries.clear()}scaleQueriesForTile(t){const i=t.level;let r=0;for(;r<this._queriesInvPtr;){const s=this._queries.data[r],n=s.extent;i>=s.minLevel&&i<=s.maxLevel&&n[0]<=t.extent[2]&&n[2]>=t.extent[0]&&n[1]<=t.extent[3]&&n[3]>=t.extent[1]?(this._queries.swapElements(r,this._queriesInvPtr-1),this._queriesInvPtr--):r++}}}var Tm,tb;(function(e){e[e.Stretch=0]="Stretch",e[e.Lut=1]="Lut",e[e.Hillshade=2]="Hillshade",e[e.COUNT=3]="COUNT"})(Tm||(Tm={})),function(e){e[e.Noop=0]="Noop",e[e.PerBand=1]="PerBand",e[e.COUNT=2]="COUNT"}(tb||(tb={}));function zot(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function Bot(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e}function Vot(e,t,i,r,s,n,o){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e[4]=n,e[5]=o,e}function k1e(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5];let l=i*n-r*s;return l?(l=1/l,e[0]=n*l,e[1]=-r*l,e[2]=-s*l,e[3]=i*l,e[4]=(s*a-n*o)*l,e[5]=(r*o-i*a)*l,e):null}function Got(e){return e[0]*e[3]-e[1]*e[2]}function z1e(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=i[0],h=i[1],p=i[2],f=i[3],g=i[4],y=i[5];return e[0]=r*c+n*h,e[1]=s*c+o*h,e[2]=r*p+n*f,e[3]=s*p+o*f,e[4]=r*g+n*y+a,e[5]=s*g+o*y+l,e}function hX(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=Math.sin(i),h=Math.cos(i);return e[0]=r*h+n*c,e[1]=s*h+o*c,e[2]=r*-c+n*h,e[3]=s*-c+o*h,e[4]=a,e[5]=l,e}function B1e(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=i[0],h=i[1];return e[0]=r*c,e[1]=s*c,e[2]=n*h,e[3]=o*h,e[4]=a,e[5]=l,e}function dX(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=i[0],h=i[1];return e[0]=r,e[1]=s,e[2]=n,e[3]=o,e[4]=r*c+n*h+a,e[5]=s*c+o*h+l,e}function jot(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=-i,e[3]=r,e[4]=0,e[5]=0,e}function Hot(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e}function pX(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e}function qot(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"}function Wot(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2+e[4]**2+e[5]**2+1)}function Xot(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e}function V1e(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e}function Yot(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e}function Zot(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e[4]=t[4]+i[4]*r,e[5]=t[5]+i[5]*r,e}function Qot(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]}function Jot(e,t){const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=t[0],c=t[1],h=t[2],p=t[3],f=t[4],g=t[5];return Math.abs(i-l)<=wt*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(r-c)<=wt*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(s-h)<=wt*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(n-p)<=wt*Math.max(1,Math.abs(n),Math.abs(p))&&Math.abs(o-f)<=wt*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(a-g)<=wt*Math.max(1,Math.abs(a),Math.abs(g))}const Kot=z1e,eat=V1e;Object.freeze({__proto__:null,copy:zot,identity:Bot,set:Vot,invert:k1e,determinant:Got,multiply:z1e,rotate:hX,scale:B1e,translate:dX,fromRotation:jot,fromScaling:Hot,fromTranslation:pX,str:qot,frob:Wot,add:Xot,subtract:V1e,multiplyScalar:Yot,multiplyScalarAndAdd:Zot,exactEquals:Qot,equals:Jot,mul:Kot,sub:eat});function G1e(){const e=new Float32Array(6);return e[0]=1,e[3]=1,e}function tat(e){const t=new Float32Array(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function iat(e,t,i,r,s,n){const o=new Float32Array(6);return o[0]=e,o[1]=t,o[2]=i,o[3]=r,o[4]=s,o[5]=n,o}function rat(e,t){return new Float32Array(e,t,6)}function j1e(e,t,i,r){const s=t[r],n=t[r+1];e[r]=i[0]*s+i[2]*n+i[4],e[r+1]=i[1]*s+i[3]*n+i[5]}function sat(e,t,i,r=0,s=0,n=2){const o=s||t.length/n;for(let a=r;a<o;a++)j1e(e,t,i,a*n)}Object.freeze({__proto__:null,create:G1e,clone:tat,fromValues:iat,createView:rat,transform:j1e,transformMany:sat});function N$(){return[1,0,0,1,0,0]}function nat(e){return[e[0],e[1],e[2],e[3],e[4],e[5]]}function oat(e,t,i,r,s,n){return[e,t,i,r,s,n]}function aat(e,t){return new Float64Array(e,t,6)}Object.freeze({__proto__:null,create:N$,clone:nat,fromValues:oat,createView:aat});function lat(e){return e instanceof Float32Array&&e.length>=2}function cat(e){return Array.isArray(e)&&e.length>=2}function xz(e){return lat(e)||cat(e)}const uat=96,hat=39.37;function fX(e,t){return t.type?rr(e,t.x,t.y):zs(e,t)}function dat(e){return Cl(e)}function pat(e,t){const i=e.targetGeometry,r=t.targetGeometry;return i.x=r.x,i.y=r.y,i.spatialReference=r.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}const fat=function(){const e=Ye();return function(t,i,r){const s=i.targetGeometry;fX(e,s);const n=.5*X4(i);return t.xmin=e[0]-n*r[0],t.ymin=e[1]-n*r[1],t.xmax=e[0]+n*r[0],t.ymax=e[1]+n*r[1],t.spatialReference=s.spatialReference,t}}();function X4(e){return e.scale*mat(e.targetGeometry)}function mat(e){return _(e)&&_c(e.spatialReference)?1/(dat(e.spatialReference)*hat*uat):1}function gat(e){return xN(e.rotation)||0}const mX=function(){const e=Ye(),t=Ye(),i=Ye();return function(r,s,n,o,a,l){return hq(e,s),nl(t,n,.5*l),rr(i,1/o*l,-1/o*l),pX(r,t),a&&hX(r,r,a),B1e(r,r,i),dX(r,r,e),r}}(),yat=function(){const e=Ye();return function(t,i,r,s){const n=X4(i),o=gat(i);return fX(e,i.targetGeometry),mX(t,e,r,n,o,s)}}(),vat=function(){const e=Ye();return function(t,i,r,s){const n=X4(i);return fX(e,i.targetGeometry),mX(t,e,r,n,0,s)}}();function _at(e){if(e.isWrappable){const t=s0(e);return t.valid[1]-t.valid[0]}return 0}function bat(e,t){return Math.round(_at(e)/t)}var xG;const uf=[0,0];let dy=xG=class extends fe{constructor(e){super(e),this._viewpoint2D={center:Ye(),rotation:0,scale:0,spatialReference:null},this.center=[0,0],this.extent=new Xt,this.id=0,this.inverseTransform=N$(),this.resolution=0,this.rotation=0,this.scale=0,this.transform=N$(),this.transformNoRotation=N$(),this.displayMat3=wm(),this.displayViewMat3=wm(),this.viewMat3=wm(),this.viewMat2d=G1e(),this.worldScreenWidth=0,this.size=[0,0]}set pixelRatio(e){this._set("pixelRatio",e),this._update()}set size(e){this._set("size",e),this._update()}set viewpoint(e){if(e){const t=this._viewpoint2D,i=e.targetGeometry;t.center[0]=i.x,t.center[1]=i.y,t.rotation=e.rotation,t.scale=e.scale,t.spatialReference=i.spatialReference}this._update()}copy(e){const t=this.size,i=this.viewpoint;return i&&t?(this.viewpoint=pat(i,e.viewpoint),this._set("size",zs(t,e.size))):(this.viewpoint=e.viewpoint.clone(),this._set("size",[e.size[0],e.size[1]])),this._set("pixelRatio",e.pixelRatio),this}clone(){return new xG({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})}toMap(e,t,i){return xz(t)?h_(e,t,this.inverseTransform):(uf[0]=t,uf[1]=i,h_(e,uf,this.inverseTransform))}toScreen(e,t,i){return xz(t)?h_(e,t,this.transform):(uf[0]=t,uf[1]=i,h_(e,uf,this.transform))}toScreenNoRotation(e,t,i){return xz(t)?h_(e,t,this.transformNoRotation):(uf[0]=t,uf[1]=i,h_(e,uf,this.transformNoRotation))}getScreenTransform(e,t){const{center:i}=this._viewpoint2D,r=this._get("pixelRatio")||1,s=this._get("size");return mX(e,i,s,t,0,r),e}_update(){const{center:e,spatialReference:t,scale:i,rotation:r}=this._viewpoint2D,s=this._get("pixelRatio")||1,n=this._get("size"),o=new xl({targetGeometry:new et(e[0],e[1],t),scale:i,rotation:r});if(this._set("viewpoint",o),!n||!t||!i)return;this.resolution=X4(o),this.rotation=r,this.scale=i,this.spatialReference=t,zs(this.center,e);const a=n[0]!==0?2/n[0]:0,l=n[1]!==0?-2/n[1]:0;wq(this.displayMat3,a,0,0,0,l,0,-1,1,1);const c=xq(this.viewMat3),h=yu(n[0]/2,n[1]/2),p=yu(-n[0]/2,-n[1]/2),f=xN(r);wL(c,c,h),Tq(c,c,f),wL(c,c,p),qF(this.displayViewMat3,this.displayMat3,c);const g=pX(this.viewMat2d,h);return hX(g,g,f),dX(g,g,p),fat(this.extent,o,n),yat(this.transform,o,n,s),k1e(this.inverseTransform,this.transform),vat(this.transformNoRotation,o,n,s),this.worldScreenWidth=bat(this.spatialReference,this.resolution),this._set("id",this.id+1),this}};u([d({readOnly:!0})],dy.prototype,"id",void 0),u([d({value:1,json:{write:!0}})],dy.prototype,"pixelRatio",null),u([d({json:{write:!0}})],dy.prototype,"size",null),u([d()],dy.prototype,"spatialReference",void 0),u([d({type:xl,json:{write:!0}})],dy.prototype,"viewpoint",null),dy=xG=u([P("esri.views.2d.ViewState")],dy);const wat=dy,xat=.125;class Tat{constructor(){this._renderParams={context:null,drawPhase:1,state:new wat({viewpoint:new xl({targetGeometry:new et(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1}}dispose(){this._renderParams=null}render(t,i,r,s,n,o,a,l,c,h){const p=o.adjustLevel(i[0]),f=this._renderParams;f.context=t,f.painter=s,f.glyphMosaic=s.glyphMosaic,f.spriteMosaic=s.spriteMosaic,f.pixelRatio=h,f.displayLevel=p,f.requiredLevel=p;const g=o.getScale(i[0]),[y,v]=o.getShift(i,a*g),b=xat*a*g/c,w=r.transforms.dvs;w[0]=b,w[4]=-b,w[6]=-1-y-l[0]*a*2,w[7]=1+v+(1-l[1])*a*2-2,f.state.size[0]=c,f.state.size[1]=c,r.stage||r.attachWithContext(t),r.triangleCount=0,s.drawTile(f,r,n)}}var Bu;(function(e){e[e.NoAlpha=0]="NoAlpha",e[e.SourceAlpha=1]="SourceAlpha",e[e.OneMinusSourceAlpha=2]="OneMinusSourceAlpha",e[e.COUNT=3]="COUNT"})(Bu||(Bu={}));function Sat(){const e=new Oi;return e.attributes.add(E.POSITION,"vec2"),e.attributes.add(E.UV0,"vec2"),e.vertex.uniforms.add("scale","float"),e.vertex.uniforms.add("offset","vec2"),e.varyings.add("uv","vec2"),e.vertex.code.add(x`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
}`),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("opacity","float"),e.fragment.code.add(x`void main() {
vec4 color = texture2D(tex, uv);
gl_FragColor = vec4(color.xyz, 1.0) * color.a * opacity;
}`),e}const Eat=Object.freeze({__proto__:null,build:Sat});class qR extends Gi{initializeProgram(t){const i=qR.shader.get().build();return new Mi(t.rctx,i,mi)}initializePipeline(){const t=this.configuration.mode===Bu.OneMinusSourceAlpha?Sc(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA):this.configuration.mode===Bu.SourceAlpha?Sc(Ee.ZERO,Ee.SRC_ALPHA):null;return Ot({blending:t,colorWrite:Ft})}}qR.shader=new Ni(Eat,()=>import("./BlendLayers.glsl.f46a9d77.js"));class TG extends mr{constructor(){super(...arguments),this.mode=Bu.NoAlpha}}u([Z({count:Bu.COUNT})],TG.prototype,"mode",void 0);function Aat(e){e.attributes.add(E.POSITION,"vec2"),e.attributes.add(E.UV0,"vec2"),e.vertex.uniforms.add("u_scale","float"),e.vertex.uniforms.add("u_offset","vec2"),e.varyings.add("v_texcoord","vec2"),e.vertex.code.add(x`void main(void) {
v_texcoord = uv0 * u_scale + u_offset;
gl_Position = vec4(position, 0.0, 1.0);
}`)}function Cat(e){e.fragment.uniforms.add("u_colormap","sampler2D"),e.fragment.uniforms.add("u_colormapOffset","float"),e.fragment.uniforms.add("u_colormapMaxIndex","float"),e.fragment.code.add(x`vec4 colormap(vec4 currentPixel, bool isFloat) {
float clrIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || clrIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 clrPosition = vec2((clrIndex + 0.5) / (u_colormapMaxIndex + 1.0), 0.0);
vec4 color = texture2D(u_colormap, clrPosition);
result = vec4(color.rgb, 1.0) * color.a * u_opacity;
}
return result;
}`)}function Rat(e){e.fragment.uniforms.add("u_transformGrid","sampler2D"),e.fragment.uniforms.add("u_transformSpacing","vec2"),e.fragment.uniforms.add("u_transformGridSize","vec2"),e.fragment.uniforms.add("u_targetImageSize","vec2"),e.fragment.code.add(x`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(0.25 / u_transformGridSize.s, 1.0 / u_transformGridSize.t);
vec2 index_transform = floor(index_image / u_transformSpacing) / u_transformGridSize;
vec2 pos = fract((index_image + vec2(0.5, 0.5)) / u_transformSpacing);
vec2 srcLocation;
vec2 transform_location = index_transform + oneTransformPixel * 0.5;
if (pos.s <= pos.t) {
vec4 ll_abc = texture2D(u_transformGrid, vec2(transform_location.s, transform_location.t));
vec4 ll_def = texture2D(u_transformGrid, vec2(transform_location.s + oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ll_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ll_def.rgb, vec3(pos, 1.0));
} else {
vec4 ur_abc = texture2D(u_transformGrid, vec2(transform_location.s + 2.0 * oneTransformPixel.s, transform_location.t));
vec4 ur_def = texture2D(u_transformGrid, vec2(transform_location.s + 3.0 * oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ur_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ur_def.rgb, vec3(pos, 1.0));
}
return srcLocation;;
}`)}function Oat(e){e.include(Rat),e.fragment.uniforms.add("u_image","sampler2D"),e.fragment.uniforms.add("u_isFloatTexture","bool"),e.fragment.uniforms.add("u_flipY","bool"),e.fragment.uniforms.add("u_applyTransform","bool"),e.fragment.uniforms.add("u_opacity","float"),e.fragment.code.add(x`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}
vec4 getPixel(vec2 pixelLocation) {
return texture2D(u_image, pixelLocation);
}`)}function Mat(e){const t=new Oi;return t.include(Aat),t.include(Oat),t.include(Cat),e.output===Tm.Stretch?Iat(t,e):e.output===Tm.Lut?Pat(t):e.output===Tm.Hillshade&&$at(t,e),t}function Pat(e){e.fragment.code.add(x`void main() {
vec2 pixelLocation = getPixelLocation(v_texcoord);
if (isOutside(pixelLocation)) {
gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
return;
}
vec4 currentPixel = getPixel(pixelLocation);
gl_FragColor = colormap(currentPixel, true);
}`)}function Iat(e,t){e.fragment.uniforms.add("u_bandCount","int"),e.fragment.uniforms.add("u_minCutOff","float",3),e.fragment.uniforms.add("u_maxCutOff","float",3),e.fragment.uniforms.add("u_factor","float",3),e.fragment.uniforms.add("u_minOutput","float"),e.fragment.uniforms.add("u_maxOutput","float"),e.fragment.uniforms.add("u_useGamma","bool"),e.fragment.uniforms.add("u_gamma","float",3),e.fragment.uniforms.add("u_gammaCorrection","float",3),e.fragment.code.add(x`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=t.applyColormap?x`gl_FragColor = colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma);`:x`gl_FragColor = vec4(grayVal, grayVal, grayVal, 1.0) * currentPixel.a * u_opacity;`;e.fragment.code.add(x`
      void main() {
        vec2 pixelLocation = getPixelLocation(v_texcoord);
        if (isOutside(pixelLocation)) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${t.stretchType===tb.Noop?x`
        gl_FragColor = vec4(currentPixel.rgb, 1.0) * currentPixel.a * u_opacity;`:x`
        if (currentPixel.a == 0.0) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${i}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = vec4(redVal, greenVal, blueVal, 1.0) * currentPixel.a * u_opacity;
        }`}
      }`)}function $at(e,t){e.fragment.uniforms.add("u_hillshadeType","int"),e.fragment.uniforms.add("u_sinZcosAs","float",6),e.fragment.uniforms.add("u_sinZsinAs","float",6),e.fragment.uniforms.add("u_cosZs","float",6),e.fragment.uniforms.add("u_weights","float",6),e.fragment.uniforms.add("u_factor","vec2"),e.fragment.uniforms.add("u_applyColormap","bool"),e.fragment.uniforms.add("u_minValue","float"),e.fragment.uniforms.add("u_maxValue","float"),e.fragment.uniforms.add("u_srcImageSize","vec2"),e.fragment.include(Vp),e.fragment.code.add(x`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 rgb = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(rgb.xyz);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv) * alpha, alpha);
}`),e.fragment.code.add(x`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const i=t.applyColormap?x`gl_FragColor = overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha);`:x`hillshade *= alpha;
gl_FragColor = vec4(hillshade, hillshade, hillshade, alpha);`;e.fragment.code.add(x`
    void main() {
      vec2 pixelLocation = getPixelLocation(v_texcoord);
      if (isOutside(pixelLocation)) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}
    }
  `)}const Dat=Object.freeze({__proto__:null,build:Mat});class Y4 extends Gi{get uniformLocationInfos(){return this._uniformLocationInfos||(this._uniformLocationInfos=Cot(this._context,this.program)),this._uniformLocationInfos}initializeProgram(t){const i=Y4.shader.get(),r=this.configuration,s=i.build({output:r.colorizerType,applyColormap:r.applyColormap,stretchType:r.stretchType});return this._context=t.rctx,new Mi(t.rctx,s,mi)}initializePipeline(){const t=this.configuration.mode===Bu.OneMinusSourceAlpha?Sc(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA):this.configuration.mode===Bu.SourceAlpha?Sc(Ee.ZERO,Ee.SRC_ALPHA):null;return Ot({blending:t,colorWrite:Ft})}bindPass(t){aE(this.program,this.uniformLocationInfos,t.basic),aE(this.program,this.uniformLocationInfos,t.common),_(t.colormap)&&aE(this.program,this.uniformLocationInfos,t.colormap),this.configuration.colorizerType===Tm.Stretch&&_(t.stretch)?aE(this.program,this.uniformLocationInfos,t.stretch):this.configuration.colorizerType===Tm.Hillshade&&_(t.hillshade)&&aE(this.program,this.uniformLocationInfos,t.hillshade)}}Y4.shader=new Ni(Dat,()=>import("./RasterColorizer.glsl.d10ae9a4.js"));class RA extends mr{constructor(){super(...arguments),this.mode=Bu.OneMinusSourceAlpha,this.colorizerType=Tm.Stretch,this.stretchType=tb.Noop,this.applyColormap=!0}}u([Z({count:Bu.COUNT})],RA.prototype,"mode",void 0),u([Z({count:Tm.COUNT})],RA.prototype,"colorizerType",void 0),u([Z({count:tb.COUNT})],RA.prototype,"stretchType",void 0),u([Z()],RA.prototype,"applyColormap",void 0);class Tz{constructor(t,i,r,s,n,o,a){this.texture=t,this.type=i,t.retain(),this.offsetAndScale=yi(r.offset[0],r.offset[1],r.scale,r.scale),this.opacities=je(s,a?o:0,n)}destroy(){this.texture.release()}}class Lat{constructor(t){this._rctx=t,this._pools=new Map}acquire(t){return this._getPool(t).acquire()}release(t){this._getPool(t.width).release(t)}clear(){this._pools.forEach(t=>t.destroy()),this._pools.clear()}_getPool(t){let i=this._pools.get(t);if(!i){const r=zi.bind(zi,this._rctx,{colorTarget:vr.TEXTURE,depthStencilTarget:ti.DEPTH_RENDER_BUFFER,width:t,height:t});i=new Wr(r),this._pools.set(t,i)}return i}}class Nat{constructor(t,i,r){this._rctx=t,this.tileSize=i,this._techniqueRepository=r,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new Tat,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._vaoQuad=bo(this._rctx,RO),this._blackTex=new Cy(cee(this._rctx,[0,0,0,1])),this._fboPool=new Lat(this._rctx)}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=tt(this._vaoQuad),this._backgroundTexture=Xi(this._backgroundTexture),this._blackTex=Xi(this._blackTex),this._blendLayersTechnique=Xi(this._blendLayersTechnique),this._applyOpacityTechnique=Xi(this._applyOpacityTechnique),this._vectorTileHelper=tt(this._vectorTileHelper)}get blendLayersTechnique(){if(R(this._blendLayersTechnique)){const t=new TG;t.mode=Bu.OneMinusSourceAlpha,this._blendLayersTechnique=this._techniqueRepository.acquire(qR,t)}return this._blendLayersTechnique}get applyOpacityTechnique(){if(R(this._applyOpacityTechnique)){const t=new TG;t.mode=Bu.SourceAlpha,this._applyOpacityTechnique=this._techniqueRepository.acquire(qR,t)}return this._applyOpacityTechnique}get backgroundIsGrid(){return this._backgroundIsGrid}get backgroundColor(){return this._backgroundColor}updateTileTexture(t,i){const r=t.layerInfo[Lt.MAP];for(const v of r)v.pendingUpdates&=~(vt.TEXTURE_NOFADING&vt.TEXTURE_FADING);if(!t.renderData)return;const s=t.surface,n=s.baseOpacity;let o=0,a=0,l=this.tileSize,c=!1;const h=s.view.pixelRatio;let p=r.length,f=0;for(;f<r.length&&!c;f++){const v=s.layerViewByIndex(f,Lt.MAP),b=v.fullOpacity;if(Ez[f]=b,che(v.layer)&&p>=r.length&&(p=f),b===0)continue;++a;const w=Sz(t,f,Az);w&&(aN(v)?l=Math.max(l,this.tileSize*h):n===1&&b===1&&(v.isOpaque||this._dataToTexture(w)&&w.sourceLayerInfo.data.descriptor.isOpaque)&&(c=!0),++o)}this._cleanupFBOPool(h,r.length),l=Fat(l);const g=l/this.tileSize,y=f-1;o!==0?o===1&&(c||this._backgroundIsGrid||_(this._backgroundColor))&&this._useLayerTexture(t,y,p,Ez[y])||this._composeMapLayers(t,i,y,p,c,Ez,l,g):this._useBackgroundTexture(t,a)}_useBackgroundTexture(t,i){let r=xm.Immediate;(t.surface.view.layerViewManager.updating||i>0)&&(r=xm.Delayed),this._backgroundTexture&&R(t.renderData.textureReference)&&(r=xm.Immediate),t.renderData.setTextureReference(_(this._backgroundTexture)?new Tz(this._backgroundTexture,Qs.FADING,sse,t.surface.baseOpacity,1,1,!1):null,r)}_useLayerTexture(t,i,r,s){const n=i<r,o=n?1:t.surface.baseOpacity,a=n?t.surface.baseOpacity:1,l=Sz(t,i,Az);return!!this._dataToTexture(l)&&(t.renderData.setTextureReference(new Tz(l.sourceLayerInfo.data,Qs.FADING,l,o,s,a,!0)),!0)}_composeMapLayers(t,i,r,s,n,o,a,l){const c=this._rctx,h=this._fboPool.acquire(a);c.bindFramebuffer(h),c.setViewport(0,0,a,a),c.setClearColor(0,0,0,0),c.setClearDepth(1),c.clearSafe(bi.COLOR_BUFFER_BIT|bi.DEPTH_BUFFER_BIT);let p=!1;!n&&_(this._backgroundTexture)&&this._drawRasterData(this.blendLayersTechnique,this._backgroundTexture.texture,1,lV);const f=t.surface.baseOpacity;let g=!1,y=Ge.LINEAR_MIPMAP_LINEAR;for(let T=r;T>=0;T--){const A=Sz(t,T,Az);A&&(T<s&&f<1&&!g&&(this._drawRasterData(this.applyOpacityTechnique,this._blackTex.texture,1,lV,f),g=!0),o[T]!==0&&(nnt(A)?p=this._drawVectorData(this.blendLayersTechnique,A,l,o[T],a,h,p):snt(A)?(this._drawImageryTileData(A,o[T]),this._hasNearestInterpolation(A)&&(y=Ge.NEAREST)):this._dataToTexture(A)&&this._drawRasterData(this.blendLayersTechnique,A.sourceLayerInfo.data.texture,A.scale,A.offset,o[T])))}const v=t.renderData.ensureTexture(a,()=>this._buildTexture(a,y)),b=c.bindTexture(v.texture,Qe.TEXTURE_UNIT_FOR_UPDATES),w=v.descriptor;c.gl.copyTexImage2D(c.gl.TEXTURE_2D,0,w.pixelFormat,0,0,w.width,w.height,0),v.generateMipmap(),c.bindTexture(b,Qe.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(null),this._fboPool.release(h);const S=g?1:f;t.renderData.setTextureReference(new Tz(v,i,sse,S,1,1,!1))}_drawQuad(t){this._rctx.bindVAO(this._vaoQuad),t.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(Tt.TRIANGLE_STRIP,0,vn(this._vaoQuad,"geometry"))}_drawRasterData(t,i,r,s,n=1){if(R(i))return;const o=this._rctx.useTechnique(t);o.bindTexture(i,"tex"),o.setUniform1f("scale",r),o.setUniform2f("offset",s[0],s[1]),o.setUniform1f("opacity",n),this._drawQuad(o)}_hasNearestInterpolation(t){const i=t.sourceLayerInfo.data;return!!i.source&&i.interpolation==="nearest"}_drawImageryTileData(t,i=1){const r=t.sourceLayerInfo.data;if(!r.source)return;t.tile.surface.layerViewByIndex(t.layerIndex,Lt.MAP).ensureSymbolizerParameters(r);const s=this._getRasterColorizerTechnique(r),n=this._rctx,o=n.useTechnique(s);if(!r.bind(n))return;r.opacity=i,r.scale=t.scale,r.offset=t.offset;const{names:a,textures:l}=r.getTextures();a.forEach((c,h)=>o.bindTexture(l[h],c)),s.bindPass(r.getUniforms()),this._drawQuad(o),n.bindVAO()}_getRasterColorizerTechnique(t){const i=t.symbolizerParameters,r=["stretch","lut","hillshade"].indexOf(i.type);return R(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new RA,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=!!i.colormap,this._rasterColorizerConfig.stretchType=t.hasStretchTypeNone()?tb.Noop:tb.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(Y4,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(t,i,r,s,n,o,a){const l=this._rctx,c=i.sourceLayerInfo.data,h=i.tile.surface.layerViewByIndex(i.layerIndex,Lt.MAP);let p;return t.bindPipelineState(l),s<1?(p=this._fboPool.acquire(n),l.bindFramebuffer(p),l.setClearColor(1,1,1,0),l.clearSafe(bi.COLOR_BUFFER_BIT|bi.DEPTH_BUFFER_BIT)):a&&l.clearSafe(bi.DEPTH_BUFFER_BIT),this._vectorTileHelper.render(l,i.sourceLod,c,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/i.scale),i.offset,this.tileSize,r),!_(p)||(l.bindFramebuffer(o),this._drawRasterData(t,p.colorTexture,1,[0,0],s),this._fboPool.release(p),a)}_dataToTexture(t){return ant(t)&&this._rasterDataToTexture(t),ont(t)}_rasterDataToTexture(t){const i=t.sourceLayerInfo;i.data=this._buildTexture(i.data),t.tile.setMemoryDirty()}setBackground(t,i){Xi(this._backgroundTexture),this._backgroundIsGrid=i,t instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(t),this._backgroundColor=null):(this._backgroundTexture=new Cy(cee(this._rctx,yi(t[0]||0,t[1]||0,t[2]||0,1))),this._backgroundColor=je(t[0]||0,t[1]||0,t[2]||0))}_buildTexture(t,i=Ge.LINEAR_MIPMAP_LINEAR){if(R(t))return null;const r={target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE,samplingMode:i,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},s=this._rctx;let n;if(typeof t=="number")r.width=r.height=t,n=new Cy(new Qe(s,r));else if(t instanceof GR)r.isOpaque=t.isOpaque,n=new Cy(new Qe(s,r,t.image)),t.release();else try{n=new Cy(new Qe(s,r,t))}catch{n=new Cy(xge(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=s.bindTexture(n.texture,Qe.TEXTURE_UNIT_FOR_UPDATES);return n.generateMipmap(),s.bindTexture(o,Qe.TEXTURE_UNIT_FOR_UPDATES),n}_cleanupFBOPool(t,i){t===this._lastPixelRatio&&i===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=t,this._lastNumLayers=i)}get test(){return{backgroundTexture:this._backgroundTexture}}}function Fat(e){const t=wT(e),i=t*t,r=e*e;if(i===r)return e;const s=t/2;return i-r<r-s*s?t:s}function Sz(e,t,i){i.layerIndex=t;const r=e.layerInfo[Lt.MAP][t];if(r.data)return rr(i.offset,0,0),i.tile=e,i.scale=1,i.sourceLod=e.lij,i.sourceLayerInfo=r,i;const s=r.upsampleInfo;if(s){const n=s.tile.layerInfo[Lt.MAP][t];return i.tile=s.tile,zs(i.offset,s.offset),i.scale=s.scale,i.sourceLod=s.tile.lij,i.sourceLayerInfo=n,i}return null}const Ez=new Array,Az={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},sse={offset:[0,0],scale:1},SG=40,nse=20,Uat=.8,kat=15,OA=1e-6;function zat(e,t,i){const r=t,s=i;let n=0,o=1/0;for(let a=0;a<3;++a){{const l=e[a];if(r[a]<l){if(s[a]<=OA)return!1;const c=(l-r[a])/s[a];n=Math.max(n,c)}else if(s[a]<=-OA){const c=(l-r[a])/s[a];o=Math.min(o,c)}if(n>o)return!1}{const l=e[a+3];if(r[a]>l){if(s[a]>=-OA)return!1;const c=(l-r[a])/s[a];n=Math.max(n,c)}else if(s[a]>=OA){const c=(l-r[a])/s[a];o=Math.min(o,c)}if(n>o)return!1}}return!0}class ose{constructor(t,i,r,s,n){this.aabb=t,this.axis=i,this.d=r,this.midStartIndex=s,this.rightStartIndex=n}}class ib{constructor(t,i,r,s){this.globalTriangleVertexIndices=t,this.firstTriangleIndex=i,this.positionAttribute=s,this.rayDirection=M(),this.bspNodeTree=new Array,this.vertexPositionBuffer=s.data,this.vertexPositionStride=s.stride;const n=r-i,o=n<=H1e?new Uint16Array(n):new Uint32Array(n);this.indices=o;for(let a=0;a<n;++a)o[a]=a;{const a=Hat(t,i,r,s.data,s.stride),l=(c,h,p)=>{const f=Gat(o,a,c,h),g=h-c;if(g<=nse){const T=new ose(f,void 0,0,c,h);return this.bspNodeTree.push(T),T}const{axis:y,midValue:v}=jat(f),b=Vat(o,a,c,h,y,v),w=(T,A)=>{if(p>kat)return;const C=A-T;return C<nse||C>=Uat*g?void 0:l(T,A,p+1)},S=new ose(f,y,v,b.next,b.mid);return this.bspNodeTree.push(S),S.leftNode=w(c,b.next),S.rightNode=w(b.mid,h),S};l(0,n,0),this.triangleVertexIndices=qat(o,t,i,r)}}intersectRayTriangleRange(t,i){{if(t>=i)return;const r=this.triangleVertexIndices,s=this.positionAttribute.data,n=this.positionAttribute.stride,o=this.rayOrigin,a=o[0],l=o[1],c=o[2],h=this.rayDirection,p=h[0],f=h[1],g=h[2];for(let y=t,v=3*t;y<i;++y){const b=r[v]*n,w=s[b],S=s[b+1],T=s[b+2],A=r[v+1]*n,C=s[A],O=s[A+1],L=s[A+2],U=r[v+2]*n,N=s[U],z=s[U+1],V=s[U+2];v+=3;const B=C-w,J=O-S,Q=L-T,te=N-w,ie=z-S,$=V-T,F=f*$-ie*g,k=g*te-$*p,G=p*ie-te*f,W=B*F+J*k+Q*G;if(Math.abs(W)<=Number.EPSILON)continue;const K=a-w,H=l-S,ee=c-T,ye=K*F+H*k+ee*G;if(W>0){if(ye<0||ye>W)continue}else if(ye>0||ye<W)continue;const Ae=H*Q-J*ee,Ve=ee*B-Q*K,Se=K*J-B*H,xe=p*Ae+f*Ve+g*Se;if(W>0){if(xe<0||ye+xe>W)continue}else if(xe>0||ye+xe<W)continue;const Re=(te*Ae+ie*Ve+$*Se)/W;if(Re>=0){const ze=this.indices[y]+this.firstTriangleIndex,ji=NO(B,J,Q,te,ie,$,Bat);this.callback(Re,ji,ze,!1)}}}ib.numFacesTested+=i-t}intersectRay(t,i){ib.numFacesTested=0;const r=je(t.r0[0],t.r0[1],t.r0[2]),s=je(t.r1[0],t.r1[1],t.r1[2]),n=s[0]-r[0],o=s[1]-r[1],a=s[2]-r[2];if(n*n+o*o+a*a<OA)return;this.rayOrigin=r;const l=this.rayDirection;l[0]=n,l[1]=o,l[2]=a;const c=this.triangleVertexIndices.length/3;this.callback=i;const h=this.bspNodeTree[0];this.intersectRayBSP(h,0,c)}intersectRayBSP(t,i,r){const s=this.rayOrigin,n=this.rayDirection;if(!zat(t.aabb,s,n))return;const o=t.axis,a=t.d;if(s[o]<a||n[o]<0){const l=i,c=t.midStartIndex;if(l<c){const h=t.leftNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}if(this.intersectRayTriangleRange(t.midStartIndex,t.rightStartIndex),s[o]>a||n[o]>0){const l=t.rightStartIndex,c=r;if(l<c){const h=t.rightNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}}ib.numFacesTested=0;const Bat=M(),ow=[1/0,1/0,1/0],aw=[-1/0,-1/0,-1/0];function Vat(e,t,i,r,s,n){let o=i,a=r;for(;o<a;){const c=e[o];t[6*c+s+3]<=n?++o:(--a,e[o]=e[a],e[a]=c)}let l=o;for(a=r;l<a;){const c=e[a-1];t[6*c+s]>=n?--a:(e[a-1]=e[l],e[l]=c,++l)}return{next:o,mid:l}}function Gat(e,t,i,r){if(r<=i)return C1(NaN,NaN,NaN,NaN,NaN,NaN);{const s=6*e[i];for(let n=0;n<3;++n)ow[n]=t[s+0+n],aw[n]=t[s+3+n]}for(let s=i+1;s<r;++s){const n=6*e[s];for(let o=0;o<3;++o)ow[o]=Math.min(ow[o],t[n+0+o]),aw[o]=Math.max(aw[o],t[n+3+o])}return C1(ow[0],ow[1],ow[2],aw[0],aw[1],aw[2])}function jat(e){const t=e[3]-e[0],i=e[4]-e[1],r=e[5]-e[2],s=t>i?t>r?0:i>r?1:2:i>r?1:r>t?2:0;return{axis:s,midValue:(e[s]+e[s+3])/2}}function Hat(e,t,i,r,s){const n=i-t,o=new Float32Array(6*n);for(let a=0;a<n;++a){const l=3*(a+t),c=e[l+0]*s,h=e[l+1]*s,p=e[l+2]*s;for(let f=0;f<3;++f){const g=r[c+f],y=r[h+f],v=r[p+f];o[6*a+f]=Math.min(g,y,v),o[6*a+3+f]=Math.max(g,y,v)}}return o}function qat(e,t,i,r){const s=r-i;let n=0;for(let a=i;a<r;++a)for(let l=0;l<3;++l)n=Math.max(t[3*a+l],n);const o=n<=H1e?new Uint16Array(3*s):new Uint32Array(3*s);for(let a=0;a<s;++a){const l=3*(e[a]+i);for(let c=0;c<3;++c){const h=t[l+c];o[3*a+c]=h}}return o}const H1e=65535;var _u;function EG(e,t){e.extensions.add("GL_OES_standard_derivatives"),t.pbrMode!==xt.Water&&t.pbrMode!==xt.WaterOnIntegratedMesh||e.include(Pve,t),e.vertex.uniforms.add("overlayTexOffset","vec4"),e.vertex.uniforms.add("overlayTexScale","vec4"),e.varyings.add("vtcOverlay","vec4"),e.vertex.code.add(x`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),e.fragment.uniforms.add("ovColorTex","sampler2D"),e.fragment.uniforms.add("overlayOpacity","float"),e.fragment.code.add(x`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),e.fragment.code.add(x`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),t.pbrMode!==xt.Water&&t.pbrMode!==xt.WaterOnIntegratedMesh||(e.include(GF),e.fragment.code.add(x`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, lightingMainDirection, colorInput.rgb, lightingMainIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}(function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"})(_u||(_u={}));function Wat(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.viewingMode===Ie.Global?e.vertex.code.add(x`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(x`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(x`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}function Xat(e){e.vertex.code.add(x`vec3 applySkirts(inout vec2 uv, vec3 vpos, vec3 vnormal, float skirtScale) {
float skirtLength = 0.0;
if (uv.x >= 2.0) {
skirtLength = uv.y * skirtScale;
vec2 x = vec2(uv.x) - vec2(3.5, 4.5);
uv = clamp(vec2(1.5) - abs(x), vec2(0.0), vec2(1.0));
}
return vpos - vnormal * skirtLength;
}`)}function Yat(e,t){e.varyings.add("vtc","vec2"),e.vertex.uniforms.add("texOffsetAndScale","vec4"),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("textureOpacities","vec3"),t.textureFadingEnabled&&(e.vertex.uniforms.add("nextTexOffsetAndScale","vec4"),e.varyings.add("nvtc","vec2"),e.fragment.uniforms.add("texNext","sampler2D"),e.fragment.uniforms.add("nextTexOpacities","vec3"),e.fragment.uniforms.add("fadeFactor","float")),e.vertex.code.add(x`
  void forwardTextureCoordinates(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${t.textureFadingEnabled?x`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:x``}
  }`),t.useGrid?(e.fragment.code.add(x`float lineFactorAtPosition(float value) {
float pos = value * 129.0;
if(pos < 0.5 || pos > 128.5) {
return 1.0;
}
pos = pos + 0.5;
float modulo = mod(pos, 16.0);
return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
}
float lineFactorAtUV(vec2 uv) {
return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
}
float lineFactor(vec2 uv) {
vec2 offset = fwidth(uv) * 0.25;
return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
}
vec4 gridColor(vec2 uv) {
float line = lineFactor(uv) * 0.1 + 0.9;
float backgroundOpacity = textureOpacities.y;
return vec4(1.0, 0.972, 0.918, 1.0) * line * backgroundOpacity;
}`),e.fragment.code.add(x`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
if (opacities.y <= 0.0) {
return color * opacities.z * opacities.x;
}
vec4 grid = gridColor(uv);
float alpha = opacities.z * color.a;
return mix(grid, color, alpha) * opacities.x;
}`)):t.hasBackgroundColor?(e.fragment.uniforms.add("backgroundColor","vec3"),e.fragment.code.add(x`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
if (opacities.y <= 0.0) {
return color * opacities.z * opacities.x;
}
float alpha = opacities.z * color.a;
float backgroundOpacity = opacities.y;
return mix(vec4(backgroundColor, 1.0) * backgroundOpacity, color, alpha) * opacities.x;
}`)):e.fragment.code.add(x`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
return color;
}`),t.textureFadingEnabled?e.fragment.code.add(x`vec4 getTileColor() {
vec4 color = getColor(texture2D(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture2D(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):e.fragment.code.add(x`vec4 getTileColor() {
return getColor(texture2D(tex, vtc), vtc, textureOpacities);
}`)}function Zat(e){const t=new Oi;if(t.include(g_e,{name:"Terrain Shader",output:e.output}),t.include(Xat),t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.UV0,"vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("origin","vec3").add("skirtScale","float"),t.fragment.uniforms.add("origin","vec3"),e.output===j.Color){t.include(Gn,{linearDepth:!1}),t.include(e0,e),t.include(Yat,e),t.include(J1,e);const i=e.overlayMode!==_u.Disabled,r=e.overlayMode===_u.EnabledWithWater;i&&t.include(EG,{pbrMode:xt.Water,useCustomDTRExponentForWater:!1,ssrEnabled:e.ssrEnabled,highStepCount:e.highStepCount}),r&&t.include(Wat,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),t.vertex.uniforms.add("viewNormal","mat4"),e.receiveShadows&&t.varyings.add("linearDepth","float"),e.tileBorders&&t.varyings.add("vuv","vec2"),e.atmosphere&&(t.vertex.uniforms.add("lightingMainDirection","vec3"),t.varyings.add("wnormal","vec3"),t.varyings.add("wlight","vec3")),e.screenSizePerspective&&(t.vertex.uniforms.add("screenSizePerspective","vec4"),t.varyings.add("screenSizeDistanceToCamera","float"),t.varyings.add("screenSizeCosAngle","float")),t.vertex.code.add(x`
      void main(void) {
        vpos = position;
        vnormal = getLocalUp(vpos, origin);

        vec2 uv = uv0;
        vpos = applySkirts(uv, vpos, vnormal, skirtScale);
        ${e.atmosphere?x`
        wnormal = normalize((viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz);
        wlight = normalize((view  * vec4(lightingMainDirection, 1.0)).xyz);`:""}
        ${e.tileBorders?x`vuv = uv;`:""}
        ${e.screenSizePerspective?x`
        vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
        screenSizeDistanceToCamera = length(viewPos);
        vec3 viewSpaceNormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}
        gl_Position = transformPosition(proj, view, vpos);
        ${e.receiveShadows?x`linearDepth = gl_Position.w;`:""}
        forwardTextureCoordinates(uv);
        ${i?x`setOverlayVTC(uv);`:""}
        ${r?x`forwardVertexTangent(vnormal);`:x``}
      }
    `),t.extensions.add("GL_OES_standard_derivatives"),t.extensions.add("GL_EXT_shader_texture_lod"),t.include(Or,e),t.include(J1,e),t.fragment.uniforms.add("cameraPosition","vec3").add("viewDirection","vec3").add("ssaoTex","sampler2D").add("viewportPixelSz","vec4"),e.screenSizePerspective&&t.fragment.uniforms.add("screenSizePerspective","vec4"),r&&(t.fragment.uniforms.add("ovWaterTex","sampler2D"),t.fragment.uniforms.add("view","mat4")),t.fragment.code.add(x`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),t.fragment.code.add(x`
      void main() {
        ${e.receiveShadows?x`float shadow = readShadowMap(vpos, linearDepth);`:x`float shadow = 0.0;`}
        float vndl = dot(normalize(vnormal), lightingMainDirection);

        float ssao = viewportPixelSz.w < .0 ? 1.0 : texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
        vec4 tileColor = getTileColor();
        ${i?x`
            vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
            vec4 overlayColor = overlayOpacity * overlayColorOpaque;
            vec4 groundColor = tileColor;
            tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}
        if (rejectBySlice(vpos)) {
          tileColor *= sliceOpacity;
        }
        ${e.atmosphere?x`
            float ndotl = clamp(vndl, 0.0, 1.0);
            vec3 atm = vec3(clamp(1.0 - dot(-viewDirection, wnormal), 0.0, 1.0));
            atm *= clamp(1.0 - lum(tileColor.rgb) * 1.5, 0.0, 1.0); //avoid atmosphere on bright base maps
            atm *= clamp(ndotl * 2.0, 0.0, 1.0); // avoid atmosphere on dark side of the globe
            atm *= tileColor.a; // premultiply with tile alpha`:""}

        vec3 albedo = ${e.atmosphere?x`atm + tileColor.rgb;`:x`tileColor.rgb;`}
        vec3 normal = normalize(vnormal);

        // heuristic shading function used in the old terrain, now used to add ambient lighting
        float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

        gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);
        ${r?x`
            vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
            float waterNormalLength = length(overlayWaterMask);
            if (waterNormalLength > 0.95) {
              mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
              vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
              vec4 viewPosition = view*vec4(vpos, 1.0);
              vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + origin);
              vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
              // un-gamma the ground color to mix in linear space
              gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w);
            }`:""}
        ${e.screenSizePerspective?x`
          float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, screenSizePerspective);
          if (perspectiveScale <= 0.25) {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
          }
          else if (perspectiveScale <= 0.5) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
          }
          else if (perspectiveScale >= 0.99) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
          }
          else {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
          }`:""}
        ${e.tileBorders?x`
            vec2 dVuv = fwidth(vuv);
            vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv, 1.0 - vuv));
            float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
      }
    `)}return e.output!==j.Depth&&e.output!==j.Shadow||(t.include(Gn,{linearDepth:!0}),t.include(q0,{output:e.output}),t.include(e0,e),t.varyings.add("linearDepth","float"),t.vertex.uniforms.add("nearFar","vec2"),t.vertex.code.add(x`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, normal.xyz, skirtScale);
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);
}`),t.fragment.code.add(x`void main() {
outputDepth(linearDepth);
}`)),e.output===j.Normal&&(t.include(Gn,{linearDepth:!1}),t.include(e0,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),t.vertex.uniforms.add("viewNormal","mat4"),t.vertex.code.add(x`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vpos = applySkirts(uv, position, normal, skirtScale);
gl_Position = transformPosition(proj, view, vpos);
vnormal = normalize((viewNormal * vec4(normal, 1.0)).xyz);
}`),t.fragment.code.add(x`void main() {
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) {
normal = -normal;
}
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
}`)),e.output===j.Highlight&&(t.include(Gn,{linearDepth:!1}),t.include(e0,e),t.include(EG,{pbrMode:xt.Disabled}),t.vertex.code.add(x`void main() {
vec3 vnormal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, vnormal, skirtScale);
setOverlayVTC(uv);
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(Qm),t.fragment.code.add(x`void main() {
vec4 overlayColor = getCombinedOverlayColor();
if (overlayColor.a == 0.0) {
gl_FragColor = vec4(0.0);
return;
}
outputHighlight();
}`)),t}const Qat=Object.freeze({__proto__:null,build:Zat});class Z4 extends Gi{constructor(){super(...arguments),this.useStencil=!1}initializeProgram(t){const i=Z4.shader.get(),r=this.configuration,s=i.build({overlayMode:r.overlayMode,output:r.output,viewingMode:t.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,textureFadingEnabled:r.textureFadingEnabled&&!r.renderOccluded,hasBackgroundColor:r.hasBackgroundColor,useGrid:r.useGrid,receiveShadows:r.receiveShadows&&!r.renderOccluded,receiveAmbientOcclusion:!1,atmosphere:r.atmosphere,tileBorders:r.tileBorders,screenSizePerspective:r.screenSizePerspective,pbrMode:xt.Disabled,ssrEnabled:r.ssrEnabled,highStepCount:!1});return new Mi(t.rctx,s,mi)}initializePipeline(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}_createPipeline(t){const i=this.configuration,r=i.backfaceCullingEnabled&&!i.renderOccluded;return Ot({blending:i.renderOccluded?Sc(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA):null,culling:r&&dq,depthTest:!i.renderOccluded&&{func:Li.LESS},depthWrite:!i.renderOccluded&&Ma,colorWrite:Ft,stencilTest:t?eQe(Ea.IntegratedMeshMaskExcluded):null})}getPipelineState(t,i){return this.useStencil?this._stencilPipelineState:super.getPipelineState(t,i)}}Z4.shader=new Ni(Qat,()=>import("./Terrain.glsl.4c14ec22.js"));class oa extends mr{constructor(){super(...arguments),this.output=j.Color,this.overlayMode=_u.Disabled,this.atmosphere=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.hasBackgroundColor=!1,this.useGrid=!1,this.renderOccluded=!1,this.ssrEnabled=!1,this.tileBorders=!1,this.screenSizePerspective=!1}}u([Z({count:j.COUNT})],oa.prototype,"output",void 0),u([Z({count:_u.COUNT})],oa.prototype,"overlayMode",void 0),u([Z()],oa.prototype,"atmosphere",void 0),u([Z()],oa.prototype,"receiveShadows",void 0),u([Z()],oa.prototype,"slicePlaneEnabled",void 0),u([Z()],oa.prototype,"backfaceCullingEnabled",void 0),u([Z()],oa.prototype,"stencilEnabled",void 0),u([Z()],oa.prototype,"textureFadingEnabled",void 0),u([Z()],oa.prototype,"hasBackgroundColor",void 0),u([Z()],oa.prototype,"useGrid",void 0),u([Z()],oa.prototype,"renderOccluded",void 0),u([Z()],oa.prototype,"ssrEnabled",void 0),u([Z()],oa.prototype,"tileBorders",void 0),u([Z()],oa.prototype,"screenSizePerspective",void 0);const Cz=7,Jat=10,EP=cs(),AP=ni();let No=class extends we{constructor(e){super(e),this.type=ur.TERRAIN,this.isGround=!0,this.tileSize=256,this.rctx=null,this._isTransparent=!1,this._scaleRangeQueries=new kot,this.renderDataPool=new Wr(Fot),this._patchGroups=new Map,this.patchGroupsDirty=!0,this.tileIterator=new D1e,this.highestVisibleLODTile=null,this.visible=!0,this._opaque=!0,this._skirtScale=1,this._velvetOverground=!0,this.castShadows=!0,this._ssrEnabled=!1,this.emptyTex=null,this.tileRenderer=null,this.tileBackgroundInitialized=!1,this.tileBackgroundUpdating=!1,this.stencilEnabledLayerExtents=[],this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.overlayOpacity=1,this.needsHighlight=!1,this.renderOccludedFlags=Cr.Occlude}get isGlobal(){return this.stage.viewingMode===Ie.Global}initialize(){const e=[ve.OPAQUE_TERRAIN,ve.TRANSPARENT_TERRAIN,ve.OCCLUDED_TERRAIN];this.stage.addRenderPlugin(e,this)}destroy(){this.stage.removeRenderPlugin(this),not()}get updating(){return!this.tileBackgroundInitialized||this.tileBackgroundUpdating}get canRender(){return this.visible&&!!this._rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setNeedsRender()}set opaque(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender())}get opaque(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled}get needsLinearDepth(){return this.overlayRenderer.hasWater}set isTransparent(e){this._isTransparent!==e&&(this._isTransparent=e,this.setNeedsRender())}get isTransparent(){return this._isTransparent}set skirtScale(e){e!==this._skirtScale&&(this._skirtScale=e,this.setNeedsRender())}get skirtScale(){return this._skirtScale}get renderPatchBorders(){return!!this.shaderTechniqueConfig.tileBorders}set renderPatchBorders(e){this.shaderTechniqueConfig.tileBorders!==e&&(this.shaderTechniqueConfig.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get cullBackFaces(){return this.shaderTechniqueConfig.backfaceCullingEnabled}set cullBackFaces(e){this.shaderTechniqueConfig.backfaceCullingEnabled!==e&&(this.shaderTechniqueConfig.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this.setNeedsRender()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get layerUid(){return N_}get slicePlaneEnabled(){return this.shaderTechniqueConfig.slicePlaneEnabled}set slicePlaneEnabled(e){this.shaderTechniqueConfig.slicePlaneEnabled!==e&&(this.shaderTechniqueConfig.slicePlaneEnabled=e,this.setNeedsRender())}set textureFadingEnabled(e){this.shaderTechniqueConfig.textureFadingEnabled!==e&&(this.shaderTechniqueConfig.textureFadingEnabled=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this.shaderTechniqueConfig.screenSizePerspective!==e&&(this.shaderTechniqueConfig.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setNeedsRender()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?YL:Cr.Occlude,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()}setTileSize(e){this.tileSize=e,this.tileRenderer&&(this.tileRenderer.tileSize=e),this.setNeedsRender()}loadTile(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e)),this.updateTileGeometry(e),this.updateTileTexture(e,vt.TEXTURE_FADING)}queryVisibleLevelRange(e,t,i,r){this._scaleRangeQueries.queryVisibleLevelRange(e,t,i,r),this.setNeedsRender()}updateTileTexture(e,t){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(e,t===vt.TEXTURE_FADING?Qs.FADING:Qs.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometry(e){for(const t of e.layerInfo[Lt.ELEVATION])t.pendingUpdates&=~vt.GEOMETRY;e.resetPendingUpdate(vt.GEOMETRY),e.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender()}unloadTile(e){e.renderData&&(e.renderData.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(e.renderData),e.renderData.clear(),e.renderData=null,e.setMemoryDirty(),this.setNeedsRender())}_getLocalOriginOfTile(e){const t=Jat-Cz,i=Math.max(0,Math.floor((e.level-t)/Cz)*Cz);if(this.isGlobal&&i===0)return pl;for(;e.parent&&e.level>i;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this.visible=e,this.setNeedsRender()}getStats(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numOriginsRendered:this.numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.allTiles.forAll(t=>{var i;return(i=t.renderData)==null?void 0:i.updateGeometry(this.rctx,e)}),this.setNeedsRender())}setNeedsRender(e=ns.UPDATE){this.patchGroupsDirty=!0,this.context.requestRender(e)}setTileBackground(e){this.tileBackground=e,this._updateTileBackground()}initializeRenderContext(e){this.context=e,this.rctx=e.renderContext.rctx,this.shaderTechniques=e.shaderTechniqueRepository,this.shaderTechniqueConfig=new oa,this.tileRenderer=new Nat(this.rctx,this.tileSize,this.shaderTechniques),this.tileBackground&&this._updateTileBackground(),this.emptyTex=xge(this.rctx)}uninitializeRenderContext(){this.emptyTex!=null&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)}intersect(e,t,i,r){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&!this._opaque)return;const s=elt,n=tlt;de(s,r,i),oe(n,1/s[0],1/s[1],1/s[2]);const o=e.results.min,a=e.results.max,l=e.results.ground,c=e.options.store===Wn.MIN,h=!!e.results.ground.target,p=u7e(e.verticalOffset),f=this._skirtScale,g=e.tolerance;let y,v=c&&_(o.dist)?o.dist:1/0;const b=S=>{const T=S.renderData;if(T==null)return;const A=T.geometryInfo;GN(EP,A.boundingBox);const C=T.localOrigin;_(p)&&(p.localOrigin=C,p.applyToAabb(EP));const O=-f*A.skirtLength;if(O!==0){const te=S.up;ZEe(EP,O*te[0],O*te[1],O*te[2])}const L=EP;if(hf[0]=i[0]-C[0],hf[1]=i[1]-C[1],hf[2]=i[2]-C[2],!oW(L,hf,n,g,v))return;const U=(te,ie,$)=>{te.set(this.type,S,ie,$,ls),v=c&&_(o.dist)?o.dist:1/0},N=(te,ie)=>{if(_(ie)&&te>=0&&(e.options.backfacesTerrain||_e(ie,s)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||t==null||t(i,r,te))){if((l.dist==null||te<l.dist)&&U(l,te,ie),e.options.isFiltered)return;e.options.store===Wn.ALL&&(R(y)?(y=QF(e.ray),U(y,te,ie),e.results.all.push(y)):te<y.dist&&U(y,te,ie)),(o.dist==null||te<o.dist)&&U(o,te,ie),e.options.store!==Wn.MIN&&(a.dist==null||te>a.dist)&&U(a,te,ie)}},z=ilt;de(z,r,C);const V=A.indices,B=A.vertexAttributes,J={data:B.getField(E.POSITION,Si).typedBuffer,size:3,stride:B.stride/4},Q=A.numWithoutSkirtIndices/3;if(!_(p)&&Q>SG){const te=S.renderData;_(te.intersectionData)||(te.intersectionData=new ib(V,0,Q,J)),te.intersectionData.intersectRay({r0:hf,r1:z},N)}else LO(hf,z,0,Q,V,J,null,p,N);if(O!==0){const te=V.length/3;if(this.isGlobal){const ie=te-Q;if(!_(p)&&ie>SG){const $=S.renderData;if(!_($.skirtIntersectionData)){const F=pot(V,Q,te,B,O,C);$.skirtIntersectionData=new ib(F.indices,0,ie,{data:F.vertices,stride:3})}$.skirtIntersectionData.intersectRay({r0:hf,r1:z},N)}else dot(hf,z,Q,te,V,B,O,C,p,N)}else fot(hf,z,Q,te,V,B,O,p,N)}},w=this._rootTiles;_(w)&&(()=>{const S=this.tileIterator;S.reset(w);const T=e.options.invisibleTerrain;for(;!S.done;){const A=S.next();!(A.visible||T&&A.intersectsClippingArea)||!_(p)&&!A.intersectsRay(i,s,g,v,f)||h&&this._useStencilForTile(A)?S.skipSubtree():b(A)}})()}prepareTechnique(e){if(e.slot===ve.OCCLUDED_TERRAIN){if((e.renderOccludedMask&YL)==0)return null}else{const t=this.opaque?ve.OPAQUE_TERRAIN:ve.TRANSPARENT_TERRAIN;if(e.slot!==t)return null}switch(e.pass){case Le.MATERIAL:{const t=e.shadowMap&&e.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==t&&(this.shaderTechniqueConfig.receiveShadows=t);const i=this.overlayRenderer.isEmpty()?_u.Disabled:this.overlayRenderer.hasWater?_u.EnabledWithWater:_u.Enabled;this.shaderTechniqueConfig.overlayMode!==i&&(this.shaderTechniqueConfig.overlayMode=i);const r=e.slot===ve.OCCLUDED_TERRAIN?$n.Occluded:$n.ColorAndWater;return this._updateTechnique(j.Color,r===$n.Occluded)}case Le.MATERIAL_DEPTH_SHADOWMAP_ALL:case Le.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return this.castShadows&&e.scenelightingData.globalFactor===1?this._updateTechnique(j.Shadow,!1):null;case Le.MATERIAL_DEPTH:return this.isTransparent&&this.overlayRenderer.isEmpty()?null:this._updateTechnique(j.Depth,!1);case Le.MATERIAL_NORMAL:return this._updateTechnique(j.Normal,!1);case Le.MATERIAL_HIGHLIGHT:return this.needsHighlight?this._updateTechnique(j.Highlight,!1):null}return null}render(e,t){const i=e.pass,r=e.scenelightingData.globalFactor===1;switch(this._updatePatchGroups(),t.useStencil=!1,i){case Le.MATERIAL:{const s=e.slot===ve.OCCLUDED_TERRAIN?$n.Occluded:$n.ColorAndWater;this._renderMaterialPass(e,t,s);break}case Le.MATERIAL_DEPTH_SHADOWMAP_ALL:case Le.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:this.castShadows&&r&&this._renderAuxiliaryPass(e,t,$n.None);break;case Le.MATERIAL_DEPTH:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,t,$n.None);break;case Le.MATERIAL_NORMAL:this._renderAuxiliaryPass(e,t,$n.None);break;case Le.MATERIAL_HIGHLIGHT:this.needsHighlight&&(this._renderAuxiliaryPass(e,t,$n.Highlight),e.rctx.clearSafe(bi.DEPTH_BUFFER_BIT))}this._scaleRangeQueries.hasPendingQueries()&&this.setNeedsRender()}_renderMaterialPass(e,t,i){const{rctx:r,camera:s}=e;this._ssrEnabled=e.ssrParams.ssrEnabled;const n=r.useTechnique(t,e.slot);this.shaderTechniqueConfig.overlayMode!==_u.Disabled&&i===$n.ColorAndWater&&e.ssrParams&&OW(n,e.ssrParams),e.shadowMap.bind(n),e.ssaoHelper.bind(n,e.camera),this._bindOverlayData(n,i),n.setUniformMatrix4fv("viewNormal",s.viewInverseTransposeMatrix),Ol(n,s.projectionMatrix),e.scenelightingData.setUniforms(n,!0,!1);const o=s.viewMatrix;oe(CP,o[12],o[13],o[14]),be(CP,CP),n.setUniform3fv("viewDirection",CP),this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this._scaleRangeQueries.prepareQueries(),this.opaque?this._renderPatchGroups(e,t,i):e.offscreenRenderingHelper.renderToTargets(()=>this._renderPatchGroups(e,t,i),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._scaleRangeQueries.processQueries()}_renderAuxiliaryPass(e,t,i){const r=e.rctx.useTechnique(t,e.slot);if(e.pass===Le.MATERIAL_HIGHLIGHT){const s=e.offscreenRenderingHelper;r.bindTexture(s.depthTexture,"depthTex"),r.setUniform4f("highlightViewportPixelSz",0,0,1/s.width,1/s.height)}else r.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),e.pass!==Le.MATERIAL_DEPTH&&e.pass!==Le.MATERIAL_DEPTH_SHADOWMAP_ALL&&e.pass!==Le.MATERIAL_DEPTH_SHADOWMAP_DEFAULT||r.setUniform2fv("nearFar",e.camera.nearFar);this._renderPatchGroupsAuxiliary(e,t,i)}_updateTileBackground(){if(!this.tileRenderer)return;this.tileBackgroundUpdating=!0;const e=()=>{this.tileBackgroundInitialized=!0,this.tileBackgroundUpdating=!1,this.shaderTechniqueConfig.useGrid=this.tileRenderer.backgroundIsGrid,this.shaderTechniqueConfig.hasBackgroundColor=!this.tileRenderer.backgroundIsGrid&&!!_(this.tileRenderer.backgroundColor),this.allTiles.forAll(t=>this.tileRenderer.updateTileTexture(t,Qs.FADING)),this.setNeedsRender()};if(typeof this.tileBackground=="string"){const t=this.tileBackground;Fu(t).then(i=>{t===this.tileBackground&&this.tileRenderer&&(this.tileRenderer.setBackground(i,this.tileBackground===Rme),e())})}else{const t=this.tileBackground?Je.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(t,!1),e()}}_updatePatchGroups(){if(this.patchGroupsDirty){if(this.highestVisibleLODTile=null,this._rebuildPatchGroups(),this.renderOrder!==HR.NONE){const e=Array.from(this._patchGroups.values());e.forEach(t=>L1e(this.renderOrder,t)),e.sort((t,i)=>N1e(t[0],i[0],this.renderOrder)),this._patchGroups=new Map(e.map(t=>[t[0].renderData.localOrigin,t]))}this.patchGroupsDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(!R(e)){this._patchGroups.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this.tileIterator;for(t.resetOne(e);!t.done;){const i=t.next(),r=i.renderData;if(!r||i.visible)if(i.rendered){if(r){const s=this._patchGroups.get(r.localOrigin)||new Array;this._patchGroups.set(r.localOrigin,s),s.push(i),(!this.highestVisibleLODTile||i.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=i),t.skipSubtree()}}else this.numTilesCulled++;else this.numTilesCulled++,t.skipSubtree()}}_useStencilForTile(e){for(const t of this.stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderPatchGroupsAuxiliary(e,t,i){t.program.setUniformMatrix4fv("proj",e.camera.projectionMatrix),t.program.setUniform1f("skirtScale",this._skirtScale),i!==$n.None&&this._bindOverlayData(t.program,i);const r=this.stencilEnabledLayerExtents.length>0;this._patchGroups.forEach(s=>{const n=s[0].renderData.localOrigin;this._bindPatchGroupData(t.program,n,e.camera.eye,e.camera.viewMatrix);for(let o=0;o<s.length;o++)this._renderPatch(e,t,s[o],Tt.TRIANGLES,r,i)}),e.rctx.bindVAO(null)}_renderPatchGroups(e,t,i){const r=e.rctx,s=e.camera,n=s.viewMatrix,o=t.program;if(this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){const f=h0e(this.stage.viewingMode,this.ellipsoidRadius),g=this.pointsOfInterest.centerOnSurfaceFrequent.distance;f.update({distance:g,fovY:s.fovY}),MR(f,o,"screenSizePerspective")}const a=this.stencilEnabledLayerExtents.length>0,l=i===$n.Occluded;l&&(o.bindTexture(this.emptyTex,"tex"),o.setUniform1f("blend",1),o.setUniform4fv("texOffsetAndScale",c1));const c=_(this.tileRenderer.backgroundColor)?this.tileRenderer.backgroundColor:pl;this.shaderTechniqueConfig.hasBackgroundColor&&o.setUniform3fv("backgroundColor",c);const h=l?0:this._skirtScale;o.setUniform1f("skirtScale",h);const p=this.wireframe?Tt.LINES:Tt.TRIANGLES;this.shaderTechniqueConfig.textureFadingEnabled&&o.bindTexture(this.emptyTex,"texNext"),this._patchGroups.forEach(f=>{const g=f[0].renderData.localOrigin;this._bindPatchGroupData(o,g,s.eye,n);const y=e.sliceHelper&&e.sliceHelper.plane;I0(o,t.configuration,y,{origin:g}),e.shadowMap&&e.shadowMap.bindView(o,g),this.numOriginsRendered++;for(let v=0;v<f.length;v++){const b=f[v],w=b.renderData.textureReference;if(!R(w)){if(!l){this._scaleRangeQueries.scaleQueriesForTile(b),ase(b.renderData.geometryInfo.uvOffsetAndScale,w.offsetAndScale,AP),o.setUniform4fv("texOffsetAndScale",AP),o.bindTexture(w.texture.texture,"tex");const S=b.renderData.textureFadeFactor,T=S<1?b.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&_(T)&&S<1?(ase(b.renderData.geometryInfo.uvOffsetAndScale,T.offsetAndScale,AP),o.setUniform1f("fadeFactor",S),o.setUniform4fv("nextTexOffsetAndScale",AP),o.setUniform3fv("nextTexOpacities",T.opacities),o.bindTexture(T.texture.texture,"texNext")):o.setUniform1f("fadeFactor",1),b.renderData.textureIsFading&&this.setNeedsRender(),o.setUniform3fv("textureOpacities",w.opacities)}this._renderPatch(e,t,b,p,a,i),b.renderOrder=this.numTilesRendered,this.numTilesRendered++}}}),r.bindVAO(null)}_renderPatch(e,t,i,r,s,n){if(R(i.renderData.vao.indexBuffer))return;const o=t.program;n!==$n.None&&this._bindOverlayPatchData(o,i.renderData.overlay),s&&(t.useStencil=this._useStencilForTile(i),t.bindPipelineState(e.rctx,e.slot));const a=this._skirtScale===0?i.renderData.geometryInfo.numWithoutSkirtIndices:i.renderData.vao.indexBuffer.size;e.rctx.bindVAO(i.renderData.vao),o.assertCompatibleVertexAttributeLocations(i.renderData.vao),e.rctx.drawElements(r,a,i.renderData.vao.indexBuffer.indexType,0)}_bindPatchGroupData(e,t,i,r){e.setUniform3fv("origin",t),Wo(lse,r,t),e.setUniformMatrix4fv("view",lse),e.setUniform3f("cameraPosition",i[0]-t[0],i[1]-t[1],i[2]-t[2])}_bindOverlayData(e,t){if(this.shaderTechniqueConfig.overlayMode===_u.Disabled)return;e.setUniform1f("overlayOpacity",this.overlayOpacity);const i=this.overlayRenderer.overlays;if(i.length>is.INNER){const r=i[is.INNER],s=r.getColorTexture(t);if(e.bindTexture(_(s)?s:this.emptyTex,"ovColorTex"),this.shaderTechniqueConfig.overlayMode===_u.EnabledWithWater){const n=r.getNormalTexture(t);e.bindTexture(_(n)?n:this.emptyTex,"ovWaterTex")}}}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_updateTechnique(e,t){return this.shaderTechniqueConfig.output=e,e===j.Color&&(this.shaderTechniqueConfig.atmosphere=this.isGlobal&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled),this.shaderTechniqueConfig.renderOccluded=t,this.shaderTechniqueConfig.stencilEnabled=!1,this._shaderTechnique=this.shaderTechniques.releaseAndAcquire(Z4,this.shaderTechniqueConfig,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this.tileRenderer}}};u([d()],No.prototype,"tileBackgroundInitialized",void 0),u([d()],No.prototype,"tileBackgroundUpdating",void 0),u([d({constructOnly:!0})],No.prototype,"overlayRenderer",void 0),u([d({constructOnly:!0})],No.prototype,"stage",void 0),u([d({readOnly:!0})],No.prototype,"isGlobal",null),u([d({constructOnly:!0})],No.prototype,"allTiles",void 0),u([d({constructOnly:!0})],No.prototype,"ellipsoidRadius",void 0),u([d({readOnly:!0})],No.prototype,"updating",null),u([d({value:!1})],No.prototype,"renderingDisabled",null),u([d()],No.prototype,"renderPatchBorders",null),u([d()],No.prototype,"cullBackFaces",null),u([d({value:HR.FRONT_TO_BACK})],No.prototype,"renderOrder",null),u([d()],No.prototype,"wireframe",null),No=u([P("esri.views.3d.terrain.TerrainRenderer")],No);const Kat=No;function ase(e,t,i){i[0]=e[0]*t[2]+t[0],i[1]=e[1]*t[3]+t[1],i[2]=e[2]*t[2],i[3]=e[3]*t[3]}const lse=Te(),CP=M(),elt=M(),tlt=M(),hf=M(),ilt=M();class rlt{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}let Wd=class extends we{constructor(e){super(e),this._handles=new Ut}initialize(){this._handles.add(this.layers.on("change",()=>this._update())),this._handles.add(this.extentHelper.watch("layerViewsExtent",()=>this._setAdHocTilingScheme())),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles=rt(this._handles),this._waitTask=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(t=>!(!eC(t)||t.isRejected())&&!(t.isFulfilled()&&!slt(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!w1e(t)&&!oN(t))),e)if(e.isResolved()){const t=H4(e,this.viewSpatialReference,this.viewingMode);if(_(t)){const i=new or(t.tileInfo);this._lockTilingScheme(i)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch(()=>{}).then(()=>{t!==this._waitTask||this.destroyed||this._update()});this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===Ie.Global){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=or.makeWebMercatorAuxiliarySphere(t):I1(e.spatialReference)&&(e=or.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(this.extentHelper.watch("tiledLayersExtent",()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===Ie.Global){const e=this.extentHelper.viewSpatialReference,t=I1(e)||Lp(e)||Np(e);e.isWebMercator?this.tilingScheme=or.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=or.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;_(e)&&!s1(e,this.extent)&&(this.tilingScheme=or.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};function slt(e,t,i){return _(H4(e,t,i))}u([d()],Wd.prototype,"tilingScheme",void 0),u([d({readOnly:!0})],Wd.prototype,"extent",void 0),u([d({value:!1})],Wd.prototype,"tilingSchemeLocked",void 0),u([d({constructOnly:!0})],Wd.prototype,"viewSpatialReference",void 0),u([d({constructOnly:!0})],Wd.prototype,"layers",void 0),u([d({constructOnly:!0})],Wd.prototype,"extentHelper",void 0),u([d({constructOnly:!0})],Wd.prototype,"viewingMode",void 0),Wd=u([P("esri.views.3d.terrain.TilingSchemeLogic")],Wd);class nlt{constructor(){this.offset=Ye(),this.scale=0,this.tile=null}init(t,i,r,s){this.tile=t,this.offset[0]=i,this.offset[1]=r,this.scale=s}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}const eh=he.getLogger("esri.views.3d.terrain.TerrainSurface"),olt=.25;let zt=class extends xr.EventedMixin(we){constructor(e){super(e),this._elevationBounds=new sX,this._iteratorPool=new Wr(D1e,t=>t.remove=()=>this._iteratorPool.release(t)),this._postorderIterator=new mot,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visible=!1,this._usedMemory=uE,this._performanceInfo=new rlt,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=M(),this._eyePosSurfaceSR=M(),this._splitLimits=new Pot,this._snapLevel=1/0,this._frustum=AR(),this._viewProjectionMatrix=Te(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new Ut,this._watchUpdatingTracking=new fp,this._frameTask=rS,this._allTiles=new $t,this._upsampleInfoPool=new Wr(nlt),this._rootTilesExtent=Dt(),this._maxNumUpdating=1,this.maxTextureScale=1.2,this.backgroundImage=Rme,this.backgroundColor=null,this._layerViewsDirty=!1}initialize(){this._lercDecoder=Pnt(this.view.resourceController),this._tilePool=this.view.state.isLocal?new Wr(Dot):new Wr(Lot);const e=this.view.resourceController.memoryController;this._upsampleMapCache=e.newCache("esri.views.3d.terrain.upsample",s=>s.unloadMapData()),this._elevationQueryCache=new Ont(e.newCache("elevation-query")),this._set("overlayManager",new Lo({surface:this})),this._handles.add([this.watch("overlayManager.hasHighlights",s=>this._renderer.setNeedsHighlight(s)),this.watch("overlayManager.rendersOccluded",s=>this._renderer.setRenderOccludedOverlay(s))],"overlayManager"),this._renderer=new Kat({overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:di(this.view.spatialReference).radius,stage:this.view._stage,allTiles:this._allTiles}),this._handles.add([Wt(this,"baseOpacity",s=>{this._handleLayerViewChanges(),this._updateBaseOpacity(s)},!0),Wt(this,"_background",()=>{this._handleLayerViewChanges(),this._renderer.setTileBackground(this._background)},!0),this.view.watch("pointsOfInterest",s=>{this._renderer.pointsOfInterest=s,this._watchUpdatingTracking.removeAll(),s&&this._watchUpdatingTracking.add(()=>s.focus.renderLocation,()=>()=>this._allTilesSorted=!1)}),Wt(hi,"TERRAIN_TILE_TREE_SHOW_TILES",s=>{s&&!this._treeDebugger?import("./TerrainTileTree3DDebugger.97446a58.js").then(({TerrainTileTree3DDebugger:n})=>{!this._treeDebugger&&hi.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new n({view:this.view}))}):s||(this._treeDebugger=rt(this._treeDebugger))})]),this._extentHelper=Qnt(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:this.view.spatialReference});const t=this.view.defaultsFromMap?new sT({getCollections:()=>{var s,n,o;return(s=this.view)==null||(n=s.defaultsFromMap)==null||(o=n.mapCollections)==null?void 0:o.map(({layers:a})=>a)},getChildrenFunction:s=>s&&"layers"in s?s.layers:null}):this.view.map.allLayers,i=new Wd({layers:t,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",i),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(cp.ELEVATION),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(cp.BASEMAP);const r=this.view.resourceController.scheduler;this._frameTask=r.registerTask(ht.TERRAIN_SURFACE,this),this.view.resourceController.memoryController.events.on("quality-changed",()=>this._viewChangeUpdate()),this._handles.add([Wt(this._extentHelper,"stencilEnabledExtents",s=>this._renderer.setStencilEnabledLayerExtents(s)),this.tilingSchemeLogic.watch("tilingScheme",()=>this._updateTilingScheme(),!0),Wt(this,"extent",()=>this._updateRootTiles()),this.view.on("resize",()=>this._viewChangeUpdate()),this.view.watch("state.camera",()=>this._viewChangeUpdate(),!0),this.view.watch("state.contentCamera",()=>this.view.state.fixedContentCamera&&this._viewChangeUpdate(),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",()=>this._viewChangeUpdate()),Wt(this.view,"qualitySettings.tiledSurface.textureFadeDuration",s=>this._renderer.textureFadingEnabled=s>0),this.view.watch("lodSnapping",()=>this._viewChangeUpdate()),Nt(()=>this._userClippingExtent,()=>this._updateClippingExtent(),Sh)]),this._handles.add(this.view.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges()}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=Xi(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=rt(this._upsampleMapCache),this._elevationQueryCache=rt(this._elevationQueryCache),this._set("tilingSchemeLogic",rt(this.tilingSchemeLogic)),this._extentHelper=rt(this._extentHelper),this._basemapLayerViewHandles.forEach((e,t)=>this._unregisterTiledLayerView(t)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",rt(this.overlayManager)),this._tilePool=rt(this._tilePool),lX.prune(),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer=rt(this._renderer),this._iteratorPool=rt(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=rt(this._upsampleInfoPool),jnt(),Oot()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var e,t;const i=(e=this.view.pointsOfInterest)==null||(t=e.contentCameraOnSurface)==null?void 0:t.scale;if(i){const r=this.view.state.contentCamera;let s=t4(this.view,r.eye,r.viewForward,r.up).tilt;s>90&&(s=180-s);const n=2*(s/90)**2,o=Jye(this.view,i)-n;Math.abs(this._snapLevel-o)>olt&&(Math.round(o)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=o)}return Math.round(this._snapLevel)}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?AS.ON:AS.OFF}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:t}=this.view;if(R(t)||R(e))return null;const i=Dt(),r=o1e(t,i,e)?i:null,s=this._get("extent");return s1(r,s)?s:r}get extent(){const e=yI(this.groundExtent,this._userClippingExtent,Dt()),t=this._get("extent");return s1(e,t)?t:e}get groundExtent(){return _(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){var e;return(e=this.tilingSchemeLogic)==null?void 0:e.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this._watchUpdatingTracking.updating||this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._renderer.updating||this._layerViewsDirty)&&this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get viewingMode(){return this.view.state.viewingMode}get ready(){return _(this.rootTiles)}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}set skirtScale(e){this._renderer.skirtScale=e}get skirtScale(){return this._renderer.skirtScale}get spatialReference(){var e,t;return(e=(t=this.tilingScheme)==null?void 0:t.spatialReference)!=null?e:null}get _background(){return this.backgroundColor!=null?this.backgroundColor:this.backgroundImage}set slicePlaneEnabled(e){var t,i;this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),(t=this.view)==null||(i=t._stage)==null||i.renderView.setRenderParameters({opaqueTerrain:this.opaque})}set velvetOverground(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e)}set visible(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e)}get opaque(){return this._renderer.opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevation(e,t,i,r){const s=this.getTileWithElevation(e,t,i,r,th);return R(s)?null:nX(th[0],th[1],s.renderData.geometryState.samplerData)}getTileWithElevation(e,t,i,r,s=th){var n;const o=this.rootTiles;if(R(o)||!o.length||o[0].layerInfo[Lt.ELEVATION].length===0)return null;if(s[0]=e,s[1]=t,s[2]=i,!wn(s,r,s,(n=this.tilingScheme)==null?void 0:n.spatialReference))return eh.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let a of o){if(!a.containsPoint(s))continue;for(;a&&!a.rendered&&!a.isLeaf;){let c=0;s[0]>.5*(a.extent[0]+a.extent[2])&&(c+=1),s[1]<.5*(a.extent[1]+a.extent[3])&&(c+=2),a=a.children[c]}const l=a.renderData;return(l?l.geometryState.samplerData:null)?a:null}return null}get elevationBounds(){return this._elevationBounds}getScale(e){if(this.tilingScheme){if(!tn(e,th,this.spatialReference))return eh.error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this.rootTiles;if(_(t)){for(let i of t)if(i.containsPoint(th)){for(;i.children[0]!=null;){let r=0;th[0]>i.children[0].extent[2]&&(r+=1),th[1]<i.children[0].extent[1]&&(r+=2),i=i.children[r]}return this._getLodBiasCorrectedScale(i.level)}}}return 1e100}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!tn(e,th,this.spatialReference))return eh.error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;th[3]=t;let i=null;const r=n=>{if(n&&jEe(n.extent,th))if(n.children[0]!=null)for(const o of n.children)r(o);else{const o=this._getLodBiasCorrectedScale(n.level);i=i==null?o:Math.min(i,o)}},s=this.rootTiles;if(_(s))for(const n of s)r(n);return i}queryVisibleScaleRange(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,n=i?this.tilingScheme.levelAtScale(i):1/0,o=this.lodBias;this._renderer.queryVisibleLevelRange(e,s+o,n+o,r)}_updateBaseOpacity(e){const t=this._renderer.opaque;this._renderer.opaque=e>=1,this._renderer.isTransparent=this._allTransparentSurfaceLayers();const i=t===this._renderer.opaque?Qs.UNFADED:Qs.IMMEDIATE;var r,s;i===Qs.IMMEDIATE&&((r=this.view)==null||(s=r._stage)==null||s.renderView.setRenderParameters({opaqueTerrain:this.opaque})),this._updateTileTextures(i)}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;e!==this.tilingScheme&&(Rh(!!e,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",e),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.setTileSize(e.pixelSize),this.overlayManager.setSpatialReference(e.spatialReference),this._updateRootTiles()))}_acquireTile(e,t,i,r){const s=this._tilePool.acquire();return RP[0]=e,RP[1]=t,RP[2]=i,s.init(RP,r,this),s}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=clt;let r=t.rootTilesInExtent(e,i,5*Ix);if(_(this.rootTiles)){if(r.length>Ix)return void eh.warn(K6e);const s=this.rootTiles.map(o=>o.lij),n=Gxe(s,r,cse);if(n.removed.length>0||n.added.length>0){const o=this.rootTiles.filter(a=>!(n.removed.findIndex(l=>cse(l,a.lij))>-1)||(this._purgeTile(a),!1));n.added.forEach(a=>o.push(this._newRootTile(a))),this._setRootTiles(o)}}else r.length>Ix&&(eh.warn(eBe),r=t.rootTilesInExtent(e,i,Ix)),this._setRootTiles(r.map(s=>this._newRootTile(s)));s1(i,this._rootTilesExtent)||(this._rootTilesExtent=Dt(i)),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready")}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===vt.SPLIT&&t.setPendingUpdate(vt.SPLIT),this._loadTile(t),t}_setRootTiles(e){if(this._set("rootTiles",e),this._allTiles.clear(),_(e)){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this.rootTiles),this._updateTilesVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this._updateTilesVisibility(this.rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(vt.GEOMETRY)&&this._updateTileGeometry(e)}_updateTilesVisibility(e){if(R(e))return;const t=vot(e);let i=t?this._elevationBounds.min:1/0,r=t?this._elevationBounds.max:-1/0;const s=this.view.state.fixedContentCamera,n=this.extent,o=this._viewProjectionMatrix;this.setTileTreeDirty();const a=this._iteratorPool.acquire();for(a.reset(e);!a.done;){const l=a.next();l.updateClippingStatus(n)&&l.resetPendingUpdate(vt.GEOMETRY)&&this._updateTileGeometry(l),l.setPendingUpdate(vt.RENDERDATA);const c=l.computeVisibility();s||c?(l.updateScreenDepth(o),l.renderData&&(i=Math.min(l.elevationBounds[0],i),r=Math.max(l.elevationBounds[1],r))):a.skipSubtree()}a.remove(),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(i)&&isFinite(r)&&(this._elevationBounds.min===i&&this._elevationBounds.max===r||(this._elevationBounds.min=i,this._elevationBounds.max=r,this.emit("elevation-bounds-change",null)))}_updateViewDependentParameters(){const e=this.view.state.camera,t=this.view.state.contentCamera,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,n=2**-this.lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(R(this._splitLimits.frustum)&&(this._splitLimits.frustum=AR()),RL(this._splitLimits.frustum,t.frustum)):this._splitLimits.frustum=null,RL(this._frustum,e.frustum),dr(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),ne(this._eyePosRenderSR,t.eye),wn(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateSkirts(){const e=this.view.state.camera,t=this.view.state.constraints.collision.enabled?0:1.11*e.near;this.skirtScale=int(this,this._eyePosSurfaceSR,t)}_updateRenderData(e){e.rendered&&!e.shouldLoad&&(MA(e)?this._loadChildren(e):llt(e)&&this._loadParent(e))}_updateTileGeometry(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._elevationUpdate(e),this._usedMemory=uE}_updateTileTexture(e,t){const i=e.resetPendingUpdate(vt.TEXTURE_FADING)?vt.TEXTURE_FADING:!!e.resetPendingUpdate(vt.TEXTURE_NOFADING)&&vt.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=uE,t.madeProgress())}_elevationUpdate(e){OP.spatialReference=this.spatialReference,OP.tile=e,OP.extent=e.extent,this.emit("elevation-change",OP),ej(e.extent,this._eyePosSurfaceSR)&&this._updateSkirts()}get running(){return this.updating&&this.ready&&!this.suspended}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateTileStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,t),e.run(()=>this._updateElevation(e)),e.run(()=>this._updateTextures(e)),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),e.done&&this.requestUpdate(),this.notifyChange("updatingProgressValue")}_updateTileStatus(e){if(!this._viewChanged||!this.rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){const i=t.next();if(i.loadable){const r=i.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(r===vt.SPLIT){i.resetPendingUpdate(vt.MERGE),i.isLeaf&&(i.setPendingUpdate(vt.SPLIT),t.skipSubtree());continue}i.resetPendingUpdate(vt.SPLIT)&&i.updateAgentSuspension(),r===vt.VSPLITMERGE&&i.updateAgents(Lt.ELEVATION)}if(t.skipSubtree(),!i.isLeaf){i.setPendingUpdate(vt.MERGE),i.resetPendingUpdate(vt.SPLIT);const r=this._iteratorPool.acquire();r.resetOne(i);for(let s=r.next();!r.done;s=r.next())this._updateClippingStatus(s),s.updateVisibility(),s.loadable&&s.updateScreenDepth(this._viewProjectionMatrix);r.remove()}}t.remove(),this.requestUpdate(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(got(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=0;for(;!e.done;){let r=!1;i=0;const s=!this._allTiles.some(n=>{if(i+=n.usedMemory,n.resetPendingUpdate(vt.MERGE)){if(!t)return n.setPendingUpdate(vt.MERGE),e.done;this._mergeTile(n),r=!0,e.madeProgress()}else n.resetPendingUpdate(vt.SPLIT)&&(this._splitTile(n),r=!0,e.madeProgress());return!e.done&&n.resetPendingUpdate(vt.RENDERDATA)&&(this._updateRenderData(n),e.madeProgress()),e.done});if(r&&(this._allTilesSorted=!1,this._allTilesDirty=!0),s){if(this._usedMemory=i,!r)break;this._updateTilesVisibility(this.rootTiles)}else this._allTilesDirty=!0}i===0&&(this._allTilesDirty=!0),this._sortTiles(e)}_updateElevation(e){return this._allTiles.some(t=>(t.resetPendingUpdate(vt.GEOMETRY)&&(this._updateTileGeometry(t),this._updateTileTexture(t,e),e.madeProgress()),e.done)),e.hasProgressed}_updateTextures(e){return this._allTiles.some(t=>(this._updateTileTexture(t,e),e.done)),e.hasProgressed}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(ns.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*Z6e}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=Be(e-this.lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){_(this.rootTiles)&&(this.rootTiles.forEach(e=>this._purgeTile(e)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1}_purgeChildTiles(e){if(e.isLeaf)return!1;let t=this._purgeTile(e.children[0]);return t=this._purgeTile(e.children[1])||t,t=this._purgeTile(e.children[2])||t,t=this._purgeTile(e.children[3])||t,e.unsetChildren(),t}_purgeTile(e){const t=this._purgeChildTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),e.unload(this._renderer),this._tilePool.release(e),t}_splitTile(e){Rh(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(vt.RENDERDATA),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,this._emitTileScaleChange(e,t),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){MP.spatialReference=this.spatialReference,MP.extent=e.extent,MP.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",MP)}_createTile(e,t,i,r){Rh(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this.extent),s.loadable&&(s.updateScreenDepth(this._viewProjectionMatrix),s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===vt.SPLIT&&s.setPendingUpdate(vt.SPLIT)),s}_mergeTile(e){Rh(!e.hasPendingUpdate(vt.SPLIT),"_mergeTile sanity check"),this._purgeChildTiles(e)&&(Rh(!e.renderData,"_mergeTile sanity check"),this._loadTile(e)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(e)}_loadChildren(e){Rh(e.rendered,"parent should be rendered"),e.unload(this._renderer),this._loadTile(e.children[0]),this._loadTile(e.children[1]),this._loadTile(e.children[2]),this._loadTile(e.children[3])}_loadParent(e){const t=e.parent;this._unloadChildren(t),this._loadTile(t)}_unloadChildren(e){e.isLeaf||(this._unloadChildren(e.children[0]),e.children[0].unload(this._renderer),this._unloadChildren(e.children[1]),e.children[1].unload(this._renderer),this._unloadChildren(e.children[2]),e.children[2].unload(this._renderer),this._unloadChildren(e.children[3]),e.children[3].unload(this._renderer))}_loadTile(e){e.load(this._renderer),e.setPendingUpdate(vt.RENDERDATA),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e),this._elevationUpdate(e)}_elevationDataArrived(e,t,i){const r=new Znt(e.lij,e.extent,i);e.dataArrived(t,Lt.ELEVATION,r);const s=[e],n=e.level,o=this._iteratorPool.acquire();for(o.reset(s);!o.done;){const a=o.next();a.findElevationBoundsForLayer(t,n),a.computeElevationBounds()}o.remove(),this._updateTilesVisibility(s)}_handleLayerViewChanges(e=e2){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const s of this.view.allLayerViews.items)if(i.add(s.uid),uT(s))if(this._basemapLayerViewHandles.has(s.uid)){const n=this._layerClassFromLayerView(s),o=this._layerIndexByUid[n].get(s.uid);o<r&&(t=!0),r=o}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach((s,n)=>{i.has(n)||(this._unregisterTiledLayerView(n),t=!0)}),t&&this._updateTiledLayers(),this._renderer.isTransparent=this._allTransparentSurfaceLayers(),e.madeProgress()}_allTransparentSurfaceLayers(){var e,t;let i=((e=this.view.map)==null||(t=e.ground)==null?void 0:t.opacity)===0;for(const r of this.view.allLayerViews.items)if(uT(r)&&!$$(r)&&!che(r.layer)&&r.fullOpacity!==0)return i=!1,i;return i}_layerClassFromLayerView(e){return $$(e)?Lt.ELEVATION:Lt.MAP}_registerTiledLayerView(e){const t=[],i=this._layerClassFromLayerView(e);t.push(e.watch("suspended",()=>this._updateTiledLayers())),t.push(e.watch("fullOpacity",()=>this._updateTileTextures(Qs.UNFADED))),t.push(e.layer.watch("effectiveScaleRange",()=>this._restartAllAgents(i))),e.on("data-changed",()=>{const r=this._layerIndexByUid[i].get(e.uid);r!=null&&this._invalidateLayerData(r,i)}),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(let i=0;i<t.length;i++)t[i].remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;const r=$u();e.forEach(s=>{const n=s.layer;if(!n||s.suspended||!uT(s))return;const o=s.fullExtent;if(!o)return void eh.warn("Terrain: Map or elevation layer does not have fullExtent: "+n.id);n0(r,o,r);const a=this._layerClassFromLayerView(s);if(a===Lt.MAP){const l=s.displayLevelRange;l.maxLevel!==1/0&&(i===null||l.maxLevel>i)&&(i=l.maxLevel)}t[a].push(s)});for(const s of y_){const n=this._layerViews[s],o=t[s];o.reverse();const a=o.length;let l=n.length!==a;const c=new Array(a),h=new Array(n.length);this._layerIndexByUid[s].clear();for(let p=0;p<a;p++){const f=o[p].uid;this._layerIndexByUid[s].set(f,p);const g=n.indexOf(o[p]);c[p]=g,p!==g&&(l=!0),g>-1&&(h[g]=p)}if(l){const p=this._postorderIterator;for(p.reset(this.rootTiles);!p.done;)p.next().modifyLayers(h,c,s);this._layerViews[s]=o,this._restartAllAgents(s),this._updateTilesVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){const i=t.next();i.restartAgents(e),e===Lt.ELEVATION&&i.computeElevationBounds()}}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll(t=>{t.updateAgents(Lt.MAP),e===Qs.IMMEDIATE?this.renderer.updateTileTexture(t,vt.TEXTURE_NOFADING):t.updateRenderData(Lt.MAP,e)}),this._renderer.isTransparent=this._allTransparentSurfaceLayers()}_invalidateLayerData(e,t){this._allTiles.forAll(i=>i.removeLayerAgent(e,t)),this._allTiles.forAll(i=>i.invalidateLayerData(e,t))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=ns.UPDATE){this.renderer.setNeedsRender(e)}requestUpdate(){++this._pendingUpdates==1&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),n=s.layer;return!n.tilemapCache||aN(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],me(I({},r),{timeout:6e3})).then(()=>--this._asyncWorkItems).catch(o=>{throw--this._asyncWorkItems,pr(o)||this._dataMissing(e,i,s,{notInTilemap:!0}),o}).then(()=>this._frameTask.schedule(()=>this._requestTileData(e,i,s,r),r.signal)))}_requestTileData(e,t,i,r){return t===Lt.ELEVATION?this._requestElevationTileData(e,i,r):this._requestMapTileData(e,i,r)}_requestElevationTileData(e,t,i){if(!$$(t))return void Rh(!1,"_requestElevationTileData can only be called for elevation layer views");const r=o=>{if(--this._asyncWorkItems,Us(i))return;const a=this._layerIndexByUid[Lt.ELEVATION].get(t.uid);a!=null?(this._usedMemory=uE,this.requestUpdate(),this._elevationDataArrived(e,a,o)):eh.warn("TerrainSurface: received data from unknown layer %d %s",Lt.ELEVATION,e.lij.toString())},s=o=>{--this._asyncWorkItems,pr(o)||(this._dataMissing(e,Lt.ELEVATION,t,o),this.requestUpdate())};if(++this._asyncWorkItems,Ure(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:sR,signal:i.signal}).then(o=>{if(Us(i))return eh.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s(pi());this._frameTask.schedule(()=>r(o),i.signal,s)},s);const n=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(n,"binary",i).then(o=>this._lercDecoder.decode(o,{noDataValue:sR},i.signal)).then(o=>{r({values:o.pixelData,width:o.width,height:o.height,noDataValue:o.noDataValue,minValue:o.minValue,maxValue:o.maxValue})},s)}_requestMapTileData(e,t,i){if(t instanceof R1e)return Promise.reject();++this._asyncWorkItems;const r=(c,h)=>{--this._asyncWorkItems,hT(h),Us(i)||(this._dataMissing(e,Lt.MAP,t,c),this.requestUpdate())},s=c=>h=>r(h,c),n=c=>this._frameTask.schedule(()=>{--this._asyncWorkItems,this.requestUpdate(),Us(i)?hT(c):this._mapTileDataArrived(e,t,c)},i.signal,s(c)).catch(s(c)),o=(c,h=null)=>this._frameTask.schedule(()=>r(c,h));if(aN(t)){const c=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(c[0],c[1],c[2],i).then(n,o)}if(rX(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(n,o);if(x1e(t)&&Ure(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(c=>{if(Us(i))return eh.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void o(pi());n(c)},o);let a=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);Mke(t.layer)&&t.layer.refreshTimestamp&&(a+=`${a.includes("?")?"&":"?"}_ts=${t.layer.refreshTimestamp}`);const l=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(a,l,i).then(n,o)}_mapTileDataArrived(e,t,i){const r=this._layerIndexByUid[Lt.MAP].get(t.uid);r!=null?e.dataArrived(r,Lt.MAP,i):(hT(i),eh.warn("TerrainSurface: received data from unknown layer"))}_dataMissing(e,t,i,r){const s=this._layerIndexByUid[t].get(i.uid);s!=null?e.dataMissing(s,t,r):eh.warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(e){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll(t=>{t.renderData&&this.overlayManager.setTileParameters(t)}),this._renderer.setNeedsRender(e))}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll(t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))}),e}getUsedMemory(){return this.tilingScheme?(this._usedMemory===uE&&(this._usedMemory=0,this._allTiles.forAll(e=>this._usedMemory+=e.usedMemory)),this._usedMemory):0}getUsedMemoryForLayerView(e){let t=0;const i=this._layerClassFromLayerView(e),r=this._layerIndexByUid[i].get(e.uid);return this._allTiles.forAll(s=>t+=s.getUsedMemoryForLayer(i,r)),t}getTile(e){if(R(e)||R(this.rootTiles))return null;const t=e.split("/").map(o=>+o);if(t[0]===0)return this.rootTiles.find(o=>o.lij[1]===t[1]&&o.lij[2]===t[2]);const i=2**t[0],r=Math.floor(t[1]/i),s=Math.floor(t[2]/i);let n;if(this.rootTiles.some(o=>o.lij[1]===r&&o.lij[2]===s&&(n=o,!0)),n){let o=1<<t[0]-1;for(;n.lij[0]<t[0];){let a=t[1]&o?2:0;if((t[2]&o)>0&&a++,!n.children[a])return null;n=n.children[a],o>>=1}return Rh(n.lij[0]===t[0]&&n.lij[1]===t[1]&&n.lij[2]===t[2],"not the right tile?"),n}return null}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{_(e.rootTiles)&&(e._mergeTile(e.rootTiles[0]),e._viewChangeUpdate())},getTiles:()=>e._allTiles.toArray(),getRenderedTiles(){Rz.clear(),e._allTiles.forAll(i=>{i.visible&&i.rendered&&Rz.push(i)});const t=Rz.toArray();return L1e(e.renderOrder,t),t},lockTilingScheme(t,i){e._extentHelper.defaultTiledLayersExtent=i,e.tilingSchemeLogic.test.lockTilingScheme(t)}}}};u([d()],zt.prototype,"_renderer",void 0),u([d()],zt.prototype,"_hasPendingUpdates",void 0),u([d()],zt.prototype,"_asyncWorkItems",void 0),u([d()],zt.prototype,"_allTilesDirty",void 0),u([d()],zt.prototype,"_allTilesSorted",void 0),u([d()],zt.prototype,"_viewChanged",void 0),u([d({readOnly:!0})],zt.prototype,"_watchUpdatingTracking",void 0),u([d()],zt.prototype,"_frameTask",void 0),u([d({readOnly:!0})],zt.prototype,"snapLevel",null),u([d({readOnly:!0})],zt.prototype,"lodSnapping",null),u([d({constructOnly:!0})],zt.prototype,"view",void 0),u([d()],zt.prototype,"_userClippingExtent",null),u([d()],zt.prototype,"_rootTilesExtent",void 0),u([d({readOnly:!0})],zt.prototype,"extent",null),u([d({readOnly:!0})],zt.prototype,"groundExtent",null),u([d({readOnly:!0})],zt.prototype,"_tilingSchemeExtent",null),u([d({readOnly:!0})],zt.prototype,"updating",null),u([d(C1e)],zt.prototype,"updatingProgress",void 0),u([d({readOnly:!0})],zt.prototype,"updatingProgressValue",null),u([d()],zt.prototype,"_maxNumUpdating",void 0),u([d({aliasOf:"view.map.ground.opacity"})],zt.prototype,"baseOpacity",void 0),u([d({readOnly:!0})],zt.prototype,"overlayManager",void 0),u([d({readOnly:!0})],zt.prototype,"viewingMode",null),u([d()],zt.prototype,"maxTextureScale",void 0),u([d({readOnly:!0})],zt.prototype,"ready",null),u([d({value:HR.FRONT_TO_BACK})],zt.prototype,"renderOrder",null),u([d({readOnly:!0})],zt.prototype,"rootTiles",void 0),u([d({readOnly:!0})],zt.prototype,"spatialReference",null),u([d()],zt.prototype,"backgroundImage",void 0),u([d({type:Je,aliasOf:"view.map.ground.surfaceColor"})],zt.prototype,"backgroundColor",void 0),u([d()],zt.prototype,"_background",null),u([d({value:!1})],zt.prototype,"slicePlaneEnabled",null),u([d({readOnly:!0})],zt.prototype,"tilingScheme",void 0),u([d({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],zt.prototype,"tilingSchemeLocked",void 0),u([d({readOnly:!0})],zt.prototype,"tilingSchemeLogic",void 0),u([d({value:!0})],zt.prototype,"velvetOverground",null),u([mt("_renderer.wireframe")],zt.prototype,"wireframe",void 0),u([d({value:!1})],zt.prototype,"suspended",null),u([d({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],zt.prototype,"textureFadeDuration",void 0),u([d()],zt.prototype,"_layerViewsDirty",void 0),u([mt("_renderer.renderPatchBorders")],zt.prototype,"renderPatchBorders",void 0),u([mt("_renderer.renderingDisabled")],zt.prototype,"renderingDisabled",void 0),zt=u([P("esri.views.3d.terrain.TerrainSurface")],zt);const alt=zt;function cse(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function MA(e){return!e.isLeaf&&(e.children[0].shouldLoad||e.children[1].shouldLoad||e.children[2].shouldLoad||e.children[3].shouldLoad||MA(e.children[0])||MA(e.children[1])||MA(e.children[2])||MA(e.children[3]))}function llt(e){return e.isLeaf&&e.parent&&e.parent.shouldLoad}const uE=-1,th=ni(),clt=Dt(),RP=[0,0,0],Rz=new $t,OP={spatialReference:null,tile:null,extent:null,context:"ground"},MP={spatialReference:null,extent:null,scale:0};let PA=class extends we{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commit(e){this.dirty=!1,this._dirtyGeomRecords.forEach((t,i)=>this.commitLayer(i,e))}commitLayer(e,t){const i=this._dirtyGeomRecords.get(e);i&&(i.forEach((r,s)=>{const n=this._ensureGeomRecord(e,s);r.forEach((o,a)=>{const l=o[0],c=o[1],h=o[2];let p=!1;if(c&Gt.Geometry.UPDATE){const f=n.get(a);if(f){const g=f[1];if(h&Gt.State.TRANSFORMATION){const y=this.model.getObject(s);this.model.updateRenderGeometryTransformation(y,l,g)&&(p=!0)}p||t.updates.push({renderGeometry:g,updateType:h})}else at(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(c&Gt.Geometry.REMOVE||p){const f=n.get(a);f?(t.removes.push(f[1]),n.delete(a),f[0].disposed&&Y1.pool.release(f[0])):c===Gt.Geometry.REMOVE&&at(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(c&Gt.Geometry.ADD||p){const f=this.model.getObject(s);if(_(f)){const g=this.model.getRenderGeometry(f,l),y=[l,g];t.adds.push(g),n.set(a,y)}}}),n.size===0&&this._residentGeomRecords.get(e).delete(s)}),this._residentGeomRecords.get(e).size===0&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e))}getResidentRenderGeometries(e,t){const i=this._residentGeomRecords.get(e);i&&i.forEach(r=>r.forEach(s=>t.push(s[1])))}_objectStateChanged(e,t){for(const i of t.geometryRecords)this._updateOrCreateDirtyRecord(t,i,null,Gt.Geometry.UPDATE,0,0,Gt.Geometry.UPDATE,Gt.Geometry.ADD|Gt.Geometry.REMOVE,e)}visibilityChanged(e){this._objectStateChanged(Gt.State.VISIBILITIES,e)}highlightChanged(e){this._objectStateChanged(Gt.State.HIGHLIGHTS,e)}occlusionChanged(e){this._objectStateChanged(Gt.State.OCCLUDEES,e)}vertexAttrsUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.record,null,Gt.Geometry.UPDATE,0,0,Gt.Geometry.UPDATE,Gt.Geometry.ADD|Gt.Geometry.REMOVE,Gt.State.VERTEXATTRS)}layerAdded(e){e.objects.forAll(t=>this._layerObjectAdded(e,t))}layerRemoved(e){e.objects.forAll(t=>this._layerObjectRemoved(e,t))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const i=e.id;for(const r of t.geometryRecords)this._objectGeometryAdded(t,r,i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const i=e.id;for(const r of t.geometryRecords)this._objectGeometryRemoved(t,r,i)}shaderTransformationChanged(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach((i,r)=>{const s=this.model.getObject(r);s&&s.hasVolativeTransformation()&&i.forEach(n=>{n[1].shaderTransformationChanged()})})}objectTransformation(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach(r=>{this._updateOrCreateDirtyRecord(e,r[0],t,Gt.Geometry.UPDATE,0,0,Gt.Geometry.UPDATE,Gt.Geometry.ADD|Gt.Geometry.REMOVE,Gt.State.TRANSFORMATION)})}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.record)}_objectGeometryAdded(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,Gt.Geometry.ADD,Gt.Geometry.REMOVE,0,0,0)}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.record)}_objectGeometryRemoved(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,Gt.Geometry.REMOVE,Gt.Geometry.ADD,Gt.Geometry.UPDATE,0,0)}_updateOrCreateDirtyRecord(e,t,i,r,s,n,o,a,l){i=gt(i,this._getParentLayerId(e));const c=e.id,h=t.id,p=this._ensureDirtyRecord(i,c),f=p.get(h);if(f){const g=f[1];g&s?(p.delete(h),f[0].disposed&&Y1.pool.release(f[0])):g&n?(f[1]=r,f[2]=l):g&o?f[2]|=l:g&a||at(!1,"ModelDirtySet.objectGeometryAdded: inconsistent state")}else p.set(h,[t,r,l]);this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}get _hasDirtyGeometryRecords(){return qr(this._dirtyGeomRecords,e=>qr(e,t=>t&&t.size>0))}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_getParentLayerId(e){return _(e.parentLayer)?e.parentLayer.id:ITe}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach((i,r)=>{i.forEach((s,n)=>{t.length>0&&(t+=`
`),t+=r+"."+n;const o=[];s.forEach(a=>{const l=a[1];o[l]||(o[l]=[]),o[l].push(a[0].geometry.id)});for(let a=0;a<o.length;a++)if(o[a]){t+=" "+e[a-1]+": ";for(let l=0;l<o[a].length;l++)t+=o[a][l]+", "}})}),t}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce((t,i)=>t+i.size,0)}}}};u([d({constructOnly:!0})],PA.prototype,"model",void 0),u([d()],PA.prototype,"dirty",void 0),PA=u([P("esri.views.3d.webgl-engine.lib.ModelDirtySet")],PA);const ult=PA;let F$=class extends we{constructor(){super(...arguments),this.dirtySet=new ult({model:this}),this._content=new Map,this._originFactory=new IW(null,75e4)}getObject(e){return this._content.get(e)}add(e){const t=e.id;at(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),qL(e)&&this.dirtySet.layerAdded(e)}remove(e){at(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),qL(e)&&this.dirtySet.layerRemoved(e)}addMany(e){for(const t of e)_(t)&&(at(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(const t of e)at(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload()}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach(i=>{i.type===e&&t(i)})}getRenderGeometry(e,t){const{geometry:i,material:r,id:s,shaderTransformation:n,origin:o,instanceParameters:a}=t,l=new CS(i,r,{id:s,boundingInfo:i.boundingInfo,calculateShaderTransformation:n,castShadow:e.castShadow});return l.updateTransformation(c=>e.getCombinedStaticTransformation(t,c)),l.origin=o||this._originFactory.getOrigin(l.boundingSphere),l.instanceParameters=a,l}updateRenderGeometryTransformation(e,t,i){if(R(e))return!1;i.updateTransformation(s=>e.getCombinedStaticTransformation(t,s));const r=this._originFactory.getOrigin(i.boundingSphere);return i.origin!==r}getStats(){const e={},t=Array.from(this._content.values());for(let i=0;i<rd.COUNT;++i)e[i]=t.filter(r=>r.type===i).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};u([d({constructOnly:!0})],F$.prototype,"dirtySet",void 0),F$=u([P("esri.views.3d.webgl-engine.parts.Model")],F$);function hlt(){const e=new Float32Array(4);return e[3]=1,e}function q1e(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function dlt(e,t,i,r){const s=new Float32Array(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function W1e(e,t){return new Float32Array(e,t,4)}Object.freeze({__proto__:null,create:hlt,clone:q1e,fromValues:dlt,createView:W1e});const RS=1e-6,hE=[0,0,0],PP=[0,0,0];function plt(e,t){const{data:i,size:r}=e,s=i.length/r;if(s<=0)return;const n=new xlt(e);U$(hE,n.minProj,n.maxProj),B_(hE,hE,.5),bu(PP,n.maxProj,n.minProj);const o=AG(PP),a=new Tlt;a.quality=o,s<14&&(e={data:new Float64Array(n.buffer,112,42),size:3});const l=[0,0,0],c=[0,0,0],h=[0,0,0],p=[0,0,0],f=[0,0,0],g=[0,0,0],y=[0,0,0];switch(flt(n,e,y,l,c,h,p,f,g,a)){case 1:return void pse(hE,PP,t);case 2:return void wlt(e,p,t)}mlt(e,y,l,c,h,p,f,g,a),X1e(e,a.b0,a.b1,a.b2,fT,mT);const v=[0,0,0];bu(v,mT,fT),a.quality=AG(v),a.quality<o?Y1e(a.b0,a.b1,a.b2,fT,mT,v,t):pse(hE,PP,t)}function flt(e,t,i,r,s,n,o,a,l,c){return glt(e,r,s),CG(r,s)<RS?1:(bu(o,r,s),Ln(o,o),ylt(t,r,o,n)<RS?2:(bu(a,s,n),Ln(a,a),bu(l,n,r),Ln(l,l),wu(i,a,o),Ln(i,i),v_(t,i,o,a,l,c),0))}const dE=[0,0,0],pE=[0,0,0],Bc=[0,0,0],Vc=[0,0,0],Gc=[0,0,0],Og=[0,0,0],Mg=[0,0,0],Pg=[0,0,0];function mlt(e,t,i,r,s,n,o,a,l){vlt(e,t,i,dE,pE),dE[0]!==void 0&&(bu(Bc,dE,i),Ln(Bc,Bc),bu(Vc,dE,r),Ln(Vc,Vc),bu(Gc,dE,s),Ln(Gc,Gc),wu(Og,Vc,n),Ln(Og,Og),wu(Mg,Gc,o),Ln(Mg,Mg),wu(Pg,Bc,a),Ln(Pg,Pg),v_(e,Og,n,Vc,Bc,l),v_(e,Mg,o,Gc,Vc,l),v_(e,Pg,a,Bc,Gc,l)),pE[0]!==void 0&&(bu(Bc,pE,i),Ln(Bc,Bc),bu(Vc,pE,r),Ln(Vc,Vc),bu(Gc,pE,s),Ln(Gc,Gc),wu(Og,Vc,n),Ln(Og,Og),wu(Mg,Gc,o),Ln(Mg,Mg),wu(Pg,Bc,a),Ln(Pg,Pg),v_(e,Og,n,Vc,Bc,l),v_(e,Mg,o,Gc,Vc,l),v_(e,Pg,a,Bc,Gc,l))}function glt(e,t,i){let r=CG(e.maxVert[0],e.minVert[0]),s=0;for(let n=1;n<7;++n){const o=CG(e.maxVert[n],e.minVert[n]);o>r&&(r=o,s=n)}dl(t,e.minVert[s]),dl(i,e.maxVert[s])}const jc=[0,0,0];function ylt(e,t,i,r){const{data:s,size:n}=e;let o=Number.NEGATIVE_INFINITY,a=0;for(let l=0;l<s.length;l+=n){jc[0]=s[l]-t[0],jc[1]=s[l+1]-t[1],jc[2]=s[l+2]-t[2];const c=i[0]*jc[0]+i[1]*jc[1]+i[2]*jc[2],h=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],p=jc[0]*jc[0]+jc[1]*jc[1]+jc[2]*jc[2]-c*c/h;p>o&&(o=p,a=l)}return dl(r,s,a),o}const Fs=[0,0];function vlt(e,t,i,r,s){blt(e,t,Fs,s,r);const n=Q1e(i,t);Fs[1]-RS<=n&&(r[0]=void 0),Fs[0]+RS>=n&&(s[0]=void 0)}const use=[0,0,0],hse=[0,0,0],dse=[0,0,0],lw=[0,0,0],cw=[0,0,0],IP=[0,0,0];function v_(e,t,i,r,s,n){if(Z1e(t)<RS)return;wu(use,i,t),wu(hse,r,t),wu(dse,s,t),pT(e,t,Fs),cw[1]=Fs[0],lw[1]=Fs[1],IP[1]=lw[1]-cw[1];const o=[i,r,s],a=[use,hse,dse];for(let l=0;l<3;++l){pT(e,o[l],Fs),cw[0]=Fs[0],lw[0]=Fs[1],pT(e,a[l],Fs),cw[2]=Fs[0],lw[2]=Fs[1],IP[0]=lw[0]-cw[0],IP[2]=lw[2]-cw[2];const c=AG(IP);c<n.quality&&(dl(n.b0,o[l]),dl(n.b1,t),dl(n.b2,a[l]),n.quality=c)}}const _lt=[0,0,0];function pT(e,t,i){const{data:r,size:s}=e;i[0]=Number.POSITIVE_INFINITY,i[1]=Number.NEGATIVE_INFINITY;for(let n=0;n<r.length;n+=s){const o=r[n]*t[0]+r[n+1]*t[1]+r[n+2]*t[2];i[0]=Math.min(i[0],o),i[1]=Math.max(i[1],o)}}function blt(e,t,i,r,s){const{data:n,size:o}=e;dl(r,n),dl(s,r),i[0]=Q1e(_lt,t),i[1]=i[0];for(let a=o;a<n.length;a+=o){const l=n[a]*t[0]+n[a+1]*t[1]+n[a+2]*t[2];l<i[0]&&(i[0]=l,dl(r,n,a)),l>i[1]&&(i[1]=l,dl(s,n,a))}}function pse(e,t,i){dl(i.center,e),B_(i.halfSize,t,.5),i.quaternion[0]=0,i.quaternion[1]=0,i.quaternion[2]=0,i.quaternion[3]=1}const df=[0,0,0],uw=[0,0,0],fE=[0,0,0],fT=[0,0,0],mT=[0,0,0],fse=[0,0,0];function wlt(e,t,i){dl(df,t),Math.abs(t[0])>Math.abs(t[1])&&Math.abs(t[0])>Math.abs(t[2])?df[0]=0:Math.abs(t[1])>Math.abs(t[2])?df[1]=0:df[2]=0,Z1e(df)<RS&&(df[0]=df[1]=df[2]=1),wu(uw,t,df),Ln(uw,uw),wu(fE,t,uw),Ln(fE,fE),X1e(e,t,uw,fE,fT,mT),bu(fse,mT,fT),Y1e(t,uw,fE,fT,mT,fse,i)}function X1e(e,t,i,r,s,n){pT(e,t,Fs),s[0]=Fs[0],n[0]=Fs[1],pT(e,i,Fs),s[1]=Fs[0],n[1]=Fs[1],pT(e,r,Fs),s[2]=Fs[0],n[2]=Fs[1]}const $P=[0,0,0],Sd=[1,0,0,0,1,0,0,0,1],hw=[0,0,0];function Y1e(e,t,i,r,s,n,o){Sd[0]=e[0],Sd[1]=e[1],Sd[2]=e[2],Sd[3]=t[0],Sd[4]=t[1],Sd[5]=t[2],Sd[6]=i[0],Sd[7]=i[1],Sd[8]=i[2],Slt(o.quaternion,Sd),U$(hw,r,s),B_(hw,hw,.5),B_(o.center,e,hw[0]),B_($P,t,hw[1]),U$(o.center,o.center,$P),B_($P,i,hw[2]),U$(o.center,o.center,$P),B_(o.halfSize,n,.5)}const Dl=7;class xlt{constructor(t){this.minVert=new Array(Dl),this.maxVert=new Array(Dl);const i=64*Dl;this.buffer=new ArrayBuffer(i);let r=0;this.minProj=new Float64Array(this.buffer,r,Dl),r+=8*Dl,this.maxProj=new Float64Array(this.buffer,r,Dl),r+=8*Dl;for(let l=0;l<Dl;++l)this.minVert[l]=new Float64Array(this.buffer,r,3),r+=24;for(let l=0;l<Dl;++l)this.maxVert[l]=new Float64Array(this.buffer,r,3),r+=24;for(let l=0;l<Dl;++l)this.minProj[l]=Number.POSITIVE_INFINITY,this.maxProj[l]=Number.NEGATIVE_INFINITY;const s=new Array(Dl),n=new Array(Dl),{data:o,size:a}=t;for(let l=0;l<o.length;l+=a){let c=o[l];c<this.minProj[0]&&(this.minProj[0]=c,s[0]=l),c>this.maxProj[0]&&(this.maxProj[0]=c,n[0]=l),c=o[l+1],c<this.minProj[1]&&(this.minProj[1]=c,s[1]=l),c>this.maxProj[1]&&(this.maxProj[1]=c,n[1]=l),c=o[l+2],c<this.minProj[2]&&(this.minProj[2]=c,s[2]=l),c>this.maxProj[2]&&(this.maxProj[2]=c,n[2]=l),c=o[l]+o[l+1]+o[l+2],c<this.minProj[3]&&(this.minProj[3]=c,s[3]=l),c>this.maxProj[3]&&(this.maxProj[3]=c,n[3]=l),c=o[l]+o[l+1]-o[l+2],c<this.minProj[4]&&(this.minProj[4]=c,s[4]=l),c>this.maxProj[4]&&(this.maxProj[4]=c,n[4]=l),c=o[l]-o[l+1]+o[l+2],c<this.minProj[5]&&(this.minProj[5]=c,s[5]=l),c>this.maxProj[5]&&(this.maxProj[5]=c,n[5]=l),c=o[l]-o[l+1]-o[l+2],c<this.minProj[6]&&(this.minProj[6]=c,s[6]=l),c>this.maxProj[6]&&(this.maxProj[6]=c,n[6]=l)}for(let l=0;l<Dl;++l){let c=s[l];dl(this.minVert[l],o,c),c=n[l],dl(this.maxVert[l],o,c)}}}class Tlt{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}}function AG(e){return e[0]*e[1]+e[0]*e[2]+e[1]*e[2]}function U$(e,t,i){e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2]}function bu(e,t,i){e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2]}function B_(e,t,i){e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}function dl(e,t,i=0){e[0]=t[i+0],e[1]=t[i+1],e[2]=t[i+2]}function wu(e,t,i){const r=t[0],s=t[1],n=t[2],o=i[0],a=i[1],l=i[2];e[0]=s*l-n*a,e[1]=n*o-r*l,e[2]=r*a-s*o}function Ln(e,t){const i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(i>0){const r=1/Math.sqrt(i);e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}}function Z1e(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}function CG(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return i*i+r*r+s*s}function Q1e(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Slt(e,t){const i=t[0]+t[4]+t[8];if(i>0){let r=Math.sqrt(i+1);e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r}else{let r=0;t[4]>t[0]&&(r=1),t[8]>t[3*r+r]&&(r=2);const s=(r+1)%3,n=(r+2)%3;let o=Math.sqrt(t[3*r+r]-t[3*s+s]-t[3*n+n]+1);e[r]=.5*o,o=.5/o,e[3]=(t[3*s+n]-t[3*n+s])*o,e[s]=(t[3*s+r]+t[3*r+s])*o,e[n]=(t[3*n+r]+t[3*r+n])*o}}const AC=k0(),i1=M(),Elt=M(),Alt=wr();class o0t{constructor(t){const o=t*56;this.buffer=new ArrayBuffer(o),this.obbs=new Array(t);for(let a=0;a<t;a++)this.obbs[a]={center:o7(this.buffer,56*a+0),halfSize:Pge(this.buffer,56*a+24),quaternion:W1e(this.buffer,56*a+36)}}}function J1e(e=[0,0,0],t=[-1,-1,-1],i=[0,0,0,1]){return{center:As(e),halfSize:bL(t),quaternion:q1e(i)}}function Clt(e){return J1e(e.center,e.halfSize,e.quaternion)}function a0t(e,t){ne(t.center,e.center),ne(t.halfSize,e.halfSize),Rge(t.quaternion,e.quaternion)}function l0t(e,t){return t=t||J1e(),plt(e,t),t}function __(e,t){const i=tr(t,e.center),r=Q4(e,t);return i>r?1:i<-r?-1:0}function c0t(e,t){t||(t=cs());const i=Eq(Alt,e.quaternion),r=e.halfSize[0]*Math.abs(i[0])+e.halfSize[1]*Math.abs(i[3])+e.halfSize[2]*Math.abs(i[6]),s=e.halfSize[0]*Math.abs(i[1])+e.halfSize[1]*Math.abs(i[4])+e.halfSize[2]*Math.abs(i[7]),n=e.halfSize[0]*Math.abs(i[2])+e.halfSize[1]*Math.abs(i[5])+e.halfSize[2]*Math.abs(i[8]);return t[0]=e.center[0]-r,t[1]=e.center[1]-s,t[2]=e.center[2]-n,t[3]=e.center[0]+r,t[4]=e.center[1]+s,t[5]=e.center[2]+n,t}function u0t(e,t){return tr(t,e.center)-Q4(e,t)}function h0t(e,t){return tr(t,e.center)+Q4(e,t)}function d0t(e,t){return __(e,t[0])<=0&&__(e,t[1])<=0&&__(e,t[2])<=0&&__(e,t[3])<=0&&__(e,t[4])<=0&&__(e,t[5])<=0}function p0t(e,t,i,r=0){OO(AC,e.quaternion),de(i1,t,e.center);const s=p0(i1,i1,AC),n=p0(Elt,i,AC);let o=-1/0,a=1/0;for(let l=0;l<3;l++)if(Math.abs(n[l])>1e-6){const c=(r+e.halfSize[l]-s[l])/n[l],h=(-r-e.halfSize[l]-s[l])/n[l];o=Math.max(o,Math.min(c,h)),a=Math.min(a,Math.max(c,h))}else if(s[l]>e.halfSize[l]+r||s[l]<-e.halfSize[l]-r)return!1;return o<=a}(()=>{const e=new Int8Array(162);let t=0;const i=r=>{for(let s=0;s<r.length;s++)e[t+s]=r[s];t+=6};return i([6,2,3,1,5,4]),i([0,2,3,1,5,4]),i([0,2,3,7,5,4]),i([0,1,3,2,6,4]),i([0,1,3,2,0,0]),i([0,1,5,7,3,2]),i([0,1,3,7,6,4]),i([0,1,3,7,6,2]),i([0,1,5,7,6,2]),i([0,1,5,4,6,2]),i([0,1,5,4,0,0]),i([0,1,3,7,5,4]),i([0,2,6,4,0,0]),i([0,0,0,0,0,0]),i([1,3,7,5,0,0]),i([2,3,7,6,4,0]),i([2,3,7,6,0,0]),i([2,3,1,5,7,6]),i([0,1,5,7,6,2]),i([0,1,5,7,6,4]),i([0,1,3,7,6,4]),i([4,5,7,6,2,0]),i([4,5,7,6,0,0]),i([4,5,1,3,7,6]),i([0,2,3,7,5,4]),i([6,2,3,7,5,4]),i([6,2,3,1,5,4]),e})();function Q4(e,t){OO(AC,e.quaternion),p0(i1,t,AC);const i=e.halfSize;return Math.abs(i1[0]*i[0])+Math.abs(i1[1]*i[1])+Math.abs(i1[2]*i[2])}function f0t(e,t){for(let i=0;i<8;++i){const r=t[i];r[0]=1&i?-e.halfSize[0]:e.halfSize[0],r[1]=2&i?-e.halfSize[1]:e.halfSize[1],r[2]=4&i?-e.halfSize[2]:e.halfSize[2],p0(r,r,e.quaternion),pe(r,r,e.center)}}function Rlt(e){return h7(e.halfSize)}class Olt{constructor(t){this._totalCount=t,this._indexRanges=[0,t]}componentCount(){const t=this._indexRanges;let i=0;for(let r=0;r<t.length;r+=2)i+=t[r+1];return i}reset(t){t==="all"||t.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=Mlt(t)}forEachComponent(t){const i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r],n=s+i[r+1];for(let o=s;o<n;o++)if(!t(o))return!1}return!0}forEachComponentRange(t){const i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r];if(!t(s,s+i[r+1]))return!1}return!0}computeOffsetRanges(t){const i=new Array(this._indexRanges.length),r=this._indexRanges;for(let s=0;s<r.length;s+=2){const n=r[s],o=n+r[s+1],a=t[n],l=t[o];i[s]=a,i[s+1]=l-a}return i}}function Mlt(e){const t=new Array;if(e.length===0)return t;let i=e[0],r=1;for(let s=1;s<e.length;s++){const n=e[s];i+r===n?r+=1:(t.push(i),t.push(r),i=n,r=1)}return t.push(i),t.push(r),t}class Plt extends y4{constructor(t,i){super(),this.pickability=null,this.highlightCounts=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=y7(i);const r=this.count;this.visibility=new Olt(r),this.materialDataBuffer=t.getBuffer(r),this.materialDataIndices=new Uint16Array(r);for(let s=0;s<r;s++)this.materialDataIndices[s]=this.materialDataBuffer.acquireIndex()}dispose(){super.dispose();for(let t=0;t<this.count;t++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[t])}get count(){return this.offsets.length-1}get geometryRanges(){return R(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return R(this.highlightCounts)?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return R(this.highlightCounts)?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((R(this.cachedHighlightRanges)||R(this.cachedDefaultRanges))&&_(this.highlightCounts)){const{highlightRanges:t,defaultRanges:i}=Ilt(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=t,this.cachedDefaultRanges=i}}}function Ilt(e,t,i){const r=[],s=[];let n=i.length,o=i.length;return t.forEachComponent(a=>(e[a]>0?(n!==a-1&&(r.length&&r.push(i[n+1]-r[r.length-1]),r.push(i[a])),n=a):(o!==a-1&&(s.length&&s.push(i[o+1]-s[s.length-1]),s.push(i[a])),o=a),!0)),r.length&&r.push(i[n+1]-r[r.length-1]),s.length&&s.push(i[o+1]-s[s.length-1]),{highlightRanges:r,defaultRanges:s}}class RG extends y4{constructor(){super(...arguments),this.visible=gT.Hidden}}var gT;u([Dn()],RG.prototype,"renderable",void 0),u([Dn()],RG.prototype,"components",void 0),function(e){e[e.Hidden=0]="Hidden",e[e.Visible=1]="Visible"}(gT||(gT={}));function $lt(e){return typeof e=="function"}function Dlt(e,t,i,r){if(i>=t)return e;e==null&&(e=Llt());const s=e.isVisibleBit;let n=e.data;const o=ebe(n),a=i/o|0,l=i-o*a,c=(t-1)/o|0,h=n,p=r===s;if(!(i<h.length*o)&&p){const g=a+1,y=Math.ceil(h.length*1.5),v=c+1;let b=Math.max(g,y);b=Math.min(b,v),n=new Uint32Array(b),n.set(h)}return a<n.length&&(n[a]=Flt(n[a],l,p)),e.data=n,e}function K1e(e,t){if(e==null)return!0;const{isVisibleBit:i,data:r}=e,s=ebe(r);return t<r.length*s?Nlt(i,r,t,s):!e.isVisibleBit}function Llt(e=!0){return{isVisibleBit:!e,data:new Uint32Array(0)}}function Nlt(e,t,i,r){const s=i/r|0,n=i-s*r;return Ult(t[s],n)===e}function ebe(e){return e.BYTES_PER_ELEMENT*8}function Flt(e,t,i){return e&~(1<<t)|(i?1:0)<<t}function Ult(e,t){return(e&1<<t)!=0}class klt{constructor(t,i){this._indices=_(t.indices)?t.indices:vS(t.positions.length/3),this._positions=new Si(t.positions),this._components=i,this._componentIntersectionData=new Array(i.count)}getComponentAabb(t,i){if(_(this._perComponentAabbs)){for(let r=0;r<6;r++)i[r]=this._perComponentAabbs[6*t+r];return i}return this._computePerComponentAabbs(),this.getComponentAabb(t,i)}getComponentPositions(t,i){i.indices=this._indices,i.data=this._positions.typedBuffer,i.stride=this._positions.typedBufferStride,i.startIndex=this._components.offsets[t],i.endIndex=this._components.offsets[t+1]}intersect(t,i,r,s,n,o){const a={data:this._positions.typedBuffer,stride:this._positions.typedBufferStride,size:3},l=this._indices,c=this._components.offsets,h=v0e(t,i,zlt);this._components.visibility.forEachComponent(p=>{if(!K1e(this._components.pickability,p))return!0;const f=this.getComponentAabb(p,Blt);if(_(n)&&n.applyToAabb(f),!nW(f,t,h,r))return!0;const g=c[p]/3,y=c[p+1]/3,v=(w,S,T)=>{o(p,w,al(S,S,s),T)},b=y-g;return R(n)&&b>SG?(this._componentIntersectionData[p]==null&&(this._componentIntersectionData[p]=new ib(this._indices,g,y,a)),this._componentIntersectionData[p].intersectRay({r0:t,r1:i},v)):LO(t,i,g,y,l,a,void 0,n,v),!0})}_computePerComponentAabbs(){const t=this._components.count;this._perComponentAabbs=new Float32Array(6*t);for(let i=0;i<t;i++)this._computeAABB(i)}_computeAABB(t){const i=this._indices,r=this._positions,s=this._components.offsets,n=s[t],o=s[t+1],a=[0,0,0],l=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];for(let p=n;p<o;p++){const f=i[p];r.getVec(f,a),loe(l,l,a),coe(c,c,a)}let h=6*t;this._perComponentAabbs[h++]=l[0],this._perComponentAabbs[h++]=l[1],this._perComponentAabbs[h++]=l[2],this._perComponentAabbs[h++]=c[0],this._perComponentAabbs[h++]=c[1],this._perComponentAabbs[h]=c[2]}get positions(){return this._positions}get indices(){return this._indices}}const zlt=M(),Blt=cs();class Vlt{constructor(t,i,r,s){this.material=t,this.drawParameters=i,this.geometry=r,this.meta=s}dispose(){this.material.dispose(),this.geometry.dispose()}}class tbe extends y4{constructor(t,i,r,s){super(),this.primitiveType=i,this.parameters=r,this.indexed=s,this.vao=t}}u([Dn()],tbe.prototype,"vao",void 0);function Glt(e,t){return{near:e,far:t}}function XO(e){return e?WR(e,1/0,-1/0):Glt(1/0,-1/0)}function WR(e,t,i){return e.near=t,e.far=i,e}function OS(e,t,i=e){return i.near=Math.min(e.near,t.near),i.far=Math.max(e.far,t.far),i}function DP(e,t){return e.near<=t&&t<=e.far}const OG={near:0,far:0};function jlt(e,t){const i=XO(),{eye:r,frustum:s,viewForward:n}=e;t.forAll(o=>{const a=o.obb,l=_e(vp(jl,a.center,r),n),c=Q4(a,n);if(DP(i,l-c)&&DP(i,l+c))return;const h=Ylt(a,s);if(h===-1)return;if(h===0)return pf.far=l+c,pf.near=l-c,void OS(i,pf);const p=LP.pushNew();p.near=l-c,p.far=l+c,p.mask=h,p.object=o});for(let o=0;o<LP.length;o++){const a=LP.data[o];if(DP(i,a.near)&&DP(i,a.far))continue;pf.far=a.far,pf.near=1/0,Xlt(a.object.obb,r,Hlt,c=>{let h=qlt;for(let p=0;p<ibe&&c.length>0;p++){if((a.mask&1<<p)==0)continue;Wlt(s[p],c,h);const f=c;c=h,h=f}for(let p=0;p<c.length;p+=3){oe(ua,c.data[p+0],c.data[p+1],c.data[p+2]);const f=_e(vp(ua,ua,r),n);pf.near=Math.min(pf.near,f)}})===0&&(pf.near=0),OS(i,pf)}return LP.length=0,i}const LP=new $t({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),pf=XO(),ua=M(),Rv=M(),Hlt=new $t({deallocator:null}),qlt=new $t({deallocator:null});function Wlt(e,t,i){i.length=0;const r=t.length-3;Oz(ua,t,r);const s=tr(e,ua);s<=0&&(i.push(ua[0]),i.push(ua[1]),i.push(ua[2]));let n=0,o=s;for(;n<r;n+=3){Oz(Rv,t,n);const a=tr(e,Rv);o*a<0&&(Cs(ua,Rv,ua,a/(a-o)),ha(i,ua)),a<=0&&ha(i,Rv),o=a,ne(ua,Rv)}o*s<0&&(Oz(Rv,t,r),Cs(ua,Rv,ua,s/(s-o)),ha(i,ua))}function Oz(e,t,i){return oe(e,t.data[i+0],t.data[i+1],t.data[i+2])}function ha(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function Xlt(e,t,i,r){OO(gse,e.quaternion),vp(jl,t,e.center),p0(jl,jl,gse);const s=8*((jl[0]<-e.halfSize[0]?-1:jl[0]>e.halfSize[0]?1:0)+3*(jl[1]<-e.halfSize[1]?-1:jl[1]>e.halfSize[1]?1:0)+9*(jl[2]<-e.halfSize[2]?-1:jl[2]>e.halfSize[2]?1:0)+13),n=mse[s];if(n===0)return n;Eq(NP,e.quaternion),Sq(NP,NP,e.halfSize);const o=(a,l)=>{const c=mse[s+l+1];return oe(a,((1&c)<<1)-1,(2&c)-1,((4&c)>>1)-1),al(a,a,NP),pe(a,e.center,a)};return i.length=0,ha(i,o(Mz,0)),ha(i,o(yse,1)),ha(i,o(jl,2)),ha(i,o(vse,3)),r(i),n===1||(i.length=0,ha(i,Mz),ha(i,vse),ha(i,o(jl,4)),ha(i,o(_se,5)),r(i),n===2||(i.length=0,ha(i,Mz),ha(i,_se),ha(i,o(jl,6)),ha(i,yse),r(i))),n}const mse=(()=>{const e=new Int8Array(216);let t=0;const i=r=>{for(let s=0;s<r.length;s++)e[t+s]=r[s];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),ibe=4;function Ylt(e,t){let i=0;for(let r=0;r<ibe;r++){const s=__(e,t[r]);if(s>0)return-1;s===0&&(i|=1<<r)}return i}const NP=wr(),gse=k0(),jl=M(),Mz=M(),yse=M(),vse=M(),_se=M();class Zlt{constructor(t){this._objects=t}submit(t,i){this._objects.preSubmit(i),this._objects.visibleObjects.forAll(r=>r.renderable.material.submit(t,r))}queryShadowCasterDepthRange(t){return this._objects.visibleObjects.length?jlt(t,this._objects.visibleObjects):null}}function Qlt(e){const t=kr().vec3f(E.POSITION);return e.normals&&t.vec2i16(E.NORMALCOMPRESSED,{glNormalized:!0}),e.textureCoordinates===_n.Default?t.vec2f(E.UV0):e.textureCoordinates===_n.Atlas&&(t.vec2f(E.UV0),t.vec4u16(E.UVREGION,{glNormalized:!0})),e.colors&&t.vec4u8(E.COLOR,{glNormalized:!0}),t.alignTo(4)}var $p;function Jlt(e,t){t.componentData===$p.Varying&&(e.vertex.uniforms.add("componentColorTex","sampler2D"),e.vertex.uniforms.add("componentColorTexInvDim","vec2"),e.attributes.add(E.COMPONENTINDEX,"float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4"),e.include(c_e),e.vertex.code.add(x`vec4 _readComponentColor() {
float normalizedIndex = (componentIndex + 0.5) * componentColorTexInvDim.x;
vec2 indexCoord = vec2(
mod(normalizedIndex, 1.0),
(floor(normalizedIndex) + 0.5) * componentColorTexInvDim.y
);
return texture2D(componentColorTex, indexCoord);
}
vec4 forwardExternalColor(out bool castShadows) {
vec4 componentColor = _readComponentColor() * 255.0;
float shadowFlag = mod(componentColor.b * 255.0, 2.0);
componentColor.b -= shadowFlag;
castShadows = shadowFlag >= 1.0;
int decodedColorMixMode;
vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451;
vExternalColorMixMode = float(decodedColorMixMode) + 0.5;
return vExternalColor;
}`),e.fragment.code.add(x`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = int(vExternalColorMixMode);
}`)),t.componentData===$p.Uniform&&(e.vertex.uniforms.add("externalColor","vec4"),e.fragment.uniforms.add("externalColorMixMode","int"),e.varyings.add("vExternalColor","vec4"),e.vertex.code.add(x`vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`),e.fragment.code.add(x`void readExternalColor(out vec4 color, out int colorMixMode) {
color = vExternalColor;
colorMixMode = externalColorMixMode;
}`))}(function(e){e[e.Uniform=0]="Uniform",e[e.Varying=1]="Varying",e[e.COUNT=2]="COUNT"})($p||($p={}));var Eu;function Klt(e,t){const i=e.vertex;switch(i.code.add(x`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),t.vertexDiscardMode){case Eu.None:i.code.add(x`#define vertexDiscardByOpacity(_opacity_) {}`);break;case Eu.Opaque:i.code.add(x`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case Eu.Transparent:i.code.add(x`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`)}}(function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"})(Eu||(Eu={}));function bse(e,t){e.include(xb,t),e.fragment.include(FR);const i=e.fragment;i.uniforms.add("baseColor","vec4"),i.uniforms.add("objectOpacity","float"),t.attributeColor?i.code.add(x`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):i.code.add(x`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),i.code.add(x`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function wse(e,t){const i=e.fragment;switch(t.doubleSidedMode){case hr.None:i.code.add(x`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case hr.View:e.include(cT,t),i.code.add(x`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case hr.WindingOrder:i.code.add(x`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:t.doubleSidedMode;case hr.COUNT:}switch(t.normalType){case Mr.Attribute:case Mr.CompressedAttribute:e.include(C4,t),i.code.add(x`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`);break;case Mr.ScreenDerivative:e.extensions.add("GL_OES_standard_derivatives"),e.include(cT,t),i.code.add(x`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`);break;case Mr.Ground:t.viewingMode===Ie.Global?(e.include(cT,t),i.code.add(x`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):t.viewingMode===Ie.Local&&i.code.add(x`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),e.extensions.add("GL_OES_standard_derivatives"),i.code.add(x`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`);break;default:t.normalType;case Mr.COUNT:}}function ect(e,t){const i=e.fragment;t.baseColorTexture?(e.include(vq,t),i.uniforms.add("baseColorTexture","sampler2D"),i.uniforms.add("baseColorTextureSize","vec2"),t.attributeTextureCoordinates===_n.Atlas?(e.include(Nge),i.code.add(x`vec4 readBaseColorTexture() {
return textureAtlasLookup(
baseColorTexture,
baseColorTextureSize,
vuv0,
vuvRegion
);
}`)):i.code.add(x`vec4 readBaseColorTexture() {
return texture2D(baseColorTexture, vuv0);
}`)):i.code.add(x`vec4 readBaseColorTexture() { return vec4(1.0); }`)}var yp;function m0t(e){return e&&Lp(e)?yp.Mars:e&&Np(e)?yp.Moon:yp.Earth}(function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"})(yp||(yp={}));const rbe=new Map([[E.POSITION,0],[E.NORMAL,1],[E.NORMALCOMPRESSED,1],[E.COLOR,2],[E.UV0,3],[E.UVREGION,4],[E.COMPONENTINDEX,5]]);function tct(e){const t=new Oi;t.include(cT,e),t.include(C4,e),t.include(xb,e),t.include(gm,e),t.include(HO,e),t.include(Jlt,e),t.include(vm,e),t.include(Or,e),t.include(ect,e),t.include(Klt,e),t.fragment.uniforms.add("view","mat4"),e.pbrMode!==xt.Normal&&e.pbrMode!==xt.Schematic||(t.include(_q,e),e.hasNormalTexture&&t.include(m_e,e)),e.output===j.Shadow&&e.componentData===$p.Varying?t.vertex.code.add(x`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):t.vertex.code.add(x`#define discardShadows(castShadows) {}`);const i=e.overlayEnabled&&e.output===j.Color&&e.pbrMode===xt.WaterOnIntegratedMesh;return e.overlayEnabled&&(t.include(J1,e),t.include(EG,e),e.viewingMode===Ie.Global?t.vertex.code.add(x`
      const float invEllipsoidRadius = ${x.float(1/(e.ellipsoidMode===yp.Earth?ai.radius:e.ellipsoidMode===yp.Mars?pp.radius:Am.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):t.vertex.code.add(x`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),i&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3"),t.varyings.add("positionView","vec3")),t.vertex.code.add(x`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      if (externalColor.a < ${x.float(Hn)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
      forwardPosition();
      forwardNormal();
      ${i?x`
        positionView = position_view();
        ${e.viewingMode===Ie.Global?x`
        groundNormal = normalize(positionWorld());
        tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:x`
        groundNormal = vec3(0.0, 0.0, 1.0);
        tbnTangent = vec3(1.0, 0.0, 0.0);
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`}
        `:""}

      ${e.overlayEnabled?x`setOverlayVTC(projectOverlay(position));`:""}
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth(); // depends on forwardPosition()
    }
  `),e.output===j.Alpha&&(t.fragment.include(Os),e.multipassTerrainEnabled&&t.include(Ec,e),t.include(bse,e),t.fragment.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.multipassTerrainEnabled?x`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${e.overlayEnabled?x`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),e.output===j.Color&&(t.fragment.include(Os),e.multipassTerrainEnabled&&t.include(Ec,e),t.include(bse,e),t.include(wse,e),t.include(J1,e),i&&t.fragment.uniforms.add("ovNormalTex","sampler2D"),e.receiveShadows?(t.include(Lm,e),t.fragment.code.add(x`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):t.fragment.code.add(x`float evaluateShadow() { return 0.0; }`),t.fragment.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.multipassTerrainEnabled?x`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${e.overlayEnabled?x`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}
    `),e.pbrMode===xt.Normal||e.pbrMode===xt.Schematic?(t.fragment.code.add(x`
        ${e.pbrMode===xt.Normal?x`
        applyPBRFactors();
        if (int(externalColorMixMode) == 3) {
          mrr = vec3(0.0, 0.6, 0.2);
        }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * lightingMainIntensity[2];
      `),e.hasNormalTexture?t.fragment.code.add(x`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):t.fragment.code.add(x`vec3 shadingNormal = normalVertex;`),t.fragment.code.add(x`${e.viewingMode===Ie.Global?x`vec3 normalGround = normalize(positionWorld());`:x`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),t.fragment.code.add(x`vec3 viewDir = normalize(vPositionWorldCameraRelative);
float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());
vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);`)):(e.receiveShadows?t.fragment.code.add(x`float shadow = evaluateShadow();`):e.viewingMode===Ie.Global?t.fragment.code.add(x`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`):t.fragment.code.add(x`float shadow = 0.0;`),t.fragment.code.add(x`
      float ambientOcclusion = evaluateAmbientOcclusion();
      // At global scale we create some additional ambient light based on the main light to simulate global illumination
      vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());
      vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${i?x`
          vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
          float waterNormalLength = length(overlayWaterMask);
          if (waterNormalLength > 0.95) {
            mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
            vec4 waterOverlayColor = vec4(overlayColorOpaque.xyz, overlayColor.w);
            vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, positionView, positionWorld());
            vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
            // un-gamma the ground color to mix in linear space
            shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
          }`:""}
      `)),t.fragment.code.add(x`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.output!==j.Depth&&e.output!==j.Shadow||(t.include(q0,e),t.fragment.code.add(x`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),e.output===j.Normal&&(t.include(wse,e),t.fragment.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${e.normalType===Mr.Ground?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),e.output===j.Highlight&&(t.include(Qm),t.fragment.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${e.overlayEnabled?x`
        vec4 overlayColor = getCombinedOverlayColor();

        if (overlayColor.a == 0.0) {
          gl_FragColor = vec4(0.0);
          return;
        }`:""}

        outputHighlight();
      }
    `)),t}const ict=Object.freeze({__proto__:null,attributeLocations:rbe,build:tct});var bs,jr;(function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight"})(bs||(bs={})),function(e){e[e.Color=0]="Color",e[e.Alpha=1]="Alpha",e[e.Depth=2]="Depth",e[e.Normal=3]="Normal"}(jr||(jr={}));class gX{constructor(){this.viewTransform=new h_e,this.slicePlane=pb()}}class rct extends gX{constructor(){super(...arguments),this.identifier=bs.Material,this.slicePlaneEnabled=!0,this.transparent=!1,this.integratedMesh=!1,this.transformNormalViewFromGlobal=wr(),this.nearFar=Ye(),this.inverseViewport=Ye(),this.ambientOcclusionEnabled=!0,this.shadowsEnabled=!0,this.hasFillLights=!0,this.sceneHasOcludees=!1,this.transparencyPassType=lt.NONE}}class sct extends gX{constructor(){super(...arguments),this.identifier=bs.ShadowMap,this.nearFar=Ye()}}class nct extends gX{constructor(){super(...arguments),this.identifier=bs.Highlight,this.inverseViewport=Ye(),this.viewport=ni()}}class J4 extends Gi{bindPass(t){const i=this.program;p_e(i,t.viewTransform),I0(this.program,this.configuration,t.slicePlane),t.identifier===bs.Material&&(t.ssrParams!==void 0&&OW(this.program,t.ssrParams),i.setUniformMatrix3fv("transformNormalViewFromGlobal",t.transformNormalViewFromGlobal),t.subPass===jr.Depth&&i.setUniform2fv("nearFar",t.nearFar),t.subPass===jr.Color&&t.lighting.setUniforms(this.program,t.integratedMesh,t.hasFillLights)),t.identifier===bs.ShadowMap&&this.program.setUniform2fv("nearFar",t.nearFar)}bindMaterial(t,i){this._material=t;const r=this.program;r.setUniform4fv("baseColor",t.baseColor),r.setUniform1f("objectOpacity",t.objectOpacity),r.setUniform1f("textureAlphaCutoff",t.alphaCutoff),t.componentParameters.type===$p.Varying?t.componentParameters.texture.bind(r,"componentColorTex","componentColorTexInvDim"):(r.setUniform4fv("externalColor",t.componentParameters.externalColor),r.setUniform1i("externalColorMixMode",t.componentParameters.externalColorMixMode)),_(t.baseColorTexture)&&t.baseColorTexture.bind(r,"baseColorTexture","baseColorTextureSize"),this.configuration.output!==j.Color&&this.configuration.output!==j.Alpha||(Fge(this.program,t,this.configuration.isSchematic),_(t.metallicRoughnessTexture)&&t.metallicRoughnessTexture.bind(r,"texMetallicRoughness","texMetallicRoughnessSize"),_(t.emissionTexture)&&t.emissionTexture.bind(r,"texEmission","texEmissionSize"),_(t.occlusionTexture)&&t.occlusionTexture.bind(r,"texOcclusion","texOcclusionSize"),_(t.normalTexture)&&t.normalTexture.bind(r,"normalTexture","normalTextureSize")),t.isIntegratedMesh&&(i.identifier===bs.Material&&i.subPass===jr.Color?(r.bindTexture(t.overlayColor,"ovColorTex"),r.bindTexture(t.overlayNormal,"ovNormalTex")):i.identifier===bs.Highlight&&r.bindTexture(t.overlayHighlight,"ovColorTex"),r.setUniform1f("overlayOpacity",1)),i.identifier===bs.Highlight&&Hp(this.program,i),i.identifier===bs.Material&&i.subPass===jr.Color&&(i.ambientOcclusionEnabled&&i.bindAmbientOcclusion(r),i.shadowsEnabled&&i.bindShadowMap(r)),i.identifier!==bs.Material||i.subPass!==jr.Color&&i.subPass!==jr.Alpha||!i.multipassTerrainParams.multipassTerrainEnabled||(this.program.setUniform2fv("nearFar",i.nearFar),r.setUniform2fv("inverseViewport",i.inverseViewport),i.multipassTerrainParams.terrainLinearDepthTexture&&r.bindTexture(i.multipassTerrainParams.terrainLinearDepthTexture,"terrainDepthTexture"))}bindDraw(t){if(d_e(this.program,t),this.program.setUniformMatrix3fv("transformNormalGlobalFromModel",t.transformNormalGlobalFromModel),this.program.rebindTextures(),_(this._material)&&this._material.isIntegratedMesh){const i=this._material.overlayTexScale,r=this._material.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[t.toMapSpace[0]*i[0]+r[0],t.toMapSpace[1]*i[1]+r[1],t.toMapSpace[0]*i[2]+r[2],t.toMapSpace[1]*i[3]+r[3]]),this.program.setUniform4fv("overlayTexScale",[t.toMapSpace[2]*i[0],t.toMapSpace[3]*i[1],t.toMapSpace[2]*i[2],t.toMapSpace[3]*i[3]])}}initializeProgram(t){const i=J4.shader.get(),r=this.configuration,s=i.build({multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround,oitEnabled:r.transparencyPassType===lt.Color,output:r.output,normalType:r.integratedMeshMode===lc.None?r.hasNormals?Mr.CompressedAttribute:Mr.ScreenDerivative:Mr.Ground,attributeColor:r.hasVertexColors,attributeTextureCoordinates:r.vertexTextureCoordinates,componentData:r.componentData,alphaDiscardMode:r.alphaDiscardMode,baseColorTexture:r.baseColorTexture,doubleSidedMode:r.doubleSidedMode,receiveAmbientOcclusion:r.receiveAmbientOcclusion,receiveShadows:r.receiveShadows,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:t.viewingMode,vertexDiscardMode:r.vertexDiscardMode,pbrMode:r.integratedMeshMode===lc.ColorOverlayWithWater?xt.WaterOnIntegratedMesh:r.usePBR?r.isSchematic?xt.Schematic:xt.Normal:xt.Disabled,hasMetalnessAndRoughnessTexture:r.hasMetalnessAndRoughnessTexture,hasEmissionTexture:r.hasEmissionTexture,hasOcclusionTexture:r.hasOcclusionTexture,hasNormalTexture:r.hasNormalTexture,vertexTangents:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:S4(t.rctx),overlayEnabled:r.integratedMeshMode===lc.ColorOverlay||r.integratedMeshMode===lc.ColorOverlayWithWater,ssrEnabled:r.ssrEnabled,highStepCount:!1,ellipsoidMode:r.ellipsoidMode});return new Mi(t.rctx,s,i.attributeLocations)}_setPipelineState(t){const i=this.configuration,r=i.integratedMeshMode!==lc.None,s=t===lt.NONE,n=t===lt.FrontFace;return Ot({blending:i.output!==j.Color&&i.output!==j.Alpha||!i.blendingEnabled?null:s?gl:Km(t),culling:VF(i.cullFace),depthTest:{func:H0(t)},depthWrite:s||n?Ma:null,colorWrite:Ft,stencilWrite:r||i.sceneHasOcludees?Ip:null,stencilTest:r?tQe(Ea.IntegratedMeshMaskExcluded):i.sceneHasOcludees?W0:null,polygonOffset:s||n?i.polygonOffsetEnabled?{factor:2,units:2}:null:c4})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}J4.shader=new Ni(ict,()=>import("./ComponentShader.glsl.52b14465.js"));class sbe extends DQe{constructor(){super(...arguments),this.transformNormalGlobalFromModel=wr(),this.toMapSpace=ni()}}var xse,lc;(function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"})(xse||(xse={})),function(e){e[e.None=0]="None",e[e.NoOverlay=1]="NoOverlay",e[e.ColorOverlay=2]="ColorOverlay",e[e.ColorOverlayWithWater=3]="ColorOverlayWithWater",e[e.COUNT=4]="COUNT"}(lc||(lc={}));class sr extends mr{constructor(){super(...arguments),this.output=j.Color,this.hasVertexColors=!1,this.hasNormals=!1,this.vertexTextureCoordinates=_n.None,this.componentData=$p.Uniform,this.slicePlaneEnabled=!1,this.cullFace=Di.Back,this.baseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.vertexDiscardMode=Eu.None,this.doubleSidedMode=hr.WindingOrder,this.blendingEnabled=!0,this.alphaDiscardMode=Ri.Opaque,this.integratedMeshMode=lc.None,this.ssrEnabled=!1,this.polygonOffsetEnabled=!1,this.usePBR=!1,this.isSchematic=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.sceneHasOcludees=!1,this.transparencyPassType=lt.NONE,this.ellipsoidMode=yp.Earth,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Z({count:j.COUNT})],sr.prototype,"output",void 0),u([Z()],sr.prototype,"hasVertexColors",void 0),u([Z()],sr.prototype,"hasNormals",void 0),u([Z({count:_n.COUNT})],sr.prototype,"vertexTextureCoordinates",void 0),u([Z({count:$p.COUNT})],sr.prototype,"componentData",void 0),u([Z()],sr.prototype,"slicePlaneEnabled",void 0),u([Z({count:Di.COUNT})],sr.prototype,"cullFace",void 0),u([Z()],sr.prototype,"baseColorTexture",void 0),u([Z()],sr.prototype,"receiveAmbientOcclusion",void 0),u([Z()],sr.prototype,"receiveShadows",void 0),u([Z({count:Eu.COUNT})],sr.prototype,"vertexDiscardMode",void 0),u([Z({count:hr.COUNT})],sr.prototype,"doubleSidedMode",void 0),u([Z()],sr.prototype,"blendingEnabled",void 0),u([Z({count:Ri.COUNT})],sr.prototype,"alphaDiscardMode",void 0),u([Z({count:lc.COUNT})],sr.prototype,"integratedMeshMode",void 0),u([Z()],sr.prototype,"ssrEnabled",void 0),u([Z()],sr.prototype,"polygonOffsetEnabled",void 0),u([Z()],sr.prototype,"usePBR",void 0),u([Z()],sr.prototype,"isSchematic",void 0),u([Z()],sr.prototype,"hasMetalnessAndRoughnessTexture",void 0),u([Z()],sr.prototype,"hasEmissionTexture",void 0),u([Z()],sr.prototype,"hasOcclusionTexture",void 0),u([Z()],sr.prototype,"hasNormalTexture",void 0),u([Z()],sr.prototype,"sceneHasOcludees",void 0),u([Z({count:lt.COUNT})],sr.prototype,"transparencyPassType",void 0),u([Z({count:yp.COUNT})],sr.prototype,"ellipsoidMode",void 0),u([Z()],sr.prototype,"multipassTerrainEnabled",void 0),u([Z()],sr.prototype,"cullAboveGround",void 0);class oct{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(const t of this._parameterBlocks)this[t]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(const t of this._parameterBlocks)if(this[t].dirty)return!0;return!1}}class yX{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function Fi(e={}){return(t,i)=>{var r;const s=(r=t._parameterCount)!=null?r:0;if(t._parameterCount=s+1,e.vectorOps){const n=e.vectorOps;Object.defineProperty(t,i,{get(){return this[s]},set(o){const a=this[s];if(a==null)this[s]=o;else{if(n.equals(a,o))return;n.copy(a,o)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[s]},set(n){this[s]!==n&&(e.dispose&&this[s]&&this[s].dispose(),this[s]=n,this._setDirty())}})}}function Tse(){return(e,t)=>{var i;const r=(i=e._parameterCount)!=null?i:0;e._parameterCount=r+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(r),Object.defineProperty(e,t,{get(){return this[r]},set(s){this[r]!==s&&(this[r]=s,this._setDirty())}})}}class Dr extends oct{constructor(){super(...arguments),this.baseColor=Ca(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=Ht(1,1,.5),this.emissiveFactor=Ht(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.overlayTexOffset=yi(-1,-1,-1,-1),this.overlayTexScale=yi(0,0,0,0),this.overlayColor=null,this.overlayHighlight=null,this.overlayNormal=null,this.objectOpacity=1,this.commonMaterialParameters=new k$,this.componentParameters=new yT,this.alphaCutoff=BL,this.alphaDiscardMode=Ri.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=yp.Earth,this.sceneHasOcludees=!1,this._techniqueConfig=new sr}dispose(){this._technique=Xi(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}prepareTechnique(t,i,r){const s=this._techniqueConfig;if(s.hasVertexColors=r.colors,s.hasNormals=r.normals,s.vertexTextureCoordinates=r.textureCoordinates,s.usePBR=this.usePBR,s.hasMetalnessAndRoughnessTexture=_(this.metallicRoughnessTexture),s.hasEmissionTexture=_(this.emissionTexture),s.hasOcclusionTexture=_(this.occlusionTexture),s.hasNormalTexture=_(this.normalTexture),s.transparencyPassType=i.identifier===bs.Material&&i.transparencyPassType!=null?i.transparencyPassType:lt.NONE,s.multipassTerrainEnabled=i.identifier===bs.Material&&i.multipassTerrainParams!=null&&i.multipassTerrainParams.multipassTerrainEnabled,s.cullAboveGround=i.identifier===bs.Material&&i.multipassTerrainParams!=null&&i.multipassTerrainParams.cullAboveGround,s.ellipsoidMode=this.ellipsoidMode,this.dirty){s.componentData=this.componentParameters.type,s.cullFace=this.commonMaterialParameters.cullFace,s.doubleSidedMode=this.commonMaterialParameters.doubleSided?hr.View:hr.None,s.baseColorTexture=_(this.baseColorTexture),s.isSchematic=this.hasParametersFromSource&&!_(this.baseColorTexture);const n=this._computeWhichMaterialPass();s.blendingEnabled=n===Uo.Transparent||n===Uo.OpaqueAndTransparent,s.alphaDiscardMode=this.alphaDiscardMode,s.integratedMeshMode=this.isIntegratedMesh?this.overlayColor?this.overlayNormal?lc.ColorOverlayWithWater:lc.ColorOverlay:lc.NoOverlay:lc.None,s.polygonOffsetEnabled=this.polygonOffsetEnabled,this._setClean()}return s.slicePlaneEnabled=i.slicePlaneEnabled&&this.commonMaterialParameters.slicePlaneEnabled,i.identifier===bs.ShadowMap?(s.output=j.Shadow,s.vertexDiscardMode=Eu.None):i.identifier===bs.Highlight?(s.output=j.Highlight,s.vertexDiscardMode=Eu.None):(this._computeWhichMaterialPass()===Uo.OpaqueAndTransparent?s.vertexDiscardMode=i.transparent?Eu.Opaque:Eu.Transparent:s.vertexDiscardMode=Eu.None,s.output=act(i.subPass),i.subPass===jr.Alpha&&(s.sceneHasOcludees=i.sceneHasOcludees),i.subPass===jr.Color?(s.receiveAmbientOcclusion=i.ambientOcclusionEnabled,s.sceneHasOcludees=i.sceneHasOcludees,s.receiveShadows=i.shadowsEnabled,s.ssrEnabled=i.ssrParams.ssrEnabled):(s.receiveAmbientOcclusion=!1,s.receiveShadows=!1)),this._technique=t.releaseAndAcquire(J4,s,this._technique),this._technique}submit(t,i){if(this.objectOpacity===0)return;const r=i.renderable.geometry,s=i.components,n=i.renderable.drawParameters,o=i.renderable.meta.cameraDepthSquared,a=s.geometryRanges,l=s.highlightRanges,c=s.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case Uo.Opaque:t.materialOpaque.submitDraw(this,r,a,n,o);break;case Uo.Transparent:t.materialTransparent.submitDraw(this,r,a,n,o);break;case Uo.OpaqueAndTransparent:t.materialOpaque.submitDraw(this,r,a,n,o),t.materialTransparent.submitDraw(this,r,a,n,o);break;case Uo.IntegratedMesh:t.materialIntegratedMesh.submitDraw(this,r,a,n,o),this.overlayHighlight&&t.highlightIntegratedMesh.submitDraw(this,r,a,n,o)}const h=this.componentParameters.castShadows!==os.None;h&&t.shadowMap.submitDraw(this,r,a,n,o),_(l)&&(t.highlight.submitDraw(this,r,l,n,o),h&&t.highlightShadowMap.submitDraw(this,r,l,n,o)),h&&_(c)&&t.defaultShadowMap.submitDraw(this,r,c,n,o)}get attributeLocations(){return rbe}_computeWhichMaterialPass(){return this.isIntegratedMesh?Uo.IntegratedMesh:this.objectOpacity<1?Uo.Transparent:this.componentParameters.opaqueOverride===os.All?Uo.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===Ri.Blend||this.alphaDiscardMode===Ri.MaskBlend?Uo.Transparent:this.componentParameters.transparent===os.None?Uo.Opaque:this.componentParameters.transparent===os.All?Uo.Transparent:Uo.OpaqueAndTransparent}}var Sse,Uo,os;u([Fi({vectorOps:yoe})],Dr.prototype,"baseColor",void 0),u([Fi()],Dr.prototype,"usePBR",void 0),u([Fi()],Dr.prototype,"hasParametersFromSource",void 0),u([Fi({vectorOps:LX})],Dr.prototype,"mrrFactors",void 0),u([Fi({vectorOps:LX})],Dr.prototype,"emissiveFactor",void 0),u([Fi({dispose:!0})],Dr.prototype,"baseColorTexture",void 0),u([Fi({dispose:!0})],Dr.prototype,"metallicRoughnessTexture",void 0),u([Fi({dispose:!0})],Dr.prototype,"emissionTexture",void 0),u([Fi({dispose:!0})],Dr.prototype,"occlusionTexture",void 0),u([Fi({dispose:!0})],Dr.prototype,"normalTexture",void 0),u([Fi({vectorOps:{equals:g1,copy:_a}})],Dr.prototype,"overlayTexOffset",void 0),u([Fi({vectorOps:{equals:g1,copy:_a}})],Dr.prototype,"overlayTexScale",void 0),u([Fi()],Dr.prototype,"overlayColor",void 0),u([Fi()],Dr.prototype,"overlayHighlight",void 0),u([Fi()],Dr.prototype,"overlayNormal",void 0),u([Fi()],Dr.prototype,"objectOpacity",void 0),u([Tse()],Dr.prototype,"commonMaterialParameters",void 0),u([Tse()],Dr.prototype,"componentParameters",void 0),u([Fi()],Dr.prototype,"alphaCutoff",void 0),u([Fi()],Dr.prototype,"alphaDiscardMode",void 0),u([Fi()],Dr.prototype,"isIntegratedMesh",void 0),u([Fi()],Dr.prototype,"polygonOffsetEnabled",void 0),u([Fi()],Dr.prototype,"ellipsoidMode",void 0),u([Fi()],Dr.prototype,"sceneHasOcludees",void 0),function(e){e[e.VERTEX=0]="VERTEX",e[e.GROUND=1]="GROUND",e[e.SCREEN_DERIVATIVE=2]="SCREEN_DERIVATIVE"}(Sse||(Sse={})),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(Uo||(Uo={}));class k$ extends yX{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=Di.Back,this.slicePlaneEnabled=!0}}u([Fi()],k$.prototype,"doubleSided",void 0),u([Fi()],k$.prototype,"cullFace",void 0),u([Fi()],k$.prototype,"slicePlaneEnabled",void 0);class yT extends yX{constructor(){super(...arguments),this.externalColor=Ca(1,1,1,1),this.externalColorMixMode=ws.Multiply,this.castShadows=os.All}get transparent(){return this.externalColor[3]<1?os.All:os.None}get opaqueOverride(){return this.externalColorMixMode===ws.Replace&&this.externalColor[3]===1?os.All:os.None}get visible(){return this.externalColor[3]>0?os.All:os.None}get type(){return $p.Uniform}}u([Fi({vectorOps:yoe})],yT.prototype,"externalColor",void 0),u([Fi()],yT.prototype,"externalColorMixMode",void 0),u([Fi()],yT.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(os||(os={}));class IA extends yX{constructor(){super(...arguments),this.texture=null,this.transparent=os.None,this.opaqueOverride=os.None,this.castShadows=os.None}get type(){return $p.Varying}}function act(e){switch(e){case jr.Color:return j.Color;case jr.Alpha:return j.Alpha;case jr.Depth:return j.Depth;case jr.Normal:return j.Normal}}u([Fi()],IA.prototype,"texture",void 0),u([Fi()],IA.prototype,"transparent",void 0),u([Fi()],IA.prototype,"opaqueOverride",void 0),u([Fi()],IA.prototype,"castShadows",void 0);class K4{constructor(t){this._low=fi(),this._high=fi(),t&&this.set(t)}get low(){return this._low}get high(){return this._high}set(t){const i=this._low,r=this._high;ne(i,t),vp(r,t,i)}setElements(t,i,r){oe(Ese,t,i,r),this.set(Ese)}get(t){return pe(t,this._low,this._high)}getLowScaled(t){return ae(t,this._low,1)}}const Ese=M();class lct{constructor(t){this.maxCount=t,this._nextIndex=0,this.recycledIndices=[]}get activeCount(){return this._nextIndex-this.recycledIndices.length}get availableCount(){return this.recycledIndices.length+this.maxCount-this._nextIndex}acquire(){return this.recycledIndices.length>0?this.recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(t){this.recycledIndices.push(t)}}class cct{constructor(t,i=1){this.rctx=t,this.fieldCount=i,this.textureWidth=4096,this.dirty=!0,this.texture=new Qe(this.rctx,{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.NEAREST,wrapMode:ct.CLAMP_TO_EDGE,width:this.textureWidth,height:1,flipped:!1}),this.data=new Pa(new ArrayBuffer(4*this.textureWidth))}dispose(){this.texture.dispose(),this.texture=void 0,this.data=void 0}setData(t,i,r,s,n,o){const a=t*this.fieldCount+i;this.dirty=!0,this.data.set(a,0,r),this.data.set(a,1,s),this.data.set(a,2,n),this.data.set(a,3,o)}setDataElement(t,i,r,s){const n=t*this.fieldCount+i;this.dirty=!0,this.data.set(n,r,s)}resizeToFit(t){const i=t*this.fieldCount;if(i>=this.data.count){const r=Math.ceil((i+1)/this.textureWidth)*this.textureWidth,s=new Pa(new ArrayBuffer(4*r));s.typedBuffer.set(this.data.typedBuffer),this.data=s}}updateTexture(){if(!this.dirty)return;const t=this.texture.descriptor.width,i=this.texture.descriptor.height;this.data.count>t*i&&this.texture.resize(t,this.data.count/t),this.texture.setData(this.data.typedBuffer),this.dirty=!1}bind(t,i,r){t.bindTexture(this.texture,i),t.setUniform2f(r,1/this.texture.descriptor.width,1/this.texture.descriptor.height)}}const nbe=65536;class uct{constructor(t,i=1){this.textureBuffer=new cct(t,i),this.indexManager=new lct(nbe)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this.indexManager.availableCount}get activeCount(){return this.indexManager.activeCount}acquireIndex(){const t=this.indexManager.acquire();return this.textureBuffer.resizeToFit(t),t}releaseIndex(t){this.indexManager.release(t)}}class obe{constructor(t,i=1){this.rctx=t,this.fieldCount=i,this.buffers=[]}garbageCollect(){this.buffers=this.buffers.filter(t=>t.activeCount!==0||(t.dispose(),!1))}destroy(){this.buffers.forEach(t=>t.dispose()),this.buffers=[]}getBuffer(t){for(const r of this.buffers)if(r.availableCount>=t)return r;if(t>nbe)return null;const i=new uct(this.rctx,this.fieldCount);return this.buffers.push(i),i}updateTextures(){for(const t of this.buffers)t.textureBuffer.updateTexture()}}const Ase=he.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class hct{constructor(t){this._renderManager=t,this._objects=[new $t,new $t],this._renderSubmit=new Zlt(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new obe(t.rctx)}dispose(){at(this._objects[gT.Hidden].length===0&&this._objects[gT.Visible].length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}createObject(t){const i=new RG;return i.toMapSpace=t.toMapSpace.slice(),i.transform=t.transform,i.obb=Clt(t.obb),i.components=new Plt(this._componentBufferManager,t.geometry.componentOffsets),i.renderable=this._createRenderable(t,i.components),i.intersectionGeometry=new klt(t.geometry.positionData,i.components),this._objects[i.visible].push(i),i}destroyObject(t){const i=t;this._objects[i.visible].removeUnordered(i),i.dispose(),this._notifyDirty()}setObjectVisibility(t,i){const r=t;i!==r.visible&&(this._objects[r.visible].removeUnordered(r),this._objects[i].push(r),r.visible=i,this._notifyDirty())}preSubmit(t){const i=t.camera.eye;this.visibleObjects.forAll(r=>{const s=qn(i,r.obb.center);r.renderable.meta.cameraDepthSquared=s})}getMaterial(t){return t.renderable.material}updateMaterial(t,i){const r=t.renderable.material;i(r),r.dirty&&this._notifyDirty()}setAllComponentVisibilities(t,i){const r=t;r.components.visibility.reset(i),r.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(t,i){return t.components.visibility.forEachComponent(i)}getComponentCount(t){const i=t,r=i.components.visibility.componentCount();return{visible:r,invisible:i.components.count-r}}setComponentData(t,i){const r=t,s=r.renderable.material;if($lt(i)){const n=r.components,o=n.materialDataBuffer,a=n.materialDataIndices,l={castShadows:!0,pickable:!0,externalColor:eX(),externalColorMixMode:ws.Multiply},c=o.textureBuffer,h=new Uint8Array(4),p=new Uint32Array(h.buffer);let f=0,g=0,y=0,v=!1,b=0;for(let w=0;w<n.count;w++)i(w,l),f+=+(l.externalColor[3]<1),g+=+(l.externalColorMixMode===ws.Replace&&l.externalColor[3]===1),y+=+l.castShadows,l_e(l.externalColor,l.externalColorMixMode,h),h[2]=254&h[2]|+l.castShadows,c.setData(a[w],0,h[0],h[1],h[2],h[3]),v=v||w>0&&b!==p[0],b=p[0],l.pickable!==K1e(n.pickability,w)&&(n.pickability=Dlt(n.pickability,n.count,w,l.pickable));v?(s.componentParameters=new IA,s.componentParameters.castShadows=Pz(y,n.count),s.componentParameters.transparent=Pz(f,n.count),s.componentParameters.opaqueOverride=Pz(g,n.count),s.componentParameters.texture=c,c.updateTexture()):(s.componentParameters=new yT,s.componentParameters.castShadows=l.castShadows?os.All:os.None,s.componentParameters.externalColor=l.externalColor,s.componentParameters.externalColorMixMode=l.externalColorMixMode)}else s.componentParameters=new yT,s.componentParameters.castShadows=i.castShadows?os.All:os.None,s.componentParameters.externalColor=i.externalColor,s.componentParameters.externalColorMixMode=i.externalColorMixMode;this._notifyDirty()}getComponentAabb(t,i,r){return t.intersectionGeometry.getComponentAabb(i,r)}getComponentObb(t){return t.obb}getObjectTransform(t){return t.transform}getComponentPositions(t,i,r){return t.intersectionGeometry.getComponentPositions(i,r)}intersect(t,i,r,s,n,o){const a=t;_(n)&&(n.localOrigin=a.transform.position);const l=k1(Cse,a.transform.rotationScale);vp(FP,i,a.transform.position),vp(UP,r,a.transform.position),al(FP,FP,l),al(UP,UP,l);const c=Nu(Cse,l);return a.intersectionGeometry.intersect(FP,UP,s,c,n,o)}addEdges(t,i,r,s){const n=t,{indices:o,positions:a}=n.intersectionGeometry,l=n.components.offsets;return i.addComponentObject(t,n.transform,{center:n.obb.center,radius:Rlt(n.obb)},a,o,l,r,s)}addComponentHighlight(t,i){const r=t.components;R(r.highlightCounts)&&(r.highlightCounts=new Uint32Array(r.count+1)),r.highlightCounts[i]++===0&&(r.highlightsDirty(),this._notifyDirty()),r.highlightCounts[r.count]++}removeComponentHighlight(t,i){const r=t.components;if(R(r.highlightCounts))return void Ase.warn("Removing non-existing highlight.");const s=r.highlightCounts[i],n=r.highlightCounts[r.count];if(s!==0){if(s>1)return r.highlightCounts[i]=s-1,void(r.highlightCounts[r.count]=n-1);r.highlightCounts[i]=0,r.highlightsDirty(),this._notifyDirty(),n===1?r.highlightCounts=null:r.highlightCounts[r.count]=n-1}else Ase.warn("Removing non-existing highlight.")}clearHighlights(t){const i=t.components;_(i.highlightCounts)&&(i.highlightCounts=null,i.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(t){return t.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects[gT.Visible]}_createRenderable(t,i){const r=this._renderManager.rctx,s=t.geometry,n=s.vertices.layoutParameters,o=jt.createVertex(r,ri.STATIC_DRAW,s.vertices.data),a=po(s.indices,S=>jt.createIndex(r,ri.STATIC_DRAW,S)),l=Rl(Qlt(n)),c=new Uint16Array(s.vertices.count);for(let S=0;S<i.count;S++){const T=i.offsets[S],A=i.offsets[S+1],C=i.materialDataIndices[S];if(_(s.indices))for(let O=T;O<A;O++)c[s.indices[O]]=C;else for(let O=T;O<A;O++)c[O]=C}const h=jt.createVertex(r,ri.STATIC_DRAW,c.buffer),p=new K4(t.transform.position),f=E1e(t.transform.rotationScale);k1(f,f),Nu(f,f);const g=new sbe;ne(g.transformWorldFromModelTL,p.low),ne(g.transformWorldFromModelTH,p.high),hR(g.transformWorldFromModelRS,t.transform.rotationScale),hR(g.transformNormalGlobalFromModel,f),_a(g.toMapSpace,t.toMapSpace);const y=new Dr,v=new us(r,y.attributeLocations,{data:l,componentIndices:dct},{data:o,componentIndices:h},a),b=new tbe(v,Tt.TRIANGLES,n,_(a)),w={cameraDepthSquared:.5,gpuMemoryEstimate:o.byteSize+h.byteSize+(_(a)?a.byteSize:0)};return new Vlt(y,g,b,w)}_notifyDirty(){this._renderManager.notifyDirty()}}const dct=Rl(kr().u16(E.COMPONENTINDEX));function Pz(e,t){return e===t?os.All:e===0?os.None:os.Some}const Cse=wm(),FP=M(),UP=M();class pct{constructor(t,i){this._rctx=t,this._techniqueRepository=i}dispose(){this._vao=tt(this._vao)}compositeTransparent(t,i,r,s=1){const n=this._rctx;ff.alphaMode=kn.Alpha,ff.function=xa.Transparency,ff.hasOpacityFactor=s!==1;const o=this._techniqueRepository.acquire(LR,ff),a=n.useTechnique(o);a.bindTexture(t,"colorTexture"),a.bindTexture(i,"alphaTexture"),a.bindTexture(r,"frontFaceTexture");const l=this._ensureVAO();n.bindVAO(l),n.drawArrays(Tt.TRIANGLE_STRIP,0,vn(l,"geometry")),o.release()}composite(t,i=kn.None,r=1,s=xa.Standard,n=is.INNER){const o=this._rctx;ff.alphaMode=i,ff.function=s,ff.hasOpacityFactor=r!==1;const a=this._techniqueRepository.acquire(LR,ff),l=o.useTechnique(a);l.bindTexture(t,"tex"),ff.hasOpacityFactor&&l.setUniform1f("opacity",r),s===xa.OverlayWithTransparency&&l.setUniform1i("overlayIdx",n);const c=this._ensureVAO();o.bindVAO(c),o.drawArrays(Tt.TRIANGLE_STRIP,0,vn(c,"geometry")),a.release()}_ensureVAO(){return R(this._vao)&&(this._vao=bo(this._rctx)),this._vao}}const ff=new T$,fct=1e4,MG=100,mct=500,gct=500,yct=.1;function vct(e,t,i){return uW(t,e)*(i[1]-i[0])+i[0]}function _ct(e,t,i){if(t.size<fct)return Cct.compute(e,t);const r=XO();return i.forAll(s=>{s.isVisible&&OS(r,bct(e,s))}),r}function bct(e,t){if(!t.isVisible)return;const i=XO(),r=t.getSpatialQueryAccelerator();return _(r)?wct(i,e,r):xct(i,e,t.objects),i}function wct(e,t,i){const r=t.eye,s=t.viewForward,n=t.frustum,o=l=>l.isVisible,a=i.objectCount;if(a<mct)WR(du,t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,s,hc.FRONT_TO_BACK,du,(l,c)=>{PG(e,t,l),du.far=e.near,c.setRange(du)},n,o),WR(du,Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,s,hc.BACK_TO_FRONT,du,(l,c)=>{PG(e,t,l),du.near=e.far,c.setRange(du)},n,o);else{const l=Math.max(Math.min(a,gct),Math.ceil(a*yct)),c=i.findClosest(s,hc.FRONT_TO_BACK,n,o,l),h=i.findClosest(s,hc.BACK_TO_FRONT,n,o,l);c&&h&&(Rse(e,t,c.boundingVolumeWorldSpace.bounds),Rse(e,t,h.boundingVolumeWorldSpace.bounds))}}function xct(e,t,i){dw.clear(),i.forAll(r=>{r.isVisible&&r.geometryRecords.length!==0&&dw.add(r)}),dw.empty||(dw.sort(t),WR(du,t.near,Math.min(e.near,t.far)),dw.forEachInDepthRange(du,hc.FRONT_TO_BACK,(r,s)=>{s<e.near&&PG(e,t,r)}),WR(du,Math.max(e.far,t.near),t.far),dw.forEachInDepthRange(du,hc.BACK_TO_FRONT,(r,s,n)=>{e.far=Math.max(e.far,n)}))}function PG(e,t,i){if(!i.isVisible||!Qy(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const r=i.transformation,s=Act;i.geometryRecords.forEach(n=>{dr(s,r,n.getShaderTransformation());const o=w1(s);abe(e,t,n.geometry.boundingInfo,s,o)})}function abe(e,t,i,r,s){if(R(i))return;const n=t.eye,o=t.viewForward;ke(Nn,i.center,r);const a=o[0]*(Nn[0]-n[0])+o[1]*(Nn[1]-n[1])+o[2]*(Nn[2]-n[2]);if(Nn[3]=i.radius*s,!(a-Nn[3]>e.near&&a+Nn[3]<e.far)&&Qy(t.frustum,Nn))if(i.radius>MG&&i.getChildren()){const l=i.getChildren();for(let c=0;c<8;++c)l[c]&&abe(e,t,l[c],r,s)}else IG.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function Rse(e,t,i){const r=t.eye,s=t.viewForward,n=(i[0]-r[0])*s[0]+(i[1]-r[1])*s[1]+(i[2]-r[2])*s[2];e.near=Math.min(e.near,n-i[3]),e.far=Math.max(e.far,n+i[3])}class Tct{constructor(){this._items=new $t({allocator:t=>t||{obj:null,distance:0,near:0,far:0},deallocator:t=>(t.obj=null,t.distance=0,t.near=0,t.far=0,t)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(t){this._items.pushNew().obj=t}sort(t){const i=t.eye,r=t.viewForward;this._items.forAll(s=>{const n=s.obj.boundingVolumeWorldSpace.bounds,o=(n[0]-i[0])*r[0]+(n[1]-i[1])*r[1]+(n[2]-i[2])*r[2];s.distance=o,s.near=o-n[3],s.far=o+n[3]}),this._items.sort((s,n)=>s.distance-n.distance)}forEachInDepthRange(t,i,r){if(i===hc.FRONT_TO_BACK)for(let s=0;s<this._items.length;++s){const n=this._items.data[s];n.far<t.near||n.near>t.far||r(n.obj,n.near,n.far)}else for(let s=this._items.length-1;s>=0;--s){const n=this._items.data[s];n.far<t.near||n.near>t.far||r(n.obj,n.near,n.far)}}}class Sct{constructor(){this.view=Te(),this.viewProj=Te(),this.frustum=AR(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}compute(t,i){this._reset(),Ur(this.view,t.viewMatrix),dr(this.viewProj,t.projectionMatrix,this.view),RL(this.frustum,t.frustum);const r=this.view,s=r[2],n=r[6],o=r[10],a=r[14],l=this.range;let c=0;if(i.forEach(g=>{if(!g.instanceParameters.visible||!g.castShadow)return;let y;g.hasShaderTransformation?(g.computeBoundingSphere(g.getShaderTransformation(),Nn,1),y=Nn):y=g.boundingSphere;const v=s*y[0]+n*y[1]+o*y[2]+a,b=v-y[3],w=v+y[3];this.geometries[c]=g,this.near[c]=-w,this.far[c]=-b,++c}),this.geometries.length===0)return l;for(let g=0;g<this.geometries.length;++g)this.near[g]>l.far&&(l.far=this.near[g]),this.near[g]>2&&this.far[g]<l.near&&(l.near=this.far[g]);const h=this.looseRange;h.near=Math.max(.5*l.near,2),h.far=2*l.far;let p=0,f=0;for(let g=0;g<this.geometries.length;++g)this.near[g]<l.near&&(this.near[g]>=h.near?l.near=this.near[g]:this.nearCandidates[p++]=g),this.far[g]>l.far&&(this.far[g]<=h.far?l.far=this.far[g]:this.farCandidates[f++]=g);if(this.nearCandidates.length===0&&this.farCandidates.length===0)return l;this.nearCandidates.sort((g,y)=>this.near[g]<this.near[y]?-1:this.near[g]>this.near[y]?1:0),this.farCandidates.sort((g,y)=>this.far[g]<this.far[y]?1:this.far[g]>this.far[y]?-1:0);for(let g=0;g<this.nearCandidates.length;++g){const y=this.nearCandidates[g];if(this.near[y]<l.near){const v=this.geometries[y],b=v.boundingInfo;this._includeNearBoundingInfoRec(b,v.getShaderTransformation())}}for(let g=0;g<this.farCandidates.length;++g){const y=this.farCandidates[g];if(this.far[y]>l.far){const v=this.geometries[y],b=v.boundingInfo;this._includeFarBoundingInfoRec(b,v.getShaderTransformation())}}return l}_reset(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE}_includeNearBoundingInfoRec(t,i){if(R(t))return;const r=t.getCenter();ke(Nn,r,i);const s=w1(i),n=Nn[0],o=Nn[1],a=Nn[2],l=t.getBSRadius()*s,c=this.frustum;if(c[0][0]*n+c[0][1]*o+c[0][2]*a+c[0][3]>l||c[1][0]*n+c[1][1]*o+c[1][2]*a+c[1][3]>l||c[2][0]*n+c[2][1]*o+c[2][2]*a+c[2][3]>l||c[3][0]*n+c[3][1]*o+c[3][2]*a+c[3][3]>l)return;const h=this.view[2]*n+this.view[6]*o+this.view[10]*a+this.view[14],p=h+l;if(!(-(h-l)<2||-p>=this.range.near))if(-p>this.looseRange.near)this.range.near=-p;else{if(l>MG){const f=t.getChildren();if(f!==void 0){for(let g=0;g<8;++g)f[g]!==void 0&&this._includeNearBoundingInfoRec(f[g],i);return}}IG.unionDepthRangeWithAABB(this.range,this.viewProj,i,t.getBBMin(),t.getBBMax())}}_includeFarBoundingInfoRec(t,i){if(R(t))return;let r=t.getBSRadius();const s=t.getCenter();ke(Nn,s,i);const n=w1(i),o=Nn[0],a=Nn[1],l=Nn[2];r*=n;const c=this.frustum;if(c[0][0]*o+c[0][1]*a+c[0][2]*l+c[0][3]>r||c[1][0]*o+c[1][1]*a+c[1][2]*l+c[1][3]>r||c[2][0]*o+c[2][1]*a+c[2][2]*l+c[2][3]>r||c[3][0]*o+c[3][1]*a+c[3][2]*l+c[3][3]>r)return;const h=this.view[2]*o+this.view[6]*a+this.view[10]*l+this.view[14]-r;if(!(-h<=this.range.far))if(-h<this.looseRange.far)this.range.far=-h;else{if(r>MG){const p=t.getChildren();if(p!==void 0){for(let f=0;f<8;++f)p[f]!==void 0&&this._includeFarBoundingInfoRec(p[f],i);return}}IG.unionDepthRangeWithAABB(this.range,this.viewProj,i,t.getBBMin(),t.getBBMax())}}}class Ect{constructor(){this.modelViewProj=Te(),this.clipPosition=[ni(),ni(),ni(),ni(),ni(),ni(),ni(),ni()]}unionDepthRangeWithAABB(t,i,r,s,n){const o=this.modelViewProj;dr(o,i,r);let a=!1;for(let l=0;l<8;++l){const c=this.clipPosition[l],h=l===0||l===3||l===4||l===7?s[0]:n[0],p=l===0||l===1||l===4||l===5?s[1]:n[1],f=l<4?s[2]:n[2];c[0]=o[0]*h+o[4]*p+o[8]*f+o[12],c[1]=o[1]*h+o[5]*p+o[9]*f+o[13],c[2]=o[2]*h+o[6]*p+o[10]*f+o[14],c[3]=o[3]*h+o[7]*p+o[11]*f+o[15]}for(let l=0;l<12;++l){const c=this.clipPosition[Iz[l][0]],h=this.clipPosition[Iz[l][1]],p=this.clipPosition[Iz[l][2]],f=this._clipTriangle(c,h,p);let g=!0;for(let y=0;y<f.length;++y)if(f[y][3]>=2){g=!1;break}if(!g){a=!0;for(let y=0;y<f.length;++y){const v=f[y][3];v<t.near&&(t.near=v),v>t.far&&(t.far=v)}}}return a}_inside(t,i){return i===0?t[0]>=-t[3]:i===1?t[1]>=-t[3]:i===2?t[0]<=t[3]:i===3?t[1]<=t[3]:void at(!1)}_intersect(t,i,r){let s=0;return r===0?s=(-t[3]-t[0])/(i[0]-t[0]+i[3]-t[3]):r===1?s=(-t[3]-t[1])/(i[1]-t[1]+i[3]-t[3]):r===2?s=(t[3]-t[0])/(i[0]-t[0]-i[3]+t[3]):r===3&&(s=(t[3]-t[1])/(i[1]-t[1]-i[3]+t[3])),m7(ni(),t,i,s)}_clipTriangle(t,i,r){let s=[t,i,r];for(let n=0;n<4;++n){const o=s;s=[];for(let a=0;a<o.length;++a){const l=o[a],c=o[(a+1)%o.length];this._inside(c,n)?(this._inside(l,n)||s.push(this._intersect(l,c,n)),s.push(c)):this._inside(l,n)&&s.push(this._intersect(l,c,n))}}return s}}const Iz=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],Nn=xn(),Act=Te(),du=XO(),dw=new Tct,Cct=new Sct,IG=new Ect;function Rct(){const e=new Oi;return e.attributes.add(E.POSITION,"vec2"),e.vertex.uniforms.add("proj","mat4"),e.vertex.uniforms.add("drawPosition","vec4"),e.varyings.add("vUV","vec2"),e.vertex.code.add(x`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),e.fragment.uniforms.add("textureInput","sampler2D"),e.fragment.uniforms.add("textureMask","sampler2D"),e.fragment.uniforms.add("textureOverlay","sampler2D"),e.fragment.uniforms.add("maskEnabled","bool"),e.fragment.uniforms.add("overlayEnabled","bool"),e.fragment.code.add(x`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);
gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),e}async function Oct(e){const t=import("./mask-svg.318fc328.js"),i=import("./overlay-svg.5292dcb7.js"),r=Fu((await t).default,{signal:e}),s=Fu((await i).default,{signal:e}),n={mask:await r,overlay:await s};return Qt(e),n}let cx=class extends we{constructor(){super(...arguments),this._handles=new Ut,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this.events=new xr,this.attributeLocations=new Map([[E.POSITION,0]]),this.tmpScreenPoint=Rr(),this.tmpRenderPoint=OEe()}get updating(){return R(this._imageSources)&&_(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const t=()=>{this._updateResourceLoading(),this.events.emit("request-render")};_(this._magnifier)&&this._handles.add(this._magnifier.watch("version",t)),t()}get enabled(){return _(this._validMagnifier)}get _validMagnifier(){return _(this._magnifier)&&this._magnifier.visible&&_(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return _(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),_(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}render(e,t){const i=this._validMagnifier;if(R(i))return;const r=t.camera.pixelRatio,s=Math.ceil(r*i.size);if(this._updateResources(e,s),R(this._resources))return;const n=this._resources.program;e.useProgram(n);const o=this._resources.textures,a=Math.ceil(1/this.factor*s);o.input.resize(a,a);const l=t.camera.fullWidth,c=t.camera.fullHeight;em(i.position,this.tmpScreenPoint);const h=t.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),p=.5*a,f=.5*a;h[0]=Be(h[0],p,l-p-1),h[1]=Be(h[1],f,c-f-1);const g=Math.floor(h[0]-p),y=Math.floor(h[1]-f);n.bindTexture(o.input,"textureInput"),e.gl.copyTexImage2D(o.input.descriptor.target,0,o.input.descriptor.pixelFormat,g,y,a,a,0);const v=i.offset.x*r,b=i.offset.y*r,w=(h[0]+v)/l*2-1,S=(h[1]-b)/c*2-1,T=s/l*2,A=s/c*2;e.bindVAO(this._resources.vao),n.bindTexture(o.overlay,"textureOverlay"),n.bindTexture(o.mask,"textureMask"),n.setUniform4f("drawPosition",w,S,T,A),n.setUniform1b("maskEnabled",i.maskEnabled),n.setUniform1b("overlayEnabled",i.overlayEnabled),e.setPipelineState(this._resources.pipelineState),e.drawArrays(Tt.TRIANGLE_STRIP,0,4)}_updateResourceLoading(){const e=this._validMagnifier;if(R(e))return;const t=e.maskUrl,i=e.overlayUrl;!_(this._imageLoadTask)||this._imageLoadTask.maskUrl===t&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),_(this._imageSources)||_(this._imageLoadTask)||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:iO(async r=>{const s=R(t)||R(i)?Oct(r):null,n=_(t)?Fu(t,{signal:r}):s.then(a=>a.mask),o=_(i)?Fu(i,{signal:r}):s.then(a=>a.overlay);this._imageSources={mask:await n,overlay:await o},this._disposeResources(),this.events.emit("request-render")})},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}_updateResources(e,t){if(!this.enabled)return void this._disposeResources();if(_(this._resources)){if(this._resources.textures.size!==t){const r=this._createTextureResources(e,t);if(R(r))return void this._disposeResources();this._disposeTextureResources(this._resources.textures),this._resources.textures=r}return}const i=this._createTextureResources(e,t);R(i)||(this._resources={textures:i,program:this._createProgram(e),vao:bo(e,pq,this.attributeLocations,0,1),pipelineState:Ot({blending:Sc(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:Ft})})}_disposeResources(){R(this._resources)||(this._disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}_disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}_createTextureResources(e,t){if(R(this._imageSources))return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;const i=new Qe(e,{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,internalFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE,samplingMode:Ge.LINEAR,flipped:!0,preMultiplyAlpha:!uj(this._imageSources.overlay.src)||!e.driverTest.svgAlwaysPremultipliesAlpha},this._imageSources.overlay),r=new Qe(e,{target:st.TEXTURE_2D,pixelFormat:$e.ALPHA,internalFormat:$e.ALPHA,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE,samplingMode:Ge.LINEAR,flipped:!0},this._imageSources.mask);return{input:new Qe(e,{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,internalFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE,samplingMode:Ge.LINEAR,flipped:!1}),mask:r,overlay:i,size:t}}_createProgram(e){const t=Rct();return new Mi(e,t,this.attributeLocations)}};u([d()],cx.prototype,"_imageSources",void 0),u([d()],cx.prototype,"_imageLoadTask",void 0),u([d({readOnly:!0})],cx.prototype,"updating",null),cx=u([P("esri/views/3d/webgl-engine/lib/MagnifierHelper")],cx);const Mct=.5,Pct=1e3/30;var XR;(function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"})(XR||(XR={}));class Ig{constructor(t,i,r=XR.FrontToBack){this._rctx=t,this._techniqueRepository=i,this._sorting=r,this._draws=new $t({initialSize:32,allocator:s=>s||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._passBoundTechniques=new Set,this._previouslyBoundMaterials=new Map,this._previouslyBoundDraw=new Map}submitDraw(t,i,r,s,n){const o=this._draws.pushNew();o.geometry=i,o.geometryRanges=r,o.material=t,o.bindDrawParams=s,o.depthSquaredHint=n,o.indexType=i.indexed?i.vao.indexBuffer.indexType:0}dispatch(t){const i=this._rctx;this._passBoundTechniques.clear(),this._previouslyBoundMaterials.clear(),this._previouslyBoundDraw.clear();let r=null;const s=this._draws.map(o=>o.material.prepareTechnique(this._techniqueRepository,t,o.geometry.parameters)),n=this._draws.length;for(let o=0;o<n;o++){const a=s[o];a===r&&a.configuration.transparencyPassType===lt.NONE||(i.useTechnique(a,t.slot),r=a),this._passBoundTechniques.has(a)||(a.bindPass(t),this._passBoundTechniques.add(a));const l=this._draws.data[o],c=l.geometry;i.bindVAO(c.vao),this._previouslyBoundMaterials.get(a)!==l.material&&(a.bindMaterial(l.material,t),this._previouslyBoundMaterials.set(a,l.material)),this._previouslyBoundDraw.get(a)!==l.bindDrawParams&&(a.bindDraw(l.bindDrawParams),this._previouslyBoundDraw.set(a,l.bindDrawParams));const h=l.geometryRanges,p=h.length;if(l.indexType!==0){const f=z$.get(l.indexType);for(let g=0;g<p;g+=2){const y=h[g],v=h[g+1];i.drawElements(c.primitiveType,v,l.indexType,y*f)}}else for(let f=0;f<p;f+=2){const g=h[f],y=h[f+1];i.drawArrays(c.primitiveType,g,y)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const t=this._sorting===XR.FrontToBack?1:-1;this._draws.sort((i,r)=>{const s=t*(i.depthSquaredHint-r.depthSquaredHint);return s!==0?s:i.geometry.vao.size-r.geometry.vao.size})}get count(){return this._draws.length}}const z$=new Map;z$.set(ot.UNSIGNED_BYTE,1),z$.set(ot.UNSIGNED_SHORT,2),z$.set(ot.UNSIGNED_INT,4);class Ict{constructor(t,i){this.rctx=t,this.shaderTechniqueRepository=i,this.canRender=!0,this._materialPassParams=new rct,this._shadowPassParams=new sct,this._highlightPassParams=new nct,this._systems=new Set,this._passes={materialOpaque:new Ig(t,this.shaderTechniqueRepository),materialTransparent:new Ig(t,this.shaderTechniqueRepository,XR.BackToFront),materialIntegratedMesh:new Ig(t,this.shaderTechniqueRepository),shadowMap:new Ig(t,this.shaderTechniqueRepository),highlight:new Ig(t,this.shaderTechniqueRepository),highlightIntegratedMesh:new Ig(t,this.shaderTechniqueRepository),highlightShadowMap:new Ig(t,this.shaderTechniqueRepository),defaultShadowMap:new Ig(t,this.shaderTechniqueRepository)}}register(t){this._systems.add(t)}prepareRender(t){if(this._systems.size!==0){for(const i of Object.values(this._passes))i.prepareSubmit();this._systems.forEach(i=>i.submit(this._passes,{camera:t}));for(const i of Object.values(this._passes))i.finishSubmit();this.shaderTechniqueRepository.frameUpdate()}}render(t){if(this._systems.size!==0)switch(this._configure(t),t.slot){case ve.OPAQUE_PLUGIN:switch(t.pass){case Le.MATERIAL:return this._materialPassParams.subPass=jr.Color,this._configureMaterialColorPass(t),this._passes.materialOpaque.dispatch(this._materialPassParams);case Le.MATERIAL_DEPTH:return this._materialPassParams.subPass=jr.Depth,this._passes.materialOpaque.dispatch(this._materialPassParams);case Le.MATERIAL_NORMAL:return this._materialPassParams.subPass=jr.Normal,this._passes.materialOpaque.dispatch(this._materialPassParams);case Le.MATERIAL_HIGHLIGHT:return this._passes.highlight.dispatch(this._highlightPassParams);case Le.MATERIAL_DEPTH_SHADOWMAP_ALL:return this._passes.shadowMap.dispatch(this._shadowPassParams);case Le.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT:return this._passes.highlightShadowMap.dispatch(this._shadowPassParams);case Le.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return this._passes.defaultShadowMap.dispatch(this._shadowPassParams)}return;case ve.TRANSPARENT_PLUGIN:switch(t.pass){case Le.MATERIAL:return this._materialPassParams.subPass=jr.Color,this._configureMaterialColorPass(t),this._passes.materialTransparent.dispatch(this._materialPassParams);case Le.MATERIAL_ALPHA:return this._materialPassParams.subPass=jr.Alpha,this._configureMaterialColorPass(t),this._passes.materialTransparent.dispatch(this._materialPassParams);case Le.MATERIAL_DEPTH:return this._materialPassParams.subPass=jr.Depth,this._passes.materialTransparent.dispatch(this._materialPassParams);case Le.MATERIAL_NORMAL:return this._materialPassParams.subPass=jr.Normal,this._passes.materialTransparent.dispatch(this._materialPassParams)}return;case ve.INTEGRATED_MESH:switch(t.pass){case Le.MATERIAL:return this._materialPassParams.subPass=jr.Color,this._configureMaterialColorPass(t),this._materialPassParams.ssrParams=t.ssrParams,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case Le.MATERIAL_DEPTH:return this._materialPassParams.subPass=jr.Depth,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case Le.MATERIAL_NORMAL:return this._materialPassParams.subPass=jr.Normal,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case Le.MATERIAL_HIGHLIGHT:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}return}}notifyDirty(){this._context.requestRender()}slots(){return[ve.OPAQUE_PLUGIN,ve.TRANSPARENT_PLUGIN,ve.INTEGRATED_MESH]}initializeRenderContext(t){this._context=t}uninitializeRenderContext(){}queryDepthRange(t){const i={near:1/0,far:-1/0};return this._systems.forEach(r=>{const s=r.queryShadowCasterDepthRange(t);_(s)&&OS(i,s,i)}),i}get shadowCastingEnabled(){return this._materialPassParams.shadowsEnabled}set shadowCastingEnabled(t){this._materialPassParams.shadowsEnabled=t}get fillLightsEnabled(){return this._materialPassParams.hasFillLights}set fillLightsEnabled(t){this._materialPassParams.hasFillLights=t}get screenSpaceReflectionsEnabled(){return _(this._materialPassParams.ssrParams.ssrEnabled)}set screenSpaceReflectionsEnabled(t){this._materialPassParams.ssrParams.ssrEnabled=!!t}_configureMaterialColorPass(t){this._materialPassParams.bindShadowMap=i=>{t.shadowMap.bind(i);const r=this._materialPassParams.viewTransform;pe(mE,r.transformWorldFromViewTL,r.transformWorldFromViewTH),t.shadowMap.bindView(i,mE)},this._materialPassParams.bindAmbientOcclusion=i=>t.ssaoHelper.bind(i,t.camera),this._materialPassParams.ambientOcclusionEnabled=!!t.ssaoHelper&&t.ssaoHelper.ready,this._materialPassParams.sceneHasOcludees=t.hasOccludees}_configure(t){const i=t.pass===Le.MATERIAL_DEPTH_SHADOWMAP_ALL||t.pass===Le.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT||t.pass===Le.MATERIAL_DEPTH_SHADOWMAP_DEFAULT?this._shadowPassParams:t.pass===Le.MATERIAL_HIGHLIGHT?this._highlightPassParams:this._materialPassParams;this._updateParameters(t,i)}_updateParameters(t,i){const r=t.camera,s=r.viewInverseTransposeMatrix;oe(mE,s[3],s[7],s[11]),$z.set(mE),ne(i.viewTransform.transformWorldFromViewTH,$z.high),ne(i.viewTransform.transformWorldFromViewTL,$z.low),Lu(i.viewTransform.transformViewFromCameraRelativeRS,r.viewMatrix),Ur(i.viewTransform.transformProjFromView,r.projectionMatrix),i.identifier===bs.Material?(this._materialPassParams.transparent=t.slot===ve.TRANSPARENT_PLUGIN,this._materialPassParams.integratedMesh=t.slot===ve.INTEGRATED_MESH,this._materialPassParams.lighting=t.scenelightingData,Nu(Ose,i.viewTransform.transformViewFromCameraRelativeRS),k1(i.transformNormalViewFromGlobal,Ose),zs(i.nearFar,r.nearFar)):i.identifier===bs.ShadowMap?zs(i.nearFar,r.nearFar):i.identifier===bs.Highlight&&(i.highlightDepthTexture=t.highlightDepthTexture,_a(i.viewport,r.fullViewport)),i.identifier!==bs.Material&&i.identifier!==bs.Highlight||(i.inverseViewport[0]=1/r.fullViewport[2],i.inverseViewport[1]=1/r.fullViewport[3]),que(t.sliceHelper.plane,i.slicePlane),de(i.slicePlane.origin,i.slicePlane.origin,mE),i.slicePlaneEnabled=t.sliceHelper.isEnabled,this._materialPassParams.slot=t.slot,this._materialPassParams.transparencyPassType=t.transparencyPassType,this._materialPassParams.multipassTerrainParams=t.multipassTerrainParams}get needsHighlight(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}get needsTransparentPass(){return this._passes.materialTransparent.count>0}}const mE=M(),Ose=wr(),$z=new K4;var ol;function $ct(e){const t=new Oi,i=t.vertex.code,r=t.fragment.code;return t.attributes.add(E.POSITION,"vec2"),e.highlightStage===ol.Downsample&&(i.add(x`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("invFramebufferDim","vec2"),r.add(x`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture2D(tex, coord);
float mx = floor(max(value.g, value.b));
gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`)),e.highlightStage===ol.Blur&&(t.attributes.add(E.UV0,"vec2"),e.gridOptimization?(t.vertex.uniforms.add("coverageTex","sampler2D"),t.fragment.uniforms.add("blurSize","vec2"),t.varyings.add("blurCoordinate","vec3")):(t.vertex.uniforms.add("blurSize","vec2"),t.varyings.add("blurCoordinates[5]","vec2")),i.add(x`
    void main() {
      gl_Position = vec4(position, 0.0, 1.0);
      ${e.gridOptimization?x`
      vec4 cov = texture2D(coverageTex, uv0);
      if (cov.r == 0.0) {
        gl_Position = vec4(0.0);
      }
      blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
      `:x`
      vec2 uv = position.xy * 0.5 + vec2(0.5);
      blurCoordinates[0] = uv;
      blurCoordinates[1] = uv + blurSize * 1.407333;
      blurCoordinates[2] = uv - blurSize * 1.407333;
      blurCoordinates[3] = uv + blurSize * 3.294215;
      blurCoordinates[4] = uv - blurSize * 3.294215;
          `}
    }`),t.fragment.uniforms.add("tex","sampler2D"),r.add(x`
    void main() {
      ${e.gridOptimization?x`
          vec2 uv = blurCoordinate.xy;
          vec4 center = texture2D(tex, uv);

          // do not blur if no pixel or all pixels in neighborhood are set
          if (blurCoordinate.z == 1.0) {
            gl_FragColor = center;
          } else {
            vec4 sum = vec4(0.0);
            sum += center * 0.204164;
            sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
            sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
            gl_FragColor = sum;
          }`:x`
          vec4 sum = vec4(0.0);
          sum += texture2D(tex, blurCoordinates[0]) * 0.204164;
          sum += texture2D(tex, blurCoordinates[1]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[2]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[3]) * 0.093913;
          sum += texture2D(tex, blurCoordinates[4]) * 0.093913;
          gl_FragColor = sum;`}
    }`)),e.highlightStage===ol.Apply&&(t.varyings.add("uv","vec2"),e.gridOptimization&&(t.attributes.add(E.UV0,"vec2"),t.vertex.uniforms.add("coverageTex","sampler2D")),i.add(x`
      void main() {
        ${e.gridOptimization?x`
            vec4 cov = texture2D(coverageTex, uv0);
            // if no highlight pixel set in this block, hide block
            if (cov.r == 0.0) {
              gl_Position = vec4(0.0);
              return;
            }`:""}
        gl_Position = vec4(position, 0.0, 1.0);
        uv = position.xy * 0.5 + vec2(0.5);
      }`),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("origin","sampler2D"),t.fragment.uniforms.add("uColor","vec4"),t.fragment.uniforms.add("haloColor","vec4"),t.fragment.uniforms.add("outlineSize","float"),t.fragment.uniforms.add("blurSize","float"),t.fragment.uniforms.add("opacities","vec4"),r.add(x`void main() {
vec4 blurredHighlightValue = texture2D(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture2D(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = uColor.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = uColor.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
gl_FragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);
}`)),t}(function(e){e[e.Blur=0]="Blur",e[e.Apply=1]="Apply",e[e.Downsample=2]="Downsample",e[e.COUNT=3]="COUNT"})(ol||(ol={}));const Dct=Object.freeze({__proto__:null,get HighlightCompositionPass(){return ol},build:$ct}),Lct=8.6,Nct=.4;class Ly extends Gi{initializeProgram(t){const i=Ly.shader.get().build(this.configuration);return new Mi(t.rctx,i,mi)}bindApplyPass(t){this.program.setUniform4fv("uColor",t.color),this.program.setUniform4fv("haloColor",t.haloColor),this.program.setUniform1f("outlineSize",Lct),this.program.setUniform1f("blurSize",Nct),this.program.setUniform4f("opacities",t.haloOpacity,t.haloOpacityOccluded,t.fillOpacity,t.fillOpacityOccluded)}initializePipeline(){return this.configuration.highlightStage===ol.Apply?Ot({blending:Xn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Ft}):Ot({colorWrite:Ft})}get primitiveType(){return this.configuration.gridOptimization?Tt.TRIANGLES:Tt.TRIANGLE_STRIP}}Ly.shader=new Ni(Dct,()=>import("./HighlightComposition.glsl.a6186650.js"));class $G extends mr{constructor(){super(...arguments),this.highlightStage=ol.Blur,this.gridOptimization=!1}}u([Z({count:ol.COUNT})],$G.prototype,"highlightStage",void 0),u([Z()],$G.prototype,"gridOptimization",void 0);const Fct=32;class Uct{constructor(t,i){this._techniqueRep=t,this._rctx=i,this.viewportToRestore=ni(),this.defaultOptions={color:Ca(1,0,1,1),haloColor:Ca(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05,shadowColor:Ca(1,0,1,1),shadowOpacity:.15,occludedShadowOpacity:.075},this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}_assertResources(){if(this.quadVAO)return;this.quadVAO=bo(this._rctx);const t={colorTarget:vr.TEXTURE,depthStencilTarget:ti.NONE,width:0,height:0},i={target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.LINEAR,wrapMode:ct.CLAMP_TO_EDGE,width:0,height:0};this.blur0Fbo=new zi(this._rctx,t,i),this.blur1Fbo=new zi(this._rctx,t,i);const r=new $G;r.highlightStage=ol.Blur,r.gridOptimization=!1,this.blurTechnique=this._techniqueRep.acquire(Ly,r),r.highlightStage=ol.Blur,r.gridOptimization=!0,this.blurGridTechnique=this._techniqueRep.acquire(Ly,r),r.highlightStage=ol.Apply,r.gridOptimization=!1,this.applyTechnique=this._techniqueRep.acquire(Ly,r),r.highlightStage=ol.Apply,r.gridOptimization=!0,this.applyGridTechnique=this._techniqueRep.acquire(Ly,r),r.highlightStage=ol.Downsample,r.gridOptimization=!1,this.downsampleTechnique=this._techniqueRep.acquire(Ly,r)}dispose(){if(this._grid.coverageMipmap)for(let t=1;t<this._grid.coverageMipmap.length;t++)this._grid.coverageMipmap[t].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this.quadVAO&&(this.quadVAO.dispose(!0),this.quadVAO=null),this.blur0Fbo=tt(this.blur0Fbo),this.blur1Fbo=tt(this.blur1Fbo)}get profilingCallback(){return hi.HIGHLIGHTS_PROFILE_TO_CONSOLE?t=>console.log(t):null}setDefaultOptions(t){this.defaultOptions=t}render(t,i,r){const s=t.pixelRatio,n=hi.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED,o=this._rctx;this._assertResources(),_a(this.viewportToRestore,t.fullViewport);const a=t.fullWidth,l=t.fullHeight,c=Math.ceil(a/s),h=Math.ceil(l/s);this.blur0Fbo.resize(c,h),this.blur1Fbo.resize(c,h),o.bindVAO(this.quadVAO);let p=null;const f=n?this.blurGridTechnique:this.blurTechnique,g=o.useTechnique(f);n?(this._gridUpdateResources(i,Fct),this._gridComputeMipmap(),p=this._grid.vao,g.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,"coverageTex")):p=this.quadVAO,o.bindVAO(p),o.bindFramebuffer(this.blur0Fbo),o.setViewport(0,0,c,h),o.setClearColor(0,0,0,0),o.clear(bi.COLOR_BUFFER_BIT),g.bindTexture(i.colorTexture,"tex"),g.setUniform2f("blurSize",1/c,0),o.drawArrays(f.primitiveType,0,vn(p,"geometry")),o.bindFramebuffer(this.blur1Fbo),o.clear(bi.COLOR_BUFFER_BIT),g.bindTexture(this.blur0Fbo.colorTexture,"tex"),g.setUniform2f("blurSize",0,1/h),o.drawArrays(f.primitiveType,0,vn(p,"geometry")),o.bindFramebuffer(r),o.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]);const y=n?this.applyGridTechnique:this.applyTechnique,v=o.useTechnique(y);if(v.bindTexture(this.blur1Fbo.colorTexture,"tex"),v.bindTexture(i.colorTexture,"origin"),n){const b=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;v.bindTexture(b,"coverageTex")}y.bindApplyPass(this.defaultOptions),o.drawArrays(y.primitiveType,0,vn(p,"geometry")),o.bindVAO(null)}_gridUpdateResources(t,i){const r=this._rctx,s=this._grid;let n=!1;if(s.coverageMipmap===null&&(s.coverageMipmap=[t],n=!0),s.viewportWidth===t.width&&s.viewportHeight===t.height||(n=!0,s.viewportWidth=t.width,s.viewportHeight=t.height),s.coverageMipmap[0]=t,s.cellPixelSize!==i&&(s.cellPixelSize=i,n=!0),n){for(let l=1;l<s.coverageMipmap.length;l++)s.coverageMipmap[l].dispose();s.mipmapLevels=Math.ceil(Math.log(s.cellPixelSize)*Math.LOG2E),s.coverageMipmap.length=s.mipmapLevels+1;for(let l=0;l<s.mipmapLevels;l++){const c=s.coverageMipmap[l],h={target:st.TEXTURE_2D,pixelFormat:$e.RGB,dataType:yt.UNSIGNED_SHORT_5_6_5,samplingMode:Ge.LINEAR,wrapMode:ct.CLAMP_TO_EDGE,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)},p={colorTarget:vr.TEXTURE,depthStencilTarget:ti.NONE,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)};s.coverageMipmap[l+1]=new zi(r,p,h)}}const o=Math.ceil(t.height/s.cellPixelSize),a=Math.ceil(t.width/s.cellPixelSize);if(!s.vao||s.verticalCellCount!==o||s.horizontalCellCount!==a){s.verticalCellCount=o,s.horizontalCellCount=a;const l=o+1,c=a+1,h=1/o,p=1/a,f=6,g=4,y=new Float32Array(f*g*l*c);let v=0;for(let b=0;b<l;b++)for(let w=0;w<c;w++)y[v+0]=(w-.5)*p*2-1,y[v+1]=(b-.5)*h*2-1,y[v+2]=w*p,y[v+3]=b*h,y[v+4]=(w+.5)*p*2-1,y[v+5]=(b-.5)*h*2-1,y[v+6]=w*p,y[v+7]=b*h,y[v+8]=(w-.5)*p*2-1,y[v+9]=(b+.5)*h*2-1,y[v+10]=w*p,y[v+11]=b*h,y[v+12]=(w-.5)*p*2-1,y[v+13]=(b+.5)*h*2-1,y[v+14]=w*p,y[v+15]=b*h,y[v+16]=(w+.5)*p*2-1,y[v+17]=(b-.5)*h*2-1,y[v+18]=w*p,y[v+19]=b*h,y[v+20]=(w+.5)*p*2-1,y[v+21]=(b+.5)*h*2-1,y[v+22]=w*p,y[v+23]=b*h,v+=f*g;s.vao&&s.vao.dispose(!0),s.vao=new us(r,mi,{geometry:RO},{geometry:jt.createVertex(r,ri.STATIC_DRAW,y)})}}_gridComputeMipmap(){const t=this._rctx,i=this._grid,r=t.useTechnique(this.downsampleTechnique);t.bindVAO(this.quadVAO);for(let s=0;s<i.mipmapLevels;s++){t.bindFramebuffer(i.coverageMipmap[s+1]),r.bindTexture(i.coverageMipmap[s].colorTexture,"tex");const n=i.coverageMipmap[s+1].width,o=i.coverageMipmap[s+1].height;r.setUniform2f("invFramebufferDim",1/n,1/o),t.setViewport(0,0,n,o),t.drawArrays(Tt.TRIANGLE_STRIP,0,vn(this.quadVAO,"geometry"))}}get gpuMemoryUsage(){let t=(_(this.blur0Fbo)?this.blur0Fbo.gpuMemoryUsage:0)+(_(this.blur1Fbo)?this.blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const i of this._grid.coverageMipmap)t+=i.gpuMemoryUsage;return t}get test(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}const kct={dataType:yt.UNSIGNED_BYTE,internalFormat:$e.RGBA},zct={};class Bct{constructor(t){this.rctx=t,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this.depthTextureSupported=t.capabilities.depthTexture}dispose(){this._depthBuffers.forEach(t=>t.dispose()),this._depthBuffers.clear(),this._depthTextures.forEach(t=>t.dispose()),this._depthTextures.clear(),this._colorTextures.forEach(t=>t.dispose()),this._colorTextures.clear(),this._framebuffers.forEach(t=>t.dispose()),this._framebuffers.clear(),this._activeTargets.clear()}disposeTargetResource(t){const i=t.id;this._activeTargets.has(i)&&(this._activeTargets.delete(i),this._disposeWithFramebuffers(this._depthTextures,i),this._disposeWithFramebuffers(this._depthBuffers,i),this._disposeWithFramebuffers(this._colorTextures,i))}_disposeWithFramebuffers(t,i){const r=t.get(i);r&&(this._framebuffers.forEach((s,n)=>{s.colorAttachment!==r&&s.depthStencilAttachment!==r||(s.detachAll(),s.dispose(),this._framebuffers.delete(n))}),r.dispose(),t.delete(i))}getDepthTexture(t,i){if(!this.depthTextureSupported)return null;let r=this._depthTextures.get(t.id);return!r||r.descriptor.width===i.width&&r.descriptor.height===i.height||(r.dispose(),r=null),r||(r=new Qe(this.rctx,{target:st.TEXTURE_2D,pixelFormat:$e.DEPTH_STENCIL,dataType:yt.UNSIGNED_INT_24_8,samplingMode:Ge.NEAREST,wrapMode:ct.CLAMP_TO_EDGE,width:i.width,height:i.height}),this._depthTextures.set(t.id,r),this._activeTargets.add(t.id)),r}getAllocatedDepthTexture(t){return this._depthTextures.get(t.id)}getDepthBuffer(t,i){if(this.depthTextureSupported)return null;let r=this._depthBuffers.get(t.id);return r?r.descriptor.width===i.width&&r.descriptor.height===i.height||r.resize(i.width,i.height):(r=new sx(this.rctx,I({internalFormat:Bo.DEPTH_STENCIL},i)),this._depthBuffers.set(t.id,r),this._activeTargets.add(t.id)),r}getColorTexture(t,i){let r=this._colorTextures.get(t.id);return r&&(r.descriptor.width===i.width&&r.descriptor.height===i.height||(r.dispose(),r=null)),r||(r=new Qe(this.rctx,{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,internalFormat:t.internalFormat,dataType:t.dataType,samplingMode:t.samplingMode!=null?t.samplingMode:Ge.LINEAR,wrapMode:ct.CLAMP_TO_EDGE,width:i.width,height:i.height}),this._colorTextures.set(t.id,r),this._activeTargets.add(t.id)),r}getAllocatedColorTexture(t){return this._colorTextures.get(t.id)}registerDepthTarget(t={}){return I(I({id:Ta()},zct),t)}registerColorTarget(t={}){return I(I({id:Ta()},kct),t)}getFramebuffer(t,i,r){const s=this._getKey(i,r);let n=this._framebuffers.get(s);const o=this.getColorTexture(i,t);if(this.depthTextureSupported){const l=r?this.getDepthTexture(r,t):void 0;return n?((n.width!==t.width||n.height!==t.height||n.colorTexture!==o||n.depthStencilTexture!==l)&&(n.detachAll(),n.resize(t.width,t.height),n.attachColorTexture(o),n.attachDepthStencilTexture(l)),n):(n=_(r)?new zi(this.rctx,{colorTarget:vr.TEXTURE,depthStencilTarget:ti.DEPTH_STENCIL_TEXTURE},o,l):new zi(this.rctx,{colorTarget:vr.TEXTURE,depthStencilTarget:ti.NONE},o),this._framebuffers.set(s,n),n)}const a=r?this.getDepthBuffer(r,t):void 0;return n?((n.width!==t.width||n.height!==t.height||n.colorTexture!==o)&&(n.detachAll(),n.resize(t.width,t.height),n.attachColorTexture(o),n.attachDepthStencilBuffer(a)),n):(n=new zi(this.rctx,{colorTarget:vr.TEXTURE,depthStencilTarget:r?ti.DEPTH_STENCIL_RENDER_BUFFER:ti.NONE},o,a),this._framebuffers.set(s,n),n)}_getKey(t,i){return`${t.id}_${i?i.id:"X"}_${t.name}${i?"_"+i.name:""}`}get gpuMemoryUsage(){let t=0;const i=new Set,r=s=>{i.has(s)||(i.add(s),t+=c0(s))};return this._depthTextures.forEach(r),this._colorTextures.forEach(r),this._depthBuffers.forEach(r),t}}class Vct{constructor(t,i){this._rctx=t,this._compositingHelper=i,this._mainColorTarget=0,this._dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};const r=t.type===Kt.WEBGL2;this._renderTargetHelper=new Bct(t);const s=this._renderTargetHelper;this.mainColorTargets=[s.registerColorTarget({name:"mainColorTarget0"}),s.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=s.registerColorTarget({name:"frontFaceTarget"});const n=o=>s.registerColorTarget({name:o,dataType:yt.FLOAT,internalFormat:r?nt.RGBA32F:$e.RGBA,samplingMode:Ge.NEAREST});this.colorFloatTarget=n("colorFloatTarget"),this.alphaFloatTarget=n("alphaFloatTarget"),this.mainDepth=s.registerDepthTarget({name:"mainDepth"}),this.linearDepth=s.registerColorTarget({name:"linearDepth",samplingMode:Ge.NEAREST}),this.terrainLinearDepth=s.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=s.registerColorTarget({name:"geometryLinearDepth"}),this.normal=s.registerColorTarget({name:"normal"}),this.highlight=s.registerColorTarget({name:"highlight",internalFormat:r?nt.RGBA4:$e.RGBA,dataType:yt.UNSIGNED_SHORT_4_4_4_4}),this.hudVisibility=s.registerColorTarget({name:"hudVisibility",internalFormat:r?nt.RGBA4:$e.RGBA,dataType:yt.UNSIGNED_SHORT_4_4_4_4}),this.tmpColor=s.registerColorTarget({name:"tmpColor"}),this.tmpDepth=s.registerDepthTarget({name:"tmpDepth"}),this.hudColor=s.registerColorTarget({name:"hudColor"})}dispose(){this._renderTargetHelper.dispose()}get width(){return this._dimensions.width}get height(){return this._dimensions.height}set background(t){this._background=t}get background(){return this._background}get currentColorTarget(){return this.mainColorTargets[this._mainColorTarget]}get previousColorTarget(){return this.mainColorTargets[1-this._mainColorTarget]}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(t,i){return this._renderTargetHelper.getFramebuffer(this._dimensions,t,i)}get colorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this._getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this._getColorTexture(this.tmpColor)}get hudColorTexture(){return this._getColorTexture(this.hudColor)}get mainColorTexture(){return this._getColorTexture(this.currentColorTarget)}advanceCurrentRenderTarget(){this._mainColorTarget=this._mainColorTarget===0&&this._needLastFrameColorTexture?1:0}initializeFrame(t){const i=this._rctx;this._dimensions.width=t.fullWidth,this._dimensions.height=t.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),i.setClearStencil(0);const r=this._background.color;i.setClearColor(r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),i.clearSafe(bi.COLOR_BUFFER_BIT|bi.DEPTH_BUFFER_BIT|bi.STENCIL_BUFFER_BIT)}composite(){_(this.colorTexture)&&this._compositingHelper.composite(this.colorTexture,kn.None)}renderTmpAndCompositeToMain(t,i,r=!1){this.renderToTargets(t,this.tmpColor,r?this.tmpDepth:this.mainDepth,Gct),this._compositingHelper.composite(this._getColorTexture(this.tmpColor),i)}renderHUDVisibility(t,i=!1){this.renderToTargets(t,this.hudVisibility,i?this.tmpDepth:this.mainDepth,jct)}compositeTransparentTerrainOntoHUDVisibility(){this.renderToTargets(()=>this._compositingHelper.composite(this._getColorTexture(this.tmpColor),kn.None,1,xa.TransparentToHUDVisibility),this.hudVisibility,this.tmpDepth)}renderOITPass(t,i,r){let s,n;switch(i){case lt.Color:s=this.colorFloatTarget,n=[0,0,0,0];break;case lt.Alpha:s=this.alphaFloatTarget,n=[1,1,1,1];break;case lt.FrontFace:s=this.frontFaceTarget,n=[0,0,0,0]}r?this.renderToTargets(t,s,this.tmpDepth,n,!0,!0):this.renderToTargets(t,s,this.mainDepth,n,!1)}compositeTransparentTerrainOntoMain(){this.bindFramebuffer(),this._compositingHelper.composite(this._getColorTexture(this.tmpColor),kn.PremultipliedAlpha)}compositeOccludedOntoMain(t){this.bindFramebuffer(),this._compositingHelper.composite(this._getColorTexture(this.tmpColor),kn.PremultipliedAlpha,t)}compositeTransparentOntoOpaque(t){t?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(bi.COLOR_BUFFER_BIT)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(this._getColorTexture(this.colorFloatTarget),this._getColorTexture(this.alphaFloatTarget),this._getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(t){this.bindTarget(this.currentColorTarget),t(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(t){this._renderTargetHelper.disposeTargetResource(t)}set needLastFrameColorTexture(t){!t&&this._needLastFrameColorTexture&&(this._mainColorTarget=0,this.disposeTarget(this.mainColorTargets[1])),this._needLastFrameColorTexture=t}get needLastFrameColorTexture(){return this._needLastFrameColorTexture}renderToTargets(t,i,r,s,n=!1,o=!1){const a=this._rctx,l=this.bindTarget(i,r);let c=0;if(s){const p=Math.max(1e-13,s[3]);a.setClearColor(s[0],s[1],s[2],p),c|=bi.COLOR_BUFFER_BIT}return n&&(c|=bi.DEPTH_BUFFER_BIT),o===!1?o=0:(o===!0&&(o=255),c|=bi.STENCIL_BUFFER_BIT),c&&a.clearSafe(c,o),t(),a.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),l}bindTarget(t,i){const r=this._renderTargetHelper.getFramebuffer(this._dimensions,t,i);return this._rctx.bindFramebuffer(r),r}_getColorTexture(t){return this._renderTargetHelper.getColorTexture(t,this._dimensions)}get gpuMemoryUsage(){let t=0;return this._renderTargetHelper&&(t+=this._renderTargetHelper.gpuMemoryUsage),t}}const Gct=[0,0,0,0],jct=[0,1,0,1];class Hct{constructor(t){this.context=t,this.renderPlugins=new Array,this.slots=[];for(let i=0;i<ve.MAX_SLOTS;++i)this.slots[i]=[]}add(t,i,r){const s=()=>{this.renderPlugins.push(i);for(const o of t)this.slots[o].push(i);this.context.requestRender()},n=i.initializeRenderContext(this.context,r);if(Cc(n))return n.then(s);s()}remove(t){const i=this.renderPlugins.length;this.renderPlugins=this.renderPlugins.filter(r=>r!==t),at(this.renderPlugins.length<i,"Removing non-added render plugin");for(let r=0;r<this.slots.length;++r)this.slots[r]=this.slots[r].filter(s=>s!==t);t.uninitializeRenderContext(),this.context.requestRender()}prepareRender(t,i){for(const r of this.renderPlugins)r.prepareRender&&r.prepareRender(t,i)}updateAnimation(t){let i=!1;return this.renderPlugins.forEach(r=>{r.updateAnimation&&(i=r.updateAnimation(t)||i)}),i}render(){const t=this.slots[this.context.renderContext.slot],i=new Array;t.filter(r=>{if(!r.canRender)return!1;if(qct(r)){const s=r.prepareTechnique(this.context.renderContext);return!!s&&(i.push(s),!0)}return i.push(null),!0}).forEach((r,s)=>r.render(this.context.renderContext,i[s]))}queryDepthRange(t){const i=Wct;i.near=1/0,i.far=-1/0;for(const r of this.renderPlugins)if(r.queryDepthRange){const s=r.queryDepthRange(t);s&&OS(i,s,i)}return i}get needsTransparentPass(){return this.renderPlugins.some(t=>t.needsTransparentPass)}get needsHighlight(){return this.renderPlugins.some(t=>t.needsHighlight)}get needsLinearDepth(){return this.renderPlugins.some(t=>t.needsLinearDepth)}get needsLaserlineWithContrastControl(){const t=this.slots[ve.LASERLINES_CONTRAST_CONTROL];return!!t&&t.length>0}get renderOccludedFlags(){let t=0;return this.renderPlugins.forEach(i=>{i.renderOccludedFlags&&(t|=i.renderOccludedFlags)}),t}}function qct(e){return"prepareTechnique"in e}const Wct={near:0,far:0};function vX(e){e.fragment.uniforms.add("projInfo","vec4"),e.fragment.uniforms.add("zScale","vec2"),e.fragment.code.add(x`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)}var Un,Nm;(function(e){e[e.Accumulate=0]="Accumulate",e[e.Visualize=1]="Visualize",e[e.VisualizeCurrent=2]="VisualizeCurrent",e[e.COUNT=3]="COUNT"})(Un||(Un={})),function(e){e[e.Gradient=0]="Gradient",e[e.Threshold=1]="Threshold"}(Nm||(Nm={}));const e5=255,Xct=1/e5;function Yct(e){const t=new Oi;t.fragment.include(nd),t.fragment.include(Os),t.include(vX),t.include(G0);const{pass:i}=e;if(i===Un.Visualize){const{visualization:r,bandsEnabled:s}=e;t.fragment.constants.add("inverseSampleValue","float",e5),t.fragment.uniforms.add("shadowCastMap","sampler2D"),t.fragment.uniforms.add("sampleScale","float"),t.fragment.uniforms.add("opacityFromElevation","float");const n=r===Nm.Gradient,o=r===Nm.Threshold;t.fragment.uniforms.add("uColor","vec4"),n?s&&t.fragment.uniforms.add("bandSize","float"):o&&t.fragment.uniforms.add("threshold","float"),t.fragment.code.add(x`
      void main(void) {
        vec4 record = texture2D(shadowCastMap, uv);
        float pixelSamples = record.r * inverseSampleValue;

        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${o?x`
            if (strength <= threshold) {
              discard;
            }`:""}

        ${n&&s?x`strength = ceil(strength / bandSize) * bandSize;`:""}

        gl_FragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${n?x`* strength`:""});
      }
    `)}else i!==Un.Accumulate&&i!==Un.VisualizeCurrent||(t.include(Lm),t.fragment.uniforms.add("depthMap","sampler2D"),t.fragment.uniforms.add("inverseViewMatrix","mat4"),t.fragment.uniforms.add("nearFar","vec2"),i===Un.Accumulate?t.fragment.constants.add("sampleValue","float",Xct):t.fragment.constants.add("shadowColor","vec4",[0,0,0,.8]),t.fragment.code.add(x`
      void main(void) {

        float depth = rgba2float(texture2D(depthMap, uv));
        // 0.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
        if (depth == 0.0) {
          discard;
        }

        float currentPixelDepth = linearDepthFromFloat(depth, nearFar);

        if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
          discard;
        }

        vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
        vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;

        mat4 shadowMatrix;
        float linearDepth = -currentPixelDepth;
        int i = chooseCascade(linearDepth, shadowMatrix);

        if (i >= numCascades) {
          discard;
        }

        vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);

        // vertex completely outside? -> no shadow
        if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
          discard;
        }

        vec2 uvShadow = cascadeCoordinates(i, lvpos);

        float depthShadow = readShadowMapDepth(uvShadow, shadowMapTex);
        bool shadow = depthShadow < lvpos.z;

        if (!shadow) {
          discard;
        }

        gl_FragColor = ${i===Un.Accumulate?x`vec4(sampleValue)`:x`shadowColor`};
      }
    `));return t}const Zct=Object.freeze({__proto__:null,get ShadowCastPass(){return Un},get ShadowCastVisualization(){return Nm},shadowCastMaxSamples:e5,build:Yct});class YO extends Gi{constructor(t,i){super(t,i,()=>this.destroy())}initializeProgram(t){const i=YO.shader.get().build(this.configuration);return new Mi(t.rctx,i,mi)}initializePipeline(t){switch(this.configuration.pass){case Un.Accumulate:return Ot({blending:Xn(Ee.ONE,Ee.ONE,Ee.ONE,Ee.ONE),colorWrite:Ft,depthTest:null,depthWrite:null});case Un.Visualize:case Un.VisualizeCurrent:return Ot({blending:gl,colorWrite:Ft,depthTest:null,depthWrite:null})}return Ot({})}bindPass(t){if(this.configuration.pass===Un.Accumulate||this.configuration.pass===Un.VisualizeCurrent){const i=t;this.program.bindTexture(i.linearDepthTexture,"depthMap"),i.shadowMap.bind(this.program),i.shadowMap.bindView(this.program,i.camera.center),this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniformMatrix4fv("inverseViewMatrix",i.inverseViewMatrix),this.program.setUniform4fv("projInfo",i.projInfo),this.program.setUniform2fv("zScale",i.zScale)}else if(this.configuration.pass===Un.Visualize){const i=t;if(this.program.bindTexture(i.shadowCastMap,"shadowCastMap"),this.program.setUniform1f("sampleScale",i.sampleScale),this.program.setUniform1f("opacityFromElevation",i.opacityFromElevation),this.program.setUniform4fv("uColor",i.color),this.configuration.visualization===Nm.Gradient&&this.configuration.bandsEnabled){const r=t;this.program.setUniform1f("bandSize",r.bandSize)}else if(this.configuration.visualization===Nm.Threshold){const r=t;this.program.setUniform1f("threshold",r.threshold)}}}get primitiveType(){return Tt.TRIANGLE_STRIP}}YO.shader=new Ni(Zct,()=>import("./ShadowCast.glsl.a8d87e3f.js"));class CC extends mr{constructor(){super(...arguments),this.pass=Un.Accumulate,this.visualization=Nm.Gradient,this.bandsEnabled=!1}}u([Z({count:Un.COUNT})],CC.prototype,"pass",void 0),u([Z()],CC.prototype,"visualization",void 0),u([Z()],CC.prototype,"bandsEnabled",void 0);const Qct=yi(.01,0,.25,1),Jct=4e4,Kct=5e4,lbe=1/512;let B$=class extends we{constructor(e,t,i,r){super({}),this._techniqueRepository=e,this._rctx=t,this._shadowAccumulator=i,this._requestRender=r,this._visualizationParams={shadowCastMap:this._shadowCastTexture,sampleScale:0,color:Qct,threshold:.5,bandSize:.1,opacityFromElevation:1},this._techniqueConfig=new CC,this._enabled=!1,this._vao=bo(t),this._techniqueConfig.pass=Un.Visualize,this._techniqueConfig.visualization=Nm.Gradient}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=tt(this._vao),this._techniqueRepository.release(this._technique),this._technique=null,this._shadowAccumulator=null}get visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire(YO,this._techniqueConfig,this._technique),this._technique}render(){if(!this._isRenderingVisualization)return;this._sampleScale=1/this._computedSamples,this._rctx.bindVAO(this._vao);const e=this.visualizeShadowCastTechnique;this._rctx.useTechnique(e),e.bindPass(this._visualizationParams),this._rctx.drawArrays(e.primitiveType,0,vn(this._vao,"geometry"))}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.color!==void 0&&this._setColor(e.color),e.threshold!==void 0&&(this._threshold=e.threshold),e.visualization!==void 0&&(this._visualization=e.visualization),e.bandSize!==void 0&&(this._bandSize=e.bandSize),e.bandsEnabled!==void 0&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._visualizationParams.opacityFromElevation}set opacityFromElevation(e){this._visualizationParams.opacityFromElevation!==e&&(this._visualizationParams.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _isRenderingVisualization(){return this._enabled&&this._computedSamples>0&&this.opacityFromElevation>lbe}get _computedSamples(){return this._shadowAccumulator.computedSamples}get _shadowCastTexture(){return this._shadowAccumulator.shadowCastTexture}get _sampleScale(){return this._visualizationParams.sampleScale}set _sampleScale(e){this._visualizationParams.sampleScale=e}get _threshold(){return this._visualizationParams.threshold}set _threshold(e){this._threshold!==e&&(this._visualizationParams.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._visualizationParams.bandSize}set _bandSize(e){e!==this._bandSize&&(this._visualizationParams.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(e){const t=this._visualizationParams.color;g1(e,t)||(_a(this._visualizationParams.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};u([d()],B$.prototype,"opacityFromElevation",null),B$=u([P("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],B$);class eut{constructor(){this.camera=new wi,this.lightMat=Te()}}class cbe{constructor(t,i,r=0){this.rctx=t,this.viewingMode=i,this._enabled=!1,this._snapshots=new Array,this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let s=0;s<4;++s)this.cascades.push(new eut);this.snapshotCount=r}dispose(){this._discardDepthTexture(),this._discardAllSnapshots()}set maxCascades(t){this.maxNumCascades=Be(Math.floor(t),1,4)}get maxCascades(){return this.maxNumCascades}set enabled(t){this._enabled=t,t||(this._discardDepthTexture(),this._discardAllSnapshots())}get enabled(){return this._enabled}get snapshotCount(){return this._snapshots.length}set snapshotCount(t){const i=this._snapshots.length;if(t>i){const r=t-i;this._snapshots.length=t;for(let s=0;s<r;++s)this._snapshots[i+s]=null}else if(t<this.snapshotCount){const r=i-t;for(let s=0;s<r;++s)this._discardSnapshot(t+s);this._snapshots.length=t}}getSnapshot(t){return this.enabled?this._snapshots[t]:null}getCascades(){for(let t=0;t<this.numCascades;++t)Lz[t]=this.cascades[t];return Lz.length=this.numCascades,Lz}start(t,i,r){at(this.enabled),this.textureSize=this._computeTextureSize(t.fullWidth,t.fullHeight),this._ensureDepthTexture();const{near:s,far:n}=this._clampNearFar(r);this._computeCascadeDistances(n,s),this._setupMatrices(t,i);const o=t.viewMatrix,a=t.projectionMatrix;for(let l=0;l<this.numCascades;++l)this._constructCascade(l,a,o,i);this.lastOrigin=null,this.clear()}finish(t){at(this.enabled),this.rctx.bindFramebuffer(t)}bind(t){this.enabled?(this._depthTextureUnit=t.bindTexture(this._depthTexture,"shadowMapTex"),t.setUniform1f("depthHalfPixelSz",.5/this.textureSize),t.setUniform1i("numCascades",this.numCascades),t.setUniform4f("cascadeDistances",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)):t.setUniform1f("depthHalfPixelSz",-1)}bindView(t,i){if(!this.enabled)return;const r=this.lastOrigin;if(!(r&&r[0]===i[0]&&r[1]===i[1]&&r[2]===i[2])){this.lastOrigin=this.lastOrigin||M(),ne(this.lastOrigin,i);for(let s=0;s<this.numCascades;++s){Wo(kse,this.cascades[s].lightMat,i);for(let n=0;n<16;++n)zse[16*s+n]=kse[n]}}t.setUniformMatrix4fv("shadowMapMatrix",zse)}takeCascadeSnapshotTo(t,i){at(this.enabled),this._ensureSnapshot(i),this._bindFbo();const r=this.rctx,s=r.bindTexture(this._snapshots[i],Qe.TEXTURE_UNIT_FOR_UPDATES);r.gl.copyTexSubImage2D(st.TEXTURE_2D,0,t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[2],t.camera.viewport[3]),r.bindTexture(s,Qe.TEXTURE_UNIT_FOR_UPDATES)}clear(){const t=this.rctx;this._bindFbo(),t.setClearColor(1,1,1,1),t.clearSafe(bi.COLOR_BUFFER_BIT|bi.DEPTH_BUFFER_BIT)}_computeTextureSize(t,i){const r=.5*Math.log(t*t+i*i)*Math.LOG2E,s=.35,n=2**Math.round(r+s);return Math.min(this.maxTextureSize,2*n)}_ensureDepthTexture(){if(this._depthTexture!=null&&this._depthTexture.descriptor.width===this.textureSize)return;this._discardDepthTexture();const t={target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE,samplingMode:Ge.NEAREST,flipped:!0,width:this.textureSize,height:this.textureSize};this._depthTexture=new Qe(this.rctx,t),this.fbo=new zi(this.rctx,{colorTarget:vr.TEXTURE,depthStencilTarget:ti.DEPTH_RENDER_BUFFER,width:this.textureSize,height:this.textureSize},this._depthTexture)}_ensureSnapshot(t){const i=this._snapshots[t];if(_(i)&&i.descriptor.width===this.textureSize)return;this._discardSnapshot(t);const r={target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE,samplingMode:Ge.NEAREST,flipped:!0,width:this.textureSize,height:this.textureSize};this._snapshots[t]=new Qe(this.rctx,r)}_discardDepthTexture(){this.fbo=tt(this.fbo),this._depthTexture=tt(this._depthTexture)}_discardSnapshot(t){this._snapshots[t]=tt(this._snapshots[t])}_discardAllSnapshots(){for(let t=0;t<this.snapshotCount;++t)this._discardSnapshot(t)}_bindFbo(){const t=this.rctx;_(this._depthTextureUnit)&&(t.bindTexture(null,this._depthTextureUnit),this._depthTextureUnit=null),t.bindFramebuffer(this.fbo)}_constructCascade(t,i,r,s){const n=this.cascades[t],o=-this.cascadeDistances[t],a=-this.cascadeDistances[t+1],l=(i[10]*o+i[14])/Math.abs(i[11]*o+i[15]),c=(i[10]*a+i[14])/Math.abs(i[11]*a+i[15]);at(l<c);for(let p=0;p<8;++p){Ho($se,p%4==0||p%4==3?-1:1,p%4==0||p%4==1?-1:1,p<4?l:c,1),Ou(qa[p],$se,Ise);for(let f=0;f<3;++f)qa[p][f]/=qa[p][3]}mo(Dz,qa[0]),Wo(Mse,Use,Dz),n.camera.viewMatrix=Mse;for(let p=0;p<8;++p)ke(qa[p],qa[p],n.camera.viewMatrix);ne(Ed,qa[0]),ne(Ad,qa[0]);for(let p=1;p<8;++p)for(let f=0;f<3;++f)Ed[f]=Math.min(Ed[f],qa[p][f]),Ad[f]=Math.max(Ad[f],qa[p][f]);Ed[2]-=200,Ad[2]+=200,n.camera.near=-Ad[2],n.camera.far=-Ed[2],this.warp?this._constructTrapezoidalProjection(r,s,n):this._constructOrthogonalProjection(n),dr(n.lightMat,n.camera.projectionMatrix,n.camera.viewMatrix);const h=this.textureSize/2;n.camera.viewport[0]=t%2==0?0:h,n.camera.viewport[1]=Math.floor(t/2)===0?0:h,n.camera.viewport[2]=h,n.camera.viewport[3]=h}_constructOrthogonalProjection(t){Cj(t.camera.projectionMatrix,Ed[0],Ad[0],Ed[1],Ad[1],t.camera.near,t.camera.far)}_constructTrapezoidalProjection(t,i,r){const s=1/qa[0][3],n=1/qa[4][3];at(s<n);let o=s+Math.sqrt(s*n);const a=Math.sin(Rs(t[2]*i[0]+t[6]*i[1]+t[10]*i[2]));o/=a,iut(qa,o,a,Dse,Lse,tut,Nse,Fse),rut(Dse,Lse,Nse,Fse,r.camera.projectionMatrix),r.camera.projectionMatrix[10]=2/(Ed[2]-Ad[2]),r.camera.projectionMatrix[14]=-(Ed[2]+Ad[2])/(Ed[2]-Ad[2])}_setupMatrices(t,i){dr(Pse,t.projectionMatrix,t.viewMatrix),fr(Ise,Pse);const r=this.viewingMode===Ie.Global?t.eye:oe(Dz,0,0,1);sF(Use,[0,0,0],[-i[0],-i[1],-i[2]],r)}_clampNearFar(t){let{near:i,far:r}=t;return i<2&&(i=2),r<2&&(r=2),i>=r&&(i=2,r=4),{near:i,far:r}}_computeCascadeDistances(t,i){this.numCascades=Math.min(1+Math.floor(G9e(t/i,4)),this.maxNumCascades);const r=(t-i)/this.numCascades,s=(t/i)**(1/this.numCascades);let n=i,o=i;for(let a=0;a<this.numCascades+1;++a)this.cascadeDistances[a]=qt(n,o,this.splitSchemeLambda),n*=s,o+=r}get gpuMemoryUsage(){var t,i;return this._snapshots.reduce((r,s)=>r+c0(s),(t=(i=this.fbo)==null?void 0:i.gpuMemoryUsage)!=null?t:0)}get test(){const t=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,depthTexture:this._depthTexture,set splitSchemeLambda(i){t.splitSchemeLambda=i},get splitSchemeLambda(){return t.splitSchemeLambda},set warp(i){t.warp=i},get warp(){return t.warp}}}}const Mse=Te(),Pse=Te(),Ise=Te(),$se=ni(),qa=[];for(let e=0;e<8;++e)qa.push(ni());const Ed=M(),Ad=M(),Dse=Ye(),Lse=Ye(),tut=Ye(),Nse=Ye(),Fse=Ye(),Use=Te(),Dz=M(),Lz=[],kse=Te(),zse=new Float32Array(64),Ll=Ye(),pw=Ye(),Ov=[Ye(),Ye(),Ye(),Ye()],Ds=Ye(),Nz=Ye(),$g=Ye(),gE=Ye(),fw=Ye(),mw=Ye(),kP=Ye();function iut(e,t,i,r,s,n,o,a){rr(Ll,0,0);for(let C=0;C<4;++C)Mh(Ll,Ll,e[C]);nl(Ll,Ll,.25),rr(pw,0,0);for(let C=4;C<8;++C)Mh(pw,pw,e[C]);nl(pw,pw,.25),ix(Ov[0],e[4],e[5],.5),ix(Ov[1],e[5],e[6],.5),ix(Ov[2],e[6],e[7],.5),ix(Ov[3],e[7],e[4],.5);let l=0,c=_L(Ov[0],Ll);for(let C=1;C<4;++C){const O=_L(Ov[C],Ll);O<c&&(c=O,l=C)}lp(Ds,Ov[l],e[l+4]);const h=Ds[0];let p,f;Ds[0]=-Ds[1],Ds[1]=h,lp(Nz,pw,Ll),gs(Nz,Ds)<0&&hq(Ds,Ds),ix(Ds,Ds,Nz,i),oR(Ds,Ds),p=f=gs(lp($g,e[0],Ll),Ds);for(let C=1;C<8;++C){const O=gs(lp($g,e[C],Ll),Ds);O<p?p=O:O>f&&(f=O)}zs(r,Ll),nl($g,Ds,p-t),Mh(r,r,$g);let g=-1,y=1,v=0,b=0;for(let C=0;C<8;++C){lp(gE,e[C],r),oR(gE,gE);const O=Ds[0]*gE[1]-Ds[1]*gE[0];O>0?O>g&&(g=O,v=C):O<y&&(y=O,b=C)}$b(g>0,"leftArea"),$b(y<0,"rightArea"),nl(fw,Ds,p),Mh(fw,fw,Ll),nl(mw,Ds,f),Mh(mw,mw,Ll),kP[0]=-Ds[1],kP[1]=Ds[0];const w=s3(r,e[b],mw,Mh($g,mw,kP),1,s),S=s3(r,e[v],mw,$g,1,n),T=s3(r,e[v],fw,Mh($g,fw,kP),1,o),A=s3(r,e[b],fw,$g,1,a);$b(w,"rayRay"),$b(S,"rayRay"),$b(T,"rayRay"),$b(A,"rayRay")}function Yt(e,t){return 3*t+e}const Bse=Ye();function Fa(e,t){return rr(Bse,e[t],e[t+3]),Bse}const ea=Ye(),We=wr();function rut(e,t,i,r,s){lp(ea,i,r),nl(ea,ea,.5),We[0]=ea[0],We[1]=ea[1],We[2]=0,We[3]=ea[1],We[4]=-ea[0],We[5]=0,We[6]=ea[0]*ea[0]+ea[1]*ea[1],We[7]=ea[0]*ea[1]-ea[1]*ea[0],We[8]=1,We[Yt(0,2)]=-gs(Fa(We,0),e),We[Yt(1,2)]=-gs(Fa(We,1),e);let n=gs(Fa(We,0),i)+We[Yt(0,2)],o=gs(Fa(We,1),i)+We[Yt(1,2)],a=gs(Fa(We,0),r)+We[Yt(0,2)],l=gs(Fa(We,1),r)+We[Yt(1,2)];n=-(n+a)/(o+l),We[Yt(0,0)]+=We[Yt(1,0)]*n,We[Yt(0,1)]+=We[Yt(1,1)]*n,We[Yt(0,2)]+=We[Yt(1,2)]*n,n=1/(gs(Fa(We,0),i)+We[Yt(0,2)]),o=1/(gs(Fa(We,1),i)+We[Yt(1,2)]),We[Yt(0,0)]*=n,We[Yt(0,1)]*=n,We[Yt(0,2)]*=n,We[Yt(1,0)]*=o,We[Yt(1,1)]*=o,We[Yt(1,2)]*=o,We[Yt(2,0)]=We[Yt(1,0)],We[Yt(2,1)]=We[Yt(1,1)],We[Yt(2,2)]=We[Yt(1,2)],We[Yt(1,2)]+=1,n=gs(Fa(We,1),t)+We[Yt(1,2)],o=gs(Fa(We,2),t)+We[Yt(2,2)],a=gs(Fa(We,1),i)+We[Yt(1,2)],l=gs(Fa(We,2),i)+We[Yt(2,2)],n=-.5*(n/o+a/l),We[Yt(1,0)]+=We[Yt(2,0)]*n,We[Yt(1,1)]+=We[Yt(2,1)]*n,We[Yt(1,2)]+=We[Yt(2,2)]*n,n=gs(Fa(We,1),t)+We[Yt(1,2)],o=gs(Fa(We,2),t)+We[Yt(2,2)],a=-o/n,We[Yt(1,0)]*=a,We[Yt(1,1)]*=a,We[Yt(1,2)]*=a,s[0]=We[0],s[1]=We[1],s[2]=0,s[3]=We[2],s[4]=We[3],s[5]=We[4],s[6]=0,s[7]=We[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=We[6],s[13]=We[7],s[14]=0,s[15]=We[8]}var $A;let no=$A=class extends we{constructor(e,t,i,r,s,n){super({}),this._rctx=e,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=s,this._requestRender=n,this._progress=0,this._sampleCount=0,this._cachedCamera=new wi,this._contentCamera=new wi,this._enabled=!1,this._cachedLightDirections=[],this._depthRange=OG,this._previewing=!1,this._handles=new Ut,this._cameraForcedForScreenshot=!1,this._shadowMap=new cbe(e,i.viewingMode),this._shadowMap.enabled=!0,this._vao=bo(e);const o={colorTarget:vr.TEXTURE,depthStencilTarget:ti.NONE,width:0,height:0},a={target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.LINEAR,wrapMode:ct.CLAMP_TO_EDGE,width:0,height:0};this._fbo=new zi(e,o,a),this._accumulationParams={camera:this._cachedCamera,linearDepthTexture:null,shadowMap:this._shadowMap,inverseViewMatrix:Te(),projInfo:ni(),zScale:Ye()},this._accumulationRenderer=new B$(t,e,this,n);const l=this._stage.resourceController.scheduler;this._handles.add(l.registerTask(ht.SHADOW_ACCUMULATOR,this)),this._handles.add(Nt(()=>i.renderView,c=>{this._handles.remove($A.renderViewHandleKey),R(c)||this._handles.add(c.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),$A.renderViewHandleKey)},rc))}normalizeCtorArgs(){return{}}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get accumulationTechnique(){if(R(this._accumulationTechnique)){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode},t=new CC;t.pass=Un.Accumulate,this._accumulationTechnique=new YO(e,t)}return this._accumulationTechnique}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabled&&this._sampleCount>0}get _canAccumulate(){return this._accumulationParams.linearDepthTexture!==null&&this._depthRange!==OG&&this._opacityFromElevation>lbe}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if(y1(t,e,bT))return;const i=e.length;t.length=i,this._sampleCount=Math.min(e5,i);for(let r=0;r<i;++r){const s=e[r],n=t[r]||M();ne(n,s),t[r]=n}this._invalidate()}get _projInfo(){return this._accumulationParams.projInfo}get _zScale(){return this._accumulationParams.zScale}get _inverseView(){return this._accumulationParams.inverseViewMatrix}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this._canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._cachedCamera,this._contentCamera);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}accumulateFixedSamples(){if(!this.isAccumulating||!this._canAccumulate)return;(this._previewing||this._progress===0||this._cameraForcedForScreenshot)&&this._clear();const e=this._cameraForcedForScreenshot?this._sampleCount:Math.min($A.previewSamples,this._sampleCount-this._progress);for(let t=0;t<e;++t)this._accumulateShadow();this._cameraForcedForScreenshot=!1}render(){this._accumulationRenderer.render()}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=tt(this._accumulationRenderer),this._shadowMap=tt(this._shadowMap),this._fbo=tt(this._fbo),this._vao=tt(this._vao),this._accumulationTechnique=Xi(this._accumulationTechnique),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.previewing!==void 0&&this.setPreviewing(e.previewing),e.lightDirections!==void 0&&this.setLightDirections(e.lightDirections),this._accumulationRenderer.setOptions(e)}setPreviewing(e){this._previewing!==e&&(this._previewing=e,this._requestRenderIfEnabled())}setLightDirections(e){this._lightDirections=e}setAccumulationDependencies(e,t,i,r){this._accumulationParams.linearDepthTexture=e,this._depthRange=t,this._updateCamera(i),this._contentCamera=r,this.notifyChange("_canAccumulate")}readAccumulatedShadow(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;const i=sut;return this._fbo.readPixels(e,t,1,1,$e.RGBA,yt.UNSIGNED_BYTE,i),i[0]/this._progress}_start(){this._progress=0,this._enabled=!0}_stop(){this._enabled=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(bi.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){const e=this._lightDirections[this._progress],t=this._cachedCamera;this._renderToShadowMap(this._shadowMap,e,t,this._depthRange),this._rctx.bindFramebuffer(this._fbo);const i=this.accumulationTechnique;this._rctx.useTechnique(i),i.bindPass(this._accumulationParams),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,vn(this._vao,"geometry")),this._progress++}_updateCamera(e){if(e.equals(this._cachedCamera))return;const{fullWidth:t,fullHeight:i,projectionMatrix:r,viewMatrix:s,center:n}=e;this._cachedCamera.copyFrom(e),this._fbo.resize(t,i),Pq(r,t,i,this._projInfo,this._zScale),Wo(this._inverseView,s,n),fr(this._inverseView,this._inverseView),this._opacityFromElevation=1-TT(Jct,Kct,e.relativeElevation)}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}get test(){return{lightDirections:this._lightDirections,isDone:()=>this._isDoneAccumulating,isActive:()=>this._isActive}}};no.previewSamples=6,no.renderViewHandleKey="renderView",u([d()],no.prototype,"_progress",void 0),u([d()],no.prototype,"_sampleCount",void 0),u([d()],no.prototype,"_enabled",void 0),u([d()],no.prototype,"_depthRange",void 0),u([d()],no.prototype,"_previewing",void 0),u([d()],no.prototype,"_accumulationRenderer",void 0),u([d()],no.prototype,"_isRefining",null),u([d()],no.prototype,"_isActive",null),u([d()],no.prototype,"_canAccumulate",null),u([d()],no.prototype,"_isDoneAccumulating",null),u([d()],no.prototype,"_opacityFromElevation",null),u([d()],no.prototype,"running",null),no=$A=u([P("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],no);const sut=new Uint8Array(4);function nut(e){const t=new Oi;return t.include(Lm),t.fragment.include(nd),t.fragment.include(Os),t.include(vX),t.include(G0),t.fragment.uniforms.add("defaultDepthTex","sampler2D").add("highlightDepthTex","sampler2D").add("depthMap","sampler2D").add("highlightMap","sampler2D").add("uColor","vec4").add("nearFar","vec2").add("opacity","float").add("occludedOpacity","float").add("terminationFactor","float").add("inverseViewMatrix","mat4").add("lightingMainDirectionView","vec3").add("texelSize","vec2"),t.fragment.constants.add("unoccludedHighlightFlag","vec4",N0e).add("highlightedThreshold","float",e.highlightedThreshold).add("selfShadowThreshold","float",e.selfShadowThreshold),t.fragment.code.add(x`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),t.fragment.code.add(x`void main(void) {
vec4 highlightInfo = texture2D(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float differenceOpacity = opacity;
float bothOpacity = occludedOpacity;
float fragOpacity = (shadowDefault || shaded) ? bothOpacity : differenceOpacity;
gl_FragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
}`),t}const out=Object.freeze({__proto__:null,build:nut}),ube=0,hbe=1;class t5 extends Gi{constructor(t){super(t,null,()=>this.destroy())}initializeProgram(t){const i=t5.shader.get().build({highlightedThreshold:.99999,selfShadowThreshold:.025});return new Mi(t.rctx,i,mi)}initializePipeline(t){return Ot({blending:Xn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Ft,depthTest:null,depthWrite:null})}bindPass(t,i){if(R(i.linearDepthTexture))return;this.program.bindTexture(i.linearDepthTexture,"depthMap"),this.program.bindTexture(i.highlightColorTexture,"highlightMap"),ke(zP,i.lighting.lightingMainDirection,i.camera.viewInverseTransposeMatrix),be(zP,zP),Pq(i.camera.projectionMatrix,i.camera.fullWidth,i.camera.fullHeight,Gse,Vse),Wo(BP,i.camera.viewMatrix,i.camera.center),fr(BP,BP),this.program.setUniform4fv("uColor",t.shadowColor),this.program.setUniform1f("opacity",t.shadowOpacity),this.program.setUniform1f("occludedOpacity",t.occludedShadowOpacity),this.program.setUniform1f("terminationFactor",t.opacityElevation*t.dayNightTerminator),this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniformMatrix4fv("inverseViewMatrix",BP),this.program.setUniform4fv("projInfo",Gse),this.program.setUniform2fv("zScale",Vse),this.program.setUniform3fv("lightingMainDirectionView",zP),this.program.setUniform2f("texelSize",1/i.linearDepthTexture.descriptor.width,1/i.linearDepthTexture.descriptor.height),i.shadowMap.bind(this.program),i.shadowMap.bindView(this.program,i.camera.center);let r=i.shadowMap.getSnapshot(ube);_(r)&&this.program.bindTexture(r,"highlightDepthTex"),r=i.shadowMap.getSnapshot(hbe),_(r)&&this.program.bindTexture(r,"defaultDepthTex")}get primitiveType(){return Tt.TRIANGLE_STRIP}}t5.shader=new Ni(out,()=>import("./ShadowHighlight.glsl.3da1538c.js"));const zP=M(),Vse=Ye(),Gse=ni(),BP=Te(),aut=.001953125,lut=4e4,cut=5e4;class uut{constructor(t,i){this._rctx=t,this._viewingMode=i,this._maxOpacity=1,this._parameters={shadowColor:Ca(1,0,1,1),shadowOpacity:.2,occludedShadowOpacity:.1,opacityElevation:1,dayNightTerminator:1},this._vao=bo(this._rctx)}get technique(){return R(this._technique)&&(this._technique=new t5({rctx:this._rctx,viewingMode:this._viewingMode})),this._technique}render(t,i){if(!t.shadowMap.enabled||!t.linearDepthTexture||!this.isVisible)return;const r=this.technique;this._rctx.bindFramebuffer(i),this._rctx.useTechnique(r),r.bindPass(this._parameters,t),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(r.primitiveType,0,vn(this._vao,"geometry"))}get gpuMemoryUsage(){var t,i;return(t=(i=this._vao)==null?void 0:i.size)!=null?t:0}setDefaultOptions(t){this._parameters=I(I({},this._parameters),t),this._updateMaxOpacity()}updateParameters(t,i){this._parameters.opacityElevation=1-TT(lut,cut,t.relativeElevation);const r=this._viewingMode===Ie.Global?be(jse,t.center):oe(jse,0,0,1),s=_e(r,i);this._parameters.dayNightTerminator=TT(0,1,Be(30*s,0,1))}dispose(){this._vao=tt(this._vao),this._technique=Xi(this._technique)}get isVisible(){const{opacityElevation:t,dayNightTerminator:i}=this._parameters;return this._maxOpacity*t*i>=aut}_updateMaxOpacity(){const t=this._parameters,i=t.shadowColor,r=Math.max(t.shadowOpacity,t.occludedShadowOpacity);this._maxOpacity=r*i[3]}}const jse=M(),Fz=pb();class hut{constructor(){this._worldPlane=Fz}get isEnabled(){return this.plane!==Fz}get plane(){return this._worldPlane}set plane(t){this._worldPlane=t||Fz}}var Wh;function dut(e){const t=new Oi;return e.output===Wh.EdgeDetector&&(t.attributes.add(E.POSITION,"vec2"),t.vertex.uniforms.add("resolution","vec4"),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[3]","vec4"),t.vertex.code.add(x`void SMAAEdgeDetectionVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
fOffset[1] = texcoord.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
fOffset[2] = texcoord.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAAEdgeDetectionVS( fTexCoord );
}`),t.fragment.uniforms.add("tColor","sampler2D"),t.fragment.code.add(x`
      vec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {
        vec2 threshold = vec2( ${x.float(e.threshold)} );

        // Calculate color deltas:
        vec4 delta;
        vec3 C = texture2D( colorTex, texcoord ).rgb;

        vec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;
        vec3 t = abs( C - Cleft );
        delta.x = max( max( t.r, t.g ), t.b );

        vec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;
        t = abs( C - Ctop );
        delta.y = max( max( t.r, t.g ), t.b );

        // We do the usual threshold:
        vec2 edges = step( threshold, delta.xy );

        // Then discard if there is no edge:
        if ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )
            discard;

        // Calculate right and bottom deltas:
        vec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;
        t = abs( C - Cright );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;
        t = abs( C - Cbottom );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the maximum delta in the direct neighborhood:
        float maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );

        // Calculate left-left and top-top deltas:
        vec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;
        t = abs( C - Cleftleft );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;
        t = abs( C - Ctoptop );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the final maximum delta:
        maxDelta = max( max( maxDelta, delta.z ), delta.w );

        // Local contrast adaptation in action:
        edges.xy *= step( maxDelta, float(${x.float(e.localConstrastAdaption)}) * delta.xy );

        return vec4( edges, 0.0, 0.0 );
      }

      void main() {
        gl_FragColor = SMAAColorEdgeDetectionPS( fTexCoord, fOffset, tColor );
      }
    `)),e.output===Wh.BlendWeight&&(t.attributes.add(E.POSITION,"vec2"),t.vertex.uniforms.add("resolution","vec4"),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[3]","vec4"),t.varyings.add("fPixCoord","vec2"),t.vertex.code.add(x`
      void SMAABlendingWeightCalculationVS( vec2 texcoord ) {
        fPixCoord = texcoord * resolution.zw;
        fOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        fOffset[1] = texcoord.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        fOffset[2] = vec4( fOffset[0].xz, fOffset[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( ${x.int(e.maxSearchSteps)} );
      }

      void main() {
        fTexCoord = (position + 1.0 ) * 0.5;
        gl_Position = vec4(position, 0, 1);
        SMAABlendingWeightCalculationVS( fTexCoord );
      }
    `),t.fragment.uniforms.add("tEdges","sampler2D").add("tArea","sampler2D").add("tSearch","sampler2D").add("tColor","sampler2D").add("resolution","vec4"),t.fragment.code.add(x`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 SMAASampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset) {
        return texture2D( tex, coord + offset.x * resolution.xy, 0.0 );
      }

      vec2 round( vec2 x ) {
        return sign( x ) * floor( abs( x ) + 0.5 );
      }

      float SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {
        e.r = bias + e.r * scale;
        return 255.0 * texture2D( searchTex, e, 0.0 ).r;
      }

      float SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${x.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * resolution.x;
        texcoord.x += resolution.x;
        texcoord.x += 2.0 * resolution.x;
        texcoord.x -= resolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${x.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * resolution.x;
        texcoord.x -= resolution.x;
        texcoord.x -= 2.0 * resolution.x;
        texcoord.x += resolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${x.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * resolution.y;
        texcoord.y -= resolution.y;
        texcoord.y -= 2.0 * resolution.y;
        texcoord.y += resolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${x.int(e.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * resolution.y;
        texcoord.y += resolution.y;
        texcoord.y += 2.0 * resolution.y;
        texcoord.y -= resolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${x.int(e.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture2D( areaTex, texcoord, 0.0 ).rg;
      }

      vec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {
        vec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );
        vec2 e = texture2D( edgesTex, texcoord ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );
          coords.y = offset[ 1 ].y;
          d.x = coords.x;
          float e1 = texture2D( edgesTex, coords, 0.0 ).r;
          coords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );
          d.y = coords.x;
          d = d * resolution.z - pixcoord.x;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * resolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );
          coords.x = offset[ 0 ].x;
          d.x = coords.y;
          float e1 = texture2D( edgesTex, coords, 0.0 ).g;
          coords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );
          d.y = coords.y;
          d = d * resolution.w - pixcoord.y;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * resolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 0.0, 1.0 ) ).g;
          weights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offset[ 0 ]+offset[ 1 ]+offset[ 2 ] + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0,1,0,1),dbg);
        }
        return weights;
      }

      void main() {
        gl_FragColor = SMAABlendingWeightCalculationPS( fTexCoord, fPixCoord, fOffset, tEdges, tArea, tSearch, ivec4( 0.0 ) );
      }
    `)),e.output===Wh.Blur&&(t.attributes.add(E.POSITION,"vec2"),t.vertex.uniforms.add("resolution","vec4"),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[2]","vec4"),t.vertex.code.add(x`void SMAANeighborhoodBlendingVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
fOffset[1] = texcoord.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAANeighborhoodBlendingVS(fTexCoord);
}`),t.fragment.uniforms.add("tBlendWeights","sampler2D"),t.fragment.uniforms.add("tColor","sampler2D"),t.fragment.uniforms.add("resolution","vec4"),t.fragment.code.add(x`vec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {
vec4 a;
a.xz = texture2D( blendTex, texcoord ).xz;
a.y = texture2D( blendTex, offset[ 1 ].zw ).g;
a.w = texture2D( blendTex, offset[ 1 ].xy ).a;
if ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {
return texture2D( colorTex, texcoord, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture2D( colorTex, texcoord, 0.0 );
texcoord += sign( offset ) * resolution.xy;
vec4 Cop = texture2D( colorTex, texcoord, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
vec4 mixed = mix(C, Cop, s);
return mixed;
}
}
void main() {
gl_FragColor = SMAANeighborhoodBlendingPS( fTexCoord, fOffset, tColor, tBlendWeights );
}`)),t}(function(e){e[e.EdgeDetector=0]="EdgeDetector",e[e.BlendWeight=1]="BlendWeight",e[e.Blur=2]="Blur",e[e.COUNT=3]="COUNT"})(Wh||(Wh={}));const put=Object.freeze({__proto__:null,get SMAAOutput(){return Wh},build:dut});class i5 extends Gi{initializeProgram(t){const i=i5.shader.get(),r=this.configuration,s=i.build({output:r.output,threshold:.05,localConstrastAdaption:2,maxSearchSteps:8,maxDistanceAreaTex:16});return new Mi(t.rctx,s,mi)}initializePipeline(){return Ot({colorWrite:Ft})}}i5.shader=new Ni(put,()=>import("./SMAA.glsl.dbf8f775.js"));class dbe extends mr{constructor(){super(...arguments),this.output=Wh.EdgeDetector}}u([Z({count:Wh.COUNT})],dbe.prototype,"output",void 0);let DA=class extends we{constructor(e,t){super({}),this.rctx=e,this._techniqueRep=t,this._isEnabled=!1}normalizeCtorArgs(){return{}}dispose(){this._abortController=Iu(this._abortController),this.disable()}_loadResources(e){if(_(this._abortController))return!1;if(_(this._searchTexture))return!0;this._abortController=new AbortController;const t=this._abortController.signal;return import("./SmaaRenderPassData.69c5bfba.js").then(i=>this._loadTextures(i,t)).then(()=>e()).finally(()=>this._abortController=null),!1}_loadTextures(e,t){return Qt(t),Promise.all([this._loadTextureFromBase64(e.areaTexture,Ge.LINEAR,$e.RGB),this._loadTextureFromBase64(e.searchTexure,Ge.NEAREST,$e.LUMINANCE)]).then(([i,r])=>{Us(t)?(i.dispose(),r.dispose(),Qt(t)):(this._areaTexture=i,this._searchTexture=r)})}get updating(){return _(this._abortController)}enable(e){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeightsTechnique||!this._blurTechnique){const t=new dbe,i=(r,s)=>this._techniqueRep.releaseAndAcquire(i5,r,s);t.output=Wh.EdgeDetector,this._edgeDetectTechnique=i(t,this._edgeDetectTechnique),t.output=Wh.BlendWeight,this._blendWeightsTechnique=i(t,this._blendWeightsTechnique),t.output=Wh.Blur,this._blurTechnique=i(t,this._blurTechnique)}return!!this._loadResources(e)&&(this._vao=x8e(this.rctx),this._edges=new zi(this.rctx,{colorTarget:vr.TEXTURE,depthStencilTarget:ti.NONE},{target:st.TEXTURE_2D,pixelFormat:$e.RGB,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.LINEAR,wrapMode:ct.CLAMP_TO_EDGE,width:4,height:4}),this._blend=new zi(this.rctx,{colorTarget:vr.TEXTURE,depthStencilTarget:ti.NONE},{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.LINEAR,wrapMode:ct.CLAMP_TO_EDGE,width:4,height:4}),this._isEnabled=!0,!0)}disable(){this._isEnabled&&(this._vao=tt(this._vao),this._areaTexture=tt(this._areaTexture),this._searchTexture=tt(this._searchTexture),this._blend=tt(this._blend),this._edges=tt(this._edges),this._isEnabled=!1)}render(e){if(!this._isEnabled)return;const t=this.rctx,i=t.getBoundFramebufferObject(),r={x:0,y:0,width:e.descriptor.width,height:e.descriptor.height};t.bindVAO(this._vao),t.setViewport(r.x,r.y,r.width,r.height),this._edges.resize(r.width,r.height),t.bindFramebuffer(this._edges),t.setClearColor(0,0,0,1),t.clear(bi.COLOR_BUFFER_BIT);const s=t.useTechnique(this._edgeDetectTechnique);s.bindTexture(e,"tColor"),s.setUniform4f("resolution",1/r.width,1/r.height,r.width,r.height),t.drawArrays(Tt.TRIANGLES,0,3),this._blend.resize(r.width,r.height),t.bindFramebuffer(this._blend),t.setClearColor(0,0,1,1),t.clear(bi.COLOR_BUFFER_BIT);const n=t.useTechnique(this._blendWeightsTechnique);n.setUniform4f("resolution",1/r.width,1/r.height,r.width,r.height),n.bindTexture(this._searchTexture,"tSearch"),n.bindTexture(this._areaTexture,"tArea"),n.bindTexture(this._edges.colorTexture,"tEdges"),t.drawArrays(Tt.TRIANGLES,0,3),t.bindFramebuffer(i),t.setClearColor(0,1,0,1),t.clear(bi.COLOR_BUFFER_BIT);const o=t.useTechnique(this._blurTechnique);o.setUniform4f("resolution",1/r.width,1/r.height,r.width,r.height),o.bindTexture(e,"tColor"),o.bindTexture(this._blend.colorTexture,"tBlendWeights"),t.drawArrays(Tt.TRIANGLES,0,3)}_loadTextureFromBase64(e,t,i){const r=new Qe(this.rctx,{pixelFormat:i,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.CLAMP_TO_EDGE,samplingMode:t},null);return Fu(e).then(s=>(r.resize(s.width,s.height),r.setData(s),r))}};u([d()],DA.prototype,"_abortController",void 0),u([d({readOnly:!0})],DA.prototype,"updating",null),DA=u([P("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],DA);var Fm;function fut(e){const t=new Oi;return t.include(G0),e.output===Fm.Blur&&(t.fragment.include(Os),t.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("tex","sampler2D").add("blurSize","vec2").add("projScale","float").add("nearFar","vec2"),t.fragment.code.add(x`
      void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {
        float c = texture2D(tex, uv).r;
        float d = linearDepthFromTexture(depthMap, uv, nearFar);

        float ddiff = d - center_d;

        float w = exp(-r * r * ${x.float(e.blurFalloff)} - ddiff * ddiff * sharpness);
        wTotal += w;
        bTotal += w * c;
      }
    `),t.fragment.code.add(x`
      void main(void) {
        float b = 0.0;
        float w_total = 0.0;

        float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

        float sharpness = -0.05 * projScale/center_d;
        for (int r = -${x.int(e.filterRadius)}; r <= ${x.int(e.filterRadius)}; ++r) {
          float rf = float(r);
          vec2 uvOffset = uv + rf * blurSize;
          blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);
        }

        gl_FragColor = vec4(b / w_total);
      }
    `)),e.output===Fm.SSAO&&(t.fragment.include(Os),t.include(vX),t.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("intensity","float").add("projScale","float").add("radius","float").add("nearFar","vec2").add("screenDimensions","vec2").add("rnmScale","vec2").add("rnm","sampler2D"),t.fragment.code.add(x`vec3 sphere[16];
void fillSphere() {
sphere[0] = vec3(0.186937, 0.0, 0.0);
sphere[1] = vec3(0.700542, 0.0, 0.0);
sphere[2] = vec3(-0.864858, -0.481795, -0.111713);
sphere[3] = vec3(-0.624773, 0.102853, -0.730153);
sphere[4] = vec3(-0.387172, 0.260319, 0.007229);
sphere[5] = vec3(-0.222367, -0.642631, -0.707697);
sphere[6] = vec3(-0.01336, -0.014956, 0.169662);
sphere[7] = vec3(0.122575, 0.1544, -0.456944);
sphere[8] = vec3(-0.177141, 0.85997, -0.42346);
sphere[9] = vec3(-0.131631, 0.814545, 0.524355);
sphere[10] = vec3(-0.779469, 0.007991, 0.624833);
sphere[11] = vec3(0.308092, 0.209288,0.35969);
sphere[12] = vec3(0.359331, -0.184533, -0.377458);
sphere[13] = vec3(0.192633, -0.482999, -0.065284);
sphere[14] = vec3(0.233538, 0.293706, -0.055139);
sphere[15] = vec3(0.417709, -0.386701, 0.442449);
}
float fallOffFunction(float vv, float vn, float bias) {
float f = max(radius * radius - vv, 0.0);
return f * f * f * max(vn-bias, 0.0);
}`),t.fragment.code.add(x`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),t.fragment.code.add(x`
      void main(void) {
        fillSphere();
        vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));
        float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);

        if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
          gl_FragColor = vec4(0.0);
          return;
        }

        vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);

        // get the normal of current fragment
        vec4 norm4 = texture2D(normalMap, uv);
        vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;
        bool isTerrain = norm4.w<0.5;

        float sum = .0;
        vec3 tapPixelPos;

        // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
        // bug or deviation from CE somewhere else?
        float ps = projScale/(2.0 * currentPixelPos.z * zScale.x + zScale.y);

        for(int i = 0; i < ${x.int(e.samples)}; ++i) {
          vec2 unitOffset = reflect(sphere[i], fres).xy;
          vec2 offset = vec2(-unitOffset * radius * ps);

          //don't use current or very nearby samples
          if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;

          vec2 tc = vec2(gl_FragCoord.xy + offset);
          if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenDimensions.x || tc.y > screenDimensions.y) continue;
          vec2 tcTap = tc/screenDimensions;
          float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);

          if (isTerrain) {
            bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;
            if (isTerrainTap) {
              continue;
            }
          }

          tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

          sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
        }

        // output the result
        float A = max(1.0-sum*intensity/float(${x.int(e.samples)}),0.0);

        // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4)/2.2
        A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;
        gl_FragColor = vec4(A);
      }
    `)),t}(function(e){e[e.SSAO=0]="SSAO",e[e.Blur=1]="Blur",e[e.COUNT=2]="COUNT"})(Fm||(Fm={}));const mut=Object.freeze({__proto__:null,get SSAOOutput(){return Fm},build:fut});class dp extends Gi{initializeProgram(t){const i=dp.shader.get(),r=this.configuration,s=(dp.filterRadius+1)/2,n=1/(2*s*s),o=i.build({output:r.output,samples:dp.samples,filterRadius:dp.filterRadius,blurFalloff:n});return new Mi(t.rctx,o,mi)}initializePipeline(){return Ot({colorWrite:Ft})}}dp.shader=new Ni(mut,()=>import("./SSAO.glsl.3d2027ee.js")),dp.samples=16,dp.filterRadius=4;class pbe extends mr{constructor(){super(...arguments),this.output=Fm.SSAO}}u([Z({count:Fm.COUNT})],pbe.prototype,"output",void 0);class gut{constructor(t,i,r){this._techniqueRep=t,this._rctx=i,this._requestRender=r,this._enabled=!1,this._ssaoTechniqueConfig=new pbe,this.quadVAO=null,this._blurSizePx=2,this._attenuation=.5}dispose(){this.quadVAO=tt(this.quadVAO)}disposeOffscreenBuffers(){po(this._ssaoFBO,t=>t.resize(0,0)),po(this._blur0FBO,t=>t.resize(0,0)),po(this._blur1FBO,t=>t.resize(0,0))}set enabled(t){t?this._enable():this._disable()}get enabled(){return this._enabled}get ready(){return this.enabled&&_(this._noiseTexture)&&_(this._ssaoFBO)&&_(this._blur0FBO)&&_(this._blur1FBO)}computeSSAO(t,i,r){if(!this.enabled||R(i)||R(r)||R(this._noiseTexture)||R(this._ssaoFBO)||R(this._blur0FBO)||R(this._blur1FBO))return;const s=this._rctx,n=t.fullViewport,o=n[2],a=n[3],l=o/this._blurSizePx,c=a/this._blurSizePx;this._ssaoFBO.resize(o,a),this._blur0FBO.resize(l,c),this._blur1FBO.resize(l,c);const h=1,p=1,f=o*h,g=a*p;s.bindFramebuffer(this._ssaoFBO),s.setViewport(0,0,o,a);const y=s.useTechnique(this._ssaoTechnique);y.setUniform2f("rnmScale",o/this._noiseTexture.descriptor.width,a/this._noiseTexture.descriptor.height),Pq(t.projectionMatrix,t.fullWidth,t.fullHeight,qse,Hse),y.setUniform4fv("projInfo",qse),y.setUniform2fv("zScale",Hse),y.setUniform2fv("nearFar",t.nearFar);let v=1/t.computeRenderPixelSizeAtDist(1);y.setUniform1f("projScale",v*h),y.setUniform2f("screenDimensions",f,g);const b=xi(t.eye,t.center);let w=20*t.computeRenderPixelSizeAtDist(b);w=Math.max(.1,w),y.setUniform1f("radius",w),y.setUniform1f("intensity",4*this._attenuation/w**6),y.bindTexture(this._noiseTexture,"rnm"),y.bindTexture(r,"normalMap"),y.bindTexture(i,"depthMap"),R(this.quadVAO)&&(this.quadVAO=bo(this._rctx)),s.bindVAO(this.quadVAO),s.drawArrays(Tt.TRIANGLE_STRIP,0,vn(this.quadVAO,"geometry"));const S=s.useTechnique(this._blurTechnique);S.bindTexture(this._ssaoFBO.colorTexture,"tex"),S.bindTexture(r,"normalMap"),S.bindTexture(i,"depthMap"),s.setViewport(0,0,f/this._blurSizePx,g/this._blurSizePx),s.bindFramebuffer(this._blur0FBO),S.setUniform2f("screenDimensions",f,g),S.setUniform2f("blurSize",0,this._blurSizePx*h/g),S.setUniform2fv("nearFar",t.nearFar),b>5e4&&(v=Math.max(0,v-(b-5e4))),S.setUniform1f("projScale",v),s.drawArrays(Tt.TRIANGLE_STRIP,0,vn(this.quadVAO,"geometry")),S.setUniform2f("blurSize",this._blurSizePx*p/f,0),s.bindFramebuffer(this._blur1FBO),S.bindTexture(this._blur0FBO.colorTexture,"tex"),s.drawArrays(Tt.TRIANGLE_STRIP,0,vn(this.quadVAO,"geometry")),s.setViewport(n[0],n[1],n[2],n[3])}bind(t,i){this.enabled&&_(this._blur1FBO)&&_(this._ssaoFBO)?(t.bindTexture(this._blur1FBO.colorTexture,"ssaoTex"),t.setUniform4f("viewportPixelSz",i.fullViewport[0],i.fullViewport[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):t.setUniform4f("viewportPixelSz",-1,-1,-1,-1)}_selectPrograms(){this._ssaoTechniqueConfig.output=Fm.SSAO,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(dp,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=Fm.Blur,this._blurTechnique=this._techniqueRep.releaseAndAcquire(dp,this._ssaoTechniqueConfig,this._blurTechnique)}_enable(){this.enabled||(this._enabled=!0,this._loadResources(()=>{this._enabled&&this._initialize()}))}_loadResources(t){this._data?t():import("./SSAOHelperData.256ae0c1.js").then(i=>{this._data=i,t()})}_initialize(){const t={target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.LINEAR,wrapMode:ct.CLAMP_TO_EDGE,width:0,height:0},i={colorTarget:vr.TEXTURE,depthStencilTarget:ti.NONE};Fu(this._data.noiseTexture).then(r=>{this._enabled&&(this._ssaoFBO=new zi(this._rctx,i,t),this._blur0FBO=new zi(this._rctx,i,t),this._blur1FBO=new zi(this._rctx,i,t),this._noiseTexture=new Qe(this._rctx,{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,hasMipmap:!0,width:r.width,height:r.height},r),this._requestRender())}),this._selectPrograms()}_disable(){this._enabled=!1,this._noiseTexture=tt(this._noiseTexture),this._blur1FBO=tt(this._blur1FBO),this._blur0FBO=tt(this._blur0FBO),this._ssaoFBO=tt(this._ssaoFBO)}get gpuMemoryUsage(){return(_(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(_(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(_(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}const Hse=Ye(),qse=ni();function yut(e,t){const i=t,r=-e[0],s=-e[1],n=-e[2],o=i[3],a=i[7],l=i[11],c=i[15];i[0]+=o*r,i[1]+=o*s,i[2]+=o*n,i[4]+=a*r,i[5]+=a*s,i[6]+=a*n,i[8]+=l*r,i[9]+=l*s,i[10]+=l*n,i[12]+=c*r,i[13]+=c*s,i[14]+=c*n}function vut(e,t){const i=t,r=e[0],s=e[1],n=e[2];i[12]+=r*i[0]+s*i[4]+n*i[8],i[13]+=r*i[1]+s*i[5]+n*i[9],i[14]+=r*i[2]+s*i[6]+n*i[10],i[14]+=r*i[3]+s*i[7]+n*i[11]}class _ut{constructor(t){this.factory=t,this.originData=new Map}acquire(t){return this.register(this.factory.getOrigin(t))}register(t){const i=this.originData.get(t.id);return i?(i.refCount++,i.origin):(this.originData.set(t.id,{refCount:1,viewMatrix:Te(),origin:t}),t)}release(t){const i=this.originData.get(t.id);i&&(i.refCount--,i.refCount===0&&this.originData.delete(t.id))}updateViewMatrices(t){this.originData.forEach(i=>{Ur(i.viewMatrix,t),vut(i.origin.vec3,i.viewMatrix)})}getViewMatrix(t){return this.originData.get(t.id).viewMatrix}}const cN=kr().vec3f(E.POSITION).u16(E.COMPONENTINDEX).u16(E.U16PADDING),fbe=kr().vec2u8(E.SIDENESS),Wse=Rl(fbe),mbe=kr().vec3f(E.POSITION0).vec3f(E.POSITION1).u16(E.COMPONENTINDEX).u8(E.VARIANTOFFSET,{glNormalized:!0}).u8(E.VARIANTSTROKE).u8(E.VARIANTEXTENSION,{glNormalized:!0}).u8(E.U8PADDING,{glPadding:!0}).u16(E.U16PADDING,{glPadding:!0}),DG=mbe.clone().vec3f(E.NORMAL),LG=mbe.clone().vec3f(E.NORMALA).vec3f(E.NORMALB),NG=new Map([[E.POSITION0,0],[E.POSITION1,1],[E.COMPONENTINDEX,2],[E.VARIANTOFFSET,3],[E.VARIANTSTROKE,4],[E.VARIANTEXTENSION,5],[E.NORMAL,6],[E.NORMALA,6],[E.NORMALB,7],[E.SIDENESS,8]]);class gbe{updateSettings(t){this.settings=t,this.edgeHashFunction=t.reducedPrecision?wut:but}write(t,i,r){const s=this.edgeHashFunction(r);GP.seed=s;const n=GP.getIntRange(0,255),o=GP.getIntRange(0,this.settings.variants-1),a=.7,l=GP.getFloat(),c=255*(.5*xut(-(1-Math.min(l/a,1))+Math.max(0,l-a)/(1-a),1.2)+.5);t.position0.setVec(i,r.position0),t.position1.setVec(i,r.position1),t.componentIndex.set(i,r.componentIndex),t.variantOffset.set(i,n),t.variantStroke.set(i,o),t.variantExtension.set(i,c)}trim(t,i){return t.slice(0,i)}}const _X=new Float32Array(6),uN=new Uint32Array(_X.buffer),i0=new Uint32Array(1);function but(e){const t=_X;t[0]=e.position0[0],t[1]=e.position0[1],t[2]=e.position0[2],t[3]=e.position1[0],t[4]=e.position1[1],t[5]=e.position1[2],i0[0]=5381;for(let i=0;i<uN.length;i++)i0[0]=31*i0[0]+uN[i];return i0[0]}function wut(e){const t=_X;t[0]=gw(e.position0[0]),t[1]=gw(e.position0[1]),t[2]=gw(e.position0[2]),t[3]=gw(e.position1[0]),t[4]=gw(e.position1[1]),t[5]=gw(e.position1[2]),i0[0]=5381;for(let i=0;i<uN.length;i++)i0[0]=31*i0[0]+uN[i];return i0[0]}const Xse=1e4;function gw(e){return Math.round(e*Xse)/Xse}function xut(e,t){const i=e<0?-1:1;return Math.abs(e)**t*i}class hN{constructor(){this.commonWriter=new gbe}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return DG.createBuffer(t)}write(t,i,r){this.commonWriter.write(t,i,r),pe(VP,r.faceNormal0,r.faceNormal1),be(VP,VP),t.normal.setVec(i,VP)}trim(t,i){return this.commonWriter.trim(t,i)}}hN.Layout=DG,hN.glLayout=Rl(DG,1);class dN{constructor(){this.commonWriter=new gbe}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return LG.createBuffer(t)}write(t,i,r){this.commonWriter.write(t,i,r),t.normalA.setVec(i,r.faceNormal0),t.normalB.setVec(i,r.faceNormal1)}trim(t,i){return this.commonWriter.trim(t,i)}}dN.Layout=LG,dN.glLayout=Rl(LG,1);const VP=M(),GP=new fu,b_=-1;var pN;function Tut(e,t,i,r=Out){const s=e.vertices.position,n=e.vertices.componentIndex,o=Rt(r.anglePlanar),a=Rt(r.angleSignificantEdge),l=Math.cos(a),c=Math.cos(o),h=FG.edge,p=h.position0,f=h.position1,g=h.faceNormal0,y=h.faceNormal1,v=Rut(e),b=Cut(e),w=b.length/4,S=t.allocate(w);let T=0;const A=w,C=i.allocate(A);let O=0,L=0,U=0;const N=qxe(0,w),z=new Float32Array(w);Zxe(z,(te,ie,$)=>{s.getVec(b[4*ie+0],p),s.getVec(b[4*ie+1],f),$[ie]=xi(p,f)}),N.sort((te,ie)=>z[ie]-z[te]);const V=new Array,B=new Array;for(let te=0;te<w;te++){const ie=N[te],$=z[ie],F=b[4*ie+0],k=b[4*ie+1],G=b[4*ie+2],W=b[4*ie+3],K=W===b_;if(s.getVec(F,p),s.getVec(k,f),K)oe(g,v[3*G+0],v[3*G+1],v[3*G+2]),ne(y,g),h.componentIndex=n.get(F),h.cosAngle=_e(g,y);else{if(oe(g,v[3*G+0],v[3*G+1],v[3*G+2]),oe(y,v[3*W+0],v[3*W+1],v[3*W+2]),h.componentIndex=n.get(F),h.cosAngle=_e(g,y),Eut(h,c))continue;h.cosAngle<-.9999&&ne(y,g)}L+=$,U++,K||Sut(h,l)?(t.write(S,T++,h),V.push($)):Aut(h,o)&&(i.write(C,O++,h),B.push($))}const J=new Float32Array(V.reverse()),Q=new Float32Array(B.reverse());return{regular:{instancesData:t.trim(S,T),lodInfo:{lengths:J}},silhouette:{instancesData:i.trim(C,O),lodInfo:{lengths:Q}},averageEdgeLength:L/U}}function Sut(e,t){return e.cosAngle<t}function Eut(e,t){return e.cosAngle>t}function Aut(e,t){const i=Rs(e.cosAngle),r=FG.fwd,s=FG.ortho;return Um(r,e.position1,e.position0),i*(_e(pt(s,e.faceNormal0,e.faceNormal1),r)>0?-1:1)>t}function Cut(e){const t=e.faces.length/3,i=e.faces,r=e.neighbors;let s=0;for(let a=0;a<t;a++){const l=r[3*a+0],c=r[3*a+1],h=r[3*a+2],p=i[3*a+0],f=i[3*a+1],g=i[3*a+2];s+=l===b_||p<f?1:0,s+=c===b_||f<g?1:0,s+=h===b_||g<p?1:0}const n=new Int32Array(4*s);let o=0;for(let a=0;a<t;a++){const l=r[3*a+0],c=r[3*a+1],h=r[3*a+2],p=i[3*a+0],f=i[3*a+1],g=i[3*a+2];(l===b_||p<f)&&(n[o++]=p,n[o++]=f,n[o++]=a,n[o++]=l),(c===b_||f<g)&&(n[o++]=f,n[o++]=g,n[o++]=a,n[o++]=c),(h===b_||g<p)&&(n[o++]=g,n[o++]=p,n[o++]=a,n[o++]=h)}return n}function Rut(e){const t=e.faces.length/3,i=e.vertices.position,r=e.faces,s=Uz.v0,n=Uz.v1,o=Uz.v2,a=new Float32Array(3*t);for(let l=0;l<t;l++){const c=r[3*l+0],h=r[3*l+1],p=r[3*l+2];i.getVec(c,s),i.getVec(h,n),i.getVec(p,o),de(n,n,s),de(o,o,s),pt(s,n,o),be(s,s),a[3*l+0]=s[0],a[3*l+1]=s[1],a[3*l+2]=s[2]}return a}(function(e){e[e.SOLID=0]="SOLID",e[e.SKETCH=1]="SKETCH"})(pN||(pN={}));const FG={edge:{position0:M(),position1:M(),faceNormal0:M(),faceNormal1:M(),componentIndex:0,cosAngle:0},ortho:M(),fwd:M()},Uz={v0:M(),v1:M(),v2:M()},Out={anglePlanar:4,angleSignificantEdge:35};function Mut(e){const t=x`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;e.code.add(t)}function Put(e,t){e.vertex.include(Mut),e.include(cT,t);const i=e.vertex;i.uniforms.add("depthBias","vec2"),i.uniforms.add("inverseViewport","vec2"),t.legacy?(i.uniforms.add("view","mat4"),i.uniforms.add("proj","mat4")):i.uniforms.add("transformNormalViewFromGlobal","mat3"),t.legacy?i.code.add(x`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
float offsetZ  = depthBias.y;
vec4 projNormal = proj * view * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`):i.code.add(x`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
float offsetZ  = depthBias.y;
vec4 projNormal = transformProjFromView * vec4(transformNormalViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`),i.code.add(x`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = depthBias.y;
return sqrt(max(projPos.z,0.0)) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function Iut(e,t){const i=e.fragment;i.constants.add("coverageTestThreshold","float",.01),t.antialiasing?i.code.add(x`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):i.code.add(x`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`)}function $ut(e,t){const i=e.vertex;t.silhouette?(i.code.add(x`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),t.legacy?i.code.add(x`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):i.code.add(x`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):i.code.add(x`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`)}function ybe(e,t){const i=e.vertex;i.uniforms.add("distanceFalloffFactor","float"),i.code.add(x`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(distanceFalloffFactor / distance), 0.0, 1.0);
}`),i.uniforms.add("componentDataTex","sampler2D"),i.uniforms.add("componentDataTexInvDim","vec2"),e.attributes.add(E.COMPONENTINDEX,"float"),i.constants.add("componentColorFieldOffset","float",0),i.constants.add("componentOtherFieldOffset","float",1),i.constants.add("componentFieldCount","float",2),i.constants.add("lineWidthFractionFactor","float",8),i.constants.add("extensionLengthOffset","float",128),i.constants.add("componentTexWidth","float",4096),i.code.add(x`vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
float fieldIndex = componentFieldCount * componentIndex + fieldOffset;
float rowIndex = floor(fieldIndex / componentTexWidth);
float colIndex = mod(fieldIndex, componentTexWidth);
vec2 linearIndex = vec2(
(colIndex + 0.5) / componentTexWidth,
(rowIndex + 0.5) * componentDataTexInvDim.y
);
return linearIndex;
}
struct ComponentData {
vec4 color;
float lineWidth;
float extensionLength;
float type;
};
ComponentData readComponentData() {
vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
vec4 colorValue = texture2D(componentDataTex, colorIndex);
vec4 otherValue = texture2D(componentDataTex, otherIndex);
return ComponentData(
vec4(colorValue.rgb, colorValue.a * otherValue.w),
otherValue.x * (255.0 / lineWidthFractionFactor),
otherValue.y * 255.0 - extensionLengthOffset,
-(otherValue.z * 255.0) + 0.5
);
}`),t.legacy?i.code.add(x`vec3 _modelToWorldNormal(vec3 normal) {
return (model * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (view * model * vec4(normal, 0.0)).xyz;
}`):(i.uniforms.add("transformNormalGlobalFromModel","mat3"),i.code.add(x`vec3 _modelToWorldNormal(vec3 normal) {
return transformNormalGlobalFromModel * normal;
}`)),t.silhouette?(e.attributes.add(E.NORMALA,"vec3"),e.attributes.add(E.NORMALB,"vec3"),i.code.add(x`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(e.attributes.add(E.NORMAL,"vec3"),i.code.add(x`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),t.legacy?i.code.add(x`vec3 worldFromModelPosition(vec3 position) {
return (model * vec4(position, 1.0)).xyz;
}
vec3 viewFromModelPosition(vec3 position) {
return (view * vec4(worldFromModelPosition(position), 1.0)).xyz;
}
vec4 projFromViewPosition(vec3 position) {
return proj * vec4(position, 1.0);
}`):(e.vertex.include(NW,t),i.code.add(x`vec3 worldFromModelPosition(vec3 position) {
vec3 rotatedModelPosition = transformWorldFromModelRS * position;
vec3 transform_CameraRelativeFromModel = dpAdd(
transformWorldFromModelTL,
transformWorldFromModelTH,
-transformWorldFromViewTL,
-transformWorldFromViewTH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}
vec3 viewFromModelPosition(vec3 position) {
return transformViewFromCameraRelativeRS * worldFromModelPosition(position);
}
vec4 projFromViewPosition(vec3 position) {
return transformProjFromView * vec4(position, 1.0);
}`)),i.code.add(x`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}function vbe(e){return e.mode===as.SKETCH||e.mode===as.MIXED}var as;(function(e){e[e.SOLID=0]="SOLID",e[e.SKETCH=1]="SKETCH",e[e.MIXED=2]="MIXED",e[e.COUNT=3]="COUNT"})(as||(as={}));function Dut(e,t){const i=e.vertex;switch(t.mode){case as.SKETCH:i.code.add(x`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case as.MIXED:i.code.add(x`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (unpackedAttributes.type <= 0.0 && lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case as.SOLID:i.code.add(x`#define discardShortEdges(unpackedAttributes, lineLengthPixels) {}`)}}function bX(e,t){const i=e.vertex;switch(e.include(ybe,t),e.attributes.add(E.SIDENESS,"vec2"),t.mode===as.MIXED?i.code.add(x`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):i.code.add(x`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),t.mode){case as.MIXED:i.code.add(x`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case as.SKETCH:i.code.add(x`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case as.SOLID:i.code.add(x`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case as.COUNT:break;default:t.mode}}function Lut(e,t){const i=e.vertex;switch(e.include(bX,t),vbe(t)&&i.uniforms.add("strokesAmplitude","float"),t.mode){case as.SOLID:i.code.add(x`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case as.SKETCH:i.code.add(x`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return strokesAmplitude;
}`);break;case as.MIXED:i.code.add(x`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return strokesAmplitude;
}
else {
return 0.0;
}
}`)}}function Nut(e,t){const i=e.vertex;e.include(bX,t);const r=e.fragment;switch(vbe(t)&&(i.uniforms.add("strokesTextureScale","vec2"),i.uniforms.add("strokesLog2Resolution","float"),i.uniforms.add("strokeVariants","float"),e.varyings.add("vStrokeUV","vec2"),r.uniforms.add("strokesTexture","sampler2D"),r.uniforms.add("strokesNormalizationScale","float"),i.code.add(x`void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
float lineIndex = clamp(ceil(log2(lineLength)), 0.0, strokesLog2Resolution);
vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * strokeVariants + variantStroke + 0.5) * strokesTextureScale;
vStrokeUV.x += variantOffset;
}`),e.fragment.include(nd),r.code.add(x`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture2D(strokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * strokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture2D(strokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),t.mode){case as.SOLID:i.code.add(x`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),r.code.add(x`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case as.SKETCH:i.code.add(x`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),r.code.add(x`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case as.MIXED:e.varyings.add("vType","float"),i.code.add(x`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),r.code.add(x`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}function Fut(e){const t=new Oi,i=t.vertex,r=t.fragment;return e.legacy&&i.uniforms.add("model","mat4"),e.antialiasing&&(i.code.add(x`#define ANTIALIASING 1`),r.code.add(x`#define ANTIALIASING 1`)),t.include(Put,e),t.include(Lut,e),t.include(ybe,e),t.include(bX,e),t.include(Nut,e),t.include(Or,e),t.include($ut,e),t.include(Iut,e),t.include(Dut,e),t.varyings.add("vColor","vec4"),t.varyings.add("vRadius","float"),t.varyings.add("vPosition","vec3"),t.varyings.add("vWorldPosition","vec3"),t.varyings.add("vViewPos","vec3"),t.varyings.add("vLineLengthPixels","float"),t.varyings.add("vSizeFalloffFactor","float"),i.uniforms.add("pixelToNDC","vec2"),i.uniforms.add("ndcToPixel","vec2"),i.uniforms.add("pixelRatio","float"),t.attributes.add(E.POSITION0,"vec3"),t.attributes.add(E.POSITION1,"vec3"),t.attributes.add(E.VARIANTOFFSET,"float"),t.attributes.add(E.VARIANTSTROKE,"float"),t.attributes.add(E.VARIANTEXTENSION,"float"),i.code.add(x`const float opaqueCutoff = 1.0 / 255.0;
void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
vec2 sideness = unpackedAttributes.sideness;
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;
vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
vViewPos = viewPos;
vec4 projPosV0 = projFromViewPosition(viewPosV0);
vec4 projPosV1 = projFromViewPosition(viewPosV1);
vec4 projPos = projFromViewPosition(viewPos);
vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * ndcToPixel;
float lineLengthPixels = length(screenSpaceLinePixels);
float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;
float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * pixelRatio;
float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;
float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * pixelRatio;
vSizeFalloffFactor = falloffFactor;
float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;
#ifdef ANTIALIASING
const float aaPaddingPixels = 1.0;
float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;
#else
float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;
#endif
vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * pixelToNDC;
vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * pixelToNDC;
vec2 extensionLengthNDC = extensionLengthPixels * pixelToNDC;
vec2 ndcOffset = (
screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
+ perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
);
projPos.xy += ndcOffset * projPos.w;
projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;
projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));
float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;
float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;
vPosition = vec3(
halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
pixelPositionAlongLine,
pixelPositionAlongLine / extendedLineLengthPixels
);
vRadius = lineWidthPixels * 0.5;
vLineLengthPixels = extendedLineLengthPixels;
discardShortEdges(unpackedAttributes, lineLengthPixels);
gl_Position = projPos;
}
void main() {
ComponentData component = readComponentData();
UnpackedAttributes unpackedAttributes = unpackAttributes(component);
vec3 worldPosV0 = worldFromModelPosition(position0);
vec3 worldPosV1 = worldFromModelPosition(position1);
vec3 viewPosV0 = viewFromModelPosition(position0);
vec3 viewPosV1 = viewFromModelPosition(position1);
vColor = component.color;
if (vColor.a < opaqueCutoff) {
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return;
}
if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
return;
}
calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);
calculateStyleOutputs(unpackedAttributes);
}`),e.multipassTerrainEnabled&&(t.fragment.include(Os),t.include(Ec,e)),t.fragment.code.add(x`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float lineOffset = calculateLineOffset();
      float positionX = position.x - lineOffset;

      if (radius < 1.0) {
        // Handle this specifically for subpixel sizes:
        // 1. Compute correct coverage (note coverage is computed by
        //    0.5 - dist, so we make sure that that will lead to correct
        //    subpixel coverage
        // 2. Ignore rounded caps
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);

        float coverage = min(coverageX, coverageY);

        return vec2(0.5 - coverage, 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      float alpha = vColor.a * coverage;

      gl_FragColor = vec4(vColor.rgb, alpha);

    }
  `),t}const Uut=Object.freeze({__proto__:null,build:Fut}),kut=-4e-4,zut=.5;class YR extends Gi{bindPass(t){const i=this.program,{edgeRenderParameters:r,bindParameters:s}=t;p_e(i,r.viewProjectionTransform),i.setUniformMatrix3fv("transformNormalViewFromGlobal",r.transformNormalViewFromGlobal),i.setUniformMatrix4fv("proj",s.camera.projectionMatrix),i.setUniform2f("depthBias",zut,kut),i.setUniform2f("pixelToNDC",2/s.camera.fullViewport[2],2/s.camera.fullViewport[3]),i.setUniform2f("ndcToPixel",s.camera.fullViewport[2]/2,s.camera.fullViewport[3]/2),i.setUniform1f("distanceFalloffFactor",r.distanceFalloffFactor),i.setUniform2f("inverseViewport",1/s.camera.fullViewport[2],1/s.camera.fullViewport[3]),i.setUniform1f("pixelRatio",s.camera.pixelRatio||1)}initializeProgram(t){const i=YR.shader.get(),r=this.configuration,s=i.build({slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,silhouette:r.silhouette,legacy:r.legacy,antialiasing:r.antialiasing,mode:r.mode,doublePrecisionRequiresObfuscation:r.doublePrecisionRequiresObfuscation,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Mi(t.rctx,s,NG)}initializePipeline(t){const i=t.rctx.capabilities.blendMinMax;return Ot(i?{blending:Xn(Ee.ONE,Ee.ONE,Ee.ZERO,Ee.ONE,Cp.ADD,i.MAX),depthTest:{func:Li.LEQUAL},colorWrite:Ft}:{depthTest:{func:Li.LEQUAL},depthWrite:Ma,colorWrite:Ft})}}YR.shader=new Ni(Uut,()=>import("./EdgeShaderProgram.glsl.959a62c8.js"));class Vf extends mr{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.mode=as.SOLID,this.doublePrecisionRequiresObfuscation=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}u([Z()],Vf.prototype,"slicePlaneEnabled",void 0),u([Z()],Vf.prototype,"silhouette",void 0),u([Z()],Vf.prototype,"legacy",void 0),u([Z()],Vf.prototype,"antialiasing",void 0),u([Z({count:as.COUNT})],Vf.prototype,"mode",void 0),u([Z()],Vf.prototype,"doublePrecisionRequiresObfuscation",void 0),u([Z()],Vf.prototype,"multipassTerrainEnabled",void 0),u([Z()],Vf.prototype,"cullAboveGround",void 0);const But=8,kz=128,Vut={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};class Gut{constructor(){this._value=0}get value(){return this._value}increment(){this._value++}decrement(){this._value--}}const jut={solid:as.SOLID,sketch:as.SKETCH,uber:as.MIXED};class RC{constructor(t,i,r){this.rctx=t,this.shaderTechniqueRepository=i,this.config=new Vf,this.technique=null,this.refCount=new Gut,this.renderables=new Set,this.sortedRenderables={[Ct.TRANSPARENT]:{[Ct.TRANSPARENT]:new $t,[Ct.OPAQUE]:new $t},[Ct.OPAQUE]:{[Ct.TRANSPARENT]:new $t,[Ct.OPAQUE]:new $t}},this.renderablesDirty=!1,this.settings=I(I({},Vut),r),this.key=RC.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);const s=this.settings.strokesTexture.variants;this.writerSettings={variants:s,reducedPrecision:hi.TESTS_DISABLE_OPTIMIZATIONS},this.config.legacy=this.settings.legacy,this.config.mode=jut[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=S4(t)}dispose(){this.technique=Xi(this.technique)}addRenderable(t){this.renderables.add(t),this.renderablesDirty=!0}removeRenderable(t){this.renderables.delete(t),this.renderablesDirty=!0}setRenderablesDirty(){this.renderablesDirty=!0}forEachRenderable(t,i){this.renderablesDirty&&this._sortRenderables(),this.sortedRenderables[i][Ct.TRANSPARENT].forAll(t),this.sortedRenderables[i][Ct.OPAQUE].forAll(t)}setMultipassParameters(t){this.config.multipassTerrainEnabled=!!t.multipassTerrainEnabled&&t.multipassTerrainEnabled,this.config.cullAboveGround=!!t.cullAboveGround&&t.cullAboveGround}bindRegularEdges(t,i){this.setMultipassParameters(t),this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(YR,this.config,this.technique),this.rctx.useTechnique(this.technique,t.slot),this.technique.bindPass({bindParameters:t,edgeRenderParameters:i})}bindSilhouetteEdges(t,i){this.setMultipassParameters(t),this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(YR,this.config,this.technique),this.rctx.useTechnique(this.technique,t.slot),this.technique.bindPass({bindParameters:t,edgeRenderParameters:i})}renderRegularEdges(t,i,r){this._render(t,t.regular.vao,i,r)}renderSilhouetteEdges(t,i,r){this._render(t,t.silhouette.vao,i,r)}_render(t,i,r,s){this._setUniforms(t,r),this.rctx.bindVAO(i),this.rctx.capabilities.instancing.drawArraysInstanced(Tt.TRIANGLE_FAN,0,4,s)}_setUniforms(t,i){const r=this.technique.program;if(t.components.buffer.textureBuffer.bind(r,Hut,qut),i.multipassTerrainEnabled&&(r.setUniform2fv("nearFar",i.camera.nearFar),r.setUniform2fv("inverseViewport",i.inverseViewport),Jm(r,i)),"origin"in t.transform)r.setUniformMatrix4fv("view",i.localViewMatrixForEdges),r.setUniformMatrix4fv("model",t.transform.modelMatrix),I0(r,this.settings,i.slicePlane,{origin:t.transform.origin.vec3});else{const s=new K4(t.transform.position),n=Nu(Yse,k1(Yse,t.transform.rotationScale)),o=new sbe;ne(o.transformWorldFromModelTL,s.low),ne(o.transformWorldFromModelTH,s.high),hR(o.transformWorldFromModelRS,t.transform.rotationScale),hR(o.transformNormalGlobalFromModel,n),d_e(r,o),r.setUniformMatrix3fv("transformNormalGlobalFromModel",o.transformNormalGlobalFromModel);const a=i.camera.viewInverseTransposeMatrix,l=oe(Wut,a[3],a[7],a[11]);I0(r,this.settings,i.slicePlane,{origin:l})}this.settings.type!=="uber"&&this.settings.type!=="sketch"||this._setSketchUniforms(r)}_setSketchUniforms(t){const i=this.settings.strokesTexture,r=i.texture;R(r)||(t.bindTexture(r,"strokesTexture"),t.setUniform2f("strokesTextureScale",1/r.descriptor.width,1/r.descriptor.height),t.setUniform1f("strokesLog2Resolution",Math.log2(i.resolution)),t.setUniform1f("strokesNormalizationScale",i.normalizationScale),t.setUniform1f("strokesAmplitude",i.amplitude),t.setUniform1f("strokeVariants",i.variants))}_sortRenderables(){this.renderablesDirty=!1,this.sortedRenderables[Ct.TRANSPARENT][Ct.TRANSPARENT].clear(),this.sortedRenderables[Ct.TRANSPARENT][Ct.OPAQUE].clear(),this.sortedRenderables[Ct.OPAQUE][Ct.TRANSPARENT].clear(),this.sortedRenderables[Ct.OPAQUE][Ct.OPAQUE].clear(),this.renderables.forEach(i=>{i.objectTransparency!==Ct.INVISIBLE&&i.edgeTransparency!==Ct.INVISIBLE&&this.sortedRenderables[i.objectTransparency][i.edgeTransparency].push(i)});const t=(i,r)=>"origin"in i.transform&&"origin"in r.transform?i.transform.origin.id<r.transform.origin.id?-1:i.transform.origin.id>r.transform.origin.id?1:0:0;this.sortedRenderables[Ct.TRANSPARENT][Ct.TRANSPARENT].sort(t),this.sortedRenderables[Ct.TRANSPARENT][Ct.OPAQUE].sort(t),this.sortedRenderables[Ct.OPAQUE][Ct.TRANSPARENT].sort(t),this.sortedRenderables[Ct.OPAQUE][Ct.OPAQUE].sort(t)}static getKey(t,i,r){return`edges-t:${t}:${i}:${r}`}}const Hut="componentDataTex",qut="componentDataTexInvDim",Yse=wm(),Wut=M();function Zse(e,t){return t.push(e.buffer),{buffer:e.buffer,layout:Xut(e.layout)}}function Qse(e){return Yut(e.layout).createView(e.buffer)}function Xut(e){const t=new Array;return e.fields.forEach((i,r)=>{const s=me(I({},i),{constructor:_be(i.constructor)});t.push([r,s])}),{stride:e.stride,fields:t,fieldNames:e.fieldNames}}function Yut(e){const t=kr();return t.stride=e.stride,t.fieldNames=e.fieldNames,e.fields.forEach(i=>t.fields.set(i[0],me(I({},i[1]),{constructor:Qut(i[1].constructor)}))),t}const Zut=[MO,Uu,Si,rn,id,dS,pS,fS,Xr,z1,T0,S0,$m,B1,E0,Pa,V1,mS,G1,A0,j1,gS,pR,fR,yS,H1,mR,gR,yR,q1,vR,_R,bR,wR,xR,TR];function _be(e){return`${e.ElementType}_${e.ElementCount}`}function Qut(e){return bbe.get(e)}const bbe=new Map;Zut.forEach(e=>bbe.set(_be(e),e));function Jse(e,t,i){const r=t/3,s=new Uint32Array(i+1),n=new Uint32Array(i+1),o=(w,S)=>{w<S?s[w+1]++:n[S+1]++};for(let w=0;w<r;w++){const S=e[3*w],T=e[3*w+1],A=e[3*w+2];o(S,T),o(T,A),o(A,S)}let a=0,l=0;for(let w=0;w<i;w++){const S=s[w+1],T=n[w+1];s[w+1]=a,n[w+1]=l,a+=S,l+=T}const c=new Uint32Array(6*r),h=s[i],p=(w,S,T)=>{if(w<S){const A=s[w+1]++;c[2*A]=S,c[2*A+1]=T}else{const A=n[S+1]++;c[2*h+2*A]=w,c[2*h+2*A+1]=T}};for(let w=0;w<r;w++){const S=e[3*w],T=e[3*w+1],A=e[3*w+2];p(S,T,w),p(T,A,w),p(A,S,w)}const f=(w,S)=>{const T=2*w,A=S-w;for(let C=1;C<A;C++){const O=c[T+2*C],L=c[T+2*C+1];let U=C-1;for(;U>=0&&c[T+2*U]>O;U--)c[T+2*U+2]=c[T+2*U],c[T+2*U+3]=c[T+2*U+1];c[T+2*U+2]=O,c[T+2*U+3]=L}};for(let w=0;w<i;w++)f(s[w],s[w+1]),f(h+n[w],h+n[w+1]);const g=new Int32Array(3*r),y=(w,S)=>w===e[3*S]?0:w===e[3*S+1]?1:w===e[3*S+2]?2:-1,v=(w,S)=>{const T=y(w,S);g[3*S+T]=-1},b=(w,S,T,A)=>{const C=y(w,S);g[3*S+C]=A;const O=y(T,A);g[3*A+O]=S};for(let w=0;w<i;w++){let S=s[w];const T=s[w+1];let A=n[w];const C=n[w+1];for(;S<T&&A<C;){const O=c[2*S],L=c[2*h+2*A];O===L?(b(w,c[2*S+1],L,c[2*h+2*A+1]),S++,A++):O<L?(v(w,c[2*S+1]),S++):(v(L,c[2*h+2*A+1]),A++)}for(;S<T;)v(w,c[2*S+1]),S++;for(;A<C;)v(c[2*h+2*A],c[2*h+2*A+1]),A++}return g}async function Jut(e){const t=Kut(e),i=wX(t),r=[t.data.buffer];return{result:eht(i,r),transferList:r}}function wX(e){const t=tht(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return Kse.updateSettings(e.writerSettings),ene.updateSettings(e.writerSettings),Tut(t,Kse,ene)}function Kut(e){return{data:cN.createView(e.dataBuffer),indices:e.indicesType==="Uint32Array"?new Uint32Array(e.indicesBuffer):e.indicesType==="Uint16Array"?new Uint16Array(e.indicesBuffer):void 0,indicesLength:e.indicesLength,writerSettings:e.writerSettings,skipDeduplicate:e.skipDeduplicate}}function eht(e,t){return t.push(e.regular.lodInfo.lengths.buffer),t.push(e.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:Zse(e.regular.instancesData,t),lodInfo:{lengths:e.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:Zse(e.silhouette.instancesData,t),lodInfo:{lengths:e.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:e.averageEdgeLength}}function tht(e,t,i,r){if(t)return{faces:i,facesLength:r,neighbors:Jse(i,r,e.count),vertices:e};const s=Eve(e.buffer,e.stride/4,{originalIndices:i,originalIndicesLength:r}),n=Jse(s.indices,r,s.uniqueCount);return{faces:s.indices,facesLength:s.indices.length,neighbors:n,vertices:cN.createView(s.buffer)}}const Kse=new hN,ene=new dN;var iht=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",work:wX,wrappedWork:Jut});class rht extends S1e{constructor(t){super("EdgeProcessingWorker","wrappedWork",t)}async process(t,i,r){if(r)return wX(t);const s=this._packInput(t),n=await this.invoke(s,i);return this._unpackOutput(n)}getTransferList(t){return[t.dataBuffer]}_packInput(t){return{dataBuffer:t.data.buffer,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate,indicesBuffer:t.indices.buffer,indicesType:sD(t.indices)?"Uint32Array":"Uint16Array",indicesLength:t.indicesLength}}_unpackOutput(t){return{regular:{instancesData:Qse(t.regular.instancesData),lodInfo:{lengths:new Float32Array(t.regular.lodInfo.lengths)}},silhouette:{instancesData:Qse(t.silhouette.instancesData),lodInfo:{lengths:new Float32Array(t.silhouette.lodInfo.lengths)}},averageEdgeLength:t.averageEdgeLength}}}function sht(e){const i=yE.resolution,r=i/2,s=new Uint8Array(4*i*i),n=4*i*r,o=yE.amplitude,a=2*o,l=4*i,c=Math.log2(i)+1,h=yE.strokes.length;let p=(c-1)*h*l;for(const{distance:g,pressure:y}of yE.strokes){let v=g,b=y,w=p;for(let S=0;S<c;S++){S!==0&&(v=tne(v,ZR.DISTANCE),b=tne(b,ZR.PRESSURE));for(let T=0;T<yE.resolution;T++){const A=.5+(v?v[T%v.length]/a:0),C=b?b[T%b.length]:1;zL(A,s,w),zL(C,s,w+n),w+=4}w-=l*(h+1)}p+=l}const f=new Qe(e,{pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,hasMipmap:!1,samplingMode:Ge.LINEAR,width:i,height:i,wrapMode:ct.REPEAT},s);return new oht(i,a,o,h,f)}function tne(e,t){if(!e)return null;const i=e.length/2,r=nht*i,s=new Array(i);let n=0;const o=t===ZR.PRESSURE;for(let a=0;a<e.length;a+=2){const l=(e[a]+e[a+1])/2;s[n++]=o?Math.min(r,1-(1-l)*ine):Math.min(r,l*ine)}return s}var ZR;(function(e){e[e.DISTANCE=0]="DISTANCE",e[e.PRESSURE=1]="PRESSURE"})(ZR||(ZR={}));const nht=.1,ine=.5;class oht{constructor(t,i,r,s,n){this.resolution=t,this.normalizationScale=i,this.amplitude=r,this.variants=s,this.texture=n}dispose(){this.texture=tt(this.texture)}}const yE={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function rne(e){let t=null;for(const i of e){const r=i.type;if(aht(i)){if(R(t))t=r;else if(t!==r)return"uber"}}return _(t)?t:"uber"}function zz(e){let t=Ct.INVISIBLE;for(const{material:i}of e)if(wbe(i)){if(i.color[3]*i.opacity<1)return Ct.TRANSPARENT;t=Ct.OPAQUE}return t}function Bz(e){let t=Ct.INVISIBLE;for(const{material:i}of e)if(wbe(i)){switch(i.objectTransparency){case Ct.TRANSPARENT:case Ct.INVISIBLE:return Ct.TRANSPARENT;case Ct.OPAQUE:if(i.opacity<1)return Ct.TRANSPARENT}t=Ct.OPAQUE}return t}function wbe(e){return e.size*e.color[3]*e.opacity>0}function aht(e){return e.size*e.color[3]>0}function lht(e,t){const i=Wxe(e,t,!0);return i===-1?t<e[0]?0:e.length:i}function sne(e,t,i){return e.length-lht(e,t*i.minimumEdgeLength)}function nne(e,t,i,r){for(let s=0;s<e.length;s++){const n=e[s].index,o=t[s],a=t[s+1];if(r)for(let l=o;l<a;l++){const c=r[l];i.set(c,n)}else for(let l=o;l<a;l++)i.set(l,n)}}const cht=he.getLogger("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView");let Xd=class extends we{constructor(e){super(e),this.updatingHandles=new fp,this.perObjectData=new Map,this.perObjectDataEvictionCache=new Set,this.renderers=new Map,this.numberOfRenderedEdges={[Ct.TRANSPARENT]:0,[Ct.OPAQUE]:0},this.gpuMemoryUsage=0,this.workerAbort=new AbortController,this.tmpModelPosition=M(),this.localOrigins=new _ut(new IW(e.renderSR))}initialize(){this.worker=new rht(this.schedule),this.componentColorManager=new obe(this.rctx,2);const e=fbe.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,t===0||t===3?0:1),e.sideness.set(t,1,t===0||t===1?0:1);this.verticesBufferObject=jt.createVertex(this.rctx,ri.STATIC_DRAW,e.buffer)}destroy(){this.destroyed||(this.perObjectData.forEach(e=>this._discardObjectEntry(e)),this.perObjectData.clear(),this.strokesTexture=tt(this.strokesTexture),this.componentColorManager=rt(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=tt(this.verticesBufferObject),this.renderers.clear(),this.updatingHandles.destroy())}get updating(){return this.updatingHandles.updating}get usedMemory(){return this.gpuMemoryUsage}get numberOfRenderedPrimitives(){return this.numberOfRenderedEdges[Ct.TRANSPARENT]+this.numberOfRenderedEdges[Ct.OPAQUE]}shouldRender(){return this.renderers.size>0}async addComponentObject(e,t,i,r,s,n,o,a){if(this.hasObject(e))return this.getObjectMemoryUsage(e);let l;const c=new one(new Promise(p=>l=p),i.center,i.radius);this.perObjectData.set(e,c);const h=await this.updatingHandles.addPromise(this._addComponentGeometry(t,c,r,s,n,o,a));return this.setNeedsRender(),l(),h}async addOrUpdateObject3D(e,t,i,r){if(this.destroyed)return void cht.warn("Attempt to add an object to a destroyed instance");const s=this.perObjectData.get(e);let n;(s==null?void 0:s.renderables.length)>0&&this.perObjectDataEvictionCache.add(s);const o=e.boundingVolumeWorldSpace.bounds,a=new one(new Promise(c=>n=c),Tc(o),lF(o));this.perObjectData.set(e,a);const l=new Array;if(i.mergeGeometries&&e.geometries.length>1&&hht(e))l.push(this._addObjectMergedGeometries(e,a,t,i,r));else for(let c=0;c<e.geometries.length;c++){const h=e.geometryRecords[c];if(!h.material.supportsEdges)continue;const p=e.geometries[c];l.push(this._addGeometry(e,a,p,h,t[0],i,r))}await this.updatingHandles.addPromise(Promise.all(l)),this.perObjectDataEvictionCache.delete(a),this._discardObjectEntry(s),this.setNeedsRender(),n()}_discardObjectEntry(e){e&&(e.renderables.length&&(e.renderables.forEach(t=>this._removeRenderable(t)),this.setNeedsRender()),e.loaded=null)}hasObject(e){return this.perObjectData.has(e)}async updateAllComponentOpacities(e,t){const i=t instanceof Array?r=>t[r]:()=>t;(await this.updatingHandles.addPromise(this._getObjectEntry(e))).renderables.forEach(r=>{const s=r.components.meta.length;for(let n=0;n<s;n++){const o=i(n),a=r.components.meta[n],l=a.index;a.material.opacity=o,r.components.buffer.textureBuffer.setDataElement(l,1,3,255*o)}this._updateTransparency(r)}),this.setNeedsRender()}async getObjectMemoryUsage(e){return(await this._getObjectEntry(e)).renderables.reduce((t,i)=>t+i.statistics.gpuMemoryUsage,0)}async updateAllComponentMaterials(e,t,i,r){const s=e instanceof tg,n=!!i.slicePlaneEnabled,o=rne(t),a=RC.getKey(o,n,s);(await this.updatingHandles.addPromise(this._getObjectEntry(e))).renderables.forEach(l=>{if(a!==l.rendererKey){const c=this.renderers.get(l.rendererKey),h=this._acquireRenderer(o,n,s);c.removeRenderable(l),c.refCount.decrement(),l.rendererKey=a,h.addRenderable(l)}for(let c=0;c<t.length;c++)l.components.meta[c].material=t[c];r&&this._updateComponentBuffer(l.components),this._updateTransparency(l)}),this.setNeedsRender()}async updateObjectVisibility(e,t){(await this.updatingHandles.addPromise(this._getObjectEntry(e))).renderables.forEach(i=>i.visible=t),this.setNeedsRender()}removeObject(e){const t=this.perObjectData.get(e);t&&(this.perObjectData.delete(e),this._discardObjectEntry(t))}async _getObjectEntry(e){const t=this.perObjectData.get(e);if(!t)throw"no object";return await t.loaded,t}removeAll(){this.perObjectData.forEach((e,t)=>this.removeObject(t))}render(e,t){if(this.numberOfRenderedEdges[t]=0,R(this.componentColorManager))return;this.localOrigins.updateViewMatrices(e.camera.viewMatrix);const i=e.camera.viewInverseTransposeMatrix,r=M(),s=new K4,n=new h_e,o=wr();oe(r,i[3],i[7],i[11]),s.set(r),ne(n.transformWorldFromViewTH,s.high),ne(n.transformWorldFromViewTL,s.low),Lu(n.transformViewFromCameraRelativeRS,e.camera.viewMatrix),Ur(n.transformProjFromView,e.camera.projectionMatrix);const a=wr();Nu(a,n.transformViewFromCameraRelativeRS),k1(o,a);let l=0,c=0;if(this.renderers.forEach(p=>{p.refCount.value===0?(this.renderers.delete(p.key),p.dispose()):p.forEachRenderable(f=>{f.visible&&(l+=f.statistics.averageEdgeLength,c++)},t)}),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures(),c===0)return;const h={distanceFalloffFactor:40*l/c,minimumEdgeLength:e.camera.perScreenPixelRatio,transparency:t,viewProjectionTransform:n,transformNormalViewFromGlobal:o};this._updateObjectCameraDistances(e),this.renderers.forEach(p=>{this._renderRegularEdges(p,e,h),this._renderSilhouetteEdges(p,e,h)})}_updateTransparency(e){const t=zz(e.components.meta),i=Bz(e.components.meta);t===e.edgeTransparency&&i===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=i,this.renderers.get(e.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(e,t,i){if(e.getCombinedStaticTransformation(t,i),_(t.origin))this.localOrigins.register(t.origin);else{const r=oe(this.tmpModelPosition,i[12],i[13],i[14]);t.origin=this.localOrigins.acquire(r)}return yut(t.origin.vec3,i),t.origin}_updateComponentBuffer(e){const{meta:t,buffer:i}=e;for(let r=0;r<t.length;r++){const s=t[r].material,n=t[r].index,o=Be(Math.round(s.size*But),0,255),a=Be(s.extensionLength,-kz,255-kz)+kz,l=s.type==="solid"?pN.SOLID:pN.SKETCH,c=255*s.opacity,h=s.color,p=255*h[0],f=255*h[1],g=255*h[2],y=255*h[3];i.textureBuffer.setData(n,0,p,f,g,y),i.textureBuffer.setData(n,1,o,a,l,c)}}_createComponentBuffers(e){if(R(this.componentColorManager))return null;const t=new Array,i=this.componentColorManager.getBuffer(e.length);for(let s=0;s<e.length;s++){const n=e[s],o=i.acquireIndex();t.push({index:o,material:n})}const r={meta:t,buffer:i};return this._updateComponentBuffer(r),r}_extractEdges(e,t,i,r,s,n=s.length){return this.worker.process({data:t,indices:s,indicesLength:n,writerSettings:e,skipDeduplicate:i},this.workerAbort.signal,r)}_createEdgeResources(e){const t={};if(R(this.verticesBufferObject))return t;if(e.regular.lodInfo.lengths.length>0){const i=new us(this.rctx,NG,{vertices:Wse,instances:hN.glLayout},{vertices:this.verticesBufferObject,instances:jt.createVertex(this.rctx,ri.STATIC_DRAW,e.regular.instancesData.buffer)});t.regular={vao:i,lod:e.regular.lodInfo}}if(e.silhouette.lodInfo.lengths.length>0){const i=new us(this.rctx,NG,{vertices:Wse,instances:dN.glLayout},{vertices:this.verticesBufferObject,instances:jt.createVertex(this.rctx,ri.STATIC_DRAW,e.silhouette.instancesData.buffer)});t.silhouette={vao:i,lod:e.silhouette.lodInfo}}return t}async _addGeometry(e,t,i,r,s,n,o){const a=i.vertexAttributes.get(E.POSITION),l=i.indices.get(E.POSITION),c=Te(),h={position:a,indices:l,modelTransform:c,origin:this._computeModelTransformWithLocalOrigin(e,r,c)};return this._addPositionData(t,h,i.edgeIndicesLength,s,n,o)}async _addPositionData(e,t,i,r,s,n=!1){if(e.loaded==null)return;const o=this._createComponentBuffers([r]);if(R(o)||i<=0)return;const a=this._acquireRenderer(r.type,!!s.slicePlaneEnabled),{modelTransform:l,origin:c}=t,h=t.indices,p=t.position,f=p.data.length/p.size,g=cN.createBuffer(f);for(let T=0;T<f;T++)g.position.set(T,0,p.data[T*p.size+0]),g.position.set(T,1,p.data[T*p.size+1]),g.position.set(T,2,p.data[T*p.size+2]);nne(o.meta,[0,g.componentIndex.count],g.componentIndex);const y=await this.updatingHandles.addPromise(this._extractEdges(a.writerSettings,g,!1,n,h,i));if(e.loaded==null)return;const{regular:v,silhouette:b}=this._createEdgeResources(y),w=(v?v.vao.size:0)+(b?b.vao.size:0),S={regular:v,silhouette:b,transform:{modelMatrix:l,origin:c},statistics:{gpuMemoryUsage:w,externalMemoryUsage:!1,averageEdgeLength:y.averageEdgeLength},components:o,visible:!0,edgeTransparency:zz(o.meta),objectTransparency:Bz(o.meta),distanceToCamera:0,rendererKey:a.key};e.renderables.push(S),a.addRenderable(S),this.gpuMemoryUsage+=w}async _addComponentGeometry(e,t,i,r,s,n,o){if(t.loaded==null)return 0;const a=this._createComponentBuffers(n);if(R(a))return 0;const l=rne(n),c=this._acquireRenderer(l,o.slicePlaneEnabled||!1,!1),h=cN.createBuffer(i.count);zW(h.position,i),nne(a.meta,s,h.componentIndex,r);const p=!0,f=c.writerSettings,g=await this.updatingHandles.addPromise(this._extractEdges(f,h,p,!1,r));if(t.loaded==null)return 0;const{regular:y,silhouette:v}=this._createEdgeResources(g),b=(y?y.vao.size:0)+(v?v.vao.size:0),w={regular:y,silhouette:v,transform:e,statistics:{gpuMemoryUsage:b,externalMemoryUsage:!0,averageEdgeLength:g.averageEdgeLength},components:a,visible:!0,edgeTransparency:zz(a.meta),objectTransparency:Bz(a.meta),distanceToCamera:0,rendererKey:c.key};return t.renderables.push(w),c.addRenderable(w),b}async _addObjectMergedGeometries(e,t,i,r,s){const n=new Map;let o=0,a=null,l=0;for(let w=0;w<e.geometries.length;w++){const S=e.geometries[w],T=e.geometryRecords[w];if(!T.material.supportsEdges)continue;!a&&T.origin&&(a=T);const A=S.vertexAttributes.get(E.POSITION);l+=A.data.length/A.size,o+=S.edgeIndicesLength}const c=l>=65536?Uint32Array:Uint16Array,h=o?new c(o):null,p=[];let f=0;for(let w=0;w<e.geometries.length;w++){const S=e.geometries[w];if(!e.geometryRecords[w].material.supportsEdges)continue;const T=S.vertexAttributes.get(E.POSITION),A=S.indices.get(E.POSITION);let C=n.get(T.data);if(C==null){C=p.length/3;for(let O=0;O<T.data.length;O+=T.size)p.push(T.data[O+0]),p.push(T.data[O+1]),p.push(T.data[O+2]);n.set(T.data,C)}if(A)for(let O=0;O<S.edgeIndicesLength;O++)h[f++]=C+A[O]}const g=a||e.geometryRecords[0],y=Te(),v=this._computeModelTransformWithLocalOrigin(e,g,y);for(let w=0;w<e.geometryRecords.length;w++)e.geometryRecords[w].origin=v;const b={position:{data:p,size:3},indices:h,modelTransform:y,origin:v};await this.updatingHandles.addPromise(this._addPositionData(t,b,h.length,i[0],r,s))}_acquireRenderer(e,t,i=!0){const r=RC.getKey(e,t,i);let s=this.renderers.get(r);return R(this.strokesTexture)&&(this.strokesTexture=sht(this.rctx)),s||(s=new RC(this.rctx,this.techniqueRepository,{type:e,slicePlaneEnabled:t,strokesTexture:this.strokesTexture,legacy:i}),this.renderers.set(r,s)),s.refCount.increment(),s}_removeRenderable(e){uht(e);const t=this.renderers.get(e.rendererKey);if(t){t.removeRenderable(e),t.refCount.decrement(),"origin"in e.transform&&this.localOrigins.release(e.transform.origin),this.gpuMemoryUsage-=e.statistics.externalMemoryUsage?0:e.statistics.gpuMemoryUsage;for(const i of e.components.meta)e.components.buffer.releaseIndex(i.index)}}_updateObjectCameraDistances(e){const t=e.camera.eye,i=e.camera.viewForward,r=M(),s=n=>{const{center:o,radius:a}=n;vp(r,o,t);const l=_e(r,i),c=l<-a?1/0:l<a?0:l-a;n.renderables.forEach(h=>h.distanceToCamera=c)};this.perObjectData.forEach(s),this.perObjectDataEvictionCache.forEach(s)}_renderRegularEdges(e,t,i){e.bindRegularEdges(t,i);const r=i.transparency;e.forEachRenderable(s=>{if(!s.visible||!s.regular)return;const n=sne(s.regular.lod.lengths,s.distanceToCamera,i);"origin"in s.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(s.transform.origin)),e.renderRegularEdges(s,t,n),this.numberOfRenderedEdges[r]+=n},r)}_renderSilhouetteEdges(e,t,i){e.bindSilhouetteEdges(t,i);const r=i.transparency;e.forEachRenderable(s=>{if(!s.visible||!s.silhouette)return;const n=sne(s.silhouette.lod.lengths,s.distanceToCamera,i);"origin"in s.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(s.transform.origin)),e.renderSilhouetteEdges(s,t,n),this.numberOfRenderedEdges[r]+=n},r)}};function uht(e){e.regular&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null),e.silhouette&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null)}function hht(e){let t=null,i=null;for(let s=0;s<e.geometries.length;s++){var r;const n=e.geometryRecords[s];if(n.material.supportsEdges){if(t){if(!y1(t,n.transformation))return!1}else t=n.transformation;if(!i&&_(n.origin))i=n;else if(_((r=i)==null?void 0:r.origin)&&_(n.origin)&&i.origin.id!==n.origin.id)return!1}}return!0}u([d({constructOnly:!0})],Xd.prototype,"rctx",void 0),u([d({constructOnly:!0})],Xd.prototype,"renderSR",void 0),u([d({constructOnly:!0})],Xd.prototype,"techniqueRepository",void 0),u([d({constructOnly:!0})],Xd.prototype,"setNeedsRender",void 0),u([d({constructOnly:!0})],Xd.prototype,"schedule",void 0),u([d({readOnly:!0})],Xd.prototype,"updatingHandles",void 0),u([d({readOnly:!0})],Xd.prototype,"updating",null),Xd=u([P("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],Xd);class one{constructor(t,i,r){this.center=i,this.radius=r,this.renderables=new Array,this.loaded=t,this.loaded.then(()=>{this.loaded!=null&&(this.loaded=!0)})}}function xbe(e){const t=e.capabilities.disjointTimerQuery;return R(t)?null:t.timestampBits()>0?new dht(t):UG?null:new pht(t)}class dht{constructor(t){this.timer=t,this.start=t.createQuery(),t.createTimestamp(this.start)}stop(t,i=50){this.end=this.timer.createQuery(),this.timer.createTimestamp(this.end),this._checkQueryResult(t,i)}_checkQueryResult(t,i){if(!this.timer.resultAvailable(this.end))return void setTimeout(()=>this._checkQueryResult(t,i),i);if(this.timer.disjoint())return void t(null);const r=this.timer.getResult(this.start),s=this.timer.getResult(this.end);t((s-r)/1e6)}}class pht{constructor(t){this.timer=t,this.query=t.createQuery(),UG=!0,this.timer.beginTimeElapsed(this.query)}stop(t,i=50){this.timer.endTimeElapsed(),UG=!1,this._checkQueryResult(t,i)}_checkQueryResult(t,i){const r=this.timer.resultAvailable(this.query),s=this.timer.disjoint();if(!r||s)s?t(null):setTimeout(()=>this._checkQueryResult(t,i),i);else{const n=this.timer.getResult(this.query);t(n/1e6)}}}let UG=!1;var es;(function(e){e[e.Prepare=0]="Prepare",e[e.Shadowmap=1]="Shadowmap",e[e.Lineardepth=2]="Lineardepth",e[e.Normals=3]="Normals",e[e.SSAO=4]="SSAO",e[e.Opaque=5]="Opaque",e[e.OpaqueEdges=6]="OpaqueEdges",e[e.Transparent=7]="Transparent",e[e.TransparentEdges=8]="TransparentEdges",e[e.Hudvisibility=9]="Hudvisibility",e[e.TransparentTerrain=10]="TransparentTerrain",e[e.Atmosphere=11]="Atmosphere",e[e.Laserline=12]="Laserline",e[e.Occluded=13]="Occluded",e[e.Antialiasing=14]="Antialiasing",e[e.Highlights=15]="Highlights",e[e.HudOccluded=16]="HudOccluded",e[e.HudNotoccluded=17]="HudNotoccluded"})(es||(es={}));const fht=["prepare","shadowmap","lineardepth","normals","ssao","opaque","opaque edges","transparent","transparent edges","hudvisibility","transparent terrain","atmosphere","laserline","occluded","antialiasing","highlights","hudOccluded","hudNotoccluded"];class mht extends r0{constructor(){super("total"),this.total=0,this.frameCount=0}}class ght{constructor(){this._startTime=0,this._lastSample=0,this._enableGPUTimer=0,this.totalTime=new mht,this.gpuTime=new r0("gpu",9),this.renderPassTimings=fht.map(t=>new r0(t))}get elapsedTime(){return performance.now()-this._startTime}enableGPUTimer(){return++this._enableGPUTimer,{remove:x7(()=>--this._enableGPUTimer)}}prerender(t){this._startTime=this._lastSample=performance.now(),this._enableGPUTimer&&(this._gpuTimer=xbe(t))}advance(t){const i=performance.now();this.renderPassTimings[t].record(i-this._lastSample),this._lastSample=i}postrender(){_(this._gpuTimer)&&(this._gpuTimer.stop(i=>_(i)&&this.gpuTime.record(i),16),this._gpuTimer=null);const t=performance.now()-this._startTime;this.totalTime.record(t),this.totalTime.total+=t,this.totalTime.frameCount++}}const ane=.9;let Gf=class extends we{constructor(e,t,i,r,s,n,o,a,l){super({}),this._materialRepository=e,this._shaderTechniqueRepository=i,this._rctx=r,this._compositingHelper=s,this._magnifierHelper=n,this._requestRender=o,this._stage=l,this._materialRenderers=new Map,this._needsTransparentPass=!1,this._hasHUDElements=!1,this._hasHighlights=!1,this._hasOccludees=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._content=new Map,this._isRendering=!1,this._fallbackDepthStencilTexture=null,this.performanceInfo=new ght,this._antialiasing=D_.SMAA,this._oitEnabled=!1,this._multipassTerrain=!0,this._opaqueTerrain=!0,this._lighting=new e_e,this._hasAnimations=!1,this._animationTimestep=0,this._handles=new Ut,this._renderHiddenTransparentEdges=()=>{},this._oitUsed=!1,this._smaaPass=new DA(this._rctx,i),this._oitEnabled=this._hasOITSupport,this._requestRender(),this._offscreenRendering=new Vct(this._rctx,this._compositingHelper),this._sliceHelper=new hut,this._shadowMap=new cbe(this._rctx,l.viewingMode,2),this._ssaoHelper=new gut(i,this._rctx,()=>this._requestRender()),this._highlightHelper=new Uct(i,this._rctx),this._shadowHighlightHelper=new uut(this._rctx,l.viewingMode),this._shadowAccumulator=new no(this._rctx,i,l,(c,h)=>{this.renderPassManager.shadowCastingEnabled=!0,this._renderPlugins.prepareRender(c,h),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled},(c,h,p,f)=>{c.start(p,h,f),this._renderShadowCascades(Le.MATERIAL_DEPTH_SHADOWMAP_ALL,c),p.setGLViewport(this._rctx),this._ensureCameraBindParameters(p)},()=>this._requestRender()),this._bindParameters={slot:null,camera:null,inverseViewport:Ye(),shadowMap:this._shadowMap,shadowMappingEnabled:this._shadowMap.enabled,ssaoHelper:this._ssaoHelper,ssaoEnabled:this._ssaoHelper.enabled,origin:null,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:this._sliceHelper.plane,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,multipassGeometryEnabled:!1,cullAboveGround:!1,lastFrameColorTexture:null,reprojectionMatrix:ls,ssrEnabled:!1,lighting:this._lighting,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:!0},this._renderContext=new hQe(this._rctx,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderContext.multipassTerrainParams={camera:null,multipassTerrainEnabled:!1,cullAboveGround:!1,terrainLinearDepthTexture:null},this._renderContext.multipassGeometryParams={multipassGeometryEnabled:!1,geometryLinearDepthTexture:null},this._renderContext.ssrParams={camera:null,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:ls,ssrEnabled:!1},this._renderPlugins=new Hct({renderContext:this._renderContext,shaderTechniqueRepository:i,textureRep:t,materialRep:this._materialRepository,requestRender:this._requestRender,schedule:a}),this.renderPassManager=new Ict(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([Wt(hi,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",c=>{this._renderHiddenTransparentEdges=c?()=>this._renderEdges(Ct.TRANSPARENT):()=>{},this._requestRender()}),Wt(this._stage,"camera",()=>this._requestRender(),!0)])}get hasWater(){return this._hasWater||this._hasOverlayWater}get hasWaterReflection(){return this.hasWater&&this._waterReflectionEnabled}normalizeCtorArgs(){return{}}dispose(){this._handles.destroy(),this._smaaPass.dispose(),this._materialRenderers.forEach(e=>e.dispose()),this._materialRenderers.clear(),this._edgeView=rt(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=tt(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlightHelper.dispose(),this._shadowHighlightHelper.dispose(),this._shadowAccumulator.dispose(),YF.prune(),this._content.clear()}disposeOffscreenBuffers(){this._offscreenRendering.dispose(),this._shadowMap.dispose(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()}get updating(){return this._antialiasing===D_.SMAA&&this._smaaPass.updating||_(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return R(this._edgeView)&&(this._edgeView=new Xd({rctx:this._rctx,renderSR:this._stage.renderSR,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:e=>this._stage.resourceController.schedule(e)}),this._handles.add(this._edgeView.watch("updating",()=>this._requestRender(),!0)),this._requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return this._bindParameters.reprojectionMatrix===null||YB(this._bindParameters.reprojectionMatrix,ls)}set _reprojectionMatrix(e){YB(this._bindParameters.reprojectionMatrix,e)||(this._bindParameters.reprojectionMatrix=e,this.notifyChange("isCameraFinal"))}get hasShadowsEnabled(){var e;return!((e=this._shadowMap)==null||!e.enabled)}setRenderParameters(e){const{renderPassManager:t,_shadowMap:i,_ssaoHelper:r}=this;e.screenSpaceReflectionsEnabled!==void 0&&t.screenSpaceReflectionsEnabled!==e.screenSpaceReflectionsEnabled&&(t.screenSpaceReflectionsEnabled=e.screenSpaceReflectionsEnabled,this._requestRender()),e.fillLightsEnabled!==void 0&&t.fillLightsEnabled!==e.fillLightsEnabled&&(t.fillLightsEnabled=e.fillLightsEnabled,this._requestRender()),e.shadowMap===void 0||i.enabled===e.shadowMap&&t.shadowCastingEnabled===e.shadowMap||(i.enabled=e.shadowMap,t.shadowCastingEnabled=e.shadowMap,this._requestRender()),e.shadowMapMaxCascades!==void 0&&i.maxCascades!==e.shadowMapMaxCascades&&(i.maxCascades=e.shadowMapMaxCascades,this._requestRender()),e.ssao!==void 0&&r.enabled!==e.ssao&&(r.enabled=e.ssao,this._requestRender()),e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this._requestRender());const s=e.antialiasingEnabled?D_.SMAA:D_.NONE;e.antialiasingEnabled!==void 0&&this._antialiasing!==s&&(this._antialiasing=s,this._requestRender()),e.highQualityTransparency!==void 0&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this._requestRender()),e.defaultHighlightOptions!==void 0&&(this._highlightHelper.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlightHelper.setDefaultOptions(e.defaultHighlightOptions),this._requestRender()),e.slicePlane!==void 0&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane,this._requestRender()),e.waterReflectionEnabled!==void 0&&this._waterReflectionEnabled!==e.waterReflectionEnabled&&(this._waterReflectionEnabled=e.waterReflectionEnabled,this._requestRender()),e.fillLightsEnabled!==void 0&&this._hasFillLights!==e.fillLightsEnabled&&(this._hasFillLights=e.fillLightsEnabled,this._requestRender()),e.opaqueTerrain!==void 0&&this._opaqueTerrain!==e.opaqueTerrain&&(this._opaqueTerrain=e.opaqueTerrain,this._requestRender()),e.hasOverlayWater!==void 0&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),e.shadowCastOptions!==void 0&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlendWorking}modify(e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:i,updates:r}=e;if(t.length===0&&i.length===0&&r.length===0)return;i.forAll(({id:o})=>this._content.delete(o)),t.forAll(o=>this._content.set(o.id,o));const s=Ove(e);let n=!1;s.forEach((o,a)=>{let l=this._materialRenderers.get(a);if(!l){if(!(o.adds.length>0))return;l=new Lve(this._rctx,this._materialRepository,a),this._materialRenderers.set(a,l)}l.modify(o),l.isEmpty&&(n=!0)}),n&&this._materialRenderers.forEach((o,a)=>{o.isEmpty&&(this._materialRenderers.delete(a),o.dispose())}),this._hasHighlights=qr(this._materialRenderers,o=>o.hasHighlights),this._hasOccludees=qr(this._materialRenderers,o=>o.hasOccludees),this._hasWater=qr(this._materialRenderers,o=>o.hasWater),this._needsTransparentPass=qr(this._materialRenderers,o=>o.requiresSlot(ve.TRANSPARENT_MATERIAL,Le.MATERIAL)),this._hasHUDElements=qr(this._materialRenderers,o=>o.requiresSlot(ve.LINE_CALLOUTS_HUD_DEPTH,Le.MATERIAL)||o.requiresSlot(ve.HUD_MATERIAL,Le.MATERIAL)||o.requiresSlot(ve.LABEL_MATERIAL,Le.MATERIAL)),this._requestRender()}updateAnimation(e){return this._hasAnimations=!1,this._materialRenderers.forEach(t=>this._hasAnimations=t.updateAnimation(e)||this._hasAnimations),this._hasAnimations=this._renderPlugins.updateAnimation(e)||this._hasAnimations,this._hasAnimations}get animationTimestep(){return this._animationTimestep}updateLightSources(e,t,i){this._lighting.groundLightingFactor=t,this._lighting.globalFactor=i,this._lighting.set(e)}render(e,t,i,r){this._isRendering=!0,this.performanceInfo.prerender(this._rctx),this._bindParameters.lighting=this._lighting,this._renderContext.hasOccludees=this._hasOccludees,this._renderContext.transparencyPassType=this._bindParameters.transparencyPassType=lt.NONE,this._renderContext.hasFillLights=this._bindParameters.hasFillLights=this._hasFillLights;const s=this._offscreenRendering;s.needLastFrameColorTexture=this.hasWaterReflection,s.advanceCurrentRenderTarget();const n=this._sliceHelper.plane;r===U1.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),t.setGLViewport(this._rctx),this.needsShadowCast&&(this.renderPassManager.shadowCastingEnabled=!0),this._renderPlugins.prepareRender(t,i),this.performanceInfo.advance(es.Prepare);const o=this._computeDepthRange(t);this._renderShadowMap(e,t,this._lighting.lightingMainDirection,o),this.performanceInfo.advance(es.Shadowmap),s.initializeFrame(t),this._ensureBindParameters(t),this._renderLinearDepth(),this.performanceInfo.advance(es.Lineardepth),this._accumulateShadows(o,t,i),this._renderNormal(),this.performanceInfo.advance(es.Normals),this._ensureBindParametersSSR(),this._ensureBindParametersCloudsReflections(),this._ssaoHelper.computeSSAO(t,s.linearDepthTexture,s.normalTexture),this.performanceInfo.advance(es.SSAO),this._renderContext.pass=Le.MATERIAL,s.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(es.Opaque);const a=this._multipassTerrain&&!this._opaqueTerrain;this._renderTerrainLinearDepth(a),this._setMultipassFlags(a),this._setTerrainCulling(a),this._renderEdges(Ct.OPAQUE),this.performanceInfo.advance(es.OpaqueEdges),this._renderHiddenTransparentEdges();const l=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;l&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(es.Transparent),this._renderGeometryLinearDepth(a);const c=this._renderHUDVisibility();a||this._renderInternalSlot(ve.LINE_CALLOUTS),this.performanceInfo.advance(es.Hudvisibility),this._renderEdges(Ct.TRANSPARENT,a),this.performanceInfo.advance(es.TransparentEdges),this._renderSlot(ve.VOXEL),this._renderTransparentTerrain(),!this._opaqueTerrain&&c&&(a?this._renderLineCallouts(hu.OCCLUDED):s.compositeTransparentTerrainOntoHUDVisibility(),this._renderHUD(hu.OCCLUDED,s.framebuffer),this.performanceInfo.advance(es.HudOccluded)),this.performanceInfo.advance(es.TransparentTerrain),this._setTerrainCulling(!1),this._opaqueTerrain||(s.compositeTransparentTerrainOntoMain(),a&&(this._renderEdges(Ct.OPAQUE),this.performanceInfo.advance(es.OpaqueEdges),l&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(es.Transparent),this._renderEdges(Ct.TRANSPARENT),this.performanceInfo.advance(es.TransparentEdges))),a&&this._renderLineCallouts(hu.NOTOCCLUDED),this._setMultipassFlags(!1),this._shadowAccumulator.render(),s.renderToTargets(()=>{this._renderInternalSlot(ve.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderSlot(ve.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),this._renderSlot(ve.LASERLINES)},s.currentColorTarget,s.mainDepth),this.performanceInfo.advance(es.Atmosphere),this._renderPlugins.needsLaserlineWithContrastControl&&s.renderTmpAndCompositeToMain(()=>this._renderSlot(ve.LASERLINES_CONTRAST_CONTROL),kn.PremultipliedAlpha),this.performanceInfo.advance(es.Laserline),this._renderOccluded(),this.performanceInfo.advance(es.Occluded);const h=r===U1.ON&&this._magnifierHelper.enabled,p=h&&R(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(p);const f=this._offscreenRendering.colorTexture;!this._renderAntiAliasing(this._antialiasing,f)&&_(f)&&this._compositingHelper.composite(f,kn.None),this.performanceInfo.advance(es.Antialiasing),this._renderHUD(hu.NOTOCCLUDED,p),this.performanceInfo.advance(es.HudNotoccluded),this._renderHighlights(p,this._bindParameters),this.performanceInfo.advance(es.Highlights),h&&this._magnifierHelper.render(this._rctx,this._bindParameters),p!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,kn.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=n,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender()}finish(e){if(this._hasAnimations||(this._animationTimestep=0),e===ns.BACKGROUND){this._rctx.gl.getError();const t=this.performanceInfo.elapsedTime/Mct;this._animationTimestep=Math.max(this._animationTimestep*ane+t*(1-ane),Pct)}}readDepthPixels(e,t,i,r,s,n){const o=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(e),this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const a=bi.COLOR_BUFFER_BIT|bi.DEPTH_BUFFER_BIT|bi.STENCIL_BUFFER_BIT;this._rctx.clearSafe(a),this._renderGeometryAndTransparentTerrainPass(Le.MATERIAL_DEPTH)}o.readPixels(t,i,r,s,$e.RGBA,yt.UNSIGNED_BYTE,n)}readAccumulatedShadow(e,t){return this._shadowAccumulator.readAccumulatedShadow(e,t)}_setMultipassFlags(e){this._renderContext.multipassTerrainParams.multipassTerrainEnabled=this._bindParameters.multipassTerrainEnabled=e,this._renderContext.multipassGeometryParams.multipassGeometryEnabled=this._bindParameters.multipassGeometryEnabled=e}_setTerrainCulling(e){this._renderContext.multipassTerrainParams.cullAboveGround=this._bindParameters.cullAboveGround=e}_renderSlot(e){this._renderContext.slot=e,this._renderPlugins.render()}_renderEdges(e,t=!1){const i=this._edgeView;_(i)&&i.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain(()=>i.render(this._bindParameters,e),kn.Alpha,t)}_renderShadowMap(e,t,i,r){const s=this._shadowMap;s.enabled&&(s.start(t,i,r),this._shadowHighlightHelper.updateParameters(t,i),this.needsShadowHighlight?(this._renderShadowCascades(Le.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT,this._shadowMap,n=>s.takeCascadeSnapshotTo(n,ube)),s.clear(),this._renderShadowCascades(Le.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,this._shadowMap,n=>{s.takeCascadeSnapshotTo(n,hbe),this._renderGeometryAndTransparentTerrainPass(Le.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT)})):this._renderShadowCascades(Le.MATERIAL_DEPTH_SHADOWMAP_ALL),s.finish(e),t.setGLViewport(this._rctx))}_renderShadowCascades(e,t=this._shadowMap,i=r=>{}){for(const r of t.getCascades())r.camera.setGLViewport(this._rctx),this._ensureCameraBindParameters(r.camera),this._renderGeometryAndTransparentTerrainPass(e),i(r)}get _needsLinearDepth(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight||this.needsShadowCast}_renderLinearDepth(){this._needsLinearDepth?this._offscreenRendering.renderToTargets(()=>this._renderGeometryAndTransparentTerrainPass(Le.MATERIAL_DEPTH),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture}_renderTerrainLinearDepth(e){if(e){const t=this._renderContext.pass;this._renderContext.pass=Le.MATERIAL_DEPTH,this._offscreenRendering.renderToTargets(()=>this._renderTransparentTerrain(),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.pass=t}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._renderContext.multipassTerrainParams.terrainLinearDepthTexture=this._bindParameters.terrainLinearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture}_renderGeometryLinearDepth(e){if(e){const t=this._renderContext.pass;this._offscreenRendering.renderToTargets(()=>this._renderGeometryPass(Le.MATERIAL_DEPTH),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=t}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._renderContext.multipassGeometryParams.geometryLinearDepthTexture=this._bindParameters.geometryLinearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture}get needsNormal(){return this._ssaoHelper.enabled}_renderNormal(){this.needsNormal?this._offscreenRendering.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(Le.MATERIAL_NORMAL)},this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)}get needsDepthRange(){return this._shadowMap.enabled||this.needsShadowCast}_computeDepthRange(e){if(!this.needsDepthRange)return OG;const t=_ct(e,this._content,this._stage.layers);return OS(t,this.renderPlugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}_renderGeometryAndTransparentTerrainPass(e){this._renderContext.pass=e,this._renderGeometryPass(e),this._renderTransparentTerrain()}_renderGeometryPass(e){this._renderContext.pass=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderOpaqueGeometry(){this._renderSlot(ve.INTEGRATED_MESH),this._renderSlot(ve.OPAQUE_TERRAIN),this._renderInternalSlot(ve.OPAQUE_MATERIAL),this._renderSlot(ve.OPAQUE_PLUGIN),this._renderSlot(ve.POSTPROCESSING_ENVIRONMENT_OPAQUE)}_renderTransparentGeometry(){this._renderInternalSlot(ve.TRANSPARENT_MATERIAL),this._renderSlot(ve.TRANSPARENT_PLUGIN)}_renderTransparentTerrain(){this._renderSlot(ve.TRANSPARENT_TERRAIN)}_renderHUDVisibility(){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility(()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture,e=this._renderInternalSlot(ve.OCCLUSION_PIXELS)},this._multipassTerrain&&!this._opaqueTerrain),e}_renderLineCallouts(e){this._bindParameters.renderTransparentlyOccludedHUD=e,e===hu.OCCLUDED?this._offscreenRendering.renderToTargets(()=>this._renderInternalSlot(ve.LINE_CALLOUTS),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderInternalSlot(ve.LINE_CALLOUTS)}_renderHUD(e,t){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency(()=>this._renderHUDElements(e),!0),this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,kn.PremultipliedAlpha)):e===hu.OCCLUDED?this._offscreenRendering.renderToTargets(()=>this._renderHUDElements(hu.OCCLUDED),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderHUDElements(e))}_renderHUDElements(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this._renderInternalSlot(ve.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(ve.HUD_MATERIAL),this._renderInternalSlot(ve.LABEL_MATERIAL)}get needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlightHelper.isVisible&&this.needsHighlight}_renderHighlights(e,t){if(!this.needsHighlight)return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const i=this._highlightHelper,r=i.profilingCallback&&xbe(this._renderContext.rctx);this._renderContext.highlightDepthTexture=t.highlightDepthTexture;const s=this._offscreenRendering.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(Le.MATERIAL_HIGHLIGHT),this._rctx.clearSafe(bi.DEPTH_BUFFER_BIT),this._renderHUDElements(hu.BOTH)},this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=s.colorTexture,this.needsShadowHighlight&&this._shadowHighlightHelper.render(t,e),i.render(this._renderContext.camera,s,e),_(r)&&i.profilingCallback&&r.stop(n=>{i.profilingCallback&&i.profilingCallback(n)})}get needsShadowCast(){return this._shadowAccumulator.isAccumulating}_accumulateShadows(e,t,i){this.needsShadowCast&&(this._shadowAccumulator.setAccumulationDependencies(this._offscreenRendering.linearDepthTexture,e,t,i),this._shadowAccumulator.accumulateFixedSamples(),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled)}_renderOrderIndependentTransparency(e,t){const i=s=>{this._renderContext.transparencyPassType=s,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._offscreenRendering.renderOITPass(()=>e(),s,t)},r=this._renderContext.pass;this._renderContext.pass=Le.MATERIAL_ALPHA,i(lt.Alpha),this._renderContext.pass=Le.MATERIAL,i(lt.Color),i(lt.FrontFace),this._offscreenRendering.compositeTransparentOntoOpaque(t),this._renderContext.transparencyPassType=lt.NONE,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._renderContext.pass=r,this._oitUsed=!0}_disposeOITBuffers(){this._oitUsed||(this._offscreenRendering.disposeTarget(this._offscreenRendering.alphaFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.colorFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.frontFaceTarget)),this._oitUsed=!1}_renderOccluded(){let e=0;this._materialRenderers.forEach((n,o)=>{o&&o.isVisible()&&o.renderOccluded===Cr.OccludeAndTransparentStencil&&(e|=o.renderOccluded,_E.push(o))});const t=this._offscreenRendering,i=(n,o,a,l,c)=>{(e&o)!=0&&(t.renderToTargets(a,t.tmpColor,t.mainDepth,[0,0,0,0],l,c),t.compositeOccludedOntoMain(n))};_E.length!==0&&(this._renderInternalSlot(ve.OCCLUDER_MATERIAL,_E),i(.5,Cr.OccludeAndTransparentStencil,()=>this._renderInternalSlot(ve.TRANSPARENT_OCCLUDER_MATERIAL,_E),!1,!1),_E.length=0),this._materialRenderers.forEach((n,o)=>{o&&o.isVisible()&&(o.renderOccluded===Cr.OccludeAndTransparent||o.renderOccluded===Cr.Transparent||o.renderOccluded===Cr.Opaque)&&(e|=o.renderOccluded,vE.push(o))});const r=this._renderPlugins.renderOccludedFlags;if(e|=r,!e)return;const s=n=>{this._renderContext.renderOccludedMask=n,r>Cr.Occlude&&this._renderSlot(ve.OCCLUDED_TERRAIN),this._renderInternalSlot(ve.OPAQUE_MATERIAL,vE),this._renderInternalSlot(ve.TRANSPARENT_MATERIAL,vE),this._renderInternalSlot(ve.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,vE),this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=Le.MATERIAL,i(.5,Cr.OccludeAndTransparent,()=>s(Cr.OccludeAndTransparent),!0,Ea.OutlineVisualElementMask),i(.5,Cr.Transparent,()=>s(Cr.Transparent),!0,Ea.OutlineVisualElementMask),i(1,Cr.Opaque,()=>s(Cr.Opaque),!0,Ea.OutlineVisualElementMask),vE.length=0}_renderAntiAliasing(e,t){if(e===D_.SMAA){if(this._smaaPass.enable(()=>this._requestRender())&&_(t))return this._smaaPass.render(t),!0}else this._smaaPass.disable();return!1}_ensureCameraBindParameters(e){this._renderContext.camera=e,this._bindParameters.camera=this._renderContext.camera,this._bindParameters.inverseViewport[0]=1/this._renderContext.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/this._renderContext.camera.fullViewport[3]}_ensureBindParameters(e){var t;this._ensureCameraBindParameters(e);const i=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=this._renderContext.shadowMap,this._bindParameters.shadowMappingEnabled=this._renderContext.shadowMap.enabled,this._bindParameters.ssaoHelper=this._renderContext.ssaoHelper,this._bindParameters.ssaoEnabled=this._renderContext.ssaoHelper.enabled,this._bindParameters.slicePlane=this._renderContext.sliceHelper.plane,this._bindParameters.hasOccludees=this._renderContext.hasOccludees,this._renderContext.multipassTerrainParams.camera=this._renderContext.camera,this._bindParameters.hudVisibilityTexture=i.hudVisibilityTexture,this._bindParameters.highlightDepthTexture=(t=i.depthTexture)!=null?t:this._getFallbackDepthTexture()}_ensureBindParametersSSR(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._renderContext.camera)?this._renderContext.ssrParams.reprojectionMatrix=this._reprojectionMatrix=ls:(Wo(lne,this._renderContext.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),Wo(jP,this._renderContext.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),fr(jP,jP),fr(cne,this._renderContext.camera.projectionMatrix),dr(yw,jP,cne),dr(yw,lne,yw),dr(yw,this._renderContext.lastFrameCamera.projectionMatrix,yw),this._renderContext.ssrParams.reprojectionMatrix=this._reprojectionMatrix=yw),this._renderContext.ssrParams.camera=this._renderContext.camera,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this.hasWaterReflection}_ensureBindParametersCloudsReflections(){this._bindParameters.cloudsCompositionParams=this._renderContext.cloudsCompositionParams}_renderInternalSlot(e,t){let i=!1;return this._bindParameters.slot=e,_(t)?t.forEach(r=>{if(!r.shouldRender(this._renderContext))return;const s=this._materialRenderers.get(r);_(s)&&(i=s.render(e,this._renderContext.pass,this._bindParameters)||i)}):this._materialRenderers.forEach((r,s)=>{s.shouldRender(this._renderContext)&&(i=r.render(e,this._renderContext.pass,this._bindParameters)||i)}),i}_getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=Tge(this._rctx)),this._fallbackDepthStencilTexture}get gpuMemoryUsage(){var e,t,i,r,s,n,o,a,l,c;return{offscreen:(e=(t=this._offscreenRendering)==null?void 0:t.gpuMemoryUsage)!=null?e:0,highlights:((i=(r=this._highlightHelper)==null?void 0:r.gpuMemoryUsage)!=null?i:0)+((s=(n=this._shadowHighlightHelper)==null?void 0:n.gpuMemoryUsage)!=null?s:0),shadows:(o=(a=this._shadowMap)==null?void 0:a.gpuMemoryUsage)!=null?o:0,ssao:(l=(c=this._ssaoHelper)==null?void 0:c.gpuMemoryUsage)!=null?l:0}}get test(){const e=this;return{offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,lighting:this._lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,getFramebufferTexture:t=>{var i;switch(t){case Ry.Color:return e._offscreenRendering.colorTexture;case Ry.LinearDepth:return e._offscreenRendering.linearDepthTexture;case Ry.Normals:return e._offscreenRendering.normalTexture;case Ry.ShadowMap:return(i=e._shadowMap)==null?void 0:i.test.depthTexture;case Ry.HudVisibility:return e._offscreenRendering.hudVisibilityTexture;case Ry.Highlight:return e._offscreenRendering.highlightTexture}}}}};var Ry;u([d()],Gf.prototype,"_shadowAccumulator",void 0),u([d()],Gf.prototype,"_smaaPass",void 0),u([d()],Gf.prototype,"_antialiasing",void 0),u([d()],Gf.prototype,"_edgeView",void 0),u([d()],Gf.prototype,"updating",null),u([d()],Gf.prototype,"isCameraFinal",null),Gf=u([P("esri.views.3d.webgl-engine.lib.Renderer")],Gf),function(e){e[e.Color=0]="Color",e[e.LinearDepth=1]="LinearDepth",e[e.Normals=2]="Normals",e[e.ShadowMap=3]="ShadowMap",e[e.HudVisibility=4]="HudVisibility",e[e.Highlight=5]="Highlight"}(Ry||(Ry={}));const vE=[],_E=[],lne=Te(),cne=Te(),jP=Te(),yw=Te(),yht=["layout","centroid","smooth","case","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","uint","uvec2","uvec3","uvec4","samplerCubeShadow","sampler2DArray","sampler2DArrayShadow","isampler2D","isampler3D","isamplerCube","isampler2DArray","usampler2D","usampler3D","usamplerCube","usampler2DArray","coherent","restrict","readonly","writeonly","resource","atomic_uint","noperspective","patch","sample","subroutine","common","partition","active","filter","image1D","image2D","image3D","imageCube","iimage1D","iimage2D","iimage3D","iimageCube","uimage1D","uimage2D","uimage3D","uimageCube","image1DArray","image2DArray","iimage1DArray","iimage2DArray","uimage1DArray","uimage2DArray","image1DShadow","image2DShadow","image1DArrayShadow","image2DArrayShadow","imageBuffer","iimageBuffer","uimageBuffer","sampler1DArray","sampler1DArrayShadow","isampler1D","isampler1DArray","usampler1D","usampler1DArray","isampler2DRect","usampler2DRect","samplerBuffer","isamplerBuffer","usamplerBuffer","sampler2DMS","isampler2DMS","usampler2DMS","sampler2DMSArray","isampler2DMSArray","usampler2DMSArray","trunc","round","roundEven","isnan","isinf","floatBitsToInt","floatBitsToUint","intBitsToFloat","uintBitsToFloat","packSnorm2x16","unpackSnorm2x16","packUnorm2x16","unpackUnorm2x16","packHalf2x16","unpackHalf2x16","outerProduct","transpose","determinant","inverse","texture","textureSize","textureProj","textureLod","textureOffset","texelFetch","texelFetchOffset","textureProjOffset","textureLodOffset","textureProjLod","textureProjLodOffset","textureGrad","textureGradOffset","textureProjGrad","textureProjGradOffset"];var une,Tbe={exports:{}};(une=["precision","highp","mediump","lowp","attribute","const","uniform","varying","break","continue","do","for","while","if","else","in","out","inout","float","int","void","bool","true","false","discard","return","mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","sampler1D","sampler2D","sampler3D","samplerCube","sampler1DShadow","sampler2DShadow","struct","asm","class","union","enum","typedef","template","this","packed","goto","switch","default","inline","noinline","volatile","public","static","extern","external","interface","long","short","double","half","fixed","unsigned","input","output","hvec2","hvec3","hvec4","dvec2","dvec3","dvec4","fvec2","fvec3","fvec4","sampler2DRect","sampler3DRect","sampler2DRectShadow","sizeof","cast","namespace","using"])!==void 0&&(Tbe.exports=une);const vht=Tbe.exports;var hne,Sbe={exports:{}};hne=Sbe,function(e){var t=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"];t!==void 0&&(hne.exports=t)}();const dne=Sbe.exports;var Ebe={exports:{}};(function(e){(function(t){var i=function(){return["abs","acos","all","any","asin","atan","ceil","clamp","cos","cross","dFdx","dFdy","degrees","distance","dot","equal","exp","exp2","faceforward","floor","fract","gl_BackColor","gl_BackLightModelProduct","gl_BackLightProduct","gl_BackMaterial","gl_BackSecondaryColor","gl_ClipPlane","gl_ClipVertex","gl_Color","gl_DepthRange","gl_DepthRangeParameters","gl_EyePlaneQ","gl_EyePlaneR","gl_EyePlaneS","gl_EyePlaneT","gl_Fog","gl_FogCoord","gl_FogFragCoord","gl_FogParameters","gl_FragColor","gl_FragCoord","gl_FragData","gl_FragDepth","gl_FragDepthEXT","gl_FrontColor","gl_FrontFacing","gl_FrontLightModelProduct","gl_FrontLightProduct","gl_FrontMaterial","gl_FrontSecondaryColor","gl_LightModel","gl_LightModelParameters","gl_LightModelProducts","gl_LightProducts","gl_LightSource","gl_LightSourceParameters","gl_MaterialParameters","gl_MaxClipPlanes","gl_MaxCombinedTextureImageUnits","gl_MaxDrawBuffers","gl_MaxFragmentUniformComponents","gl_MaxLights","gl_MaxTextureCoords","gl_MaxTextureImageUnits","gl_MaxTextureUnits","gl_MaxVaryingFloats","gl_MaxVertexAttribs","gl_MaxVertexTextureImageUnits","gl_MaxVertexUniformComponents","gl_ModelViewMatrix","gl_ModelViewMatrixInverse","gl_ModelViewMatrixInverseTranspose","gl_ModelViewMatrixTranspose","gl_ModelViewProjectionMatrix","gl_ModelViewProjectionMatrixInverse","gl_ModelViewProjectionMatrixInverseTranspose","gl_ModelViewProjectionMatrixTranspose","gl_MultiTexCoord0","gl_MultiTexCoord1","gl_MultiTexCoord2","gl_MultiTexCoord3","gl_MultiTexCoord4","gl_MultiTexCoord5","gl_MultiTexCoord6","gl_MultiTexCoord7","gl_Normal","gl_NormalMatrix","gl_NormalScale","gl_ObjectPlaneQ","gl_ObjectPlaneR","gl_ObjectPlaneS","gl_ObjectPlaneT","gl_Point","gl_PointCoord","gl_PointParameters","gl_PointSize","gl_Position","gl_ProjectionMatrix","gl_ProjectionMatrixInverse","gl_ProjectionMatrixInverseTranspose","gl_ProjectionMatrixTranspose","gl_SecondaryColor","gl_TexCoord","gl_TextureEnvColor","gl_TextureMatrix","gl_TextureMatrixInverse","gl_TextureMatrixInverseTranspose","gl_TextureMatrixTranspose","gl_Vertex","greaterThan","greaterThanEqual","inversesqrt","length","lessThan","lessThanEqual","log","log2","matrixCompMult","max","min","mix","mod","normalize","not","notEqual","pow","radians","reflect","refract","sign","sin","smoothstep","sqrt","step","tan","texture2D","texture2DLod","texture2DProj","texture2DProjLod","textureCube","textureCubeLod","texture2DLodEXT","texture2DProjLodEXT","textureCubeLodEXT","texture2DGradEXT","texture2DProjGradEXT","textureCubeGradEXT"]}();i!==void 0&&(e.exports=i)})()})(Ebe);const _ht=Ebe.exports;var ih=999,pne=9999,Vz=0,Gz=1,fne=2,mne=3,gne=4,HP=5,bht=6,wht=7,xht=8,yne=9,Tht=10,vne=11,Sht=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function Eht(){var e,t,i,r=0,s=0,n=ih,o=[],a=[],l=1,c=0,h=0,p=!1,f=!1,g="";return function(B){return a=[],B!==null?v(B.replace?B.replace(/\r\n/g,`
`):B):b()};function y(B){B.length&&a.push({type:Sht[n],data:B,position:h,line:l,column:c})}function v(B){var J;for(r=0,i=(g+=B).length;e=g[r],r<i;){switch(J=r,n){case Vz:r=C();break;case Gz:r=A();break;case fne:r=T();break;case mne:r=O();break;case gne:r=N();break;case vne:r=U();break;case HP:r=z();break;case pne:r=V();break;case yne:r=S();break;case ih:r=w()}J!==r&&(g[J]===`
`?(c=0,++l):++c)}return s+=r,g=g.slice(r),a}function b(B){return o.length&&y(o.join("")),n=Tht,y("(eof)"),a}function w(){return o=o.length?[]:o,t==="/"&&e==="*"?(h=s+r-1,n=Vz,t=e,r+1):t==="/"&&e==="/"?(h=s+r-1,n=Gz,t=e,r+1):e==="#"?(n=fne,h=s+r,r):/\s/.test(e)?(n=yne,h=s+r,r):(p=/\d/.test(e),f=/[^\w_]/.test(e),h=s+r,n=p?gne:f?mne:pne,r)}function S(){return/[^\s]/g.test(e)?(y(o.join("")),n=ih,r):(o.push(e),t=e,r+1)}function T(){return e!=="\r"&&e!==`
`||t==="\\"?(o.push(e),t=e,r+1):(y(o.join("")),n=ih,r)}function A(){return T()}function C(){return e==="/"&&t==="*"?(o.push(e),y(o.join("")),n=ih,r+1):(o.push(e),t=e,r+1)}function O(){if(t==="."&&/\d/.test(e))return n=HP,r;if(t==="/"&&e==="*")return n=Vz,r;if(t==="/"&&e==="/")return n=Gz,r;if(e==="."&&o.length){for(;L(o););return n=HP,r}if(e===";"||e===")"||e==="("){if(o.length)for(;L(o););return y(e),n=ih,r+1}var B=o.length===2&&e!=="=";if(/[\w_\d\s]/.test(e)||B){for(;L(o););return n=ih,r}return o.push(e),t=e,r+1}function L(B){for(var J,Q,te=0;;){if(J=dne.indexOf(B.slice(0,B.length+te).join("")),Q=dne[J],J===-1){if(te--+B.length>0)continue;Q=B.slice(0,1).join("")}return y(Q),h+=Q.length,(o=o.slice(Q.length)).length}}function U(){return/[^a-fA-F0-9]/.test(e)?(y(o.join("")),n=ih,r):(o.push(e),t=e,r+1)}function N(){return e==="."||/[eE]/.test(e)?(o.push(e),n=HP,t=e,r+1):e==="x"&&o.length===1&&o[0]==="0"?(n=vne,o.push(e),t=e,r+1):/[^\d]/.test(e)?(y(o.join("")),n=ih,r):(o.push(e),t=e,r+1)}function z(){return e==="f"&&(o.push(e),t=e,r+=1),/[eE]/.test(e)||e==="-"&&/[eE]/.test(t)?(o.push(e),t=e,r+1):/[^\d]/.test(e)?(y(o.join("")),n=ih,r):(o.push(e),t=e,r+1)}function V(){if(/[^\d\w_]/.test(e)){var B=o.join("");return n=vht.indexOf(B)>-1?xht:_ht.indexOf(B)>-1?wht:bht,y(o.join("")),n=ih,r}return o.push(e),t=e,r+1}}function Aht(e){var t=Eht(),i=[];return i=(i=i.concat(t(e))).concat(t(null))}function Cht(e){return Aht(e)}function Rht(e){return e.map(t=>t.type!=="eof"?t.data:"").join("")}const jz=["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"];function Oht(e,t="100",i="300 es"){const r=/^\s*\#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const s of e)if(s.type==="preprocessor"){const n=r.exec(s.data);if(n){const o=n[1].replace(/\s\s+/g," ");if(o===i)return o;if(o===t)return s.data="#version "+i,t;throw new Error("unknown glsl version: "+o)}}return e.splice(0,0,{type:"preprocessor",data:"#version "+i},{type:"whitespace",data:`
`}),null}function Mht(e,t){for(let i=t-1;i>=0;i--){const r=e[i];if(r.type!=="whitespace"&&r.type!=="block-comment"){if(r.type!=="keyword")break;if(r.data==="attribute"||r.data==="in")return!0}}return!1}function LA(e,t,i,r){r=r||i;for(const s of e)if(s.type==="ident"&&s.data===i)return r in t?t[r]++:t[r]=0,LA(e,t,r+"_"+t[r],r);return i}function Abe(e,t,i="afterVersion"){function r(l,c){for(let h=c;h<l.length;h++){const p=l[h];if(p.type==="operator"&&p.data===";")return h}return null}function s(l){let c=-1,h=0,p=-1;for(let f=0;f<l.length;f++){const g=l[f];if(g.type==="preprocessor"&&(g.data.match(/\#(if|ifdef|ifndef)\s+.+/)?++h:g.data.match(/\#endif\s*.*/)&&--h),i!=="afterVersion"&&i!=="afterPrecision"||g.type==="preprocessor"&&/^#version/.test(g.data)&&(p=Math.max(p,f)),i==="afterPrecision"&&g.type==="keyword"&&g.data==="precision"){const y=r(l,f);if(y===null)throw new Error("precision statement not followed by any semicolons!");p=Math.max(p,y)}c<p&&h===0&&(c=f)}return c+1}const n={data:`
`,type:"whitespace"},o=l=>l<e.length&&/[^\r\n]$/.test(e[l].data);let a=s(e);o(a-1)&&e.splice(a++,0,n);for(const l of t)e.splice(a++,0,l);o(a-1)&&o(a)&&e.splice(a,0,n)}function Pht(e,t,i,r="lowp"){Abe(e,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function Iht(e,t,i,r,s="lowp"){Abe(e,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:r.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:s},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function $ht(e,t){let i,r,s=-1;for(let n=t;n<e.length;n++){const o=e[n];if(o.type==="operator"&&(o.data==="["&&(i=n),o.data==="]")){r=n;break}o.type==="integer"&&(s=parseInt(o.data,10))}return i&&r&&e.splice(i,r-i+1),s}function _ne(e,t){const i=Dht();if(_(i))return i;const r=Cht(e);if(Oht(r,"100","300 es")==="300 es")return e;let s=null,n=null;const o={},a={};for(let l=0;l<r.length;++l){const c=r[l];switch(c.type){case"keyword":t===nc.VERTEX_SHADER&&c.data==="attribute"?c.data="in":c.data==="varying"&&(c.data=t===nc.VERTEX_SHADER?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(c.data.trim())&&(c.data=c.data.replace(/(2D|Cube|EXT)/g,"")),t===nc.FRAGMENT_SHADER&&c.data==="gl_FragColor"&&(s||(s=LA(r,o,"fragColor"),Pht(r,s,"vec4")),c.data=s),t===nc.FRAGMENT_SHADER&&c.data==="gl_FragData"){const h=$ht(r,l+1),p=LA(r,o,"fragData");Iht(r,p,"vec4",h,"mediump"),c.data=p}else t===nc.FRAGMENT_SHADER&&c.data==="gl_FragDepthEXT"&&(n||(n=LA(r,o,"gl_FragDepth")),c.data=n);break;case"ident":if(yht.indexOf(c.data)>=0){if(t===nc.VERTEX_SHADER&&Mht(r,l))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");c.data in a||(a[c.data]=LA(r,o,c.data)),c.data=a[c.data]}}}for(let l=r.length-1;l>=0;--l){const c=r[l];if(c.type==="preprocessor"){const h=c.data.match(/\#extension\s+(.*)\:/);if(h&&h[1]&&jz.indexOf(h[1].trim())>=0){const g=r[l+1];r.splice(l,g&&g.type==="whitespace"?2:1)}const p=c.data.match(/\#ifdef\s+(.*)/);p&&p[1]&&jz.indexOf(p[1].trim())>=0&&(c.data="#if 1");const f=c.data.match(/\#ifndef\s+(.*)/);f&&f[1]&&jz.indexOf(f[1].trim())>=0&&(c.data="#if 0")}}return Lht(e,Rht(r))}function Dht(e){return null}function Lht(e,t){return t}const Nht=4294967295;class Fht{constructor(t,i,r,s,n=new Map){this._context=t,this._locations=s,this._uniformBlockBindings=n,this._refCount=1,this._compiled=!1,this._nameToUniformLocation={},this._nameToUniform1={},this._nameToUniform1v={},this._nameToUniform2={},this._nameToUniform3={},this._nameToUniform4={},this._nameToUniformMatrix3={},this._nameToUniformMatrix4={},t||console.error("RenderingContext isn't initialized!"),i.length===0&&console.error("Shaders source should not be empty!"),this._context.type===Kt.WEBGL2&&(i=_ne(i,nc.VERTEX_SHADER),r=_ne(r,nc.FRAGMENT_SHADER)),this._vShader=bne(this._context,nc.VERTEX_SHADER,i),this._fShader=bne(this._context,nc.FRAGMENT_SHADER,r),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment(ks.Shader,this),aR()&&(this.vertexShader=i,this.fragmentShader=r)}get glName(){if(_(this._glName))return this._glName;if(R(this._vShader))return null;const t=this._context.gl,i=t.createProgram();if(t.attachShader(i,this._vShader),t.attachShader(i,this._fShader),this._locations.forEach((r,s)=>t.bindAttribLocation(i,r,s)),t.linkProgram(i),aR()&&!t.getProgramParameter(i,t.LINK_STATUS)&&console.error(`Could not link shader
validated: ${t.getProgramParameter(i,t.VALIDATE_STATUS)}, gl error ${t.getError()}, vertex: ${t.getShaderParameter(this._vShader,t.COMPILE_STATUS)}, fragment: ${t.getShaderParameter(this._fShader,t.COMPILE_STATUS)}, info log: ${t.getProgramInfoLog(i)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`),this._context.type===Kt.WEBGL2){const r=t;for(const[s,n]of this._uniformBlockBindings){const o=r.getUniformBlockIndex(i,s);o<Nht&&r.uniformBlockBinding(i,o,n)}}return this._glName=i,this._context.instanceCounter.increment(ks.Program,this),i}get hasGLName(){return _(this._glName)}get isCompiled(){if(this._compiled)return!0;const t=this._context.gl.getExtension("KHR_parallel_shader_compile");return t==null?(this._compiled=!0,!0):(this._compiled=!!this._context.gl.getProgramParameter(this.glName,t.COMPLETION_STATUS_KHR),this._compiled)}dispose(){if(--this._refCount>0)return;const t=this._context.gl;this._vShader&&(t.deleteShader(this._vShader),this._vShader=null,this._context.instanceCounter.decrement(ks.Shader,this)),this._fShader&&(t.deleteShader(this._fShader),this._fShader=null),this._glName&&(t.deleteProgram(this._glName),this._glName=null,this._context.instanceCounter.decrement(ks.Program,this))}ref(){++this._refCount}_getUniformLocation(t){return this._nameToUniformLocation[t]===void 0&&(this._nameToUniformLocation[t]=this._context.gl.getUniformLocation(this.glName,t)),this._nameToUniformLocation[t]}hasUniform(t){return this._getUniformLocation(t)!==null}setUniform1i(t,i){const r=this._nameToUniform1[t];(r===void 0||i!==r)&&(this._context.gl.uniform1i(this._getUniformLocation(t),i),this._nameToUniform1[t]=i)}setUniform1iv(t,i){const r=this._nameToUniform1v[t];tp(r,i)&&(this._context.gl.uniform1iv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform1v[t]=Array.from(i):Cd(i,r))}setUniform2iv(t,i){const r=this._nameToUniform2[t];tp(r,i)&&(this._context.gl.uniform2iv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform2[t]=Array.from(i):Cd(i,r))}setUniform3iv(t,i){const r=this._nameToUniform3[t];tp(r,i)&&(this._context.gl.uniform3iv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform3[t]=Array.from(i):Cd(i,r))}setUniform4iv(t,i){const r=this._nameToUniform4[t];tp(r,i)&&(this._context.gl.uniform4iv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform4[t]=Array.from(i):Cd(i,r))}setUniform1f(t,i){const r=this._nameToUniform1[t];(r===void 0||i!==r)&&(this._context.gl.uniform1f(this._getUniformLocation(t),i),this._nameToUniform1[t]=i)}setUniform1fv(t,i){const r=this._nameToUniform1v[t];tp(r,i)&&(this._context.gl.uniform1fv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform1v[t]=Array.from(i):Cd(i,r))}setUniform2f(t,i,r){const s=this._nameToUniform2[t];(s===void 0||i!==s[0]||r!==s[1])&&(this._context.gl.uniform2f(this._getUniformLocation(t),i,r),s===void 0?this._nameToUniform2[t]=[i,r]:(s[0]=i,s[1]=r))}setUniform2fv(t,i){const r=this._nameToUniform2[t];tp(r,i)&&(this._context.gl.uniform2fv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform2[t]=Array.from(i):Cd(i,r))}setUniform3f(t,i,r,s){const n=this._nameToUniform3[t];(n===void 0||i!==n[0]||r!==n[1]||s!==n[2])&&(this._context.gl.uniform3f(this._getUniformLocation(t),i,r,s),n===void 0?this._nameToUniform3[t]=[i,r,s]:(n[0]=i,n[1]=r,n[2]=s))}setUniform3fv(t,i){const r=this._nameToUniform3[t];tp(r,i)&&(this._context.gl.uniform3fv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform3[t]=Array.from(i):Cd(i,r))}setUniform4f(t,i,r,s,n){const o=this._nameToUniform4[t];(o===void 0||i!==o[0]||r!==o[1]||s!==o[2]||n!==o[3])&&(this._context.gl.uniform4f(this._getUniformLocation(t),i,r,s,n),o===void 0?this._nameToUniform4[t]=[i,r,s,n]:(o[0]=i,o[1]=r,o[2]=s,o[3]=n))}setUniform4fv(t,i){const r=this._nameToUniform4[t];tp(r,i)&&(this._context.gl.uniform4fv(this._getUniformLocation(t),i),r===void 0?this._nameToUniform4[t]=Array.from(i):Cd(i,r))}setUniformMatrix3fv(t,i,r=!1){const s=this._nameToUniformMatrix3[t];zht(s,i)&&(this._context.gl.uniformMatrix3fv(this._getUniformLocation(t),r,i),s===void 0?this._nameToUniformMatrix3[t]=Array.from(i):Cd(i,s))}setUniformMatrix4fv(t,i,r=!1){const s=this._nameToUniformMatrix4[t];Bht(s,i)&&(this._context.gl.uniformMatrix4fv(this._getUniformLocation(t),r,i),s===void 0?this._nameToUniformMatrix4[t]=Array.from(i):Cd(i,s))}stop(){}}function tp(e,t){if(R(e)||e.length!==t.length)return!0;for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!0;return!1}function bne(e,t,i){const r=e.gl,s=r.createShader(t);return r.shaderSource(s,i),r.compileShader(s),aR()&&!r.getShaderParameter(s,r.COMPILE_STATUS)&&(console.error("Compile error in ".concat(t===nc.VERTEX_SHADER?"vertex":"fragment"," shader")),console.error(r.getShaderInfoLog(s)),console.error(Uht(i)),e.type===Kt.WEBGL2&&(console.log("Shader source before transpilation:"),console.log(i))),s}function Uht(e){let t=2;return e.replace(/\n/g,()=>`
`+kht(t++)+":")}function kht(e){return e>=1e3?e.toString():("  "+e).slice(-3)}function Cd(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}function zht(e,t){return!!R(e)||(e.length!==9?tp(e,t):e.length!==9||e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3]||e[4]!==t[4]||e[5]!==t[5]||e[6]!==t[6]||e[7]!==t[7]||e[8]!==t[8])}function Bht(e,t){return!!R(e)||(e.length!==16?tp(e,t):e.length!==16||e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3]||e[4]!==t[4]||e[5]!==t[5]||e[6]!==t[6]||e[7]!==t[7]||e[8]!==t[8]||e[9]!==t[9]||e[10]!==t[10]||e[11]!==t[11]||e[12]!==t[12]||e[13]!==t[13]||e[14]!==t[14]||e[15]!==t[15])}class Vht{constructor(t){this._rctx=t,this._store=new RW}dispose(){this._store.forEach(t=>t.forEach(i=>i.dispose())),this._store.clear()}acquire(t,i,r,s){const n=this._store.get(t,i);if(_(n))return n.ref(),n;const o=new Fht(this._rctx,t,i,r,s);return o.ref(),this._store.set(t,i,o),o}get test(){let t=0;return this._store.forEach(i=>i.forEach(r=>t+=r.hasGLName?2:1)),{cachedWebGLObjects:t}}}class wne{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:Ee.ONE,dstRGB:Ee.ZERO,srcAlpha:Ee.ONE,dstAlpha:Ee.ZERO},this.blendEquation={mode:Cp.ADD,modeAlpha:Cp.ADD},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=ba.BACK,this.frontFace=XT.CCW,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=Li.LESS,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:ba.FRONT_AND_BACK,func:Li.ALWAYS,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:ba.FRONT_AND_BACK,fail:Ui.KEEP,zFail:Ui.KEEP,zPass:Ui.KEEP},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.uniformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array}}class Ght{constructor(t){this._allocations=new Map,t?Error.stackTraceLimit=1/0:(this.add=()=>{},this.remove=()=>{})}add(t){this._allocations.set(t,new Error().stack)}remove(t){this._allocations.delete(t)}print(){if(this._allocations.size>0){console.log(`${this._allocations.size} live object allocations:`);const t=new Map;this._allocations.forEach(i=>{var r;t.set(i,((r=t.get(i))!=null?r:0)+1)}),t.forEach((i,r)=>{const s=r.split(`
`);s.shift(),s.shift(),console.log(`${i}: ${s.shift()}`),s.forEach(n=>console.log("   ",n))})}}}class jht{constructor(){this.RECORD_ALLOCATIONS=!1}}const Hht=new jht;class qht{constructor(){for(this._current=new Array,this._max=new Array,this._allocations=new Ght(Hht.RECORD_ALLOCATIONS);this._current.length<ks.COUNT;)this._current.push(0),this._max.push(0)}resetMax(){for(this._max.length=0;this._max.length<this._current.length;)this._max.push(0)}increment(t,i){const r=++this._current[t];this._max[t]=Math.max(r,this._max[t]),this._allocations.add(i)}decrement(t,i){--this._current[t],this._allocations.remove(i)}get max(){return this._max}get current(){return this._current}get total(){return this.current.reduce((t,i)=>t+i,0)}printResourceCount(){if(this.total>0){console.log("Live objects:");for(let t=0;t<ks.COUNT;++t){const i=this._current[t];i>0&&console.log(`${ks[t]}: ${i}`)}}this._allocations.print()}}function xne(e,t){const i=new zi(e,{colorTarget:vr.TEXTURE,depthStencilTarget:ti.NONE},{target:st.TEXTURE_2D,wrapMode:ct.CLAMP_TO_EDGE,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.NEAREST,width:1,height:1});function r(w,S){const T=`

  precision highp float;

  attribute vec2 position;

  uniform vec3 u_highA;
  uniform vec3 u_lowA;
  uniform vec3 u_highB;
  uniform vec3 u_lowB;

  varying vec4 v_color;

  ${t?"#define DOUBLE_PRECISION_REQUIRES_OBFUSCATION":""}

  #ifdef DOUBLE_PRECISION_REQUIRES_OBFUSCATION

  vec3 dpPlusFrc(vec3 a, vec3 b) {
    return mix(a, a + b, vec3(notEqual(b, vec3(0))));
  }

  vec3 dpMinusFrc(vec3 a, vec3 b) {
    return mix(vec3(0), a - b, vec3(notEqual(a, b)));
  }

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = dpPlusFrc(hiA, hiB);
    vec3 e = dpMinusFrc(t1, hiA);
    vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
    return t1 + t2;
  }

  #else

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = hiA + hiB;
    vec3 e = t1 - hiA;
    vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
    return t1 + t2;
  }

  #endif

  const float MAX_RGBA_FLOAT =
    255.0 / 256.0 +
    255.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 / 256.0;

  const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);

  vec4 float2rgba(const float value) {
    // Make sure value is in the domain we can represent
    float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);

    // Decompose value in 32bit fixed point parts represented as
    // uint8 rgba components. Decomposition uses the fractional part after multiplying
    // by a power of 256 (this removes the bits that are represented in the previous
    // component) and then converts the fractional part to 8bits.
    vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);

    // Convert uint8 values (from 0 to 255) to floating point representation for
    // the shader
    const float toU8AsFloat = 1.0 / 255.0;

    return fixedPointU8 * toU8AsFloat;
  }

  void main() {
    vec3 val = dpAdd(u_highA, u_lowA, -u_highB, -u_lowB);

    v_color = float2rgba(val.z / 25.0);

    gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);
  }
  `,A=`
  precision highp float;

  varying vec4 v_color;

  void main() {
    gl_FragColor = v_color;
  }
  `,C=e.programCache.acquire(T,A,new Map([["position",0]])),O=new Float32Array(6);AL(w,O,3);const L=new Float32Array(6);return AL(S,L,3),e.useProgram(C),C.setUniform3f("u_highA",O[0],O[2],O[4]),C.setUniform3f("u_lowA",O[1],O[3],O[5]),C.setUniform3f("u_highB",L[0],L[2],L[4]),C.setUniform3f("u_lowB",L[1],L[3],L[5]),C}const s=jt.createVertex(e,ri.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),n=new us(e,new Map([["position",0]]),{geometry:[new bn("position",2,ot.UNSIGNED_SHORT,0,4)]},{geometry:s}),o=je(5633261287538229e-9,2626832878767164e-9,1.4349880495278358e6),a=je(563327146742708e-8,2.6268736381334523e6,1434963231608387e-9),l=r(o,a),c=e.getBoundFramebufferObject(),{x:h,y:p,width:f,height:g}=e.getViewport();e.bindFramebuffer(i),e.setViewport(0,0,1,1),e.bindVAO(n),e.drawArrays(Tt.TRIANGLE_STRIP,0,4);const y=new Uint8Array(4);i.readPixels(0,0,1,1,$e.RGBA,yt.UNSIGNED_BYTE,y),l.dispose(),n.dispose(!1),s.dispose(),i.dispose(),e.setViewport(h,p,f,g),e.bindFramebuffer(c);const v=(o[2]-a[2])/25,b=uW(y);return Math.abs(v-b)}var Tne,Sne,Ene,Cbe={exports:{}};function Wht(e){var t,i,r,s,n;if(!e.gl)return!1;if(e.type===Kt.WEBGL1)return!((s=e.capabilities.textureFloat)==null||!s.textureFloat||(n=e.capabilities.colorBufferFloat)==null||!n.textureFloat);if(!(((t=e.capabilities.textureFloat)==null?void 0:t.textureFloat)&&((i=e.capabilities.colorBufferFloat)==null?void 0:i.textureFloat)&&((r=e.capabilities.colorBufferFloat)==null?void 0:r.floatBlend)))return!1;const o=new zi(e,{colorTarget:vr.TEXTURE,depthStencilTarget:ti.NONE},{target:st.TEXTURE_2D,wrapMode:ct.CLAMP_TO_EDGE,pixelFormat:$e.RGBA,dataType:yt.FLOAT,internalFormat:nt.RGBA32F,samplingMode:Ge.NEAREST,width:1,height:1}),a=jt.createVertex(e,ri.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),l=new us(e,new Map([["a_pos",0]]),{geometry:[new bn("a_pos",2,ot.UNSIGNED_SHORT,0,4)]},{geometry:a}),c=`
  precision highp float;
  attribute vec2 a_pos;

  void main() {
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
  }
  `,h=`
   precision highp float;

   void main() {
    gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);
   }
  `,p=e.programCache.acquire(c,h,new Map([["a_pos",0]]));e.useProgram(p);const f=e.getBoundFramebufferObject(),{x:g,y,width:v,height:b}=e.getViewport();e.bindFramebuffer(o),e.setViewport(0,0,1,1),e.bindVAO(l),e.drawArrays(Tt.TRIANGLE_STRIP,0,4);const w=Ot({blending:z0e});e.setPipelineState(w),e.drawArrays(Tt.TRIANGLE_STRIP,0,4),Cbe.exports.init(e);const S=e.gl.getError();return e.setViewport(g,y,v,b),e.bindFramebuffer(f),p.dispose(),l.dispose(!1),a.dispose(),o.dispose(),S!==1282||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}Tne=Cbe,Sne=function(){var e=function(v){window.console&&window.console.log&&window.console.log(v)},t=function(v){window.console&&window.console.error?window.console.error(v):e(v)},i={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},r=null,s=null;function n(v){if(r==null)for(var b in r={},s={},v)typeof v[b]=="number"&&(r[v[b]]=b,s[b]=v[b])}function o(){if(r==null)throw"WebGLDebugUtils.init(ctx) not called"}function a(v){return o(),r[v]!==void 0}function l(v){o();var b=r[v];return b!==void 0?"gl."+b:"/*UNKNOWN WebGL ENUM*/ 0x"+v.toString(16)}function c(v,b,w,S){var T;if((T=i[v])!==void 0&&(T=T[b])!==void 0&&T[w]){if(typeof T[w]=="object"&&T[w].enumBitwiseOr!==void 0){for(var A=T[w].enumBitwiseOr,C=0,O=[],L=0;L<A.length;++L){var U=s[A[L]];(S&U)!=0&&(C|=U,O.push(l(U)))}return C===S?O.join(" | "):l(S)}return l(S)}return S===null?"null":S===void 0?"undefined":S.toString()}function h(v,b){for(var w="",S=b.length,T=0;T<S;++T)w+=(T==0?"":", ")+c(v,S,T,b[T]);return w}function p(v,b,w){v.__defineGetter__(w,function(){return b[w]}),v.__defineSetter__(w,function(S){b[w]=S})}function f(v,b,w,S){S=S||v,n(v),b=b||function(U,N,z){for(var V="",B=z.length,J=0;J<B;++J)V+=(J==0?"":", ")+c(N,B,J,z[J]);t("WebGL error "+l(U)+" in "+N+"("+V+")")};var T={};function A(U,N){return function(){w&&w(N,arguments);var z=U[N].apply(U,arguments),V=S.getError();return V!=0&&(T[V]=!0,b(V,N,arguments)),z}}var C={};for(var O in v)if(typeof v[O]=="function")if(O!="getExtension")C[O]=A(v,O);else{var L=A(v,O);C[O]=function(){return f(L.apply(v,arguments),b,w,S)}}else p(C,v,O);return C.getError=function(){for(var U in T)if(T.hasOwnProperty(U)&&T[U])return T[U]=!1,U;return v.NO_ERROR},C}function g(v){var b=v.getParameter(v.MAX_VERTEX_ATTRIBS),w=v.createBuffer();v.bindBuffer(v.ARRAY_BUFFER,w);for(var S=0;S<b;++S)v.disableVertexAttribArray(S),v.vertexAttribPointer(S,4,v.FLOAT,!1,0,0),v.vertexAttrib1f(S,0);v.deleteBuffer(w);var T=v.getParameter(v.MAX_TEXTURE_IMAGE_UNITS);for(S=0;S<T;++S)v.activeTexture(v.TEXTURE0+S),v.bindTexture(v.TEXTURE_CUBE_MAP,null),v.bindTexture(v.TEXTURE_2D,null);for(v.activeTexture(v.TEXTURE0),v.useProgram(null),v.bindBuffer(v.ARRAY_BUFFER,null),v.bindBuffer(v.ELEMENT_ARRAY_BUFFER,null),v.bindFramebuffer(v.FRAMEBUFFER,null),v.bindRenderbuffer(v.RENDERBUFFER,null),v.disable(v.BLEND),v.disable(v.CULL_FACE),v.disable(v.DEPTH_TEST),v.disable(v.DITHER),v.disable(v.SCISSOR_TEST),v.blendColor(0,0,0,0),v.blendEquation(v.FUNC_ADD),v.blendFunc(v.ONE,v.ZERO),v.clearColor(0,0,0,0),v.clearDepth(1),v.clearStencil(-1),v.colorMask(!0,!0,!0,!0),v.cullFace(v.BACK),v.depthFunc(v.LESS),v.depthMask(!0),v.depthRange(0,1),v.frontFace(v.CCW),v.hint(v.GENERATE_MIPMAP_HINT,v.DONT_CARE),v.lineWidth(1),v.pixelStorei(v.PACK_ALIGNMENT,4),v.pixelStorei(v.UNPACK_ALIGNMENT,4),v.pixelStorei(v.UNPACK_FLIP_Y_WEBGL,!1),v.pixelStorei(v.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),v.UNPACK_COLORSPACE_CONVERSION_WEBGL&&v.pixelStorei(v.UNPACK_COLORSPACE_CONVERSION_WEBGL,v.BROWSER_DEFAULT_WEBGL),v.polygonOffset(0,0),v.sampleCoverage(1,!1),v.scissor(0,0,v.canvas.width,v.canvas.height),v.stencilFunc(v.ALWAYS,0,4294967295),v.stencilMask(4294967295),v.stencilOp(v.KEEP,v.KEEP,v.KEEP),v.viewport(0,0,v.canvas.width,v.canvas.height),v.clear(v.COLOR_BUFFER_BIT|v.DEPTH_BUFFER_BIT|v.STENCIL_BUFFER_BIT);v.getError(););}function y(v){var b,w,S=[],T=[],A={},C=1,O=!1,L=[],U=0,N=0,z=!1,V=0,B={};function J(H){return typeof H=="function"?H:function(ee){H.handleEvent(ee)}}v.getContext=(w=v.getContext,function(){var H=w.apply(v,arguments);if(H instanceof WebGLRenderingContext){if(H!=b){if(b)throw"got different context";A=K(b=H)}return A}return H});var Q=function(H){S.push(J(H))},te=function(H){T.push(J(H))};function ie(H){var ee=H.addEventListener;H.addEventListener=function(ye,Ae,Ve){switch(ye){case"webglcontextlost":Q(Ae);break;case"webglcontextrestored":te(Ae);break;default:ee.apply(H,arguments)}}}function $(){for(var H=Object.keys(B),ee=0;ee<H.length;++ee)delete B[H]}function F(){++N,O||U==N&&v.loseContext()}function k(H,ee){var ye=H[ee];return function(){if(F(),!O)return ye.apply(H,arguments)}}function G(){for(var H=0;H<L.length;++H){var ee=L[H];ee instanceof WebGLBuffer?b.deleteBuffer(ee):ee instanceof WebGLFramebuffer?b.deleteFramebuffer(ee):ee instanceof WebGLProgram?b.deleteProgram(ee):ee instanceof WebGLRenderbuffer?b.deleteRenderbuffer(ee):ee instanceof WebGLShader?b.deleteShader(ee):ee instanceof WebGLTexture&&b.deleteTexture(ee)}}function W(H){return{statusMessage:H,preventDefault:function(){z=!0}}}return ie(v),v.loseContext=function(){if(!O){for(O=!0,U=0,++C;b.getError(););$(),B[b.CONTEXT_LOST_WEBGL]=!0;var H=W("context lost"),ee=S.slice();setTimeout(function(){for(var ye=0;ye<ee.length;++ye)ee[ye](H);V>=0&&setTimeout(function(){v.restoreContext()},V)},0)}},v.restoreContext=function(){O&&T.length&&setTimeout(function(){if(!z)throw"can not restore. webglcontestlost listener did not call event.preventDefault";G(),g(b),O=!1,N=0,z=!1;for(var H=T.slice(),ee=W("context restored"),ye=0;ye<H.length;++ye)H[ye](ee)},0)},v.loseContextInNCalls=function(H){if(O)throw"You can not ask a lost contet to be lost";U=N+H},v.getNumCalls=function(){return N},v.setRestoreTimeout=function(H){V=H},v;function K(H){for(var ee in H)typeof H[ee]=="function"?A[ee]=k(H,ee):p(A,H,ee);A.getError=function(){if(F(),!O)for(;Re=b.getError();)B[Re]=!0;for(var Re in B)if(B[Re])return delete B[Re],Re;return A.NO_ERROR};for(var ye=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],Ae=0;Ae<ye.length;++Ae){var Ve=ye[Ae];A[Ve]=function(Re){return function(){if(F(),O)return null;var ze=Re.apply(H,arguments);return ze.__webglDebugContextLostId__=C,L.push(ze),ze}}(H[Ve])}var Se=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(Ae=0;Ae<Se.length;++Ae)Ve=Se[Ae],A[Ve]=function(Re){return function(){return F(),O?null:Re.apply(H,arguments)}}(A[Ve]);var xe=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(Ae=0;Ae<xe.length;++Ae)Ve=xe[Ae],A[Ve]=function(Re){return function(){return F(),!O&&Re.apply(H,arguments)}}(A[Ve]);return A.checkFramebufferStatus=function(Re){return function(){return F(),O?A.FRAMEBUFFER_UNSUPPORTED:Re.apply(H,arguments)}}(A.checkFramebufferStatus),A.getAttribLocation=function(Re){return function(){return F(),O?-1:Re.apply(H,arguments)}}(A.getAttribLocation),A.getVertexAttribOffset=function(Re){return function(){return F(),O?0:Re.apply(H,arguments)}}(A.getVertexAttribOffset),A.isContextLost=function(){return O},A}}return{init:n,mightBeEnum:a,glEnumToString:l,glFunctionArgToString:c,glFunctionArgsToString:h,makeDebugContext:f,makeLostContextSimulatingCanvas:y,resetToInitialState:g}},(Ene=Sne())!==void 0&&(Tne.exports=Ene);const Xht=he.getLogger("esri.views.WebGLDriverTest");function Yht(e){const t=new zi(e,{colorTarget:vr.TEXTURE,depthStencilTarget:ti.NONE},{target:st.TEXTURE_2D,wrapMode:ct.CLAMP_TO_EDGE,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.NEAREST,width:1,height:1}),i=`
precision highp float;
attribute vec2 a_pos;
uniform highp sampler2D u_texture;
varying vec4 v_color;

float getBit(in float bitset, in int bitIndex) {
  float offset = pow(2.0, float(bitIndex));
  return mod(floor(bitset / offset), 2.0);
}

void main() {
  vec4 value = texture2D(u_texture, vec2(0.0));
  float bit = getBit(value.x * 255.0, 1);

  v_color = bit * vec4(1.0);
  gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`,r=`
precision highp float;
varying vec4 v_color;

void main() {
  gl_FragColor = v_color;
}
`,s=new Uint8Array(4),n=jt.createVertex(e,ri.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),o=new us(e,new Map([["a_position",0]]),{geometry:[new bn("a_position",2,ot.SHORT,0,4)]},{geometry:n}),a=e.programCache.acquire(i,r,new Map([["a_pos",0]]));e.useProgram(a);const l=new Qe(e,{target:st.TEXTURE_2D,wrapMode:ct.CLAMP_TO_EDGE,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.NEAREST,width:1,height:1},new Uint8Array([2,255,0,0]));a.setUniform1i("u_texture",0),e.bindTexture(l,0);const c=e.getBoundFramebufferObject();e.bindFramebuffer(t),e.useProgram(a);const{x:h,y:p,width:f,height:g}=e.getViewport();e.setViewport(0,0,1,1),e.bindVAO(o),e.drawArrays(Tt.TRIANGLE_STRIP,0,4),e.setViewport(h,p,f,g),t.readPixels(0,0,1,1,$e.RGBA,yt.UNSIGNED_BYTE,s),a.dispose(),o.dispose(!1),n.dispose(),t.dispose();const y=s[0]!==255||s[1]!==255||s[2]!==255||s[3]!==255;return y&&Xht.warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${s[0]}.${s[1]}.${s[2]}.${s[3]}]`),e.bindFramebuffer(c),y}new bn("a_pos",2,ot.BYTE,0,2);new bn("a_pos",2,ot.BYTE,0,4),new bn("a_tex",2,ot.BYTE,2,4);const Zht={geometry:[new bn("a_pos",2,ot.UNSIGNED_SHORT,0,4)]};async function Qht(e){const t=new Image;if(t.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",t.width=5,t.height=5,await t.decode(),!e.gl)return!0;const i=new zi(e,{colorTarget:vr.TEXTURE,depthStencilTarget:ti.NONE},{target:st.TEXTURE_2D,wrapMode:ct.CLAMP_TO_EDGE,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,samplingMode:Ge.NEAREST,width:1,height:1}),r=jt.createVertex(e,ri.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),s=new us(e,new Map([["a_pos",0]]),Zht,{geometry:r}),n=`
  precision highp float;

  attribute vec2 a_pos;
  varying vec2 v_uv;

  void main() {
    v_uv = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
  }
  `,o=`
  precision highp float;

  varying vec2 v_uv;
  uniform sampler2D u_texture;

  void main() {
    gl_FragColor = texture2D(u_texture, v_uv);
  }
  `,a=e.programCache.acquire(n,o,new Map([["a_pos",0]]));e.useProgram(a);const l=new Qe(e,{dataType:yt.UNSIGNED_BYTE,pixelFormat:$e.RGBA,preMultiplyAlpha:!1,wrapMode:ct.CLAMP_TO_EDGE,samplingMode:Ge.LINEAR},t);e.bindTexture(l,0),a.setUniform1i("u_texture",0);const c=e.getBoundFramebufferObject(),{x:h,y:p,width:f,height:g}=e.getViewport();e.bindFramebuffer(i),e.setViewport(0,0,1,1),e.setClearColor(0,0,0,0),e.setBlendingEnabled(!1),e.clearSafe(bi.COLOR_BUFFER_BIT),e.bindVAO(s),e.drawArrays(Tt.TRIANGLE_STRIP,0,4);const y=new Uint8Array(4);return i.readPixels(0,0,1,1,$e.RGBA,yt.UNSIGNED_BYTE,y),a.dispose(),s.dispose(!1),r.dispose(),i.dispose(),l.dispose(),e.setViewport(h,p,f,g),e.bindFramebuffer(c),t.src="",y[0]===255}class Jht{constructor(t){this.context=t,this._floatBufferBlendWorking=Wht(t),Qht(t).then(i=>this._svgAlwaysPremultipliesAlpha=!i)}get floatBufferBlendWorking(){if(R(this._floatBufferBlendWorking))throw new Error("floatBufferBlendWorking test not yet available");return this._floatBufferBlendWorking}get svgAlwaysPremultipliesAlpha(){if(R(this._svgAlwaysPremultipliesAlpha))throw new Error("svgAlwaysPremultipliesAlpha test not yet available");return this._svgAlwaysPremultipliesAlpha}get doublePrecisionRequiresObfuscation(){if(R(this._doublePrecisionRequiresObfuscation)){const t=xne(this.context,!1),i=xne(this.context,!0);this._doublePrecisionRequiresObfuscation=t!==0&&(i===0||t/i>5)}return this._doublePrecisionRequiresObfuscation}get ignoresSamplerPrecision(){return R(this._ignoresSamplerPrecision)&&(this._ignoresSamplerPrecision=Yht(this.context)),this._ignoresSamplerPrecision}}class Ane{constructor(t,i,r,s,n,o,a,l){this.createQuery=t,this.resultAvailable=i,this.getResult=r,this.disjoint=s,this.beginTimeElapsed=n,this.endTimeElapsed=o,this.createTimestamp=a,this.timestampBits=l}}function Kht(e,t){if(t.disjointTimerQuery)return null;let i=e.getExtension("EXT_disjoint_timer_query_webgl2");return i&&Zs(e)?new Ane(()=>e.createQuery(),r=>e.getQueryParameter(r,e.QUERY_RESULT_AVAILABLE),r=>e.getQueryParameter(r,e.QUERY_RESULT),()=>e.getParameter(i.GPU_DISJOINT_EXT),r=>e.beginQuery(i.TIME_ELAPSED_EXT,r),()=>e.endQuery(i.TIME_ELAPSED_EXT),r=>i.queryCounterEXT(r,i.TIMESTAMP_EXT),()=>e.getQuery(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT)):(i=e.getExtension("EXT_disjoint_timer_query"),i?new Ane(()=>i.createQueryEXT(),r=>i.getQueryObjectEXT(r,i.QUERY_RESULT_AVAILABLE_EXT),r=>i.getQueryObjectEXT(r,i.QUERY_RESULT_EXT),()=>e.getParameter(i.GPU_DISJOINT_EXT),r=>i.beginQueryEXT(i.TIME_ELAPSED_EXT,r),()=>i.endQueryEXT(i.TIME_ELAPSED_EXT),r=>i.queryCounterEXT(r,i.TIMESTAMP_EXT),()=>i.getQueryEXT(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT)):null)}function edt(e,t){if(t.disjointTimerQuery)return null;if(Zs(e))return{drawBuffers:e.drawBuffers.bind(e),MAX_DRAW_BUFFERS:e.MAX_DRAW_BUFFERS,MAX_COLOR_ATTACHMENTS:e.MAX_COLOR_ATTACHMENTS};if(t.drawBuffers)return null;const i=e.getExtension("WEBGL_draw_buffers");return i?{drawBuffers:i.drawBuffersWEBGL.bind(i),MAX_DRAW_BUFFERS:i.MAX_DRAW_BUFFERS_WEBGL,MAX_COLOR_ATTACHMENTS:i.MAX_COLOR_ATTACHMENTS_WEBGL}:null}function tdt(e){if(Zs(e))return{drawArraysInstanced:e.drawArraysInstanced.bind(e),drawElementsInstanced:e.drawElementsInstanced.bind(e),vertexAttribDivisor:e.vertexAttribDivisor.bind(e)};const t=e.getExtension("ANGLE_instanced_arrays");return t?{drawArraysInstanced:t.drawArraysInstancedANGLE.bind(t),drawElementsInstanced:t.drawElementsInstancedANGLE.bind(t),vertexAttribDivisor:t.vertexAttribDivisorANGLE.bind(t)}:null}function idt(e,t){if(t.compressedTextureETC)return null;const i=e.getExtension("WEBGL_compressed_texture_etc");return i?{COMPRESSED_R11_EAC:i.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:i.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:i.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:i.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:i.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:i.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}function rdt(e,t){if(t.compressedTextureS3TC)return null;const i=e.getExtension("WEBGL_compressed_texture_s3tc");return i?{COMPRESSED_RGB_S3TC_DXT1:i.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:i.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:i.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:i.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}function sdt(e,t){if(Zs(e))return{MIN:e.MIN,MAX:e.MAX};if(t.blendMinMax)return null;{const i=e.getExtension("EXT_blend_minmax");return i?{MIN:i.MIN_EXT,MAX:i.MAX_EXT}:null}}function ndt(e,t){if(t.textureFilterAnisotropic)return null;const i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return i?{MAX_TEXTURE_MAX_ANISOTROPY:i.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:i.TEXTURE_MAX_ANISOTROPY_EXT}:null}function odt(e,t){if(Zs(e))return{textureFloat:!0,textureFloatLinear:!t.textureFloatLinear&&!!e.getExtension("OES_texture_float_linear"),textureHalfFloat:!0,textureHalfFloatLinear:!t.textureHalfFloatLinear&&!!e.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:e.HALF_FLOAT,R16F:e.R16F,RG16F:e.RG16F,RGBA16F:e.RGBA16F,R32F:e.R32F,RG32F:e.RG32F,RGBA32F:e.RGBA32F,R11F_G11F_B10F:e.R11F_G11F_B10F,RGB16F:e.RGB16F};if(e instanceof WebGLRenderingContext){const i=!t.textureHalfFloat&&e.getExtension("OES_texture_half_float");return{textureFloat:!t.textureFloat&&!!e.getExtension("OES_texture_float"),textureFloatLinear:!t.textureFloatLinear&&!!e.getExtension("OES_texture_float_linear"),textureHalfFloat:!!i,textureHalfFloatLinear:!t.textureHalfFloatLinear&&!!e.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:i?i.HALF_FLOAT_OES:void 0}}return null}function adt(e,t){if(Zs(e)){const i=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_half_float"),r=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),s=!t.floatBlend&&!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return i||r||s?{textureFloat:!!r,textureHalfFloat:!!i,floatBlend:!!s,R16F:e.R16F,RG16F:e.RG16F,RGBA16F:e.RGBA16F,R32F:e.R32F,RG32F:e.RG32F,RGBA32F:e.RGBA32F,R11F_G11F_B10F:e.R11F_G11F_B10F,RGB16F:e.RGB16F}:null}if(e instanceof WebGLRenderingContext){const i=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_half_float"),r=!t.colorBufferFloat&&e.getExtension("WEBGL_color_buffer_float"),s=!t.floatBlend&&!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return i||r||s?{textureFloat:!!r,textureHalfFloat:!!i,floatBlend:!!s,RGBA16F:i?i.RGBA16F_EXT:void 0,RGB16F:i?i.RGB16F_EXT:void 0,RGBA32F:r?r.RGBA32F_EXT:void 0}:null}return null}function qP(e,t,i,r,s){if(r&&Zs(e))return!0;if(t[i])return!1;for(const n of s)if(e.getExtension(n))return!0;return!1}function ldt(e,t){if(!Zs(e)||t.textureNorm16)return null;const i=e.getExtension("EXT_texture_norm16");return i?{R16:i.R16_EXT,RG16:i.RG16_EXT,RGB16:i.RGB16_EXT,RGBA16:i.RGBA16_EXT,R16_SNORM:i.R16_SNORM_EXT,RG16_SNORM:i.RG16_SNORM_EXT,RGB16_SNORM:i.RGB16_SNORM_EXT,RGBA16_SNORM:i.RGBA16_SNORM_EXT}:null}function cdt(e,t){const i=t.loseContext&&e.getExtension("WEBGL_lose_context");return i?{loseRenderingContext:()=>i.loseContext()}:null}function udt(e,t){if(Zs(e))return{createVertexArray:e.createVertexArray.bind(e),deleteVertexArray:e.deleteVertexArray.bind(e),bindVertexArray:e.bindVertexArray.bind(e)};if(t.vao)return null;const i=e.getExtension("OES_vertex_array_object")||e.getExtension("MOZ_OES_vertex_array_object")||e.getExtension("WEBKIT_OES_vertex_array_object");return i?{createVertexArray:i.createVertexArrayOES.bind(i),deleteVertexArray:i.deleteVertexArrayOES.bind(i),bindVertexArray:i.bindVertexArrayOES.bind(i)}:null}class hdt{constructor(t,i){this.gl=t,this._depthTexture=null,this._standardDerivatives=null,this._shaderTextureLOD=null,this._fragDepth=null,this._disabledExtensions=i.disabledExtensions||{},this._debugWebGLExtensions=i.debugWebGLExtensions||{}}get drawBuffers(){return this._drawBuffers||(this._drawBuffers=edt(this.gl,this._disabledExtensions)),this._drawBuffers}get instancing(){return this._instancing||(this._instancing=tdt(this.gl)),this._instancing}get vao(){return this._vertexArrayObject||(this._vertexArrayObject=udt(this.gl,this._disabledExtensions)),this._vertexArrayObject}get compressedTextureETC(){return this._compressedTextureETC||(this._compressedTextureETC=idt(this.gl,this._disabledExtensions)),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC||(this._compressedTextureS3TC=rdt(this.gl,this._disabledExtensions)),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic||(this._textureFilterAnisotropic=ndt(this.gl,this._disabledExtensions)),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery||(this._disjointTimerQuery=Kht(this.gl,this._disabledExtensions)),this._disjointTimerQuery}get textureFloat(){return this._textureFloat||(this._textureFloat=odt(this.gl,this._disabledExtensions)),this._textureFloat}get colorBufferFloat(){return this._colorBufferFloat||(this._colorBufferFloat=adt(this.gl,this._disabledExtensions)),this._colorBufferFloat}get blendMinMax(){return this._minMaxBlending||(this._minMaxBlending=sdt(this.gl,this._disabledExtensions)),this._minMaxBlending}get depthTexture(){return this._depthTexture===null&&(this._depthTexture=qP(this.gl,this._disabledExtensions,"depthTexture",!0,["WEBGL_depth_texture","MOZ_WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"])),this._depthTexture}get standardDerivatives(){return this._standardDerivatives===null&&(this._standardDerivatives=qP(this.gl,this._disabledExtensions,"standardDerivatives",!0,["OES_standard_derivatives"])),this._standardDerivatives}get shaderTextureLOD(){return this._shaderTextureLOD===null&&(this._shaderTextureLOD=qP(this.gl,this._disabledExtensions,"shaderTextureLOD",!0,["EXT_shader_texture_lod"])),this._shaderTextureLOD}get fragDepth(){return this._fragDepth===null&&(this._fragDepth=qP(this.gl,this._disabledExtensions,"fragDepth",!0,["EXT_frag_depth"])),this._fragDepth}get loseContext(){return this._loseContext||(this._loseContext=cdt(this.gl,this._debugWebGLExtensions)),this._loseContext}get textureNorm16(){return this._textureNorm16||(this._textureNorm16=ldt(this.gl,this._disabledExtensions)),this._textureNorm16}enable(t){return this[t]}}class ddt{constructor(t,i){this.gl=t,this.instanceCounter=new qht,this.programCache=new Vht(this),this._state=new wne,this._numOfDrawCalls=0,this._numOfTriangles=0,this.type=Zs(t)?Kt.WEBGL2:Kt.WEBGL1,this._loadExtensions(),this.configure(i)}configure(t){this._capabilities=new hdt(this.gl,t),this._parameters=this._loadParameters(t);const i=this.gl.getParameter(this.gl.VIEWPORT);this._state=new wne,this._state.viewport={x:i[0],y:i[1],width:i[2],height:i[3]},this._stateTracker=new g8e({setBlending:r=>{if(r){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(r.opRgb,r.opAlpha),this.setBlendFunctionSeparate(r.srcRgb,r.dstRgb,r.srcAlpha,r.dstAlpha);const s=r.color;this.setBlendColor(s.r,s.g,s.b,s.a)}else this.setBlendingEnabled(!1)},setCulling:r=>{r?(this.setFaceCullingEnabled(!0),this.setCullFace(r.face),this.setFrontFace(r.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:r=>{r?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(r.factor,r.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:r=>{r?(this.setDepthTestEnabled(!0),this.setDepthFunction(r.func)):this.setDepthTestEnabled(!1)},setStencilTest:r=>{if(r){this.setStencilTestEnabled(!0);const s=r.function;this.setStencilFunction(s.func,s.ref,s.mask);const n=r.operation;this.setStencilOp(n.fail,n.zFail,n.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:r=>{r?(this.setDepthWriteEnabled(!0),this.setDepthRange(r.zNear,r.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:r=>{r?this.setColorMask(r.r,r.g,r.b,r.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:r=>{r?this.setStencilWriteMask(r.mask):this.setStencilWriteMask(0)}}),this.enforceState(),this._driverTest=new Jht(this)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}dispose(){this.programCache.dispose(),this.bindVAO(null),this.unbindBuffer(ft.ARRAY_BUFFER),this.unbindBuffer(ft.ELEMENT_ARRAY_BUFFER),Zs(this.gl)&&(this.unbindBuffer(ft.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(ft.PIXEL_PACK_BUFFER),this.unbindBuffer(ft.PIXEL_UNPACK_BUFFER),this.unbindBuffer(ft.COPY_READ_BUFFER),this.unbindBuffer(ft.COPY_WRITE_BUFFER)),this._state.textureUnitMap.length=0,cu()&&this.instanceCounter.printResourceCount()}setPipelineState(t){this._stateTracker.setPipeline(t)}setBlendingEnabled(t){this._state.blend!==t&&(t===!0?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=t,this._stateTracker.invalidateBlending())}externalProgramUpdate(){var t;(t=this._state.program)==null||t.stop(),this._state.program=null}externalTextureUnitUpdate(t,i){for(let r=0;r<t.length;++r)this._state.textureUnitMap[t[r]]=null;i>=0&&(this._state.activeTexture=i)}externalVertexArrayObjectUpdate(){const t=this.capabilities.vao;t&&(t.bindVertexArray(null),this._state.vertexArrayObject=null),this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(t,i,r,s){t===this._state.blendColor.r&&i===this._state.blendColor.g&&r===this._state.blendColor.b&&s===this._state.blendColor.a||(this.gl.blendColor(t,i,r,s),this._state.blendColor.r=t,this._state.blendColor.g=i,this._state.blendColor.b=r,this._state.blendColor.a=s,this._stateTracker.invalidateBlending())}setBlendFunction(t,i){t===this._state.blendFunction.srcRGB&&i===this._state.blendFunction.dstRGB||(this.gl.blendFunc(t,i),this._state.blendFunction.srcRGB=t,this._state.blendFunction.srcAlpha=t,this._state.blendFunction.dstRGB=i,this._state.blendFunction.dstAlpha=i,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(t,i,r,s){this._state.blendFunction.srcRGB===t&&this._state.blendFunction.srcAlpha===r&&this._state.blendFunction.dstRGB===i&&this._state.blendFunction.dstAlpha===s||(this.gl.blendFuncSeparate(t,i,r,s),this._state.blendFunction.srcRGB=t,this._state.blendFunction.srcAlpha=r,this._state.blendFunction.dstRGB=i,this._state.blendFunction.dstAlpha=s,this._stateTracker.invalidateBlending())}setBlendEquation(t){this._state.blendEquation.mode!==t&&(this.gl.blendEquation(t),this._state.blendEquation.mode=t,this._state.blendEquation.modeAlpha=t,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(t,i){this._state.blendEquation.mode===t&&this._state.blendEquation.modeAlpha===i||(this.gl.blendEquationSeparate(t,i),this._state.blendEquation.mode=t,this._state.blendEquation.modeAlpha=i,this._stateTracker.invalidateBlending())}setColorMask(t,i,r,s){this._state.colorMask.r===t&&this._state.colorMask.g===i&&this._state.colorMask.b===r&&this._state.colorMask.a===s||(this.gl.colorMask(t,i,r,s),this._state.colorMask.r=t,this._state.colorMask.g=i,this._state.colorMask.b=r,this._state.colorMask.a=s,this._stateTracker.invalidateColorWrite())}setClearColor(t,i,r,s){this._state.clearColor.r===t&&this._state.clearColor.g===i&&this._state.clearColor.b===r&&this._state.clearColor.a===s||(this.gl.clearColor(t,i,r,s),this._state.clearColor.r=t,this._state.clearColor.g=i,this._state.clearColor.b=r,this._state.clearColor.a=s)}setFaceCullingEnabled(t){this._state.faceCulling!==t&&(t===!0?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=t,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(t){this._state.polygonOffsetFill!==t&&(t===!0?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=t,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(t,i){this._state.polygonOffset[0]===t&&this._state.polygonOffset[1]===i||(this._state.polygonOffset[0]=t,this._state.polygonOffset[1]=i,this.gl.polygonOffset(t,i),this._stateTracker.invalidatePolygonOffset())}setCullFace(t){this._state.cullFace!==t&&(this.gl.cullFace(t),this._state.cullFace=t,this._stateTracker.invalidateCulling())}setFrontFace(t){this._state.frontFace!==t&&(this.gl.frontFace(t),this._state.frontFace=t,this._stateTracker.invalidateCulling())}setScissorTestEnabled(t){this._state.scissorTest!==t&&(t===!0?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=t)}setScissorRect(t,i,r,s){this._state.scissorRect.x===t&&this._state.scissorRect.y===i&&this._state.scissorRect.width===r&&this._state.scissorRect.height===s||(this.gl.scissor(t,i,r,s),this._state.scissorRect.x=t,this._state.scissorRect.y=i,this._state.scissorRect.width=r,this._state.scissorRect.height=s)}setDepthTestEnabled(t){this._state.depthTest!==t&&(t===!0?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=t,this._stateTracker.invalidateDepthTest())}setClearDepth(t){this._state.clearDepth!==t&&(this.gl.clearDepth(t),this._state.clearDepth=t)}setDepthFunction(t){this._state.depthFunction!==t&&(this.gl.depthFunc(t),this._state.depthFunction=t,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(t){this._state.depthWrite!==t&&(this.gl.depthMask(t),this._state.depthWrite=t,this._stateTracker.invalidateDepthWrite())}setDepthRange(t,i){this._state.depthRange.zNear===t&&this._state.depthRange.zFar===i||(this.gl.depthRange(t,i),this._state.depthRange.zNear=t,this._state.depthRange.zFar=i,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(t){this._state.stencilTest!==t&&(t===!0?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=t,this._stateTracker.invalidateStencilTest())}setClearStencil(t){t!==this._state.clearStencil&&(this.gl.clearStencil(t),this._state.clearStencil=t)}setStencilFunction(t,i,r){this._state.stencilFunction.func===t&&this._state.stencilFunction.ref===i&&this._state.stencilFunction.mask===r||(this.gl.stencilFunc(t,i,r),this._state.stencilFunction.face=ba.FRONT_AND_BACK,this._state.stencilFunction.func=t,this._state.stencilFunction.ref=i,this._state.stencilFunction.mask=r,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(t,i,r,s){this._state.stencilFunction.face===t&&this._state.stencilFunction.func===i&&this._state.stencilFunction.ref===r&&this._state.stencilFunction.mask===s||(this.gl.stencilFuncSeparate(t,i,r,s),this._state.stencilFunction.face=t,this._state.stencilFunction.func=i,this._state.stencilFunction.ref=r,this._state.stencilFunction.mask=s,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(t){this._state.stencilWriteMask!==t&&(this.gl.stencilMask(t),this._state.stencilWriteMask=t,this._stateTracker.invalidateStencilWrite())}setStencilOp(t,i,r){this._state.stencilOperation.face===ba.FRONT_AND_BACK&&this._state.stencilOperation.fail===t&&this._state.stencilOperation.zFail===i&&this._state.stencilOperation.zPass===r||(this.gl.stencilOp(t,i,r),this._state.stencilOperation.face=ba.FRONT_AND_BACK,this._state.stencilOperation.fail=t,this._state.stencilOperation.zFail=i,this._state.stencilOperation.zPass=r,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(t,i,r,s){this._state.stencilOperation.face===t&&this._state.stencilOperation.fail===i&&this._state.stencilOperation.zFail===r&&this._state.stencilOperation.zPass===s||(this.gl.stencilOpSeparate(t,i,r,s),this._state.stencilOperation.face=t,this._state.stencilOperation.fail=i,this._state.stencilOperation.zFail=r,this._state.stencilOperation.zPass=s,this._stateTracker.invalidateStencilTest())}setActiveTexture(t,i=!1){const r=this._state.activeTexture;return t>=0&&(i||t!==this._state.activeTexture)&&(this.gl.activeTexture(B5+t),this._state.activeTexture=t),r}clear(t){t&&this.gl.clear(t)}clearSafe(t,i=255){t&&(t&bi.COLOR_BUFFER_BIT&&this.setColorMask(!0,!0,!0,!0),t&bi.DEPTH_BUFFER_BIT&&this.setDepthWriteEnabled(!0),t&bi.STENCIL_BUFFER_BIT&&this.setStencilWriteMask(i),this.gl.clear(t))}drawArrays(t,i,r){if(cu()&&(this._numOfDrawCalls++,this._numOfTriangles+=Cne(t,r)),this.gl.drawArrays(t,i,r),cu()){const s=lee(this);s&&console.error("drawArrays:",s)}}drawElements(t,i,r,s){if(cu()&&(this._numOfDrawCalls++,this._numOfTriangles+=Cne(t,i)),this.gl.drawElements(t,i,r,s),cu()){const o=lee(this);if(o){var n;const a=this.getBoundVAO(),l=a==null?void 0:a.indexBuffer,c={indexBuffer:l,vertexBuffers:a==null?void 0:a.vertexBuffers},h={mode:t,count:i,type:r,offset:s},p=(n=po(l,y=>y.size))!=null?n:0,f=s+i,g=p<f?`. Buffer is too small. Attempted to draw index ${f} of ${p}`:"";console.error(`drawElements: ${o}${g}`,{args:h,vao:c})}}}logIno(){cu()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}get capabilities(){return this._capabilities}setViewport(t,i,r,s){r=Math.max(Math.round(r),1),s=Math.max(Math.round(s),1);const n=this._state.viewport;n.x===t&&n.y===i&&n.width===r&&n.height===s||(n.x=t,n.y=i,n.width=r,n.height=s,this.gl.viewport(t,i,r,s))}getViewport(){return{x:this._state.viewport.x,y:this._state.viewport.y,width:this._state.viewport.width,height:this._state.viewport.height}}useProgram(t){var i,r;this._state.program!==t&&((i=this._state.program)==null||i.stop(),this._state.program=t,this.gl.useProgram((r=t==null?void 0:t.glName)!=null?r:null))}bindTexture(t,i,r=!1){(i>=this.parameters.maxTextureImageUnits||i<0)&&console.error("Input texture unit is out of range of available units!");const s=this._state.textureUnitMap[i];return R(t)||t.glName==null?(_(s)&&(this.setActiveTexture(i,r),this.gl.bindTexture(s.descriptor.target,null)),this._state.textureUnitMap[i]=null,s):r||s!==t?(this.setActiveTexture(i,r),this.gl.bindTexture(t.descriptor.target,t.glName),t.applyChanges(),this._state.textureUnitMap[i]=t,s):(t.isDirty&&(this.setActiveTexture(i,r),t.applyChanges()),s)}unbindTextureAllUnits(t){for(let i=0;i<this.parameters.maxTextureImageUnits;i++)this._state.textureUnitMap[i]===t&&(this.bindTexture(null,i),this._state.textureUnitMap[i]=null)}bindFramebuffer(t,i=!1){if(i||this._state.readFramebuffer!==t||this._state.drawFramebuffer!==t){if(R(t))return this.gl.bindFramebuffer(qs.FRAMEBUFFER,null),this._state.readFramebuffer=null,void(this._state.drawFramebuffer=null);t.initializeAndBind(qs.FRAMEBUFFER),this._state.readFramebuffer=t,this._state.drawFramebuffer=t}}bindFramebufferSeparate(t,i,r=!1){const s=i===qs.READ_FRAMEBUFFER,n=s?this._state.readFramebuffer:this._state.drawFramebuffer;(r||n!==t)&&(R(t)?this.gl.bindFramebuffer(i,null):t.initializeAndBind(i),s?this._state.readFramebuffer=gt(t,null):this._state.drawFramebuffer=gt(t,null))}blitFramebuffer(t,i,r=0,s=0,n=t.width,o=t.height,a=0,l=0,c=i.width,h=i.height,p=bi.COLOR_BUFFER_BIT,f=Ge.NEAREST){this.bindFramebufferSeparate(t,qs.READ_FRAMEBUFFER),this.bindFramebufferSeparate(i,qs.DRAW_FRAMEBUFFER),this.gl.blitFramebuffer(r,s,n,o,a,l,c,h,p,f)}bindBuffer(t,i){if(t)switch(i!=null||(i=t.bufferType),i){case ft.ARRAY_BUFFER:this._state.vertexBuffer=Ua(this.gl,t,i,this._state.vertexBuffer);break;case ft.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=Ua(this.gl,t,i,this._state.indexBuffer);break;case ft.UNIFORM_BUFFER:this._state.uniformBuffer=Ua(this.gl,t,i,this._state.uniformBuffer);break;case ft.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=Ua(this.gl,t,i,this._state.pixelPackBuffer);break;case ft.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=Ua(this.gl,t,i,this._state.pixelUnpackBuffer);break;case ft.COPY_READ_BUFFER:this._state.copyReadBuffer=Ua(this.gl,t,i,this._state.copyReadBuffer);break;case ft.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=Ua(this.gl,t,i,this._state.copyWriteBuffer)}}bindRenderbuffer(t){const i=this.gl;t||(i.bindRenderbuffer(i.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==t&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glName),this._state.renderbuffer=t)}_getBufferBinding(t,i){if(i>=this.parameters.maxUniformBufferBindings||i<0)return console.error("Uniform buffer binding point is out of range!"),null;const r=this._state.uniformBufferBindingPoints;let s=r[i];return R(s)&&(s={buffer:null,offset:0,size:0},r[i]=s),s}bindBufferBase(t,i,r){const s=this._getBufferBinding(t,i);R(s)||s.buffer===r&&s.offset===0&&s.size===0||(this.gl.bindBufferBase(t,i,r?r.glName:null),s.buffer=r,s.offset=0,s.size=0)}bindBufferRange(t,i,r,s,n){const o=this._getBufferBinding(t,i);if(!R(o)&&!(o.buffer===r&&o.offset===s&&o.size===n)){if(s%this._parameters.uniformBufferOffsetAlignment!=0)return void console.error("Uniform buffer binding offset is not a multiple of the context offset alignment");this.gl.bindBufferRange(t,i,r.glName,s,n),o.buffer=r,o.offset=s,o.size=n}}bindUBO(t,i,r,s){R(i)?this.bindBufferBase(ft.UNIFORM_BUFFER,t,null):(cu()&&(s!=null?s:i.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),i.initialize(),r!==void 0&&s!==void 0?this.bindBufferRange(ft.UNIFORM_BUFFER,t,i.buffer,r,s):this.bindBufferBase(ft.UNIFORM_BUFFER,t,i.buffer))}unbindUBO(t){for(let i=0,r=this._state.uniformBufferBindingPoints.length;i<r;i++){const s=this._state.uniformBufferBindingPoints[i];_(s)&&s.buffer===t.buffer&&this.bindBufferBase(ft.UNIFORM_BUFFER,i,null)}}unbindBuffer(t){switch(t){case ft.ARRAY_BUFFER:this._state.vertexBuffer=Ua(this.gl,null,t,this._state.vertexBuffer);break;case ft.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=Ua(this.gl,null,t,this._state.indexBuffer);break;case ft.UNIFORM_BUFFER:this._state.uniformBuffer=Ua(this.gl,null,t,this._state.uniformBuffer);break;case ft.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=Ua(this.gl,null,t,this._state.pixelPackBuffer);break;case ft.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=Ua(this.gl,null,t,this._state.pixelUnpackBuffer);break;case ft.COPY_READ_BUFFER:this._state.copyReadBuffer=Ua(this.gl,null,t,this._state.copyReadBuffer);break;case ft.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=Ua(this.gl,null,t,this._state.copyWriteBuffer)}}bindVAO(t=null){R(t)?this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null):this._state.vertexArrayObject!==t&&(t.bind(),this._state.vertexArrayObject=t)}async clientWaitAsync(t=10){const i={};this.instanceCounter.increment(ks.Sync,i);const r=this.gl,s=r.fenceSync(mV.SYNC_GPU_COMMANDS_COMPLETE,0);let n;r.flush();do await AT(t),n=r.clientWaitSync(s,0,0);while(n===VD.TIMEOUT_EXPIRED);if(r.deleteSync(s),this.instanceCounter.decrement(ks.Sync,i),n===VD.WAIT_FAILED)throw new Error("Client wait failed")}getBoundFramebufferObject(t=qs.FRAMEBUFFER){return t===qs.READ_FRAMEBUFFER?this._state.readFramebuffer:this._state.drawFramebuffer}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer(ft.ARRAY_BUFFER),this.unbindBuffer(ft.ELEMENT_ARRAY_BUFFER),Zs(this.gl)&&(this.unbindBuffer(ft.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(ft.PIXEL_PACK_BUFFER),this.unbindBuffer(ft.PIXEL_UNPACK_BUFFER),this.unbindBuffer(ft.COPY_READ_BUFFER),this.unbindBuffer(ft.COPY_WRITE_BUFFER));for(let t=0;t<this.parameters.maxTextureImageUnits;++t)this.bindTexture(null,t);this.setBlendingEnabled(!1),this.setBlendFunction(Ee.ONE,Ee.ZERO),this.setBlendEquation(Cp.ADD),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(ba.BACK),this.setFrontFace(XT.CCW),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(Li.LESS),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(Li.ALWAYS,0,0),this.setStencilOp(Ui.KEEP,Ui.KEEP,Ui.KEEP),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){var t,i;const r=this.gl,s=this.capabilities.vao;s&&s.bindVertexArray(null);for(let c=0;c<this.parameters.maxVertexAttributes;c++)r.disableVertexAttribArray(c);if(this._state.vertexBuffer?r.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):r.bindBuffer(ft.ARRAY_BUFFER,null),this._state.indexBuffer?r.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):r.bindBuffer(ft.ELEMENT_ARRAY_BUFFER,null),Zs(r)){var n,o;this._state.uniformBuffer?r.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):r.bindBuffer(ft.UNIFORM_BUFFER,null);for(let c=0;c<this._parameters.maxUniformBufferBindings;c++){const h=this._state.uniformBufferBindingPoints[c];if(_(h)&&h.buffer!==null){const{buffer:p,offset:f,size:g}=h;f===0&&g===0?r.bindBufferBase(ft.UNIFORM_BUFFER,c,p.glName):r.bindBufferRange(ft.UNIFORM_BUFFER,c,p.glName,f,g)}else r.bindBufferBase(ft.UNIFORM_BUFFER,c,null)}this._state.pixelPackBuffer?r.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):r.bindBuffer(ft.PIXEL_PACK_BUFFER,null),this._state.pixelUnpackBuffer?r.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):r.bindBuffer(ft.PIXEL_UNPACK_BUFFER,null),this._state.copyReadBuffer?r.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):r.bindBuffer(ft.COPY_READ_BUFFER,null),this._state.copyWriteBuffer?r.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):r.bindBuffer(ft.COPY_WRITE_BUFFER,null),r.bindFramebuffer(qs.READ_FRAMEBUFFER,null),r.readBuffer(r.BACK),this._state.readFramebuffer&&(r.bindFramebuffer(qs.READ_FRAMEBUFFER,this._state.readFramebuffer.glName),r.readBuffer(ql.COLOR_ATTACHMENT0)),r.bindFramebuffer(qs.DRAW_FRAMEBUFFER,(n=(o=this._state.drawFramebuffer)==null?void 0:o.glName)!=null?n:null)}else{var a,l;this._state.readFramebuffer=this._state.drawFramebuffer,r.bindFramebuffer(qs.FRAMEBUFFER,(a=(l=this._state.drawFramebuffer)==null?void 0:l.glName)!=null?a:null)}if(s&&this._state.vertexArrayObject){const c=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(c)}r.useProgram((t=(i=this._state.program)==null?void 0:i.glName)!=null?t:null),r.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),r.bindRenderbuffer(r.RENDERBUFFER,this._state.renderbuffer?this._state.renderbuffer.glName:null),this._state.blend===!0?r.enable(this.gl.BLEND):r.disable(this.gl.BLEND),r.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),r.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),r.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),r.clearDepth(this._state.clearDepth),r.clearStencil(this._state.clearStencil),r.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),r.cullFace(this._state.cullFace),r.depthFunc(this._state.depthFunction),r.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),this._state.depthTest===!0?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),r.depthMask(this._state.depthWrite),r.frontFace(this._state.frontFace),r.lineWidth(1),this._state.faceCulling===!0?r.enable(r.CULL_FACE):r.disable(r.CULL_FACE),r.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),this._state.polygonOffsetFill===!0?r.enable(r.POLYGON_OFFSET_FILL):r.disable(r.POLYGON_OFFSET_FILL),r.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),this._state.scissorTest===!0?r.enable(r.SCISSOR_TEST):r.disable(r.SCISSOR_TEST),r.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),r.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),this._state.stencilTest===!0?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),r.stencilMask(this._state.stencilWriteMask);for(let c=0;c<this.parameters.maxTextureImageUnits;c++){r.activeTexture(B5+c),r.bindTexture(st.TEXTURE_2D,null),r.bindTexture(st.TEXTURE_CUBE_MAP,null),Zs(r)&&(r.bindTexture(st.TEXTURE_3D,null),r.bindTexture(st.TEXTURE_2D_ARRAY,null));const h=this._state.textureUnitMap[c];_(h)&&r.bindTexture(h.descriptor.target,h.glName)}r.activeTexture(B5+this._state.activeTexture),r.viewport(this._state.viewport.x,this._state.viewport.y,this._state.viewport.width,this._state.viewport.height),cu()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}_loadExtensions(){this.type===Kt.WEBGL1&&this.gl.getExtension("OES_element_index_uint"),this.gl.getExtension("KHR_parallel_shader_compile")}_loadParameters(t){var i;const r=this.capabilities.textureFilterAnisotropic,s=(i=t.maxAnisotropy)!=null?i:1/0,n=Zs(this.gl),o=this.gl,a={versionString:this.gl.getParameter(this.gl.VERSION),maxVertexTextureImageUnits:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS),maxMaxAnisotropy:r?Math.min(this.gl.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY),s):1,maxTextureImageUnits:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE),maxUniformBufferBindings:n?o.getParameter(o.MAX_UNIFORM_BUFFER_BINDINGS):0,maxVertexUniformBlocks:n?o.getParameter(o.MAX_VERTEX_UNIFORM_BLOCKS):0,maxFragmentUniformBlocks:n?o.getParameter(o.MAX_FRAGMENT_UNIFORM_BLOCKS):0,maxUniformBlockSize:n?o.getParameter(o.MAX_UNIFORM_BLOCK_SIZE):0,uniformBufferOffsetAlignment:n?o.getParameter(o.UNIFORM_BUFFER_OFFSET_ALIGNMENT):1,maxArrayTextureLayers:n?o.getParameter(o.MAX_ARRAY_TEXTURE_LAYERS):1,maxSamples:n?o.getParameter(o.MAX_SAMPLES):1};return Qe.TEXTURE_UNIT_FOR_UPDATES=a.maxTextureImageUnits-1,a}}function Ua(e,t,i,r){return t?r!==t&&e.bindBuffer(i,t.glName):e.bindBuffer(i,null),t}function Cne(e,t){switch(e){case Tt.POINTS:return 2*t;case Tt.TRIANGLES:return t/3;case Tt.TRIANGLE_STRIP:case Tt.TRIANGLE_FAN:return t-2;default:return 0}}class pdt extends ddt{constructor(t,i,r){super(t,i),this.newCache=r,this._refCount=1}dispose(){--this._refCount>0||super.dispose()}ref(){++this._refCount}useTechnique(t,i=null,r){return this.useProgram(t.program),t.bindPipelineState(this,i,r),t.program}isTechniqueCompiled(t){return t.program.isCompiled}get test(){return this.programCache.test}}const Rbe=he.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");let ux=class extends we{constructor(e,t,i){super({}),this._stage=e,this._techniqueRepository=t,this._rctx=i,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new xr,this._frameTask=e.resourceController.scheduler.registerTask(ht.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}dispose(){this._frameTask.remove(),this._stage.forEachOfType(rd.Texture,e=>e.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return R(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(qO,new $W)),this._textureTechnique}acquire(e){const t=this._textures.get(e);return t?(t.ref(),gt(t.loadingPromise,t)):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach(t=>{const i=t.texture.frameUpdate(this._rctx,this.textureTechnique,t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)}),e&&this.events.emit("changed",ns.BACKGROUND)}_createNewRef(e){const t=this._stage.getObject(e);if(R(t))return at(t!==void 0),null;const i=t.events.on("unloaded",()=>{i.remove(),this._onTextureUnloaded(e)}),r=new fdt(e,()=>{this._frameTask.schedule(()=>{r.isUnreferenced&&t.unload()})});return this._textures.set(e,r),r.ref(),_(t.glTexture)?(this._updateGLTexture(r,t.glTexture),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule(()=>{const s=t.load(this._rctx,()=>this.textureTechnique),n=a=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,a),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r),o=a=>(this._loadingCount--,r.loadingPromise=null,pr(a)||Rbe.error(a),null);return Cc(s)?s.then(n,o):n(s)}),r.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",ns.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};u([d()],ux.prototype,"_loadingCount",void 0),u([d()],ux.prototype,"_frameTask",void 0),u([d()],ux.prototype,"updating",null),ux=u([P("esri.views.3d.webgl-engine.lib.TextureRepository")],ux);class fdt{constructor(t,i){this.id=t,this._release=i,this._refCount=0}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(Rbe.error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}const mdt=he.getLogger("esri.views.3d.webgl-engine.materials.internal.waterMaterialUtils");let NA=class extends we{constructor(){super(...arguments),this._data=new Array,this.loadingState=ma.NOT_LOADED}dispose(){this.loadingState=ma.NOT_LOADED,this._data.forEach(e=>e.dispose()),this._data.length=0}get updating(){return this.loadingState===ma.LOADING}get ready(){return this.loadingState===ma.LOADED}loadTextures(e){const t=[ui("esri/images/materials/water/normals.jpg"),ui("esri/images/materials/water/perturbation.jpg")];this.loadingState=ma.LOADING,Promise.all(t.map(i=>Fu(i))).then(i=>{i.forEach(r=>this._data.push(new Qe(e,{target:st.TEXTURE_2D,pixelFormat:$e.RGBA,dataType:yt.UNSIGNED_BYTE,wrapMode:ct.REPEAT,samplingMode:Ge.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,maxAnisotropy:8,width:r.width,height:r.height},r))),this.loadingState=ma.LOADED}).catch(i=>{mdt.error("Failed to load textures for water material.",i),this.loadingState=ma.NOT_LOADED})}bind(e){this.ready&&(e.bindTexture(this._data[0],"texWaveNormal"),e.bindTexture(this._data[1],"texWavePerturbation"))}};u([d()],NA.prototype,"loadingState",void 0),u([d({type:Boolean,readOnly:!0})],NA.prototype,"updating",null),NA=u([P("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],NA);class gdt extends y4{constructor(t,i,r,s,n,o){super(),this._rctx=t,this._renderScene=i,this._requestRenderScene=r,this._renderOverlay=s,this._forceCameraHook=n,this._disposeOffscreenBuffers=o,this.supersample=!0,this._screenshotQueue=new Array}dispose(){this._rctx=null}takeScreenshot(t){this._requestRenderScene(ns.BACKGROUND);const i=Sm();return this._screenshotQueue.push({settings:t,resolver:i}),i.promise}update(t){for(const i of this._screenshotQueue){if(this.isDisposed){i.resolver.reject();continue}const r=me(I({},i.settings),{pixelRatio:i.settings.pixelRatio*t.viewCamera.pixelRatio}),s=this._ensureScreenshotEncodeCanvas(),n=this._renderScreenshot(t,r),o=hKe(n,r,s,{flipY:!0,premultipliedAlpha:!0});i.resolver(o)}this._screenshotQueue.length=0}_renderScreenshotOverlay(t,i,r){if(R(this._renderOverlay))return i;t.width=i.width,t.height=i.height;const s=t.getContext("2d"),n=r.pixelRatio;return s.save(),s.translate(0,i.height),s.scale(1,-1),r.region&&s.translate(-r.region.x,-r.region.y),s.scale(n,n),i=this._renderOverlay(t,i),s.restore(),i}_readbackScreenshot(t,i){return t.resample?this._readbackScreenshotResampled(t,i):this._readbackScreenshotImmediate(t,i)}_readbackScreenshotResampled(t,i){const{framebufferWidth:r,framebufferHeight:s,region:n,resample:o}=t,a=this._ensureScreenshotEncodeCanvas();let l=Wk(r,s,a);this._rctx.gl.readPixels(0,0,r,s,$e.RGBA,ot.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),i(),l=this._renderScreenshotOverlay(a,l,me(I({},t),{region:null}));const c=Wk(n.width,n.height,a);return fKe(l,c,!0,o.region.x,s-(o.region.y+o.region.height),o.region.width,o.region.height)}_readbackScreenshotImmediate(t,i){const{framebufferHeight:r,region:s}=t,n=this._ensureScreenshotEncodeCanvas(),o=Wk(s.width,s.height,n);return this._rctx.gl.readPixels(s.x,r-(s.y+s.height),s.width,s.height,$e.RGBA,ot.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),i(),this._renderScreenshotOverlay(n,o,t)}_renderScreenshot(t,i){let r=null;const s=t.viewCamera,{framebufferWidth:n,framebufferHeight:o}=i;let a=!1;const l=i.disableDecorations&&t.frameHasDecorations,c=n!==s.fullWidth||o!==s.fullHeight,h=i.ignorePadding&&s.pixelRatio!==i.pixelRatio,p=c||l||h;if(p){const y=s.clone();if(i.ignorePadding){const w=aF(y.padding);for(let S=0;S<4;S++)w[S]=Math.round(w[S]/y.pixelRatio*i.pixelRatio);y.padding=w}y.fullWidth=n,y.fullHeight=o,y.pixelRatio=i.pixelRatio;const v=s.fovX-y.fovX,b=s.fovY-y.fovY;v<0&&v<b?y.fovX=s.fovX:b<0&&b<v&&(y.fovY=s.fovY),this._forceCameraHook(y),a=!0,r=new zi(this._rctx,{width:y.fullWidth,height:y.fullHeight,colorTarget:vr.TEXTURE,depthStencilTarget:ti.DEPTH_STENCIL_RENDER_BUFFER}),this._renderScene(r,y,i.disableDecorations?U1.OFF:U1.ON),this._disposeOffscreenBuffers()}const f=()=>{this._rctx.bindFramebuffer(null),tt(r)},g=this._readbackScreenshot(i,f);if(f(),p&&!this._rctx.contextAttributes.alpha)for(let y=3;y<g.data.length;y+=4)g.data[y]=255;return a&&this._forceCameraHook(s),g}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}const Rne=he.getLogger("esri.views.3d.webgl-engine.parts.View");let In=class extends g4(we){constructor(e){super({}),this.events=new xr,this.waterTextureRepository=new NA,this._magnifierHelper=new cx,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=e.container,this._initializeContext(e),Wt(this.waterTextureRepository,"loadingState",()=>this.requestRender()),this._magnifierHelper.events.on("request-render",()=>this.requestRender()),this._stippleTextureRepository=new t_e(this._rctx),this._shaderTechniqueRepository=new Cve({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new ux(e,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",t=>this.requestRender(t)),this._materialRepository=new kve(this._textureRepository,this._shaderTechniqueRepository,()=>this.requestRender(),()=>this.requestRender()),this._compositingHelper=new pct(this._rctx,this._shaderTechniqueRepository),this._renderer=new Gf(this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,t=>this.requestRender(t),(t,i)=>e.schedule(t,i),e),this._screenshotManager=new gdt(this._rctx,(t,i,r)=>this._renderer.render(t,i,i,r),t=>this.requestRender(t),e.options.screenshot.renderOverlay,t=>this.events.emit("force-camera-for-screenshot",t),()=>this._renderer.disposeOffscreenBuffers()),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}dispose(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=Js(this._frameTask),this._shaderTechniqueRepository=tt(this._shaderTechniqueRepository),super.dispose(),this._tmpDepthBuffer=null,this._rctx=null}get performanceInfo(){const e=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:e.getUsedTextureMemory!==void 0?e.getUsedTextureMemory():void 0,renderbufferMemory:e.getUsedRenderbufferMemory!==void 0?e.getUsedRenderbufferMemory():void 0,VBOMemory:e.getUsedVBOMemory!==void 0?e.getUsedVBOMemory():void 0}}requestRender(e=ns.UPDATE){e===ns.UPDATE?this._needsUpdate=!0:this._needsRender=!0}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}ensureEdgeView(){return this._renderer.ensureEdgeView()}get edgeView(){return this._renderer.edgeView}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}updateLightSources(e,t,i){this._renderer.updateLightSources(e,t,i),this.requestRender()}setRenderParameters(e){e.idleSuspend!==void 0&&this._idleSuspend!==!!e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend,this.requestRender()),this._renderer.setRenderParameters(e)}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}modify(e){this._renderer.modify(e),e.clear()}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e)}get hasShadowsEnabled(){return this._renderer.hasShadowsEnabled}readAccumulatedShadow(e){return this._renderer.readAccumulatedShadow(e[0],e[1])}getMinimalDepthForArea(e,t,i,r,s,n=s){const o=r.constrainWindowSize(t,i,s*r.pixelRatio,n*r.pixelRatio),a=this._ensureDepthBuffer(o);this._renderer.readDepthPixels(r,o[0],o[1],o[2],o[3],a);let l=Number.MAX_VALUE;for(let c=0;c<o[2]*o[3];c++){const h=vct(4*c,a,r.nearFar);l>h&&h!==r.nearFar[0]&&h!==r.nearFar[1]&&(l=h)}if(_(e)){const c=e.pickDepth(t*r.pixelRatio,i*r.pixelRatio,r);_(c)&&l>c&&c!==r.nearFar[0]&&c!==r.nearFar[1]&&(l=c)}return l===Number.MAX_VALUE?void 0:l}_ensureDepthBuffer(e){const t=4*e[2]*e[3];return(R(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}get renderPlugins(){return this._renderer.renderPlugins}get test(){return{renderer:this._renderer}}get gpuMemoryUsage(){return this._renderer.gpuMemoryUsage}async reloadShaders(){M1e(),await this._shaderTechniqueRepository.reloadAll(),this.requestRender()}get animationTimestep(){return this._renderer.animationTimestep}_registerFrameTask(e){const t=e.state,i={viewCamera:t.camera,frameHasDecorations:!1};let r=!1,s=ns.BACKGROUND,n=!1;const o={preRender:a=>{r=this.updating,s=this._needsUpdate?ns.UPDATE:ns.BACKGROUND,e.processSyncLayers();const l=a.time-this._lastAnimationUpdate;(l>this.animationTimestep||_(this.forcedAnimationTime)||r||this._needsRender)&&(this._renderer.updateAnimation({camera:t.camera,dt:l,forcedTime:this.forcedAnimationTime})&&this.requestRender(ns.BACKGROUND),this._lastAnimationUpdate=a.time)},render:()=>{if((this._needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const a=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this._renderer.render(null,t.camera,t.contentCamera,U1.ON),n=!0,a&&this._renderer.hasWaterReflection&&(this.requestRender(ns.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:()=>{i.viewCamera=t.camera,i.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(i)},finish:()=>{n&&(this._renderer.finish(s),n=!1)}};this._frameTask=_1(o)}_initializeContext(e){const t=e.options;this._canvas=t.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const i={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil==null||t.stencil,powerPreference:"high-performance"},r=r3e("3d",this._canvas,i);if(R(r)){const s=ue("esri-force-webgl");Rne.error(s)}else this._rctx=this._newRenderingContext(r,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&Rne.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&ue("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_newRenderingContext(e,t){const i={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8},r=(s,n)=>t.resourceController.memoryController.newCache(s,n);return new pdt(e,i,r)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")}get componentObjectCollection(){return R(this._componentObjectCollection)&&(this._componentObjectCollection=new hct(this._renderer.renderPassManager)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}};u([d({type:Boolean,readOnly:!0})],In.prototype,"updating",null),u([Dn()],In.prototype,"_rctx",void 0),u([Dn()],In.prototype,"_container",void 0),u([Dn()],In.prototype,"_canvas",void 0),u([Dn()],In.prototype,"_stippleTextureRepository",void 0),u([Dn(),d()],In.prototype,"waterTextureRepository",void 0),u([Dn(),d()],In.prototype,"_magnifierHelper",void 0),u([Dn(),d()],In.prototype,"_textureRepository",void 0),u([Dn()],In.prototype,"_compositingHelper",void 0),u([Dn()],In.prototype,"_renderer",void 0),u([Dn()],In.prototype,"_screenshotManager",void 0),u([Dn()],In.prototype,"componentObjectCollection",null),u([Dn()],In.prototype,"_componentObjectCollection",void 0),u([d()],In.prototype,"_needsUpdate",void 0),u([d()],In.prototype,"_needsWaterReflectionUpdate",void 0),In=u([P("esri.views.3d.webgl-engine.parts.RenderView")],In);var V$;let aa=V$=class extends g4(we){constructor(e){super(e),this._handles=new Ut,this._model=new F$,this._layers=new $t,this._changeSet=new Rve,this._layerSyncSet=new Set}initialize(){this._set("renderView",new In(this)),this._frameTask=this.resourceController.scheduler.registerTask(ht.STAGE,this),this._handles.add(this._frameTask)}destroy(){Y1.pool.prune(0),this._handles.destroy(),this.dispose()}get viewingMode(){return this.state.viewingMode}get updating(){return this._model.dirtySet.dirty||this.renderView.updating||this._frameTask.updating}add(e){this._model.add(e),qL(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.requestRender()}remove(e){R(e)||(this.renderView.requestRender(),this._model.remove(e),qL(e)&&(this._removeLayer(e),e.detachStage()))}addMany(e){_(e)&&(this._model.addMany(e),this.renderView.requestRender())}removeMany(e){_(e)&&(this._model.removeMany(e),this.renderView.requestRender())}async load(e){R(e)||(Array.isArray(e)||(e=[e]),await $C(e.filter(t=>R(t.glTexture)).map(t=>this.schedule(()=>this._model.has(t)?t.load(this.renderView.renderingContext,()=>this.renderView.textureRepository.textureTechnique):null))))}loadImmediate(e){return e.load(this.renderView.renderingContext,()=>this.renderView.textureRepository.textureTechnique)}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty}runTask(e){this._frameTask.processQueue(e),e.done||this._commit()}_commit(){const e=this._model.dirtySet;V$.DebugSettings.logDirtySet&&console.log("Dirty set: "+e.formatDebugInfo()),e.commit(this._changeSet),V$.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map(t=>t.id)),console.log("RGs remove: "+this._changeSet.removes.map(t=>t.id))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.requestRender()}schedule(e,t){return this._frameTask.schedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}processSyncLayers(){const e=this._model.dirtySet;this._layers.forAll(t=>{(this._layerSyncSet.has(t.id)||t.updatePolicy===aS.SYNC)&&(e.commitLayer(t.id,this._changeSet),this._layerSyncSet.delete(t.id))});for(const t of this._layerSyncSet)e.commitLayer(t,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet)}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.some(t=>t===e)||this._layers.push(e)}_removeLayer(e){this._commit(),this._layers.removeUnordered(e)!=null&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet))}addRenderPlugin(e,t,i){const r=this.renderView.renderPlugins.add(e,t,i),s=()=>{$re(t)&&this.sceneIntersectionHelper.addIntersectionHandler(t)};if(Cc(r))return r.then(s);s()}removeRenderPlugin(e){$re(e)&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return{getCount:t=>e._model.test.content.filter(i=>i.type===t).length,model:e._model}}};aa.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},u([d({constructOnly:!0})],aa.prototype,"resourceController",void 0),u([d({constructOnly:!0})],aa.prototype,"options",void 0),u([d({constructOnly:!0})],aa.prototype,"state",void 0),u([d({constructOnly:!0})],aa.prototype,"sceneIntersectionHelper",void 0),u([d({readOnly:!0})],aa.prototype,"viewingMode",null),u([d({constructOnly:!0})],aa.prototype,"container",void 0),u([d({constructOnly:!0})],aa.prototype,"renderSR",void 0),u([d({constructOnly:!0})],aa.prototype,"_handles",void 0),u([d({readOnly:!0})],aa.prototype,"updating",null),u([d({constructOnly:!0})],aa.prototype,"_model",void 0),u([Dn(),d()],aa.prototype,"renderView",void 0),aa=V$=u([P("esri.views.3d.webgl-engine.Stage")],aa);function Obe(e){return jp(e)&&e.intersector===ur.PCL&&!!e.target}function Mbe(e){return jp(e)&&e.intersector===ur.I3S&&!!e.target}function ydt(e){return jp(e)&&e.intersector===ur.TERRAIN&&!!e.target}function Pbe(e){return jp(e)&&e.intersector===ur.OVERLAY&&!!e.target}function vdt(e){return jp(e)&&e.intersector===ur.LOD&&!!e.target}function One(e,t){return oye(e)||Uq(e)?fN(e.target.object.metadata,t):ydt(e)?(i=t.map)==null?void 0:i.ground:Obe(e)||Mbe(e)||Pbe(e)?fN(e.target,t):null;var i}function Mne(e,t){return oye(e)||Uq(e)?Pne(e.target.object.metadata,t):Obe(e)?e.target.createGraphic():Pbe(e)||vdt(e)?Pne(e.target,t):Mbe(e)?_dt(e.target,t):null}function Pne(e,t){if(R(e)||R(e.graphicUid))return null;const i=fN(e,t);if(R(i))return null;if(i===t.graphics)return _(t.graphicsView)?t.graphicsView.getGraphicFromGraphicUid(e.graphicUid):null;const r=t.allLayerViews.find(s=>s.layer===i);return r&&!r.suspended&&"getGraphicFromGraphicUid"in r&&_(e.graphicUid)?r.getGraphicFromGraphicUid(e.graphicUid):null}function _dt(e,t){const i=fN(e,t);if(R(i))return null;const r=t.allLayerViews.find(s=>s.layer===i);return r&&!r.suspended&&"getGraphicFromIntersectorTarget"in r?r.getGraphicFromIntersectorTarget(e):null}function fN(e,t){return R(e.layerUid)?null:_(t.graphicsView)&&e.layerUid===t.graphicsView.processor.layer.id?t.graphics:t.map.findLayerByUid(e.layerUid)}async function bdt(e,t){if(e.type==="2d")return e.hitTest(t);const i=await e.hitTest(t),r=i.results[0],s=i.results.findIndex(n=>n.distance!==r.distance);return s!==-1&&(i.results=i.results.slice(0,s)),i}let Hz,qz;function Ine(e){switch(e){case Kt.WEBGL1:return wdt();case Kt.WEBGL2:return xdt()}}function wdt(){return Hz||(Hz=Edt()),Hz}function xdt(){return qz||(qz=Adt()),qz}class Ibe{constructor(){this.available=!1,this.majorPerformanceCaveat=!1,this.maxTextureSize=0,this.supportsVertexShaderSamplers=!1,this.supportsHighPrecisionFragment=!1}}class Tdt extends Ibe{constructor(){super(...arguments),this.type=Kt.WEBGL1,this.supportsElementIndexUint=!1,this.supportsStandardDerivatives=!1,this.supportsInstancedArrays=!1,this.supportsTextureFloat=!1}}class Sdt extends Ibe{constructor(){super(...arguments),this.type=Kt.WEBGL2}}function $be(e,t){if(e===Kt.WEBGL1&&typeof WebGLRenderingContext===void 0||e===Kt.WEBGL2&&typeof WebGL2RenderingContext===void 0)return null;const i=document.createElement("canvas");if(!i)return null;let r=BD(i,e,{failIfMajorPerformanceCaveat:!0});if(R(r)&&(r=BD(i,e),_(r)&&(t.majorPerformanceCaveat=!0)),R(r))return r;if(e===Kt.WEBGL1){const n=r.getParameter(r.VERSION),o=n==null?void 0:n.match(/^WebGL\s+([\d.]*)/);if(o){const a=parseFloat(o[1]);t.available=a>=.94}}else t.available=!0;t.maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),t.supportsVertexShaderSamplers=r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0;const s=r.getShaderPrecisionFormat(r.FRAGMENT_SHADER,r.HIGH_FLOAT);return s&&(t.supportsHighPrecisionFragment=s.precision>0),r}function Edt(){const e=new Tdt,t=$be(Kt.WEBGL1,e);return R(t)||(e.supportsElementIndexUint=t.getExtension("OES_element_index_uint")!==null,e.supportsStandardDerivatives=t.getExtension("OES_standard_derivatives")!==null,e.supportsInstancedArrays=t.getExtension("ANGLE_instanced_arrays")!==null,e.supportsTextureFloat=t.getExtension("OES_texture_float")!==null),e}function Adt(){const e=new Sdt,t=$be(Kt.WEBGL2,e);return R(t),e}function Cdt(e){const t=Rdt(e);if(!t.available)return new q("webgl:required","WebGL is required but not supported.");if(e==="3d"&&t.majorPerformanceCaveat)return new q("webgl:major-performance-caveat-detected","Your WebGL implementation doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist.");if(!t.supportsHighPrecisionFragment)return new q("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported.");if(!t.supportsVertexShaderSamplers)return new q("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported.");if(t.type===Kt.WEBGL1){if(!t.supportsElementIndexUint)return new q("webgl:element-index-uint-required","WebGL support for uint vertex indices is required but not supported.");if(!t.supportsStandardDerivatives)return new q("webgl:standard-derivatives-required","WebGL support for standard derivatives is required but not supported.");if(!t.supportsInstancedArrays)return new q("webgl:instanced-arrays-required","WebGL support for instanced rendering is required but not supported.")}return null}function Rdt(e){const t=lhe(e);for(;t.length>1;){const i=Ine(t.shift());if(i.available)return i}return Ine(t.shift())}function Odt(e){return e&&"nodeType"in e}function Mdt(e){return e&&typeof e.render=="function"}const $ne={component:"esri-component"};let w_=class extends we{constructor(){super(...arguments),this.widget=null}destroy(){this.widget&&this.widget.destroy(),this.node=null}get id(){return this.get("widget.id")||this.get("node.id")}set node(e){const t=this._get("node");e!==t&&(e&&e.classList.add($ne.component),t&&t.classList.remove($ne.component),this._set("node",e))}castNode(e){return e?typeof e=="string"||Odt(e)?(this._set("widget",null),KN(e)):(Mdt(e)&&!e.domNode&&(e.domNode=document.createElement("div")),this._set("widget",e),e.domNode):(this._set("widget",null),null)}};u([d({dependsOn:[]})],w_.prototype,"id",null),u([d()],w_.prototype,"node",null),u([At("node")],w_.prototype,"castNode",null),u([d({readOnly:!0})],w_.prototype,"widget",void 0),w_=u([P("esri.views.ui.Component")],w_);const G$=w_,Pdt={left:0,top:0,bottom:0,right:0},Dbe={bottom:30,top:15,right:15,left:15},Wz="manual",ta={ui:"esri-ui",corner:"esri-ui-corner",innerContainer:"esri-ui-inner-container",manualContainer:"esri-ui-manual-container",cornerContainer:"esri-ui-corner-container",topLeft:"esri-ui-top-left",topRight:"esri-ui-top-right",bottomLeft:"esri-ui-bottom-left",bottomRight:"esri-ui-bottom-right"};function Idt(e){return e&&!e._started&&typeof e.postMixInProperties=="function"&&typeof e.buildRendering=="function"&&typeof e.postCreate=="function"&&typeof e.startup=="function"}function Xz(e){const t=e,i=typeof t=="object"&&t!==null&&Object.getPrototypeOf(t);return(i===null||i===Object.prototype)&&("component"in t||"index"in t||"position"in t)?e:null}function Yz(e,{top:t,bottom:i,left:r,right:s}){e.style.top=t,e.style.bottom=i,e.style.left=r,e.style.right=s}let jf=class extends xr.EventedAccessor{constructor(e){super(e),this._cornerNameToContainerLookup={},this._positionNameToContainerLookup={},this._components=new Array,this._componentToKey=new Map,this._handles=new Ut,this.view=null,this._applyViewPadding=()=>{const t=this.container;t&&Yz(t,this._toPxPosition(this._getViewPadding()))},this._applyUIPadding=()=>{const t=this._innerContainer;t&&Yz(t,this._toPxPosition(this.padding))},this._initContainers()}initialize(){this._handles.add([Nt(()=>{var e;return[(e=this.view)==null?void 0:e.padding,this.container]},this._applyViewPadding,fn),Nt(()=>this.padding,this._applyUIPadding,fn)])}destroy(){this.container=null;for(const e of this._components)e.destroy();this._components.length=0,this._handles.destroy(),this._componentToKey.clear()}set container(e){const t=this._get("container");e!==t&&(e&&(e.classList.add(ta.ui),e.classList.add(zIe()),this._attachContainers(e)),t&&(t.classList.remove(ta.ui),Yz(t,{top:"",bottom:"",left:"",right:""}),Sce(t)),this._set("container",e))}get height(){const e=this.get("view.height")||0;if(e===0)return e;const t=this._getViewPadding(),i=t.top+t.bottom;return Math.max(e-i,0)}get padding(){return this._get("padding")}set padding(e){e?this._override("padding",e):this._clearOverride("padding")}castPadding(e){return typeof e=="number"?{bottom:e,top:e,right:e,left:e}:I(I({},Dbe),e)}get width(){const e=this.get("view.width")||0;if(e===0)return e;const t=this._getViewPadding(),i=t.left+t.right;return Math.max(e-i,0)}add(e,t){let i,r;if(Array.isArray(e))return void e.forEach(n=>this.add(n,t));const s=Xz(e);s&&({index:i,position:t,component:e,key:r}=s),t&&typeof t=="object"&&({index:i,key:r,position:t}=t),!e||t&&!this._isValidPosition(t)||this._add(e,t,i,r)}remove(e,t){if(!e)return;if(Array.isArray(e))return e.map(r=>this.remove(r,t));const i=this._find(e);if(i){const r=this._componentToKey;if(r.has(e)&&r.get(e)!==t)return;const s=this._components.indexOf(i);return i.node.parentNode&&i.node.parentNode.removeChild(i.node),this._componentToKey.delete(e),this._components.splice(s,1)[0]}}empty(e){return Array.isArray(e)?e.map(t=>this.empty(t)).reduce((t,i)=>t.concat(i)):(e=e||Wz)===Wz?Array.prototype.slice.call(this._manualContainer.children).filter(t=>!t.classList.contains(ta.corner)).map(t=>this.remove(t)):this._isValidPosition(e)?Array.prototype.slice.call(this._cornerNameToContainerLookup[e].children).map(this.remove,this):null}move(e,t){if(Array.isArray(e)&&e.forEach(n=>this.move(n,t)),!e)return;let i;const r=Xz(e)||Xz(t);if(r&&(i=r.index,t=r.position,e=r.component||e),t&&!this._isValidPosition(t))return;const s=this.remove(e);s&&this.add(s,{position:t,index:i})}find(e){if(!e)return null;const t=this._findById(e);return t&&(t.widget||t.node)}getPosition(e){for(const t in this._positionNameToContainerLookup)if(this._positionNameToContainerLookup[t].contains(e))return t;return null}_add(e,t,i,r){e instanceof G$||(e=new G$({node:e})),this._place({component:e,position:t,index:i}),this._components.push(e),r&&this._componentToKey.set(e,r)}_find(e){return e?e instanceof G$?this._findByComponent(e):typeof e=="string"?this._findById(e):this._findByNode(e.domNode||e):null}_getViewPadding(){return this.get("view.padding")||Pdt}_attachContainers(e){e.appendChild(this._innerContainer),e.appendChild(this._manualContainer)}_initContainers(){const e=document.createElement("div");e.classList.add(ta.innerContainer),e.classList.add(ta.cornerContainer);const t=document.createElement("div");t.classList.add(ta.innerContainer),t.classList.add(ta.manualContainer);const i=document.createElement("div");i.classList.add(ta.topLeft),i.classList.add(ta.corner),e.appendChild(i);const r=document.createElement("div");r.classList.add(ta.topRight),r.classList.add(ta.corner),e.appendChild(r);const s=document.createElement("div");s.classList.add(ta.bottomLeft),s.classList.add(ta.corner),e.appendChild(s);const n=document.createElement("div");n.classList.add(ta.bottomRight),n.classList.add(ta.corner),e.appendChild(n),this._innerContainer=e,this._manualContainer=t;const o=qy();this._cornerNameToContainerLookup={"top-left":i,"top-right":r,"bottom-left":s,"bottom-right":n,"top-leading":o?r:i,"top-trailing":o?i:r,"bottom-leading":o?n:s,"bottom-trailing":o?s:n},this._positionNameToContainerLookup=I({manual:t},this._cornerNameToContainerLookup)}_isValidPosition(e){return!!this._positionNameToContainerLookup[e]}_place(e){const t=e.component,i=e.position||Wz,r=e.index,s=this._positionNameToContainerLookup[i],n=r>-1;if(Idt(t.widget)&&t.widget.startup(),!n)return void s.appendChild(t.node);const o=Array.prototype.slice.call(s.children);if(r===0)return void(s.firstChild?YY(t.node,s.firstChild):s.appendChild(t.node));r>=o.length?s.appendChild(t.node):YY(t.node,o[r])}_toPxPosition(e){return{top:this._toPxUnit(e.top),left:this._toPxUnit(e.left),right:this._toPxUnit(e.right),bottom:this._toPxUnit(e.bottom)}}_toPxUnit(e){return e===0?"0":e+"px"}_findByComponent(e){let t,i=null;return this._components.some(r=>(t=r===e,t&&(i=r),t)),i}_findById(e){let t,i=null;return this._components.some(r=>(t=r.id===e,t&&(i=r),t)),i}_findByNode(e){let t,i=null;return this._components.some(r=>(t=r.node===e,t&&(i=r),t)),i}};u([d()],jf.prototype,"container",null),u([d()],jf.prototype,"height",null),u([d({value:Dbe})],jf.prototype,"padding",null),u([At("padding")],jf.prototype,"castPadding",null),u([d()],jf.prototype,"view",void 0),u([d()],jf.prototype,"width",null),jf=u([P("esri.views.ui.UI")],jf);const $dt=jf;function Dne(e,t){return e&&"copyright"in e&&(!t||typeof e.originOf=="function"&&e.originOf("copyright")==="user")}function Ddt(e,t){return e.length!==t.length||e.some((i,r)=>i.text!==t[r].text)}function WP(e,t,i){!i||!t||e.find(r=>r.layerView===t&&r.text===i)||e.push({text:i,layerView:t})}function Ldt(e){return e.type==="bing-maps"}const Dg=[];let hx=class extends zT{constructor(e){super(e),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.handles.remove("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new it,this.view=null,this._allLayerViewsChange=t=>{this.handles.remove("suspension");const i=this.get("view.allLayerViews");i&&this.handles.add(i.map(r=>r.watch(["suspended","attributionVisible"],this._updateAttributionItems)),"suspension"),t&&t.removed&&t.removed.forEach(r=>{this._pendingAttributions.delete(r),this._fetchedAttributionData.delete(r)}),this._updateAttributionItems()},this._updateAttributionItems=()=>{const t=this.get("view.allLayerViews");Dg.length=0,t?(t.forEach(i=>{if(i.suspended||!i.get("layer.attributionVisible"))return;const r=i.layer;if(Dne(r,"user"))return void WP(Dg,i,r.copyright);if(r.hasAttributionData){if(this._fetchedAttributionData.has(i)){const n=this._fetchedAttributionData.get(i);return void(n?WP(Dg,i,this._getDynamicAttribution(n,this.view,r)):Dne(r)&&WP(Dg,i,r.copyright))}return void this._fetchAttributionData(i)}const s=r.get("portalItem.accessInformation");WP(Dg,i,s||r.copyright)}),Ddt(this.items,Dg)&&(this.items.removeAll(),this.items.addMany(Dg)),Dg.length=0,this.notifyChange("state")):this._clear()},this.handles.add([Rp(this,"view.allLayerViews","change",this._allLayerViewsChange,this._allLayerViewsChange,this._clear),NPe(this,"view.stationary",()=>this._updateAttributionItems())])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.get("view.ready")?this._pendingAttributions.size>0?"loading":"ready":"disabled"}async _fetchAttributionData(e){if(this._pendingAttributions.has(e))return;this._pendingAttributions.add(e);const t=await wl(e.layer.fetchAttributionData());if(this._pendingAttributions.has(e)){const i=t.ok?this._createContributionIndex(t.value,Ldt(e.layer)):null;this._pendingAttributions.delete(e),this._fetchedAttributionData.set(e,i)}this._updateAttributionItems()}_createContributionIndex(e,t){const i=e.contributors,r={};if(!i)return r;for(let s=0;s<i.length;s++){const n=i[s],o=n.coverageAreas;if(!o)return;for(const a of o){const l=a.bbox,c=a.zoomMin-(t&&a.zoomMin?1:0),h=a.zoomMax-(t&&a.zoomMax?1:0),p={xmin:l[1],ymin:l[0],xmax:l[3],ymax:l[2],spatialReference:He.WGS84},f={extent:fm(p),attribution:n.attribution||"",score:a.score!=null?a.score:100,id:s};for(let g=c;g<=h;g++)r[g]=r[g]||[],r[g].push(f)}}return r.maxKey=Math.max.apply(null,Object.keys(r)),r}_getDynamicAttribution(e,t,i){const{extent:r,scale:s}=t;let n=i.tileInfo.scaleToZoom(s);if(n=Math.min(e.maxKey,Math.round(n)),!r||n==null||n<=-1)return"";const o=e[n],a=sb(r.center.clone().normalize(),t.spatialReference),l={};return o?o.filter(c=>{const h=!l[c.id]&&a&&aO(c.extent,a);return h&&(l[c.id]=!0),h}).sort((c,h)=>h.score-c.score||c.objectId-h.objectId).map(c=>c.attribution).join(", "):""}};u([d({readOnly:!0,type:it})],hx.prototype,"items",void 0),u([d({readOnly:!0})],hx.prototype,"state",null),u([d()],hx.prototype,"view",void 0),hx=u([P("esri.widgets.Attribution.AttributionViewModel")],hx);const Lbe=hx,Lg={base:"esri-attribution esri-widget",poweredBy:"esri-attribution__powered-by",sources:"esri-attribution__sources",open:"esri-attribution--open",sourcesOpen:"esri-attribution__sources--open",link:"esri-attribution__link",widgetIcon:"esri-icon-description",interactive:"esri-interactive"};let la=class extends Ia{constructor(e,t){super(e,t),this._isOpen=!1,this._attributionTextOverflowed=!1,this._prevSourceNodeHeight=0,this.iconClass=Lg.widgetIcon,this.itemDelimiter=" | ",this.label=void 0,this.messages=null,this.view=null,this.viewModel=new Lbe}initialize(){this.own(Rp(this,"viewModel.items","change",()=>this.scheduleRender()))}get _isInteractive(){return this._isOpen||this._attributionTextOverflowed}get attributionText(){return this.viewModel.items.reduce((e,t)=>(e.indexOf(t.text)===-1&&e.push(t.text),e),[]).join(this.itemDelimiter)}render(){const e={[Lg.open]:this._isOpen};return le("div",{bind:this,class:this.classes(Lg.base,e),onclick:this._toggleState,onkeydown:this._toggleState},this.renderSourcesNode(),this.renderPoweredBy())}renderPoweredBy(){return le("div",{class:Lg.poweredBy},"Powered by"," ",le("a",{class:Lg.link,href:"http://www.esri.com/",target:"_blank",rel:"noreferrer"},"Esri"))}renderSourcesNode(){const e=this._isOpen,t=this._isInteractive,i=t?0:-1,{attributionText:r}=this,s=t?"button":void 0,n={[Lg.sourcesOpen]:e,[Lg.interactive]:t};return le("div",{afterCreate:this._afterSourcesNodeCreate,afterUpdate:this._afterSourcesNodeUpdate,bind:this,class:this.classes(Lg.sources,n),innerHTML:r,role:s,tabIndex:i})}_afterSourcesNodeCreate(e){this._prevSourceNodeHeight=e.clientWidth}_afterSourcesNodeUpdate(e){let t=!1;const{clientHeight:i,clientWidth:r,scrollWidth:s}=e,n=s>=r,o=this._attributionTextOverflowed!==n;if(this._attributionTextOverflowed=n,o&&(t=!0),this._isOpen){const a=i<this._prevSourceNodeHeight;this._prevSourceNodeHeight=i,a&&(this._isOpen=!1,t=!0)}t&&this.scheduleRender()}_toggleState(){this._isInteractive&&(this._isOpen=!this._isOpen)}};u([d()],la.prototype,"_isOpen",void 0),u([d()],la.prototype,"_isInteractive",null),u([d()],la.prototype,"_attributionTextOverflowed",void 0),u([d()],la.prototype,"_prevSourceNodeHeight",void 0),u([d({readOnly:!0,dependsOn:["viewModel.items.length","itemDelimiter"]})],la.prototype,"attributionText",null),u([d()],la.prototype,"iconClass",void 0),u([d()],la.prototype,"itemDelimiter",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],la.prototype,"label",void 0),u([d(),fl("esri/widgets/Attribution/t9n/Attribution")],la.prototype,"messages",void 0),u([mt("viewModel.view")],la.prototype,"view",void 0),u([d({type:Lbe})],la.prototype,"viewModel",void 0),u([lu()],la.prototype,"_toggleState",null),la=u([P("esri.widgets.Attribution")],la);const Ndt=la,Fdt="esri.widgets.CompassViewModel";let x_=class extends gme(we){constructor(e){super(e),this._handles=new Ut,this.orientation={x:0,y:0,z:0},this.view=null,this._updateForCamera=this._updateForCamera.bind(this),this._updateForRotation=this._updateForRotation.bind(this),this._updateRotationWatcher=this._updateRotationWatcher.bind(this)}initialize(){this._handles.add(Wt(this,"view",this._updateRotationWatcher))}destroy(){this._handles.destroy(),this._handles=null,this.view=null}get canShowNorth(){const e=this.get("view.spatialReference");return!(!e||!e.isWebMercator&&!e.isGeographic)}get state(){return this.get("view.ready")?this.canShowNorth?"compass":"rotation":"disabled"}reset(){if(!this.get("view.ready"))return;const e={};this.view.type==="2d"?e.rotation=0:e.heading=0,this.callGoTo({target:e})}_updateForRotation(e){e!=null&&(this.orientation={z:e})}_updateForCamera(e){if(!e)return;const t=-e.heading;this.orientation={x:0,y:0,z:t}}_updateRotationWatcher(e){this._handles.removeAll(),e&&(e.type==="2d"?this._handles.add(Wt(this,"view.rotation",this._updateForRotation)):this._handles.add(Wt(this,"view.camera",this._updateForCamera)))}};u([d({readOnly:!0})],x_.prototype,"canShowNorth",null),u([d()],x_.prototype,"orientation",void 0),u([d({readOnly:!0})],x_.prototype,"state",null),u([d()],x_.prototype,"view",void 0),x_=u([P(Fdt)],x_);const Nbe=x_,Ng={base:"esri-compass esri-widget--button esri-widget",text:"esri-icon-font-fallback-text",icon:"esri-compass__icon",rotationIcon:"esri-icon-dial",northIcon:"esri-icon-compass",widgetIcon:"esri-icon-locate-circled",interactive:"esri-interactive",disabled:"esri-disabled"};let Yd=class extends Ia{constructor(e,t){super(e,t),this.goToOverride=null,this.iconClass=Ng.widgetIcon,this.label=void 0,this.messages=null,this.view=null,this.viewModel=new Nbe}reset(){return this.viewModel.reset()}render(){const{orientation:e,state:t}=this.viewModel,i=t==="disabled",r=(t==="rotation"?"rotation":"compass")=="compass",s=i?-1:0,n={[Ng.disabled]:i,[Ng.interactive]:!i},o={[Ng.northIcon]:r,[Ng.rotationIcon]:!r},{messages:a}=this;return le("div",{bind:this,class:this.classes(Ng.base,n),onclick:this._reset,onkeydown:this._reset,role:"button",tabIndex:s,"aria-label":a.reset,title:a.reset},le("span",{"aria-hidden":"true",class:this.classes(Ng.icon,o),styles:this._toRotationTransform(e)}),le("span",{class:Ng.text},a.reset))}_reset(){this.viewModel.reset()}_toRotationTransform(e){return{transform:`rotateZ(${e.z}deg)`}}};u([mt("viewModel.goToOverride")],Yd.prototype,"goToOverride",void 0),u([d()],Yd.prototype,"iconClass",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Yd.prototype,"label",void 0),u([d(),fl("esri/widgets/Compass/t9n/Compass")],Yd.prototype,"messages",void 0),u([mt("viewModel.view")],Yd.prototype,"view",void 0),u([d({type:Nbe})],Yd.prototype,"viewModel",void 0),u([lu()],Yd.prototype,"_reset",null),Yd=u([P("esri.widgets.Compass")],Yd);const Udt=Yd;let dx=class extends we{constructor(e){super(e),this._handles=new Ut,this.navigationMode="pan",this.view=null}initialize(){this._handles.add(eH(this,"view.inputManager",this._setNavigationMode.bind(this)))}destroy(){this._handles.destroy(),this._handles=null,this.view=null}get state(){return this.get("view.ready")&&this.view.type==="3d"?"ready":"disabled"}toggle(){this.state!=="disabled"&&(this.navigationMode=this.navigationMode!=="pan"?"pan":"rotate",this._setNavigationMode())}_setNavigationMode(){this.get("view.inputManager").primaryDragAction=this.navigationMode==="pan"?"pan":"rotate"}};u([d({readOnly:!0})],dx.prototype,"state",null),u([d()],dx.prototype,"navigationMode",void 0),u([d()],dx.prototype,"view",void 0),dx=u([P("esri.widgets.NavigationToggleViewModel")],dx);const Fbe=dx,Hc={base:"esri-navigation-toggle esri-widget",button:"esri-navigation-toggle__button esri-widget--button",activeButton:"esri-navigation-toggle__button--active",panButton:"esri-navigation-toggle__button--pan",rotateButton:"esri-navigation-toggle__button--rotate",isLayoutHorizontal:"esri-navigation-toggle--horizontal",rotationIcon:"esri-icon-rotate",panIcon:"esri-icon-pan",widgetIcon:"esri-icon-pan2",disabled:"esri-disabled"};let Zd=class extends Ia{constructor(e,t){super(e,t),this.iconClass=Hc.widgetIcon,this.label=void 0,this.messages=null,this.view=null,this.viewModel=new Fbe}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}toggle(){return this.viewModel.toggle()}render(){const e=this.get("viewModel.state")==="disabled",t=this.get("viewModel.navigationMode")==="pan",i={[Hc.disabled]:e,[Hc.isLayoutHorizontal]:this.layout==="horizontal"},r={[Hc.activeButton]:t},s={[Hc.activeButton]:!t},n=e?-1:0,o=this.messages.toggle;return le("div",{bind:this,class:this.classes(Hc.base,i),onclick:this._toggle,onkeydown:this._toggle,tabIndex:n,"aria-label":o,title:o},le("div",{class:this.classes(Hc.button,Hc.panButton,r)},le("span",{class:Hc.panIcon})),le("div",{class:this.classes(Hc.button,Hc.rotateButton,s)},le("span",{class:Hc.rotationIcon})))}_toggle(){this.toggle()}};u([d()],Zd.prototype,"iconClass",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Zd.prototype,"label",void 0),u([d({value:"vertical"})],Zd.prototype,"layout",null),u([d(),fl("esri/widgets/NavigationToggle/t9n/NavigationToggle")],Zd.prototype,"messages",void 0),u([mt("viewModel.view")],Zd.prototype,"view",void 0),u([d({type:Fbe})],Zd.prototype,"viewModel",void 0),u([lu()],Zd.prototype,"_toggle",null),Zd=u([P("esri.widgets.NavigationToggle")],Zd);const kdt=Zd,bE={button:"esri-widget--button esri-widget",disabled:"esri-disabled",interactive:"esri-interactive",iconText:"esri-icon-font-fallback-text",icon:"esri-icon"};let py=class extends Ia{constructor(){super(...arguments),this.enabled=!0,this.iconClass="",this.title=""}render(){const e=this.enabled?0:-1,t={[bE.disabled]:!this.enabled,[bE.interactive]:this.enabled},i={[this.iconClass]:!!this.iconClass};return le("div",{bind:this,class:this.classes(bE.button,t),onclick:this._triggerAction,onkeydown:this._triggerAction,role:"button",tabIndex:e,title:this.title},le("span",{"aria-hidden":"true",role:"presentation",class:this.classes(bE.icon,i)}),le("span",{class:bE.iconText},this.title))}_triggerAction(){this.action.call(this)}};u([d()],py.prototype,"action",void 0),u([d()],py.prototype,"enabled",void 0),u([d()],py.prototype,"iconClass",void 0),u([d()],py.prototype,"title",void 0),u([lu()],py.prototype,"_triggerAction",null),py=u([P("esri.widgets.IconButton")],py);const Lne=py;let px=class extends we{get canZoomIn(){if(!this.get("view.ready"))return!1;const e=this.get("view.animation.target.scale")||this.get("view.scale"),t=this.get("view.constraints.effectiveMaxScale");return t===0||e>t}get canZoomOut(){if(!this.get("view.ready"))return!1;const e=this.get("view.animation.target.scale")||this.get("view.scale"),t=this.get("view.constraints.effectiveMinScale");return t===0||e<t}};u([d({readOnly:!0})],px.prototype,"canZoomIn",null),u([d({readOnly:!0})],px.prototype,"canZoomOut",null),u([d()],px.prototype,"view",void 0),px=u([P("esri.widgets.Zoom.ZoomConditions2D")],px);const zdt=px;let fx=class extends we{get canZoomIn(){return!!this.get("view.ready")}get canZoomOut(){return!!this.get("view.ready")}};u([d({readOnly:!0})],fx.prototype,"canZoomIn",null),u([d({readOnly:!0})],fx.prototype,"canZoomOut",null),u([d()],fx.prototype,"view",void 0),fx=u([P("esri.widgets.Zoom.ZoomConditions3D")],fx);const Bdt=fx;let fy=class extends we{constructor(e){super(e),this.canZoomIn=!1,this.canZoomOut=!1}destroy(){this.view=null}get state(){return this.get("view.ready")?"ready":"disabled"}set view(e){e?e.type==="2d"?this._zoomConditions=new zdt({view:e}):e.type==="3d"&&(this._zoomConditions=new Bdt({view:e})):this._zoomConditions=null,this._set("view",e)}zoomIn(){if(!this.canZoomIn)return;const e=this.view;e.type==="2d"?e.mapViewNavigation.zoomIn():l6(e.goTo({zoomFactor:2}))}zoomOut(){if(!this.canZoomOut)return;const e=this.view;e.type==="2d"?e.mapViewNavigation.zoomOut():l6(e.goTo({zoomFactor:.5}))}};u([d()],fy.prototype,"_zoomConditions",void 0),u([d({aliasOf:"_zoomConditions.canZoomIn",readOnly:!0})],fy.prototype,"canZoomIn",void 0),u([d({aliasOf:"_zoomConditions.canZoomOut",readOnly:!0})],fy.prototype,"canZoomOut",void 0),u([d({readOnly:!0})],fy.prototype,"state",null),u([d()],fy.prototype,"view",null),fy=u([P("esri.widgets.Zoom.ZoomViewModel")],fy);const Ube=fy,wE={base:"esri-zoom esri-widget",horizontalLayout:"esri-zoom--horizontal",zoomInIcon:"esri-icon-plus",zoomOutIcon:"esri-icon-minus",widgetIcon:"esri-icon-zoom-in-magnifying-glass"};let Hf=class extends Ia{constructor(e,t){super(e,t),this.iconClass=wE.widgetIcon,this.label=void 0,this.messages=null,this.view=null,this.viewModel=new Ube}initialize(){this._zoomInButton=new Lne({action:this.zoomIn.bind(this),iconClass:wE.zoomInIcon}),this._zoomOutButton=new Lne({action:this.zoomOut.bind(this),iconClass:wE.zoomOutIcon})}destroy(){this._zoomInButton.destroy(),this._zoomOutButton.destroy(),this._zoomInButton=null,this._zoomOutButton=null}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}render(){const e=this.viewModel,t={[wE.horizontalLayout]:this.layout==="horizontal"};return this._zoomInButton.enabled=e.state==="ready"&&e.canZoomIn,this._zoomOutButton.enabled=e.state==="ready"&&e.canZoomOut,this._zoomInButton.title=this.messages.zoomIn,this._zoomOutButton.title=this.messages.zoomOut,le("div",{class:this.classes(wE.base,t)},this._zoomInButton.render(),this._zoomOutButton.render())}zoomIn(){return this.viewModel.zoomIn()}zoomOut(){return this.viewModel.zoomOut()}};u([d()],Hf.prototype,"iconClass",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Hf.prototype,"label",void 0),u([d({value:"vertical"})],Hf.prototype,"layout",null),u([d(),fl("esri/widgets/Zoom/t9n/Zoom")],Hf.prototype,"messages",void 0),u([mt("viewModel.view")],Hf.prototype,"view",void 0),u([d({type:Ube})],Hf.prototype,"viewModel",void 0),Hf=u([P("esri.widgets.Zoom")],Hf);const Vdt=Hf,kbe="esri.views.ui.DefaultUI";function Gdt(e){return e&&e.view!==void 0}he.getLogger(kbe);let j$=class extends $dt{constructor(e){super(e),this._defaultPositionLookup={attribution:"manual",compass:"top-leading","navigation-toggle":"top-leading",zoom:"top-leading"},this.components=[]}initialize(){this._handles.add([Nt(()=>this.components,this._componentsWatcher.bind(this),fn),Nt(()=>this.view,this._updateViewAwareWidgets.bind(this),fn)])}_add(e,t,i,r){if(typeof e=="string"&&this._defaultPositionLookup[e]){if(this._find(e))return;e=this._createComponent(e)}super._add(e,t,i,r)}_removeComponents(e){e.forEach(t=>{const i=this._find(t);i&&(this.remove(i),i.destroy())})}_updateViewAwareWidgets(e){this.components.forEach(t=>{const i=this._find(t),r=i&&i.widget;Gdt(r)&&(r.view=e)})}_componentsWatcher(e,t){this._removeComponents(t),this._addComponents(e),this._adjustPadding(e)}_adjustPadding(e){if(e.indexOf("attribution")===-1&&!this._isOverridden("padding")){const{top:t}=this.padding;this.padding=t}}_addComponents(e){this.initialized&&e.forEach(t=>this.add(this._createComponent(t),this._defaultPositionLookup[t]))}_createComponent(e){const t=this._createWidget(e);if(t)return new G$({id:e,node:t})}_createWidget(e){return e==="attribution"?this._createAttribution():e==="compass"?this._createCompass():e==="navigation-toggle"?this._createNavigationToggle():e==="zoom"?this._createZoom():void 0}_createAttribution(){return new Ndt({view:this.view})}_createCompass(){return new Udt({view:this.view})}_createNavigationToggle(){return new kdt({view:this.view})}_createZoom(){return new Vdt({view:this.view})}};u([d()],j$.prototype,"components",void 0),j$=u([P(kbe)],j$);const jdt=j$;let H$=class extends jdt{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};u([d()],H$.prototype,"components",void 0),H$=u([P("esri.views.ui.3d.DefaultUI3D")],H$);const zbe=H$,Nl=he.getLogger("esri.views.SceneView");let Ke=class extends d3e(G6e(rBe(KBe))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this.propertiesPool=new N0({slicePlane:Hue},this),this._resourceController=Bst(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new Z9({view:this}),this.labeler=new m_({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new YT,this.basemapTerrain=null,this.elevationProvider=null,this.camera=null,this.canvas=null,this.center=null,this.constraints=new Yme,this.environmentManager=new _h,this.extent=null,this.floors=new it,this.windowDevicePixelRatio=1,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new iVe({view:this}),this.groundView=null,this.navigating=!1,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new Irt,this.scale=null,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new zbe,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.viewpoint=null,this.zoom=null,this.highlightOptions=new mG,ORe(),e&&e.environment||(this._defaults.environment=new tx,this.environment=this._defaults.environment);const t=(r=null)=>{_(r)&&r.type===Ai.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach(async s=>{try{await s.when()}catch{}this._updatingChanged()}))};this.handles.add([Yx(()=>{var r;return(r=this.map)==null?void 0:r.allLayers},"after-changes",r=>t(r),{onListenerAdd:()=>t(),onListenerRemove:()=>t(),sync:!0}),this.allLayerViews.on("after-changes",r=>this._updateUpdatingMonitors(r)),this.watch("map",r=>{r&&r.load&&r.load().catch(()=>{})})]),this.inputManager=new fqe({view:this});const i=()=>{const r=window.devicePixelRatio;r!==this.windowDevicePixelRatio&&(this.windowDevicePixelRatio=r,this.notifyChange("pixelRatio"))};this.stateManager=new ost({view:this,updateDevicePixelRatio:i})}initialize(){this.groundView=new iBe({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.handles.add(Yx(()=>{var t;return(t=this.map)==null?void 0:t.allLayers},"after-changes",e,{onListenerAdd:e,onListenerRemove:e})),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,t=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=t)},fn),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,t=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=t)},fn),this.updatingHandles.add(()=>this.qualitySettings.frameRate,t=>CTe(t>0?1e3/Math.ceil(t):0),fn),this.updatingHandles.add(()=>hi.SCENEVIEW_LOCKING_LOG,t=>this.defaultsFromMap.logDebugInformation=t,fn),this.updatingHandles.add(()=>{var t;return(t=this.map)==null?void 0:t.ground},e,rc),this.updatingHandles.add(()=>{var t,i;return(t=this.map)==null||(i=t.ground)==null?void 0:i.opacity},()=>this._updateDefaultHitTestOptions(),rc),this.handles.add(this.watch("spatialReference",()=>this.notifyChange("clippingArea"),!0))}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=rt(this.sharedSymbolResources),this.labeler.destroy(),this._set("labeler",null),this.deconflictor.destroy(),this._set("deconflictor",null),this._resourceController=rt(this._resourceController),this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this.propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this.environmentManager.destroy(),this._set("environmentManager",null),this.groundView=rt(this.groundView))}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain&&this.basemapTerrain.spatialReference}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get clippingArea(){if(this.viewingMode==="global")return null;let e=this._userClippingArea||this.get("map.clippingArea");return!(!!this._userClippingArea||this.get("map.clippingEnabled"))||R(e)?(this._clippingArea=null,null):e instanceof Xt?this.spatialReference&&(e=XP(e,this.spatialReference),R(e))?(Nl.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),R(e.intersection(this.groundAndLayersExtent))&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(Nl.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&this.viewingMode==="global"&&_(e)?Nl.error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===Ie.Global)return null;const e=this.renderSpatialReference,t=this.dataExtent;return R(t)||R(e)||t.spatialReference.equals(e)?t:XP(t,e)}get dataExtent(){let e=this.groundAndLayersExtent;const t=this.spatialReference||He.WGS84,i=XP(this.clippingArea,t);_(i)&&(e=_(e)?e.intersection(i):i);const r=this._get("dataExtent");return _(e)&&e.equals(r)?r:e}get groundAndLayersExtent(){const e=this.spatialReference||He.WGS84;let t;const i=n=>{const o=XP(n,e);R(o)||(_(t)?t.union(o):t=o.clone())},r=this.basemapTerrain;if(r!=null&&r.spatialReference){const n=r.groundExtent;i(new Xt({xmin:n[0],ymin:n[1],zmin:0,xmax:n[2],ymax:n[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map){const n=o=>{!_(o.fullExtent)||o.type==="graphics"&&o.internal||i(o.fullExtent)};this.map.allLayers.forEach(o=>n(o))}if(R(t))return null;t.hasZ?(t.zmin=Math.min(0,t.zmin),t.zmax=Math.max(0,t.zmax)):(t.zmin=0,t.zmax=0);const s=this._get("groundAndLayersExtent");return t.equals(s)?s:t}set environment(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)}castEnvironment(e){return e?e instanceof tx?e:e instanceof nS?this.environment!=null?this.environment.cloneWithWebsceneEnvironment(e):tx.fromWebsceneEnvironment(e):Ir(tx,e):new tx}get pixelRatio(){return Math.min(this.windowDevicePixelRatio,this.maximumPixelRatio)}set pixelRatio(e){_(e)?this._override("pixelRatio",e):this._clearOverride("pixelRatio")}get maximumPixelRatio(){let e=1/0;const{maximumPixelRatio:t,maximumRenderResolution:i}=this.qualitySettings;if(t!=null&&(e=Math.min(e,t)),i!=null){const r=i/Math.max(this.width,this.height);e=Math.min(e,r)}return e}set maximumPixelRatio(e){_(e)?this._override("maximumPixelRatio",e):this._clearOverride("maximumPixelRatio")}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||_(this.activeTool)}get stationary(){return!this.animation&&!this.resizing&&(R(this.state)||this.state.stationary)}set qualityProfile(e){P$.isValidProfile(e)&&(P$.apply(e,this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||P$.getDefaultProfile()}set slicePlane(e){if(_(this._stage)&&this._stage.renderView.setRenderParameters({slicePlane:e}),R(e))return void this._set("slicePlane",null);const t=this.propertiesPool.get("slicePlane");HS(e,t),this._set("slicePlane",t)}get typeSpecificPreconditionsReady(){return!!this.viewingMode}get resolution(){return this.spatialReference!=null?ahe(this.scale,this.spatialReference):0}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return e!=null?U0.deriveUnitFromSR(e,this.spatialReference):null}get updating(){var e,t,i;if(this.destroyed)return!1;let r=0,s=this.layerViewManager.updating,n=s?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(o=>{if(o.isFulfilled()){if(o.updating){if(s=!0,o.suspended||uT(o))return;++n,r+=o.updatingProgress}}else++n});for(const o of[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this.featureTreeDebugger,this.toolViewManager,this.analysisViewManager])_(o)&&o.updating&&(n+=.1,r+=.5*.1);for(const o of[this.deconflictor,this.labeler,this.basemapTerrain])_(o)&&o.updating&&(++n,r+=o.updatingProgress);if(s=!!(s||n>0||this.updatingHandles.updating||!this.ready||!this.stationary||this._createGraphicsViewController||(e=this.inputManager)!=null&&e.hasPendingInputs||(t=this.map)!=null&&(i=t.allLayers)!=null&&i.some(o=>!o.isFulfilled())),s?(this._numUpdating=Math.max(n,this._numUpdating),r+=this._numUpdating-n):this._numUpdating=0,this._numUpdating>0?r/=this._numUpdating:r=s?0:1,this._get("updatingProgress")!==r){const o=this._resourceController.scheduler.now;if(r<1){const a=Math.min((o-this._lastUpdateTime)/2e3,1);r=this.updatingProgress*(1-a)+r*a}this._set("updatingProgress",r),this._lastUpdateTime=s&&r<1?o:0}return s}get viewingMode(){var e;const t=this._predeterminedViewingMode;if(_(t))return uC(t);const i=this.spatialReference;return i?_((e=this.defaultsFromMap)==null?void 0:e.viewingMode)&&i.equals(this.defaultsFromMap.spatialReference)?uC(this.defaultsFromMap.viewingMode):bS(i,Ie.Global)?"global":"local":"global"}set viewingMode(e){this.ready?Nl.error("#viewingMode","viewingMode cannot be set once view is ready"):e?this._override("viewingMode",e):e===void 0&&this._clearOverride("viewingMode")}get resourceController(){return this._resourceController}get performanceInfo(){return new dnt(this)}forceAnimationTime(e){this._stage.renderView.forcedAnimationTime=this.basemapTerrain.overlayManager.forcedAnimationTime=e}on(e,t,i,r){return this.viewEvents.on(e,t,i,r)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return Nl.error("#toMap()","Scene view cannot be used before it is ready"),null;const i=t?this.externalToInternalIntersectOptions(t):this._defaultToMapOptions,r=_(i.graphics)&&(_(i.graphics.include)||_(i.graphics.exclude)),s=HK(e)?jK(this,e):e,n=em(s);i.enableDraped=i.include&&!i.include.has(N_)||i.exclude&&i.exclude.has(N_);const o=this.sceneIntersectionHelper,a=ku(this.state.viewingMode);if(a.options.selectionMode=!0,a.options.store=r?Wn.ALL:Wn.MIN,o.intersectIntersectorScreen(n,a,i),r){for(const l of a.results.all){const c=Mne(l,this);if(R(c))return this._intersectResultToMapPoint(l);if(this._testGraphicUidFilter(i.graphics,c))return this._intersectResultToMapPoint(l)}return null}return this._intersectResultToMapPoint(a.results.min)}toScreen(e){if(!this.ready)return Nl.error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=gt(e.z==null&&Vh(this.elevationProvider,e),0);return tn(e,vw,this.renderSpatialReference,t),this.state.camera.projectToScreen(vw,Zz),Jh(Zz[0],Zz[1])}pixelSizeAt(e){return this.ready?e?(tn(e,vw,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(vw)):0:(Nl.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e):1}hitTest(e,t){if(!this.ready)return Nl.error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=HK(e)?jK(this,e):e,r=Rr(i.x,i.y),s=t?this.externalToInternalIntersectOptions(t):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const n=ku(this.state.viewingMode);n.options.selectionMode=!0,n.options.store=Wn.ALL,this.sceneIntersectionHelper.intersectIntersectorScreen(r,n,s);const o=this._intersectResultsToHits(n.results.all,s.graphics),a=n.results.ground,l=One(a,this),c=_(l)&&"type"in l&&l.type==="integrated-mesh"?l:null,h={screenPoint:i,results:o,ground:{mapPoint:this._intersectResultToMapPoint(a),distance:jp(a)?a.distanceInRenderSpace:0,layer:c}};return hi.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(h.intersector=n),Promise.resolve(h)}popupHitTest(e){return bdt(this,e).then(({results:t,ground:i})=>{let r=null;return!(t.length===0||Math.abs(gt(t[0].distance,0)-i.distance)<1e-5)||i.layer&&i.layer.type==="integrated-mesh"||(r=i.mapPoint),{results:t,screenPoint:e,mapPoint:r}})}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(await this.whenReady(),R(e.parent))throw new q("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return e.parent.type==="analysis"?(await this.whenLayerView(e.parent)).whenAnalysisView(e):this.analysisViewManager.whenAnalysisView(e)}whenLayerView(e){return super.whenLayerView(e)}takeScreenshot(e){return this.whenReady().then(()=>{const t=uKe(e,this);return t.pixelRatio/=this.pixelRatio,this._stage.renderView.takeScreenshot(mKe(t,this.supersampleScreenshotsEnabled,this.padding))})}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return KK.importLayerView(e)}hasLayerViewModule(e){return KK.hasLayerViewModule(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){var e,t,i,r;return this.map&&"initialViewProperties"in this.map&&((e=this.map)==null||(t=e.initialViewProperties)==null?void 0:t.spatialReference)||((i=this.defaultsFromMap)==null?void 0:i.spatialReference)||((r=this.defaultsFromMap)==null?void 0:r.ready)&&this._initialDefaultSpatialReference||null}async validate(){let e=Cdt(this.type);if(ue("safari")&&ue("safari")<9&&(e=new q("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:ue("safari")})),_(e))throw Nl.warn("#validate()",e.message),e}get _predeterminedViewingMode(){var e,t;const i=this._isOverridden("viewingMode")?this._get("viewingMode"):(e=this.map&&"initialViewProperties"in this.map?(t=this.map.initialViewProperties)==null?void 0:t.viewingMode:null)!=null?e:null;return _(i)?ZK(i):null}getSpatialReferenceSupport({spatialReference:e,layer:t}){const i=this._predeterminedViewingMode;if(_(i))return this._validateSpatialReferenceForViewingMode(e,t,i)?{constraints:this._makeSpatialReferenceConstraints(e,t,i)}:null;const r=this._validateSpatialReferenceForViewingMode(e,t,Ie.Local),s=this._validateSpatialReferenceForViewingMode(e,t,Ie.Global);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:r?{constraints:this._makeSpatialReferenceConstraints(e,t,Ie.Local)}:{constraints:this._makeSpatialReferenceConstraints(e,t,Ie.Global)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!!bS(e,i)&&(!!R(t)||!!DZ(t)||(!eC(t)||!R(H4(t,e,i)))&&(!LZ(t)||i!==Ie.Global))}_makeSpatialReferenceConstraints(e,t,i){if(R(t))return[{spatialReference:e,viewingMode:i}];const r=e.isWebMercator,s=e.isWGS84;return DZ(t)&&(r||s)?!s||i===Ie.Local||j4(t.tileInfo,t.fullExtent,e,Ie.Global)===null?[{spatialReference:e,viewingMode:i},{spatialReference:He.WebMercator,viewingMode:i}]:[{spatialReference:r?He.WGS84:He.WebMercator,viewingMode:i}]:eC(t)||LZ(t)||!r&&!s?eC(t)&&r&&i!==Ie.Global?[{spatialReference:e,viewingMode:i},{spatialReference:He.WGS84,viewingMode:Ie.Local}]:[{spatialReference:e,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:r?He.WGS84:He.WebMercator,viewingMode:i}]}_validateSpatialReference(e){const t=_(this.getSpatialReferenceSupport({spatialReference:e})),i=this._predeterminedViewingMode;return t||(_(i)?Nl.warnOnce(`Spatial reference defined on view not supported in ${uC(i)} viewing mode.`):e.isGeographic&&Nl.warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise(e=>{this.ready?e(this):this._resolveWhenReady.push(e)})}computeMapPointFromVec3d(e,t){let i=this.spatialReference||He.WGS84;return wn(e,this.renderSpatialReference,e,i)||(i=He.WGS84,wn(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new et(e,i),t}trackGraphicState(e){if(!e.graphic)return Nl.error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=n=>{var o;!r&&_(n)&&"processor"in n&&((o=n.processor)==null?void 0:o.type)==="graphics-3d"&&n.processor.graphicsCore&&(i=n.processor.graphicsCore.trackGraphicState(e))};return _(t)?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),{remove:()=>{r=!0,_(i)&&(i.remove(),i=null)}}}highlight(e){if(Array.isArray(e))return ET(e.map(i=>this.highlight(i)));if(it.isCollection(e))return ET(e.toArray().map(i=>this.highlight(i)));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):km()}maskOccludee(e){if(!e)return Nl.error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const s=n=>{!r&&_(n)&&C6e(n)&&(i=n.maskOccludee(e))};return _(t)?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),{remove:()=>{r=!0,_(i)&&(i.remove(),i=null)}}}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find(t=>t.layer===e.layer):null}graphicChanged(e){_(this.graphicsView)&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await mD(()=>this.graphicsView),this.graphicsView;if(!e.layer||!this.map)throw new q("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise((i,r)=>{const s=this.map.allLayers.on("change",n=>{n.added.indexOf(e.layer)!==-1&&(s.remove(),this.whenLayerView(e.layer).then(i,r))})}):this.whenLayerView(e.layer)}externalToInternalIntersectOptions(e){const t=this._externalToInternalRenderItems(e.include,OC.INCLUDE),i=this._externalToInternalRenderItems(e.exclude,OC.EXCLUDE);return{include:t.layerUids,exclude:i.layerUids,graphics:{include:t.graphicUids,exclude:i.graphicUids}}}_intersectResultToMapPoint(e,t){return e.getIntersectionPoint(vw)?(t=this.computeMapPointFromVec3d(vw,t),e.intersector===ur.TERRAIN&&this.basemapTerrain&&(t.z=gt(Vh(this.basemapTerrain,t),0)),t):null}_intersectResultsToHits(e,t){const i=new Array;let r=null;for(let s=0;s<e.length;s++){const n=e[s],o=One(n,this);if(_(o)&&(o===this.map.ground||"type"in o&&o.type==="integrated-mesh"))break;const a=Mne(n,this);if(!_(a))continue;if(R(r)&&s!==e.length-1&&(r=new Set),_(r)){const h=this._getGraphicFilterUid(a);if(r.has(h))continue;r.add(h)}if(!this._testGraphicUidFilter(t,a))continue;const l=this._intersectResultToMapPoint(n),c=n.distanceInRenderSpace;i.push({graphic:a,mapPoint:l,distance:c})}return i}_getGraphicFilterUid(e){if(e.layer&&"objectIdField"in e.layer){const t=e.attributes[e.layer.objectIdField];if(t)return`o-${e.layer.id}-${t}`}return`u-${e.uid}`}_testGraphicUidFilter(e,t){const i=this._getGraphicFilterUid(t);return R(e)||(R(e.include)||e.include.has(i))&&(R(e.exclude)||!e.exclude.has(i))}_externalToInternalRenderItems(e,t,i={layerUids:null,graphicUids:null}){if(!e)return i;if(e instanceof qo)Hdt(i,this._getGraphicFilterUid(e)),t===OC.INCLUDE&&(_(this.graphicsView)&&e.layer===this?xE(i,this.graphicsView.processor.layer.id):e.layer&&xE(i,e.layer.uid));else if(YCe(e))for(const r of e)r===this.graphics&&_(this.graphicsView)?xE(i,this.graphicsView.processor.layer.id):r instanceof kT?r===this.map.ground&&xE(i,N_):this._externalToInternalRenderItems(r,t,i);else xE(i,e.uid);return i}_initBasemapTerrain(){this._set("basemapTerrain",new alt({view:this})),this._set("elevationProvider",new AA({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new T1e({view:this})),this._set("featureTiles",new a1e({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.contentCameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{const t=this.basemapTerrain&&this.basemapTerrain.extent;if(this.clippingArea||t)if(t&&this.basemapTerrain.spatialReference){const i=_(this.basemapTerrain.extent)?dO(BN(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;_(this.clippingArea)?this.featureTiles.filterExtent=this.clippingArea.intersection(i):this.featureTiles.filterExtent=i}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add(()=>hi.FEATURE_TILE_TREE_SHOW_TILES,t=>{t&&this.featureTiles&&!this.featureTreeDebugger?this.updatingHandles.addPromise(import("./FeatureTileTree3DDebugger.d2ab91a9.js")).then(({FeatureTileTree3DDebugger:i})=>{!this.featureTreeDebugger&&hi.FEATURE_TILE_TREE_SHOW_TILES&&(this.featureTreeDebugger=new i({view:this}))}):t||!this.featureTreeDebugger||hi.FEATURE_TILE_TREE_SHOW_TILES||(this.featureTreeDebugger.destroy(),this.featureTreeDebugger=null)},rc),this.updatingHandles.add(()=>this.clippingArea,e,rc),this.updatingHandles.add(()=>this.basemapTerrain.extent,e,rc)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.deinit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new Est(this.map,e));const t=this.state.isGlobal,i=nhe(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",nN.create(this.state.viewingMode,i)),t||this.handles.add(this.watch("basemapTerrain.extent",r=>{const s=this.renderCoordsHelper.spatialReference;r[0]===0&&r[1]===0&&r[2]===0&&r[3]===0||!nF(r,this.basemapTerrain.spatialReference,Nne,s)||(this.renderCoordsHelper.extent=Nne)},!0),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(_S/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){_(e)&&e.type===Ai.MOVE||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach(t=>{t.destroyed||(this.handles.add([t.watch(["updating","updatingProgress"],()=>this._updatingChanged(),!0)],"updatingMonitors"),t.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}_renderScreenshotOverlay(e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const i=e.getContext("2d");return i.putImageData(t,0,0),this.overlay.renderCanvas(e),i.getImageData(0,0,t.width,t.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,canvas:this.renderCanvas,screenshot:{renderOverlay:(a,l)=>this._renderScreenshotOverlay(a,l)}},t=new hst(this.state.viewingMode,a=>this._stage.layers.forAll(a),this);this._set("sceneIntersectionHelper",t);const i=KN(this.surface),{resourceController:r,state:s,renderSpatialReference:n}=this;this._stage=new aa({options:e,container:i,resourceController:r,state:s,sceneIntersectionHelper:t,renderSR:n}),this._stage.renderView.setRenderParameters({slicePlane:this.slicePlane}),this._lostWebGLContextHandle=eO(this._stage.renderView.canvas,"webglcontextlost",()=>this.fatalError=new q("webgl-context-lost")),this.handles.add([this.updatingHandles.add(()=>this.qualitySettings.antialiasingEnabled,()=>this._stage.renderView.setRenderParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled}),fn),this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,()=>this._stage.renderView.setRenderParameters({highQualityTransparency:this.qualitySettings.highQualityTransparency}),fn),Nt(()=>this.magnifier,a=>this._stage.renderView.magnifier=a,rc)],"stage");const o=()=>{this._stage.renderView.setRenderParameters({defaultHighlightOptions:mG.toEngineOptions(this.highlightOptions)})};this.handles.add(this.updatingHandles.add(()=>[this.highlightOptions.color,this.highlightOptions.haloColor,this.highlightOptions.haloOpacity,this.highlightOptions.fillOpacity,this.highlightOptions.shadowOpacity,this.highlightOptions.shadowColor,this.highlightOptions.shadowDifference],o),"stage"),o(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(_S/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new fnt({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state,objectResourceCache:new prt})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController||this.graphics.length===0)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=new AbortController;const e=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this._updatingChanged()}async _createGraphicsViewAsync(e){const t=(await import("./GraphicsView3D.268e5a36.js")).default;Qt(e),await mD(()=>{var i;return((i=this.basemapTerrain)==null?void 0:i.ready)===!0},e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),_(this.graphicsView)&&(this.handles.remove(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const e=ZK(this.viewingMode);if(e===Ie.Global&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.handles.add(Yx(()=>this.graphics,"after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const i=this.get("map.initialViewProperties.environment");i&&(this.environment=i)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const t=this._resolveWhenReady;this._resolveWhenReady=[],t.forEach(i=>i(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(N_);for(const e of this.map.allLayers.items)e.type==="integrated-mesh"&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(N_);for(const e of this.map.allLayers.items)e.type==="integrated-mesh"&&e.opacity<1&&this._defaultToMapOptions.exclude.add(e.uid)}}getVoxelWasmPerSceneView(){return Ax.getInstance().getVoxelWasmPerSceneView(this)}};function xE(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function Hdt(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}function XP(e,t){return _(e)&&M1(e.spatialReference,t)?dO(e,t):null}var OC;u([d()],Ke.prototype,"_userClippingArea",void 0),u([d()],Ke.prototype,"_resourceController",void 0),u([d()],Ke.prototype,"_stage",void 0),u([d({readOnly:!0})],Ke.prototype,"deconflictor",void 0),u([d({readOnly:!0})],Ke.prototype,"labeler",void 0),u([d(WB(YT,"analyses"))],Ke.prototype,"analyses",void 0),u([d({type:sS,readOnly:!0,aliasOf:"state.animation"})],Ke.prototype,"animation",void 0),u([d({readOnly:!0})],Ke.prototype,"basemapTerrain",void 0),u([d({readOnly:!0})],Ke.prototype,"elevationProvider",void 0),u([d({type:_l,aliasOf:"stateManager.camera"})],Ke.prototype,"camera",void 0),u([d({type:_l,aliasOf:"stateManager.contentCamera"})],Ke.prototype,"contentCamera",void 0),u([d({readOnly:!0})],Ke.prototype,"canvas",void 0),u([d({type:et,aliasOf:"stateManager.center"})],Ke.prototype,"center",void 0),u([d({type:Xt})],Ke.prototype,"clippingArea",null),u([d({type:Yme})],Ke.prototype,"constraints",void 0),u([d({type:Xt,readOnly:!0})],Ke.prototype,"renderDataExtent",null),u([d({type:Xt,readOnly:!0})],Ke.prototype,"dataExtent",null),u([d({type:Xt,readOnly:!0})],Ke.prototype,"groundAndLayersExtent",null),u([d({value:null,type:tx})],Ke.prototype,"environment",null),u([At("environment")],Ke.prototype,"castEnvironment",null),u([d({readOnly:!0})],Ke.prototype,"environmentManager",void 0),u([d({type:Xt,aliasOf:"stateManager.extent"})],Ke.prototype,"extent",void 0),u([d()],Ke.prototype,"floors",void 0),u([d({readOnly:!0,aliasOf:"stateManager.screenCenter"})],Ke.prototype,"screenCenter",void 0),u([d({type:Number})],Ke.prototype,"pixelRatio",null),u([d({type:Number,dependsOn:["qualitySettings.maximumPixelRatio","qualitySettings.maximumRenderResolution","size"]})],Ke.prototype,"maximumPixelRatio",null),u([d({aliasOf:"stateManager.frustum"})],Ke.prototype,"frustum",void 0),u([d({type:Number,readOnly:!0})],Ke.prototype,"fullOpacity",void 0),u([d({readOnly:!0})],Ke.prototype,"graphicsView",void 0),u([d({readOnly:!0})],Ke.prototype,"analysisViewManager",void 0),u([d()],Ke.prototype,"groundView",void 0),u([d({type:Boolean})],Ke.prototype,"initialExtentRequired",null),u([d()],Ke.prototype,"_defaultsFromMapSettings",null),u([d({type:Boolean,readOnly:!0})],Ke.prototype,"interacting",null),u([d()],Ke.prototype,"stationary",null),u([d({aliasOf:"state.navigating"})],Ke.prototype,"navigating",void 0),u([d()],Ke.prototype,"map",void 0),u([d({readOnly:!0})],Ke.prototype,"mapCoordsHelper",void 0),u([d({aliasOf:"stateManager.padding"})],Ke.prototype,"padding",void 0),u([d({type:T1e,readOnly:!0})],Ke.prototype,"pointsOfInterest",void 0),u([d({type:a1e,readOnly:!0})],Ke.prototype,"featureTiles",void 0),u([d()],Ke.prototype,"featureTreeDebugger",void 0),u([d({type:Boolean})],Ke.prototype,"screenSizePerspectiveEnabled",void 0),u([d({constructOnly:!0})],Ke.prototype,"deactivatedWebGLExtensions",void 0),u([d({constructOnly:!0})],Ke.prototype,"debugWebGLExtensions",void 0),u([d({constructOnly:!0})],Ke.prototype,"renderCanvas",void 0),u([d({constructOnly:!0})],Ke.prototype,"state",void 0),u([d({readOnly:!0})],Ke.prototype,"inputManager",void 0),u([d({readOnly:!0})],Ke.prototype,"stateManager",void 0),u([d({type:["low","medium","high"]})],Ke.prototype,"qualityProfile",null),u([d({type:Lre,get(){let e=this._get("qualitySettings");return e||(e=new Lre,P$.apply(this.qualityProfile,e)),e}})],Ke.prototype,"qualitySettings",void 0),u([d()],Ke.prototype,"slicePlane",null),u([d({readOnly:!0})],Ke.prototype,"typeSpecificPreconditionsReady",null),u([d({readOnly:!0})],Ke.prototype,"renderCoordsHelper",void 0),u([d({readOnly:!0})],Ke.prototype,"sceneIntersectionHelper",void 0),u([d({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],Ke.prototype,"resolution",null),u([d({type:Number,aliasOf:"stateManager.scale"})],Ke.prototype,"scale",void 0),u([d()],Ke.prototype,"heightModelInfo",null),u([d()],Ke.prototype,"spatialReference",void 0),u([d({type:Boolean,constructOnly:!0})],Ke.prototype,"alphaCompositingEnabled",void 0),u([d({type:Boolean})],Ke.prototype,"supersampleScreenshotsEnabled",void 0),u([d({readOnly:!0})],Ke.prototype,"type",void 0),u([d({type:zbe})],Ke.prototype,"ui",void 0),u([d({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating","analysisViewManager.updating"]})],Ke.prototype,"updating",null),u([d({type:Number,readOnly:!0,dependsOn:["updating"]})],Ke.prototype,"updatingProgress",void 0),u([d({type:["global","local"]})],Ke.prototype,"viewingMode",null),u([d({type:xl,aliasOf:"stateManager.viewpoint"})],Ke.prototype,"viewpoint",void 0),u([d({type:Number,aliasOf:"stateManager.zoom"})],Ke.prototype,"zoom",void 0),u([d({type:mG})],Ke.prototype,"highlightOptions",void 0),Ke=u([P("esri.views.SceneView")],Ke),function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(OC||(OC={}));const vw=M(),Zz=Rr(),Nne=Dt(),g0t=Ke;function qdt(e){return e&&"getAtOrigin"in e&&"originOf"in e}function Fne(e){e&&e.writtenProperties&&e.writtenProperties.forEach(t=>{const i=t.target;t.newOrigin&&t.oldOrigin!==t.newOrigin&&qdt(i)&&i.updateOrigin(t.propName,t.newOrigin)})}let my=class extends fe{constructor(e){super(e),this.facilityIdField=null,this.layerId=null,this.nameField=null,this.siteIdField=null,this.sublayerId=null}};u([d({type:String,json:{write:!0}})],my.prototype,"facilityIdField",void 0),u([d({type:String,json:{write:!0}})],my.prototype,"layerId",void 0),u([d({type:String,json:{write:!0}})],my.prototype,"nameField",void 0),u([d({type:String,json:{write:!0}})],my.prototype,"siteIdField",void 0),u([d({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],my.prototype,"sublayerId",void 0),my=u([P("esri.layers.support.FacilityLayerInfo")],my);const Wdt=my;let Th=class extends fe{constructor(e){super(e),this.facilityIdField=null,this.layerId=null,this.levelIdField=null,this.levelNumberField=null,this.longNameField=null,this.shortNameField=null,this.sublayerId=null,this.verticalOrderField=null}};u([d({type:String,json:{write:!0}})],Th.prototype,"facilityIdField",void 0),u([d({type:String,json:{write:!0}})],Th.prototype,"layerId",void 0),u([d({type:String,json:{write:!0}})],Th.prototype,"levelIdField",void 0),u([d({type:String,json:{write:!0}})],Th.prototype,"levelNumberField",void 0),u([d({type:String,json:{write:!0}})],Th.prototype,"longNameField",void 0),u([d({type:String,json:{write:!0}})],Th.prototype,"shortNameField",void 0),u([d({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],Th.prototype,"sublayerId",void 0),u([d({type:String,json:{write:!0}})],Th.prototype,"verticalOrderField",void 0),Th=u([P("esri.layers.support.LevelLayerInfo")],Th);const Xdt=Th;let T_=class extends fe{constructor(e){super(e),this.layerId=null,this.nameField=null,this.siteIdField=null,this.sublayerId=null}};u([d({type:String,json:{write:!0}})],T_.prototype,"layerId",void 0),u([d({type:String,json:{write:!0}})],T_.prototype,"nameField",void 0),u([d({type:String,json:{write:!0}})],T_.prototype,"siteIdField",void 0),u([d({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],T_.prototype,"sublayerId",void 0),T_=u([P("esri.layers.support.SiteLayerInfo")],T_);const Ydt=T_;let mx=class extends fe{constructor(e){super(e),this.levelLayer=null,this.facilityLayer=null,this.siteLayer=null}};u([d({type:Xdt,json:{write:!0}})],mx.prototype,"levelLayer",void 0),u([d({type:Wdt,json:{write:!0}})],mx.prototype,"facilityLayer",void 0),u([d({type:Ydt,json:{write:!0}})],mx.prototype,"siteLayer",void 0),mx=u([P("esri.support.MapFloorInfo")],mx);const Zdt=mx,Qdt="webscene:failed-to-copy-embedded-resources",Jdt="webscene:schema-validation";function Kdt(){return new q(Qdt,"Copying of embedded resources is currently not supported")}function ept(e){return new q(Jdt,"Failed to save webscene due to schema validation errors. See 'details.errors' for more detailed information",{errors:e})}async function tpt(e,t={},i){await e.load(i);const r=bl(e.itemUrl,"resources"),{start:s=1,num:n=10,sortOrder:o="asc",sortField:a="created"}=t,l={query:{start:s,num:n,sortOrder:o,sortField:a,token:e.apiKey},signal:Pr(i,"signal")},c=await e.portal._request(r,l);return{total:c.total,nextStart:c.nextStart,resources:c.resources.map(({created:h,size:p,resource:f})=>({created:new Date(h),size:p,resource:e.resourceFromPath(f)}))}}async function ipt(e,t,i,r){if(!e.hasPath())throw new q(`portal-item-resource-${t}:invalid-path`,"Resource does not have a valid path");const s=e.portalItem;await s.load(r);const n=bl(s.userItemUrl,t==="add"?"addResources":"updateResources"),[o,a]=Bbe(e.path),l=await Vbe(i),c=new FormData;return o&&o!=="."&&c.append("resourcesPrefix",o),c.append("fileName",a),c.append("file",l,a),c.append("f","json"),_(r)&&r.access&&c.append("access",r.access),await s.portal._request(n,{method:"post",body:c,signal:Pr(r,"signal")}),e}async function rpt(e,t,i){if(!t.hasPath())throw new q("portal-item-resources-remove:invalid-path","Resource does not have a valid path");await e.load(i);const r=bl(e.userItemUrl,"removeResources");await e.portal._request(r,{method:"post",query:{resource:t.path},signal:Pr(i,"signal")}),t.portalItem=null}async function spt(e,t){await e.load(t);const i=bl(e.userItemUrl,"removeResources");return e.portal._request(i,{method:"post",query:{deleteAll:!0},signal:Pr(t,"signal")})}function Bbe(e){const t=e.lastIndexOf("/");return t===-1?[".",e]:[e.slice(0,t),e.slice(t+1)]}function xX(e){const[t,i]=npt(e),[r,s]=Bbe(t);return[r,s,i]}function npt(e){const t=GAe(e);return R(t)?[e,""]:[e.slice(0,e.length-t.length-1),`.${t}`]}async function Vbe(e){return e instanceof Blob?e:(await Ti(e.url,{responseType:"blob"})).data}function opt(e,t){if(!e.hasPath())return null;const[i,,r]=xX(e.path);return e.portalItem.resourceFromPath(bl(i,t+r))}function Gbe(e,t){if(!e.hasPath())return null;const[i,,r]=xX(e.path);return e.portalItem.resourceFromPath(bl(i,t+r))}var FA=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",addOrUpdateResource:ipt,contentToBlob:Vbe,fetchResources:tpt,getSiblingOfSameType:opt,getSiblingOfSameTypeI:Gbe,removeAllResources:spt,removeResource:rpt,splitPrefixFileNameAndExtension:xX});async function Une(e,t,i){if(!t||!t.resources)return;const r=t.portalItem===e.portalItem?new Set(e.paths):new Set;e.paths.length=0,e.portalItem=t.portalItem;const s=new Set(t.resources.toKeep.map(c=>c.resource.path)),n=new Set,o=[];s.forEach(c=>{r.delete(c),e.paths.push(c)});for(const c of t.resources.toUpdate)if(r.delete(c.resource.path),s.has(c.resource.path)||n.has(c.resource.path)){const{resource:h,content:p,finish:f,error:g}=c,y=Gbe(h,zhe());e.paths.push(y.path),o.push(kne({resource:y,content:p,finish:f,error:g},i))}else e.paths.push(c.resource.path),o.push(apt(c,i)),n.add(c.resource.path);for(const c of t.resources.toAdd)o.push(kne(c,i)),e.paths.push(c.resource.path);if(r.forEach(c=>{const h=t.portalItem.resourceFromPath(c);o.push(h.portalItem.removeResource(h).catch(()=>{}))}),o.length===0)return;const a=await Ks(o);Qt(i);const l=a.filter(c=>"error"in c).map(c=>c.error);if(l.length>0)throw new q("save:resources","Failed to save one or more resources",{errors:l})}async function kne(e,t){const i=await wl(e.resource.portalItem.addResource(e.resource,e.content,t));if(i.ok!==!0)throw e.error&&e.error(i.error),i.error;e.finish&&e.finish(e.resource)}async function apt(e,t){const i=await wl(e.resource.update(e.content,t));if(i.ok!==!0)throw e.error(i.error),i.error;e.finish(e.resource)}const lpt={width:600,height:400},YP=1.5;function cpt(e,t){t=t||lpt;let{width:i,height:r}=t;const s=i/r;return s<YP?r=i/YP:s>YP&&(i=r*YP),i>e.width&&(r*=e.width/i,i=e.width),r>e.height&&(i*=e.height/r,r=e.height),{width:Math.round(i),height:Math.round(r)}}function zne(e){return{enabled:!(e==null||!e.length)}}var kG;let gx=kG=class extends fe{constructor(e){super(e),this.exactMatch=!1,this.name=null,this.type=null}clone(){return new kG({exactMatch:this.exactMatch,type:this.type,name:this.name})}};u([d({type:Boolean,json:{write:!0}})],gx.prototype,"exactMatch",void 0),u([d({type:String,json:{write:!0}})],gx.prototype,"name",void 0),u([ut(pH)],gx.prototype,"type",void 0),gx=kG=u([P("esri.webdoc.applicationProperties.SearchLayerField")],gx);const upt=gx;var zG;let yx=zG=class extends fe{constructor(e){super(e),this.field=null,this.id=null,this.subLayer=null}clone(){return new zG(se({field:this.field,id:this.id,subLayer:this.subLayer}))}};u([d({type:upt,json:{write:{isRequired:!0}}})],yx.prototype,"field",void 0),u([d({type:String,json:{write:{isRequired:!0}}})],yx.prototype,"id",void 0),u([d({type:ir,json:{write:!0}})],yx.prototype,"subLayer",void 0),yx=zG=u([P("esri.webdoc.applicationProperties.SearchLayer")],yx);const hpt=yx;var BG;let vx=BG=class extends fe{constructor(e){super(e),this.exactMatch=!1,this.name=null,this.type=null}clone(){return new BG({exactMatch:this.exactMatch,type:this.type,name:this.name})}};u([d({type:Boolean,json:{write:!0}})],vx.prototype,"exactMatch",void 0),u([d({type:String,json:{write:!0}})],vx.prototype,"name",void 0),u([ut(pH)],vx.prototype,"type",void 0),vx=BG=u([P("esri.webdoc.applicationProperties.SearchTableField")],vx);const dpt=vx;var VG;let UA=VG=class extends fe{constructor(e){super(e),this.field=null,this.id=null}clone(){return new VG(se({field:this.field,id:this.id}))}};u([d({type:dpt,json:{write:{isRequired:!0}}})],UA.prototype,"field",void 0),u([d({type:String,json:{write:{isRequired:!0}}})],UA.prototype,"id",void 0),UA=VG=u([P("esri.webdoc.applicationProperties.SearchTable")],UA);const ppt=UA;var GG;const jbe=it.ofType(hpt),Hbe=it.ofType(ppt);let Qd=GG=class extends fe{constructor(e){super(e),this.addressSearchEnabled=!0,this.enabled=!0,this.hintText=null,this.layers=new jbe,this.tables=new Hbe}readAddressSearchEnabled(e){return!e}writeAddressSearchEnabled(e,t,i){t[i]=!e}clone(){return new GG(se({addressSearchEnabled:this.addressSearchEnabled,enabled:this.enabled,hintText:this.hintText,layers:this.layers,tables:this.tables}))}};u([d({type:Boolean,nonNullable:!0,json:{read:{source:"disablePlaceFinder"},write:{target:"disablePlaceFinder",isRequired:!0},origins:{"web-scene":{read:!1,write:!1}}}})],Qd.prototype,"addressSearchEnabled",void 0),u([De("addressSearchEnabled")],Qd.prototype,"readAddressSearchEnabled",null),u([Fe("addressSearchEnabled")],Qd.prototype,"writeAddressSearchEnabled",null),u([d({type:Boolean,nonNullable:!0,json:{write:!0,origins:{"web-map":{write:{isRequired:!0}},"web-scene":{default:!0,write:!0}}}})],Qd.prototype,"enabled",void 0),u([d({type:String,json:{write:!0}})],Qd.prototype,"hintText",void 0),u([d({type:jbe,json:{write:{overridePolicy:zne},origins:{"web-scene":{write:{isRequired:!0}}}}})],Qd.prototype,"layers",void 0),u([d({type:Hbe,json:{read:!0,write:{overridePolicy:zne}}})],Qd.prototype,"tables",void 0),Qd=GG=u([P("esri.webdoc.applicationProperties.Search")],Qd);const fpt=Qd;var jG;let q$=jG=class extends fe{constructor(e){super(e),this.search=null}clone(){return new jG(se({search:this.search}))}};u([d({type:fpt,json:{write:!0}})],q$.prototype,"search",void 0),q$=jG=u([P("esri.webdoc.applicationProperties.Viewing")],q$);const mpt=q$;var HG;let W$=HG=class extends fe{constructor(e){super(e),this.viewing=null}clone(){return new HG({viewing:this.viewing?this.viewing.clone():null})}};u([d({type:mpt,json:{write:!0}})],W$.prototype,"viewing",void 0),W$=HG=u([P("esri.webscene.ApplicationProperties")],W$);const gpt=W$;var qG;let S_=qG=class extends fe{constructor(e){super(e),this.environment=new nS,this.spatialReference=null,this.viewpoint=null}set viewingMode(e){this._set("viewingMode",e)}clone(){return new qG({environment:this.environment.clone(),spatialReference:this.spatialReference?this.spatialReference.clone():null,viewingMode:this.viewingMode,viewpoint:this.viewpoint?this.viewpoint.clone():null})}};u([d({type:nS,json:{write:{isRequired:!0}}})],S_.prototype,"environment",void 0),u([d({type:He})],S_.prototype,"spatialReference",void 0),u([d({type:["local","global"]})],S_.prototype,"viewingMode",null),u([d({type:xl,json:{write:{isRequired:!0}}})],S_.prototype,"viewpoint",void 0),S_=qG=u([P("esri.webscene.InitialViewProperties")],S_);const mN=S_;var WG;let hm=WG=class extends fe{constructor(){super(...arguments),this.url=""}destroy(){this.url=""}clone(){return new WG({url:this.url})}};u([d({type:String,json:{write:{isRequired:!0}}})],hm.prototype,"url",void 0),hm=WG=u([P("esri.webdoc.support.SlideThumbnail")],hm);var XG;let X$=XG=class extends fe{constructor(){super(...arguments),this.text=""}clone(){return new XG({text:this.text})}};u([d({type:String,json:{write:!0}})],X$.prototype,"text",void 0),X$=XG=u([P("esri.webscene.support.Description")],X$);const Y$=X$;var YG;let MC=YG=class extends fe{constructor(){super(...arguments),this.lighting=new Mp}clone(){return new YG({lighting:Mp.prototype.clone.call(this.lighting)})}};u([d({type:Mp,json:{write:!0}})],MC.prototype,"lighting",void 0),MC=YG=u([P("esri.webscene.Environment")],MC);var Z$;let Q$=Z$=class extends fe{constructor(){super(...arguments),this.opacity=null}clone(){return new Z$({opacity:this.opacity})}cloneAndApplyTo(e){return this.opacity==null||((e=e!=null?e.clone():new kT).opacity=this.opacity),e}static fromGround(e){return new Z$({opacity:e.opacity})}};u([d({type:Number,json:{type:ir,read:{reader:NT,source:"transparency"},write:{writer:(e,t)=>{t.transparency=zN(e)},target:"transparency"}}})],Q$.prototype,"opacity",void 0),Q$=Z$=u([P("esri.webscene.support.SlideGround")],Q$);const qbe=Q$;var ZG;let Hx=ZG=class extends fe{constructor(e){super(e),this.id="",this.sublayerIds=null}clone(){return new ZG({id:this.id,sublayerIds:se(this.sublayerIds)})}};u([d({type:String,json:{write:!0}})],Hx.prototype,"id",void 0),u([d({type:[ir],json:{read:{source:"subLayerIds"},write:{target:"subLayerIds"}}})],Hx.prototype,"sublayerIds",void 0),Hx=ZG=u([P("esri.webscene.support.SlideVisibleLayer")],Hx);var QG;let J$=QG=class extends fe{constructor(){super(...arguments),this.text=""}clone(){return new QG({text:this.text})}};u([d({type:String,json:{write:{isRequired:!0}}})],J$.prototype,"text",void 0),J$=QG=u([P("esri.webscene.support.Title")],J$);const PC=J$;let ypt=0;const JG=it.ofType(Hx),vpt=he.getLogger("esri.webscene.Slide");let oo=class extends fe{constructor(e){super(e),this.id=Date.now().toString(16)+"-slide-"+ypt++,this.title=new PC,this.description=new Y$,this.thumbnail=new hm,this.viewpoint=null,this.basemap=null,this.ground=null,this.environment=new MC,this.visibleLayers=new JG}destroy(){this.visibleLayers.removeAll(),this.basemap=null,this.thumbnail&&this.thumbnail.destroy(),this.description=null,this.title=null,this.thumbnail=null}castTitle(e){return typeof e=="string"?new PC({text:e}):Ir(PC,e)}castDescription(e){return typeof e=="string"?new Y$({text:e}):Ir(Y$,e)}castThumbnail(e){return typeof e=="string"?new hm({url:e}):Ir(hm,e)}castBasemap(e){return lq(e)}set visibleLayers(e){this._set("visibleLayers",Om(e,this._get("visibleLayers"),JG))}castVisibleLayers(e){return e&&typeof e.map=="function"?e.map(t=>{if(typeof t=="string")return{id:t};if(t instanceof PF){const i=Bne(t);return{id:t.id,sublayerIds:i}}return t.id?{id:t.id,sublayerIds:t.sublayerIds}:(vpt.warn('Invalid visible layer, expected { id }, Layer or "id"'),t)}):null}clone(){return new this.constructor({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,ground:this.ground&&this.ground.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})}_updateVisibleLayersFrom(e){const t=[];return Ks(this._getLayers(e.map).map(i=>e.whenLayerView(i).then(r=>{if(r.visible){const s=Bne(i);t.push(new Hx({id:r.layer.id,sublayerIds:s}))}})).toArray()).then(()=>{this.visibleLayers.removeAll(),this.visibleLayers.addMany(t)})}updateFrom(e,t){return t={screenshot:I({format:"png",quality:80,width:120,height:75,disableDecorations:!0},t&&t.screenshot)},e.when(()=>(this.viewpoint=e.viewpoint.clone(),this.environment.lighting=Mp.prototype.clone.apply(e.environment.lighting),this.basemap=e.map.basemap&&e.map.basemap.clone()||null,this.ground=e.map.ground?qbe.fromGround(e.map.ground):null,this._updateVisibleLayersFrom(e))).then(()=>e.takeScreenshot(t.screenshot)).then(i=>(this.thumbnail=new hm({url:i.dataUrl}),this))}async applyTo(e,t){_(this._applyToController)&&this._applyToController.abort();let i=new AbortController;this._applyToController=i;const r=tO(t,()=>i.abort()),s=e.resourceController.scheduler.registerTask(ht.SLIDE);let n=!1;t=me(I({animate:!0},t),{signal:this._applyToController.signal});const o=async()=>{await $C([s.schedule(()=>n=this._setViewpointOfInterest(e,t)),s.schedule(()=>this._applyBasemap(e,t),t.signal)]),await $C([s.schedule(()=>this._applyLayerVisibility(e),t.signal),s.schedule(()=>this._applyGround(e),t.signal),s.schedule(()=>this._applyViewpoint(e,t),t.signal)])},a=await wl(e.addUpdatingPromise(o()));if(n&&(e.contentCamera=null),s.remove(),this._applyToController===i&&(this._applyToController=null),i=null,r==null||r.remove(),a.ok===!1)throw a.error;return this}async _applyBasemap(e,t){if(this.basemap){try{await this.basemap.load(t)}catch(i){if(pr(i))throw i}e.map.basemap=gBe(this.basemap,e.map.basemap)}}_applyGround(e){this.ground&&(e.map.ground=this.ground.cloneAndApplyTo(e.map.ground))}_getLayers(e){const t=new it;return this._collectLayers(e,t),this._collectLayers(e.ground,t),t}_collectLayers(e,t){e.layers.forEach(i=>{_ke(i)&&(t.add(i),"layers"in i&&this._collectLayers(i,t))})}_applyLayerVisibility(e){!this.visibleLayers||this._getLayers(e.map).forEach(t=>{const i=this.visibleLayers.find(n=>n.id===t.id);t.visible=i!=null;const r=i&&i.sublayerIds,s=Wbe(t);r&&s&&s.forEach(n=>n.visible=r.indexOf(n.id)>=0)})}_setViewpointOfInterest(e,t){if(e.state.fixedContentCamera||!this.viewpoint||t.ignoreViewpoint||!t.useDestinationCamera)return!1;const i=ZW(e,this.viewpoint);return e.contentCamera=i,_(i)}async _applyViewpoint(e,t){if(this.viewpoint&&!t.ignoreViewpoint){if(_(this.viewpoint.camera)&&(this.viewpoint.camera.fov=e.camera.fov),t.animate&&this.get("environment.lighting.date"))return void await this._animateToLighting(e,t);t.animate&&(e.environment.applyLighting(this.environment.lighting.clone()),await e.goTo(this.viewpoint,t)),e.viewpoint=this.viewpoint}e.environment.applyLighting(this.environment.lighting.clone())}async _animateToLighting(e,t){let i=null;e.environment.lighting.type==="sun"&&(e.viewingMode==="global"&&(i=this._animateLightingWithCamera(e)),e.environment.lighting.cameraTrackingEnabled=!1),e.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled,this.environment.lighting.displayUTCOffset!=null&&e.environment.lighting.type==="sun"&&(e.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset);const r=e.goTo(this.viewpoint,t),s=()=>{i&&i.remove(),e.environment.lighting.type==="sun"&&(e.environment.lighting.cameraTrackingEnabled=!0)};return r.then(()=>{e.environment.applyLighting(this.environment.lighting.clone()),s()},n=>{throw s(),n})}_getTime(e){return[e.getTime(),3600*e.getUTCHours()+60*e.getUTCMinutes()+e.getUTCSeconds()]}_setTime(e,t,i){return e.setTime(t),e.setUTCHours(i/3600),e.setUTCMinutes(i%3600/60),e.setUTCSeconds(i%3600%60),e}_animateLightingWithCamera(e){const t=new Date(e.environment.lighting.date.toString()),[i,r]=this._getTime(t),[s,n]=this._getTime(this.environment.lighting.date),o=_pt(r,n),a=e.renderCoordsHelper,l=M();a.toRenderCoords(e.camera.position,l);const c=M(),h=M();_(this.viewpoint.camera)&&a.toRenderCoords(this.viewpoint.camera.position,c);const p=new Date;return e.watch("camera",f=>{a.toRenderCoords(f.position,h);const g=qn(l,h),y=qn(c,h);let v=0;g+y!==0&&(v=g/(g+y));const b=i+(s-i)*v,w=bpt(r,o*v);e.environment.lighting.date=this._setTime(p,b,w)})}static createFrom(e,t){return new this().updateFrom(e,t)}};function Wbe(e){if(e.type==="building-scene"||e.type==="map-image")return e.allSublayers.toArray()}function Bne(e){const t=Wbe(e);if(t)return t.filter(i=>i.visible).map(i=>i.id)}u([d({type:String,json:{write:{isRequired:!0}}})],oo.prototype,"id",void 0),u([d({type:PC,json:{default:()=>new PC({text:""}),write:{isRequired:!0}}})],oo.prototype,"title",void 0),u([At("title")],oo.prototype,"castTitle",null),u([d({type:Y$,json:{write:{overridePolicy:e=>({enabled:!(!e||!e.text)})}}})],oo.prototype,"description",void 0),u([At("description")],oo.prototype,"castDescription",null),u([d({type:hm,json:{default:()=>new hm({url:""}),write:{isRequired:!0}}})],oo.prototype,"thumbnail",void 0),u([At("thumbnail")],oo.prototype,"castThumbnail",null),u([d({type:xl,nonNullable:!0,json:{write:{isRequired:!0}}})],oo.prototype,"viewpoint",void 0),u([d({type:iS,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],oo.prototype,"basemap",void 0),u([At("basemap")],oo.prototype,"castBasemap",null),u([d({type:qbe,json:{write:!0}})],oo.prototype,"ground",void 0),u([d({type:JG,json:{write:{isRequired:!0}}})],oo.prototype,"visibleLayers",null),u([At("visibleLayers")],oo.prototype,"castVisibleLayers",null),u([d({type:MC,json:{write:!0}})],oo.prototype,"environment",void 0),oo=u([P("esri.webscene.Slide")],oo);const KG=86400,Vne=43200;function _pt(e,t){let i=t-e;return i>Vne&&(i-=KG),i<-Vne&&(i+=KG),i}function bpt(e,t){return e2e(e+t,KG)}const wpt=oo,e7=it.ofType(wpt);let K$=class extends fe{constructor(e){super(e),this.slides=new e7}destroy(){this.slides.forEach(e=>e.destroy()),this.slides.removeAll()}set slides(e){e&&(e=e.filter(t=>!!t.viewpoint)),this._set("slides",Om(e,this._get("slides"),e7))}clone(){return new this.constructor({slides:this.slides.clone()})}};u([d({type:e7,nonNullable:!0,json:{write:!0}}),At(pj)],K$.prototype,"slides",null),K$=u([P("esri.webscene.Presentation")],K$);const Xbe=K$;var t7;let _x=t7=class extends fe{constructor(e){super(e)}clone(){return new t7({name:this.name,path:this.path,title:this.title})}};u([d({type:String,json:{write:!0}})],_x.prototype,"name",void 0),u([d({type:String,json:{write:!0}})],_x.prototype,"path",void 0),u([d({type:String,json:{write:!0}})],_x.prototype,"title",void 0),_x=t7=u([P("esri.webscene.TransportationNetwork")],_x);const xpt=_x;class gN extends L0{constructor(t,i){super(t,i,"webscene")}get supportsGround(){return this.since(1,8)}get supportsVisibleElevationLayersInSlides(){return this.lessThan(1,8)}}const _w=he.getLogger("esri.WebScene"),vT=new gN(1,27),Tpt=()=>{const t=[],i=vT.major;for(let r=8;r<=vT.minor;r++)t.push(`${i}.${r}`);return t},Qz="Web Scene",ZP="ViewingMode-Local";let Ei=class extends Ep.LoadableMixin(kS(qH(Mme))){constructor(e){super(e),this._handles=new Ut,this.applicationProperties=null,this.clippingArea=null,this.clippingEnabled=!1,this.floorInfo=null,this.heightModelInfo=null,this.sourceVersion=null,this.transportationNetworks=null,this.presentation=new Xbe,this.initialViewProperties=new mN,this.portalItem=null,this.resourceInfo=null,this._debouncedSaveOperations=w7(async(t,i,r)=>{switch(t){case qx.SAVE:return this._saveImpl(i);case qx.SAVE_AS:return this._saveAsImpl(r,i)}}),this.resourceReferences={portalItem:null,paths:[]},this.authoringApp=null,this.authoringAppVersion=null,this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1}initialize(){if(this.when().catch(e=>{_w.error("#load()","Failed to load web scene",e)}),this.resourceInfo){let e;try{e=this._validateJSON(this.resourceInfo)}catch(t){return void this.addResolvingPromise(Promise.reject(t))}this.read(e),this.addResolvingPromise(this._validateSpatialReference()),this.addResolvingPromise(this._validateHeightModelInfo())}this._handles.add(this.allLayers.on("change",()=>this._scheduleLayersIdGC()))}destroy(){this._unscheduleLayersIdGC(),this._handles.destroy(),this.presentation&&this.presentation.destroy();const e=this.portalItem;this.portalItem=null,e==null||e.destroy()}writeClippingArea(e,t){t.clippingArea||(t.clippingArea={}),t.clippingArea.geometry=e.toJSON()}readClippingEnabled(e,t){return!!t.clippingArea&&!!t.clippingArea.clip}writeClippingEnabled(e,t){this.clippingArea&&(t.clippingArea||(t.clippingArea={}),t.clippingArea.clip=e)}writeLayers(e,t,i,r){const s=me(I({},r),{layerContainerType:"operational-layers"}),n=e.map(o=>this.verifyWriteLayer(o,r)?o.write({},s):null).filter(o=>!!o);t[i]=n.toArray()}verifyWriteLayer(e,t){return"write"in e||(t&&t.messages&&t.messages.push(new q("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted in web scenes`,{layer:e})),!1)}readSourceVersion(e,t){const[i,r]=t.version.split(".");return new gN(parseInt(i,10),parseInt(r,10))}writeSourceVersion(e,t,i){t[i]=`${vT.major}.${vT.minor}`}get thumbnailUrl(){return this.portalItem&&this.portalItem.thumbnailUrl||null}set thumbnailUrl(e){e?this._override("thumbnailUrl",e):(this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}set authoringApp(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)}writeAuthoringApp(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp="ArcGIS API for JavaScript"}set authoringAppVersion(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)}writeAuthoringAppVersion(e,t){e&&this._isAuthoringAppVersionSetByUser?t.authoringAppVersion=e:t.authoringAppVersion=fj}writeGround(e,t,i,r){t[i]=e?e.write({},r):{transparency:0,layers:[]}}readInitialViewProperties(e,t){const i={};return t.initialState&&t.initialState.environment&&(i.environment=nS.fromJSON(t.initialState.environment)),t.spatialReference?i.spatialReference=He.fromJSON(t.spatialReference):i.spatialReference=He.WebMercator,i.viewingMode=t.viewingMode||"global",t.initialState&&t.initialState.viewpoint&&(i.viewpoint=xl.fromJSON(t.initialState.viewpoint)),new mN(i)}get spatialReference(){var e,t;return(e=(t=this.initialViewProperties)==null?void 0:t.spatialReference)!=null?e:He.WebMercator}get viewingMode(){var e,t;return(e=(t=this.initialViewProperties)==null?void 0:t.viewingMode)!=null?e:"global"}load(e){return this.addResolvingPromise(this._loadFromSource()),Promise.resolve(this)}loadAll(){return Tj(this,e=>{const t=this.presentation&&this.presentation.slides;e(this.ground,this.basemap,this.layers,t&&t.map(i=>i.basemap))})}read(e,t){t=me(I({},t),{origin:"web-scene"});const i=this._isAuthoringAppVersionSetByUser,r=this._isAuthoringAppSetByUser;if(Tae(this,e,s=>super.read(e,s),t),r||(this._isAuthoringAppSetByUser=!1),i||(this._isAuthoringAppVersionSetByUser=!1),e.baseMap&&Array.isArray(e.baseMap.elevationLayers)&&this.sourceVersion.supportsVisibleElevationLayersInSlides){const s=e.baseMap.elevationLayers.map(l=>({id:l.id})),n=this.presentation.slides,o=(l,c)=>l.visibleLayers.some(h=>h.id===c),a=s.filter(l=>!n.some(c=>o(c,l.id)));n.forEach(l=>{l.visibleLayers.addMany(a)})}}_writeBasemapElevationLayers(e){const t=e.ground&&e.ground.layers;!e.baseMap&&t&&t.length&&(e.baseMap={title:"Basemap",baseMapLayers:[]}),e.baseMap&&(e.baseMap.elevationLayers=se(t))}write(e,t){var i;if(this.loadStatus!=="loaded"){const n=new q("webscene:not-loaded","Web scene must be loaded before it can be serialized");throw _w.error("#toJSON()","Web scene must be loaded before it can be serialized",this.loadError||this.loadStatus),n}this._runLayersIdGC();const r=!((i=t)!=null&&i.messages);t=me(I({messages:[]},t),{origin:"web-scene"});const s=super.write(e,t);if(r){const n=t.messages.filter(o=>o.name==="web-document-write:property-required");if(n.length){const o=new q("web-document:property-required","One or more properties that are required in the webscene JSON are missing, see details for the specific errors",{errors:n});throw _w.error("#toJSON()","One or more properties that are required in the webscene JSON are missing",n),o}}return this._writeBasemapElevationLayers(s),s}async save(e){return this._debouncedSaveOperations(qx.SAVE,e)}async _saveImpl(e){this.portalItem||(_w.error("save(): requires the .portalItem property to be set"),await Promise.reject(new q("webscene:portal-item-not-set","Portal item to save to has not been set on the WebScene"))),this.portalItem.type!==Qz&&await Promise.reject(new q("webscene:portal-item-wrong-type",`Portal item needs to have type "${Qz}"`));const t=this._updateFromPromise;await this._ensureLoadBeforeSave();const i=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:this.portalItem.itemUrl&&Ts(this.portalItem.itemUrl),messages:[],portal:this.portalItem.portal||Bn.getDefault(),portalItem:this.portalItem,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),r=this.write({},i);return await Promise.all(i.resources.pendingOperations),await this._verifySave(r,i,e),this._updateTypeKeywords(this.portalItem),await this.portalItem.update({data:r}),await Une(this.resourceReferences,i,null),Fne(i),t&&await t,await this._saveThumbnail(),this.portalItem}async saveAs(e,t){return this._debouncedSaveOperations(qx.SAVE_AS,t,e)}async _saveAsImpl(e,t){let i=tS.from(e);i||(_w.error("saveAs(portalItem): requires a portal item parameter"),await Promise.reject(new q("webscene:portal-item-required","saveAs requires a portal item to save to"))),i.id&&(i=i.clone(),i.id=null);const r=i.portal||Bn.getDefault();await this._ensureLoadBeforeSave(),i.type=Qz,i.portal=r;const s=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:null,messages:[],portal:r,portalItem:i,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),n=this.write({},s);await Promise.all(s.resources.pendingOperations),await this._verifySaveAs(n,s,t);const o=this.thumbnailUrl,a=!this._isOverridden("thumbnailUrl");return this._updateTypeKeywords(i),await r._signIn(),await r.user.addItem({item:i,folder:t&&t.folder,data:n}),await Une(this.resourceReferences,s,null),this.portalItem=i,P8.prototype.read.call(this,{version:n.version,authoringApp:n.authoringApp,authoringAppVersion:n.authoringAppVersion},{name:"web-scene",ignoreDefaults:!0,url:i.itemUrl&&Ts(i.itemUrl)}),Fne(s),o&&(this.thumbnailUrl=a?hj(o,"w","8192"):o),s.portalItem=i,await this._saveThumbnail(),i}async _saveThumbnail(){this._isOverridden("thumbnailUrl")&&(await this.portalItem.updateThumbnail({thumbnail:this.thumbnailUrl}),this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}_verifySave(e,t,i,r=!1){if(!OT(this.spatialReference))return Promise.reject(new q("webscene:unsupported-spatial-reference","Webscenes using spatial reference systems from Mars or Moon can not be saved currently."));let s,n=t.messages.filter(a=>a.type==="error").map(a=>new q(a.name,a.message,a.details));t.blockedRelativeUrls&&(n=n.concat(t.blockedRelativeUrls.map(a=>new q("url:unsupported",`Relative url '${a}' is not supported in Web Scene`)))),i&&i.ignoreUnsupported&&(n=n.filter(a=>a.name!=="layer:unsupported"&&a.name!=="symbol:unsupported"&&a.name!=="symbol-layer:unsupported"&&a.name!=="property:unsupported"&&a.name!=="url:unsupported"&&a.name!=="scenemodification:unsupported")),i!=null&&i.requiredPropertyChecksDisabled&&(n=n.filter(a=>a.name!=="web-document-write:property-required"));const o=i&&i.strictSchemaValidationEnabled;return s=o?import("./schemaValidator.c6c5643f.js").then(a=>{const l=a.validate(e);if(l.length>0){const c=`webscene did not validate:
${l.join(`
`)}`;_w.error(`${r?"saveAs":"save"}(): ${c}`)}return l.map(c=>new q("webscene:schema-validation",c))}).then(a=>{if(o&&a.length>0)throw ept(a.concat(n));return n}):Promise.resolve(n),s.then(a=>{if(a.length>0)return Promise.reject(new q("webscene:save","Failed to save webscene due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:a}))})}_verifySaveAs(e,t,i){return this.canNotSaveAs(t)?Promise.reject(Kdt()):this._verifySave(e,t,i,!0)}verifySaveAs(e){const t=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),i=this.write({},t);return this._verifySaveAs(i,t,e)}canNotSaveAs(e){return e||(e=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),this.write({},e)),e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.writtenUrls.length>0}async updateFrom(e,t={}){const i=this._updateFrom(e,t);this._updateFromPromise=i,await i,this._updateFromPromise===i&&(this._updateFromPromise=null)}async _updateFrom(e,t={}){if(await e.whenReady(),!t.environmentExcluded&&e.environment){if(e.environment.lighting.type&&e.environment.lighting.type!=="sun")throw new q("lighting:unsupported",`${e.environment.lighting.type} lighting cannot be stored in WebScene`);this.initialViewProperties.environment=nS.prototype.clone.apply(e.environment)}if(!t.viewpointExcluded&&e.viewpoint&&(this.initialViewProperties.viewpoint=e.viewpoint.clone()),this.initialViewProperties.spatialReference=e.spatialReference.clone(),this.initialViewProperties.viewingMode=e.viewingMode,_(e.clippingArea)?e.clippingArea!==this.clippingArea&&(this.clippingArea=e.clippingArea.clone(),this.clippingEnabled=!0):this.clippingEnabled=!1,e.heightModelInfo&&(this.heightModelInfo=e.heightModelInfo.clone()),e.map===this)for(const i of e.allLayerViews){const r="visible";r in i&&r in i.layer&&i._isOverridden(r)&&(i.layer[r]=i[r])}(t.thumbnailExcluded===!1||t.thumbnailExcluded==null&&!t.viewpointExcluded)&&await this._updateFromThumbnail(e,t.thumbnailSize||void 0)}async _updateFromThumbnail(e,t){const i=cpt(e,t),r=await e.takeScreenshot({format:"jpg",width:i.width,height:i.height,disableDecorations:!0});this.thumbnailUrl=r.dataUrl}_loadFromSource(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-scene"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):this._loadObjectsWithLayers()}_readAndLoadFromJSON(e,t){const i=this._validateJSON(e);return this.read(i,t),this._loadFromJSON(i,t)}_extractOperationalLayers(e){const t=[];if(!this.sourceVersion.supportsGround&&e.baseMap&&Array.isArray(e.baseMap.elevationLayers))for(const s of e.baseMap.elevationLayers)t.push(s);const i=[],r=s=>(s.layers&&(s.layers=s.layers.filter(r)),s.layerType!=="ArcGISTiledElevationServiceLayer"||(this.sourceVersion.supportsGround||i.push(s),!1));return{operationalLayers:e.operationalLayers?e.operationalLayers.filter(r):[],operationalElevationLayers:i,basemapElevationLayers:t}}_loadFromJSON(e,t){const i=new it;return this._validateSpatialReference().then(()=>this._validateHeightModelInfo()).then(()=>import("./layersCreator.cc0b2319.js")).then(({populateOperationalLayers:r})=>{const{operationalLayers:s,operationalElevationLayers:n,basemapElevationLayers:o}=this._extractOperationalLayers(e),a=[],l={context:me(I({},t),{layerContainerType:"operational-layers"})};if(this.portalItem&&(l.context.portal=this.portalItem.portal||Bn.getDefault()),o.length>0){const c=me(I({},l),{context:me(I({},l.context),{layerContainerType:"ground"})});c.defaultLayerType="ArcGISTiledElevationServiceLayer",a.push(r(this.ground.layers,o,c))}if(n.length>0){const c=me(I({},l),{context:me(I({},l.context),{layerContainerType:"ground"})});c.defaultLayerType="ArcGISTiledElevationServiceLayer",a.push(r(i,n,c))}return s&&s.length>0&&a.push(r(this.layers,s,l)),Ks(a).then(()=>{})}).then(()=>this._loadObjectsWithLayers()).then(()=>{this.ground.layers.addMany(i)})}async _ensureLoadBeforeSave(){await this.load(),await this._loadObjectsWithLayers();const e=[];for(const t of this.allLayers.items)if("beforeSave"in t&&typeof t.beforeSave=="function"){const i=t.beforeSave();i&&e.push(i)}await Ks(e)}async _loadObjectsWithLayers(){const e=[];this.ground&&e.push(this.ground.load()),this.basemap&&e.push(this.basemap.load()),this.presentation.slides.forEach(t=>{t.basemap&&e.push(t.basemap.load())}),await Ks(e)}async _loadFromItem(e){if(await e.load().catch(r=>{throw new q("webscene:load-portal-item","Failed to load portal item",{error:r})}),e.type!=="Web Scene")throw new q("webscene:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Scene'",{type:e.type});const t=await e.fetchData();this.resourceInfo=t;const i={origin:"web-scene",url:Ts(e.itemUrl),portal:e.portal||Bn.getDefault(),portalItem:e,readResourcePaths:[]};await this._readAndLoadFromJSON(t,i),this.resourceReferences={portalItem:e,paths:i.readResourcePaths}}_validateSpatialReference(){const e=this.initialViewProperties,t=this._sceneSpatialReference;let i;if(e.viewingMode!=="local"){if(!bS(t,Ie.Global))return Promise.reject(new q("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in global mode, only Web Mercator, WGS84 GCS or CGCS2000 are supported",{spatialReference:t,viewingMode:e.viewingMode}));i=a=>!a||M1(a,t)}else{if(!bS(t,Ie.Local))return Promise.reject(new q("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in local mode, only projected coordinate systems are supported",{spatialReference:t,viewingMode:e.viewingMode}));i=a=>!a||a.equals(t)}const r=a=>a&&(_(a.camera)&&a.camera.position&&a.camera.position.spatialReference||_(a.targetGeometry)&&a.targetGeometry.spatialReference),s=e.viewpoint,n=r(s);if(n&&!i(n))return Promise.reject(new q("webscene:incompatible-camera-spatial-reference","Camera spatial reference (${cameraSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{cameraSpatialReference:n,sceneSpatialReference:t,viewingMode:e.viewingMode}));const o=this.presentation.slides.find(a=>!i(r(a.viewpoint)));if(o){const a=r(o.viewpoint);return Promise.reject(new q("webscene:incompatible-slide-spatial-reference","Slide spatial reference (${slideSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{slideSpatialReference:a,sceneSpatialReference:t,viewingMode:e.viewingMode}))}return Promise.resolve()}_validateHeightModelInfo(){const e=this._sceneSpatialReference,t=qBe(this.heightModelInfo,e);return t?Promise.reject(t):Promise.resolve()}_validateJSON(e){const t=gN.parse(e.version||"","webscene");return vT.validate(t),e.version=`${t.major}.${t.minor}`,t.major===1&&t.minor<=2&&(e.spatialReference=He.WebMercator.toJSON()),e}_updateTypeKeywords(e){this.initialViewProperties.viewingMode==="local"?e.typeKeywords?e.typeKeywords.indexOf(ZP)===-1&&e.typeKeywords.push(ZP):e.typeKeywords=[ZP]:this.initialViewProperties.viewingMode==="global"&&e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(t=>t!==ZP)),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((t,i,r)=>r.indexOf(t)===i))}get _sceneSpatialReference(){return this.initialViewProperties.spatialReference||He.WebMercator}get _verifyItemRelativeRootPath(){return this.portalItem&&this.portalItem.itemUrl?Ts(this.portalItem.itemUrl).path:null}_enableVerifyItemRelativeUrls(e){const t=this._verifyItemRelativeRootPath;return t&&(e.verifyItemRelativeUrls={rootPath:t,writtenUrls:[]}),e}_unscheduleLayersIdGC(){this._layersIdGCTimeoutId&&(clearTimeout(this._layersIdGCTimeoutId),this._layersIdGCTimeoutId=0)}_scheduleLayersIdGC(){this._unscheduleLayersIdGC(),this._layersIdGCTimeoutId=setTimeout(()=>{this._layersIdGCTimeoutId=0,this._runLayersIdGC()},3e3)}_runLayersIdGC(){this._unscheduleLayersIdGC();const e=this.applicationProperties&&this.applicationProperties.viewing&&this.applicationProperties.viewing.search,t=r=>!!this.allLayers.find(s=>s.id===r);e&&e.layers&&(e.layers=e.layers.filter(r=>t(r.id)));const i=this.presentation&&this.presentation.slides;i&&i.forEach(r=>{r.visibleLayers&&(r.visibleLayers=r.visibleLayers.filter(s=>t(s.id)))})}static fromJSON(e){if(!e)throw new q("webscene:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:e})}};var qx;Ei.VERSION=vT,u([d({type:gpt,json:{write:!0}})],Ei.prototype,"applicationProperties",void 0),u([d({json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],Ei.prototype,"basemap",void 0),u([d({type:Xt,json:{read:{source:"clippingArea.geometry",reader:bp},write:{target:"clippingArea.geometry"}}})],Ei.prototype,"clippingArea",void 0),u([Fe("clippingArea")],Ei.prototype,"writeClippingArea",null),u([d({type:Boolean,json:{write:{target:"clippingArea.clip"}}})],Ei.prototype,"clippingEnabled",void 0),u([De("clippingEnabled",["clippingArea"])],Ei.prototype,"readClippingEnabled",null),u([Fe("clippingEnabled")],Ei.prototype,"writeClippingEnabled",null),u([d({type:Zdt,json:{read:{source:"mapFloorInfo"},write:{target:"mapFloorInfo"}}})],Ei.prototype,"floorInfo",void 0),u([d({type:U0,json:{write:!0}})],Ei.prototype,"heightModelInfo",void 0),u([d({json:{write:{target:"operationalLayers",ignoreOrigin:!0}}})],Ei.prototype,"layers",void 0),u([Fe("layers")],Ei.prototype,"writeLayers",null),u([d({readOnly:!0,type:gN,json:{type:Tpt(),write:{ignoreOrigin:!0,target:"version",isRequired:!0,overridePolicy:()=>({enabled:!0,allowNull:!0,ignoreOrigin:!0})}}})],Ei.prototype,"sourceVersion",void 0),u([De("sourceVersion",["version"])],Ei.prototype,"readSourceVersion",null),u([Fe("sourceVersion")],Ei.prototype,"writeSourceVersion",null),u([d({json:{read:!1,write:!1}})],Ei.prototype,"tables",void 0),u([d()],Ei.prototype,"thumbnailUrl",null),u([d({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],Ei.prototype,"authoringApp",null),u([Fe("authoringApp")],Ei.prototype,"writeAuthoringApp",null),u([d({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],Ei.prototype,"authoringAppVersion",null),u([Fe("authoringAppVersion")],Ei.prototype,"writeAuthoringAppVersion",null),u([d({json:{write:{isRequired:!0,allowNull:!0,ignoreOrigin:!0,enabled:!0}}})],Ei.prototype,"ground",void 0),u([Fe("ground")],Ei.prototype,"writeGround",null),u([d({type:it.ofType(xpt),json:{write:!0}})],Ei.prototype,"transportationNetworks",void 0),u([d({type:Xbe,nonNullable:!0,json:{write:{ignoreOrigin:!0,writer:(e,t,i,r)=>{if(e.slides&&e.slides.length>0){const s=me(I({},r),{isPresentation:!0});t.presentation=e.write({},s)}}}}})],Ei.prototype,"presentation",void 0),u([d({type:mN,nonNullable:!0,json:{write:{target:"initialState",isRequired:!0,ignoreOrigin:!0},default:()=>new mN({viewingMode:"global",spatialReference:He.WebMercator})}})],Ei.prototype,"initialViewProperties",void 0),u([De("initialViewProperties",["initialState.environment","spatialReference","viewingMode","initialState.viewpoint"])],Ei.prototype,"readInitialViewProperties",null),u([d({type:He,json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],Ei.prototype,"spatialReference",null),u([d({type:["local","global"],json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],Ei.prototype,"viewingMode",null),u([d({type:tS})],Ei.prototype,"portalItem",void 0),u([d()],Ei.prototype,"resourceInfo",void 0),Ei=u([P("esri.WebScene")],Ei),function(e){e[e.SAVE=0]="SAVE",e[e.SAVE_AS=1]="SAVE_AS"}(qx||(qx={}));const y0t=Ei,Hr={allRenderFn:!1,cmpDidLoad:!0,cmpDidUnload:!1,cmpDidUpdate:!0,cmpDidRender:!0,cmpWillLoad:!0,cmpWillUpdate:!0,cmpWillRender:!0,connectedCallback:!0,disconnectedCallback:!0,element:!0,event:!0,hasRenderFn:!0,lifecycle:!0,hostListener:!0,hostListenerTargetWindow:!0,hostListenerTargetDocument:!0,hostListenerTargetBody:!0,hostListenerTargetParent:!1,hostListenerTarget:!0,member:!0,method:!0,mode:!0,observeAttribute:!0,prop:!0,propMutable:!0,reflect:!0,scoped:!0,shadowDom:!0,slot:!0,cssAnnotations:!0,state:!0,style:!0,svg:!0,updatable:!0,vdomAttribute:!0,vdomXlink:!0,vdomClass:!0,vdomFunctional:!0,vdomKey:!0,vdomListener:!0,vdomRef:!0,vdomPropOrAttr:!0,vdomRender:!0,vdomStyle:!0,vdomText:!0,watchCallback:!0,taskQueue:!0,hotModuleReplacement:!1,isDebug:!1,isDev:!1,isTesting:!1,hydrateServerSide:!1,hydrateClientSide:!1,lifecycleDOMEvents:!1,lazyLoad:!1,profile:!1,slotRelocation:!0,appendChildSlotFix:!1,cloneNodeFix:!1,hydratedAttribute:!1,hydratedClass:!0,safari10:!1,scriptDataOpts:!1,scopedSlotTextContentFix:!1,shadowDomShim:!1,slotChildNodesFix:!1,invisiblePrehydration:!0,propBoolean:!0,propNumber:!0,propString:!0,cssVarShim:!1,constructableCSS:!0,cmpShouldUpdate:!0,devTools:!1,dynamicImportShim:!1,shadowDelegatesFocus:!0,initializeNextTick:!1,asyncLoading:!1,asyncQueue:!1,transformTagName:!1,attachStyles:!0};let bx,Ybe,r5,Zbe=!1,yN=!1,TX=!1,Kl=!1,Gne=null,i7=!1;const ZO=typeof window!="undefined"?window:{};Hr.cssVarShim&&ZO.CSS;const Xh=ZO.document||{head:{}},Spt=ZO.HTMLElement||class{},El={$flags$:0,$resourcesUrl$:"",jmp:e=>e(),raf:e=>requestAnimationFrame(e),ael:(e,t,i,r)=>e.addEventListener(t,i,r),rel:(e,t,i,r)=>e.removeEventListener(t,i,r),ce:(e,t)=>new CustomEvent(e,t)},vN=Hr.shadowDomShim&&Hr.shadowDom?(()=>(Xh.head.attachShadow+"").indexOf("[native")>-1)():!0,Ept=(()=>{let e=!1;try{Xh.addEventListener("e",null,Object.defineProperty({},"passive",{get(){e=!0}}))}catch{}return e})(),Apt=e=>Promise.resolve(e),Cpt=Hr.constructableCSS?(()=>{try{return new CSSStyleSheet,typeof new CSSStyleSheet().replace=="function"}catch{}return!1})():!1,Qbe=(e,t,i,r)=>{i&&i.map(([s,n,o])=>{const a=Opt(e,s),l=Rpt(t,o),c=Mpt(s);El.ael(a,n,l,c),(t.$rmListeners$=t.$rmListeners$||[]).push(()=>El.rel(a,n,l,c))})},Rpt=(e,t)=>i=>{try{Hr.lazyLoad||e.$hostElement$[t](i)}catch(r){QO(r)}},Opt=(e,t)=>t&4?Xh:t&8?ZO:t&16?Xh.body:e,Mpt=e=>Ept?{passive:(e&1)!==0,capture:(e&2)!==0}:(e&2)!==0,jne="http://www.w3.org/1999/xlink",rb=(e,t="")=>()=>{},Hne=new WeakMap,Ppt=(e,t,i)=>{let r=wN.get(e);Cpt&&i?(r=r||new CSSStyleSheet,r.replace(t)):r=t,wN.set(e,r)},Ipt=(e,t,i,r)=>{let s=Jbe(t,i),n=wN.get(s);if(e=e.nodeType===11?e:Xh,n)if(typeof n=="string"){e=e.head||e;let o=Hne.get(e),a;o||Hne.set(e,o=new Set),o.has(s)||(a=Xh.createElement("style"),a.innerHTML=n,e.insertBefore(a,e.querySelector("link")),o&&o.add(s))}else e.adoptedStyleSheets.includes(n)||(e.adoptedStyleSheets=[...e.adoptedStyleSheets,n]);return s},$pt=e=>{const t=e.$cmpMeta$,i=e.$hostElement$,r=t.$flags$,s=rb("attachStyles",t.$tagName$),n=Ipt(vN&&i.shadowRoot?i.shadowRoot:i.getRootNode(),t,e.$modeName$);r&10&&(i["s-sc"]=n,i.classList.add(n+"-h"),r&2&&i.classList.add(n+"-s")),s()},Jbe=(e,t)=>"sc-"+(t&&e.$flags$&32?e.$tagName$+"-"+t:e.$tagName$),Dpt=e=>lft.map(t=>t(e)).find(t=>!!t),qne={},Lpt="http://www.w3.org/2000/svg",Npt="http://www.w3.org/1999/xhtml",Fpt=e=>e!=null,SX=e=>(e=typeof e,e==="object"||e==="function"),ou=(e,t,...i)=>{let r=null,s=null,n=null,o=!1,a=!1,l=[];const c=p=>{for(let f=0;f<p.length;f++)r=p[f],Array.isArray(r)?c(r):r!=null&&typeof r!="boolean"&&((o=typeof e!="function"&&!SX(r))&&(r=String(r)),o&&a?l[l.length-1].$text$+=r:l.push(o?_N(null,r):r),a=o)};if(c(i),t&&(Hr.isDev&&e==="input"&&zpt(t),Hr.vdomKey&&t.key&&(s=t.key),Hr.slotRelocation&&t.name&&(n=t.name),Hr.vdomClass)){const p=t.className||t.class;p&&(t.class=typeof p!="object"?p:Object.keys(p).filter(f=>p[f]).join(" "))}if(Hr.isDev&&l.some(ewe)&&oft(`The <Host> must be the single root component. Make sure:
- You are NOT using hostData() and <Host> in the same component.
- <Host> is used once, and it's the single root component of the render() function.`),Hr.vdomFunctional&&typeof e=="function")return e(t===null?{}:t,l,Upt);const h=_N(e,null);return h.$attrs$=t,l.length>0&&(h.$children$=l),Hr.vdomKey&&(h.$key$=s),Hr.slotRelocation&&(h.$name$=n),h},_N=(e,t)=>{const i={$flags$:0,$tag$:e,$text$:t,$elm$:null,$children$:null};return Hr.vdomAttribute&&(i.$attrs$=null),Hr.vdomKey&&(i.$key$=null),Hr.slotRelocation&&(i.$name$=null),i},Kbe={},ewe=e=>e&&e.$tag$===Kbe,Upt={forEach:(e,t)=>e.map(Wne).forEach(t),map:(e,t)=>e.map(Wne).map(t).map(kpt)},Wne=e=>({vattrs:e.$attrs$,vchildren:e.$children$,vkey:e.$key$,vname:e.$name$,vtag:e.$tag$,vtext:e.$text$}),kpt=e=>{if(typeof e.vtag=="function"){const i=Object.assign({},e.vattrs);return e.vkey&&(i.key=e.vkey),e.vname&&(i.name=e.vname),ou(e.vtag,i,...e.vchildren||[])}const t=_N(e.vtag,e.vtext);return t.$attrs$=e.vattrs,t.$children$=e.vchildren,t.$key$=e.vkey,t.$name$=e.vname,t},zpt=e=>{const t=Object.keys(e),i=t.indexOf("value");if(i===-1)return;const r=t.indexOf("type"),s=t.indexOf("min"),n=t.indexOf("max"),o=t.indexOf("step");(i<r||i<s||i<n||i<o)&&aft('The "value" prop of <input> should be set after "min", "max", "type" and "step"')},Xne=(e,t,i,r,s,n)=>{if(i!==r){let o=Jne(e,t),a=t.toLowerCase();if(t==="class"){const l=e.classList,c=Yne(i),h=Yne(r);l.remove(...c.filter(p=>p&&!h.includes(p))),l.add(...h.filter(p=>p&&!c.includes(p)))}else if(t==="style"){for(const l in i)(!r||r[l]==null)&&(l.includes("-")?e.style.removeProperty(l):e.style[l]="");for(const l in r)(!i||r[l]!==i[l])&&(l.includes("-")?e.style.setProperty(l,r[l]):e.style[l]=r[l])}else if(t!=="key")if(t==="ref")r&&r(e);else if(!e.__lookupSetter__(t)&&t[0]==="o"&&t[1]==="n")t[2]==="-"?t=t.slice(3):Jne(ZO,a)?t=a.slice(2):t=a[2]+t.slice(3),i&&El.rel(e,t,i,!1),r&&El.ael(e,t,r,!1);else{const l=SX(r);if((o||l&&r!==null)&&!s)try{if(e.tagName.includes("-"))e[t]=r;else{let h=r==null?"":r;t==="list"?o=!1:(i==null||e[t]!=h)&&(e[t]=h)}}catch{}let c=!1;a!==(a=a.replace(/^xlink\:?/,""))&&(t=a,c=!0),r==null||r===!1?(r!==!1||e.getAttribute(t)==="")&&(c?e.removeAttributeNS(jne,t):e.removeAttribute(t)):(!o||n&4||s)&&!l&&(r=r===!0?"":r,c?e.setAttributeNS(jne,t,r):e.setAttribute(t,r))}}},Bpt=/\s/,Yne=e=>e?e.split(Bpt):[],twe=(e,t,i,r)=>{const s=t.$elm$.nodeType===11&&t.$elm$.host?t.$elm$.host:t.$elm$,n=e&&e.$attrs$||qne,o=t.$attrs$||qne;for(r in n)r in o||Xne(s,r,n[r],void 0,i,t.$flags$);for(r in o)Xne(s,r,n[r],o[r],i,t.$flags$)},bN=(e,t,i,r)=>{let s=t.$children$[i],n=0,o,a,l;if(Zbe||(TX=!0,s.$tag$==="slot"&&(bx&&r.classList.add(bx+"-s"),s.$flags$|=s.$children$?2:1)),s.$text$!==null)o=s.$elm$=Xh.createTextNode(s.$text$);else if(s.$flags$&1)o=s.$elm$=Xh.createTextNode("");else{if(Kl||(Kl=s.$tag$==="svg"),o=s.$elm$=Xh.createElementNS(Kl?Lpt:Npt,s.$flags$&2?"slot-fb":s.$tag$),Kl&&s.$tag$==="foreignObject"&&(Kl=!1),twe(null,s,Kl),Fpt(bx)&&o["s-si"]!==bx&&o.classList.add(o["s-si"]=bx),s.$children$)for(n=0;n<s.$children$.length;++n)a=bN(e,s,n,o),a&&o.appendChild(a);s.$tag$==="svg"?Kl=!1:o.tagName==="foreignObject"&&(Kl=!0)}return o["s-hn"]=r5,s.$flags$&3&&(o["s-sr"]=!0,o["s-cr"]=Ybe,o["s-sn"]=s.$name$||"",l=e&&e.$children$&&e.$children$[i],l&&l.$tag$===s.$tag$&&e.$elm$&&QR(e.$elm$,!1)),o},QR=(e,t)=>{El.$flags$|=1;const i=e.childNodes;for(let r=i.length-1;r>=0;r--){const s=i[r];s["s-hn"]!==r5&&s["s-ol"]&&(swe(s).insertBefore(s,EX(s)),s["s-ol"].remove(),s["s-ol"]=void 0,TX=!0),t&&QR(s,t)}El.$flags$&=-2},iwe=(e,t,i,r,s,n)=>{let o=e["s-cr"]&&e["s-cr"].parentNode||e,a;for(o.shadowRoot&&o.tagName===r5&&(o=o.shadowRoot);s<=n;++s)r[s]&&(a=bN(null,i,s,e),a&&(r[s].$elm$=a,o.insertBefore(a,EX(t))))},rwe=(e,t,i,r,s)=>{for(;t<=i;++t)(r=e[t])&&(s=r.$elm$,awe(r),yN=!0,s["s-ol"]?s["s-ol"].remove():QR(s,!0),s.remove())},Vpt=(e,t,i,r)=>{let s=0,n=0,o=0,a=0,l=t.length-1,c=t[0],h=t[l],p=r.length-1,f=r[0],g=r[p],y,v;for(;s<=l&&n<=p;)if(c==null)c=t[++s];else if(h==null)h=t[--l];else if(f==null)f=r[++n];else if(g==null)g=r[--p];else if(QP(c,f))wx(c,f),c=t[++s],f=r[++n];else if(QP(h,g))wx(h,g),h=t[--l],g=r[--p];else if(QP(c,g))(c.$tag$==="slot"||g.$tag$==="slot")&&QR(c.$elm$.parentNode,!1),wx(c,g),e.insertBefore(c.$elm$,h.$elm$.nextSibling),c=t[++s],g=r[--p];else if(QP(h,f))(c.$tag$==="slot"||g.$tag$==="slot")&&QR(h.$elm$.parentNode,!1),wx(h,f),e.insertBefore(h.$elm$,c.$elm$),h=t[--l],f=r[++n];else{for(o=-1,a=s;a<=l;++a)if(t[a]&&t[a].$key$!==null&&t[a].$key$===f.$key$){o=a;break}o>=0?(v=t[o],v.$tag$!==f.$tag$?y=bN(t&&t[n],i,o,e):(wx(v,f),t[o]=void 0,y=v.$elm$),f=r[++n]):(y=bN(t&&t[n],i,n,e),f=r[++n]),y&&swe(c.$elm$).insertBefore(y,EX(c.$elm$))}s>l?iwe(e,r[p+1]==null?null:r[p+1].$elm$,i,r,n,p):n>p&&rwe(t,s,l)},QP=(e,t)=>e.$tag$===t.$tag$?e.$tag$==="slot"?e.$name$===t.$name$:e.$key$===t.$key$:!1,EX=e=>e&&e["s-ol"]||e,swe=e=>(e["s-ol"]?e["s-ol"]:e).parentNode,wx=(e,t)=>{const i=t.$elm$=e.$elm$,r=e.$children$,s=t.$children$,n=t.$tag$,o=t.$text$;let a;o===null?(Kl=n==="svg"?!0:n==="foreignObject"?!1:Kl,n==="slot"||twe(e,t,Kl),r!==null&&s!==null?Vpt(i,r,t,s):s!==null?(e.$text$!==null&&(i.textContent=""),iwe(i,null,t,s,0,s.length-1)):r!==null&&rwe(r,0,r.length-1),Kl&&n==="svg"&&(Kl=!1)):(a=i["s-cr"])?a.parentNode.textContent=o:e.$text$!==o&&(i.data=o)},nwe=e=>{let t=e.childNodes,i,r,s,n,o,a;for(r=0,s=t.length;r<s;r++)if(i=t[r],i.nodeType===1){if(i["s-sr"]){for(o=i["s-sn"],i.hidden=!1,n=0;n<s;n++)if(a=t[n].nodeType,t[n]["s-hn"]!==i["s-hn"]||o!==""){if(a===1&&o===t[n].getAttribute("slot")){i.hidden=!0;break}}else if(a===1||a===3&&t[n].textContent.trim()!==""){i.hidden=!0;break}}nwe(i)}},Dh=[],owe=e=>{let t,i,r,s,n,o,a=0,l=e.childNodes,c=l.length;for(;a<c;a++){if(t=l[a],t["s-sr"]&&(i=t["s-cr"])&&i.parentNode)for(r=i.parentNode.childNodes,s=t["s-sn"],o=r.length-1;o>=0;o--)i=r[o],!i["s-cn"]&&!i["s-nr"]&&i["s-hn"]!==t["s-hn"]&&(Zne(i,s)?(n=Dh.find(h=>h.$nodeToRelocate$===i),yN=!0,i["s-sn"]=i["s-sn"]||s,n?n.$slotRefNode$=t:Dh.push({$slotRefNode$:t,$nodeToRelocate$:i}),i["s-sr"]&&Dh.map(h=>{Zne(h.$nodeToRelocate$,i["s-sn"])&&(n=Dh.find(p=>p.$nodeToRelocate$===i),n&&!h.$slotRefNode$&&(h.$slotRefNode$=n.$slotRefNode$))})):Dh.some(h=>h.$nodeToRelocate$===i)||Dh.push({$nodeToRelocate$:i}));t.nodeType===1&&owe(t)}},Zne=(e,t)=>e.nodeType===1?e.getAttribute("slot")===null&&t===""||e.getAttribute("slot")===t:e["s-sn"]===t?!0:t==="",awe=e=>{e.$attrs$&&e.$attrs$.ref&&e.$attrs$.ref(null),e.$children$&&e.$children$.map(awe)},Gpt=(e,t)=>{const i=e.$hostElement$,r=e.$cmpMeta$,s=e.$vnode$||_N(null,null),n=ewe(t)?t:ou(null,null,t);r5=i.tagName,r.$attrsToReflect$&&(n.$attrs$=n.$attrs$||{},r.$attrsToReflect$.map(([o,a])=>n.$attrs$[a]=i[o])),n.$tag$=null,n.$flags$|=4,e.$vnode$=n,n.$elm$=s.$elm$=i.shadowRoot||i,bx=i["s-sc"],Ybe=i["s-cr"],Zbe=vN&&(r.$flags$&1)!==0,yN=!1,wx(s,n);{if(El.$flags$|=1,TX){owe(n.$elm$);let o,a,l,c,h,p,f=0;for(;f<Dh.length;f++)o=Dh[f],a=o.$nodeToRelocate$,a["s-ol"]||(l=Xh.createTextNode(""),l["s-nr"]=a,a.parentNode.insertBefore(a["s-ol"]=l,a));for(f=0;f<Dh.length;f++)if(o=Dh[f],a=o.$nodeToRelocate$,o.$slotRefNode$){for(c=o.$slotRefNode$.parentNode,h=o.$slotRefNode$.nextSibling,l=a["s-ol"];l=l.previousSibling;)if(p=l["s-nr"],p&&p["s-sn"]===a["s-sn"]&&c===p.parentNode&&(p=p.nextSibling,!p||!p["s-nr"])){h=p;break}(!h&&c!==a.parentNode||a.nextSibling!==h)&&a!==h&&(!a["s-hn"]&&a["s-ol"]&&(a["s-hn"]=a["s-ol"].parentNode.nodeName),c.insertBefore(a,h))}else a.nodeType===1&&(a.hidden=!0)}yN&&nwe(n.$elm$),El.$flags$&=-2,Dh.length=0}},jpt=(e,t)=>{},lwe=(e,t)=>(e.$flags$|=16,jpt(e,e.$ancestorComponent$),hft(()=>Hpt(e,t))),Hpt=(e,t)=>{const i=e.$hostElement$,r=rb("scheduleUpdate",e.$cmpMeta$.$tagName$),s=i;let n;return t?n=_T(s,"componentWillLoad"):n=_T(s,"componentWillUpdate"),n=Qne(n,()=>_T(s,"componentWillRender")),r(),Qne(n,()=>qpt(e,s,t))},qpt=async(e,t,i)=>{const r=e.$hostElement$,s=rb("update",e.$cmpMeta$.$tagName$);r["s-rc"],i&&$pt(e);const n=rb("render",e.$cmpMeta$.$tagName$);Wpt(e,t,r),n(),s(),Xpt(e)},Wpt=(e,t,i)=>{try{Gne=t,t=t.render&&t.render(),e.$flags$&=-17,e.$flags$|=2,(Hr.hasRenderFn||Hr.reflect)&&(Hr.vdomRender||Hr.reflect)&&(Hr.hydrateServerSide||Gpt(e,t))}catch(a){QO(a,e.$hostElement$)}return Gne=null,null},Xpt=e=>{const t=e.$cmpMeta$.$tagName$,i=e.$hostElement$,r=rb("postUpdate",t),s=i;e.$ancestorComponent$,_T(s,"componentDidRender"),e.$flags$&64?(_T(s,"componentDidUpdate"),r()):(e.$flags$|=64,_T(s,"componentDidLoad"),r())},_T=(e,t,i)=>{if(e&&e[t])try{return e[t](i)}catch(r){QO(r)}},Qne=(e,t)=>e&&e.then?e.then(t):t(),Ypt=(e,t)=>e!=null&&!SX(e)?t&4?e==="false"?!1:e===""||!!e:t&2?parseFloat(e):t&1?String(e):e:e,Zpt=(e,t)=>s5(e).$instanceValues$.get(t),Qpt=(e,t,i,r)=>{const s=s5(e),n=e,o=s.$instanceValues$.get(t),a=s.$flags$,l=n;if(i=Ypt(i,r.$members$[t][0]),i!==o){s.$instanceValues$.set(t,i);{if(r.$watchers$&&a&128){const c=r.$watchers$[t];c&&c.map(h=>{try{l[h](i,o,t)}catch(p){QO(p,n)}})}if((a&18)===2){if(l.componentShouldUpdate&&l.componentShouldUpdate(i,o,t)===!1)return;lwe(s,!1)}}}},Jpt=(e,t,i)=>{if(t.$members$){e.watchers&&(t.$watchers$=e.watchers);const r=Object.entries(t.$members$),s=e.prototype;r.map(([n,[o]])=>{(o&31||o&32)&&Object.defineProperty(s,n,{get(){return Zpt(this,n)},set(a){Qpt(this,n,a,t)},configurable:!0,enumerable:!0})});{const n=new Map;s.attributeChangedCallback=function(o,a,l){El.jmp(()=>{const c=n.get(o);if(this.hasOwnProperty(c))l=this[c],delete this[c];else if(s.hasOwnProperty(c)&&typeof this[c]=="number"&&this[c]==l)return;this[c]=l===null&&typeof this[c]=="boolean"?!1:l})},e.observedAttributes=r.filter(([o,a])=>a[0]&15).map(([o,a])=>{const l=a[1]||o;return n.set(l,o),a[0]&512&&t.$attrsToReflect$.push([o,l]),l})}}return e},Kpt=async(e,t,i,r,s)=>{if((t.$flags$&32)===0&&(s=e.constructor,t.$flags$|=32,customElements.whenDefined(i.$tagName$).then(()=>t.$flags$|=128),s.style)){let o=s.style;typeof o!="string"&&(o=o[t.$modeName$=Dpt(e)]);const a=Jbe(i,t.$modeName$);if(!wN.has(a)){const l=rb("registerStyles",i.$tagName$);Ppt(a,o,!!(i.$flags$&1)),l()}}t.$ancestorComponent$,(()=>lwe(t,!0))()},eft=e=>{},tft=e=>{if((El.$flags$&1)===0){const t=s5(e),i=t.$cmpMeta$,r=rb("connectedCallback",i.$tagName$);t.$flags$&1?(Qbe(e,t,i.$listeners$),eft(t.$lazyInstance$)):(t.$flags$|=1,i.$flags$&12&&ift(e),i.$members$&&Object.entries(i.$members$).map(([s,[n]])=>{if(n&31&&e.hasOwnProperty(s)){const o=e[s];delete e[s],e[s]=o}}),Kpt(e,t,i)),r()}},ift=e=>{const t=e["s-cr"]=Xh.createComment("");t["s-cn"]=!0,e.insertBefore(t,e.firstChild)},rft=e=>{if((El.$flags$&1)===0){const t=s5(e);t.$rmListeners$&&(t.$rmListeners$.map(i=>i()),t.$rmListeners$=void 0)}},sft=(e,t)=>{const i={$flags$:t[0],$tagName$:t[1]};i.$members$=t[2],i.$listeners$=t[3],i.$watchers$=e.$watchers$,i.$attrsToReflect$=[],!vN&&i.$flags$&1&&(i.$flags$|=8);const r=e.prototype.connectedCallback,s=e.prototype.disconnectedCallback;return Object.assign(e.prototype,{__registerHost(){nft(this,i)},connectedCallback(){tft(this),r&&r.call(this)},disconnectedCallback(){rft(this),s&&s.call(this)},__attachShadow(){vN?this.attachShadow({mode:"open",delegatesFocus:!!(i.$flags$&16)}):this.shadowRoot=this}}),e.is=i.$tagName$,Jpt(e,i)},cwe=new WeakMap,s5=e=>cwe.get(e),nft=(e,t)=>{const i={$flags$:0,$hostElement$:e,$cmpMeta$:t,$instanceValues$:new Map};return Qbe(e,i,t.$listeners$),cwe.set(e,i)},Jne=(e,t)=>t in e,QO=(e,t)=>(0,console.error)(e,t),uwe=Hr.isTesting?["STENCIL:"]:["%cstencil","color: white;background:#4c47ff;font-weight: bold; font-size:10px; padding:2px 6px; border-radius: 5px"],oft=(...e)=>console.error(...uwe,...e),aft=(...e)=>console.warn(...uwe,...e),wN=new Map,lft=[],Kne=[],hwe=[],cft=(e,t)=>i=>{e.push(i),i7||(i7=!0,t&&El.$flags$&4?uft(r7):El.raf(r7))},eoe=e=>{for(let t=0;t<e.length;t++)try{e[t](performance.now())}catch(i){QO(i)}e.length=0},r7=()=>{eoe(Kne),eoe(hwe),(i7=Kne.length>0)&&El.raf(r7)},uft=e=>Apt().then(e),hft=cft(hwe,!0);Hr.isDev,Hr.isTesting;/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 */function dft(e){return e.map(t=>{let i="";for(let r=0;r<t;r++)i+=((1+Math.random())*65536|0).toString(16).substring(1);return i}).join("-")}const pft=()=>dft([2,1,1,1,3]);/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 */const fft='@charset "UTF-8";@-webkit-keyframes in{0%{opacity:0}100%{opacity:1}}@keyframes in{0%{opacity:0}100%{opacity:1}}@-webkit-keyframes in-down{0%{opacity:0;-webkit-transform:translate3D(0, -5px, 0);transform:translate3D(0, -5px, 0)}100%{opacity:1;-webkit-transform:translate3D(0, 0, 0);transform:translate3D(0, 0, 0)}}@keyframes in-down{0%{opacity:0;-webkit-transform:translate3D(0, -5px, 0);transform:translate3D(0, -5px, 0)}100%{opacity:1;-webkit-transform:translate3D(0, 0, 0);transform:translate3D(0, 0, 0)}}@-webkit-keyframes in-up{0%{opacity:0;-webkit-transform:translate3D(0, 5px, 0);transform:translate3D(0, 5px, 0)}100%{opacity:1;-webkit-transform:translate3D(0, 0, 0);transform:translate3D(0, 0, 0)}}@keyframes in-up{0%{opacity:0;-webkit-transform:translate3D(0, 5px, 0);transform:translate3D(0, 5px, 0)}100%{opacity:1;-webkit-transform:translate3D(0, 0, 0);transform:translate3D(0, 0, 0)}}@-webkit-keyframes in-scale{0%{opacity:0;-webkit-transform:scale3D(0.95, 0.95, 1);transform:scale3D(0.95, 0.95, 1)}100%{opacity:1;-webkit-transform:scale3D(1, 1, 1);transform:scale3D(1, 1, 1)}}@keyframes in-scale{0%{opacity:0;-webkit-transform:scale3D(0.95, 0.95, 1);transform:scale3D(0.95, 0.95, 1)}100%{opacity:1;-webkit-transform:scale3D(1, 1, 1);transform:scale3D(1, 1, 1)}}:root{--calcite-animation-timing:calc(150ms * var(--calcite-internal-duration-factor));--calcite-internal-duration-factor:var(--calcite-duration-factor, 1);--calcite-internal-animation-timing-fast:calc(100ms * var(--calcite-internal-duration-factor));--calcite-internal-animation-timing-medium:calc(200ms * var(--calcite-internal-duration-factor));--calcite-internal-animation-timing-slow:calc(300ms * var(--calcite-internal-duration-factor))}.calcite-animate{opacity:0;-webkit-animation-fill-mode:both;animation-fill-mode:both;-webkit-animation-duration:var(--calcite-animation-timing);animation-duration:var(--calcite-animation-timing)}.calcite-animate__in{-webkit-animation-name:in;animation-name:in}.calcite-animate__in-down{-webkit-animation-name:in-down;animation-name:in-down}.calcite-animate__in-up{-webkit-animation-name:in-up;animation-name:in-up}.calcite-animate__in-scale{-webkit-animation-name:in-scale;animation-name:in-scale}:root{--calcite-popper-transition:var(--calcite-animation-timing)}:host([hidden]){display:none}:host{position:relative;margin-left:auto;margin-right:auto;display:none;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center;padding-top:4rem;padding-bottom:4rem;opacity:1;min-height:var(--calcite-loader-size);font-size:var(--calcite-loader-font-size);stroke:var(--calcite-ui-brand);stroke-width:3;fill:none;-webkit-transform:scale(1, 1);transform:scale(1, 1);animation:loader-color-shift 6s alternate-reverse infinite linear}:host([scale=s]){--calcite-loader-font-size:var(--calcite-font-size--2);--calcite-loader-size:2rem;--calcite-loader-size-inline:0.75rem}:host([scale=m]){--calcite-loader-font-size:var(--calcite-font-size-0);--calcite-loader-size:4rem;--calcite-loader-size-inline:1rem}:host([scale=l]){--calcite-loader-font-size:var(--calcite-font-size-2);--calcite-loader-size:6rem;--calcite-loader-size-inline:1.5rem}:host([no-padding]){padding-top:0px;padding-bottom:0px}:host{display:none}:host([active]){display:-ms-flexbox;display:flex}.loader__text{display:block;text-align:center;font-size:var(--calcite-font-size--2);line-height:1rem;color:var(--calcite-ui-text-1);margin-top:calc(var(--calcite-loader-size) + 1.5rem)}.loader__percentage{position:absolute;display:block;text-align:center;color:var(--calcite-ui-text-1);font-size:var(--calcite-loader-font-size);width:var(--calcite-loader-size);left:50%;margin-left:calc(var(--calcite-loader-size) / 2 * -1);line-height:0.25;-webkit-transform:scale(1, 1);transform:scale(1, 1)}.loader__svgs{position:absolute;overflow:visible;opacity:1;width:var(--calcite-loader-size);height:var(--calcite-loader-size);left:50%;margin-left:calc(var(--calcite-loader-size) / 2 * -1);-webkit-transform:scale(1, 1);transform:scale(1, 1)}.loader__svg{position:absolute;top:0px;left:0px;-webkit-transform-origin:center;transform-origin:center;overflow:visible;width:var(--calcite-loader-size);height:var(--calcite-loader-size);-webkit-animation-iteration-count:infinite;animation-iteration-count:infinite;-webkit-animation-timing-function:linear;animation-timing-function:linear;-webkit-animation-name:loader-clockwise;animation-name:loader-clockwise}@supports (display: grid){.loader__svg--1{-webkit-animation-name:loader-offset-1;animation-name:loader-offset-1}.loader__svg--2{-webkit-animation-name:loader-offset-2;animation-name:loader-offset-2}.loader__svg--3{-webkit-animation-name:loader-offset-3;animation-name:loader-offset-3}}:host([type=determinate]){-webkit-animation:none;animation:none;stroke:var(--calcite-ui-border-3)}:host([type=determinate]) .loader__svg--3{-webkit-animation:none;animation:none;stroke:var(--calcite-ui-brand);stroke-dasharray:150.79632;-webkit-transform:rotate(-90deg);transform:rotate(-90deg);-webkit-transition:all var(--calcite-internal-animation-timing-fast) linear;transition:all var(--calcite-internal-animation-timing-fast) linear}:host([inline]){position:relative;margin:0px;-webkit-animation:none;animation:none;stroke:currentColor;stroke-width:2;padding-top:0px;padding-bottom:0px;height:var(--calcite-loader-size-inline);min-height:var(--calcite-loader-size-inline);width:var(--calcite-loader-size-inline);-webkit-margin-end:calc(var(--calcite-loader-size-inline) * 0.5);margin-inline-end:calc(var(--calcite-loader-size-inline) * 0.5);vertical-align:calc(var(--calcite-loader-size-inline) * -1 * 0.2)}:host([active][inline]){display:inline-block}:host([inline]) .loader__svgs{top:0px;left:0px;margin:0px;width:var(--calcite-loader-size-inline);height:var(--calcite-loader-size-inline)}:host([inline]) .loader__svg{width:var(--calcite-loader-size-inline);height:var(--calcite-loader-size-inline)}:host([complete]){opacity:0;-webkit-transform:scale(0.75, 0.75);transform:scale(0.75, 0.75);-webkit-transform-origin:center;transform-origin:center;-webkit-transition:opacity var(--calcite-internal-animation-timing-medium) linear 1000ms, -webkit-transform var(--calcite-internal-animation-timing-medium) linear 1000ms;transition:opacity var(--calcite-internal-animation-timing-medium) linear 1000ms, -webkit-transform var(--calcite-internal-animation-timing-medium) linear 1000ms;transition:opacity var(--calcite-internal-animation-timing-medium) linear 1000ms, transform var(--calcite-internal-animation-timing-medium) linear 1000ms;transition:opacity var(--calcite-internal-animation-timing-medium) linear 1000ms, transform var(--calcite-internal-animation-timing-medium) linear 1000ms, -webkit-transform var(--calcite-internal-animation-timing-medium) linear 1000ms}:host([complete]) .loader__svgs{opacity:0;-webkit-transform:scale(0.75, 0.75);transform:scale(0.75, 0.75);-webkit-transform-origin:center;transform-origin:center;-webkit-transition:opacity calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms, -webkit-transform calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms;transition:opacity calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms, -webkit-transform calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms;transition:opacity calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms, transform calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms;transition:opacity calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms, transform calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms, -webkit-transform calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms}:host([complete]) .loader__percentage{color:var(--calcite-ui-brand);-webkit-transform:scale(1.05, 1.05);transform:scale(1.05, 1.05);-webkit-transform-origin:center;transform-origin:center;-webkit-transition:color var(--calcite-internal-animation-timing-medium) linear, -webkit-transform var(--calcite-internal-animation-timing-medium) linear;transition:color var(--calcite-internal-animation-timing-medium) linear, -webkit-transform var(--calcite-internal-animation-timing-medium) linear;transition:color var(--calcite-internal-animation-timing-medium) linear, transform var(--calcite-internal-animation-timing-medium) linear;transition:color var(--calcite-internal-animation-timing-medium) linear, transform var(--calcite-internal-animation-timing-medium) linear, -webkit-transform var(--calcite-internal-animation-timing-medium) linear}.loader__svg--1{stroke-dasharray:27.9252444444% 139.6262222222%;-webkit-animation-duration:0.72s;animation-duration:0.72s}@-webkit-keyframes loader-offset-1{0%{stroke-dasharray:27.9252444444% 251.3272%;stroke-dashoffset:0}50%{stroke-dasharray:139.6262222222% 139.6262222222%;stroke-dashoffset:-83.7757333333%}100%{stroke-dasharray:27.9252444444% 251.3272%;stroke-dashoffset:-279.2524444444%}}@keyframes loader-offset-1{0%{stroke-dasharray:27.9252444444% 251.3272%;stroke-dashoffset:0}50%{stroke-dasharray:139.6262222222% 139.6262222222%;stroke-dashoffset:-83.7757333333%}100%{stroke-dasharray:27.9252444444% 251.3272%;stroke-dashoffset:-279.2524444444%}}.loader__svg--2{stroke-dasharray:55.8504888889% 139.6262222222%;-webkit-animation-duration:0.96s;animation-duration:0.96s}@-webkit-keyframes loader-offset-2{0%{stroke-dasharray:55.8504888889% 223.4019555556%;stroke-dashoffset:0}50%{stroke-dasharray:139.6262222222% 139.6262222222%;stroke-dashoffset:-97.7383555556%}100%{stroke-dasharray:55.8504888889% 223.4019555556%;stroke-dashoffset:-279.2524444444%}}@keyframes loader-offset-2{0%{stroke-dasharray:55.8504888889% 223.4019555556%;stroke-dashoffset:0}50%{stroke-dasharray:139.6262222222% 139.6262222222%;stroke-dashoffset:-97.7383555556%}100%{stroke-dasharray:55.8504888889% 223.4019555556%;stroke-dashoffset:-279.2524444444%}}.loader__svg--3{stroke-dasharray:13.9626222222% 139.6262222222%;-webkit-animation-duration:1.16s;animation-duration:1.16s}@-webkit-keyframes loader-offset-3{0%{stroke-dasharray:13.9626222222% 265.2898222222%;stroke-dashoffset:0}50%{stroke-dasharray:139.6262222222% 139.6262222222%;stroke-dashoffset:-76.7944222222%}100%{stroke-dasharray:13.9626222222% 265.2898222222%;stroke-dashoffset:-279.2524444444%}}@keyframes loader-offset-3{0%{stroke-dasharray:13.9626222222% 265.2898222222%;stroke-dashoffset:0}50%{stroke-dasharray:139.6262222222% 139.6262222222%;stroke-dashoffset:-76.7944222222%}100%{stroke-dasharray:13.9626222222% 265.2898222222%;stroke-dashoffset:-279.2524444444%}}@-webkit-keyframes loader-color-shift{0%{stroke:var(--calcite-ui-brand)}33%{stroke:var(--calcite-ui-brand-press)}66%{stroke:var(--calcite-ui-brand-hover)}100%{stroke:var(--calcite-ui-brand)}}@keyframes loader-color-shift{0%{stroke:var(--calcite-ui-brand)}33%{stroke:var(--calcite-ui-brand-press)}66%{stroke:var(--calcite-ui-brand-hover)}100%{stroke:var(--calcite-ui-brand)}}@-webkit-keyframes loader-clockwise{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes loader-clockwise{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}';let s7=class extends Spt{constructor(){super();this.__registerHost(),this.__attachShadow(),this.active=!1,this.inline=!1,this.scale="m",this.value=0,this.text="",this.noPadding=!1}render(){const{el:e,inline:t,label:i,scale:r,text:s,type:n,value:o}=this,a=e.id||pft(),l=.45,c=t?this.getInlineSize(r):this.getSize(r),h=c*l,p=`0 0 ${c} ${c}`,f=n==="determinate",g=2*h*Math.PI,y=o/100*g,v=g-y,b=Math.floor(o),w={"aria-valuenow":b,"aria-valuemin":0,"aria-valuemax":100,complete:b===100},S={r:h,cx:c/2,cy:c/2},T={"stroke-dasharray":`${y} ${v}`};return ou(Kbe,Object.assign({"aria-label":i,id:a,role:"progressbar"},f?w:{}),ou("div",{class:"loader__svgs"},ou("svg",{class:"loader__svg loader__svg--1",viewBox:p},ou("circle",Object.assign({},S))),ou("svg",{class:"loader__svg loader__svg--2",viewBox:p},ou("circle",Object.assign({},S))),ou("svg",Object.assign({class:"loader__svg loader__svg--3",viewBox:p},f?{style:T}:{}),ou("circle",Object.assign({},S)))),s&&ou("div",{class:"loader__text"},s),f&&ou("div",{class:"loader__percentage"},o))}getSize(e){return{s:32,m:56,l:80}[e]}getInlineSize(e){return{s:12,m:16,l:20}[e]}get el(){return this}static get style(){return fft}};s7=sft(s7,[1,"calcite-loader",{active:[516],inline:[516],label:[1],scale:[513],type:[513],value:[2],text:[1],noPadding:[4,"no-padding"]}]);function mft(){if(typeof customElements=="undefined")return;["calcite-loader"].forEach(t=>{switch(t){case"calcite-loader":customElements.get(t)||customElements.define(t,s7);break}})}mft();export{Ryt as $,Fyt as A,Uyt as B,PF as C,wXe as D,Im as E,va as F,it as G,Nt as H,km as I,Myt as J,Vyt as K,q as L,f5e as M,eyt as N,ZN as O,fn as P,tyt as Q,hO as R,ub as S,iyt as T,rc as U,wj as V,uO as W,Jfe as X,$Ee as Y,Kgt as Z,xr as _,u as a,wft as a$,AOe as a0,Sl as a1,Op as a2,Yit as a3,AYe as a4,wl as a5,Qt as a6,g7 as a7,ue as a8,dmt as a9,Wt as aA,e2 as aB,ht as aC,Js as aD,Gve as aE,Ks as aF,qr as aG,Dft as aH,ac as aI,mn as aJ,f0 as aK,Pr as aL,Fh as aM,Nhe as aN,oe as aO,wn as aP,pe as aQ,ae as aR,et as aS,ic as aT,qM as aU,Cyt as aV,yZ as aW,xyt as aX,RYe as aY,YN as aZ,M1 as a_,he as aa,ku as ab,Wn as ac,BT as ad,oke as ae,gt as af,ki as ag,ij as ah,ne as ai,Tp as aj,$u as ak,M as al,cs as am,N0 as an,Xt as ao,rS as ap,$t as aq,Nyt as ar,Lyt as as,Qyt as at,IW as au,Dyt as av,$yt as aw,eH as ax,Rp as ay,HD as az,ky as b,pyt as b$,hb as b0,Zit as b1,yW as b2,wp as b3,jH as b4,Es as b5,rO as b6,Dt as b7,o1e as b8,pmt as b9,zm as bA,nb as bB,cc as bC,Wnt as bD,Hnt as bE,Xnt as bF,Yx as bG,iO as bH,Us as bI,tm as bJ,A1 as bK,Qa as bL,VN as bM,lr as bN,E as bO,w7 as bP,s1 as bQ,JN as bR,hi as bS,go as bT,pi as bU,Fft as bV,Gt as bW,rs as bX,ct as bY,is as bZ,CS as b_,br as ba,nF as bb,dyt as bc,y0 as bd,amt as be,n0 as bf,MY as bg,ej as bh,yrt as bi,di as bj,Rft as bk,woe as bl,_oe as bm,Xgt as bn,Ygt as bo,yze as bp,tS as bq,Ti as br,Bn as bs,Ts as bt,Dmt as bu,dO as bv,myt as bw,Ple as bx,Cl as by,zoe as bz,fp as c,hlt as c$,yI as c0,sb as c1,Tst as c2,Oi as c3,Gn as c4,x as c5,Or as c6,Os as c7,Ec as c8,j as c9,u4 as cA,ju as cB,od as cC,l4 as cD,n4 as cE,ve as cF,Q1 as cG,b4 as cH,cZe as cI,lW as cJ,kS as cK,Vm as cL,eYe as cM,ws as cN,aF as cO,po as cP,tle as cQ,Yft as cR,aEe as cS,KUe as cT,ET as cU,C1e as cV,vc as cW,qCe as cX,Kh as cY,Te as cZ,tYe as c_,BL as ca,Vp as cb,Sc as cc,Ee as cd,Z as ce,Di as cf,lt as cg,mr as ch,Ni as ci,Gi as cj,Mi as ck,mi as cl,Ol as cm,Jm as cn,Gp as co,wb as cp,Ot as cq,Km as cr,VF as cs,H0 as ct,Ma as cu,a4 as cv,Ft as cw,Ip as cx,D0 as cy,W0 as cz,d,gT as d$,J1e as d0,Umt as d1,Wxe as d2,Pft as d3,Oft as d4,Kxe as d5,eTe as d6,He as d7,eF as d8,PQe as d9,kN as dA,ut as dB,si as dC,uze as dD,Ioe as dE,GN as dF,$Y as dG,uc as dH,Fle as dI,al as dJ,eg as dK,S1e as dL,SN as dM,_1 as dN,oOe as dO,ur as dP,vyt as dQ,p0t as dR,QF as dS,HT as dT,gV as dU,S0e as dV,Rl as dW,Qlt as dX,c2 as dY,Lmt as dZ,Clt as d_,Oae as da,Rge as db,Eq as dc,l0t as dd,f0t as de,Age as df,OO as dg,vp as dh,p0 as di,fr as dj,ni as dk,wr as dl,ke as dm,Ile as dn,De as dp,ir as dq,Zgt as dr,P8 as ds,Ep as dt,lze as du,sme as dv,bze as dw,cke as dx,U5e as dy,jfe as dz,y0t as e,zA as e$,l1 as e0,dr as e1,tOe as e2,Lu as e3,wm as e4,kmt as e5,_n as e6,Sm as e7,Ho as e8,BS as e9,Mc as eA,Iyt as eB,vye as eC,_a as eD,PXe as eE,d0t as eF,Qy as eG,uMe as eH,qn as eI,xi as eJ,_e as eK,Go as eL,de as eM,o$ as eN,cp as eO,jEe as eP,fyt as eQ,Cst as eR,xmt as eS,Rm as eT,BOe as eU,VOe as eV,Fe as eW,Nmt as eX,ui as eY,y7 as eZ,Tx as e_,Ct as ea,_fe as eb,bfe as ec,Pyt as ed,Uce as ee,rV as ef,GEe as eg,A5 as eh,Be as ei,ai as ej,mb as ek,emt as el,se as em,fe as en,Uj as eo,Pe as ep,Cc as eq,Xi as er,m0t as es,gyt as et,xT as eu,Ri as ev,Tmt as ew,Au as ex,tO as ey,AR as ez,cb as f,Zft as f$,Rc as f0,pm as f1,b1 as f2,gZ as f3,_c as f4,Zze as f5,Xft as f6,fH as f7,bp as f8,Cae as f9,qft as fA,GAe as fB,hae as fC,dj as fD,R1 as fE,GC as fF,qdt as fG,Ny as fH,fc as fI,XAe as fJ,UT as fK,$N as fL,zhe as fM,bl as fN,_mt as fO,Al as fP,k4e as fQ,z4e as fR,gO as fS,XS as fT,Fde as fU,Syt as fV,eke as fW,Qgt as fX,ZTe as fY,rgt as fZ,tmt as f_,qSe as fa,IQ as fb,hgt as fc,_gt as fd,wgt as fe,Zde as ff,Jde as fg,Xde as fh,tLe as fi,imt as fj,_yt as fk,Xae as fl,b2e as fm,Hft as fn,u2e as fo,g2e as fp,r1 as fq,Kde as fr,Qae as fs,aO as ft,jft as fu,F0 as fv,BH as fw,g5e as fx,FT as fy,bft as fz,qo as g,fmt as g$,Jft as g0,Qft as g1,Kft as g2,FC as g3,Mu as g4,oEe as g5,IN as g6,tve as g7,byt as g8,vXe as g9,Woe as gA,Zae as gB,Nft as gC,wmt as gD,PY as gE,bgt as gF,Bgt as gG,pj as gH,Om as gI,J9 as gJ,yi as gK,dn as gL,sgt as gM,ngt as gN,oi as gO,a0t as gP,c0t as gQ,hmt as gR,eAe as gS,__ as gT,o0t as gU,jL as gV,nd as gW,Qm as gX,Li as gY,bn as gZ,ot as g_,Eyt as ga,umt as gb,Ift as gc,n0t as gd,omt as ge,BN as gf,Ie as gg,eDe as gh,Ayt as gi,or as gj,Pde as gk,zfe as gl,$Ze as gm,Sh as gn,tt as go,yue as gp,zmt as gq,ahe as gr,zyt as gs,DN as gt,dgt as gu,Sft as gv,tn as gw,DW as gx,Aa as gy,Ai as gz,we as h,Int as h$,EO as h0,fi as h1,ii as h2,mo as h3,Dle as h4,u0t as h5,h0t as h6,tj as h7,rMe as h8,Le as h9,FY as hA,AT as hB,Fhe as hC,ise as hD,Ine as hE,eue as hF,QB as hG,Lr as hH,ZB as hI,KB as hJ,ND as hK,EOe as hL,Qe as hM,$e as hN,yt as hO,d1 as hP,Mce as hQ,np as hR,t0t as hS,s0t as hT,E1e as hU,Wre as hV,e0t as hW,i0t as hX,Kyt as hY,lN as hZ,VI as h_,Hp as ha,rF as hb,I0 as hc,Tt as hd,us as he,jt as hf,ri as hg,Zyt as hh,Cde as hi,Y$e as hj,Vue as hk,gTe as hl,bL as hm,nM as hn,fo as ho,_o as hp,UH as hq,q4e as hr,Kt as hs,Ax as ht,sT as hu,Em as hv,PN as hw,Oj as hx,n2e as hy,je as hz,GS as i,Xn as i$,Ge as i0,Ca as i1,yft as i2,AW as i3,yu as i4,Hre as i5,cnt as i6,unt as i7,At as i8,Wr as i9,Ice as iA,MRe as iB,vi as iC,ix as iD,XOe as iE,zs as iF,Cs as iG,da as iH,m7 as iI,s0 as iJ,y1 as iK,lp as iL,xVe as iM,Um as iN,Bj as iO,WT as iP,tr as iQ,oR as iR,gs as iS,JA as iT,cF as iU,Gmt as iV,bT as iW,jmt as iX,RVe as iY,IVe as iZ,$mt as i_,V7 as ia,z7 as ib,B7 as ic,zL as id,cyt as ie,Qh as ig,c3e as ih,POe as ii,Gft as ij,MOe as ik,be as il,pt as im,I1 as io,Ye as ip,mc as iq,Fmt as ir,zft as is,rr as it,Bft as iu,nT as iv,w6 as iw,ES as ix,Rt as iy,Vh as iz,mD as j,D7 as j$,Zm as j0,Cr as j1,g1 as j2,Gyt as j3,uEe as j4,vft as j5,_s as j6,Rmt as j7,Cmt as j8,kRe as j9,pst as jA,Bx as jB,nG as jC,eb as jD,gl as jE,kr as jF,_ft as jG,ure as jH,tF as jI,Tft as jJ,Vmt as jK,Vn as jL,em as jM,Bmt as jN,Tye as jO,Mbe as jP,UD as jQ,ydt as jR,Mne as jS,c7 as jT,As as jU,cmt as jV,lmt as jW,Iu as jX,Fg as jY,l6 as jZ,Dp as j_,FRe as ja,Rce as jb,Omt as jc,XB as jd,Imt as je,Pmt as jf,Mmt as jg,zn as jh,_F as ji,tgt as jj,igt as jk,Kmt as jl,egt as jm,Mh as jn,nl as jo,hq as jp,uq as jq,OEe as jr,Rr as js,Ne as jt,Vft as ju,t2e as jv,Ur as jw,tg as jx,pl as jy,eX as jz,FN as k,zW as k$,mu as k0,z0 as k1,Hn as k2,j0 as k3,c4 as k4,GK as k5,nN as k6,yl as k7,lMe as k8,pb as k9,v1e as kA,sDe as kB,MF as kC,wfe as kD,Pu as kE,n5e as kF,Jh as kG,WN as kH,ece as kI,Bi as kJ,Ss as kK,Cft as kL,X2e as kM,vmt as kN,JFe as kO,Qke as kP,Jke as kQ,Kke as kR,Sge as kS,Ege as kT,k0 as kU,cl as kV,Wo as kW,Xr as kX,GO as kY,YB as kZ,ls as k_,WC as ka,UMe as kb,Mm as kc,hF as kd,QRe as ke,pO as kf,Oc as kg,ALe as kh,rDe as ki,Zle as kj,MS as kk,fUe as kl,vke as km,Ake as kn,qH as ko,Pnt as kp,VC as kq,U0 as kr,hke as ks,r$ as kt,Mft as ku,y5e as kv,kft as kw,Jyt as kx,Ir as ky,wst as kz,Je as l,Emt as l$,ll as l0,fOe as l1,qyt as l2,cS as l3,Z1 as l4,Si as l5,jyt as l6,Wyt as l7,GRe as l8,Hyt as l9,UDe as lA,R5e as lB,k2e as lC,wDe as lD,xgt as lE,IDe as lF,AQ as lG,kde as lH,vgt as lI,rRe as lJ,zp as lK,zgt as lL,pK as lM,K5 as lN,eU as lO,a6 as lP,fu as lQ,Bxe as lR,Eft as lS,Aft as lT,tl as lU,ogt as lV,il as lW,mgt as lX,xF as lY,Ht as lZ,zy as l_,IKe as la,NKe as lb,$Ke as lc,DKe as ld,LKe as le,Vde as lf,Ude as lg,agt as lh,ygt as li,ggt as lj,Bde as lk,Zfe as ll,qmt as lm,pH as ln,tpe as lo,epe as lp,fgt as lq,pgt as lr,rmt as ls,smt as lt,nmt as lu,zxe as lv,Tyt as lw,qV as lx,wyt as ly,Ta as lz,g0t as m,tc as m$,Smt as m0,$Ae as m1,ED as m2,cj as m3,r0t as m4,el as m5,v7 as m6,qre as m7,fl as m8,Ia as m9,Wmt as mA,Hhe as mB,nIe as mC,Qmt as mD,Zmt as mE,Xmt as mF,pa as mG,fa as mH,lo as mI,vl as mJ,Bp as mK,$I as mL,KC as mM,LH as mN,lL as mO,$C as mP,xx as mQ,ts as mR,w4e as mS,o0 as mT,Vo as mU,_4e as mV,Du as mW,f4e as mX,u4e as mY,c4e as mZ,N1 as m_,le as ma,xf as mb,yV as mc,Ede as md,Soe as me,Qx as mf,jle as mg,gmt as mh,eO as mi,qN as mj,bmt as mk,N5e as ml,Vgt as mm,Ugt as mn,UAe as mo,L5e as mp,US as mq,Ggt as mr,Xyt as ms,iet as mt,jC as mu,WA as mv,PB as mw,jgt as mx,Jmt as my,Ymt as mz,P as n,SQe as n$,lfe as n0,XLe as n1,r4e as n2,o4e as n3,Bt as n4,afe as n5,dc as n6,b4e as n7,m4e as n8,gb as n9,WX as nA,Fgt as nB,a4e as nC,l4e as nD,n4e as nE,s4e as nF,Ox as nG,Zat as nH,SO as nI,cUe as nJ,XVe as nK,t9e as nL,Tu as nM,R9e as nN,$9e as nO,td as nP,L9e as nQ,oc as nR,eGe as nS,cGe as nT,U0e as nU,xWe as nV,VL as nW,NQe as nX,zQe as nY,dQe as nZ,xa as n_,N7 as na,x4e as nb,T4e as nc,S4e as nd,$H as ne,A4e as nf,E4e as ng,C4e as nh,fj as ni,JC as nj,KFe as nk,v4e as nl,g4e as nm,h4e as nn,N4e as no,$4e as np,I4e as nq,$gt as nr,D4e as ns,L4e as nt,d4e as nu,p4e as nv,b7 as nw,y4e as nx,M4e as ny,xH as nz,yC as o,pke as o$,Sat as o0,Mat as o1,rbe as o2,tct as o3,nut as o4,mM as o5,R5 as o6,oAe as o7,x9e as o8,Tve as o9,dut as oA,Fm as oB,fut as oC,CLe as oD,iUe as oE,oDe as oF,yc as oG,aj as oH,Fc as oI,PKe as oJ,Tl as oK,kyt as oL,MZe as oM,Fut as oN,oZe as oO,XJe as oP,UKe as oQ,eit as oR,xit as oS,git as oT,QUe as oU,Ike as oV,Pke as oW,Sle as oX,oUe as oY,Tj as oZ,Jgt as o_,yYe as oa,ayt as ob,oyt as oc,syt as od,Sx as oe,e6e as of,nyt as og,lyt as oh,Jze as oi,lO as oj,rJe as ok,uyt as ol,hyt as om,Wgt as on,Ac as oo,UZe as op,qh as oq,WL as or,JZe as os,ol as ot,$ct as ou,Un as ov,Nm as ow,Yct as ox,e5 as oy,Wh as oz,rt as p,ec as p$,mke as p0,uUe as p1,XH as p2,dUe as p3,pUe as p4,Une as p5,Fne as p6,v0 as p7,EBe as p8,xBe as p9,c6 as pA,ugt as pB,BDe as pC,kDe as pD,cSe as pE,gze as pF,xO as pG,Vi as pH,j4e as pI,gfe as pJ,m6e as pK,o5e as pL,g6e as pM,Rfe as pN,hL as pO,Lft as pP,dfe as pQ,dL as pR,hUe as pS,oO as pT,Wft as pU,$ft as pV,Hmt as pW,L0 as pX,_7 as pY,$w as pZ,fze as p_,CK as pa,Ra as pb,NC as pc,dke as pd,sd as pe,QN as pf,VS as pg,xke as ph,JUe as pi,tke as pj,Lke as pk,xY as pl,ele as pm,oze as pn,Hfe as po,tq as pp,iK as pq,ZI as pr,Pfe as ps,uke as pt,iq as pu,ime as pv,Sfe as pw,mt as px,ob as py,ST as pz,RY as q,hfe as q$,gD as q0,cC as q1,WB as q2,wY as q3,Eme as q4,Sp as q5,_p as q6,_le as q7,n1 as q8,xft as q9,sat as qA,Tgt as qB,pX as qC,tze as qD,ize as qE,rze as qF,Dgt as qG,Igt as qH,pJ as qI,Sgt as qJ,dJ as qK,O4e as qL,Pgt as qM,Ngt as qN,Lgt as qO,L1 as qP,Agt as qQ,Egt as qR,Cgt as qS,Rgt as qT,Mgt as qU,i4e as qV,mJ as qW,Ogt as qX,R4e as qY,OF as qZ,ufe as q_,z5e as qa,JI as qb,QJ as qc,NT as qd,GH as qe,yke as qf,gke as qg,PS as qh,xce as qi,Hgt as qj,FS as qk,mmt as ql,wdt as qm,fke as qn,qgt as qo,FSe as qp,Uft as qq,D as qr,Amt as qs,Byt as qt,jot as qu,G1e as qv,z1e as qw,h_ as qx,dX as qy,hX as qz,_ as r,Up as r0,z8e as r1,WOe as r2,HOe as r3,up as r4,O_e as r5,$oe as r6,M8e as r7,ymt as r8,z_e as r9,cgt as rA,kgt as rB,ryt as rC,Oyt as rD,Yyt as rE,V_e as ra,wC as rb,z_ as rc,rn as rd,Pa as re,Uu as rf,Kb as rg,het as rh,L_e as ri,k_e as rj,F_e as rk,uet as rl,cG as rm,U_e as rn,A0 as ro,net as rp,E0 as rq,Q9 as rr,G1 as rs,IYe as rt,zet as ru,ket as rv,Uet as rw,yyt as rx,gCe as ry,lgt as rz,qt as s,R as t,Ut as u,bc as v,zT as w,aS as x,O5e as y,pr as z};
