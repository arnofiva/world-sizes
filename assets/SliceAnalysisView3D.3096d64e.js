import{ax as D,J as t,d as s,x as _,h as g,y as E,a2 as m,a6 as y,F as V,M as c,K as n,ki as L,a7 as b,V as p,b8 as x,eS as C,jo as z,kj as $,kk as S,ew as G,i_ as A}from"./vendor.5a0f9a12.js";import{p as M}from"./AnalysisView3D.4f71e3f1.js";import{L as O,x as j,j as k,M as B,y as F,h as R,g as U,p as K,K as q,S as I,C as T,a as J,U as H,b as N}from"./sliceToolUtils.3516703a.js";import{E as Q}from"./BuildingComponentSublayer.2f204c63.js";import{a as W}from"./LineVisualElement.9378dd44.js";import"./persistable.e960b349.js";import"./ImageMaterial.2d7ab4ce.js";import"./capabilities.ee85458d.js";import"./I3SIndexInfo.4991bee2.js";import"./I3SLayerDefinitions.4c545ea5.js";const w=D.getLogger("esri.views.3d.analysis.Slice.SliceController");let h=class extends g{constructor(e){super(e),this._handles=new E,this._internalChange=!1,this._currentSlicePlane=null,this.state="ready"}get ready(){return this.state==="ready"}initialize(){this._handles.add(this.analysis.excludedLayers.on("before-add",e=>{const i=e.item;i!=null&&(i instanceof m||i instanceof Q)?i instanceof m&&O(i)?(w.error("excludedLayers",`Layer '${i.title}, id:${i.id}' of type '${i.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.analysis.excludedLayers.includes(i)&&e.preventDefault():(w.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())})),Y(this.view,this),this._handles.add([y(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},{sync:!0}),y(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),y(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane()},{sync:!0}),y(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this._handles.add([y(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis"),this._set("state","ready"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){this.state!=="destroyed"&&(this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null),Z(this.view,this),this._handles.destroy(),this.set("view",null),this._set("state","destroyed"))}async whenReady(){return await V(this,"ready"),this}get _allLayerAndSubLayerViews(){const e=this.view.allLayerViews.items;return e.concat(e.filter(j).flatMap(({sublayerViews:i})=>i.items))}_updateBoundedPlaneFromSlicePlane(){const e=this.analysis.shape,i=this._currentSlicePlane;if(c(i)&&c(e)||n(i)&&n(e)&&e.equals(i))return;let l=null,a=null;if(n(e)&&n(e.position)){const o=e.position.spatialReference,f=k(e,this.view);c(f)&&W(this.analysis,o,w),l=B(f,this.view,{tiltEnabled:this.analysis.tiltEnabled},L()),n(l)&&(a={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=l,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const e=this.analysisViewData.plane,i=F(e,this.view,this.view.spatialReference,new R);let l=null;n(i)&&(l={heading:i.heading,tilt:i.tilt,position:i.position,width:i.width,height:i.height}),this._currentSlicePlane=l,this._internalChange=!0,this.analysis.shape=i,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(v)return;const e=P(this.view);if(this.analysisViewData.active)n(e.activeController)&&e.activeController!==this?(v=!0,e.activeController.analysisViewData.active=!1,v=!1):n(e.activeController)&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(n(e.activeController)&&e.activeController!==this)return;n(e.activeController)&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){this.state==="ready"&&X(this.view)}_updateLayerViews(){const e=n(this.analysisViewData.plane)&&this.analysisViewData.visible&&this.analysisViewData.active,i=[],l=a=>{"layers"in a?a.layers.forEach(l):i.push(a)};this.analysis.excludedLayers.forEach(l),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=e&&i.indexOf(a.layer)<0),"sublayerViews"in a&&a.sublayerViews.forEach(o=>{o.slicePlaneEnabled=e&&i.indexOf(o.sublayer)<0}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.analysis.excludeGroundSurface)}};t([s({readOnly:!0})],h.prototype,"state",void 0),t([s()],h.prototype,"view",void 0),t([s()],h.prototype,"analysis",void 0),t([s()],h.prototype,"analysisViewData",void 0),t([s()],h.prototype,"ready",null),t([s()],h.prototype,"_allLayerAndSubLayerViews",null),h=t([_("esri.views.3d.analysis.Slice.SliceController")],h);const u=new Map;let v=!1;function X(e){const i=P(e).activeController;n(i)&&n(i.analysisViewData.plane)&&i.analysisViewData.visible?e.slicePlane=i.analysisViewData.plane:e.slicePlane=null}function Y(e,i){u.has(e)||u.set(e,{all:[],activeController:null}),u.get(e).all.push(i)}function P(e){return u.get(e)}function Z(e,i){if(!u.has(e))throw new Error("view expected in global slice register");const l=u.get(e),a=l.all.lastIndexOf(i);if(a===-1)throw new Error("controller expected in global slice register");l.all.splice(a,1),l.all.length===0&&u.delete(e)}let r=class extends g{constructor(e){super(e),this._handles=new E,this._gridVisualElement=null,this._outlineVisualElement=null,this.state="pending",this.showGrid=!1,this.editable=!0}get ready(){return this.state==="ready"}initialize(){this._initialize()}async _initialize(){if(this.state==="destroyed"||this.state==="ready")return;await V(this.view,"ready",!0);const e=this.analysisViewData;if(c(e))throw new Error("expected internal object to be valid");this._gridVisualElement=U(this.view),this._outlineVisualElement=K(this.view),this._handles.add([y(()=>({visible:n(e.plane)&&this.analysisViewData.visible,active:this.analysisViewData.active,editable:this.editable,showGrid:this.showGrid}),i=>this._updateMaterials(i),b),y(()=>e.plane,i=>this._updatePlane(i),b)],"internal"),this._set("state","ready")}destroy(){this.state!=="destroyed"&&this.state!=="pending"&&(this._handles.destroy(),this._gridVisualElement=p(this._gridVisualElement),this._outlineVisualElement=p(this._outlineVisualElement),this.set("view",null),this._set("state","destroyed"))}async whenReady(){return await V(this,"ready"),this}_updatePlane(e){if(c(e))return;const i=x(z.get(),C(e.basis1),C(e.basis2),1),l=$(S.get(),i),a=q(e,S.get()),o=G(l,a,l);this._outlineVisualElement.transform=o,this._gridVisualElement.transform=o}_updateMaterials({visible:e,active:i,editable:l,showGrid:a}){this._outlineVisualElement.color=I,this._outlineVisualElement.width=l?T:J,this._outlineVisualElement.stipplePattern=i?null:A(5);const o=a?N:[0,0,0,0];this._gridVisualElement.backgroundColor=H,this._gridVisualElement.gridColor=o,this._gridVisualElement.visible=e,this._outlineVisualElement.visible=e}};t([s({readOnly:!0})],r.prototype,"state",void 0),t([s()],r.prototype,"view",void 0),t([s()],r.prototype,"analysis",void 0),t([s()],r.prototype,"analysisViewData",void 0),t([s()],r.prototype,"ready",null),t([s()],r.prototype,"showGrid",void 0),t([s()],r.prototype,"editable",void 0),r=t([_("esri.views.3d.analysis.Slice.SliceVisualization")],r);let d=class extends M(g){constructor(e){super(e),this.type="slice-view-3d",this.analysisVisualization=null,this.analysisController=null,this.plane=null,this.active=!0,this.showGrid=!1,this.editable=!1}initialize(){this.analysisVisualization=new r({view:this.view,analysis:this.analysis,analysisViewData:this}),this.analysisController=new h({view:this.view,analysis:this.analysis,analysisViewData:this})}destroy(){this.analysisVisualization=p(this.analysisVisualization),this.analysisController=p(this.analysisController)}async when(){return await this.analysisVisualization.whenReady(),await this.analysisController.whenReady(),this}get testData(){return{visualization:this.analysisVisualization,controller:this.analysisController}}};t([s()],d.prototype,"type",void 0),t([s()],d.prototype,"analysis",void 0),t([s()],d.prototype,"plane",void 0),t([s()],d.prototype,"active",void 0),t([s({aliasOf:"analysisVisualization.showGrid"})],d.prototype,"showGrid",void 0),t([s({aliasOf:"analysisVisualization.editable"})],d.prototype,"editable",void 0),d=t([_("esri.views.3d.analysis.SliceAnalysisView3D")],d);const de=d;export{de as default};
