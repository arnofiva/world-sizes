import{s as K,a as S,_ as he,m as Z}from"./arcadeUtils.1e20f716.js";import{D as Y,q as oe,r as fe,P as Ie,G as ue,y as Ee,_ as ce,e as Fe,a as we,b as De,g as Q,w as be,T as Ne,j as Ae,c as M,C as xe,v as _,E as T,d as X}from"./featureSetUtils.15b32940.js";import{mX as w,mZ as N,mT as D,nu as L,mS as j,mW as b,nn as W,mI as C,m_ as G,mK as Se,n1 as Te,n2 as Le,n3 as ve,eq as Oe,mQ as A,mP as q,mR as B,qY as Re,dv as V,fS as z,nj as J,qJ as ee}from"./vendor.f59113c8.js";import{d as Ce,b as de}from"./SpatialFilter.0fdbd285.js";import{WhereClause as E}from"./WhereClause.d621a470.js";import"./geometryEngineAsync.b8c0bd7a.js";function Pe(n,a,m,p){if(p.length===1){if(b(p[0]))return Z(n,p[0],-1);if(G(p[0]))return Z(n,p[0].toArray(),-1)}return Z(n,p,-1)}function ne(n,a,m){const p=n.getVariables();if(p.length>0){const I=[];for(let e=0;e<p.length;e++){const i={name:p[e]};I.push(a.evaluateIdentifier(m,i))}return q(I).then(e=>{const i={};for(let t=0;t<p.length;t++)i[p[t]]=e[t];return n.parameters=i,n})}return A(n)}function c(n,a,m=null){for(const p in n)if(p.toLowerCase()===a.toLowerCase())return n[p];return m}function me(n){if(n===null)return null;const a={type:c(n,"type",""),name:c(n,"name","")};if(a.type==="range")a.range=c(n,"range",[]);else{a.codedValues=[];for(const m of c(n,"codedValues",[]))a.codedValues.push({name:c(m,"name",""),code:c(m,"code",null)})}return a}function te(n){if(n===null)return null;const a={},m=c(n,"wkt",null);m!==null&&(a.wkt=m);const p=c(n,"wkid",null);return p!==null&&(a.wkid=p),a}function pe(n){if(n===null)return null;const a={hasZ:c(n,"hasz",!1),hasM:c(n,"hasm",!1)},m=c(n,"spatialreference",null);m&&(a.spatialReference=te(m));const p=c(n,"x",null);if(p!==null)return a.x=p,a.y=c(n,"y",null),a;const I=c(n,"rings",null);if(I!==null)return a.rings=I,a;const e=c(n,"paths",null);if(e!==null)return a.paths=e,a;const i=c(n,"points",null);if(i!==null)return a.points=i,a;for(const t of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const o=c(n,t,null);o!==null&&(a[t]=o)}return a}function Me(n,a){for(const m of a)if(m===n)return!0;return!1}function Ge(n){return!!n.layerDefinition&&!!n.featureSet&&Me(n.layerDefinition.geometryType,["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&n.layerDefinition.objectIdField!==null&&n.layerDefinition.objectIdField!==""&&b(n.layerDefinition.fields)!==!1&&b(n.featureSet.features)!==!1}function _e(n){n.mode==="async"&&(n.functions.getuser=function(a,m){return n.standardFunctionAsync(a,m,(p,I,e)=>{w(e,1,2);let i=N(e[1],""),t=i===!0;if(i=i===!0||i===!1?"":D(i),e[0]instanceof K){let d=null;return a.services&&a.services.portal&&(d=a.services.portal),d=Y(e[0],d),oe(d,i,t).then(l=>{if(l){const s=JSON.parse(JSON.stringify(l));for(const r of["lastLogin","created","modified"])s[r]!==void 0&&s[r]!==null&&(s[r]=new Date(s[r]));return S.convertObjectToArcadeDictionary(s)}return null})}let o=null;if(L(e[0])&&(o=e[0]),o)return t=!1,i?null:o.load().then(()=>o.getOwningSystemUrl()).then(d=>{if(!d)return i?null:o.getIdentityUser().then(s=>s?S.convertObjectToArcadeDictionary({username:s}):null);let l=null;return a.services&&a.services.portal&&(l=a.services.portal),l=Y(new K(d),l),oe(l,i,t).then(s=>{if(s){const r=JSON.parse(JSON.stringify(s));for(const f of["lastLogin","created","modified"])r[f]!==void 0&&r[f]!==null&&(r[f]=new Date(r[f]));return S.convertObjectToArcadeDictionary(r)}return null})});throw new Error("Invalid Parameter")})},n.signatures.push({name:"getuser",min:"1",max:"2"}),n.functions.featuresetbyid=function(a,m){return n.standardFunctionAsync(a,m,(p,I,e)=>{if(w(e,2,4),e[0]instanceof fe){const i=D(e[1]);let t=N(e[2],null);const o=j(N(e[3],!0));if(t===null&&(t=["*"]),b(t)===!1)throw new Error("Invalid Parameter");return e[0].featureSetById(i,o,t)}throw new Error("Invalid Parameter")})},n.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),n.functions.getfeatureset=function(a,m){return n.standardFunctionAsync(a,m,(p,I,e)=>{if(w(e,1,2),W(e[0])){let i=N(e[1],"datasource");return i===null&&(i="datasource"),i=D(i).toLowerCase(),Ie(e[0].fullSchema(),i,a.lrucache,a.interceptor,a.spatialReference)}throw new Error("Invalid Parameter")})},n.signatures.push({name:"getfeatureset",min:"1",max:"2"}),n.functions.featuresetbyportalitem=function(a,m){return n.standardFunctionAsync(a,m,(p,I,e)=>{if(w(e,2,5),e[0]===null)throw new Error("Portal is required");if(e[0]instanceof K){const l=D(e[1]),s=D(e[2]);let r=N(e[3],null);const f=j(N(e[4],!0));if(r===null&&(r=["*"]),b(r)===!1)throw new Error("Invalid Parameter");let u=null;return a.services&&a.services.portal&&(u=a.services.portal),u=Y(e[0],u),ue(l,s,a.spatialReference,r,f,u,a.lrucache,a.interceptor)}if(C(e[0])===!1)throw new Error("Portal is required");const i=D(e[0]),t=D(e[1]);let o=N(e[2],null);const d=j(N(e[3],!0));if(o===null&&(o=["*"]),b(o)===!1)throw new Error("Invalid Parameter");if(a.services&&a.services.portal)return ue(i,t,a.spatialReference,o,d,a.services.portal,a.lrucache,a.interceptor);throw new Error("Portal is required")})},n.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),n.functions.featuresetbyname=function(a,m){return n.standardFunctionAsync(a,m,(p,I,e)=>{if(w(e,2,4),e[0]instanceof fe){const i=D(e[1]);let t=N(e[2],null);const o=j(N(e[3],!0));if(t===null&&(t=["*"]),b(t)===!1)throw new Error("Invalid Parameter");return e[0].featureSetByName(i,o,t)}throw new Error("Invalid Parameter")})},n.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),n.functions.featureset=function(a,m){return n.standardFunction(a,m,(p,I,e)=>{w(e,1,1);let i=e[0];const t={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(C(i))i=JSON.parse(i),i.layerDefinition!==void 0?(t.layerDefinition=i.layerDefinition,t.featureSet=i.featureSet,i.layerDefinition.spatialReference&&(t.layerDefinition.spatialReference=i.layerDefinition.spatialReference)):(t.featureSet.features=i.features,t.featureSet.geometryType=i.geometryType,t.layerDefinition.geometryType=t.featureSet.geometryType,t.layerDefinition.objectIdField=i.objectIdFieldName,t.layerDefinition.typeIdField=i.typeIdFieldName,t.layerDefinition.globalIdField=i.globalIdFieldName,t.layerDefinition.fields=i.fields,i.spatialReference&&(t.layerDefinition.spatialReference=i.spatialReference));else{if(!(e[0]instanceof S))throw new Error("Invalid Parameter");{i=JSON.parse(e[0].castToText());const o=c(i,"layerdefinition");if(o!==null){t.layerDefinition.geometryType=c(o,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.globalIdField=c(o,"globalidfield",""),t.layerDefinition.objectIdField=c(o,"objectidfield",""),t.layerDefinition.typeIdField=c(o,"typeidfield","");const d=c(o,"spatialreference",null);d&&(t.layerDefinition.spatialReference=te(d));for(const s of c(o,"fields",[])){const r={name:c(s,"name",""),alias:c(s,"alias",""),type:c(s,"type",""),nullable:c(s,"nullable",!0),editable:c(s,"editable",!0),length:c(s,"length",null),domain:me(c(s,"domain"))};t.layerDefinition.fields.push(r)}const l=c(i,"featureset",null);if(l){const s={};for(const r of t.layerDefinition.fields)s[r.name.toLowerCase()]=r.name;for(const r of c(l,"features",[])){const f={},u=c(r,"attributes",{});for(const h in u)f[s[h.toLowerCase()]]=u[h];t.featureSet.features.push({attributes:f,geometry:pe(c(r,"geometry",null))})}}}else{t.layerDefinition.geometryType=c(i,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.objectIdField=c(i,"objectidfieldname",""),t.layerDefinition.typeIdField=c(i,"typeidfieldname","");const d=c(i,"spatialreference",null);d&&(t.layerDefinition.spatialReference=te(d));for(const s of c(i,"fields",[])){const r={name:c(s,"name",""),alias:c(s,"alias",""),type:c(s,"type",""),nullable:c(s,"nullable",!0),editable:c(s,"editable",!0),length:c(s,"length",null),domain:me(c(s,"domain"))};t.layerDefinition.fields.push(r)}const l={};for(const s of t.layerDefinition.fields)l[s.name.toLowerCase()]=s.name;for(const s of c(i,"features",[])){const r={},f=c(s,"attributes",{});for(const u in f)r[l[u.toLowerCase()]]=f[u];t.featureSet.features.push({attributes:r,geometry:pe(c(s,"geometry",null))})}}}}if(Ge(t)===!1)throw new Error("Invalid Parameter");return Ee.create(t,a.spatialReference)})},n.signatures.push({name:"featureset",min:"1",max:"1"}),n.functions.filter=function(a,m){return n.standardFunctionAsync(a,m,(p,I,e)=>{if(w(e,2,2),b(e[0])||G(e[0])){const i=[];let t=e[0];t instanceof Se&&(t=t.toArray());let o=null;if(e[1]instanceof Te)o=n.arcadeCustomFunctionHandler(e[1]);else if(e[1]instanceof Le)o=(...d)=>e[1].fn(a,{preparsed:!0,arguments:d});else{if(!(e[1]instanceof ve))throw new Error("Invalid Parameter");o=(...d)=>{if(d.length!==e[1].paramCount)throw new Error("Invalid parameters");return e[1].fn(...d)}}return t.reduce((d,l,s)=>d.then(r=>{s>0&&r===!0&&i.push(t[s-1]);const f=o(l);return Oe(f)?f:A(f)}),Promise.resolve(!1)).then(d=>(d===!0&&t.length>0&&i.push(t[t.length-1]),i))}return L(e[0])?e[0].load().then(i=>{const t=E.create(e[1],i.getFieldsIndex()),o=t.getVariables();if(o.length>0){const d=[];for(let l=0;l<o.length;l++){const s={name:o[l]};d.push(n.evaluateIdentifier(a,s))}return q(d).then(l=>{const s={};for(let r=0;r<o.length;r++)s[o[r]]=l[r];return t.parameters=s,new ce({parentfeatureset:e[0],whereclause:t})})}return A(new ce({parentfeatureset:e[0],whereclause:t}))}):n.failDefferred("Filter cannot accept this parameter type")})},n.signatures.push({name:"filter",min:"2",max:"2"}),n.functions.orderby=function(a,m){return n.standardFunctionAsync(a,m,(p,I,e)=>{if(w(e,2,2),L(e[0])){const i=new Fe(e[1]);return A(new we({parentfeatureset:e[0],orderbyclause:i}))}return n.failDefferred("Order cannot accept this parameter type")})},n.signatures.push({name:"orderby",min:"2",max:"2"}),n.functions.top=function(a,m){return n.standardFunctionAsync(a,m,(p,I,e)=>(w(e,2,2),L(e[0])?A(new De({parentfeatureset:e[0],topnum:e[1]})):b(e[0])?B(e[1])>=e[0].length?e[0].slice(0):e[0].slice(0,B(e[1])):G(e[0])?B(e[1])>=e[0].length()?e[0].slice(0):e[0].slice(0,B(e[1])):n.failDefferred("Top cannot accept this parameter type")))},n.signatures.push({name:"top",min:"2",max:"2"}),n.functions.first=function(a,m){return n.standardFunctionAsync(a,m,(p,I,e)=>(w(e,1,1),L(e[0])?e[0].first(p.abortSignal).then(i=>{if(i!==null){const t=he.createFromGraphicLikeObject(i.geometry,i.attributes,e[0]);t._underlyingGraphic=i,i=t}return i}):b(e[0])?e[0].length===0?A(null):A(e[0][0]):G(e[0])?e[0].length()===0?A(null):A(e[0].get(0)):null))},n.signatures.push({name:"first",min:"1",max:"1"}),n.functions.attachments=function(a,m){return n.standardFunctionAsync(a,m,(p,I,e)=>{w(e,1,2);const i={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof S){if(e[1].hasField("minsize")&&(i.minsize=B(e[1].field("minsize"))),e[1].hasField("metadata")&&(i.returnMetadata=j(e[1].field("metadata"))),e[1].hasField("maxsize")&&(i.maxsize=B(e[1].field("maxsize"))),e[1].hasField("types")){const t=Re(e[1].field("types"),!1);t.length>0&&(i.types=t)}}else if(e[1]!==null)throw new Error("Invalid Parameter")}if(W(e[0])){let t=e[0]._layer;return t instanceof V&&(t=Q(t,a.spatialReference,["*"],!0,a.lrucache,a.interceptor)),t===null||L(t)===!1?[]:t.load().then(()=>t.queryAttachments(e[0].field(t.objectIdField),i.minsize,i.maxsize,i.types,i.returnMetadata))}if(e[0]===null)return[];throw new Error("Invalid Parameter")})},n.signatures.push({name:"attachments",min:"1",max:"2"}),n.functions.featuresetbyrelationshipname=function(a,m){return n.standardFunctionAsync(a,m,(p,I,e)=>{w(e,2,4);const i=e[0],t=D(e[1]);let o=N(e[2],null);const d=j(N(e[3],!0));if(o===null&&(o=["*"]),b(o)===!1)throw new Error("Invalid Parameter");if(e[0]===null)return null;if(!W(e[0]))throw new Error("Invalid Parameter");let l=i._layer;return l instanceof V&&(l=Q(l,a.spatialReference,["*"],!0,a.lrucache,a.interceptor)),l===null||L(l)===!1?null:l.load().then(s=>{const r=s.relationshipMetaData().filter(u=>u.name===t);if(r.length===0)return null;if(r[0].relationshipTableId!==void 0&&r[0].relationshipTableId!==null&&r[0].relationshipTableId>-1)return be(s,r[0],i.field(s.objectIdField),s.spatialReference,o,d,a.lrucache,a.interceptor);let f=s.serviceUrl();return f?(f=f.charAt(f.length-1)==="/"?f+r[0].relatedTableId.toString():f+"/"+r[0].relatedTableId.toString(),Ne(f,s.spatialReference,o,d,a.lrucache,a.interceptor).then(u=>u.load().then(()=>u.relationshipMetaData()).then(h=>{if(h=h.filter(v=>v.id===r[0].id),i.hasField(r[0].keyField)===!1||i.field(r[0].keyField)===null)return s.getFeatureByObjectId(i.field(s.objectIdField),[r[0].keyField]).then(v=>{if(v){const k=E.create(h[0].keyField+"= @id",u.getFieldsIndex());return k.parameters={id:v.attributes[r[0].keyField]},u.filter(k)}return new Ce({parentfeatureset:u})});const F=E.create(h[0].keyField+"= @id",u.getFieldsIndex());return F.parameters={id:i.field(r[0].keyField)},u.filter(F)}))):null})})},n.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),n.functions.featuresetbyassociation=function(a,m){return n.standardFunctionAsync(a,m,(p,I,e)=>{w(e,2,3);const i=e[0],t=D(N(e[1],"")).toLowerCase(),o=C(e[2])?D(e[2]):null;if(e[0]===null)return null;if(!W(e[0]))throw new Error("Invalid Parameter");let d=i._layer;return d instanceof V&&(d=Q(d,a.spatialReference,["*"],!0,a.lrucache,a.interceptor)),d===null||L(d)===!1?null:d.load().then(()=>{const l=d.serviceUrl();return Ae(l,a.spatialReference)}).then(l=>{let s=null,r=null,f=!1;if(o!==null&&o!==""&&o!==void 0){for(const g of l.terminals)g.terminalName===o&&(r=g.terminalId);r===null&&(f=!0)}const u=l.associations.getFieldsIndex(),h=u.get("TOGLOBALID").name,F=u.get("FROMGLOBALID").name,v=u.get("TOTERMINALID").name,k=u.get("FROMTERMINALID").name,$=u.get("FROMNETWORKSOURCEID").name,H=u.get("TONETWORKSOURCEID").name,P=u.get("ASSOCIATIONTYPE").name,ye=u.get("ISCONTENTVISIBLE").name,ge=u.get("OBJECTID").name;for(const g of d.fields)if(g.type==="global-id"){s=i.field(g.name);break}let O=null,re=new M(new z({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",l.associations.getFieldsIndex())),ae=new M(new z({name:"side",alias:"side",type:"string"}),E.create("''",l.associations.getFieldsIndex()));const x="globalid",ie="globalId",se={};for(const g in l.lkp)se[g]=l.lkp[g].sourceId;const R=new xe(new z({name:"classname",alias:"classname",type:"string"}),null,se);let y="";switch(t){case"midspan":{y=`((${h}='${s}') OR ( ${F}='${s}')) AND (${P} IN (5))`,R.codefield=E.create(`CASE WHEN (${h}='${s}') THEN ${$} ELSE ${H} END`,l.associations.getFieldsIndex());const g=ee(T.findField(l.associations.fields,F));g.name=x,g.alias=x,O=new M(g,E.create(`CASE WHEN (${F}='${s}') THEN ${h} ELSE ${F} END`,l.associations.getFieldsIndex())),re=l.unVersion>=4?new X(T.findField(l.associations.fields,u.get("PERCENTALONG").name)):new M(new z({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",l.associations.getFieldsIndex()));break}case"junctionedge":{y=`((${h}='${s}') OR ( ${F}='${s}')) AND (${P} IN (4,6))`,R.codefield=E.create(`CASE WHEN (${h}='${s}') THEN ${$} ELSE ${H} END`,l.associations.getFieldsIndex());const g=ee(T.findField(l.associations.fields,F));g.name=x,g.alias=x,O=new M(g,E.create(`CASE WHEN (${F}='${s}') THEN ${h} ELSE ${F} END`,l.associations.getFieldsIndex())),ae=new M(new z({name:"side",alias:"side",type:"string"}),E.create(`CASE WHEN (${P}=4) THEN 'from' ELSE 'to' END`,l.associations.getFieldsIndex()));break}case"connected":{let g=`${h}='@T'`,le=`${F}='@T'`;r!==null&&(g+=` AND ${v}=@A`,le+=` AND ${k}=@A`),y="(("+g+") OR ("+le+"))",y=J(y,"@T",s),g=J(g,"@T",s),r!==null&&(g=J(g,"@A",r.toString()),y=J(y,"@A",r.toString())),R.codefield=E.create("CASE WHEN "+g+` THEN ${$} ELSE ${H} END`,l.associations.getFieldsIndex());const U=ee(T.findField(l.associations.fields,F));U.name=x,U.alias=x,O=new M(U,E.create("CASE WHEN "+g+` THEN ${F} ELSE ${h} END`,l.associations.getFieldsIndex()));break}case"container":y=`${h}='${s}' AND ${P} = 2`,r!==null&&(y+=` AND ${v} = `+r.toString()),R.codefield=$,y="( "+y+" )",O=new _(T.findField(l.associations.fields,F),x,x);case"content":y=`(${F}='${s}' AND ${P} = 2)`,r!==null&&(y+=` AND ${k} = `+r.toString()),R.codefield=H,y="( "+y+" )",O=new _(T.findField(l.associations.fields,h),x,x);break;case"structure":y=`(${h}='${s}' AND ${P} = 3)`,r!==null&&(y+=` AND ${v} = `+r.toString()),R.codefield=$,y="( "+y+" )",O=new _(T.findField(l.associations.fields,F),x,ie);break;case"attached":y=`(${F}='${s}' AND ${P} = 3)`,r!==null&&(y+=` AND ${k} = `+r.toString()),R.codefield=H,y="( "+y+" )",O=new _(T.findField(l.associations.fields,h),x,ie);break;default:throw new Error("Invalid Parameter")}return f&&(y="1 <> 1"),new T({parentfeatureset:l.associations,adaptedFields:[new X(T.findField(l.associations.fields,ge)),new X(T.findField(l.associations.fields,ye)),O,ae,R,re],extraFilter:y?E.create(y,l.associations.getFieldsIndex()):null})})})},n.signatures.push({name:"featuresetbyassociation",min:"2",max:"6"}),n.functions.groupby=function(a,m){return n.standardFunctionAsync(a,m,(p,I,e)=>(w(e,3,3),L(e[0])?e[0].load().then(i=>{const t=[],o=[];let d=!1,l=[];if(C(e[1]))l.push(e[1]);else if(e[1]instanceof S)l.push(e[1]);else if(b(e[1]))l=e[1];else{if(!G(e[1]))return n.failDefferred("Illegal Value: GroupBy");l=e[1].toArray()}for(const r of l)if(C(r)){const f=E.create(D(r),i.getFieldsIndex()),u=de(f)===!0?D(r):"%%%%FIELDNAME";t.push({name:u,expression:f}),u==="%%%%FIELDNAME"&&(d=!0)}else{if(!(r instanceof S))return n.failDefferred("Illegal Value: GroupBy");{const f=r.hasField("name")?r.field("name"):"%%%%FIELDNAME",u=r.hasField("expression")?r.field("expression"):"";if(f==="%%%%FIELDNAME"&&(d=!0),!f)return n.failDefferred("Illegal Value: GroupBy");t.push({name:f,expression:E.create(u||f,i.getFieldsIndex())})}}if(l=[],C(e[2]))l.push(e[2]);else if(b(e[2]))l=e[2];else if(G(e[2]))l=e[2].toArray();else{if(!(e[2]instanceof S))return n.failDefferred("Illegal Value: GroupBy");l.push(e[2])}for(const r of l){if(!(r instanceof S))return n.failDefferred("Illegal Value: GroupBy");{const f=r.hasField("name")?r.field("name"):"",u=r.hasField("statistic")?r.field("statistic"):"",h=r.hasField("expression")?r.field("expression"):"";if(!f||!u||!h)return n.failDefferred("Illegal Value: GroupBy");o.push({name:f,statistic:u.toLowerCase(),expression:E.create(h,i.getFieldsIndex())})}}if(d){const r={};for(const u of i.fields)r[u.name.toLowerCase()]=1;for(const u of t)u.name!=="%%%%FIELDNAME"&&(r[u.name.toLowerCase()]=1);for(const u of o)u.name!=="%%%%FIELDNAME"&&(r[u.name.toLowerCase()]=1);let f=0;for(const u of t)if(u.name==="%%%%FIELDNAME"){for(;r["field_"+f.toString()]===1;)f++;r["field_"+f.toString()]=1,u.name="FIELD_"+f.toString()}}const s=[];for(const r of t)s.push(ne(r.expression,n,a));for(const r of o)s.push(ne(r.expression,n,a));return s.length>0?q(s).then(()=>A(e[0].groupby(t,o))):A(e[0].groupby(t,o))}):n.failDefferred("Illegal Value: GroupBy")))},n.signatures.push({name:"groupby",min:"3",max:"3"}),n.functions.distinct=function(a,m){return n.standardFunctionAsync(a,m,(p,I,e)=>L(e[0])?(w(e,2,2),e[0].load().then(i=>{const t=[];let o=[];if(C(e[1]))o.push(e[1]);else if(e[1]instanceof S)o.push(e[1]);else if(b(e[1]))o=e[1];else{if(!G(e[1]))return n.failDefferred("Illegal Value: GroupBy");o=e[1].toArray()}let d=!1;for(const s of o)if(C(s)){const r=E.create(D(s),i.getFieldsIndex()),f=de(r)===!0?D(s):"%%%%FIELDNAME";t.push({name:f,expression:r}),f==="%%%%FIELDNAME"&&(d=!0)}else{if(!(s instanceof S))return n.failDefferred("Illegal Value: GroupBy");{const r=s.hasField("name")?s.field("name"):"%%%%FIELDNAME",f=s.hasField("expression")?s.field("expression"):"";if(r==="%%%%FIELDNAME"&&(d=!0),!r)return n.failDefferred("Illegal Value: GroupBy");t.push({name:r,expression:E.create(f||r,i.getFieldsIndex())})}}if(d){const s={};for(const f of i.fields)s[f.name.toLowerCase()]=1;for(const f of t)f.name!=="%%%%FIELDNAME"&&(s[f.name.toLowerCase()]=1);let r=0;for(const f of t)if(f.name==="%%%%FIELDNAME"){for(;s["field_"+r.toString()]===1;)r++;s["field_"+r.toString()]=1,f.name="FIELD_"+r.toString()}}const l=[];for(const s of t)l.push(ne(s.expression,n,a));return l.length>0?q(l).then(()=>A(e[0].groupby(t,[]))):A(e[0].groupby(t,[]))})):Pe("distinct",p,I,e))})}export{_e as registerFunctions};
