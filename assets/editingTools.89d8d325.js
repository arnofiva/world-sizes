var an=Object.defineProperty,sn=Object.defineProperties;var nn=Object.getOwnPropertyDescriptors;var Yi=Object.getOwnPropertySymbols;var rn=Object.prototype.hasOwnProperty,on=Object.prototype.propertyIsEnumerable;var Qi=(t,e,i)=>e in t?an(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,O=(t,e)=>{for(var i in e||(e={}))rn.call(e,i)&&Qi(t,i,e[i]);if(Yi)for(var i of Yi(e))on.call(e,i)&&Qi(t,i,e[i]);return t},R=(t,e)=>sn(t,nn(e));import{cr as ln,lN as hn,cp as N,cn as ns,c7 as H,I as m,cy as rt,cB as rs,cC as os,cD as ls,cE as hs,kH as cs,cK as ds,cw as ps,cx as Qt,cQ as us,di as Lt,jQ as cn,aH as y,b7 as q,J as h,hk as gs,L as _,hl as dn,ed as pn,hm as un,hn as gn,f2 as V,iI as tt,lO as mn,cF as _n,lP as ms,dF as Di,iz as _s,kf as Kt,h9 as It,lQ as fn,lR as vn,cZ as Ki,aE as I,lS as Jt,lT as yn,lU as Mn,gu as Ji,eJ as ea,lV as bn,dH as ot,e$ as wn,lW as We,iw as Ie,ix as ge,b9 as ie,lX as fs,lY as Ai,lZ as vs,l_ as ys,l$ as Ms,m0 as bs,jA as di,m1 as En,k3 as ei,jW as Ii,y as re,hG as B,i8 as Ot,iP as $,jn as ti,c4 as z,bk as D,hf as yi,m2 as ii,iQ as pe,eV as Ae,jm as ws,aB as Pt,km as Mi,ha as xn,j1 as Oi,j0 as zi,j9 as Dt,iD as Ve,j8 as Ye,jd as He,m3 as Sn,a_ as Dn,W as Es,jj as An,aW as Ue,gR as ta,m4 as On,m5 as Pn,eA as ai,m6 as Rn,b8 as si,d_ as Pi,eW as Hi,eS as zt,jf as x,m7 as Gn,m8 as te,l as W,ln as k,m9 as yt,je as $e,ma as Cn,mb as bi,eG as Tn,iR as Ri,N as Vn,O as $n,d as v,u as ye,h as Ln,ce as ia,aI as xs,e1 as Ht,ak as Me,mc as In,ba as fe,md as zn,jp as Ft,ci as Hn,jo as aa,aC as Ss,er as Un,bv as Nn,me as kn,dR as Ds,mf as Fn,mg as Bn,cz as Rt,dd as Z,a7 as pt,R as F,mh as jn,mi as U,mj as As,mk as Wn,ml as Os,gC as Xn,jX as Gi,mm as sa,jY as Le,jZ as Ci,kk as ni,lE as Ps,am as na,eH as Ne,mn as qn,f0 as Gt,hi as ra,kb as J,kq as E,kD as Zn,ek as Yt,mo as Rs,ka as ri,jS as Ui,k2 as Yn,kE as Qn,jT as Gs,au as Kn,d3 as Cs,A as Jn,mp as er,mq as Ts,lD as tr,mr as ir,jJ as Ut,jy as Vs,f1 as ar,j2 as oa,V as Ni,aZ as Fe,ms as la,mt as sr,bX as nr,mu as ha,kh as xe,mv as rr,mw as or,e4 as lr,mx as hr,kL as Ct,my as ca,e_ as cr,mz as da,k7 as $s,a5 as Ls,gt as Is,gm as zs,bb as dr,cf as pr,kP as ur,mA as pa,jk as ua,jL as ga,k9 as ht,jE as ma,mB as gr,mC as mr,bT as _a,mD as Ge,mE as Bt,mF as _r}from"./vendor.d1b93dad.js";import{t as fr,n as ki}from"./LineVisualElement.640b7e15.js";import{z as vr}from"./RightAngleQuadVisualElement.2b95085b.js";import{r as yr,e as oi}from"./SnappingContext.9e7e28aa.js";import{y as Mr,p as br,q as wr}from"./colorUtils.7c4b6dc5.js";import{F as fa,t as ne,w as De,c as Ti,d as Mt,v as Hs,O as Us,u as Ns,e as Er,f as xr,_ as Sr,i as Dr,m as Ar,k as Or,V as Pr,l as va,Q as Rr,n as Gr,K as Cr,s as Tr,r as Vr}from"./sliceToolUtils.96408bc9.js";import{_ as $r,b as Lr,G as Ir,n as zr,r as Hr,a as Fi,x as Ur,w as Nr,p as ue,C as At,d as kr,e as mt,D as ct,f as pi,g as li,R as Fr,M as Br}from"./drawSurfaces.992ce592.js";import{v as jr}from"./GraphicManipulator.8ee7b045.js";import{S as ui,X as Wr,T as ya,E as Se,t as Xr,a as qr,s as Zr,c as Yr,e as Ma}from"./EditGeometryOperations.3de3efe5.js";import{l as Qr,v as Kr}from"./axisAngleDegrees.f9e2944e.js";function ks(t,e){t.extensions.add("GL_OES_standard_derivatives"),t.fragment.include(ln),t.include(hn),t.fragment.uniforms.add("glowColor","vec3"),t.fragment.uniforms.add("glowWidth","float"),t.fragment.uniforms.add("glowFalloff","float"),t.fragment.uniforms.add("innerColor","vec3"),t.fragment.uniforms.add("innerWidth","float"),t.fragment.uniforms.add("depthMap","sampler2D"),t.fragment.uniforms.add("nearFar","vec2"),t.fragment.uniforms.add("frameColor","sampler2D"),e.contrastControlEnabled&&t.fragment.uniforms.add("globalAlphaContrastBoost","float"),t.fragment.code.add(N`vec4 blendPremultiplied(vec4 source, vec4 dest) {
float oneMinusSourceAlpha = 1.0 - source.a;
return vec4(
source.rgb + dest.rgb * oneMinusSourceAlpha,
source.a + dest.a * oneMinusSourceAlpha
);
}`),t.fragment.code.add(N`vec4 premultipliedColor(vec3 rgb, float alpha) {
return vec4(rgb * alpha, alpha);
}`),t.fragment.code.add(N`vec4 laserlineProfile(float dist) {
if (dist > glowWidth) {
return vec4(0.0);
}
float innerAlpha = (1.0 - smoothstep(0.0, innerWidth, dist));
float glowAlpha = pow(max(0.0, 1.0 - dist / glowWidth), glowFalloff);
return blendPremultiplied(
premultipliedColor(innerColor, innerAlpha),
premultipliedColor(glowColor, glowAlpha)
);
}`),t.fragment.code.add(N`bool laserlineReconstructFromDepth(out vec3 pos, out vec3 normal, out float depthDiscontinuityAlpha) {
float depth = linearDepthFromTexture(depthMap, uv, nearFar);
if (-depth == nearFar[0]) {
return false;
}
pos = reconstructPosition(gl_FragCoord.xy, depth);
normal = normalize(cross(dFdx(pos), dFdy(pos)));
float ddepth = fwidth(depth);
depthDiscontinuityAlpha = 1.0 - smoothstep(0.0, 0.01, -ddepth / depth);
return true;
}`),e.contrastControlEnabled?t.fragment.code.add(N`float rgbToLuminance(vec3 color) {
return dot(vec3(0.2126, 0.7152, 0.0722), color);
}
vec4 laserlineOutput(vec4 color) {
float backgroundLuminance = rgbToLuminance(texture2D(frameColor, uv).rgb);
float alpha = clamp(globalAlpha * max(backgroundLuminance * globalAlphaContrastBoost, 1.0), 0.0, 1.0);
return color * alpha;
}`):t.fragment.code.add(N`vec4 laserlineOutput(vec4 color) {
return color * globalAlpha;
}`)}function Jr(t){const e=new ns;return e.include(ks,t),e.vertex.uniforms.add("modelView","mat4"),e.vertex.uniforms.add("proj","mat4"),e.attributes.add(H.START,"vec3"),e.attributes.add(H.END,"vec3"),e.attributes.add(H.UP,"vec3"),e.attributes.add(H.EXTRUDE,"vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vViewStart","vec3"),e.varyings.add("vViewEnd","vec3"),e.varyings.add("vViewPlane","vec4"),e.vertex.uniforms.add("glowWidth","float"),e.vertex.uniforms.add("pixelToNDC","vec2"),e.vertex.code.add(N`void main() {
vec3 pos = mix(start, end, extrude.x);
vec4 viewPos = modelView * vec4(pos, 1);
vec4 projPos = proj * viewPos;
vec2 ndcPos = projPos.xy / projPos.w;
vec3 viewUp = (modelView * vec4(extrude.y * up, 0)).xyz;
vec4 projPosUp = proj * vec4(viewPos.xyz + viewUp, 1);
vec2 projExtrudeDir = normalize(projPosUp.xy / projPosUp.w - ndcPos);
vec2 lxy = abs(sign(projExtrudeDir) - ndcPos);
ndcPos += length(lxy) * projExtrudeDir;
vec3 worldPlaneNormal = normalize(cross(up, normalize(end - start)));
vec3 viewPlaneNormal = (modelView * vec4(worldPlaneNormal, 0)).xyz;
vViewStart = (modelView * vec4(start, 1)).xyz;
vViewEnd = (modelView * vec4(end, 1)).xyz;
vViewPlane = vec4(viewPlaneNormal, -dot(viewPlaneNormal, vViewStart));
float xPaddingPixels = sign(dot(viewPlaneNormal, viewPos.xyz)) * (extrude.x * 2.0 - 1.0) * glowWidth;
ndcPos.x += xPaddingPixels * pixelToNDC.x;
uv = ndcPos * 0.5 + 0.5;
gl_Position = vec4(ndcPos, 0, 1);
}`),e.fragment.uniforms.add("globalAlpha","float"),e.fragment.uniforms.add("perScreenPixelRatio","float"),e.fragment.code.add(N`float planeDistancePixels(vec4 plane, vec3 pos, vec3 start, vec3 end) {
vec3 origin = mix(start, end, 0.5);
vec3 basis = end - origin;
vec3 posAtOrigin = pos - origin;
float x = dot(normalize(basis), posAtOrigin);
float y = dot(plane.xyz, posAtOrigin);
float dx = max(abs(x) - length(basis), 0.0);
float dy = y;
float dist = length(vec2(dx, dy));
float width = fwidth(y);
float maxPixelDistance = length(pos) * perScreenPixelRatio * 2.0;
float pixelDist = dist / min(width, maxPixelDistance);
return abs(pixelDist);
}
void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
float distance = planeDistancePixels(vViewPlane, pos, vViewStart, vViewEnd);
vec4 color = laserlineProfile(distance);
float alpha = 1.0 - smoothstep(0.995, 0.999, abs(dot(normal, vViewPlane.xyz)));
gl_FragColor = laserlineOutput(color * alpha * depthDiscontinuityAlpha);
}`),e}const eo=Object.freeze({__proto__:null,build:Jr});class Je extends ls{initializeProgram(e){const i=Je.shader.get(),a=this.configuration,s=i.build(a);return new hs(e.rctx,s,Je.attributeLocations)}bind(e,i,a){this.program.setUniform3fv("innerColor",e.innerColor),this.program.setUniform1f("innerWidth",e.innerWidth*a.pixelRatio),this.program.setUniform3fv("glowColor",e.glowColor),this.program.setUniform1f("glowWidth",e.glowWidth*a.pixelRatio),this.program.setUniform1f("glowFalloff",e.glowFalloff),this.program.setUniform1f("globalAlpha",e.globalAlpha),this.program.setUniform1f("perScreenPixelRatio",a.perScreenPixelRatio),this.program.setUniform2f("pixelToNDC",2/a.fullWidth,2/a.fullHeight),this.program.setUniformMatrix4fv("proj",a.projectionMatrix),cs(ba,a.viewMatrix,i),this.program.setUniformMatrix4fv("modelView",ba),this.configuration.contrastControlEnabled&&this.program.setUniform1f("globalAlphaContrastBoost",e.globalAlphaContrastBoost!=null?e.globalAlphaContrastBoost:1)}initializePipeline(){return ds({blending:ps(Qt.ONE,Qt.ONE_MINUS_SRC_ALPHA),colorWrite:us})}}Je.shader=new os(eo,()=>import("./LaserlinePath.glsl.38df0624.js")),Je.attributeLocations=new Map([[H.START,0],[H.END,1],[H.UP,2],[H.EXTRUDE,3]]);class Fs extends rs{constructor(){super(...arguments),this.contrastControlEnabled=!1}}m([rt()],Fs.prototype,"contrastControlEnabled",void 0);const ba=Lt();class wa{constructor(e){this._renderCoordsHelper=e,this._buffers=null,this._origin=y(),this._dirty=!1,this._count=0,this._vao=null}set vertices(e){const i=new Float64Array(3*e.length);let a=0;for(const s of e)i[a++]=s[0],i[a++]=s[1],i[a++]=s[2];this.buffers=[i]}set buffers(e){if(this._buffers=e,this._buffers.length>0){const i=this._buffers[0],a=3*Math.floor(i.length/3/2);q(this._origin,i[a+0],i[a+1],i[a+2])}else q(this._origin,0,0,0);this._dirty=!0}get origin(){return this._origin}draw(e){const i=this._ensureVAO(e);h(i)&&(e.bindVAO(i),e.drawArrays(gs.TRIANGLES,0,this._count))}dispose(){h(this._vao)&&this._vao.dispose()}_ensureVAO(e){return _(this._buffers)?null:(_(this._vao)&&(this._vao=this._createVAO(e,this._buffers)),this._ensureVertexData(this._vao,this._buffers),this._vao)}_createVAO(e,i){const a=this._createDataBuffer(i);return this._dirty=!1,new dn(e,Je.attributeLocations,{data:pn(xa)},{data:un.createVertex(e,gn.STATIC_DRAW,a)})}_ensureVertexData(e,i){if(!this._dirty)return;const a=this._createDataBuffer(i);e.vertexBuffers.data.setData(a),this._dirty=!1}_numberOfRenderVertices(e){return 3*(2*(e.length/3-1))}_createDataBuffer(e){const i=e.reduce((o,l)=>o+this._numberOfRenderVertices(l),0);this._count=i;const a=xa.createBuffer(i),s=this._origin;let n=0,r=0;for(const o of e){for(let l=0;l<o.length;l+=3){const c=q(Ea,o[l+0],o[l+1],o[l+2]);l===0?r=this._renderCoordsHelper.getAltitude(c):this._renderCoordsHelper.setAltitude(c,r);const d=this._renderCoordsHelper.worldUpAtPosition(c,to),p=n+2*l,g=V(Ea,c,s);if(l<o.length-3){a.up.setVec(p,d),a.up.setVec(p+3,d),a.up.setVec(p+5,d);for(let f=0;f<6;f++)a.start.setVec(p+f,g);a.extrude.setValues(p+0,0,-1),a.extrude.setValues(p+1,1,-1),a.extrude.setValues(p+2,1,1),a.extrude.setValues(p+3,0,-1),a.extrude.setValues(p+4,1,1),a.extrude.setValues(p+5,0,1)}if(l>0){a.up.setVec(p-2,d),a.up.setVec(p-4,d),a.up.setVec(p-5,d);for(let f=-6;f<0;f++)a.end.setVec(p+f,g)}}n+=this._numberOfRenderVertices(o)}return a.buffer}}const to=y(),Ea=y(),xa=cn().vec3f(H.START).vec3f(H.END).vec3f(H.UP).vec2f(H.EXTRUDE),Bi=tt(6);function io(t){const e=new ns;return e.extensions.add("GL_OES_standard_derivatives"),e.include(mn),e.include(ks,t),e.fragment.uniforms.add("angleCutoff","vec2"),e.fragment.uniforms.add("globalAlpha","float"),t.heightManifoldEnabled&&e.fragment.uniforms.add("heightPlane","vec4"),t.pointDistanceEnabled&&e.fragment.uniforms.add("pointDistanceSphere","vec4"),t.lineVerticalPlaneEnabled&&e.fragment.uniforms.add("lineVerticalPlane","vec4").add("lineVerticalStart","vec3").add("lineVerticalEnd","vec3"),(t.heightManifoldEnabled||t.pointDistanceEnabled||t.lineVerticalPlaneEnabled)&&e.fragment.uniforms.add("maxPixelDistance","float"),t.intersectsLineEnabled&&e.fragment.uniforms.add("intersectsLineStart","vec3").add("intersectsLineEnd","vec3").add("intersectsLineDirection","vec3").add("intersectsLineRadius","float").add("perScreenPixelRatio","float"),(t.lineVerticalPlaneEnabled||t.heightManifoldEnabled)&&e.fragment.code.add(N`float planeDistancePixels(vec4 plane, vec3 pos) {
float dist = dot(plane.xyz, pos) + plane.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),t.pointDistanceEnabled&&e.fragment.code.add(N`float sphereDistancePixels(vec4 sphere, vec3 pos) {
float dist = distance(sphere.xyz, pos) - sphere.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),t.intersectsLineEnabled&&e.fragment.code.add(N`float lineDistancePixels(vec3 start, vec3 dir, float radius, vec3 pos) {
float dist = length(cross(dir, pos - start)) / (length(pos) * perScreenPixelRatio);
return abs(dist) - radius;
}`),(t.lineVerticalPlaneEnabled||t.intersectsLineEnabled)&&e.fragment.code.add(N`bool pointIsWithinLine(vec3 pos, vec3 start, vec3 end) {
vec3 dir = end - start;
float t2 = dot(dir, pos - start);
float l2 = dot(dir, dir);
return t2 >= 0.0 && t2 <= l2;
}`),e.fragment.code.add(N`void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
vec4 color = vec4(0, 0, 0, 0);`),t.heightManifoldEnabled&&e.fragment.code.add(N`{
float heightManifoldAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, heightPlane.xyz)));
vec4 heightManifoldColor = laserlineProfile(planeDistancePixels(heightPlane, pos));
color = max(color, heightManifoldColor * heightManifoldAlpha);
}`),t.pointDistanceEnabled&&e.fragment.code.add(N`{
float pointDistanceSphereDistance = sphereDistancePixels(pointDistanceSphere, pos);
vec4 pointDistanceSphereColor = laserlineProfile(pointDistanceSphereDistance);
float pointDistanceSphereAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, normalize(pos - pointDistanceSphere.xyz))));
color = max(color, pointDistanceSphereColor * pointDistanceSphereAlpha);
}`),t.lineVerticalPlaneEnabled&&e.fragment.code.add(N`{
if (pointIsWithinLine(pos, lineVerticalStart, lineVerticalEnd)) {
float lineVerticalDistance = planeDistancePixels(lineVerticalPlane, pos);
vec4 lineVerticalColor = laserlineProfile(lineVerticalDistance);
float lineVerticalAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, lineVerticalPlane.xyz)));
color = max(color, lineVerticalColor * lineVerticalAlpha);
}
}`),t.intersectsLineEnabled&&e.fragment.code.add(N`{
if (pointIsWithinLine(pos, intersectsLineStart, intersectsLineEnd)) {
float intersectsLineDistance = lineDistancePixels(intersectsLineStart, intersectsLineDirection, intersectsLineRadius, pos);
vec4 intersectsLineColor = laserlineProfile(intersectsLineDistance);
float intersectsLineAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, 1.0 - abs(dot(normal, intersectsLineDirection)));
color = max(color, intersectsLineColor * intersectsLineAlpha);
}
}`),e.fragment.code.add(N`gl_FragColor = laserlineOutput(color * depthDiscontinuityAlpha);
}`),e}const ao=Object.freeze({__proto__:null,defaultAngleCutoff:Bi,build:io});class gi extends ls{initializeProgram(e){const i=gi.shader.get(),a=this.configuration,s=i.build(a);return new hs(e.rctx,s,_n)}bind(e,i){this.program.setUniform3fv("innerColor",e.innerColor),this.program.setUniform1f("innerWidth",e.innerWidth*i.pixelRatio),this.program.setUniform3fv("glowColor",e.glowColor),this.program.setUniform1f("glowWidth",e.glowWidth*i.pixelRatio),this.program.setUniform1f("glowFalloff",e.glowFalloff),this.program.setUniform1f("globalAlpha",e.globalAlpha),this.configuration.contrastControlEnabled&&this.program.setUniform1f("globalAlphaContrastBoost",e.globalAlphaContrastBoost!=null?e.globalAlphaContrastBoost:1);const a=e.angleCutoff!=null?e.angleCutoff:Bi;this.program.setUniform2f("angleCutoff",Math.cos(a),Math.cos(Math.max(0,a-tt(2)))),this.configuration.intersectsLineEnabled&&this.program.setUniform1f("perScreenPixelRatio",i.perScreenPixelRatio)}initializePipeline(){return ds({blending:ps(Qt.ONE,Qt.ONE_MINUS_SRC_ALPHA),colorWrite:us})}}gi.shader=new os(ao,()=>import("./Laserlines.glsl.bfd6c6af.js"));class lt extends rs{constructor(){super(...arguments),this.heightManifoldEnabled=!1,this.pointDistanceEnabled=!1,this.lineVerticalPlaneEnabled=!1,this.intersectsLineEnabled=!1,this.contrastControlEnabled=!1}}m([rt()],lt.prototype,"heightManifoldEnabled",void 0),m([rt()],lt.prototype,"pointDistanceEnabled",void 0),m([rt()],lt.prototype,"lineVerticalPlaneEnabled",void 0),m([rt()],lt.prototype,"intersectsLineEnabled",void 0),m([rt()],lt.prototype,"contrastControlEnabled",void 0);const so=y(),no=Di(),ro={glowColor:[1,.5,0],glowWidth:8,glowFalloff:8,innerColor:[1,1,1],innerWidth:1,globalAlpha:.75,angleCutoff:tt(6),globalAlphaContrastBoost:2};function Sa(t,e,i,a){const s=so,n=no;ot(s,e,a),I(n,i),n[3]=0,bs(n,n,a),di(s,n,t)}class oo{constructor(e,i={},a={contrastControlEnabled:!1}){this._renderCoordsHelper=e,this._config=a,this._technique=null,this._projInfo=Di(),this._zScale=_s(),this._heightManifoldEnabled=!1,this._heightManifoldTarget=y(),this._pointDistanceEnabled=!1,this._pointDistanceOrigin=y(),this._pointDistanceTarget=y(),this._lineVerticalPlaneEnabled=!1,this._lineVerticalPlaneSegment=Kt(),this._intersectsLineEnabled=!1,this._intersectsLineSegment=Kt(),this._intersectsLineRadius=3,this._intersectsLineInfinite=!1,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._tempNormal=y(),this._tempDir=y(),this._tempUp=y(),this._tempVec3A=y(),this._tempVec3B=y(),this._tempVec4=Di(),this._tempPlane=It(),this._tempSphere=fn(),this._params=vn(i,ro)}get renderSlots(){return[this._config.contrastControlEnabled?Ki.LASERLINES_CONTRAST_CONTROL:Ki.LASERLINES]}get needsLinearDepth(){return!0}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this._requestRender())}get heightManifoldTarget(){return this._heightManifoldTarget}set heightManifoldTarget(e){I(this._heightManifoldTarget,e),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this._requestRender())}get pointDistanceTarget(){return this._pointDistanceTarget}set pointDistanceTarget(e){I(this._pointDistanceTarget,e),this._requestRender()}get pointDistanceOrigin(){return this._pointDistanceOrigin}set pointDistanceOrigin(e){I(this._pointDistanceOrigin,e),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this._requestRender())}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){Jt(e,this._lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this._requestRender())}get intersectsLineSegment(){return this._intersectsLineSegment}set intersectsLineSegment(e){Jt(e,this._intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._intersectsLineRadius}set intersectsLineRadius(e){e!==this._intersectsLineRadius&&(this._intersectsLineRadius=e,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(e){e!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=e,h(this._pathVerticalPlaneData)&&this._requestRender())}set pathVerticalPlaneVertices(e){_(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new wa(this._renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(e){_(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new wa(this._renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameters(e){yn(this._params,e)&&this._requestRender()}initializeRenderContext(e){this._context=e;const i=e.renderContext.rctx;this._quadVAO=Mn(i),this._techniqueRepository=e.shaderTechniqueRepository,this._techniqueConfig=new lt;const a=new Fs;a.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquire(Je,a)}uninitializeRenderContext(){this._quadVAO=Ji(this._quadVAO),this._technique=ea(this._technique),this._pathVerticalPlaneData=Ji(this._pathVerticalPlaneData),this._pathTechnique=ea(this._pathTechnique)}prepareTechnique(){return this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled?(this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._technique=this._techniqueRepository.releaseAndAcquire(gi,this._techniqueConfig,this._technique),this._technique):this._pathTechnique}render(e,i){const a=e.camera;bn(a.projectionMatrix,a.fullWidth,a.fullHeight,this._projInfo,this._zScale),(this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled)&&this._renderUnified(e,i),this.pathVerticalPlaneEnabled&&this._renderPath(e)}_renderUnified(e,i){const a=e.rctx,s=a.useTechnique(i);this._bindGlobalUniforms(e,s),this._bindHeightManifoldUniforms(e,s),this._bindPointDistanceUniforms(e,s),this._bindLineVerticalPlaneUniforms(e,s),this._bindIntersectsLineUniforms(e,s),i.bind(this._params,e.camera),a.bindVAO(this._quadVAO),a.drawArrays(gs.TRIANGLE_STRIP,0,4)}_renderPath(e){if(_(this._pathVerticalPlaneData)||_(this._pathTechnique))return;const i=e.rctx,a=this._pathTechnique,s=i.useTechnique(a);this._bindGlobalUniforms(e,s),a.bind(this._params,this._pathVerticalPlaneData.origin,e.camera),this._pathVerticalPlaneData.draw(e.rctx)}_bindHeightManifoldUniforms(e,i){if(!this.heightManifoldEnabled)return;const a=this._tempVec3A,s=this._tempPlane;this._renderCoordsHelper.worldUpAtPosition(this._heightManifoldTarget,a),Sa(s,this._heightManifoldTarget,a,e.camera.viewMatrix),i.setUniform4fv("heightPlane",s)}_bindPointDistanceUniforms(e,i){if(!this._pointDistanceEnabled)return;const a=e.camera,s=this._tempSphere;I(s,this._pointDistanceOrigin),ot(s,s,a.viewMatrix),s[3]=wn(this._pointDistanceOrigin,this._pointDistanceTarget),i.setUniform4f("pointDistanceSphere",s[0],s[1],s[2],s[3])}_bindLineVerticalPlaneUniforms(e,i){if(!this._lineVerticalPlaneEnabled)return;const a=this._renderCoordsHelper,s=e.camera,n=this._tempPlane,r=this._tempVec3A,o=this._tempUp,l=this._tempDir,c=this._tempNormal;We(this._lineVerticalPlaneSegment,.5,r),a.worldUpAtPosition(r,o),Ie(l,this._lineVerticalPlaneSegment.vector),ge(c,o,l),Ie(c,c),Sa(n,this._lineVerticalPlaneSegment.origin,c,s.viewMatrix),i.setUniform4fv("lineVerticalPlane",n);const d=this._tempVec3A;I(d,this._lineVerticalPlaneSegment.origin),a.setAltitude(d,0),ot(d,d,s.viewMatrix),i.setUniform3fv("lineVerticalStart",d);const p=this._tempVec3B;ie(p,this._lineVerticalPlaneSegment.origin,this._lineVerticalPlaneSegment.vector),a.setAltitude(p,0),ot(p,p,s.viewMatrix),i.setUniform3fv("lineVerticalEnd",p)}_bindIntersectsLineUniforms(e,i){if(!this._intersectsLineEnabled)return;const a=lo,s=ho;if(this._intersectsLineInfinite){const o=e.camera;if(fs(Ai(this._intersectsLineSegment.origin,this._intersectsLineSegment.vector),bt),bt.c0=-Number.MAX_VALUE,!vs(o.frustum,bt))return;ys(bt,a),Ms(bt,s)}else I(a,this._intersectsLineSegment.origin),ie(s,this._intersectsLineSegment.origin,this._intersectsLineSegment.vector);const n=this._tempVec3A;ot(n,a,e.camera.viewMatrix),i.setUniform3fv("intersectsLineStart",n);const r=this._tempVec4;I(r,this._intersectsLineSegment.vector),this._tempVec4[3]=0,bs(this._tempVec4,this._tempVec4,e.camera.viewMatrix),ot(s,s,e.camera.viewMatrix),i.setUniform3fv("intersectsLineEnd",s),Ie(r,r),i.setUniform3f("intersectsLineDirection",r[0],r[1],r[2]),i.setUniform1f("intersectsLineRadius",this._intersectsLineRadius)}_bindGlobalUniforms(e,i){const a=e.camera;i.setUniform4fv("projInfo",this._projInfo),i.setUniform2fv("zScale",this._zScale),i.setUniform2fv("nearFar",a.nearFar),this._heightManifoldEnabled?i.setUniform1f("maxPixelDistance",2*a.computeScreenPixelSizeAt(this._heightManifoldTarget)):this._pointDistanceEnabled?i.setUniform1f("maxPixelDistance",2*a.computeScreenPixelSizeAt(this._pointDistanceTarget)):this._lineVerticalPlaneEnabled&&i.setUniform1f("maxPixelDistance",2*a.computeScreenPixelSizeAt(this._lineVerticalPlaneSegment.origin)),i.bindTexture(e.offscreenRenderingHelper.linearDepthTexture,"depthMap"),i.bindTexture(e.offscreenRenderingHelper.mainColorTexture,"frameColor")}_requestRender(){this._context&&this._context.requestRender()}}const bt=ms(),lo=y(),ho=y();class Tt extends fr{constructor(e){super(e.view),this._angleCutoff=Bi,this._style={},this._heightManifoldTarget=y(),this._heightManifoldEnabled=!1,this._intersectsLine=Kt(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProps(e)}get testData(){return this.renderer}createResources(){this._ensureRenderer()}destroyResources(){this._disposeRenderer()}updateVisibility(){this._syncRenderer(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(e){this._angleCutoff!==e&&(this._angleCutoff=e,this._syncAngleCutoff())}get style(){return this._style}set style(e){this._style=e,this._syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(e){h(e)?(I(this._heightManifoldTarget,e),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this._syncRenderer(),this._syncHeightManifold()}set intersectsWorldUpAtLocation(e){if(_(e))return void(this.intersectsLine=null);const i=this.view.renderCoordsHelper.worldUpAtPosition(e,co);this.intersectsLine=En(e,i),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(e){h(e)?(Jt(e,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this._syncIntersectsLine(),this._syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){this._intersectsLineInfinite=e,this._syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){this._lineVerticalPlaneSegment=h(e)?Jt(e):null,this._syncLineVerticalPlane(),this._syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(e){this._pathVerticalPlaneBuffers=e,this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(e){this._pointDistanceLine=h(e)?{origin:ei(e.origin),target:ei(e.target)}:null,this._syncPointDistance(),this._syncRenderer()}_syncRenderer(){this.attached&&this.visible&&(this._intersectsLineEnabled||this._heightManifoldEnabled||h(this._pointDistanceLine)||h(this._pathVerticalPlaneBuffers))?this._ensureRenderer():this._disposeRenderer()}_ensureRenderer(){h(this.renderer)||(this.renderer=new oo(this.view.renderCoordsHelper,void 0,{contrastControlEnabled:!0}),this._syncStyle(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncIntersectsLineInfinite(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncAngleCutoff(),this.view._stage&&this.view._stage.addRenderPlugin(this.renderer.renderSlots,this.renderer))}_syncStyle(){_(this.renderer)||(this.renderer.setParameters(this._style),this._style.intersectsLineRadius!=null&&(this.renderer.intersectsLineRadius=this._style.intersectsLineRadius))}_syncAngleCutoff(){_(this.renderer)||this.renderer.setParameters({angleCutoff:this._angleCutoff})}_syncHeightManifold(){_(this.renderer)||(this.renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this.renderer.heightManifoldTarget=this._heightManifoldTarget))}_syncIntersectsLine(){_(this.renderer)||(this.renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this.renderer.intersectsLineSegment=this._intersectsLine))}_syncIntersectsLineInfinite(){_(this.renderer)||(this.renderer.intersectsLineInfinite=this._intersectsLineInfinite)}_syncPathVerticalPlane(){_(this.renderer)||(this.renderer.pathVerticalPlaneEnabled=h(this._pathVerticalPlaneBuffers)&&this.visible,h(this._pathVerticalPlaneBuffers)&&(this.renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}_syncLineVerticalPlane(){_(this.renderer)||(this.renderer.lineVerticalPlaneEnabled=h(this._lineVerticalPlaneSegment)&&this.visible,h(this._lineVerticalPlaneSegment)&&(this.renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}_syncPointDistance(){_(this.renderer)||(this.renderer.pointDistanceEnabled=h(this._pointDistanceLine)&&this.visible,h(this._pointDistanceLine)&&(this.renderer.pointDistanceOrigin=this._pointDistanceLine.origin,this.renderer.pointDistanceTarget=this._pointDistanceLine.target))}_disposeRenderer(){h(this.renderer)&&this.view._stage&&(this.view._stage.removeRenderPlugin(this.renderer),this.renderer=null)}}const co=y();class ji extends ki{constructor(e){super(e),this._ray=Ii(),this._externalResources=null,this._handles=new re,this._isWorldDown=!1,this._start=y(),this._end=B(1,0,0),this._width=1,this._color=Ot(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=Ot(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=K.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=$.OccludeAndTransparent,this._fadedExtensions=Oa,this.applyProps(e)}createExternalResources(){const e=new ti(this.materialParameters);this._handles.add(this.view.state.watch("camera",()=>{this._updateGeometry()}));const i=new Tt({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:i}}destroyExternalResources(){h(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalMaterial(e){h(this._externalResources)&&e(this._externalResources.material)}createGeometries(e){const i=[y(),y()],a=this.extensionType===K.FADED;a&&i.push(y(),y());const s=a?new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]):null,n=z.createPolylineGeometry(i,null,s);e.addGeometry(n,D(this._externalResources).material),this._updateVertices(e)}updateVisibility(e){super.updateVisibility(e),h(this._externalResources)&&(this._externalResources.laserline.visible=e)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,I(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),V(this._end,e,this._end),yi(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,ii(this._start,e)||(I(this._start,e),yi(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,ii(this._end,e)||(I(this._end,e),yi(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){pe(e,this._color)||(Ae(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){pe(e,this._innerColor)||(Ae(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const i=h(e)!==h(this._stipplePattern);this._stipplePattern=e,i?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(_(e)||_(this._stippleOffColor)||!pe(e,this._stippleOffColor))&&(this._stippleOffColor=h(e)?ws(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this._updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&h(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,h(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,h(e)&&(this._externalResources.laserline.style=e))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,h(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=Pt(e,Oa),this.recreateGeometry()}_updateMaterial(){_(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,polygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}_updateGeometry(){h(this.object)&&this._updateVertices(this.object)}_updateVertices(e){const i=this._extensionType===K.FADED?this._updateLineSegmentFinite(Da):this._updateLineSegmentInfinite(this._extensionType,Da);this._updateVertexAttributes(e,i),h(this._externalResources)&&(this._externalResources.laserline.intersectsLine=i)}_updateLineSegmentFinite(e){return Mi(this._start,this._end,e)}_updateLineSegmentInfinite(e,i){const a=this.view.state.camera;switch(fs(this._ray,Ce),e){case K.LINE:Ce.c0=-Number.MAX_VALUE;break;case K.RAY:case K.GROUND_RAY:{const r=this._ray.origin,o=Pt(this.view.elevationProvider.getElevation(r[0],r[1],r[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),l=this.view.renderCoordsHelper.getAltitude(r);this._isWorldDown&&l<o&&xn(Ce.ray.direction,Ce.ray.direction),this._extensionType===K.GROUND_RAY&&o!=null&&(Ce.c1=Math.abs(l-o));break}}if(!vs(a.frustum,Ce))return Mi(this._start,this._end,i);const s=ys(Ce,Be),n=Ms(Ce,po);return Mi(s,n,i)}_updateVertexAttributes(e,i){const a=e.geometries[0].getMutableAttribute(H.POSITION).data;if(this.extensionType===K.FADED){const s=We(i,-this.fadedExtensions.start,Be);a[0]=s[0],a[1]=s[1],a[2]=s[2];const n=We(i,0,Be);a[3]=n[0],a[4]=n[1],a[5]=n[2];const r=We(i,1,Be);a[6]=r[0],a[7]=r[1],a[8]=r[2];const o=We(i,1+this.fadedExtensions.end,Be);a[9]=o[0],a[10]=o[1],a[11]=o[2]}else{const s=We(i,0,Be);a[0]=s[0],a[1]=s[1],a[2]=s[2];const n=We(i,1,Be);a[3]=n[0],a[4]=n[1],a[5]=n[2]}e.geometryVertexAttrsUpdated(e.geometryRecords[0])}}const Ce=ms(),Be=y(),po=y(),Da=Kt();var K;(function(t){t[t.LINE=0]="LINE",t[t.RAY=1]="RAY",t[t.GROUND_RAY=2]="GROUND_RAY",t[t.FADED=3]="FADED"})(K||(K={}));const Aa=1/3,Oa={start:Aa,end:Aa};class uo extends ki{constructor(e){super(e),this._handles=new re,this._location=y(),this._direction=B(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=Ot(1,0,1,1),this._renderOccluded=$.OccludeAndTransparent,this.applyProps(e)}get location(){return this._location}set location(e){ii(this._location,e)||(I(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){ii(this._direction,e)||(I(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,i){Ie(this._direction,V(this._direction,i,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){pe(e,this._color)||(Ae(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}createExternalResources(){const e=new ti(this.materialParameters);this._handles.add(this.view.state.watch("camera",()=>{this._updateGeometry()})),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const i=z.createPolylineGeometry([y(),y()]),a=z.createPolylineGeometry([y(),y()]),s=D(this._externalResources).material;e.addGeometry(i,s),e.addGeometry(a,s),this._updateVertices(e)}forEachExternalMaterial(e){h(this._externalResources)&&e(this._externalResources.material)}_updateMaterial(){_(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){const e=this.object;_(e)||this._updateVertices(e)}_updateVertices(e){const i=this.view.state.camera;i.projectToScreen(this.location,jt),ie(_e,this.location,this.direction),i.projectToScreen(_e,it),Oi(it,zi(it,it,jt)),this._updateVertexAttributes(i,e,0,jt,it,1),this._updateVertexAttributes(i,e,1,jt,it,-1)}_updateVertexAttributes(e,i,a,s,n,r){const o=i.geometryRecords[a],l=o.geometry.getMutableAttribute(H.POSITION).data,c=Dt(Pa,Ve(Pa,n[1]*r,n[0]*-r),this.offset+this.width/2),d=Ye(Wt,Ye(Wt,Ye(Wt,s,Dt(Wt,n,this.length/2)),c),c),p=Ye(Ra,d,Dt(Ra,n,-this.length));e.unprojectFromScreen(d,_e),l[0]=_e[0],l[1]=_e[1],l[2]=_e[2],e.unprojectFromScreen(p,_e),l[3]=_e[0],l[4]=_e[1],l[5]=_e[2],i.geometryVertexAttrsUpdated(o)}}const _e=y(),jt=He(),it=He(),Pa=He(),Wt=He(),Ra=He();class Bs{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return h(this._resources)?this._resources.object:null}get resources(){return h(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this.resourceFactory.recreateGeometry)return void this.recreate();const e=this.resourceFactory.view._stage;if(_(this._resources)||!e)return;const i=this._resources.object;this._resources.external.forEach(s=>{s.type===Sn.Geometry&&e.remove(s)}),i.removeAllGeometries();const a=this.resourceFactory.recreateGeometry(this._resources.external,i,this._resources.layer);e.addMany(a)}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this.resourceFactory.view._stage;if(!e)return;const i=new Dn({isPickable:!1,updatePolicy:Es.SYNC});e.add(i);const a=new An({castShadow:!1}),s=this.resourceFactory.createResources(a,i);s.forEach(r=>e.add(r)),e.add(a),i.add(a);const n=this.resourceFactory.cameraChanged?Ue(this.resourceFactory.view.state,"camera",r=>this.resourceFactory.cameraChanged(r)):null;this._resources={layer:i,object:a,external:s,cameraHandle:n},this._syncVisible()}_destroyResources(){if(_(this._resources))return;const e=this.resourceFactory.view._stage;e==null||e.remove(this._resources.object),e==null||e.remove(this._resources.layer),this._resources.external.forEach(i=>{e==null||e.remove(i),"dispose"in i&&i.dispose()}),this._resources.object.dispose(),this._resources.cameraHandle&&this._resources.cameraHandle.remove(),this._resources=null}_syncVisible(){_(this._resources)||this._resources.object.setVisible(this._visible)}}class Vi{constructor(e){this.view=null,this._geometry=null,this._size=3,this._color=ta(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=ta(1,1,1,1),this._elevationInfo=null,this.resources=new Bs({view:e.view,createResources:a=>this._createResources(a),recreateGeometry:(a,s)=>(a.geometry=this._recreateGeometry(s,a.material),h(a.geometry)?[a.geometry]:[])});let i=!0;for(const a in e)a in this?a==="attached"?i=e[a]:this[a]=e[a]:console.error("Cannot set unknown property",a);this.attached=i}destroy(){this.resources.destroy()}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e}get attached(){return this.resources.attached}set attached(e){this.resources.attached=e}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const i=this.preferredTextureSize;this._size=e,i<this.preferredTextureSize?h(this.resources)&&this.resources.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){pe(e,this._color)||(Ae(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,h(this.resources)&&this.resources.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){pe(e,this._outlineColor)||(Ae(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources&&this.resources.recreateGeometry()}_updateMaterial(){const e=this.resources.resources;_(e)||e.material.setParameters(this._materialParameters(e.texture.id))}_updateSizeAttribute(){const e=this.resources.resources,i=this.resources.object;if(_(e)||_(i))return;const a=e.geometry;if(_(a))return;const s=a.getMutableAttribute(H.SIZE).data,n=this.geometrySize;s[0]=n,s[1]=n,i.geometryVertexAttrsUpdated(i.geometryRecords[0])}_materialParameters(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:go,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}}get geometrySize(){return this._size/xt}_recreateGeometry(e,i){const a=this._createRenderGeometry();return h(a)&&e.addGeometry(a,i),a}_createResources(e){const i=On(this._primitive,this.preferredTextureSize),a=new Pn(this._materialParameters(i.id)),s=this._recreateGeometry(e,a);return{material:a,texture:i,geometry:s,forEach(n){n(i),n(a),h(this.geometry)&&n(this.geometry)}}}get preferredTextureSize(){return ai(Rn(2*this.geometrySize),16,128)}calculateMapBounds(e){if(_(this.resources.resources)||_(this.resources.resources.geometry))return!1;const i=this.resources.resources.geometry.vertexAttributes.get(H.POSITION);return si(i.data,this.view.renderCoordsHelper.spatialReference,Ga,this.view.spatialReference),Pi(e,Ga),!0}_createRenderGeometry(){const e=this.geometry;if(_(e))return null;const{renderCoordsHelper:i,elevationProvider:a}=this.view,s=Hi(e,a,zt.fromElevationInfo(this.elevationInfo),i),n=q(x.get(),e.x,e.y,s),r=x.get();si(n,e.spatialReference,r,i.spatialReference);const o=this.geometrySize;return z.createPointGeometry(null,r,null,[o,o],[0,0,0,1])}}const xt=Gn,go=[xt/2,xt/2,1-xt/2,1-xt/2],Ga=y();class Vt extends yr{visualizeIntersectionPoint(e,i){const{coordinateHelper:a,elevationInfo:s,view:n}=i;return te(new Vi({view:n,primitive:"circle",geometry:a.vectorToPoint(e.intersectionPoint),elevationInfo:s,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:W.toUnitRGBA(k.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,i){const{coordinateHelper:a,elevationInfo:s,view:n}=i;return te(new Vi({view:n,primitive:"circle",geometry:a.vectorToPoint(e.point),elevationInfo:s,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:W.toUnitRGBA(k.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,i){const{coordinateHelper:a,elevationInfo:s,view:n}=i;return te(this._createLineSegmentHintFromMap(e.type,e.lineStart,e.lineEnd,a,s,n,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,i){const{coordinateHelper:a,elevationInfo:s,view:n}=i,r=yt(e.lineStart,a,s,i.view),o=yt(e.lineEnd,a,s,i.view),l=$e(o,r,o,.5),c=new uo({view:n,attached:!1,offset:k.parallelLineHintOffset,length:k.parallelLineHintLength,width:k.parallelLineHintWidth,color:W.toUnitRGBA(k.orange),location:l,renderOccluded:$.Opaque});return c.setDirectionFromPoints(r,l),c.attached=!0,te(c)}visualizeRightAngleQuad(e,i){const{coordinateHelper:a,elevationInfo:s,view:n}=i;return te(new vr({view:n,attached:!0,color:W.toUnitRGBA(k.orange),renderOccluded:$.Transparent,outlineRenderOccluded:$.Opaque,outlineColor:W.toUnitRGBA(k.orange),outlineSize:k.rightAngleHintOutlineSize,size:k.rightAngleHintSize,geometry:{previous:yt(e.previousVertex,a,s,n),center:yt(e.centerVertex,a,s,n),next:yt(e.nextVertex,a,s,n)}}))}_createLineSegmentHintFromMap(e,i,a,s,n,r,o=!0,l=!0){const c=y(),d=y();return Cn(i,a,s,n,r,c,d),this._createLineSegmentHint(e,r,c,d,o,l)}_createLineSegmentHint(e,i,a,s,n=!0,r=!0){const o=new ji({view:i,extensionType:K.FADED,start:a,end:s,color:W.toUnitRGBA(k.orange),renderOccluded:$.Opaque});switch(e){case bi.TARGET:o.width=k.lineHintWidthTarget,o.fadedExtensions={start:0,end:k.lineHintFadedExtensions};break;case bi.REFERENCE_EXTENSION:o.width=k.lineHintWidthReference,o.fadedExtensions={start:0,end:0};break;case bi.REFERENCE:o.width=k.lineHintWidthReference,o.fadedExtensions={start:n?k.lineHintFadedExtensions:0,end:r?k.lineHintFadedExtensions:0}}return o.attached=!0,o}}const M={main:new W([255,127,0]),selected:new W([255,255,255]),staged:new W([12,207,255]),outline:new W([0,0,0,.5]),selectedOutline:new W([255,255,255])},ut=.3;function $t(t,e){const i=t.clone();return i.a*=e,i}function mo(t,e){const i=t.clone(),a=Mr(i);a.s*=e;const s=br(a);return i.r=s.r,i.g=s.g,i.b=s.b,i}function oe(t,e){if(e)for(const i in e)t[i]=e[i]}class _o{constructor(e){this.color=M.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=$.Opaque,oe(this,e)}}class wi{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=M.main,this.outlineColor=M.outline,this.renderOccluded=$.Opaque,this.hoverOutlineColor=M.selectedOutline,oe(this,e)}apply(e,i){const a=this[e];i.setParameters({color:ze(a),transparent:e!=="color"||a.a<1,renderOccluded:this.renderOccluded})}}class fo{constructor(e){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=$t(M.main,.5),this.hoverColor=M.main,this.renderOccluded=$.Transparent,this.minSquaredEdgeLength=900,oe(this,e)}apply(e,i){const a=this[e];i.setParameters({color:ze(a),transparent:a.a<1,renderOccluded:this.renderOccluded})}}class vo{constructor(e){this.vertex=new wi({color:M.main,outlineColor:M.outline}),this.edge=new wi({color:mo($t(M.main,2/3),.5),outlineColor:$t(M.outline,.5),size:8,collisionPadding:8}),this.selected=new wi({color:M.selected,outlineColor:M.outline}),this.edgeOffset=new fo,oe(this,e)}}class $i{constructor(e){this.color=M.selected,this.width=1.5,this.stipplePattern=Ri(5),this.stippleOffColor=M.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=M.selected,this.renderOccluded=$.OccludeAndTransparent,oe(this,e)}apply(e){e.color=ze(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=ze(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=ze(this.innerColor),e.renderOccluded=this.renderOccluded}}class yo{constructor(e){this.color=M.selected,this.size=4,this.outlineSize=1,this.outlineColor=M.outline,this.shape="square",oe(this,e)}apply(e){e.color=ze(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=ze(this.outlineColor),e.primitive=this.shape}}class hi{constructor(e){this.innerColor=M.selected,this.innerWidth=1,this.glowColor=M.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=ut,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=M.main,oe(this,e)}apply(e,i=1){const a={glowColor:W.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:W.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*i,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=a:e.laserlineStyle=a}}class Mo{constructor(e){this.outline=new $i({color:M.outline,renderOccluded:$.OccludeAndTransparentStencil,stippleOffColor:M.selected,stipplePattern:Ri(5),width:1.5,innerWidth:0}),this.staged=new $i({color:M.selected,renderOccluded:$.OccludeAndTransparentStencil,innerColor:M.staged,stippleOffColor:M.outline,stipplePattern:Ri(5),width:1.5}),this.shadowStyle=new hi({globalAlpha:ut,glowColor:M.main,glowFalloff:8,glowWidth:8,innerColor:M.selected,innerWidth:1}),oe(this,e)}}class bo{constructor(e){this.outline=new yo({color:M.selected,outlineColor:M.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new hi({globalAlpha:ut,glowColor:M.main,glowFalloff:1.5,glowWidth:6,innerColor:M.selected,innerWidth:1,radius:2}),oe(this,e)}}class wo extends $i{constructor(e){super(),this.extensionType=K.GROUND_RAY,oe(this,e)}}class Eo{constructor(e){this.lineGraphics=new Mo,this.pointGraphics=new bo,this.heightPlane=new hi({globalAlpha:ut,glowColor:M.main,glowFalloff:8,glowWidth:8,innerColor:M.selected,innerWidth:1}),this.heightBox=new hi({globalAlpha:ut,glowColor:M.main,glowFalloff:8,glowWidth:8,innerColor:M.selected,innerWidth:0,heightFillColor:M.main}),this.zVerticalLine=new wo({color:$t(M.main,5*ut/3),falloff:2,innerColor:$t(M.selected,0),renderOccluded:$.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:K.GROUND_RAY}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,oe(this,e)}}class xo{constructor(e){this.visualElements=new Eo,this.reshapeManipulators=new vo,this.zManipulator=new _o,oe(this,e)}colorToVec4(e){return ze(e)}}function ze(t){return Tn(W.toUnitRGBA(t))}const u=new xo;class So{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get resources(){return h(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){this.resourceFactory.recreateGeometry?_(this._resources)||(this._ensureRenderGeometriesRemoved(),this.resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?_(this._resources)&&this._createResources():this._destroyResources()}_createResources(){var e;this._destroyResources();const i=this.resourceFactory.createResources();this._resources={layerView:new St({view:this.resourceFactory.view}),external:i,geometriesAdded:!1},this._syncGeometriesToRenderer();const a=(e=this.resourceFactory.view.basemapTerrain)==null?void 0:e.overlayManager;a&&a.registerDrapeSource(this._resources.layerView)}_destroyResources(){var e;if(_(this._resources))return;this._ensureRenderGeometriesRemoved();const i=(e=this.resourceFactory.view.basemapTerrain)==null?void 0:e.overlayManager;i&&i.unregisterDrapeSource(this._resources.layerView),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){var e;_(this._resources)||(e=this.resourceFactory.view)==null||!e.basemapTerrain||!this._resources.geometriesAdded||(this.resourceFactory.view.basemapTerrain.overlayManager.renderer.removeGeometries(this._resources.external.geometries,this._resources.layerView,ia.Geometry.UPDATE),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){_(this._resources)||this._resources.geometriesAdded||(this.resourceFactory.view.basemapTerrain.overlayManager.renderer.addGeometries(this._resources.external.geometries,this._resources.layerView,ia.Geometry.UPDATE),this._resources.geometriesAdded=!0)}}let St=class extends Vn(Ln){constructor(t){super(t),this.drapeSourceType=$n.Features,this.updatePolicy=Es.SYNC}};m([v({constructOnly:!0})],St.prototype,"view",void 0),m([v({readOnly:!0})],St.prototype,"drapeSourceType",void 0),St=m([ye("DrapedVisualElementLayerView")],St);class et{constructor(e){this.view=null,this._attachmentOrigin=Ht(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new Me,this._isDraped=!1,this._geometry=null,this._width=1,this._color=Ot(1,0,1,1),this._innerWidth=0,this._innerColor=Ot(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=$.OccludeAndTransparentStencil,this.resources=new Bs({view:e.view,createResources:a=>this._createResources(a),recreateGeometry:(a,s)=>(a.geometries.length=0,this._recreateGeometry(s,a.material,a.geometries),a.geometries)}),this._attachmentOrigin.spatialReference=e.view.spatialReference,this.drapedResources=new So({view:e.view,createResources:()=>this._createDrapedResources(),recreateGeometry:a=>{a.geometries=this._createRenderGeometriesDraped(a.material),this._attachmentOriginChanged()}});let i=!0;this._laserline=new Tt({view:e.view});for(const a in e)a in this?a==="attached"?i=e[a]:this[a]=e[a]:console.error("Cannot set unknown property",a);this.attached=i}destroy(){this.resources.destroy(),this.drapedResources.destroy(),this._laserline.destroy()}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this._updateAttached(this.attached),this._laserline.attached=this.laserlineAttached)}get laserlineAttached(){return this.attached&&this.visible&&h(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e,this.drapedResources.visible=e,this._laserline.attached=this.laserlineAttached}get attached(){return this.resources.attached||this.drapedResources.attached}set attached(e){this._updateAttached(e)}_updateAttached(e){this.resources.attached=!this.isDraped&&e,this.drapedResources.attached=this.isDraped&&e,this._laserline.attached=this.laserlineAttached,this.attached&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry(),this.drapedResources.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){pe(e,this._color)||(Ae(this._color,e),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){pe(e,this._innerColor)||(Ae(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const i=h(e)!==h(this._stipplePattern);this._stipplePattern=e,i?this.resources.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e&&this._stippleOffColor&&pe(e,this._stippleOffColor)||(this._stippleOffColor=e?ws(e):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this.laserlineAttached,h(e)&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this.laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const e=h(this.resources.resources)?this.resources.resources.geometries:null;if(!e||e.length===0)return null;q(at,0,0,0);let i=0;for(const a of e){const s=a.vertexAttributes.get(H.POSITION),n=a.indices.get(H.POSITION),r=D(this.resources.resources).material.isClosed(s.data,n);In(s,n,r,Ca)&&(ie(at,at,Ca),i++)}return i===0?null:(fe(at,at,1/i),this.view.renderCoordsHelper.fromRenderCoords(at,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){h(this.resources.resources)&&this.resources.resources.material.setParameters(this.materialParameters),h(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameters(this.materialParameters)}get isClosed(){return h(this.geometry)&&this.geometry.type==="polygon"}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this.isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",polygonOffset:!0,renderOccluded:this.normalizedRenderOccluded}}get normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===$.OccludeAndTransparentStencil?$.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(e,i,a){const s=this._createRenderGeometries();for(const n of s)e.addGeometry(n,i),a.push(n);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_createResources(e){const i=new ti(this.materialParameters),a=[];return this._recreateGeometry(e,i,a),{material:i,geometries:a,forEach:s=>{s(i),a.forEach(s)}}}_createDrapedResources(){const e=new ti(this.materialParameters);return{material:e,geometries:this._createRenderGeometriesDraped(e)}}_createRenderGeometriesDraped(e){const i=this.geometry;if(_(i))return[];const a=zn(i,this.view.basemapTerrain.spatialReference),s=[];for(const{position:n}of a.lines){const r={overlayInfo:{spatialReference:this.view.basemapTerrain.spatialReference,renderCoordsHelper:this.view.renderCoordsHelper},attributeData:{position:n},removeDuplicateStartEnd:this.isClosed?Ft.REMOVE:Ft.KEEP},o=new Hn(aa(r),e),l=Ss(Do);Pi(l,n),Un(o.boundingSphere,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0,.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1]))),s.push(o)}return s}calculateMapBounds(e){if(_(this.resources.resources))return!1;const i=this.view.renderCoordsHelper;for(const a of this.resources.resources.geometries){const s=a.vertexAttributes.get(H.POSITION),n=new Float64Array(s.data.length);Nn(s.data,i.spatialReference,0,n,this.view.spatialReference,0,s.data.length/3),Pi(e,n)}return!0}_createRenderGeometries(){var e;const i=this.geometry;if(_(i))return[];const a=kn(i,this.view.elevationProvider,this.view.renderCoordsHelper,zt.fromElevationInfo((e=this.elevationInfo)!=null?e:new Ds({mode:Fn(i,null)}))),s=[],n=[];for(const{position:r,mapPosition:o}of a.lines){const l={overlayInfo:null,attributeData:{position:r,mapPosition:o},removeDuplicateStartEnd:this.isClosed?Ft.REMOVE:Ft.KEEP};s.push(aa(l)),n.push(r)}return this._laserline.pathVerticalPlane=n,s}}const Do=xs(),Ca=y(),at=y();class Ta extends ki{constructor(e){super(e),this.view=null,this._renderOccluded=$.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=u.colorToVec4(u.reshapeManipulators.vertex.color),this._size=u.reshapeManipulators.vertex.size,this._outlineColor=u.colorToVec4(u.reshapeManipulators.vertex.outlineColor),this._outlineSize=u.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){pe(e,this._color)||(Ae(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){pe(e,this._outlineColor)||(Ae(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSize:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSize:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this.vertexMaterial.setParameters(this.vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameters(this.vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(_(e)||e.length===0)return[];const i=.5,a=.5,s=Bn(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,zt.fromElevationInfo(this.elevationInfo)),n=[],r=s.numVertices,o=s.position;for(let l=0;l<r;++l){const c=q(Ao,o[3*l+0],o[3*l+1],o[3*l+2]),d=Va(i,c),p=Va(a,c);n.push({vertexGeometry:d,vertexOutlineGeometry:p})}return n}createGeometries(e){const i=this._createRenderGeometries();for(const{vertexGeometry:a,vertexOutlineGeometry:s}of i)e.addGeometry(a,this.vertexMaterial),e.addGeometry(s,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new fa(R(O({},this.vertexMaterialParameters),{writeDepth:!0,cullFace:Rt.Back,screenSizeEnabled:!0})),this.vertexOutlineMaterial=new fa(R(O({},this.vertexOutlineMaterialParameters),{transparent:!0,writeDepth:!0,cullFace:Rt.Front,screenSizeEnabled:!0,shadingEnabled:!1}))}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this.vertexMaterial),e(this.vertexOutlineMaterial)}}const Ao=y();function Va(t,e){return z.createSphereGeometry(t,16,16,{offset:e})}let ee=class extends Me.EventedAccessor{constructor(t){super(t),this.tracking=!1,this.displaying=!1,this.isDraped=!1}};m([v({constructOnly:!0})],ee.prototype,"graphic",void 0),m([v()],ee.prototype,"tracking",void 0),m([v()],ee.prototype,"displaying",void 0),m([v()],ee.prototype,"isDraped",void 0),ee=m([ye("esri.views.3d.layers.graphics.GraphicState")],ee);let Xe=class extends $r{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:t,offset:e}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new Ds({mode:t,offset:e})}normalizeCtorArgs(t){if(!t.elevationInfo){var e;const i=(e=t.hasZ)==null||e;return R(O({},t),{elevationInfo:{mode:i?"absolute-height":"on-the-ground",offset:0}})}return t}initializeGraphic(t){return this._createGraphicState=new ee({graphic:t}),Z([this.view.maskOccludee(t),this.view.trackGraphicState(this._createGraphicState),Ue(this._createGraphicState,"isDraped",e=>{h(this._outlineVisualElement)&&(this._outlineVisualElement.isDraped=e)})])}makeDrawOperation(){return new Lr({view:this.view,manipulators:this.manipulators,geometryType:Ir(this.geometryType),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new zr(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new Hr(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new Vt})}onActiveVertexChanged(t){return h(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[t],null):(this._activeVertexVisualElement=new Ta({view:this.view,spatialReference:this.view.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:u.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=u.colorToVec4(u.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,pt(()=>{this._activeVertexVisualElement=F(this._activeVertexVisualElement)}))}onOutlineChanged(t){if(h(this._outlineVisualElement))return this._outlineVisualElement.geometry=t,null;const e=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new et({view:this.view,geometry:t,elevationInfo:e,isDraped:h(this._createGraphicState)?this._createGraphicState.isDraped:jn(this.hasZ,e)==="on-the-ground",attached:!1}),u.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),u.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,pt(()=>{this._outlineVisualElement=F(this._outlineVisualElement)})}onRegularVerticesChanged(t){return h(this._verticesVisualElement)?(this._verticesVisualElement.vertices=t,null):(this._verticesVisualElement=new Ta({view:this.view,spatialReference:this.view.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:u.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,pt(()=>{this._verticesVisualElement=F(this._verticesVisualElement)}))}};m([v({constructOnly:!0})],Xe.prototype,"elevationInfo",void 0),m([v({constructOnly:!0})],Xe.prototype,"geometryType",void 0),m([v({readOnly:!0})],Xe.prototype,"type",void 0),m([v({constructOnly:!0,nonNullable:!0})],Xe.prototype,"view",void 0),Xe=m([ye("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Xe);function Qe(t,e=U(t)){return e.mode!=="on-the-ground"&&!(_(t.geometry)||!t.geometry.hasZ)}var de;(function(t){t[t.NONE=0]="NONE",t[t.ANY=1]="ANY",t[t.Z=2]="Z",t[t.XY=4]="XY"})(de||(de={}));var P;(function(t){t[t.TRANSLATE_Z=0]="TRANSLATE_Z",t[t.TRANSLATE_XY=1]="TRANSLATE_XY",t[t.SCALE=2]="SCALE",t[t.ROTATE=3]="ROTATE",t[t.SCALE_ROTATE=4]="SCALE_ROTATE"})(P||(P={}));class js{constructor(){this.grabbingState=de.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=de.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator((i,a)=>{if(a===P.TRANSLATE_Z&&(this.zManipulator=i),i instanceof ne&&(i.selected&&(this.numSelected===0&&(this.firstSelected=i),this.numSelected++),_(this.firstGrabbedXY)&&i.grabbing&&a===P.TRANSLATE_XY&&(this.firstGrabbedXY=i)),i.grabbing)switch(this.grabbingState|=de.ANY,a){case P.TRANSLATE_Z:this.grabbingState|=de.Z;break;case P.TRANSLATE_XY:this.grabbingState|=de.XY}})}}function Oo(t){const{view:e,graphic:i}=t,a=new ee({graphic:i}),s=Po(t,a),n=[s,Ro(t,s.visualElement,a),e.maskOccludee(i),e.trackGraphicState(a)];return{visualElement:s.visualElement,remove:()=>Z(n).remove()}}function Po(t,e){const{view:i,graphic:a}=t,s=new et({view:i,geometry:Li(a)?a.geometry:null,elevationInfo:U(a),attached:!1});u.visualElements.lineGraphics.shadowStyle.apply(s);const n=()=>{s.attached=e.displaying};u.visualElements.lineGraphics.outline.apply(s);const r=[e.watch("displaying",n),e.watch("isDraped",o=>s.isDraped=o),e.on("changed",()=>s.geometry=Li(a)?a.geometry:null),te(s)];return n(),{visualElement:s,remove:()=>Z(r).remove()}}function Ro(t,e,i){const{graphic:a,view:s}=t,n=[],r=U(a),o=r.mode==="on-the-ground"||!r.offset&&r.mode!=="absolute-height",l=new js,c=new ji({view:s,extensionType:u.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:$.OccludeAndTransparent});u.visualElements.pointGraphics.shadowStyle.apply(c);const d=tt(u.visualElements.heightPlaneAngleCutoff),p=new Tt({view:s,attached:!1,angleCutoff:d});u.visualElements.heightPlane.apply(p);let g=1,f=1;const b=()=>{if(l.update(t),!i.displaying||o&&(i.isDraped||!Li(a)||!a.geometry.hasZ))return e.laserlineEnabled=!1,c.attached=!1,void(p.attached=!1);e.laserlineEnabled=!0;{const w=l.grabbingState&de.XY?u.visualElements.laserlineAlphaMultiplier:1;w!==g&&(g=w,u.visualElements.lineGraphics.shadowStyle.apply(e,w),u.visualElements.pointGraphics.shadowStyle.apply(c,w))}{const w=l.grabbingState&de.Z?u.visualElements.laserlineAlphaMultiplier:1;w!==f&&(f=w,u.visualElements.heightPlane.apply(p,w))}Go(c,l),Co(t,e,p,l)};u.visualElements.zVerticalLine.apply(c),n.push(i.on("changed",b),i.watch("displaying",b),e.events.on("attachment-origin-changed",b),te(c),te(p));const A=[],G=()=>{Z(A).remove(),A.length=0,t.forEachManipulator(w=>A.push(w.events.on("grab-changed",b))),t.forEachManipulator(w=>A.push(w.events.on("select-changed",b))),b()};return G(),n.push(t.onManipulatorsChanged(G),As(()=>Z(A))),Z(n)}function Go(t,e){const i=e.numSelected===1?e.firstSelected:e.numSelected>1&&h(e.firstGrabbedXY)?e.firstGrabbedXY:null;h(i)?(t.setStartEndFromWorldDownAtLocation(i.renderLocation),t.attached=!0):t.attached=!1}function Co(t,e,i,a){if(a.numSelected>0){q(je,0,0,0);let s=0;t.forEachManipulator((n,r)=>{r===P.TRANSLATE_XY&&n.selected&&n instanceof ne&&(ie(je,je,n.renderLocation),s++)}),s>0?(i.heightManifoldTarget=fe(je,je,1/s),i.attached=!0):i.attached=!1}else{const s=e.attachmentOrigin;h(s)&&t.view.renderCoordsHelper.toRenderCoords(s,je)?(i.heightManifoldTarget=je,i.attached=!0):i.attached=!1}}function Li(t){return h(t.geometry)&&(t.geometry.type==="polygon"||t.geometry.type==="polyline")}const je=y();function To(t){const{view:e,graphic:i}=t,a=new ee({graphic:i}),s=[],n=$o(t,a,s);return Vo(t,a,s,n),s.push(e.trackGraphicState(a)),{visualElement:n,remove(){Z(s).remove()}}}function Vo(t,e,i,a){const{view:s,graphic:n}=t,r=new ji({view:s,extensionType:u.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:$.OccludeAndTransparent});u.visualElements.zVerticalLine.apply(r);const o=new Tt({view:s,intersectsLineInfinite:!0,attached:!1});u.visualElements.pointGraphics.shadowStyle.apply(o);const l=tt(u.visualElements.heightPlaneAngleCutoff),c=new Tt({view:s,attached:!1,angleCutoff:l});u.visualElements.heightPlane.apply(c);const d=U(t.graphic),p=zt.fromElevationInfo(d),g=d.mode==="on-the-ground"||!d.offset&&d.mode!=="absolute-height",f=new js;let b=1,A=1;const G=()=>{f.update(t);const w=Wi(n),C=g&&(e.isDraped||_(w)||!w.hasZ);let Y=!0;if(!C&&h(w)){const L=Hi(w,s.elevationProvider,p,s.renderCoordsHelper);q(he,w.x,w.y,L),si(he,w.spatialReference,he,s.renderCoordsHelper.spatialReference),r.setStartEndFromWorldDownAtLocation(he),o.intersectsWorldUpAtLocation=he}else Y=!1;const _t=f.grabbingState&de.Z?u.visualElements.laserlineAlphaMultiplier:1;_t!==b&&(b=_t,u.visualElements.heightPlane.apply(c,_t));const ft=Ss(Ho);!C&&e.displaying&&a.calculateMapBounds(ft)&&si(Wn(ft,he),s.spatialReference,he,s.renderCoordsHelper.spatialReference)?(c.heightManifoldTarget=he,c.attached=!0):c.attached=!1;const be=f.grabbingState&de.XY?u.visualElements.laserlineAlphaMultiplier:1;be!==A&&(A=be,u.visualElements.pointGraphics.shadowStyle.apply(o,be));const kt=Y&&e.displaying&&!C;o.attached=kt,r.attached=kt};i.push(e.watch(["displaying","isDraped"],G),e.on("changed",G)),t.forEachManipulator(w=>{i.push(w.events.on("grab-changed",G))}),i.push(te(o)),i.push(te(r)),i.push(te(c)),G()}function $o(t,e,i){const{view:a,graphic:s}=t,n=new Vi({view:a,geometry:Wi(s),elevationInfo:U(s),attached:!1});return Lo(t,n,e,i),i.push(te(n)),n}function Wi(t){const e=t.geometry;return _(e)?null:e.type==="point"?e:e.type==="mesh"?e.anchor.clone():null}function Lo(t,e,i,a){const s=()=>e.attached=i.displaying;Io(t,e,i,a),u.visualElements.pointGraphics.outline.apply(e),a.push(Ue(i,"displaying",s))}function Io(t,e,i,a){const{view:s,graphic:n}=t;let r=null;const o=c=>{h(r)&&(r.remove(),r=null),i.isDraped&&h(c)&&(r=zo(s,c,()=>{e.geometry=c}))},l=()=>{const c=Wi(n);o(c),e.geometry=c};a.push(i.on("changed",l),As(()=>r)),l()}function zo(t,e,i){const a=t.elevationProvider.spatialReference;Xn(e,he,a);const s=he[0],n=he[1];return t.elevationProvider.on("elevation-change",r=>{Os(r.extent,s,n)&&i()})}const he=y(),Ho=xs();function mi(t){switch(D(t.graphic.geometry).type){case"point":case"mesh":return To(t);case"polygon":case"polyline":return Oo(t);default:return null}}const Uo=[1,.5,0],Ws=128,ve=70,No=80,Xs=.02,ko=54,Fo=100,qs=Math.ceil(ve/3*2),Ze=160,Ei=.5,xi=24,st=9,Bo=Ze+30,$a=Ze+53,jo=60,Wo=23,Xo=5*Math.PI/12,qo=1*Math.PI/3,La=10,Ia=.2,za=30,Ha=53,Ua=.2,Na=.3,Zo=200,Yo=3,Qo=1e6;class Nt{constructor(){this._available=!0}set location(e){this._forEachManipulator3D(i=>i.location=e)}set elevationAlignedLocation(e){this._forEachManipulator3D(i=>i.elevationAlignedLocation=e)}set elevationInfo(e){this._forEachManipulator3D(i=>i.elevationInfo=e)}get renderLocation(){let e;return this._forEachManipulator3D(i=>{e||(e=i.renderLocation)}),e}get available(){return this._available}set available(e){this._available=e,this._forEachManipulator3D(i=>i.available=e)}get grabbing(){return this.someManipulator(e=>e.grabbing)}get dragging(){return this.someManipulator(e=>e.dragging)}hasManipulator(e){return this.someManipulator(i=>i===e)}someManipulator(e){let i=!1;return this.forEachManipulator(a=>{!i&&e(a)&&(i=!0)}),i}_forEachManipulator3D(e){this.forEachManipulator((i,a)=>{i instanceof ne&&e(i,a)})}}function ci(t,e){return Zs(t,()=>e)}function Ko(t){return Zs(t,e=>e.plane)}function Zs(t,e){const i=y(),a=y();let s=!1;return n=>{const r=e(n);if(n.action==="start"){const c=Gi(n.screenStart,sa(Le.get())),d=Ci(t.state.camera,c,Fa);h(d)&&(s=ni(r,d,i))}if(!s)return null;const o=Gi(n.screenEnd,sa(Le.get())),l=Ci(t.state.camera,o,Fa);return _(l)?null:ni(r,l,a)?R(O({},n),{renderStart:i,renderEnd:a,plane:r,ray:l}):null}}function Jo(t,e,i,a=null,s=null){let n=null;return r=>{if(r.action==="start"&&(n=t.sceneIntersectionHelper.intersectElevationFromScreen(He(r.screenStart.x,r.screenStart.y),e,i,s),h(n)&&h(a)&&!na(n,n,a))||_(n))return null;const o=t.sceneIntersectionHelper.intersectElevationFromScreen(He(r.screenEnd.x,r.screenEnd.y),e,i,s);return h(o)?h(a)&&!na(o,o,a)?null:R(O({},r),{mapStart:n,mapEnd:o}):null}}function _i(t,e,i,a=null,s=null){return Jo(t,i,Ps(e,t,i),a,s)}function Ys(t,e,i,a=null,s=null){return _i(t,i,U(e),a,s)}function el(t,e,i,a){const s=e.toMap(t.screenStart,{include:[i]});return h(s)?Ys(e,i,s,a):null}function tl(t,e){const i=al,a=sl,s=It();t.renderCoordsHelper.worldUpAtPosition(e,i);const n=ge(s,i,V(a,e,t.state.camera.eye));return ge(n,n,i),di(e,n,s)}function Qs(t,e,i){let a=null;const s=new Fi;return s.next(ci(t,tl(t,e))).next(il(t,e)).next(Ks(t,i)).next(n=>{n.mapEnd.x=n.mapStart.x,n.mapEnd.y=n.mapStart.y,a=n}),n=>(a=null,s.execute(n),a)}function il(t,e){const i=y(),a=Ne(e);t.renderCoordsHelper.worldUpAtPosition(e,i);const s=y(),n=y(),r=o=>(V(o,o,e),qn(i,o,o),t.viewingMode==="global"&&Ne(o)*Math.sign(Gt(i,o))<.001-a&&V(o,fe(o,i,.001),e),ie(o,o,e),o);return o=>(o.renderStart=r(I(s,o.renderStart)),o.renderEnd=r(I(n,o.renderEnd)),o)}function Ks(t,e){const i=t.renderCoordsHelper;return a=>{const s=i.fromRenderCoords(a.renderStart,e),n=i.fromRenderCoords(a.renderEnd,e);return h(s)&&h(n)?R(O({},a),{mapStart:s,mapEnd:n}):null}}var ka;(function(t){t[t.GROUND=0]="GROUND",t[t.OTHER=1]="OTHER"})(ka||(ka={}));const al=y(),sl=y(),Fa=Ii();function fi(t,e,i,a){const s=t.graphic,n=(r,o)=>e({action:r,graphic:s,dxScreen:o.screenDeltaX,dyScreen:o.screenDeltaY});return i((r,o,l)=>{const c=o.next(d=>(d.action==="start"&&n("start",d),d)).next(Ur(s,a)).next(d=>{switch(d.action){case"start":case"update":(d.translationX||d.translationY||d.translationZ)&&n("update",d);break;case"end":n("end",d)}return d});return l.next(Nr(s)).next(()=>{n("end",{screenDeltaX:0,screenDeltaY:0})}),c})}function Js(t){if(_(t)||t.type!=="polyline"&&t.type!=="polygon")return 0;const e=(t.type==="polyline"?t.paths:t.rings)[0];if(!e||e.length<2)return 0;const i=e[0],a=e[1];return Math.atan2(a[1]-i[1],a[0]-i[0])}class nl extends Nt{constructor(e){super(),this._handles=new re,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=ve,this._updateAfterDrag=!1,this.events=new Me,this._tool=e.tool,this._view=e.view,e.radius!=null&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}set orthogonalAvailable(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._handles=F(this._handles),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){for(const{manipulator:i}of this._arrowManipulatorInfos)e(i,P.TRANSLATE_XY)}createGraphicDragPipeline(e,i,a){const s=i.graphic,n=U(s),r=D(s.geometry).spatialReference;return fi(i,a,o=>this.createDragPipeline((l,c,d,p,g)=>o(l,e(l,c,d,p,g),d),n,r,s),this._view.state.viewingMode)}createDragPipeline(e,i,a,s){return Z(this._arrowManipulatorInfos.map(({manipulator:n},r)=>ue(n,(o,l,c,d,p)=>{const g=l.next(f=>R(O({},f),{manipulatorType:P.TRANSLATE_XY})).next(At(this._view,o.elevationAlignedLocation)).next(_i(this._view,o.elevationAlignedLocation,i,a,s)).next(kr(o.location,this.angle+(r+1)*Math.PI*.5)).next(mt());e(o,g,c,d,p)})))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:i},a){const s=this._radius/ve,n=ko*s,r=n*Math.sqrt(3)/2,o=z.createExtrudedTriangle(r,n/2,n/2,Xs);z.transformInPlace(o,ra(J.get(),q(x.get(),0,-r/3,0))),e.renderObjects=[{geometry:o,material:this._opaqueMaterial,stateMask:E.Focused},{geometry:o,material:this._transparentMaterial,stateMask:E.Unfocused}],e.radius=r/3*2*1.2;const l=Zn(J.get(),a*Math.PI/2),c=ra(J.get(),q(x.get(),0,Fo*s,0));Yt(i,l,c)}_createManipulators(){for(let e=0;e<4;e++){const i=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(i)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,i=Rs(J.get(),e,B(0,0,1)),a=ri(J.get(),q(x.get(),this.displayScale,this.displayScale,this.displayScale)),s=Yt(J.get(),a,i);for(const n of this._arrowManipulatorInfos){const r=Yt(J.get(),s,n.transform);n.manipulator.modelTransform=r}}_createArrowManipulator(e){const i=new ne({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:B(0,0,1)}}),a={manipulator:i,transform:Lt()};return this._updateArrowManipulator(a,e),this._handles.add(i.events.on("drag",s=>{this._updateAfterDrag&&s.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),a}_createMaterial(e=1){const i=W.toUnitRGBA(M.main);return i[3]*=e,new Ui({color:i,transparent:e!==1,cullFace:Rt.Back,renderOccluded:$.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map(({manipulator:e})=>e)}}}class rl{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new Fi,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&h(this.lastDragEvent)){const i=this.lastDragEvent.mapEnd,a=this._snap(this.lastDragEvent.screenEnd);if(h(a)){const s={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:e===!0?a:i,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(s)}}this._enabled=e}_snap(e){const i=h(this.view)?this.view.toMap(e,{exclude:[]}):null;return h(i)&&h(this.view)&&(i.z=Ps(i,this.view,this.elevationInfo)),i}createDragEventPipelineStep(e,i){return this.view=e,this.elevationInfo=i,this.lastDragEvent=null,a=>{if(this.lastDragEvent=a.action!=="end"?O({},a):null,this._enabled){const s=this._snap(a.screenEnd);return h(s)?{action:a.action,mapStart:a.mapStart,mapEnd:s,screenStart:a.screenStart,screenEnd:a.screenEnd}:null}return{action:a.action,mapStart:a.mapStart,mapEnd:a.mapEnd,screenStart:a.screenStart,screenEnd:a.screenEnd}}}}class ol extends Nt{constructor(e){super(),this._handles=new re,this._snapToScene=new rl,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=ve,this._view=e.view,this._tool=e.tool,e.snapToScene!=null&&(this.snapToScene=e.snapToScene),e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,P.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,i,a){const s=i.graphic,n=U(s),r=D(s.geometry).spatialReference;return fi(i,a,o=>this.createDragPipeline((l,c,d,p,g)=>o(l,e(l,c,d,p,g),d),n,r,s),this._view.state.viewingMode)}createDragPipeline(e,i,a,s){const n=this._view;return ue(this._manipulator,(r,o,l,c,d)=>{const p=o.next(At(n,r.elevationAlignedLocation)).next(_i(n,r.elevationAlignedLocation,i,a,s)).next(this._snapToScene.createDragEventPipelineStep(n,i),this._snapToScene.next).next(g=>R(O({},g),{manipulatorType:P.TRANSLATE_XY})).next(mt());e(r,p,l,c,d)})}_updateManipulatorTransform(){const e=ri(J.get(),q(x.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new ne({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:B(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=z.createCylinderGeometry(Xs,1,Ws,B(0,0,1),B(0,0,0)),i=ri(Lt(),B(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:e,material:this._discMaterial,transform:i,stateMask:E.Focused},{geometry:e,material:this._discMaterialTransparent,transform:i,stateMask:E.Unfocused}],this._manipulator.radius=No*(this._radius/ve)}_createMaterial(e=1){const i=W.toUnitRGBA(M.main);return i[3]*=e,new Ui({color:i,transparent:e!==1,cullFace:Rt.Back,renderOccluded:$.Transparent})}get test(){return{discManipulator:this._manipulator}}}class ll extends Nt{constructor(e){super(),this._handles=new re,this._radius=ve,this.events=new Me,this._tool=e.tool,this._view=e.view,e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()})}forEachManipulator(e){e(this._manipulator,P.TRANSLATE_Z)}createGraphicDragPipeline(e,i,a){const s=D(i.graphic.geometry).spatialReference;return fi(i,a,n=>this.createDragPipeline((r,o,l,c,d)=>n(r,e(r,o,l,c,d),l),s),this._view.state.viewingMode)}createDragPipeline(e,i){const a=this._view;return ue(this._manipulator,(s,n,r,o,l)=>{const c=n.next(d=>R(O({},d),{manipulatorType:P.TRANSLATE_Z})).next(Qs(a,s.renderLocation,i)).next(mt());e(s,c,r,o,l)})}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}_updateManipulator(){const e=this._radius/ve,i=u.zManipulator.height*e,a=u.zManipulator.coneHeight*e,s=u.zManipulator.coneWidth*e,n=u.zManipulator.width*e,r=[B(0,0,0),B(0,0,i)],o=z.createTubeGeometry(r,n/2,16,!1),l=z.createConeGeometry(a,s/2,16,!1),c=[B(0,0,0),B(0,0,i+a)],d=w=>{const C=Lt();if(cs(C,C,[0,0,i]),Qn(C,C,Math.PI/2),w){const Y=1+2*w/s;Gs(C,C,[Y,Y,Y])}return C},p=d(0),g=(w,C)=>{const Y=wr(u.zManipulator.color,C);return[Y.r/255,Y.g/255,Y.b/255,u.zManipulator.color.a*w]},f=De(g(1,.25),$.Occlude),b=De(g(1,0),$.Occlude),A=De(g(.7,0),u.zManipulator.renderOccluded),G=De(g(.85,0),u.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:l,transform:p,material:f,stateMask:E.Unfocused},{geometry:o,material:f,stateMask:E.Unfocused},{geometry:l,transform:p,material:b,stateMask:E.Focused},{geometry:o,material:b,stateMask:E.Focused},{geometry:l,transform:p,material:A,stateMask:E.Unfocused},{geometry:o,material:A,stateMask:E.Unfocused},{geometry:l,transform:p,material:G,stateMask:E.Focused},{geometry:o,material:G,stateMask:E.Focused}],this._manipulator.radius=n/2+2,this._manipulator.collisionType={type:"line",paths:[c]}}_createManipulator(){const e=new ne({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=i=>{const a=this._view.state.camera,s=Ba;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,s);const n=Yn(a.eye,s),r=a.computeRenderPixelSizeAtDist(n),o=V(nt,s,a.eye);Ie(o,o);const l=hl;this._view.renderCoordsHelper.worldUpAtPosition(Ba,l);const c=Math.abs(Gt(o,l)),d=ge(nt,o,l),p=ge(nt,d,l),g=ai(c,.01,1),f=1-Math.sqrt(1-g*g)/g/a.fullWidth,b=this._radius/ve,A=u.zManipulator.width*b;fe(p,Ie(p,p),(1/f-1)*n+r*A),i[12]-=nt[0],i[13]-=nt[1],i[14]-=nt[2]},this._manipulator=e,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}const Ba=y(),nt=y(),hl=y();class Ke extends Nt{constructor(e){super(),this._handles=new re,this._angleDeferred=null,this._interactive=!0;const{tool:i,view:a,snapToScene:s,radius:n}=e;this._view=a,this.xyManipulation=new ol({tool:i,view:a,snapToScene:s,radius:n}),this.xyAxisManipulation=new nl({tool:i,view:a,radius:n}),this.zManipulation=new ll({tool:i,view:a,radius:n}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(r=>{this._handles.add(r.events.on("grab-changed",()=>this._updateManipulatorInteractivity()))})}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(e,i,a){return Z([this.xyManipulation.createGraphicDragPipeline((s,n,r,o,l)=>e(ce.XY,s,n,r,o,l),i,a),this.xyAxisManipulation.createGraphicDragPipeline((s,n,r,o,l)=>e(ce.XY_AXIS,s,n,r,o,l),i,a),this.zManipulation.createGraphicDragPipeline((s,n,r,o,l)=>e(ce.Z,s,n,r,o,l),i,a)])}createDragPipeline(e,i,a,s){return Z([this.xyManipulation.createDragPipeline((n,r,o,l,c)=>e(ce.XY,n,r,o,l,c),i,a,s),this.xyAxisManipulation.createDragPipeline((n,r,o,l,c)=>e(ce.XY_AXIS,n,r,o,l,c),i,a,s),this.zManipulation.createDragPipeline((n,r,o,l,c)=>e(ce.Z,n,r,o,l,c),a)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this._angleDeferred=null,this.xyAxisManipulation.angle=e}set angleDeferred(e){this.xyAxisVisible?this.angle=e():this._angleDeferred=e}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator(i=>e(i,P.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(i=>e(i,P.TRANSLATE_XY)),this.zManipulation.forEachManipulator(i=>e(i,P.TRANSLATE_Z))}get xyAxisVisible(){const e=this.xyManipulation.someManipulator(i=>i.focused)||this.xyAxisManipulation.someManipulator(i=>i.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||e}_autoHideXYAxis(){const e=this.xyAxisManipulation,i=this.xyManipulation;if(Kn("esri-mobile"))return;const a=[];i.forEachManipulator(n=>a.push(n)),e.forEachManipulator(n=>a.push(n));const s=()=>{const n=[];this.xyAxisVisible?h(this._angleDeferred)&&(this.angle=this._angleDeferred()):e.forEachManipulator(r=>n.push(r.disableDisplay())),this._handles.remove(ja),this._handles.add(n,ja)};for(const n of a)this._handles.add(n.events.on("focus-changed",s));this._view.inputManager&&this._handles.add(this._view.inputManager.watch("latestPointerType",s)),s()}_updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator(i=>{i.interactive=!e&&this._interactive||i.grabbing})}static radiusForSymbol(e){const i=h(e)&&e.type==="point-3d"&&e.symbolLayers;return!!i&&i.length>0&&i.some(a=>a.type==="icon")?qs:ve}}const ja="disable-xy-axis-display";var ce;(function(t){t[t.XY=0]="XY",t[t.XY_AXIS=1]="XY_AXIS",t[t.Z=2]="Z"})(ce||(ce={}));class Xi extends Nt{constructor(e){super(),this._handles=new re,this._view=e.view,this._tool=e.tool,this._graphicState=e.graphicState,this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(e){e(this._manipulator,P.TRANSLATE_XY)}createGraphicDragPipeline(e){return fi(this._graphicState,e,i=>this.createDragPipeline(i),this._view.state.viewingMode)}createDragPipeline(e){const i=this._view,a=this._graphicState.graphic,s=h(a.geometry)?a.geometry.spatialReference:null;return ue(this._manipulator,(n,r,o,l,c)=>{const d=r.next(el(c,i,a,s)).next(ct()).next(mt());e(n,d,o,l,c)})}_createManipulator(){const e=this._view,i=this._graphicState.graphic;this._manipulator=new jr({graphic:i,view:e,selectable:!0,cursor:"move"})}}class cl{constructor(e){this.allGraphics=e,this.type="graphic-move-start"}}class dl{constructor(e,i,a){this.dx=e,this.dy=i,this.allGraphics=a,this.type="graphic-move"}}class Wa{constructor(e){this.allGraphics=e,this.type="graphic-move-stop"}}let we=class extends Cs(Me.EventedMixin(pi)){constructor(t){super(t),this.graphics=new Jn,this.enableZ=!0,this.type="move-3d",this._toolHandles=new re,this.snappingPipeline=new li}initialize(){this._toolHandles.add([this.graphics.on("change",()=>this._refreshManipulators())]),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const t=this.graphics.toArray().filter(e=>er(e)===Ts.SUPPORTED).map(e=>new pl(e));t.length&&(this._createManipulators(t),this._createVisualElements(t),this.handles.add(t.map(e=>this.view.trackGraphicState(e.state))),this._updateMoveManipulation(t))}_createManipulators(t){for(const e of t){const i=e.state;e.manipulationXY=new Xi({tool:this,view:this.view,graphicState:i}),e.manipulationXY.forEachManipulator(a=>this.handles.add(a.events.on("immediate-click",s=>{this.emit("immediate-click",R(O({},s),{graphic:i.graphic})),s.stopPropagation()}))),this.handles.add(e.manipulationXY.createDragPipeline((a,s,n,r)=>this._buildDragEventPipeline(t,ce.XY,a,s,n,r)))}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new Ke({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:t.length===1?Ke.radiusForSymbol(t[0].graphic.symbol):ve});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator(s=>{this.handles.add(s.events.on("immediate-click",n=>{e.zManipulation.hasManipulator(s)||this.graphics.length!==1||this.emit("immediate-click",R(O({},n),{graphic:this.graphics.getItemAt(0)})),n.stopPropagation()}))});const i=()=>this._updateMoveManipulation(t);for(const s of t)this.handles.add([s.state.on("changed",i),s.state.watch("displaying",i)]);const a=t[t.length-1];this.handles.add(a.state.on("changed",()=>this._updateMoveManipulationAngle(a))),this.handles.add(e.createDragPipeline((s,n,r,o,l)=>this._buildDragEventPipeline(t,s,n,r,o,l),U(a.graphic),D(a.graphic.geometry).spatialReference,a.graphic)),this._updateMoveManipulationAngle(a)}_createVisualElements(t){for(const e of t){const i=e.graphic,a=mi({view:this.view,graphic:i,forEachManipulator:s=>{e.manipulationXY.forEachManipulator(s),this._moveManipulation.forEachManipulator(s)},onManipulatorsChanged:()=>pt()});_(a)||(e.geometryRepresentation=a.visualElement,e.geometryRepresentation instanceof et&&this.handles.add([e.geometryRepresentation.events.on("attachment-origin-changed",()=>{e.state.isDraped||this._updateMoveManipulation(t)}),e.state.watch("isDraped",()=>this._updateMoveManipulation(t))]),this.handles.add(a))}}_updateMoveManipulationAngle(t){this._moveManipulation.angleDeferred=()=>Js(t.graphic.geometry)}_updateMoveManipulation(t){const e=Ht(0,0,0,this.view.spatialReference);let i=0,a=!1;const s=this._moveManipulation;for(const n of t){if(!n.state.displaying)continue;const r=n.state.graphic;this.enableZ&&Qe(r)&&(a=!0);const o=n.geometryRepresentation instanceof et&&!n.state.isDraped?n.geometryRepresentation.attachmentOrigin:Ti(this.view,r);h(o)&&(e.x+=o.x,e.y+=o.y,e.z+=o.z,i++)}i>0?(e.x/=i,e.y/=i,e.z/=i,s.location=e,s.xyManipulation.available=!0,s.xyAxisManipulation.available=!0,s.zManipulation.available=a):s.available=!1}_buildDragEventPipeline(t,e,i,a,s,n){const r=[],o=[];let l=null,c=null;const d=()=>{for(const g of r)g.dragging=!1;r.length=0,o.length=0,l=null,c=null,this._moveManipulation.interactive=!0};if(t.length===1&&e===ce.XY){const g=t[0].graphic;a=this._buildSnappingPipelineSteps(g,U(g),a,s,n)}const p=a.next(g=>{if(g.action==="start"){r.length=0,o.length=0;for(const f of t)f.dragging||!f.manipulationXY.hasManipulator(i)&&f.manipulationXY.grabbing||(r.push(f),o.push(f.graphic),f.dragging=!0);if(o.length!==0&&(this._moveManipulation.interactive=!1,l=Fr(o,this.view.state.viewingMode),c=Br(o),this.emit("graphic-move-start",new cl(o)),this.destroyed))return null}return o.length!==0?g:null}).next(g=>l(g)).next(g=>{switch(g.action){case"start":case"update":if(g.translationX||g.translationY||g.translationZ){const f=this.view.toScreen(g.mapStart),b=this.view.toScreen(g.mapEnd),A=b.x-f.x,G=b.y-f.y;if(this.emit("graphic-move",new dl(A,G,o)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new Wa(o)),this.destroyed)return null;d()}});return s.next(g=>c(g)).next(()=>{if(this.emit("graphic-move-stop",new Wa(o)),this.destroyed)return null;d()}),p}_buildSnappingPipelineSteps(t,e,i,a,s){const n=t.geometry;if(_(n)||n.type!=="point"&&n.type!=="mesh")return i;const r=(n.type==="point"?n:n.anchor).clone(),o=new oi({elevationInfo:e,pointer:s,editGeometryOperations:ui.fromGeometry(r,this.view.state.viewingMode),visualizer:new Vt,excludeFeature:t}),l=this.snappingManager;return i.next(c=>(r.z=tr(this.view,r,U(t),{mode:"absolute-height",offset:0}),R(O({},c),{snapOrigin:o.coordinateHelper.pointToVector(r)}))).next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:o,snappingManager:l,cancel:a,updatingHandles:this.updatingHandles}),this.snappingPipeline.next)}};m([v({constructOnly:!0,nonNullable:!0})],we.prototype,"view",void 0),m([v({readOnly:!0})],we.prototype,"graphics",void 0),m([v({constructOnly:!0,nonNullable:!0})],we.prototype,"enableZ",void 0),m([v({constructOnly:!0})],we.prototype,"snappingManager",void 0),m([v({readOnly:!0})],we.prototype,"type",void 0),m([v({readOnly:!0})],we.prototype,"updating",null),we=m([ye("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],we);class pl{constructor(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new ee({graphic:e})}get graphic(){return this.state.graphic}}function Xa(t,e,i){const a=i.mode==="on-the-ground"?ya.XY:ya.XYZ;return new Wr(t,a,e,0)}function qa(t,e,i){const a=y();if(!t.renderCoordsHelper.toRenderCoords(e,a))return null;const s=Za(t,e,Ut(i.plane)),n=Za(t,e,i.edgeDirection);if(_(s)||_(n))return null;const r=ge(y(),s,n);return di(a,r,It())}function Za(t,e,i){const a=Ht(e.x+i[0],e.y+i[1],e.z+i[2],e.spatialReference),s=y(),n=y();return t.renderCoordsHelper.toRenderCoords(e,s)&&t.renderCoordsHelper.toRenderCoords(a,n)?Vs(n,s,n):null}function ul(t,e,i){const a=Ut(t),s=Vs(y(),e,i),n=ge(y(),s,a),r=ge(y(),s,n);return ir(s[0],s[1],s[2],0,n[0],n[1],n[2],0,r[0],r[1],r[2],0,0,0,0,1)}function gl(t,e,i){const a=i.projectToRenderScreen(t,oa()),s=i.projectToRenderScreen(e,oa());return h(a)&&h(s)?ar(V(a,a,s)):0}let qe=class extends Me.EventedMixin(Ni){constructor(t){super(t),this._vertexManipulatorMaterial=De(u.colorToVec4(u.reshapeManipulators.vertex.color),u.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=Mt(u.colorToVec4(u.reshapeManipulators.vertex.outlineColor),u.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=Mt(u.colorToVec4(u.reshapeManipulators.vertex.hoverOutlineColor),u.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=De(u.colorToVec4(u.reshapeManipulators.edge.color),u.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=Mt(u.colorToVec4(u.reshapeManipulators.edge.outlineColor),u.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=De(u.colorToVec4(u.reshapeManipulators.edgeOffset.color),u.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=De(u.colorToVec4(u.reshapeManipulators.edgeOffset.hoverColor),u.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=De(u.colorToVec4(u.reshapeManipulators.selected.color),u.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=Mt(u.colorToVec4(u.reshapeManipulators.selected.outlineColor),u.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=Mt(u.colorToVec4(u.reshapeManipulators.selected.hoverOutlineColor),u.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new re,this._manipulatorInfos=[],this._editGeometryOperations=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=T.NONE,this._outlineVisualElement=null,this.tool=null,this.outputGeometry=null,this._snappingPipeline=new li,this._snappingPipelineHandle=new li,this._vertexLaserLineVisualElement=null}initialize(){const t=new ee({graphic:this.graphic});this._graphicState=t,this.handles.add([t.watch("displaying",e=>{for(const i of this._manipulatorInfos)i.manipulator.available=e}),this.view.trackGraphicState(t)])}destroy(){this._editGeometryOperations=F(this._editGeometryOperations),this._moveManipulation=F(this._moveManipulation),this._graphicMoveManipulation=F(this._graphicMoveManipulation),this._manipulatorHandles=F(this._manipulatorHandles),this.manipulators.removeAll(),this._manipulatorInfos=[],this._resetGrabbingDragging()}get inputGeometry(){return h(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(t){this._recreateEditGeometryAndManipulators(t)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}removeSelectedVertices(){const t=this._manipulatorInfos.filter(e=>e.manipulator.selected&&e.handle.type==="vertex");this._removeVertices(t)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._moveManipulation=F(this._moveManipulation),this._graphicMoveManipulation=F(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[]}_resetGrabbingDragging(){this._numGrabbing=0,this._numDragging=0}_createManipulators(){if(_(this._editGeometryOperations))return;const t=U(this.graphic);for(const e of this._editGeometryOperations.data.components){for(const i of e.vertices)this._createVertexOrEdgeManipulator(i,t);for(const i of e.edges)this._createVertexOrEdgeManipulator(i,t)}this._createGraphicMoveManipulators(t)}get canRedo(){return h(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return h(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if(_(this._editGeometryOperations))return null;const t=this._editGeometryOperations.redo();return h(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}undo(){if(_(this._editGeometryOperations))return null;this.emit("undo");const t=this._editGeometryOperations.undo();return h(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}_recreateManipulators(){this._removeManipulators(),this._resetGrabbingDragging(),this._createManipulators()}_recreateEditGeometryAndManipulators(t=this.inputGeometry){this._removeManipulators(),this._resetGrabbingDragging(),_(t)||(F(this._editGeometryOperations),this._editGeometryOperations=ui.fromGeometry(t,this.view.state.viewingMode),this._createManipulators())}_perGraphicManipulatorDragAction(t,e){if(e.action==="end")return;let i=0;const a=[],s=this._manipulatorInfos.some(r=>r.handle.type==="vertex"&&r.manipulator.selected),n=t===dt.SELECTED_OR_ALL&&s;for(const r of this._manipulatorInfos)wt(r)&&(r.manipulator.grabbing||n&&!r.manipulator.selected||a.push(r),i++);if(a.length!==0)if(this._moveVertices(a,e),a.length===i){if(this._updateEventState(T.MOVING),this.destroyed)return;this.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(T.RESHAPING),this.destroyed)return;this.emit("reshape",{type:"reshape",mover:this.graphic})}}_isMultiVertexSelection(){let t=0;for(const e of this._manipulatorInfos)wt(e)&&e.manipulator.selected&&t++;return t>1}_perVertexManipulatorDragAction(t){if(this._updateEventState(T.RESHAPING),this.destroyed)return;const{mapDeltaX:e,mapDeltaY:i,mapDeltaZ:a}=t;if(!e&&!i&&!a)return;const s=[];for(const n of this._manipulatorInfos)wt(n)&&(n.manipulator.selected&&!n.manipulator.grabbing||n===t.info)&&s.push(n);this._moveVertices(s,t,Se.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(t){if(t===this._reshapeEventState)return!1;switch(t){case T.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case T.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case T.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case T.MOVING:switch(this._reshapeEventState){case T.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case T.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case T.RESHAPING:switch(this._reshapeEventState){case T.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case T.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const e=this._reshapeEventState!==t;return this._reshapeEventState=t,e}_createGraphicMoveManipulators(t){if(this._graphicMoveManipulation=new Xi({tool:this.tool,view:this.view,graphicState:this._graphicState}),this.enableMoveGraphic){let a=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((s,n,r)=>{n.next(o=>this._trackNumDragging(o)).next(o=>(o.action==="start"&&(a=D(this._editGeometryOperations).createUndoGroup()),o)).next(o=>{this._perGraphicManipulatorDragAction(dt.ALL,o),o.action==="end"&&(a=Fe(a))}),r.next(this._cancelDragOperation(()=>a=Fe(a)))}))}else this._graphicMoveManipulation.forEachManipulator(a=>{a.grabbable=!1,a.cursor=null});this._graphicMoveManipulation.forEachManipulator(a=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(a,!1),a.events.on("immediate-click",s=>{this._manipulatorInfos.some(n=>n.manipulator.selected)?this._clearSelection():this.emit("immediate-click",R(O({},s),{graphic:this.graphic})),s.stopPropagation()})])),this._moveManipulation=new Ke({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&Qe(this.graphic),snapToScene:!1,radius:Ke.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator(a=>{this.handles.add([this._watchAndUpdateGrabState(a,!1),a.events.on("immediate-click",s=>{this._moveManipulation.zManipulation.hasManipulator(a)||this._manipulatorInfos.some(n=>n.manipulator.selected)||this.emit("immediate-click",R(O({},s),{graphic:this.graphic})),s.stopPropagation()})])}),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const e=D(this.graphic.geometry).spatialReference;this.handles.add([this._moveManipulation.createDragPipeline((a,s,n,r,o)=>{const l=n.next(c=>this._trackNumDragging(c)).next(c=>{const d=this._manipulatorInfos.filter(p=>wt(p)&&p.manipulator.selected);return c.manipulatorType===P.TRANSLATE_XY&&d.length===1?R(O({},c),{info:d[0],snapOrigin:d[0].handle.pos}):R(O({},c),{info:null})}).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:c=>!!c.info,cancel:r,snappingManager:this.tool.snappingManager,snappingContext:new oi({editGeometryOperations:D(this._editGeometryOperations),elevationInfo:t,pointer:o,excludeFeature:this.graphic,visualizer:new Vt}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next(ct()).next(c=>(this._perGraphicManipulatorDragAction(dt.SELECTED_OR_ALL,c),c));return r.next(this._cancelDragOperation()),l},t,e,this.graphic),Ue(this._graphicState,"displaying",()=>{this._updateMoveManipulationPosition()}),this._graphicState.on("changed",()=>this._updateMoveManipulationPosition()),Ue(this._graphicState,"isDraped",()=>{const a="align-move-manipulation";this._graphicState.isDraped?this.handles.add(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),a):this.handles.remove(a)})]),this._updateMoveManipulationPosition();const i=mi({view:this.view,graphic:this.graphic,forEachManipulator:a=>{if(!this.destroyed){h(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(a);for(const s of this._manipulatorInfos)a(s.manipulator,P.TRANSLATE_XY);this._moveManipulation.forEachManipulator(a)}},onManipulatorsChanged:a=>this.on("manipulators-changed",a)});h(i)&&(this._outlineVisualElement=i.visualElement instanceof et?i.visualElement:null),h(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()}),this._graphicState.watch("isDraped",()=>this._updateMoveManipulationPosition())]),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(t,e=U(this.graphic)){const i=u.reshapeManipulators.edgeOffset,a=i.size/2,s=a+i.collisionPadding;if(_(this._edgeOffsetManipulatorGeometryInside)||_(this._edgeOffsetManipulatorGeometryOutside)){const g=a/s,f=g*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=z.createExtrudedTriangle(f,g/2,g/2,i.height,i.offset),this._edgeOffsetManipulatorGeometryOutside=z.createExtrudedTriangle(-f,g/2,g/2,i.height,-i.offset)}const n=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:E.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:E.Focused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:E.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:E.Focused}],r=new ne({view:this.view,renderObjects:n,elevationInfo:e.mode!=="on-the-ground"||la(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:s,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:B(0,0,1)},collisionPriority:1}),o=new ne({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default"}),l={manipulator:r,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:o,elevationInfo:e,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(l,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(l);const c=this._getManipulatorInfoFromHandle(l.handle.leftVertex).manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l)),d=this._getManipulatorInfoFromHandle(l.handle.rightVertex).manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l));l.locationUpdateHandle=Z([c,d]),this._manipulatorHandles.add(l.locationUpdateHandle,r),this._manipulatorHandles.add([this._watchAndUpdateGrabState(r,!0),this._watchAndUpdateGrabState(o,!0)],r),this._manipulatorHandles.add(ue(r,this._createEdgeOffsetPipeline(l,e)),r),this._manipulatorHandles.add(ue(o,(g,f,b,A)=>{if(A==="touch")this._createEdgeOffsetPipeline(l,e)(g,f,b);else if(this.enableMoveGraphic){const G=this.graphic,w=h(G.geometry)?G.geometry.spatialReference:null;f.next(C=>this._trackNumDragging(C)).next(At(this.view,g.elevationAlignedLocation)).next(_i(this.view,g.elevationAlignedLocation,e,w,G)).next(mt()).next(ct()).next(C=>this._perGraphicManipulatorDragAction(dt.ALL,C)),b.next(this._cancelDragOperation())}}),r);const p=g=>{this._manipulatorInfos.some(f=>f.manipulator.selected)?this._clearSelection():this.emit("immediate-click",R(O({},g),{graphic:this.graphic})),g.stopPropagation()};return this._manipulatorHandles.add([r.events.on("immediate-click",p),o.events.on("immediate-click",p)],r),this._manipulatorInfos.push(l),this.manipulators.add(r),this.manipulators.add(o),this.emit("manipulators-changed"),l}_autoHideEdgeOffsetManipulator(t,e){const i=t.manipulator,a=t.edgeManipulator,s=()=>{Fe(t.visibilityHandle);const n=gl(this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator.renderLocation,this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator.renderLocation,this.view.state.camera)<e;(!i.focused&&!a.focused||n)&&(i.grabbable=!n,a.grabbable=!n,t.visibilityHandle=Z([i.disableDisplay(),{remove:()=>{i.grabbable=!0,a.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([i.events.on("focus-changed",s),a.events.on("focus-changed",s),{remove:()=>{Fe(t.visibilityHandle),this.manipulators.remove(a)}}],i),s()}_updateEdgeOffsetManipulator(t){this._updateManipulatorPosition(t);const e=D(this._editGeometryOperations).data.coordinateHelper,i=qa(this.view,t.manipulator.elevationAlignedLocation,Xa(e,t.handle,D(t.manipulator.elevationInfo))),a=this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator.renderLocation,s=this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator.renderLocation,n=h(i)?ul(i,a,s):sr;t.manipulator.modelTransform=n,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=n;const r=Ne(V(Xt,a,s))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-r,0,0],[r,0,0]]]}}_createEdgeOffsetPipeline(t,e){return(i,a,s)=>{this._clearSelection();const{step:n,cleanup:r}=this._initializeEdgeOffset(t,e);a.next(o=>this._trackNumDragging(o)).next(At(this.view,i.elevationAlignedLocation)).next(n).next(Ko(this.view)).next(Ks(this.view,D(this._editGeometryOperations).data.spatialReference)).next(ct()).next(this._applyEdgeOffsetStep(t)).next(o=>{o.action==="end"&&r()}),s.next(o=>(r(),o)).next(this._cancelDragOperation())}}_initializeEdgeOffset(t,e){const i=D(this._editGeometryOperations),a=Xa(i.data.coordinateHelper,t.handle,e),s=i.createUndoGroup(),n=qa(this.view,t.manipulator.elevationAlignedLocation,a);a.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge),1),a.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge),0);const r=()=>new nr({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:D(this._editGeometryOperations).data.spatialReference}),o=new et({view:this.view,isDraped:this._graphicState.isDraped,geometry:r(),elevationInfo:t.elevationInfo,width:u.visualElements.lineGraphics.outline.width,color:u.colorToVec4(M.main),attached:!0});let l;const c=()=>{this._cleanEdgeOffsetCollapsedEdges(t),l=Fe(l)},d=this.on("undo",c);return l=Z([te(o),this._graphicState.watch("isDraped",p=>o.isDraped=p),this._graphicState.on("changed",()=>o.geometry=r()),s,d]),{step:p=>_(a)||_(n)?(c(),null):R(O({},p),{operation:a,plane:n}),cleanup:c}}_applyEdgeOffsetStep(t){return e=>{if(this.destroyed||_(e.operation))return e;this._updateEventState(T.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:s}=e;return(i||a||s)&&(this._offsetEdge(t,e),this.emit("reshape",{type:"reshape",mover:this.graphic})),e}}_cleanEdgeOffsetCollapsedEdges(t){var e,i;const a=(e=t.handle.leftVertex.leftEdge)==null?void 0:e.leftVertex,s=t.handle.leftVertex,n=(i=t.handle.rightVertex.rightEdge)==null?void 0:i.rightVertex,r=t.handle.rightVertex,o=D(this._editGeometryOperations).data.coordinateHelper,l=1e-6,c=[];a&&o.distance(a.pos,s.pos)<l&&c.push(this._getManipulatorInfoFromHandle(s)),(o.distance(s.pos,r.pos)<l||n&&o.distance(n.pos,r.pos)<l)&&c.push(this._getManipulatorInfoFromHandle(r)),c.length&&this._removeVertices(c)}_computeVertexManipulatorSizeAndOutline(t){const e=t.size/2,i=e+t.collisionPadding;return{size:e/i,outlineSize:(e+t.outlineSize)/i}}_createVertexOrEdgeManipulator(t,e=U(this.graphic)){if(t.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(_(this._vertexManipulatorGeometry)||_(this._vertexManipulatorOutlineGeometry)){const{size:r,outlineSize:o}=this._computeVertexManipulatorSizeAndOutline(u.reshapeManipulators.vertex);this._vertexManipulatorGeometry=z.createSphereGeometry(r,16,16),this._vertexManipulatorOutlineGeometry=z.createSphereGeometry(o,16,16)}if(_(this._edgeManipulatorGeometry)||_(this._edgeManipulatorOutlineGeometry)){const{size:r,outlineSize:o}=this._computeVertexManipulatorSizeAndOutline(u.reshapeManipulators.edge);this._edgeManipulatorGeometry=z.createSphereGeometry(r,16,16),this._edgeManipulatorOutlineGeometry=z.createSphereGeometry(o,16,16)}const i=h(this.graphic.geometry)&&this.graphic.geometry.type==="point"?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:le.Vertex|E.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:le.Vertex|E.Unfocused|E.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:le.Vertex|E.Focused|E.Unselected},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:E.Selected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:E.Selected|E.Unfocused},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:E.Selected|E.Focused}];this.enableMidpoints&&i.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:le.Edge|E.Focused|E.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:le.Edge|E.Focused|E.Unselected},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:le.Edge|E.Unfocused|E.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:le.Edge|E.Unfocused|E.Unselected});const a=new ne({view:this.view,renderObjects:i,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(a,t,e);const s=t.type==="edge"?{manipulator:a,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(s),this.manipulators.add(a),this._updateManipulatorPosition(s),s.type==="edge"){const r=this._getManipulatorInfoFromHandle(s.handle.leftVertex).manipulator.events.on("location-update",()=>this._updateManipulatorPosition(s)),o=this._getManipulatorInfoFromHandle(s.handle.rightVertex).manipulator.events.on("location-update",()=>this._updateManipulatorPosition(s));s.locationUpdateHandle=Z([r,o]),this._manipulatorHandles.add(s.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const n=ue(a,(r,o,l,c)=>{let d=null;o.next(p=>this._trackNumDragging(p)).next(p=>{if(p.action==="start"&&(d=D(this._editGeometryOperations).createUndoGroup()),Qa(s)){const g=this._splitEdgeManipulator(s);return R(O({},p),{info:g,snapOrigin:g.handle.pos})}return R(O({},p),{info:s,snapOrigin:s.handle.pos})}).next(At(this.view,r.elevationAlignedLocation)).next(Ys(this.view,this.graphic,r.elevationAlignedLocation,r.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:l,snappingManager:this.tool.snappingManager,snappingContext:new oi({editGeometryOperations:D(this._editGeometryOperations),elevationInfo:e,pointer:c,excludeFeature:this.graphic,visualizer:new Vt}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(ct()).next(p=>{this._perVertexManipulatorDragAction(p),p.action==="end"&&(d=Fe(d))}),l.next(this._cancelDragOperation(()=>d=Fe(d)))});return this._manipulatorHandles.add(n,a),this._manipulatorHandles.add([a.events.on("immediate-click",r=>this._manipulatorClickCallback(r,s)),a.events.on("select-changed",()=>{s.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()})],a),this.emit("manipulators-changed"),s}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_cancelDragOperation(t){return()=>{switch(this._numDragging--,this.undo(),this.outputGeometry=h(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null,h(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._reshapeEventState){case T.NONE:break;case T.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case T.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}t&&t(),this.destroyed||this._updateEventState(T.NONE)}}_setTypeSpecificManipulatorSettings(t,e,i){switch(e.type){case"vertex":t.state=le.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2,t.radius=u.reshapeManipulators.vertex.size/2+u.reshapeManipulators.vertex.collisionPadding,t.elevationInfo=i,t.interactive=h(this.graphic.geometry)&&this.graphic.geometry.type!=="point";break;case"edge":t.state=le.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1,t.radius=u.reshapeManipulators.edge.size/2+u.reshapeManipulators.edge.collisionPadding,t.elevationInfo=i.mode!=="on-the-ground"||la(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(t,e){return t.events.on("grab-changed",i=>{if(i.action==="start")e&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(T.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(i.pointerType!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(a=>{a.manipulator.interactive=!this._numGrabbing&&h(this.graphic.geometry)&&this.graphic.geometry.type!=="point","edgeManipulator"in a&&(a.edgeManipulator.interactive=!this._numGrabbing)}),D(this._graphicMoveManipulation).forEachManipulator(a=>a.interactive=!this._numGrabbing))})}_clearSelection(){for(const t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1)}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(t){t&&(this._manipulatorHandles.remove(t.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(t),1),this.manipulators.remove(t.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(t){if(t){for(const e of this._manipulatorInfos)if(t===e.handle)return e}return null}_updateManipulatorPosition(t){if(!t)return;const e=D(this._editGeometryOperations);if(t.handle.type==="vertex")t.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,Et),t.manipulator.grabbing&&h(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if(t.handle.type==="edge"){const i=this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator,a=this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator;if(h(t.manipulator.elevationInfo)&&t.manipulator.elevationInfo.mode==="on-the-ground"){const s=i.location,n=a.location,r=.5,o=s.x+r*(n.x-s.x),l=s.y+r*(n.y-s.y),c=s.hasZ&&n.hasZ?0:void 0;t.manipulator.location=Ht(o,l,c,e.data.spatialReference)}else $e(Xt,i.renderLocation,a.renderLocation,.5),t.manipulator.renderLocation=Xt}}_splitEdgeManipulator(t,e=.5){const i=D(this._editGeometryOperations),a=D(i.splitEdge(t.handle,e).createdVertex);t.locationUpdateHandle.remove(),t.locationUpdateHandle=void 0;const s=U(this.graphic);let n;this.enableEdgeOffset?(this._removeManipulator(t),n=this._createVertexOrEdgeManipulator(a)):(n=t,n.handle=a,n.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,s)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(n),this._updateSelection(t.manipulator);const r=this._updateEventState(T.RESHAPING),o=i.data.coordinateHelper.vectorToArray(n.handle.pos),l=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:o,componentIndex:l,vertexIndex:D(a.index)}],added:o}),r&&this._updateEventState(T.NONE),n}_updateMoveManipulationPosition(){const t=q(Xt,0,0,0);let e=0,i=!1,a=null,s=null;for(const n of this._manipulatorInfos)wt(n)&&(n.manipulator.selected?(e++,ie(t,t,n.manipulator.renderLocation),_(a)||n.selectedIndex>a.selectedIndex?(s=a,a=n):(_(s)||n.selectedIndex>s.selectedIndex)&&(s=n)):i=!0);if(e!==0){const n=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=n,this._moveManipulation.xyAxisManipulation.available=n,this._moveManipulation.zManipulation.available=n&&this.enableZVertex&&Qe(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=n&&e!==1}else{const n=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=n,this._moveManipulation.xyAxisManipulation.available=n,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=n,this._moveManipulation.zManipulation.available=n&&this.enableZShape&&Qe(this.graphic)}if(e!==0){let n=0;if(h(a)){const r=a.handle.pos,o=h(s)?s.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,l=!h(s)&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;o&&l?this._moveManipulation.xyAxisManipulation.available=!1:o?n=Ya(o,r):l&&(n=Ya(r,l))}this._moveManipulation.angle=n,this._moveManipulation.radius=qs}else this._moveManipulation.angleDeferred=()=>Js(D(this.graphic.geometry)),this._moveManipulation.radius=Ke.radiusForSymbol(this.graphic.symbol);e!==0&&i?(fe(t,t,1/e),Et.spatialReference=D(this._editGeometryOperations).data.spatialReference,Et.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,Et),this._moveManipulation.elevationAlignedLocation=Et):h(this._outlineVisualElement)&&!this._graphicState.isDraped&&h(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:Hs(this.view,this._moveManipulation,this.graphic)}_removeVertices(t){const e=[],i=D(this._editGeometryOperations);for(const a of t)if(a.handle.type==="vertex"&&i.canRemoveVertex()){e.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const s=D(i.removeVertices([a.handle]).removedVertices[0].createdEdge);s&&this._createVertexOrEdgeManipulator(s)}if(e.length>0){const a=e.map(n=>{const r=i.data.components.indexOf(n.component);return{coordinates:i.data.coordinateHelper.vectorToArray(n.pos),componentIndex:r,vertexIndex:D(n.index)}});this.outputGeometry=i.data.geometry;const s=this._updateEventState(T.RESHAPING);if(this.destroyed||(this.emit("vertex-remove",{type:"vertex-remove",removed:a.map(n=>n.coordinates),vertices:a}),this.destroyed)||s&&(this._updateEventState(T.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(t,e,i=e.action==="start"?Se.NEW_STEP:Se.ACCUMULATE_STEPS){const a=D(this._editGeometryOperations);a.moveVertices(t.map(s=>s.handle),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const s of t)this._updateManipulatorPosition(s)}_offsetEdge(t,e){if(_(e.operation))return;const i=D(this._editGeometryOperations),a=e.operation.clone();a.distance=e.operation.signedDistanceToPoint(e.mapEnd),i.updateVertices([t.handle.leftVertex,t.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,e){t.shiftKey||this._clearSelection(),e.handle.type==="vertex"&&(e.manipulator.selected=!e.manipulator.selected),e.handle.type==="vertex"&&t.button===ha.Right&&this._removeVertices([e]),Qa(e)&&t.button===ha.Left&&this._splitEdgeManipulator(e),t.stopPropagation()}};function Ya(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI/2}function wt(t){return t.handle.type==="vertex"}function Qa(t){return t.handle.type==="edge"}m([v({constructOnly:!0})],qe.prototype,"tool",void 0),m([v()],qe.prototype,"inputGeometry",null),m([v()],qe.prototype,"outputGeometry",void 0),m([v({readOnly:!0})],qe.prototype,"updating",null),qe=m([ye("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],qe);const Et=Ht(0,0,null,null),Xt=y();var le,T,dt;(function(t){t.Vertex=xe.Custom1,t.Edge=xe.Custom2})(le||(le={})),function(t){t[t.NONE=0]="NONE",t[t.MOVING=1]="MOVING",t[t.RESHAPING=2]="RESHAPING"}(T||(T={})),function(t){t[t.ALL=0]="ALL",t[t.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(dt||(dt={}));let X=class extends Me.EventedMixin(pi){constructor(t){super(t),this._handles=new re,this._reshapeOperation=null,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.snappingManager=null,this.automaticManipulatorSelection=!1}destroy(){this._handles=F(this._handles),this._reshapeOperation=F(this._reshapeOperation),this._set("view",null),this._set("graphic",null)}get updating(){var t,e;return(t=(e=this._reshapeOperation)==null?void 0:e.updating)!=null&&t}_updateGeometry(){const t=rr(this.graphic);this._reshapeOperation.inputGeometry=h(t)?t.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),or(this.graphic)!==Ts.SUPPORTED)return;const t=this.watch("graphic.geometry",()=>{this._internalGeometryUpdate===!1&&this._updateGeometry()},!0);this._handles.add(t,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_updateGeometryInternally(t){this._internalGeometryUpdate=!0,this.graphic.geometry=t,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){_(this.graphic)||this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}initialize(){this._reshapeOperation=new qe({tool:this}),this._handles.add([this._reshapeOperation.on("reshape",t=>{t.type==="reshape"&&this._onReshapeGeometryChanged(),this.emit("reshape",t)}),this._reshapeOperation.on("move",t=>{t.type==="move"&&this._onReshapeGeometryChanged(),this.emit("move",t)}),this._reshapeOperation.on("vertex-add",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",t)}),this._reshapeOperation.on("vertex-remove",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",t)}),this._reshapeOperation.on("immediate-click",t=>this.emit("immediate-click",t)),this.view.on("pointer-down",["Shift"],t=>{t.stopPropagation()}),Ue(this,"graphic",()=>{this._updateGraphic()},!0)]),this.finishToolCreation()}get canUndo(){var t,e;return(t=(e=this._reshapeOperation)==null?void 0:e.canUndo)!=null&&t}undo(){h(this.snappingManager)&&this.snappingManager.doneSnapping(),h(this._reshapeOperation.undo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canRedo(){var t,e;return(t=(e=this._reshapeOperation)==null?void 0:e.canRedo)!=null&&t}redo(){h(this.snappingManager)&&this.snappingManager.doneSnapping(),h(this._reshapeOperation.redo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}onInputEvent(t){t.type!=="key-down"||t.key!=="Delete"&&t.key!=="Backspace"||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager}}};m([v()],X.prototype,"_reshapeOperation",void 0),m([v({constructOnly:!0,nonNullable:!0})],X.prototype,"view",void 0),m([v({constructOnly:!0})],X.prototype,"graphic",void 0),m([v({constructOnly:!0,nonNullable:!0})],X.prototype,"enableZShape",void 0),m([v({constructOnly:!0,nonNullable:!0})],X.prototype,"enableZVertex",void 0),m([v({constructOnly:!0,nonNullable:!0})],X.prototype,"enableMoveGraphic",void 0),m([v({constructOnly:!0,nonNullable:!0})],X.prototype,"enableMidpoints",void 0),m([v({constructOnly:!0,nonNullable:!0})],X.prototype,"enableEdgeOffset",void 0),m([v({readOnly:!0})],X.prototype,"type",void 0),m([v({constructOnly:!0})],X.prototype,"snappingManager",void 0),m([v({readOnly:!0})],X.prototype,"updating",null),m([v()],X.prototype,"automaticManipulatorSelection",void 0),X=m([ye("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],X);var S,gt;(function(t){t.ScaleIn=xe.Custom2,t.ScaleOut=xe.Custom3,t.RotateLeft=xe.Custom4,t.RotateRight=xe.Custom5,t.Unlocked=xe.Custom7,t.DelayedFocused=xe.Custom8,t.TouchInput=xe.Custom12})(S||(S={}));class ml{constructor(e){this.mode=null,this._handles=new re,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new Me,this.getFocused=()=>this.ringManipulator.focused,this.getScale=()=>h(this._scaleRotateDragData)&&this._scaleRotateDragData.mode==="scale"?this.adapter.scale:1,this.tool=e.tool,this.mode=e.mode,this.adapter=e.adapter,this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform()}get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(e){this.ringManipulator.location=e}set elevationAlignedLocation(e){this.ringManipulator.elevationAlignedLocation=e}get grabbing(){return this.ringManipulator.grabbing}set interactive(e){this.ringManipulator.interactive=e}destroy(){h(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=F(this._handles),this.tool.manipulators.remove(this.ringManipulator),this.ringManipulator=null}startAnimation(e){this.cancelActiveAnimation(),e.start();const i=lr({update:({deltaTime:a})=>{e.update(a)&&this.cancelActiveAnimation()}});this._activeAnimation=R(O({},e),{frameTask:i})}cancelActiveAnimation(){h(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=F(this._activeAnimation))}forEachManipulator(e){e(this.ringManipulator,P.SCALE_ROTATE)}_createManipulator(){this.ringManipulator=this._createRingManipulator(),this.tool.manipulators.add(this.ringManipulator);const e=this.ringManipulator,i=this.tool.graphicState.graphic,a=ue(e,(s,n,r)=>{this._scaleRotateDragData=null,this.adapter.restart();const o={mode:"none",origin:ei(s.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=o,this._updateDragState();const l=x.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(s.renderLocation,l),n.next(ci(this.tool.view,di(s.renderLocation,l,It()))).next(c=>{const d=Ut(c.plane),p=Us(c.renderStart,c.renderEnd,o.origin,d),g=hr.shortestSignedDiff(o.angle,p);o.angleDir=ai(o.angleDir+g,-Na,Na),o.angle=p;const f=_l(o,c),b=f-this.adapter.scale;if(o.scaleDir=ai(o.scaleDir+b,-Ua,Ua),this._onScaleChanged(),o.mode==="none"){const A=this.mode||fl(c,c.plane,o.origin,this.tool.view.state.camera);if(h(A)){switch(A){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:i,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:i,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}o.mode=A}}switch(o.mode){case"rotate":this.adapter.angle=o.initialAngle+p;break;case"scale":this.adapter.scale=f,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),c.action){case"start":case"update":switch(o.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:i,angle:Ct(o.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:i,xScale:f,yScale:f})}break;case"end":switch(o.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:Ct(o.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:f,yScale:f})}}c.action==="end"&&(this.startAnimation(Ka(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState())}),r.next(()=>{if(this.adapter.cancel(),h(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:1,yScale:1})}this.startAnimation(Ka(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}})});this._handles.add(a),this._handles.add([this.ringManipulator.events.on("focus-changed",s=>{s.action==="focus"?this.startAnimation(vl(this,()=>this._updateDelayedFocusedState())):this._updateDelayedFocusedState()}),this.ringManipulator.events.on("immediate-click",s=>{s.stopPropagation()}),Ue(this.tool.graphicState,"displaying",s=>this.ringManipulator.available=s)])}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this.ringManipulator.updateStateEnabled(S.DelayedFocused,this.getFocused())}_updateDragState(){if(this.ringManipulator.updateStateEnabled(S.Unlocked,!(h(this._scaleRotateDragData)&&this._scaleRotateDragData.mode!=="none")),h(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this.ringManipulator.updateStateEnabled(S.ScaleIn|S.ScaleOut,!1),this.ringManipulator.updateStateEnabled(S.RotateLeft,this._scaleRotateDragData.angleDir<0),this.ringManipulator.updateStateEnabled(S.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this.ringManipulator.updateStateEnabled(S.RotateLeft|S.RotateRight,!1),this.ringManipulator.updateStateEnabled(S.ScaleIn,this._scaleRotateDragData.scaleDir<0),this.ringManipulator.updateStateEnabled(S.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this.ringManipulator.updateStateEnabled(S.ScaleIn|S.ScaleOut|S.RotateLeft|S.RotateRight,!1)}_updateManipulatorTransform(){const e=Rs(J.get(),this.adapter.angle,B(0,0,1)),i=this.getScale(),a=ri(J.get(),q(x.get(),i,i,i));this.ringManipulator.modelTransform=Yt(J.get(),a,e)}_createRingManipulator(){const e=(L,me,Oe)=>{const Pe=[],Re=Math.ceil(Ws*(me-L)/(2*Math.PI));for(let j=0;j<Re+1;j++){const vt=L+j*(me-L)/Re;Pe.push(B(Oe*Math.cos(vt),Oe*Math.sin(vt),0))}return Pe},i=L=>e(0,2*Math.PI,L),a=L=>[[-L/2,0],[L/2,0],[L/2,Ei/2],[-L/2,Ei/2]],s=(L,me)=>z.createPathExtrusionGeometry(a(me),L,[],[],!1),n=i(Ze),r=s(n,xi),o={left:[],right:[]},l=[];for(let L=0;L<2;L++){const me=L*Math.PI-Math.PI/4,Oe=Math.PI/2-Xo,Pe=me+Oe,Re=me+Math.PI/2-Oe,j=e(Pe,Re,Bo),vt=s(j,st);l.push(j),l.push(e(Pe,Re,$a-xi/2)),o.left.push(vt),o.right.push(vt);for(let vi=0;vi<2;vi++){const qi=vi===0,Q=Lt();if(qi){Gs(Q,Q,[1,-1,1]),ca(Q,Q,-Pe,[0,0,1]);const ke=Math.round(Ia*(j.length-1));Q[12]=j[ke][0],Q[13]=j[ke][1],Q[14]=j[ke][2]}else{ca(Q,Q,Re,[0,0,1]);const ke=Math.round((1-Ia)*(j.length-1));Q[12]=j[ke][0],Q[13]=j[ke][1],Q[14]=j[ke][2]}const Zi=z.createExtrudedTriangle(jo,0,Wo,Ei);z.transformInPlace(Zi,Q),(qi?o.left:o.right).push(Zi)}}const c=[];for(let L=0;L<2;L++){const me=L*Math.PI-Math.PI/4,Oe=Math.PI/2-qo,Pe=me+Oe,Re=me+Math.PI/2-Oe,j=e(Pe,Re,$a);c.push(s(j,st))}const d=i(Ze+za),p=i(Ze+Ha),g=s(d,st),f=s(p,st),b=i(Ze-za),A=i(Ze-Ha),G=s(b,st),w=s(A,st),C=this._createMaterial(),Y=this._createMaterial(.66),_t=this._createMaterial(.5),ft=this._createMaterial(.33);let be=[{geometry:r,material:C,stateMask:S.DelayedFocused},{geometry:r,material:_t,stateMask:E.None}];this.mode&&this.mode!=="scale"||(be=be.concat([{geometry:c,material:C,stateMask:S.DelayedFocused|S.Unlocked},{geometry:g,material:Y,stateMask:S.DelayedFocused|S.ScaleIn},{geometry:f,material:ft,stateMask:S.DelayedFocused|S.ScaleIn},{geometry:G,material:Y,stateMask:S.DelayedFocused|S.ScaleOut},{geometry:w,material:ft,stateMask:S.DelayedFocused|S.ScaleOut}])),this.mode&&this.mode!=="rotate"||(be=be.concat([{geometry:o.right,material:C,stateMask:S.DelayedFocused|S.Unlocked},{geometry:o.left,material:C,stateMask:S.DelayedFocused|S.RotateLeft},{geometry:o.right,material:C,stateMask:S.DelayedFocused|S.RotateRight}]));const kt=[n,...l];return new ne({view:this.tool.view,renderObjects:be,autoScaleRenderObjects:!1,worldOriented:!0,radius:xi,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:U(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:kt,direction:B(0,0,1)}})}_createMaterial(e=1){const i=[...Uo,e];return new Ui({color:i,transparent:e!==1,cullFace:Rt.Back,renderOccluded:$.Transparent})}get test(){return{ringManipulator:this.ringManipulator}}}function _l(t,e){const i=V(x.get(),e.renderStart,t.origin),a=V(x.get(),e.renderEnd,t.origin),s=Ne(i),n=Ne(a);return s===0?0:n/s}function fl(t,e,i,a){const{renderStart:s,renderEnd:n}=t,r=qt(s,a,x.get()),o=qt(n,a,x.get());if(cr(r,o)<La*La)return null;const l=V(x.get(),s,i),c=ge(x.get(),l,Ut(e)),d=s,p=ie(x.get(),d,c),g=qt(i,a,x.get()),f=r,b=qt(p,a,x.get()),A=V(x.get(),b,f),G=V(x.get(),r,g),w=Ai(f,A),C=Ai(g,G);return da(w,o)<da(C,o)?"rotate":"scale"}function qt(t,e,i){return e.projectToScreen(t,Si),q(i,Si[0],Si[1],0)}function Ka(t,e){let i=null,a=1;const s=()=>a;return{start:()=>{a=t.getScale(),i=t.getScale,t.getScale=s,e()},update:n=>(a+=((a+1)/2-a)*Math.min(n*Yo,1),e(),Math.abs(a-1)<.01?gt.STOP:gt.CONTINUE),destroy:()=>{t.getScale=i,e()}}}function vl(t,e){let i=0,a=null;const s=()=>!1;return{start:()=>{a=t.getFocused,t.getFocused=s,i=0,e()},update:n=>(i+=n,!a()||i>Zo?gt.STOP:gt.CONTINUE),destroy:()=>{t.getFocused=a,e()}}}(function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"})(gt||(gt={}));const Si=He();function en(t){return h(t.geometry)&&t.geometry.type==="mesh"?yl(t.geometry):Ml(t)}function yl(t){return h(t.transform)?bl(t,t.transform):wl(t)}function Ml(t){let e=t.geometry,i=$s;return{undo(a){i=a.geometry,a.geometry=e},redo(a){e=a.geometry,a.geometry=i}}}function bl(t,e){let i=e.clone(),a=null;return{undo:s=>{a=h(t.transform)?t.transform.clone():null,t.transform=i,s.notifyGeometryChanged()},redo:s=>{i=h(t.transform)?t.transform.clone():null,t.transform=a,s.notifyGeometryChanged()}}}function wl(t){let e,i=t.vertexAttributes.clonePositional();return{undo:a=>{e=t.vertexAttributes.clonePositional(),t.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=t.vertexAttributes.clonePositional(),t.vertexAttributes=e,a.notifyGeometryChanged()}}}let Te=class extends Ni{constructor(t){super(t),this.angle=0,this.scale=1,this.initialAngle=0,this.previousAngle=0,this.previousScale=1}initialize(){this.restart()}restart(){this.handles.remove(Ja);const t=this.geometry.transform;if(this.scale=1,h(t)){const e=Qr(t.rotation)[2];Math.abs(e)>.999999&&(this.angle=tt(Kr(t.rotation))*Math.sign(e))}this.initialAngle=this.angle,this.previousAngle=this.angle,this.previousScale=this.scale,this.handles.add(Ls(()=>({angle:this.angle,scale:this.scale}),e=>this._update(e),Is),Ja)}cancel(){this.scale=1,this.angle=this.initialAngle}createUndoRecord(){return en(this.graphic)}_update({scale:t,angle:e}){const i=this.geometry.anchor,a=this.viewingMode===zs.Global;t!==this.previousScale&&(this.geometry.scale(t/this.previousScale,{origin:i,geographic:a}),this.previousScale=t,h(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()),e!==this.previousAngle&&(this.geometry.rotate(0,0,Ct(e-this.previousAngle),{origin:i,geographic:a}),this.previousAngle=e,h(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged())}};m([v({constructOnly:!0})],Te.prototype,"graphic",void 0),m([v({constructOnly:!0})],Te.prototype,"geometry",void 0),m([v({constructOnly:!0})],Te.prototype,"viewingMode",void 0),m([v()],Te.prototype,"angle",void 0),m([v()],Te.prototype,"scale",void 0),Te=m([ye("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],Te);const Ja="scale-heading-update-key";let Ee=class extends Ni{constructor(t){super(t),this.angle=0,this.scale=1,this.symbol=null,this.initialAngle=0}initialize(){this.restart()}restart(){this.handles.remove(es);const t=h(this.graphic.symbol)&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:$s;if(this.symbol=h(t)?t.clone():null,this.initialSizes=[],h(t)){const e=this.findLayerView();h(e)&&(this.initialSizes=t.symbolLayers.map(i=>i.type==="object"?e.getSymbolLayerSize(t,i):null).toArray())}this.angle=0,h(t)&&t.symbolLayers.some(e=>!(e.type!=="object"||!h(e.heading))&&(this.angle=-tt(e.heading),!0)),this.initialAngle=this.angle,this.scale=1,this.handles.add(Ls(()=>({angle:this.angle,scale:this.scale}),e=>this._updateSymbol(e),Is),es)}cancel(){this.graphic.symbol=this.symbol}createUndoRecord(){let t=this.graphic.symbol,e=null;return{undo:i=>{e=i.symbol,i.symbol=t,this.restart()},redo:i=>{t=i.symbol,i.symbol=e,this.restart()}}}_updateSymbol({scale:t,angle:e}){const i=this.graphic.symbol;if(_(this.symbol)||_(i)||i.type!=="point-3d")return;const a=i.clone(),s=-Ct(e-this.initialAngle);let n=!1;this._forEachObjectSymbolLayerPair(this.symbol,a,(r,o,l)=>{const c=Pt(r.heading,0)+s;o.heading!==c&&(o.heading=c,n=!0);const d=this.initialSizes[l];if(h(d)&&"width"in d){d.width=this.sizeFilter(d.width),d.height=this.sizeFilter(d.height),d.depth=this.sizeFilter(d.depth);const p=d.width*t;o.width!==p&&(o.width=p,n=!0);const g=d.depth*t;o.depth!==g&&(o.depth=g,n=!0);const f=d.height*t;o.height!==f&&(o.height=f,n=!0)}}),n&&(this.graphic.symbol=a)}_forEachObjectSymbolLayerPair(t,e,i){t.symbolLayers.forEach((a,s)=>{const n=e.symbolLayers.getItemAt(s);a.type==="object"&&n.type==="object"&&i(a,n,s)})}};m([v()],Ee.prototype,"angle",void 0),m([v()],Ee.prototype,"scale",void 0),m([v({constructOnly:!0})],Ee.prototype,"graphic",void 0),m([v()],Ee.prototype,"symbol",void 0),m([v({constructOnly:!0})],Ee.prototype,"findLayerView",void 0),m([v({constructOnly:!0})],Ee.prototype,"sizeFilter",void 0),Ee=m([ye("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],Ee);const es="scale-heading-update-key";let ae=class extends Cs(Me.EventedMixin(pi)){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.type="transform-3d",this.scaleRotate=null,this.snappingPipeline=new li}initialize(){this.graphicState=new ee({graphic:this.graphic}),this.moveManipulation=new Ke({tool:this,view:this.view,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Qe(this.graphic),radius:Ke.radiusForSymbol(this.graphic.symbol)}),this.moveManipulation.forEachManipulator(e=>this.handles.add(e.events.on("immediate-click",i=>{this.emit("immediate-click",R(O({},i),{graphic:this.graphicState.graphic})),i.stopPropagation()}))),this.moveManipulation.elevationInfo=U(this.graphic);const t=this.graphic.geometry;if(this.moveManipulation.createGraphicDragPipeline((e,i,a,s,n)=>(h(t)&&e===ce.XY&&(a=a.next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new oi({elevationInfo:U(this.graphic),pointer:n,editGeometryOperations:ui.fromGeometry(new dr({spatialReference:t.spatialReference}),this.view.state.viewingMode),visualizer:new Vt,excludeFeature:this.graphic}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:s}),this.snappingPipeline.next)),a),this.graphicState,e=>{const{action:i,graphic:a,dxScreen:s,dyScreen:n}=e,r={graphic:a,dxScreen:s,dyScreen:n};switch(i){case"start":this.emit("graphic-translate-start",r),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",r);break;case"end":this.emit("graphic-translate-stop",r)}}),this.moveManipulation.angle=h(this.scaleRotate)?this.scaleRotate.angle:0,this.scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(this.scaleRotateAdapter.watch("angle",()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const e=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this.scaleRotate=new ml({tool:this,mode:e,adapter:this.scaleRotateAdapter}),this.handles.add(this.scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.handles.add([mi({view:this.view,graphic:this.graphic,forEachManipulator:e=>this._forEachManipulator(e),onManipulatorsChanged:()=>pt()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),this.view.watch("scale",()=>this._updateMoveAngle())]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(e=>{e instanceof ne&&this.handles.add(e.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))}),this.finishToolCreation()}_updateManipulatorsInteractive(){_(this.scaleRotate)||(this.scaleRotate.interactive=!this.moveManipulation.grabbing,this.moveManipulation.interactive=!this.scaleRotate.grabbing)}_createScaleRotateAdapter(){return h(this.graphic.geometry)&&this.graphic.geometry.type==="mesh"?new Te({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new Ee({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find(t=>t.layer===this.graphic.layer)})}_forEachManipulator(t){this.moveManipulation.forEachManipulator(t),h(this.scaleRotate)&&this.scaleRotate.forEachManipulator(t)}_hideManipulatorsForGraphicState(){return this.graphicState.watch("displaying",t=>{this._forEachManipulator(e=>e.available=t),this.moveManipulation.zManipulation.available=t&&this.enableZ&&Qe(this.graphic)})}_createGeometryUndoRecord(){return en(this.graphic)}destroy(){this.moveManipulation.destroy(),this.scaleRotate=F(this.scaleRotate),this.scaleRotateAdapter=F(this.scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}set snapToScene(t){this.moveManipulation&&(this.moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this.updatingHandles.updating}set location(t){this.moveManipulation.location=t,h(this.scaleRotate)&&(this.scaleRotate.location=t)}set elevationAlignedLocation(t){this.moveManipulation.elevationAlignedLocation=t,h(this.scaleRotate)&&(this.scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){h(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if(_(this.scaleRotate))return;const t=this.scaleRotate.getScale();this.moveManipulation.displayScale=t}_updateMoveAngle(){this.view.state.viewingMode===zs.Local||this.view.scale<Qo?this.moveManipulation.angle=this.scaleRotateAdapter.angle:this.moveManipulation.angle=0}_onGeometryChanged(){Hs(this.view,this,this.graphic)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this.moveManipulation.renderLocation)}get test(){return{discManipulator:this.moveManipulation.xyManipulation.test.discManipulator,zManipulator:this.moveManipulation.zManipulation.test.manipulator,ringManipulator:h(this.scaleRotate)?this.scaleRotate.test.ringManipulator:null,arrowManipulators:this.moveManipulation.xyAxisManipulation.test.arrowManipulators}}};m([v({constructOnly:!0,nonNullable:!0})],ae.prototype,"view",void 0),m([v({constructOnly:!0,nonNullable:!0})],ae.prototype,"graphic",void 0),m([v({constructOnly:!0,nonNullable:!0})],ae.prototype,"enableZ",void 0),m([v()],ae.prototype,"enableRotation",void 0),m([v()],ae.prototype,"enableScaling",void 0),m([v({value:!1})],ae.prototype,"snapToScene",null),m([v({constructOnly:!0})],ae.prototype,"snappingManager",void 0),m([v({readOnly:!0})],ae.prototype,"type",void 0),m([v({readOnly:!0})],ae.prototype,"updating",null),ae=m([ye("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],ae);const ts="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAACuFBMVEUAAAD/AAD/gAD/VQD/gAD/bQD/gAD/cQD/gAD/dAD/eAD/gAD/gAD/egD/gAD/ewD/gAD/fAD/gAD/fQD/gAD/fQD/fQD/egD/fQD/gAD/fQD/ewD/fQD/gAD/gAD/fQD/gAD/fAD/fgD/fgD/fAD/fgD/fAD/fgD/fAD/fgD/gAD/fAD/fgD/fAD/fQD/fgD/fgD/fQD/fgD/fgD/fQD/fgD/fQD/fQD/fgD/fgD/fQD/fQD/fgD/fQD/fgD/fQD/fgD/fQD/fgD/fgD/gAL/fgD/gAb/gAT/gwr/gQj/hA7/hAz/hxH/iBP/ixn/iRf/jBz/jR7/jyP/kCX/kyr/lS7/lCz/li//mTT/mTf/nDr/mjn/nTz/n0H/nT//oET/oEL/okf/oEX/o0r/pU3/o0v/pU//qFL/plH/qFX/qFP/qVb/q1n/rV3/rFz/rmD/rl7/sGL/rmH/tW3/s2v/tW//tW7/t3L/tnD/uHT/unb/unn/unf/vHv/vX3/v4D/vX7/w4n/xY3/xIv/x4//xY3/x5H/yZP/x5H/yJP/y5f/yZX/zZv/y5n/zZ3/zJv/z5//z6D/z6H/0aT/0KP/0qb/06j/1av/06r/1q3/1q//17H/2rb/2rb/2rj/3bz/4MH/38D/38H/4sX/4MT/48f/4sb/4sf/5Mr/5s3/5cz/5s3/59D/59D/6dT/6dP/6dT/6tb/6tX/6tf/69n/69j/7dr/7Nn/7dz/7dv/7t3/7t7/7t3/7+H/8eL/8uX/8eP/8+j/8+f/9On/8+j/9Or/9ez/9e3/9ez/9e3/9+//9+7/+PD/9+//+PH/+PD/+fL/+PH/+fT/+vX/+fT/+vb/+vX/+/b/+vb/+/j/+/j//Pr//Pn//fv//v3//vz//fz//fv//v3//fz//////v7//v3///9vf1WOAAAA53RSTlMAAQIDBgcICQoLERIYGRobKCkqKywtLzAxMjM4OTo+P0BAQUVGR0hPUFFSUlNUWlthYmNlZmdoamtvcHR1dnd4eXx9f4CAgYGCgoODhIWGhoeIiYqLjIyNjo+QkJGSkpOTlJSVlpaXmJiZmZqbnJydnZ6eoqKjo6Skpaanp6ipqqqvsLCxsbKzs7S1tbe3uLi5uru8vL2+wMDBwsTGx8jLzc3O0NDR0dLT1dXW19ja2tvc3N3e3t/f4ODh4uLl5ufn6urr6+zt7u7v8PDx8fLy8/P09fX29vf3+Pn6+vv8/Pz8/f3+/v7EBDCzAAADmklEQVR42qXXd3sUVRQG8BNDKkU3KLYUIFkLLBo0yRJNBszuuwQlGISIDUTFhljAhhUbtlXEYEcjoEJUNCqKPXZUUCDU0FvI+RpkZpa5c9iZzMzD7+/d88yde+95z5CbvIIhIyqrtbo6rboyUlKQR4GcGI7GIMSi4QHkU1bRKDgaVZRF3nKGanClDc4hD4Nq0CvtzAzqRd8L4GlkX3IVGg0fxpxMzjLOgk9hx2VkRuBbJNPh/+cjpQnezkuvcC6Q8vVseItkkKTWP6Pr17HwVkbCQFg+YJ4P3U0vtrS1t//c9u6zM+DgFLH/av+m7Gfe1IhpLf+ysmbxVBxrdD4ptvPzDvdY2trNUvfytBLlZDkdloZt3GPvPk5z8K0EpFMpJacWlmTqmdnBd1dBqMkm01BY4n+waTsb1nd0drHl/2kQSsiQpcHyKKd0MP/YfOt4AJfPWtTOKRumw04z+0MRlNV81PezoNz5JZv+boRdIemisMxkS+ck2M3rZMPHskcZ/Q/KR6y8D2HqWjbMh11/IgrDfoiU7lsgXGNW6GgQB1quYPrClk9+WnuITash3WGWfw02VUR5MUCKX3n7w8m3P1z121xIzazbMg5KLJcK4Ntl5vV4EDYhGgz/XmDdcnmWRsC/iQeM1wibYVSBAL5g3WQoF9JFCOBN1t0PpZo0BDCPdU9BqaU6BPAA65JQLglWYDbrFooCGgJ4jHXPiSUEeokvse4hKNXBtnEF624W2xiBf/GN3GP3pVCG0xAIE57+9h64uZd1bbApFpcpMXfFLuaVcLOKdS/DJiSu87UHucfhOb0+wIEmeZ0pCqWVdX+Nh5MJ61i3BDaVsqVhphkCnyaQrt68SYdvhE0pEQ2AzRI2LBuX3k1a2fAe7PoRyTU0/seGb66ANPkHNqxpEG1dBIvhvkNs2PLMWCiJ5FY27LlbBouMNsOTXWz6p/lqmK57fR2buh+HjDYVrsqCLhWmK5cuXvbZBhUVzzuGK+XUwO6J3exs5yMQLs6mlNMg3PY7O/nlBkiDyDISQv2CHXysrckEpHI5ZEmTXpUzyp+vTOx1yHLIp/icN74y927z54vuiiNNiISwc5hNub6pHoo8xNI5CCSS4T5sw/ewLZ1wNnwbnklOyuBPrJRcnKTBhzEDyVV+OTyV5x/fZ98Z5CG7RIOr2pJs8tanMApH0cI+5FP/sqoYhFhVaT8KJDdUHKkwP/8rhhWHct1+dwRTps/cplDIpwAAAABJRU5ErkJggg==",El={mipmap:!0,preMultiplyAlpha:!0,width:64,height:64};function xl(t){return t.fromData(ts,()=>new pr(ts,El))}class Sl{constructor(){this.lastDragEvent=null,this.next=new Fi,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&h(this.lastDragEvent)){const i=R(O({},this.lastDragEvent),{action:"update"});e&&this._adjustScaleFactors(i),this.next.execute(i)}this._enabled=e}createDragEventPipelineStep(){return this.lastDragEvent=null,e=>(this.lastDragEvent=e.action!=="end"?O({},e):null,this._enabled&&this._adjustScaleFactors(e),e)}_adjustScaleFactors(e){const i=Ns(e.handle)?Math.max(Math.abs(e.factor1),Math.abs(e.factor2)):e.handle.direction[0]===0?Math.abs(e.factor2):Math.abs(e.factor1);e.factor1=e.factor1<0?-i:i,e.factor2=e.factor2<0?-i:i}get test(){return{_adjustScaleFactors:e=>this._adjustScaleFactors(e)}}}function Zt(t,e){return tn(t,e,!1)}function is(t,e){return tn(t,e,!0)}function tn(t,e,i){if(t instanceof Xr){if(t.operation instanceof qr)return Dl(t.operation,e,i),!0;if(t.operation instanceof Zr)return Al(t.operation,e,i),!0;if(t.operation instanceof Yr)return Ol(t.operation,e,i),!0}return!1}function Dl(t,e,i=!1){const a=i?-1:1,s=B(a*t.dx,a*t.dy,a*t.dz);ie(e.origin,e.origin,s)}function Al(t,e,i=!1){const a=i?-t.angle:t.angle;pa(e.basis1,e.basis1,ua,a),pa(e.basis2,e.basis2,ua,a)}function Ol(t,e,i=!1){const a=i?1/t.factor1:t.factor1,s=i?1/t.factor2:t.factor2;fe(e.basis1,e.basis1,a),fe(e.basis2,e.basis2,s),ga(e.origin,e.origin,t.origin,t.axis1,a),ga(e.origin,e.origin,t.origin,t.axis2,s)}function Pl(t,e,i,a){a||(a=ht());const s=Ve(Le.get(),t[1],-t[0]),n=Ve(Le.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),r=Ve(Le.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),o=Le.get();e.components.forEach(d=>d.vertices.forEach(p=>{const g=p.pos;Ve(o,ma(t,g),ma(s,g)),gr(n,n,o),mr(r,r,o)}));const l=1e-6,c=Ve(Le.get(),r[0]-n[0]<l?i/2:0,r[1]-n[1]<l?i/2:0);return zi(n,n,c),Ye(r,r,c),Dt(a.basis1,t,(r[0]-n[0])/2),Dt(a.basis2,s,(r[1]-n[1])/2),Ve(a.origin,n[0]*t[0]+n[1]*s[0],n[0]*t[1]+n[1]*s[1]),Ye(a.origin,a.origin,a.basis1),Ye(a.origin,a.origin,a.basis2),a}function Rl(t,e,i,a=0,s){s||(s=ht()),e.toRenderCoords(t.origin,i,s.origin);const n=x.get();ie(n,t.origin,t.basis1),ie(n,n,t.basis2),e.toRenderCoords(n,i,n);const r=x.get();ie(r,t.origin,t.basis1),V(r,r,t.basis2),e.toRenderCoords(r,i,r);const o=x.get();V(o,t.origin,t.basis1),V(o,o,t.basis2),e.toRenderCoords(o,i,o);const l=x.get();V(l,t.origin,t.basis1),ie(l,l,t.basis2),e.toRenderCoords(l,i,l);const c=$e(x.get(),n,r,.5);V(c,c,s.origin);const d=$e(x.get(),o,l,.5);V(d,s.origin,d),$e(s.basis1,c,d,.5);const p=$e(x.get(),l,n,.5);V(p,p,s.origin);const g=$e(x.get(),r,o,.5);V(g,s.origin,g),$e(s.basis2,p,g,.5);const f=ge(x.get(),s.basis1,s.basis2),b=ge(f,f,s.basis1);return Ie(b,b),fe(s.basis2,b,Gt(s.basis2,b)),fe(s.basis1,s.basis1,1+a/Ne(s.basis1)),fe(s.basis2,s.basis2,1+a/Ne(s.basis2)),ur(s),s}let se=class extends Me.EventedMixin(pi){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this._preserveAspectRatio=new Sl,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this.handles=new re,this.moveZManipulator=null,this.resizeManipulators=null,this.rotateManipulator=null,this.attachmentOrigin=null,this.outlineVisualElement=null,this.mapBounds=ht(),this.mapBoundsStart=ht(),this.displayBounds=ht(),this.displayBoundsStart=ht(),this.displayBoundsMarginStart=0,this.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}]}initialize(){this.graphicState=new ee({graphic:this.graphic});const t=this.graphic.geometry;this.editGeometryOperations=ui.fromGeometry(t,this.view.state.viewingMode),this.graphicMoveManipulation=new Xi({tool:this,view:this.view,graphicState:this.graphicState}),this.handles.add(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=Er(this.view,xr.CENTER_ON_CALLOUT),this.moveZManipulator.state|=Sr,this.handles.add(this.watch("enableZ",()=>this._updateManipulatorAvailability(this.moveZManipulator,P.TRANSLATE_Z))),this.handles.add(this._createMoveZDragPipeline()),this.manipulators.add(this.moveZManipulator),this.resizeManipulators=this.resizeHandles.map(n=>{const r=Dr(this.view,n);return this.handles.add(this.watch("enableScaling",()=>this._updateManipulatorAvailability(r,P.SCALE))),r.events.on("grab-changed",o=>this._onResizeGrab(o)),this.handles.add(this._createResizeDragPipeline(r,n)),r}),this.manipulators.addMany(this.resizeManipulators),this.rotateManipulatorTexture=xl(this.view.toolViewManager.textures),this.rotateManipulator=Ar(this.view,this.rotateManipulatorTexture.texture),this.handles.add(this.watch("enableRotation",()=>this._updateManipulatorAvailability(this.rotateManipulator,P.ROTATE))),this.rotateManipulator.events.on("grab-changed",n=>{this._onRotateGrab(n)}),this.handles.add(this._createRotateDragPipeline(this.rotateManipulator)),this.manipulators.add(this.rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const e=mi({view:this.view,graphic:this.graphic,forEachManipulator:n=>this._forEachManipulator(n),onManipulatorsChanged:()=>pt()});h(e)&&(this.outlineVisualElement=e.visualElement instanceof et?e.visualElement:null),h(this.outlineVisualElement)&&this.handles.add(this.outlineVisualElement.events.on("attachment-origin-changed",()=>this._updateDisplayBounds())),this.handles.add(e),this.handles.add([this.graphicState.on("changed",()=>this._onGeometryChanged()),this.graphicState.watch("displaying",()=>this._updateAllManipulatorAvailability()),Ue(this.graphicState,"isDraped",()=>this._graphicDrapedChanged()),this.view.trackGraphicState(this.graphicState)]);const i=this.view.pointsOfInterest;i&&this.handles.add(i.centerOnSurfaceFrequent.watch("location",()=>this._updateDisplayBounds()));const a=n=>{this.handles.add(n.events.on("grab-changed",()=>{this.grabbing=n.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(a);const s=(n,r)=>{this.handles.add(n.events.on("immediate-click",o=>{r===P.TRANSLATE_XY&&this.emit("immediate-click",R(O({},o),{graphic:this.graphic})),o.stopPropagation()}))};this._forEachManipulator(s),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this.finishToolCreation()}_graphicDrapedChanged(){this.handles.remove(as),this._updateDisplayBounds(),this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",t=>{h(this.attachmentOrigin)&&Os(t.extent,this.attachmentOrigin.x,this.attachmentOrigin.y)&&this._updateDisplayBounds()}),as)}_updateAllManipulatorAvailability(){this._forEachManipulator((t,e)=>this._updateManipulatorAvailability(t,e))}_updateManipulatorAvailability(t,e){const i=this.grabbing&&!t.grabbing;if(t.interactive=!i,t instanceof ne){const a=this.graphicState.displaying,s=this.enableZ&&Qe(this.graphic);switch(e){case P.ROTATE:t.available=a&&this.enableRotation;break;case P.SCALE:t.available=a&&(this.enableScaling||this.enableRotation||s),t.interactive=!i&&this.enableScaling,t.state=this.enableScaling?Or:Pr;break;case P.TRANSLATE_Z:t.available=a&&s;break;default:t.available=a}}}_forEachManipulator(t){this.graphicMoveManipulation.forEachManipulator(t),this.resizeManipulators.forEach(e=>t(e,P.SCALE)),t(this.rotateManipulator,P.ROTATE),t(this.moveZManipulator,P.TRANSLATE_Z)}destroy(){this.mapBounds=null,this.displayBounds=null,this.rotateManipulatorTexture.release(),this.handles.destroy(),this.graphicMoveManipulation.destroy(),this.editGeometryOperations.destroy(),this._set("view",null),this._set("graphic",null)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){const t=this.graphic.geometry,e=this.editGeometryOperations.data,i=e.components[0].edges[0],a=zi(Le.get(),i.leftVertex.pos,i.rightVertex.pos);Oi(a,a);const s=Pt(Ti(this.view,this.graphic),t.extent.center);let n=Cl*this.view.pixelSizeAt(s);const r=this.view.spatialReference;r!==t.spatialReference&&(n*=_a(r)/_a(t.spatialReference)),Pl(a,e,n,this.mapBounds)}_updateDisplayBounds(){const t=this.graphic.geometry;if(_(t))return;const e=h(this.outlineVisualElement)&&!this.graphicState.isDraped&&h(this.outlineVisualElement.attachmentOrigin)?this.outlineVisualElement.attachmentOrigin:Ti(this.view,this.graphic);this.attachmentOrigin=Pt(e,t.extent.center);const i=h(e)?e.z:Hi(this.mapBounds.origin,this.view.elevationProvider,zt.fromElevationInfo(U(this.graphic)),this.view.renderCoordsHelper),a=Ge(this.mapBounds);a.origin[2]=i,Rl(a,this.view.renderCoordsHelper,t.spatialReference,this.displayBoundsMargin,this.displayBounds),this._updateManipulators()}get displayBoundsMargin(){const t=this.view.pointsOfInterest,e=t?t.centerOnSurfaceFrequent.location:this.editGeometryOperations.data.geometry.extent.center;return Gl*this.view.pixelSizeAt(e)}_createMoveXYGraphicDragPipeline(){return this.graphicMoveManipulation.createDragPipeline((t,e,i)=>this._applyGraphicMoveSteps(e,i))}_createMoveZDragPipeline(){const t=this.view,e=this.editGeometryOperations.data.spatialReference;return ue(this.moveZManipulator,(i,a,s)=>{const n=ei(i.renderLocation),r=a.next(Qs(t,n,e)).next(mt());this._applyGraphicMoveSteps(r,s)})}_applyGraphicMoveSteps(t,e){const i=t.next(a=>(a.action==="start"&&(this.inputState={type:"move"},Ge(this.mapBounds,this.mapBoundsStart),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:a.screenDeltaX,dyScreen:a.screenDeltaY})),a)).next(ct()).next(this._moveDragUpdateGeometry()).next(a=>{const s={graphic:this.graphic,dxScreen:a.screenDeltaX,dyScreen:a.screenDeltaY};switch(a.action){case"start":case"update":(a.mapEnd.x-a.mapStart.x||a.mapEnd.y-a.mapStart.y||a.mapEnd.z-a.mapStart.z)&&this.emit("graphic-translate",s);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",s)}return a});return e.next(()=>{h(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()}),i}_moveDragUpdateGeometry(){return t=>{if(_(this.inputState)||this.inputState.type!=="move")return t;const e=[];for(const s of this.editGeometryOperations.data.components)e.push(...s.vertices);const i=t.action==="start"?Se.NEW_STEP:Se.ACCUMULATE_STEPS,a=this.editGeometryOperations.moveVertices(e,t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i);return Zt(a,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_onResizeGrab(t){if(t.action!=="start")return;const e=this._calculatePickRay(t.screenPoint);ni(this.displayBounds.plane,e,x.get())&&(Ge(this.displayBounds,this.displayBoundsStart),Ge(this.mapBounds,this.mapBoundsStart),this.displayBoundsMarginStart=this.displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(t,e){return ue(t,(i,a,s)=>{_(this.inputState)||(a.next(n=>(n.action==="start"&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),n)).next(ci(this.view,this.displayBoundsStart.plane)).next(n=>R(O({},n),{handle:e})).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next(n=>{const r={graphic:this.graphic,xScale:n.factor1,yScale:n.factor2};switch(n.action){case"start":case"update":this.emit("graphic-scale",r);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",r)}return n}),s.next(()=>{h(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()}))})}_resizeDragRenderPlaneToFactors(){return t=>{const e=this.displayBoundsStart,i=t.handle.direction,a=this.displayBoundsMargin,s=this.displayBoundsMarginStart,n=I(x.get(),e.origin);Bt(n,n,e.basis1,-i[0]),Bt(n,n,e.basis2,-i[1]);const r=V(x.get(),t.renderEnd,n),o=V(x.get(),t.renderStart,n),l=Ns(t.handle),c=va(e),d=va(this.displayBounds)/c,p=(g,f)=>{if(g===0)return 1;let b=Ne(f),A=.5*g*Gt(f,r)/b;const G=A<0?-1:1;l&&(A+=(b-.5*g*Gt(f,o)/b)*G*d);const w=b<1.5*s?1:ss;return b=Math.max(b-s,ss),G>0&&(A-=a),G*Math.max(G*(A/b),w)};return R(O({},t),{factor1:p(i[0],e.basis1),factor2:p(i[1],e.basis2)})}}_resizeDragUpdateGeometry(){return t=>{const e=I(y(),this.mapBoundsStart.origin);Bt(e,e,this.mapBoundsStart.basis1,-t.handle.direction[0]),Bt(e,e,this.mapBoundsStart.basis2,-t.handle.direction[1]);const i=Ve(_s(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);Oi(i,i);const a=[];for(const r of this.editGeometryOperations.data.components)a.push(...r.vertices);const s=t.action==="start"?Se.NEW_STEP:Se.ACCUMULATE_STEPS,n=this.editGeometryOperations.scaleVertices(a,e,i,t.factor1,t.factor2,s,Ma.REPLACE);return Ge(this.mapBoundsStart,this.mapBounds),Zt(n,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_onRotateGrab(t){if(t.action!=="start")return;const e=Rr(this.displayBounds,this.view.renderCoordsHelper,Gr.HEADING,It()),i=this._calculatePickRay(t.screenPoint);ni(e,i,x.get())&&(Ge(this.displayBounds,this.displayBoundsStart),Ge(this.mapBounds,this.mapBoundsStart),this.inputState={type:"rotate",rotatePlane:e})}_createRotateDragPipeline(t){return ue(t,(e,i,a)=>{const s=this.inputState;_(s)||(i.next(n=>(n.action==="start"&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),n)).next(ci(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdateGeometry()).next(n=>{const r={graphic:this.graphic,angle:Ct(n.rotateAngle)};switch(n.action){case"start":case"update":this.emit("graphic-rotate",r);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",r)}return n}),a.next(()=>{h(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()}))})}_rotateDragRenderPlaneToRotate(t){return e=>{const i=Ut(t.rotatePlane),a=Us(e.renderStart,e.renderEnd,this.displayBounds.origin,i);return R(O({},e),{rotateAxis:i,rotateAngle:a})}}_rotateDragUpdateGeometry(){return t=>{const e=I(y(),this.mapBoundsStart.origin),i=[];for(const n of this.editGeometryOperations.data.components)i.push(...n.vertices);const a=t.action==="start"?Se.NEW_STEP:Se.ACCUMULATE_STEPS,s=this.editGeometryOperations.rotateVertices(i,e,t.rotateAngle,a,Ma.REPLACE);return Ge(this.mapBoundsStart,this.mapBounds),Zt(s,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_calculatePickRay(t){const e=Ii(),i=Gi(t);return Ci(this.view.state.camera,i,e),Ie(e.direction,e.direction),e}_updateManipulators(){if(!this.visible)return;const t=Cr(this.displayBounds,J.get());Tr(this.rotateManipulator,t,this.displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this.moveZManipulator,t),this.resizeManipulators.forEach((e,i)=>{Vr(e,this.resizeHandles[i],t,this.displayBounds)})}_updateZMoveHandle(t,e){const i=this.displayBounds,a={basis:i.basis1,direction:-1,position:V(x.get(),i.origin,i.basis1),edge:2},s=J.get();_r(s,e,a.edge*Math.PI/2),s[12]=0,s[13]=0,s[14]=0,t.modelTransform=s,t.renderLocation=a.position}_cancel(){const t=this.editGeometryOperations.lastOperation;_(t)||(this.editGeometryOperations.undo(),this.graphic.geometry=this.editGeometryOperations.data.geometry,is(t,this.mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this.editGeometryOperations.canUndo}undo(){if(h(this.inputState))this.view.activeTool=null;else if(this.canUndo){const t=this.editGeometryOperations.undo();this.graphic.geometry=this.editGeometryOperations.data.geometry,is(D(t),this.mapBounds),this._updateDisplayBounds()}}get canRedo(){return this.editGeometryOperations.canRedo}redo(){if(this.canRedo){const t=this.editGeometryOperations.redo();this.graphic.geometry=this.editGeometryOperations.data.geometry,Zt(D(t),this.mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this.resizeManipulators,rotateManipulator:this.rotateManipulator,moveZManipulator:this.moveZManipulator}}};m([v({constructOnly:!0,nonNullable:!0})],se.prototype,"view",void 0),m([v({constructOnly:!0,nonNullable:!0})],se.prototype,"graphic",void 0),m([v({constructOnly:!0,nonNullable:!0})],se.prototype,"enableZ",void 0),m([v()],se.prototype,"enableRotation",void 0),m([v()],se.prototype,"enableScaling",void 0),m([v()],se.prototype,"preserveAspectRatio",null),m([v()],se.prototype,"grabbing",void 0),m([v()],se.prototype,"inputState",void 0),m([v({readOnly:!0})],se.prototype,"type",void 0),se=m([ye("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],se);const as="draped-elevation-changes",Gl=10,Cl=80,ss=1e-6;var Bl=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",get DrawGraphicTool3D(){return Xe},get GraphicMoveTool(){return we},get GraphicReshapeTool(){return X},get GraphicTransformTool(){return ae},get ExtentTransformTool(){return se}});export{Bl as e,Bi as l,io as o,Jr as t};
