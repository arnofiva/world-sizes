var Z=Object.defineProperty,B=Object.defineProperties;var J=Object.getOwnPropertyDescriptors;var G=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var L=(e,t,a)=>t in e?Z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,P=(e,t)=>{for(var a in t||(t={}))K.call(t,a)&&L(e,a,t[a]);if(G)for(var a of G(t))Y.call(t,a)&&L(e,a,t[a]);return e},z=(e,t)=>B(e,J(t));import{ch as v,ci as R,cj as Q,ck as X,cl as ee,cm as y,ax as j,cc as te,cd as ae,T as ie,Z as se,U as re,$ as b,M as N,cn as ne,bt as C,b0 as oe,aL as U,co as le,cp as he,cq as ce,cg as de,cr as H,bz as I,cs as ge,K as q,ct as M,cu as me,cv as F,as as ue,cw as w,at as V,cx as ye,cy as fe,cz as pe,F as xe,J as x,d as _,x as we}from"./vendor.5a0f9a12.js";import{l as _e}from"./projectExtentUtils.1832b9cd.js";import{m as ve}from"./ImageMaterial.2d7ab4ce.js";import{i as Re}from"./RefreshableLayerView.27e350dc.js";function Se(e,t,a){const s=v(e)/R(e),i={width:a,height:a};return s>1.0001?i.height=a/s:s<.9999&&(i.width=a*s),i.width=Math.round(i.width/(v(e)/v(t))),i.height=Math.round(i.height/(R(e)/R(t))),i}function W(e){return Q.createSquareGeometry([[e[0],e[1],-1],[e[2],e[1],-1],[e[2],e[3],-1],[e[0],e[3],-1]])}function Ae(e,t){if(!X(e,t))return W(t);const a=[e[1]-t[1],Math.min(e[3],t[3])-Math.max(e[1],t[1]),t[3]-e[3],123456],s=[e[0]-t[0],Math.min(e[2],t[2])-Math.max(e[0],t[0]),t[2]-e[2],123456],i=t[2]-t[0],l=t[3]-t[1],n=s[0]>0&&s[2]>0?3:2,r=a[0]>0&&a[2]>0?3:2,c=(r+1)*(n+1),o=new Float64Array(3*c),d=new Float32Array(2*c),h=new Uint32Array(6*(r*n-1));let S=0,A=0,O=0,g=0,u=0;for(let f=0;f<4;f++){const T=a[f];if(T<=0)continue;let E=0;for(let p=0;p<4;p++){const D=s[p];D<=0||(o[A++]=t[0]+E,o[A++]=t[1]+S,o[A++]=-1,d[O++]=E/i,d[O++]=S/l,p<3&&f<3&&(p!==1||f!==1)&&(h[u++]=g,h[u++]=g+1,h[u++]=g+n+1,h[u++]=g+1,h[u++]=g+n+2,h[u++]=g+n+1),g++,E+=D)}S+=T}const k=new Uint32Array(h.length);return new ee([[y.POSITION,{size:3,data:o,exclusive:!0}],[y.NORMAL,{size:3,data:Ee,exclusive:!0}],[y.UV0,{size:2,data:d,exclusive:!0}]],[[y.POSITION,h],[y.NORMAL,k],[y.UV0,h]])}const Ee=[0,0,1],$=j.getLogger("esri.views.3d.layers.DynamicLayerView3D");let m=class extends Re(te(ae)){constructor(){super(...arguments),this.drapeSourceType=ie.RasterImage,this.updatePolicy=se.SYNC,this.fullExtentInLocalViewSpatialReference=null,this.maximumDataResolution=null,this._images=new Array,this._extents=new Array,this._overlays=new Array,this.updateWhenStationary=!0,this.refreshDebounced=re(async e=>{this.destroyed||await this._doRefresh(e).catch(t=>{b(t)||j.getLogger(this.declaredClass).error(t)})},2e3)}initialize(){this.addResolvingPromise(_e(this).then(e=>this._set("fullExtentInLocalViewSpatialReference",e))),this.updatingHandles.add(()=>this.suspended,()=>this._suspendedChangeHandler()),this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks(()=>{this._isScaleRangeActive()&&this.notifyChange("suspended")},()=>{})),this._isScaleRangeLayer()&&this.updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.notifyChange("suspended"))}destroy(){this.clear()}setDrapingExtent(e,t){this._spatialReference=t,e.forEach(a=>{this._overlays[a.index]=a,this._updateImageExtent(a)})}_updateImageExtent(e){const t=this._clippedExtent(e.extent,be);if(N(t))return;const a=Se(e.extent,t,e.resolution);let s=e.pixelRatio*this.view.pixelRatio;if("imageMaxWidth"in this.layer||"imageMaxHeight"in this.layer){const l=this.layer.imageMaxWidth,n=this.layer.imageMaxHeight;if(a.width>l){const r=l/a.width;a.height=Math.floor(a.height*r),a.width=l,s*=r}if(a.height>n){const r=n/a.height;a.width=Math.floor(a.width*r),a.height=n,s*=r}}const i=this._extents[e.index];i&&ne(i.extent,t)&&this._imageSizeEquals(t,i.imageSize,a)||(this._extents[e.index]={extent:C(t),imageSize:a,pixelRatio:s},this.suspended||this._fetch(e.index).catch(l=>{b(l)||$.error(l)}))}clear(){for(let e=0;e<this._images.length;e++)this._clearImage(e)}async doRefresh(){return this._doRefresh()}async _doRefresh(e){if(this.suspended)return;const t=[];for(let a=0;a<this._extents.length;a++)this._extents[a]&&t.push(this._fetch(a,e));await oe(t)}canResume(){if(!super.canResume())return!1;const e=this.layer;if(this._isScaleRangeActive()){const{minScale:t,maxScale:a}=e.effectiveScaleRange,s=this.view.scale;if(s<a||t>0&&s>t)return!1}return!0}isUpdating(){return this._images.some(e=>!!e.loadingPromise)}async processResult(e,t,a){(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement)&&(e.image=t)}findExtentInfoAt(e){for(const t of this._extents){const a=t.extent;if(new U(a[0],a[1],a[2],a[3],this._spatialReference).contains(e))return t}return null}getFetchOptions(){}async redraw(e,t){await le(this._images,async(a,s)=>{a&&(await e(a,t),await this._createStageObjects(s,a.image,t))})}_imageSizeEquals(e,t,a){if(!this.maximumDataResolution)return!1;const s=v(e)/this.maximumDataResolution.x,i=R(e)/this.maximumDataResolution.y,l=s/t.width,n=i/t.height,r=s/a.width,c=i/a.height,o=Math.abs(l-r),d=Math.abs(n-c),h=he.TESTS_DISABLE_OPTIMIZATIONS?0:1.5;return o<=h&&d<=h}async _fetch(e,t){if(this.suspended)return;const a=this._extents[e],s=a.extent;this._images[e]||(this._images[e]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:C(s)});const i=this._images[e];i.loadingAbortController&&(i.loadingAbortController.abort(),i.loadingAbortController=null);const l=new U(s[0],s[1],s[2],s[3],this._spatialReference);if(l.width===0||l.height===0)return void this._clearImage(e);const n=new AbortController;i.loadingAbortController=n,ce(t,()=>n.abort());const r=n.signal,c=this._waitFetchReady(r).then(()=>{const o=z(P({requestAsImageElement:!0,pixelRatio:this._overlays[e].pixelRatio},this.getFetchOptions()),{signal:r}),{height:d,width:h}=a.imageSize;return this.layer.fetchImage(l,h,d,o)}).then(o=>{if(de(r))throw $.warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),H();return this.processResult(i,o)}).then(()=>I(i.renderExtent,s));i.loadingPromise=c,ge(c,()=>{c===i.loadingPromise&&(i.loadingPromise=null,i.loadingAbortController=null)}),this.notifyChange("updating"),await c.then(async()=>{if(r.aborted)throw H();await this._createStageObjects(e,i.image,r),this.notifyChange("updating")}).catch(o=>{throw o&&!b(o)&&$.error(o),this.notifyChange("updating"),o})}_clearImage(e){const t=this._images[e];if(t){q(t.renderGeometry)&&(this.view.basemapTerrain.overlayManager.renderer.removeGeometries([t.renderGeometry],this,M.Geometry.UPDATE),t.renderGeometry=null);const a=this.view._stage;a.remove(t.texture),t.texture=null,a.remove(t.material),t.material=null,t.loadingAbortController&&(t.loadingAbortController.abort(),t.loadingAbortController=null),t.loadingPromise=null,t.image=null,t.pixelData=null}}async _createStageObjects(e,t,a){const s=this.view._stage,i=this._images[e],l=this.view.basemapTerrain.overlayManager.renderer,n=()=>{s.remove(i.texture),i.texture=null,q(i.renderGeometry)&&(l.removeGeometries([i.renderGeometry],this,M.Geometry.UPDATE),i.renderGeometry=null)};if(t){const r=new me(t,{width:t.width,height:t.height,preMultiplyAlpha:!0,wrap:{s:F.CLAMP_TO_EDGE,t:F.CLAMP_TO_EDGE}});let c;if(await ue(this._images[e===w.INNER?w.OUTER:w.INNER].loadingPromise),V(a),e===w.INNER)c=W(i.renderExtent);else{const o=this._images[0].renderExtent;if(!o)return void n();c=Ae(o,i.renderExtent)}n(),s.add(r),await s.loadImmediate(r),i.texture=r,N(i.material)?(i.material=new ve({transparent:!0,textureId:r.id}),s.add(i.material)):i.material.setParameters({textureId:r.id}),i.renderGeometry=new ye(c,i.material),i.renderGeometry.origin=this._overlays[e].renderLocalOrigin,l.addGeometries([i.renderGeometry],this,M.Geometry.UPDATE)}else n(),s.remove(i.material),i.material=null}_isScaleRangeLayer(){return"effectiveScaleRange"in this.layer}_isScaleRangeActive(){const e=this.layer;if(!this._isScaleRangeLayer())return!1;const{minScale:t,maxScale:a}=e.effectiveScaleRange;return fe(t,a)}_clippedExtent(e,t){if(this.view.viewingMode!=="local")return I(t,e);const a=this.view.basemapTerrain;return a.ready?pe(e,a.extent,t):I(t,e)}_suspendedChangeHandler(){this.suspended?this.clear():this.refreshDebounced()}async _waitFetchReady(e){await xe(this.view,"stationary",e),V(e)}};x([_()],m.prototype,"layer",void 0),x([_()],m.prototype,"suspended",void 0),x([_({readOnly:!0})],m.prototype,"fullExtentInLocalViewSpatialReference",void 0),x([_()],m.prototype,"updating",void 0),m=x([we("esri.views.3d.layers.DynamicLayerView3D")],m);const Te=m,be=C();export{Te as q};
