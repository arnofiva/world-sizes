var Me=Object.defineProperty,Ve=Object.defineProperties;var Ee=Object.getOwnPropertyDescriptors;var J=Object.getOwnPropertySymbols;var Re=Object.prototype.hasOwnProperty,Ce=Object.prototype.propertyIsEnumerable;var Q=(e,t,i)=>t in e?Me(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,S=(e,t)=>{for(var i in t||(t={}))Re.call(t,i)&&Q(e,i,t[i]);if(J)for(var i of J(t))Ce.call(t,i)&&Q(e,i,t[i]);return e},M=(e,t)=>Ve(e,Ee(t));import{bc as G,K as c,lM as K,lN as Oe,lO as Ie,aI as C,lP as ee,iJ as W,bb as Pe,fb as ke,fd as Ge,iF as $e,iG as De,kR as ze,lQ as Ae,dS as te,lr as F,lR as Fe,lS as de,fz as ue,lT as He,c9 as We,ca as Ue,bR as j,jG as Ze,v as Le,M as g,lU as Ne,c6 as je,lV as Be,lW as Xe,A as qe,ax as Ye,J as p,d,x as B,h as Je,lX as I,eC as ie,lY as Qe,di as Ke,al as X,B as et,V as z,g as tt,a8 as it,bl as q,eM as ae,ln as me,Y,hP as ne,gv as ge,kf as P,aZ as ye,aM as ve,cf as fe,lZ as L,X as at,a_ as nt,jm as re,ed as xe,l_ as _e,l$ as rt}from"./vendor.5a0f9a12.js";import{x as st,S as ot,g as lt,p as ct}from"./EditGeometryOperations.4c2916cf.js";import{r as we}from"./drawUtils.a0d6d86a.js";import{e as N}from"./SnappingContext.6bf7685d.js";function A(e,t,i=null){return c(i)?[e,t,i]:[e,t]}function m(e,t,i=null){return c(i)?{x:e,y:t,z:i}:{x:e,y:t}}class Se{constructor(t){this.spatialReference=t}mapToLocalMultiple(t){return F(t.map(i=>this.mapToLocal(i)))}get doUnnormalization(){return!1}}class ht extends Se{constructor(t,i,a=null){super(i),this.defaultZ=a,this.transform=K(),this.transformInv=K(),this.transform=Oe(t),Ie(this.transformInv,this.transform)}makeMapPoint(t,i){return A(t,i,this.defaultZ)}mapToLocal(t){return m(this.transform[0]*t[0]+this.transform[2]*t[1]+this.transform[4],this.transform[1]*t[0]+this.transform[3]*t[1]+this.transform[5])}localToMap(t){return A(this.transformInv[0]*t.x+this.transformInv[2]*t.y+this.transformInv[4],this.transformInv[1]*t.x+this.transformInv[3]*t.y+this.transformInv[5],this.defaultZ)}}class pt extends Se{constructor(t,i){super(t.spatialReference),this.view=t,this.defaultZ=null,this.pWS=C(),this.tangentFrameUpWS=C(),this.tangentFrameRightWS=C(),this.tangentFrameForwardWS=C(),this.localFrameRightWS=C(),this.localFrameUpWS=C(),this.worldToLocalTransform=ee(),this.localToWorldTransform=ee(),this.scale=1,this.scale=t.resolution,this.referenceMapPoint=i,this.defaultZ=i.hasZ?i.z:null;const a=t.state.camera.viewRight;this.view.renderCoordsHelper.toRenderCoords(this.referenceMapPoint,this.pWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,W.X,this.tangentFrameRightWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,W.Y,this.tangentFrameUpWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,W.Z,this.tangentFrameForwardWS);const r=C();Pe(r,this.tangentFrameForwardWS,ke(a,this.tangentFrameForwardWS)),Ge(this.localFrameRightWS,a,r),$e(this.localFrameRightWS,this.localFrameRightWS),De(this.localFrameUpWS,this.tangentFrameForwardWS,this.localFrameRightWS),ze(this.worldToLocalTransform,this.localFrameRightWS,this.tangentFrameRightWS),Ae(this.localToWorldTransform,this.worldToLocalTransform)}get doUnnormalization(){return this.view.viewingMode==="global"}makeMapPoint(t,i){return A(t,i,this.defaultZ)}mapToLocal(t){const i=C();this.view.renderCoordsHelper.toRenderCoords(new G({x:t[0],y:t[1],spatialReference:this.spatialReference}),i),te(i,i,this.worldToLocalTransform);const a=this.view.renderCoordsHelper.fromRenderCoords(i,this.view.spatialReference);return c(a)?m(a.x/this.scale,a.y/this.scale):null}localToMap(t){const i=C();this.view.renderCoordsHelper.toRenderCoords(new G({x:t.x*this.scale,y:t.y*this.scale,spatialReference:this.spatialReference}),i),te(i,i,this.localToWorldTransform);const a=this.view.renderCoordsHelper.fromRenderCoords(i,this.view.spatialReference);return c(a)?A(a.x,a.y,this.defaultZ):null}}function se(e,t){if(e.type==="2d")return new ht(e.state.transform,e.spatialReference,t.length>2?t[2]:null);if(e.type==="3d"){const i=t.length>2?new G({x:t[0],y:t[1],z:t[2],spatialReference:e.spatialReference}):new G({x:t[0],y:t[1],spatialReference:e.spatialReference});return new pt(e,i)}return null}function oe(e,t){const i=new G({x:e[0],y:e[1],spatialReference:t});return e.length>2&&(i.z=e[2]),i}function dt(e,t){return new We({points:e,spatialReference:t})}function le(e,t,i){const a=new Ue({paths:e,spatialReference:t});return i&&de(a),a}function $(e,t,i,a=!0){const r=j(e);r.forEach(s=>{const o=s[0],h=s[s.length-1];Ze(o,h)&&s.length!==1||s.push(s[0])});let n=new Le({rings:r,spatialReference:t});return n.rings.forEach(s=>{Fe(s,!1,!1)||s.reverse()}),i&&de(n),a&&n.isSelfIntersecting&&ue(t)&&(n=He(n)),n}function ce(e,t,i){const a=t.mapToLocalMultiple(e),r=[],n={x:a[0].x,y:a[0].y},s={x:a[1].x,y:a[1].y},o=Math.round(s.x-n.x),h=Math.round(s.y-n.y),l=Math.max(Math.abs(o),Math.abs(h));if(i){const u={x:n.x+l,y:n.y+l},y={x:n.x-l,y:n.y-l};r.push(m(u.x,y.y),m(y.x,y.y),m(y.x,u.y),m(u.x,u.y))}else{const u={x:o>0?n.x+l:n.x-l,y:h>0?n.y+l:n.y-l};r.push(m(n.x,n.y),m(u.x,n.y),m(u.x,u.y),m(n.x,u.y))}return $([F(r.map(u=>t.localToMap(u)))],t.spatialReference,t.doUnnormalization,!0)}function ut(e,t,i){let a=t.mapToLocalMultiple(e);if(a.length===1){const h=a[0];a=[m(h.x-48,h.y+48),m(h.x+48,h.y-48),m(h.x+48,h.y-48),m(h.x-48,h.y+48)]}const r=[],n={x:a[0].x,y:a[0].y},s={x:a[1].x,y:a[1].y};if(i){const o=Math.round(s.x-n.x),h=Math.round(s.y-n.y);r.push(m(n.x-o,n.y-h),m(s.x,n.y-h),m(s.x,s.y),m(n.x-o,s.y))}else r.push(m(n.x,n.y),m(s.x,n.y),m(s.x,s.y),m(n.x,s.y));return $([F(r.map(o=>t.localToMap(o)))],t.spatialReference,t.doUnnormalization,!0)}function he(e,t,i,a){const r=t.mapToLocalMultiple(e);let n=null,s=null;if(i)n=r[0],s=r[1];else{const v=r[0],b=r[1],E=Math.round(b.x-v.x),V=Math.round(b.y-v.y),R=Math.max(Math.abs(E),Math.abs(V));n=m(E>0?v.x+R/2:v.x-R/2,V>0?v.y+R/2:v.y-R/2),s=m(Math.abs(E)>Math.abs(V)?n.x-R/2:n.x,Math.abs(E)>Math.abs(V)?n.y:n.y-R/2)}const o=t.localToMap(n),h=t.localToMap(s);if(g(o)||g(h))return null;t.doUnnormalization&&Ne([[o,h]],t.spatialReference);const l=oe(o,t.spatialReference),u=oe(h,t.spatialReference),y=je(t.spatialReference);let _=0;if(ue(t.spatialReference))_=y*Be(l,u,null);else{const v=n.x-s.x,b=n.y-s.y;_=y*Math.sqrt(v*v+b*b)*(a||1)}const T=new Xe({center:l,radius:_,radiusUnit:"meters",spatialReference:t.spatialReference});return $(T.rings,T.spatialReference,!1)}function mt(e,t,i){const a=t.mapToLocalMultiple(e),r=a[0],n=a[1],s=Math.round(n.x-r.x),o=Math.round(n.y-r.y),h=m(i?r.x:r.x+s/2,i?r.y:r.y+o/2),l=i?s:s/2,u=i?o:o/2,y=60,_=[],T=2*Math.PI/y;for(let v=0;v<y;v++){const b=Math.cos(v*T),E=Math.sin(v*T),V=m(l*b+h.x,u*E+h.y);_.push(V)}return _.push(_[0]),$([F(_.map(v=>t.localToMap(v)))],t.spatialReference,t.doUnnormalization,!1)}var k;(function(e){e[e.WhenToolEditable=0]="WhenToolEditable",e[e.WhenToolNotEditable=1]="WhenToolNotEditable",e[e.Always=2]="Always"})(k||(k={}));class gt{constructor(){this._isToolEditable=!0,this._manipulators=new qe,this._nextManipulatorId=0,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(t){this._isToolEditable=t}get length(){return this._manipulators.length}add(t,i=k.WhenToolEditable){return this.addMany([t],i)[0]}addMany(t,i=k.WhenToolEditable){return t.map(a=>{const r=this._nextManipulatorId++,n={id:r,manipulator:a,visibilityPredicate:i,attached:!1};return this._manipulators.add(n),this._attached&&this._updateManipulatorAttachment(n),r})}remove(t){if(typeof t=="number"){const a=t;for(let r=0;r<this._manipulators.length;r++)if(this._manipulators.getItemAt(r).id===a){const n=this._manipulators.splice(r,1)[0];return this._detachManipulator(n),n.id}return null}const i=t;for(let a=0;a<this._manipulators.length;a++)if(this._manipulators.getItemAt(a).manipulator===i){const r=this._manipulators.splice(a,1)[0];return this._detachManipulator(r),r.id}return null}removeAll(){this._manipulators.forEach(t=>{this._detachManipulator(t)}),this._manipulators.removeAll()}attach(){this._manipulators.forEach(t=>{this._updateManipulatorAttachment(t)}),this._attached=!0}detach(){this._manipulators.forEach(t=>{this._detachManipulator(t)}),this._attached=!1}destroy(){this._manipulators.forEach(({manipulator:t})=>{t.destroy&&t.destroy()}),this._manipulators.destroy(),this._resourceContexts=null}on(t,i){return this._manipulators.on(t,a=>{i(a)})}forEach(t){for(const i of this._manipulators.items)t(i)}some(t){return this._manipulators.items.some(t)}toArray(){const t=[];return this.forEach(i=>t.push(i.manipulator)),t}intersect(t,i){let a=null,r=Number.MAX_VALUE;return this._manipulators.forEach(({id:n,manipulator:s,attached:o})=>{if(!o||!s.interactive)return;const h=s.intersectionDistance(t,i);c(h)&&h<r&&(r=h,a={id:n,manipulator:s})}),a}findById(t){if(g(t))return null;for(const i of this._manipulators.items)if(t===i.id)return i.manipulator;return null}_updateManipulatorAttachment(t){this._isManipulatorItemVisible(t)?this._attachManipulator(t):this._detachManipulator(t)}_attachManipulator(t){t.attached||(t.manipulator.attach&&t.manipulator.attach(this._resourceContexts),t.attached=!0)}_detachManipulator(t){if(!t.attached)return;const i=t.manipulator;i.grabbing=!1,i.dragging=!1,i.hovering=!1,i.selected=!1,i.detach&&i.detach(this._resourceContexts),t.attached=!1}_isManipulatorItemVisible(t){return t.visibilityPredicate===k.Always||(this._isToolEditable?t.visibilityPredicate===k.WhenToolEditable:t.visibilityPredicate===k.WhenToolNotEditable)}}const yt=Ye.getLogger("esri.views.interactive.InteractiveToolBase");let w=class extends Je{constructor(e){super(e),this.manipulators=new gt,this.updating=!1,this.automaticManipulatorSelection=!0,this._editableFlags=new Map([[I.MANAGER,!0],[I.USER,!0]]),this._creationStartedResolver=ie(),this._creationFinishedResolver=ie()}set toolState(e){this._set("toolState",e),this._syncVisible()}get active(){return this.view!=null&&this.view.activeTool===this}set visible(e){this._get("visible")!==e&&(this._set("visible",e),this._syncVisible())}get editable(){return this.getEditableFlag(I.USER)}set editable(e){this.setEditableFlag(I.USER,e)}get created(){return this.toolState==="created"}get cursor(){return null}initialize(){this._syncVisible()}destroy(){this.manipulators.destroy(),this._set("view",null)}activate(){g(this.view)?yt.error("Can't activate tool if view is not defined."):(Qe(this.view)&&this.view.focus(),this.onActivate())}deactivate(){this.onDeactivate()}handleInputEvent(e){this.onInputEvent(e)}handleInputEventAfter(e){this.onInputEventAfter(e)}setEditableFlag(e,t){this._editableFlags.set(e,t),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),e===I.USER&&this.notifyChange("editable"),this.onEditableChange()}getEditableFlag(e){return this._editableFlags.get(e)}whenCreationStarted(){return this._creationStartedResolver.promise}whenCreated(){return this._creationFinishedResolver.promise}rejectCreation(e){this.toolState!=="pending"&&this.toolState!=="creating"||this._creationStartedResolver.resolve(this),this._creationFinishedResolver.reject(e)}onActivate(){}onDeactivate(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(e){}onInputEventAfter(e){}get internallyEditable(){return this.getEditableFlag(I.USER)&&this.getEditableFlag(I.MANAGER)}startToolCreation(){if(this.toolState==="pending")return this._creationStartedResolver.resolve(this),void(this.toolState="creating");throw new Error(`Unexpected tool state ${this.toolState}`)}finishToolCreation(){switch(this.toolState){case"pending":this.startToolCreation();case"creating":this.created||this._creationFinishedResolver.resolve(this),this.toolState="created";break;case"created":break;default:throw new Error(`Unexpected tool state ${this.toolState}`)}}_syncVisible(){if(this.toolState!=="pending"){if(this.visible)this._show();else if(this._hide(),this.active)return void(this.view.activeTool=null)}}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.visible?this.manipulators.attach():this.manipulators.detach()}};p([d({value:"pending"})],w.prototype,"toolState",null),p([d({constructOnly:!0})],w.prototype,"view",void 0),p([d({readOnly:!0})],w.prototype,"active",null),p([d({value:!0})],w.prototype,"visible",null),p([d({value:!0})],w.prototype,"editable",null),p([d({readOnly:!0})],w.prototype,"created",null),p([d({readOnly:!0})],w.prototype,"manipulators",void 0),p([d({readOnly:!0})],w.prototype,"updating",void 0),p([d()],w.prototype,"cursor",null),p([d()],w.prototype,"automaticManipulatorSelection",void 0),w=p([B("esri.views.interactive.InteractiveToolBase")],w);let f=class extends Ke(X.EventedMixin(w)){constructor(e){super(e),this._graphic=null,this.defaultZ=0,this.geometryType=null,this.hasZ=!0,this.mode=null,this.snappingManager=null,this.snapToScene=!1}initialize(){this.internalGraphicsLayer=new et({listMode:"hide",internal:!0}),this.view.map.layers.add(this.internalGraphicsLayer),this.drawOperation=this.makeDrawOperation(),this.handles.add([this.drawOperation.on("vertex-add",e=>this.onVertexAdd(e)),this.drawOperation.on("vertex-remove",e=>this.onVertexRemove(e)),this.drawOperation.on("vertex-update",e=>this.onVertexUpdate(e)),this.drawOperation.on("cursor-update",e=>this.onCursorUpdate(e)),this.drawOperation.on("complete",e=>this.onComplete(e))]),this.finishToolCreation()}destroy(){this.drawOperation=z(this.drawOperation),this._destroyAllVisualisations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=z(this.internalGraphicsLayer),this._set("view",null)}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(e){this._set("centered",e),this._updateGraphic()}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}set forceUniformSize(e){this._set("forceUniformSize",e),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(e){this._set("graphicSymbol",e),c(this._graphic)&&(this._graphic.symbol=e)}get updating(){var e,t;return(e=(t=this.drawOperation)==null?void 0:t.updating)!=null&&e}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(e){this.drawOperation.onInputEvent(e)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo()}_createGraphic(e){this._graphic=new tt(M(S({},this.graphicProperties),{geometry:e,symbol:this.graphicSymbol})),this.internalGraphicsLayer.add(this._graphic),this.handles.add(this.initializeGraphic(this._graphic)),this.notifyChange("graphic"),this.handles.add(it(()=>{c(this._graphic)&&(this.internalGraphicsLayer.remove(this._graphic),this._graphic=z(this._graphic))}),U)}_destroyAllVisualisations(){this.handles.remove(O.outline),this.handles.remove(O.regularVertices),this.handles.remove(O.activeVertex),this.handles.remove(U)}_getCreateOperationGeometry(e={operationComplete:!1}){if(this.drawOperation==null||this.drawOperation.numVertices===0)return null;const t=this.drawOperation.stagedVertex,i=this.drawOperation.committedVertices,a=i.slice();c(t)&&a.push(this.drawOperation.coordinateHelper.pointToArray(t));const r=c(t)?this.drawOperation.coordinateHelper.pointToArray(t):i.splice(-1)[0],n={regularVertices:null,activeVertex:null,full:null,outline:null},s=a.length,o=this.drawOperation.spatialReference,h=this.view.type==="3d"&&this.view.viewingMode==="global";switch(this.geometryType){case"point":n.regularVertices=i,n.activeVertex=r,n.full=this.drawOperation.coordinateHelper.arrayToPoint(a[0]);break;case"multipoint":n.regularVertices=i,n.activeVertex=r,s>0&&(n.full=dt(a,o));break;case"polyline":n.regularVertices=i,n.activeVertex=r,s>0&&(n.full=le([a],o,h));break;case"polygon":n.regularVertices=i,n.activeVertex=r,s>0&&(n.full=$([a],o,h,!0));break;case"circle":if(s>0){const l=se(this.view,a[0]);if(s===1&&e.operationComplete){const u=a[0],y=l.makeMapPoint(u[0]+pe*this.view.resolution,u[1]);n.full=he([u,y],l,!0)}else s===2&&(n.full=this.forceUniformSize?he(a,l,this.centered):mt(a,l,this.centered))}break;case"rectangle":if(s>0){const l=se(this.view,a[0]);if(s===1&&e.operationComplete){const u=a[0],y=l.makeMapPoint(u[0]+pe*this.view.resolution,u[1]);n.full=ce([u,y],l,!0)}else s===2&&(n.full=this.forceUniformSize?ce(a,l,this.centered):ut(a,l,this.centered))}break;default:return null}switch(this.geometryType){case"point":case"multipoint":break;case"polyline":case"polygon":s>1&&(n.outline=le([a],o,h));break;case"circle":case"rectangle":c(n.full)&&n.full.type==="polygon"&&(n.outline=$(n.full.rings,o,h))}return n}initializeGraphic(e){return null}onComplete(e){this._updateGraphic();let t=null;if(this.drawOperation.isCompleted){const i=this._getCreateOperationGeometry({operationComplete:!0});c(i)&&(g(this._graphic)?this._createGraphic(i.full):this._graphic.geometry=i.full,t=q(this._graphic).clone())}this.emit("complete",S({graphic:t},e))}onCursorUpdate(e){this._updateGraphic(),this.emit("cursor-update",e)}onDeactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}onVertexAdd(e){this._updateGraphic(),this.emit("vertex-add",e)}onVertexRemove(e){this._updateGraphic(),this.emit("vertex-remove",e)}onVertexUpdate(e){this._updateGraphic(),this.emit("vertex-update",e)}_updateGraphic(){const e=this._getCreateOperationGeometry();g(e)?this._destroyAllVisualisations():(c(e.outline)?this.handles.add(this.onOutlineChanged(e.outline),O.outline):this.handles.remove(O.outline),c(e.regularVertices)?this.handles.add(this.onRegularVerticesChanged(e.regularVertices),O.regularVertices):this.handles.remove(O.regularVertices),c(e.activeVertex)?this.handles.add(this.onActiveVertexChanged(e.activeVertex),O.activeVertex):this.handles.remove(O.activeVertex),c(e.full)?g(this._graphic)?this._createGraphic(e.full):this._graphic.geometry=e.full:this.handles.remove(U))}};p([d({value:!0})],f.prototype,"centered",null),p([d({nonNullable:!0})],f.prototype,"defaultZ",void 0),p([d()],f.prototype,"drawOperation",void 0),p([d({value:!0})],f.prototype,"enabled",null),p([d({value:!0})],f.prototype,"forceUniformSize",null),p([d({constructOnly:!0})],f.prototype,"geometryType",void 0),p([d()],f.prototype,"graphic",null),p([d({constructOnly:!0})],f.prototype,"graphicProperties",void 0),p([d()],f.prototype,"graphicSymbol",null),p([d({constructOnly:!0})],f.prototype,"hasZ",void 0),p([d({constructOnly:!0})],f.prototype,"mode",void 0),p([d()],f.prototype,"snappingManager",void 0),p([d()],f.prototype,"snapToScene",void 0),p([d({readOnly:!0})],f.prototype,"type",void 0),p([d({readOnly:!0})],f.prototype,"updating",null),p([d({constructOnly:!0,nonNullable:!0})],f.prototype,"view",void 0),f=p([B("esri.views.draw.DrawGraphicTool")],f);const U="create-operation-graphic",O={outline:"outline-visual",regularVertices:"regular-vertices-visual",activeVertex:"active-vertex-visual"};function kt(e){switch(e){case"point":case"polyline":case"polygon":case"multipoint":return e;case"circle":case"rectangle":return"segment";default:return null}}const pe=48;class vt{constructor({grabbableForEvent:t}){this.events=new X,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0,this.grabbableForEvent=t}intersectionDistance(t,i){return 0}attach(){}detach(){}}const Te="click";function ft(e,t){let i=null,a=null;return r=>{if(r.action==="cancel")return void(c(a)&&(a.execute({action:"cancel"}),i=null,a=null));const n={action:r.action,screenStart:r.start,screenEnd:r.screenPoint};r.action==="start"&&g(i)&&(i=new D,a=new D,t(e,i,a,r.pointerType,n)),c(i)&&i.execute(n),r.action==="end"&&c(i)&&(i=null,a=null)}}function Z(e,t){return e.events.on("drag",ft(e,t))}function Gt(e,t){const i=[e.x,e.y,e.z],a=t,r=[Math.cos(a),Math.sin(a)],n=Math.sqrt(r[0]*r[0]+r[1]*r[1]);if(n===0)return null;r[0]/=n,r[1]/=n;const s=o=>{const h=(o.x-i[0])*r[0]+(o.y-i[1])*r[1];o.x=i[0]+h*r[0],o.y=i[1]+h*r[1]};return o=>(s(o.mapStart),s(o.mapEnd),o)}function xt(e,t){let i=null;return a=>{if(a.action==="start"&&(i=_t(e,a.mapStart.spatialReference,t)),g(i))return null;const r=a.mapEnd.x-a.mapStart.x,n=a.mapEnd.y-a.mapStart.y,s=a.mapEnd.z-a.mapStart.z;return i.move(r,n,s),M(S({},a),{translationX:r,translationY:n,translationZ:s})}}function be(e,t){return g(e)?null:e.spatialReference.equals(t)?e.clone():Y(e,t)}function _t(e,t,i){const a=e.geometry;if(g(a))return null;if(a.type==="mesh")return wt(e,a,t,i);const r=be(a,t),n=a.spatialReference;return g(r)?null:{move:(s,o,h)=>{const l=we(r.clone(),s,o,h);l.spatialReference.equals(n)?e.geometry=l:e.geometry=Y(l,n)}}}function wt(e,t,i,a){if(c(t.transform))return St(e,t,t.transform,i);if(!t.spatialReference.equals(i))return null;let r=0,n=0,s=0;return{move:(o,h,l)=>{const u=o-r,y=h-n,_=l-s;if(u||y||_){const T=new G(t.origin.x+u,t.origin.y+y,t.origin.z+_,t.origin.spatialReference);t.centerAt(T,{geographic:a===ge.Global}),e.notifyGeometryChanged(),r=o,n=h,s=l}}}}function St(e,t,i,a){const r=be(i.getOriginPoint(t.spatialReference),a),n=t.spatialReference;return g(r)?null:{move:(s,o,h)=>{const l=we(r.clone(),s,o,h);if(l.spatialReference.equals(n))i.origin=ne(l.x,l.y,l.z);else{const u=Y(l,n);c(u)&&(i.origin=ne(u.x,u.y,u.z))}e.notifyMeshTransformChanged(),e.notifyGeometryChanged()}}}function $t(e,t){const i=e.map(a=>q(xt(a,t))).filter(a=>c(a));return a=>{const r=a.mapEnd.x-a.mapStart.x,n=a.mapEnd.y-a.mapStart.y,s=a.mapEnd.z-a.mapStart.z;return i.forEach(o=>o(a)),M(S({},a),{translationX:r,translationY:n,translationZ:s})}}function Tt(e,t){const i=new Map;for(const a of t)i.set(a,j(e[a]));return a=>(i.forEach((r,n)=>{e[n]=r}),a)}function bt(e){return c(e.geometry)&&e.geometry.type==="mesh"?Mt(e,e.geometry):Tt(e,["geometry"])}function Mt(e,t){const i=c(t.transform)?t.transform.clone():null,a=t.vertexAttributes.clonePositional();return r=>(t.transform=i,t.vertexAttributes=a,e.notifyGeometryChanged(),r)}function Dt(e){const t=e.map(i=>q(bt(i))).filter(i=>c(i));return i=>(t.forEach(a=>a(i)),i)}function zt(){let e=0,t=0,i=0;return a=>{a.action==="start"&&(e=a.mapStart.x,t=a.mapStart.y,i=a.mapStart.z);const r=a.mapEnd.x-e,n=a.mapEnd.y-t,s=a.mapEnd.z-i;return e=a.mapEnd.x,t=a.mapEnd.y,i=a.mapEnd.z,M(S({},a),{mapDeltaX:r,mapDeltaY:n,mapDeltaZ:s,mapDeltaSpatialReference:a.mapStart.spatialReference})}}function At(){let e=0,t=0;return i=>{i.action==="start"&&(e=i.screenStart.x,t=i.screenStart.y);const a=i.screenEnd.x-e,r=i.screenEnd.y-t;return e=i.screenEnd.x,t=i.screenEnd.y,M(S({},i),{screenDeltaX:a,screenDeltaY:r})}}function Ft(e,t){let i=null,a=0,r=0;return n=>{if(n.action==="start"&&(i=e.toScreen(t),i.x<0||i.x>e.width||i.y<0||i.y>e.height?i=null:(a=n.screenStart.x-i.x,r=n.screenStart.y-i.y)),i==null)return null;const s=ae(n.screenEnd.x-a,0,e.width),o=ae(n.screenEnd.y-r,0,e.height),h=me(s,o);return n.screenStart=i,n.screenEnd=h,n}}class D{constructor(){this.execute=()=>{}}next(t,i=new D){return c(t)&&(this.execute=a=>{const r=t(a);c(r)&&i.execute(r)}),i}}class Vt{constructor(){this.next=new D}createSnapDragEventPipelineStep({predicate:t=()=>!0,cancel:i,snappingManager:a,snappingContext:r,updatingHandles:n}){if(g(a))return l=>l;let s=null,o=null;const h=()=>{s=P(s),a.doneSnapping(),c(o)&&o.frameTask.remove(),o=null};return i.next(l=>(h(),l)),this.next=new D,l=>{if(!t(l))return l;if(s=P(s),l.action==="start"){const u=a.view.type==="3d"?a.view.resourceController.scheduler.registerTask(ye.SNAPPING):ve;o={context:new N({editGeometryOperations:r.editGeometryOperations,elevationInfo:r.elevationInfo,pointer:r.pointer,vertexHandle:c(l.info)?l.info.handle:null,excludeFeature:r.excludeFeature,visualizer:r.visualizer}),originalPos:c(l.snapOrigin)?r.coordinateHelper.vectorToDehydratedPoint(l.snapOrigin):l.mapStart,frameTask:u}}if(c(o)){const u=o.context.coordinateHelper.vectorToDehydratedPoint(o.context.coordinateHelper.arrayToVector([o.originalPos.x,o.originalPos.y,o.originalPos.z]));u.x+=l.mapEnd.x-l.mapStart.x,u.y+=l.mapEnd.y-l.mapStart.y;const y=l.mapStart.x-o.originalPos.x,_=l.mapStart.y-o.originalPos.y,T=M(S({},l),{action:"udpate"}),v=o.context,b=a.update(u,o.context);if(l.mapEnd.x=b.x+y,l.mapEnd.y=b.y+_,l.action!=="end"){const E=o.frameTask;s=fe(async V=>{const R=await E.schedule(()=>a.snap(u,v,V),V);if(R.valid){const H=await E.schedule(()=>R.apply(),V);L(H,b)||(T.mapEnd.x=H.x+y,T.mapEnd.y=H.y+_,this.next.execute(T))}}),n.addPromise(s.promise)}}return l.action==="end"&&h(),l}}}let x=class extends X.EventedMixin(at){constructor(e){super(e),this._createOperationCompleted=!1,this._pointerDownStates=new Set,this._snappingPipeline=new Vt,this._snappingTask=null,this._stagedVertex=null,this.snapToSceneEnabled=null,g(e.elevationInfo)&&(this.elevationInfo={mode:e.hasZ?"absolute-height":"on-the-ground",offset:0})}initialize(){var e,t;this.coordinateHelper=st(this.hasZ,this.hasM,this.view.spatialReference);const i=this.view.type==="3d"?(e=this.view)==null||(t=e.resourceController)==null?void 0:t.scheduler:null;this._frameTask=i?i.registerTask(ye.SNAPPING):ve;const a="viewingMode"in this.view.state?this.view.state.viewingMode:ge.Local,r=this.geometryType==="segment"||this.geometryType==="multipoint"?"polyline":this.geometryType;this._editGeometryOperations=new ot(new lt(r,this.coordinateHelper,a)),this._activeComponent=new ct(this.spatialReference,a),this._editGeometryOperations.data.components.push(this._activeComponent),this.handles.add(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],n=>{const s=n.vertices.map(h=>({componentIndex:0,vertexIndex:h.index,coordinates:this.coordinateHelper.vectorToArray(h.pos)})),o=s.map(h=>h.coordinates);switch(n.type){case"vertex-add":this.emit(n.type,M(S({},n),{added:o,vertices:s}));break;case"vertex-update":this.emit(n.type,M(S({},n),{updated:o,vertices:s}));break;case"vertex-remove":this.emit(n.type,M(S({},n),{removed:o,vertices:s}))}})),this._manipulator=new vt({grabbableForEvent:n=>this.drawingMode!=="click"||n.pointerType==="touch"&&this._snappingEnabled&&this._pointerDownStates.size===1}),this.manipulators.add(this._manipulator),this._manipulator.grabbable=this.geometryType!=="point",this.handles.add([this._createManipulatorDragPipeline(this._manipulator),this._manipulator.events.on("immediate-click",n=>this._onImmediateClick(n)),this._manipulator.events.on("immediate-double-click",n=>this._onImmediateDoubleClick(n))])}destroy(){this._editGeometryOperations=z(this._editGeometryOperations),this._frameTask=nt(this._frameTask)}get _snappingEnabled(){return c(this.snappingManager)&&this.snappingManager.options.effectiveEnabled}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activeComponent.vertices.map(e=>this.coordinateHelper.vectorToArray(e.pos))}set drawingMode(e){this._set("drawingMode",e!=null?e:Te)}get hasStagedVertex(){return c(this._stagedVertex)}get interactive(){return this._manipulator.interactive}set interactive(e){this._manipulator.interactive=e}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activeComponent.vertices.length}get numVertices(){return c(this._stagedVertex)?this._activeComponent.vertices.length+1:this._activeComponent.vertices.length}get spatialReference(){return this.view.spatialReference}get stagedVertex(){return this._stagedVertex}set stagedVertex(e){if(g(e))this.discardStagedVertex();else if(!c(this._stagedVertex)||!L(this._stagedVertex,e)){if(g(this._stagedVertex))this._stagedVertex=j(e);else{if(L(this._stagedVertex,e))return;this._stagedVertex.x=e.x,this._stagedVertex.y=e.y,this._stagedVertex.z=e.z,this._stagedVertex.m=e.m,this._stagedVertex.hasZ=e.hasZ,this._stagedVertex.hasM=e.hasM,this._stagedVertex.spatialReference=e.spatialReference}this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activeComponent.vertices.length,coordinates:this.coordinateHelper.pointToArray(e)}],operation:"apply",type:"vertex-update"})}}get updating(){return this.updatingHandles.updating}get vertices(){const e=this.committedVertices;return c(this._stagedVertex)&&e.push(this.coordinateHelper.pointToArray(this._stagedVertex)),e}cancel(){this.complete({aborted:!0})}commitStagedVertex(){if(this._snappingTask=P(this._snappingTask),c(this._stagedVertex)){const e=this._stagedVertex;this._stagedVertex=null,this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(e))}}complete(e){const t=e&&e.aborted||!1;P(this._snappingTask),c(this.snappingManager)&&this.snappingManager.doneSnapping(),this.geometryType==="segment"||this.geometryType==="point"?this.commitStagedVertex():this.discardStagedVertex();const i=this.geometryType==="multipoint"&&this.numVertices===0||this.geometryType==="polyline"&&this.numVertices<2||this.geometryType==="polygon"&&this.numVertices<3;this._createOperationCompleted=!i,(this.isCompleted||t)&&this.emit("complete",{vertices:this.vertices.map((a,r)=>({componentIndex:0,vertexIndex:r,coordinates:a})),aborted:t,type:"complete"})}discardStagedVertex(){this._stagedVertex=null}onInputEvent(e){switch(e.type){case"pointer-down":this._pointerDownStates.add(e.pointerId);break;case"pointer-up":this._pointerDownStates.delete(e.pointerId)}switch(e.type){case"pointer-move":return this._onPointerMove(e);case"hold":return this._onHold(e)}}redo(){this._editGeometryOperations.redo()}undo(){c(this.snappingManager)&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_closeOnClickVertexIndex(e){const t=this._activeComponent;if(this.geometryType==="polygon"&&t.vertices.length>2){if(this._vertexWithinPointerDistance(t.vertices[0].pos,e))return 0;if(this._vertexWithinPointerDistance(t.vertices[t.vertices.length-1].pos,e))return t.vertices.length-1}return null}_createManipulatorDragPipeline(e){switch(this.drawingMode){case"click":return this._createManipulatorDragPipelineClick(e);case"freehand":return this._createManipulatorDragPipelineFreehand(e);case"hybrid":return this._createManipulatorDragPipelineHybrid(e)}}_createManipulatorDragPipelineClick(e){return Z(e,(t,i,a,r)=>{const n=r==="touch"&&this._snappingEnabled;!this.isCompleted&&n&&(i.next(this._screenToMapDragEventStep()).next(s=>(s.action==="start"&&(this.stagedVertex=s.mapStart,(this.geometryType==="segment"||n&&this.numVertices===0)&&this.commitStagedVertex()),s)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>n,cancel:a,snappingManager:this.snappingManager,snappingContext:new N({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:r,visualizer:this.snappingVisualizer}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(s=>(n&&(this.stagedVertex=s.mapEnd,s.action==="end"&&this.commitStagedVertex()),s)).next(s=>(s.action==="end"&&(this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()),s)),a.next(()=>{n&&c(this.snappingManager)&&this.snappingManager.doneSnapping()}))})}_createManipulatorDragPipelineFreehand(e){return Z(e,(t,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next(a=>(a.action==="start"&&(g(this.stagedVertex)&&(this.stagedVertex=a.mapStart),this.geometryType==="segment"&&this.commitStagedVertex()),a)).next(a=>{switch(a.action){case"start":case"update":this.stagedVertex=a.mapEnd,this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.complete()}return a})})}_createManipulatorDragPipelineHybrid(e){return Z(e,(t,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next(a=>(a.action==="start"&&(g(this.stagedVertex)&&(this.stagedVertex=a.mapStart),this.commitStagedVertex()),a)).next(a=>{switch(a.action){case"start":case"update":this.stagedVertex=a.mapEnd,this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()}return a})})}_getDrawSurface(){if(g(this.elevationDrawSurface))return this.drawSurface;if(!this.coordinateHelper.hasZ)return this.elevationDrawSurface.defaultZ=null,this.elevationDrawSurface;let e=this.defaultZ,t=!1;c(this.elevationInfo)&&this.elevationInfo.mode==="absolute-height"&&(t=!0),c(this.snapToSceneEnabled)&&(t=this.snapToSceneEnabled),c(this.elevationInfo)&&this.elevationInfo.mode==="on-the-ground"&&(t=!1);const i=this._activeComponent.vertices.length;return(this.geometryType==="segment"||this.geometryType==="polygon")&&i>0&&(e=this.coordinateHelper.getZ(this._activeComponent.vertices[0].pos),t=!1),t?this.drawSurface:(this.elevationDrawSurface.defaultZ=e,this.elevationDrawSurface)}_mapToScreen(e){return this._getDrawSurface().mapToScreen(e)}_onHold(e){P(this._snappingTask),this.drawingMode==="click"&&e.pointerType==="touch"&&this._snappingEnabled&&(this.stagedVertex=e.mapPoint),e.stopPropagation()}_onImmediateClick(e){if(e.pointerType==="mouse"&&e.button===2||this._manipulator.dragging)return;const t=this._activeComponent,i=this._closeOnClickVertexIndex(e.screenPoint);if(c(i))return e.stopPropagation(),this.discardStagedVertex(),void this.complete();const a=this._screenToMap(e.screenPoint);if(c(a))switch(this.drawingMode){case"freehand":this.geometryType==="point"&&(this.hasStagedVertex?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(a)),this.complete());break;case"click":case"hybrid":this._snappingTask=P(this._snappingTask),this.hasStagedVertex?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(a)),(this.geometryType==="point"||this.geometryType==="segment"&&t.vertices.length===2||this.geometryType==="segment"&&this.drawingMode==="hybrid"&&t.vertices.length===1)&&this.complete()}e.stopPropagation()}_onImmediateDoubleClick(e){this._manipulator.dragging||this.geometryType==="point"||(this.complete(),e.stopPropagation())}_onPointerMove(e){if(P(this._snappingTask),this._manipulator.dragging||this._pointerDownStates.has(e.pointerId)||this._manipulator.grabbing||!this._manipulator.interactive)return;const t=me(e.x,e.y),i=this._closeOnClickVertexIndex(t);if(c(i)){this.discardStagedVertex();const a={componentIndex:0,vertexIndex:i,coordinates:this.coordinateHelper.vectorToArray(this._activeComponent.vertices[i].pos)};this.emit("cursor-update",{updated:null,vertices:[a],operation:"apply",type:"vertex-update"})}else{const a=this._screenToMap(t);if(this._manipulator.cursor=c(a)?"crosshair":null,c(a))if(c(this.snappingManager)){const r=this.snappingManager,n=new N({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:e.pointerType,visualizer:this.snappingVisualizer});this.stagedVertex=r.update(a,n),this._snappingTask=fe(async s=>{const o=await this._frameTask.schedule(()=>r.snap(a,n,s),s);o.valid&&await this._frameTask.schedule(()=>{this.stagedVertex=o.apply()},s)}),this.updatingHandles.addPromise(this._snappingTask.promise)}else this.stagedVertex=a}e.stopPropagation()}_screenToMap(e){return this._getDrawSurface().screenToMap(e)}_screenToMapDragEventStep(){let e=null;return t=>{if(t.action==="start"&&(e=this._screenToMap(t.screenStart)),g(e))return null;const i=this._screenToMap(t.screenEnd);return c(i)?M(S({},t),{mapStart:e,mapEnd:i}):null}}_vertexWithinPointerDistance(e,t){const a=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(e));return!!c(a)&&Et(a,t,25)}};function Et(e,t,i){const a=e.x-t.x,r=e.y-t.y;return a*a+r*r<=i}p([d()],x.prototype,"defaultZ",void 0),p([d({value:Te})],x.prototype,"drawingMode",null),p([d({constructOnly:!0})],x.prototype,"elevationDrawSurface",void 0),p([d({constructOnly:!0})],x.prototype,"elevationInfo",void 0),p([d({constructOnly:!0})],x.prototype,"geometryType",void 0),p([d({constructOnly:!0})],x.prototype,"hasM",void 0),p([d({constructOnly:!0})],x.prototype,"hasZ",void 0),p([d({constructOnly:!0})],x.prototype,"manipulators",void 0),p([d({constructOnly:!0})],x.prototype,"drawSurface",void 0),p([d({constructOnly:!0})],x.prototype,"snappingManager",void 0),p([d({constructOnly:!0})],x.prototype,"snappingVisualizer",void 0),p([d()],x.prototype,"snapToSceneEnabled",void 0),p([d({readOnly:!0})],x.prototype,"updating",null),p([d({constructOnly:!0})],x.prototype,"view",void 0),x=p([B("esri.views.draw.DrawOperation")],x);class Ht{constructor(t,i,a,r=null){this.elevationInfo=t,this.defaultZ=i,this.view=a,this.excludeGraphics=r}screenToMap(t){if(c(this.defaultZ))return this.view.sceneIntersectionHelper.intersectElevationFromScreen(re(t.x,t.y),this.elevationInfo,this.defaultZ,this.excludeGraphics);const i=this.view.sceneIntersectionHelper.intersectElevationFromScreen(re(t.x,t.y),this.elevationInfo,0,this.excludeGraphics);return c(i)&&(i.z=void 0),i}mapToScreen(t){const i=xe(t.x,t.y,_e(this.view,t,this.elevationInfo),t.spatialReference);return this.view.toScreen(i)}}class Wt{constructor(t,i,a=[]){this.view=t,this.elevationInfo=i,this.exclude=a}screenToMap(t){const i=this.view.toMap(t,{exclude:this.exclude});return c(i)&&(i.z=rt(i,this.view,this.elevationInfo)),i}mapToScreen(t){let i=t;return c(this.elevationInfo)&&(i=xe(t.x,t.y,_e(this.view,t,this.elevationInfo),t.spatialReference)),this.view.toScreen(i)}}class Ut{constructor(t){this.view=t,this.screenToMap=i=>t.toMap(i),this.mapToScreen=i=>t.toScreen(i)}}export{Ft as C,zt as D,kt as G,Dt as M,$t as R,f as _,D as a,x as b,Ut as c,Gt as d,At as e,w as f,Vt as g,Wt as n,Z as p,Ht as r,bt as w,xt as x};
