import{qJ as K,fA as Q,at as Z,qK as $,bO as ee,qL as p,hE as I,qM as te,l as ae,oG as re,qN as ie,qO as E,ft as J,is as ne}from"./vendor.5a0f9a12.js";import{r as N,m as se,H as oe,o as ce}from"./cimAnalyzer.043f2b67.js";import{J as V,s as le,$ as A,t as W,a as me,b as he}from"./CIMSymbolHelper.aa89c22c.js";import"./enums.c01b5663.js";import"./BidiEngine.eb17884f.js";import"./number.dc47462b.js";const fe=512;class ye{constructor(e){this._resourceManager=e}dispose(){this._rasterizationCanvas=null}rasterizeJSONResource(e,t,o){if(this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),e.type==="simple-fill"||e.type==="esriSFS"){const[m,n,h]=V.rasterizeSimpleFill(this._rasterizationCanvas,e.style,t);return{size:[n,h],image:new Uint32Array(m.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0}}if(e.type==="simple-line"||e.type==="esriSLS"||e.type==="line"&&e.dashTemplate){let m,n;if(e.type==="simple-line"||e.type==="esriSLS")switch(m=le(e.style,e.cap),e.cap){case"butt":n="Butt";break;case"square":n="Square";break;default:n="Round"}else m=e.dashTemplate,n=e.cim.capStyle;const[h,f,u]=V.rasterizeSimpleLine(m,n);return{size:[f,u],image:new Uint32Array(h.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let a,r,s;if(e.type==="simple-marker"||e.type==="esriSMS"||e.type==="line-marker"?(a=A.fromSimpleMarker(e),s=N(a)):e.cim&&e.cim.type==="CIMHatchFill"?(a=A.fromCIMHatchFill(e.cim),r=new W(a.frame.xmin,-a.frame.ymax,a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin)):e.cim.markerPlacement&&e.cim.markerPlacement.type==="CIMMarkerPlacementInsidePolygon"?(a=A.fromCIMInsidePolygon(e.cim),r=new W(a.frame.xmin,-a.frame.ymax,a.frame.xmax-a.frame.xmin,a.frame.ymax-a.frame.ymin)):(a=e.cim,s=N(a)),s&&!o){const[m,n,h]=se(s);return m?{size:[n,h],image:new Uint32Array(m.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}:null}const[i,c,l,y,d]=A.rasterize(this._rasterizationCanvas,a,r,this._resourceManager,!o);return i?{size:[c,l],image:new Uint32Array(i.buffer),sdf:!1,simplePattern:!1,anchorX:y,anchorY:d}:null}rasterizeImageResource(e,t,o,a){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=t;const r=this._rasterizationCanvas.getContext("2d");o instanceof ImageData?r.putImageData(o,0,0):(o.setAttribute("width",`${e}px`),o.setAttribute("height",`${t}px`),r.drawImage(o,0,0,e,t));const s=r.getImageData(0,0,e,t),i=new Uint8Array(s.data);if(a){for(const n of a)if(n&&n.oldColor&&n.oldColor.length===4&&n.newColor&&n.newColor.length===4){const[h,f,u,M]=n.oldColor,[z,w,x,P]=n.newColor;if(h===z&&f===w&&u===x&&M===P)continue;for(let C=0;C<i.length;C+=4)h===i[C]&&f===i[C+1]&&u===i[C+2]&&M===i[C+3]&&(i[C]=z,i[C+1]=w,i[C+2]=x,i[C+3]=P)}}let c;for(let n=0;n<i.length;n+=4)c=i[n+3]/255,i[n]=i[n]*c,i[n+1]=i[n+1]*c,i[n+2]=i[n+2]*c;let l=i,y=e,d=t;const m=fe;if(y>=m||d>=m){const n=y/d;n>1?(y=m,d=Math.round(m/n)):(d=m,y=Math.round(m*n)),l=new Uint8Array(4*y*d);const h=new Uint8ClampedArray(l.buffer);K(i,e,t,h,y,d,!1)}return{size:[y,d],image:new Uint32Array(l.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}var F;(function(g){g.Legend="legend",g.Preview="preview"})(F||(F={}));const D=(g,e,t)=>{if(g&&g.targetSize){let o;if(t){const a=Math.max(t.frame.xmax-t.frame.xmin,t.frame.ymax-t.frame.ymin);o=g.targetSize/I(a)}else o=g.targetSize/e.referenceSize;return o}return g&&g.scaleFactor?g.scaleFactor:1},j={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class xe{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._pictureMarkerCache=new Map,this._textRasterizer=new me,this._cimResourceManager=new he,this._rasterizer=new ye(this._cimResourceManager)}async rasterizeCIMSymbolAsync(e,t,o,a,r,s,i,c){a=a||(t?t.centroid!=null?"esriGeometryPolygon":Q(t.geometry):null)||ge(e);const l=await this.analyzeCIMSymbol(e,t?ue(t.attributes):null,o,a,c);return this.rasterizeCIMSymbol(l,t,a,r,s,i)}async analyzeCIMSymbol(e,t,o,a,r){const s=[],i=t?{geometryType:a,spatialReference:this._spatialReference,fields:t}:null;let c;await oe(e.data,i,this._cimResourceManager,s,this._avoidSDF),Z(r);for(const l of s)l.cim.type!=="CIMPictureMarker"&&l.cim.type!=="CIMPictureFill"&&l.cim.type!=="CIMPictureStroke"||(c||(c=[]),c.push(this._fetchPictureMarkerResource(l,r))),o&&l.type==="text"&&typeof l.text=="string"&&l.text.indexOf("[")>-1&&(l.text=$(o,l.text,l.cim.textCase));return c&&await Promise.all(c),s}async _fetchPictureMarkerResource(e,t){const o=e.materialHash;if(!this._pictureMarkerCache.get(o)){const a=(await ee(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(o,a)}}rasterizeCIMSymbol(e,t,o,a,r,s){const i=[];for(const c of e){a&&typeof a.scaleFactor=="function"&&(a.scaleFactor=a.scaleFactor(t,r,s));const l=this._getRasterizedResource(c,t,o,a,r,s);if(!l)continue;let y=0,d=l.anchorX||0,m=l.anchorY||0,n=!1,h=0,f=0;if(o==="esriGeometryPoint"){const u=D(a,c,null);if(h=p(c.offsetX,t,r,s)*u||0,f=p(c.offsetY,t,r,s)*u||0,c.type==="marker")y=p(c.rotation,t,r,s)||0,n=!!c.rotateClockwise&&c.rotateClockwise;else if(c.type==="text"){if(y=p(c.angle,t,r,s)||0,c.horizontalAlignment!==void 0)switch(c.horizontalAlignment){case"left":d=-.5;break;case"right":d=.5;break;default:d=0}if(c.verticalAlignment!==void 0)switch(c.verticalAlignment){case"top":m=.5;break;case"bottom":m=-.5;break;case"baseline":m=-.25;break;default:m=0}}}l!=null&&i.push({angle:y,rotateClockWise:n,anchorX:d,anchorY:m,offsetX:h,offsetY:f,rasterizedResource:l})}return this.getSymbolImage(i)}getSymbolImage(e){const t=document.createElement("canvas"),o=t.getContext("2d");let a=0,r=0,s=0,i=0;const c=[];for(let m=0;m<e.length;m++){const n=e[m],h=n.rasterizedResource;if(!h)continue;const f=h.size,u=n.offsetX,M=n.offsetY,z=n.anchorX,w=n.anchorY,x=n.rotateClockWise||!1;let P=n.angle,C=I(u)-f[0]*(.5+z),_=I(M)-f[1]*(.5+w),b=C+f[0],k=_+f[1];if(P){x&&(P=-P);const v=Math.sin(P*Math.PI/180),S=Math.cos(P*Math.PI/180),Y=C*S-_*v,T=C*v+_*S,L=C*S-k*v,O=C*v+k*S,U=b*S-k*v,G=b*v+k*S,H=b*S-_*v,q=b*v+_*S;C=Math.min(Y,L,U,H),_=Math.min(T,O,G,q),b=Math.max(Y,L,U,H),k=Math.max(T,O,G,q)}a=C<a?C:a,r=_<r?_:r,s=b>s?b:s,i=k>i?k:i;const X=o.createImageData(h.size[0],h.size[1]);X.data.set(new Uint8ClampedArray(h.image.buffer));const B={offsetX:u,offsetY:M,rotateClockwise:x,angle:P,rasterizedImage:X,anchorX:z,anchorY:w};c.push(B)}t.width=s-a,t.height=i-r;const l=-a,y=i;for(let m=0;m<c.length;m++){const n=c[m],h=this._imageDataToCanvas(n.rasterizedImage),f=n.rasterizedImage.width,u=n.rasterizedImage.height,M=l-f*(.5+n.anchorX),z=y-u*(.5-n.anchorY);if(n.angle){const w=(360-n.angle)*Math.PI/180;o.save(),o.translate(I(n.offsetX),-I(n.offsetY)),o.translate(l,y),o.rotate(w),o.translate(-l,-y),o.drawImage(h,M,z),o.restore()}else o.drawImage(h,M+I(n.offsetX),z-I(n.offsetY))}const d=new te({x:l/t.width-.5,y:y/t.height-.5});return{imageData:t.width!==0&&t.height!==0?o.getImageData(0,0,t.width,t.height):o.createImageData(1,1),anchorPosition:d}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,o=t.getContext("2d");return t.width=e.width,t.height=e.height,o.putImageData(e,0,0),t}_imageTo32Array(e,t,o,a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const r=this._imageDataCanvas,s=r.getContext("2d");if(r.width=t,r.height=o,s.drawImage(e,0,0,t,o),a){s.save();const i=new ae(a);s.fillStyle=i.toHex(),s.globalCompositeOperation="multiply",s.fillRect(0,0,t,o),s.globalCompositeOperation="destination-atop",s.drawImage(e,0,0,t,o),s.restore()}return new Uint32Array(s.getImageData(0,0,t,o).data.buffer)}_getRasterizedResource(e,t,o,a,r,s){let i,c,l,y,d=null,m=null;if(o==="esriGeometryPolyline"||o==="esriGeometryPolygon"){const h=a&&a.style?a.style:F.Legend,f=o==="esriGeometryPolyline"?j.stroke[h]:j.fill[h];if(e.type==="line"){if(e.cim.type!=="CIMSolidStroke"){if(e.cim.type==="CIMPictureStroke"){const u=p(e.width,t,r,s),M=p(e.color,t,r,s),{image:z,width:w,height:x}=this._getPictureResource(e,u,M);return this._rasterizePictureResource(e,z,w,x,f,u)}return null}({analyzedCIM:i,hash:l}=R(e,t,r,s)),c=this._embedCIMLayerInVectorMarker(i,f)}else if(e.type==="marker"){if(e.cim.type==="CIMPictureMarker"){const u=p(e.size,t,r,s),M=p(e.color,t,r,s),{image:z,width:w,height:x}=this._getPictureResource(e,u,M);return this._rasterizePictureResource(e,z,w,x,f,u)}if(e.cim.type!=="CIMVectorMarker")return null;e.cim.offsetX=p(e.offsetX,t,r,s),e.cim.offsetY=p(e.offsetY,t,r,s),e.cim.rotation=p(e.rotation,t,r,s),e.cim.markerPlacement=e.markerPlacement,{analyzedCIM:i}=R(e,t,r,s),l=re(JSON.stringify(i)).toString(),c=this._embedCIMLayerInVectorMarker(i,f),d=p(e.size,t,r,s),m=e.path}else{if(e.type==="text")return null;if(e.type==="fill"){if(e.cim.type==="CIMHatchFill"||e.cim.type==="CIMVectorMarker"||e.cim.type==="CIMPictureMarker"||e.cim.type==="CIMPictureFill"){const u=e.cim.size||e.cim.height;let M,z,w;if(e.cim.type==="CIMPictureMarker"||e.cim.type==="CIMPictureFill")({image:M,width:z,height:w}=this._getPictureResource(e,u,p(e.color,t,r,s)));else{({analyzedCIM:i,hash:l}=R(e,t,r,s));const x=this._rasterizer.rasterizeJSONResource({cim:i,type:e.type,url:e.url,mosaicHash:l,size:u,path:m},1,this._avoidSDF);M=x.image,z=x.size[0],w=x.size[1]}return this._rasterizePictureResource(e,M,z,w,f,null)}if(e.cim.type!=="CIMSolidFill")return null;({analyzedCIM:i,hash:l}=R(e,t,r,s)),c=this._embedCIMLayerInVectorMarker(i,f)}}}else{if(e.type==="text")return y=this._rasterizeTextResource(e,t,a,r,s),y;({analyzedCIM:i,hash:l}=R(e,t,r,s));const h=D(a,e,null);if(e.cim.type==="CIMPictureMarker"){const f=p(e.size,t,r,s)*h,{image:u,width:M,height:z}=this._getPictureResource(e,f,p(e.color,t,r,s));return y={image:u,size:[M,z],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},y}ie(i,h,{preserveOutlineWidth:!1}),c=i}l+=o,a&&(l+=JSON.stringify(a));const n=this._resourceCache;return n.has(l)?n.get(l):(y=this._rasterizer.rasterizeJSONResource({cim:c,type:e.type,url:e.url,mosaicHash:l,size:d,path:m},window.devicePixelRatio||1,this._avoidSDF),n.set(l,y),y)}_rasterizeTextResource(e,t,o,a,r){const s=D(o,e,null),i=p(e.text,t,a,r);if(!i||i.length===0)return null;const c=p(e.fontName,t,a,r),l=p(e.style,t,a,r),y=p(e.weight,t,a,r),d=p(e.decoration,t,a,r),m=p(e.size,t,a,r)*s,n=p(e.horizontalAlignment,t,a,r),h=p(e.verticalAlignment,t,a,r),f=E(p(e.color,t,a,r)),u=E(p(e.outlineColor,t,a,r)),M={color:f,size:m,horizontalAlignment:n,verticalAlignment:h,font:{family:c,style:l,weight:y,decoration:d},halo:{size:p(e.outlineSize,t,a,r)||0,color:u,style:l},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(i,M)}_rasterizePictureResource(e,t,o,a,r,s){const i=document.createElement("canvas"),c=i.getContext("2d");i.height=I(Math.max(r.frame.ymax-r.frame.ymin,s)),i.width=I(r.frame.xmax-r.frame.xmin);const l=c.createImageData(o,a);l.data.set(new Uint8ClampedArray(t.buffer));const y=this._imageDataToCanvas(l),d=c.createPattern(y,"repeat"),m=Math.cos((-e.cim.rotation||0)*Math.PI/180),n=Math.sin((-e.cim.rotation||0)*Math.PI/180);d.setTransform({m11:m,m12:n,m21:-n,m22:m,m41:I(e.cim.offsetX)||0,m42:I(e.cim.offsetY)||0});const h=r.canvasPaths;let f,u,M;J(h)?(f=h.rings,c.fillStyle=d,u=c.fill,M=["evenodd"]):ne(h)&&(f=h.paths,c.strokeStyle=d,c.lineWidth=s,u=c.stroke,f[0][0][1]=i.height/2,f[0][1][1]=i.height/2),c.beginPath();for(const x of f){const P=x?x.length:0;if(P>1){let C=x[0];c.moveTo(I(C[0]),I(C[1]));for(let _=1;_<P;++_)C=x[_],c.lineTo(I(C[0]),I(C[1]));c.closePath()}}u.apply(c,M);const z=c.getImageData(0,0,i.width,i.height),w=new Uint8Array(z.data);return{size:[i.width,i.height],image:new Uint32Array(w.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t,o){const a=this._pictureMarkerCache.get(e.materialHash);if(!a)return null;const r=a.height/a.width,s=t?r>1?I(t):I(t)/r:a.width,i=t?r>1?I(t)*r:I(t):a.height;return{image:this._imageTo32Array(a,s,i,o),width:s,height:i}}_embedCIMLayerInVectorMarker(e,t){const o=J(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol",a=t.frame;return{type:"CIMVectorMarker",frame:a,size:a.ymax-a.ymin,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:o,symbolLayers:[e]}}]}}}function ue(g){return(g?Object.keys(g):[]).map(e=>({name:e,alias:e,type:typeof g[e]=="string"?"esriFieldTypeString":"esriFieldTypeDouble"}))}function ge(g){if(!(g&&g.data&&g.data.symbol))return null;switch(g.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}function R(g,e,t,o){let a,r;return typeof g.materialHash=="function"?(a=(0,g.materialHash)(e,t,o),r=ce(g.cim,g.materialOverrides)):(a=g.materialHash,r=g.cim),{analyzedCIM:r,hash:a}}export{xe as CIMSymbolRasterizer,F as GeometryStyle};
