var as=Object.defineProperty,os=Object.defineProperties;var hs=Object.getOwnPropertyDescriptors;var Ne=Object.getOwnPropertySymbols;var ls=Object.prototype.hasOwnProperty,cs=Object.prototype.propertyIsEnumerable;var qe=(r,t,e)=>t in r?as(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,ot=(r,t)=>{for(var e in t||(t={}))ls.call(t,e)&&qe(r,e,t[e]);if(Ne)for(var e of Ne(t))cs.call(t,e)&&qe(r,e,t[e]);return r},It=(r,t)=>os(r,hs(t));import{i4 as Ii,i3 as vt,qu as Li,qv as it,qw as fe,it as et,qx as Pt,qy as ae,qz as de,qA as Xe,a as E,d as V,n as Ie,h as Pi,iv as zi,hR as $i,cP as $t,t as R,r as W,qB as Le,fi as Pe,a$ as Jt,ho as g,pH as us,aa as ut,ei as Ci,L as ft,qC as fs,af as Wi,a1 as ds,od as oe,e7 as _s,mp as ms,a6 as tt,mx as ps,ml as ki,mm as Fi,bs as ys,bt as xs,mq as gs,mr as Ms,ms as ws,mt as vs,qD as He,qE as Ue,qF as Ye,z as ze,bI as je,kv as bs,lC as Ss,ok as Ts,y as Is,lB as Ls,a8 as Ps,d7 as zs,mP as $s,lR as Cs}from"./vendor.f59113c8.js";import{d as Ws,g as ks,c as Fs,e as Es,f as Ei,n as Ri,h as _e,i as Rs,j as As,k as Bs,o as Os}from"./CIMSymbolHelper.9edf3a4c.js";import{l as Ai,f as Vs,p as Bi}from"./Pipeline.f19deb94.js";import{_ as me,t as Ds,o as bt,s as Ks,b as Oi,h as F,j as Gs,a as Zs,d as Ns,i as Mt,e as qs,n as Xs,$,f as Vi,U as Hs,r as Us,p as Ys}from"./definitions.9639b7e5.js";import{E as I,z as Qe,J as js,Q as Qs}from"./Utils.c37502be.js";import{l as Js,p as tr}from"./tileUtils.82b27401.js";import{n as Di,r as er,d as ir,a as sr}from"./TileClipper.e294d748.js";import{i as D,r as Bt,e as Je}from"./enums.c01b5663.js";import{x as z,w}from"./number.dc47462b.js";import{_ as pe,b as rr,U as Ki,B as Ut,x as Ct,R as nr,L as te}from"./MaterialKey.9964f4ac.js";import{t as ar,h as ti,M as or}from"./GeometryUtils.09f0c771.js";import{f as he,o as hr,H as lr}from"./cimAnalyzer.66c04f61.js";import{s as Gi}from"./Geometry.e891c191.js";import"./BidiEngine.eb17884f.js";import"./QueryEngine.7ca31221.js";import"./WhereClause.d621a470.js";import"./json.da51edc4.js";import"./QueryEngineCapabilities.650d7541.js";import"./utils.a947722b.js";import"./ClassBreaksDefinition.f6c72a07.js";import"./createConnection.1a6cbb72.js";import"./quickselect.02d2bace.js";import"./centroid.7fe573f3.js";import"./ogcFeatureUtils.623f359f.js";import"./geojson.ca120e51.js";import"./clientSideDefaults.e7270462.js";function C(r){if(!r)return 0;const{r:t,g:e,b:i,a:s}=r;return z(t*s,e*s,i*s,255*s)}function Y(r){if(!r)return 0;const[t,e,i,s]=r;return z(t*(s/255),e*(s/255),i*(s/255),s)}class ct{constructor(t,e,i,s){this.center=Ii(t,e),this.centerT=vt(),this.halfWidth=i/2,this.halfHeight=s/2,this.width=i,this.height=s}get x(){return this.center[0]}get y(){return this.center[1]}get blX(){return this.center[0]+this.halfWidth}get blY(){return this.center[1]+this.halfHeight}get trX(){return this.center[0]-this.halfWidth}get trY(){return this.center[1]-this.halfHeight}get xmin(){return this.x-this.halfWidth}get xmax(){return this.x+this.halfWidth}get ymin(){return this.y-this.halfHeight}get ymax(){return this.y+this.halfHeight}set x(t){this.center[0]=t}set y(t){this.center[1]=t}clone(){return new ct(this.x,this.y,this.width,this.height)}serialize(t){return t.writeF32(this.center[0]),t.writeF32(this.center[1]),t.push(this.width),t.push(this.height),t}findCollisionDelta(t,e=4){const i=Math.abs(t.centerT[0]-this.centerT[0]),s=Math.abs(t.centerT[1]-this.centerT[1]),n=(t.halfWidth+this.halfWidth+e)/i,a=(t.halfHeight+this.halfHeight+e)/s,o=Math.min(n,a);return Math.log2(o)}extend(t){const e=Math.min(this.xmin,t.xmin),i=Math.min(this.ymin,t.ymin),s=Math.max(this.xmax,t.xmax)-e,n=Math.max(this.ymax,t.ymax)-i,a=e+s/2,o=i+n/2;this.width=s,this.height=n,this.halfWidth=s/2,this.halfHeight=n/2,this.x=a,this.y=o}static deserialize(t){const e=t.readF32(),i=t.readF32(),s=t.readInt32(),n=t.readInt32();return new ct(e,i,s,n)}}const $e=26,Zi=4,cr=$e+Zi,ur=$e-6,ei=3,j=8,fr=Math.PI/180;class Ni{constructor(t,e,i,s){this._rotationT=it(),this._xBounds=0,this._yBounds=0,this.minZoom=0,this.maxZoom=255,this._bounds=null;const n=i.rect,a=new Float32Array(8);t*=s,e*=s;const o=i.code?n.width*s:i.metrics.width,h=i.code?n.height*s:i.metrics.height;a[0]=t,a[1]=e,a[2]=t+o,a[3]=e,a[4]=t,a[5]=e+h,a[6]=t+o,a[7]=e+h,this._data=a,this._setTextureCoords(n),this._scale=s,this._mosaic=i,this.x=t,this.y=e,this.maxOffset=Math.max(t+o,e+h)}get width(){return this._mosaic.metrics.width*this._scale}get mosaic(){return this._mosaic}set angle(t){this._angle=t,Li(this._rotationT,-t),this._setOffsets(this._data)}get angle(){return this._angle}get xTopLeft(){return this._data[0]}get yTopLeft(){return this._data[1]}get xBottomRight(){return this._data[6]}get yBottomRight(){return this._data[7]}get texcoords(){return this._texcoords}get textureBinding(){return this._mosaic.textureBinding}get offsets(){return this._offsets||this._setOffsets(this._data),this._offsets}get char(){return String.fromCharCode(this._mosaic.code)}get code(){return this._mosaic.code}get bounds(){if(!this._bounds){const{height:t,width:e}=this._mosaic.metrics,i=e*this._scale,s=Math.abs(t)*this._scale,n=new Float32Array(8);n[0]=this.x,n[1]=this.y,n[2]=this.x+i,n[3]=this.y,n[4]=this.x,n[5]=this.y+s,n[6]=this.x+i,n[7]=this.y+s;const a=fe(it(),this._rotationT,this._T);Xe(n,n,a);let o=1/0,h=1/0,l=0,c=0;for(let d=0;d<4;d++){const p=n[2*d],y=n[2*d+1];o=Math.min(o,p),h=Math.min(h,y),l=Math.max(l,p),c=Math.max(c,y)}const u=l-o,f=c-h,_=o+u/2,m=h+f/2;this._bounds=new ct(_,m,u,f)}return this._bounds}setTransform(t){this._T=t,this._offsets=null}_setOffsets(t){this._offsets||(this._offsets={upperLeft:0,upperRight:0,lowerLeft:0,lowerRight:0});const e=this._offsets,i=new Float32Array(8),s=fe(it(),this._rotationT,this._T);Xe(i,t,s),e.upperLeft=w(i[0]*j,i[1]*j),e.upperRight=w(i[2]*j,i[3]*j),e.lowerLeft=w(i[4]*j,i[5]*j),e.lowerRight=w(i[6]*j,i[7]*j)}_setTextureCoords({x:t,y:e,width:i,height:s}){this._texcoords={upperLeft:w(t,e),upperRight:w(t+i,e),lowerLeft:w(t,e+s),lowerRight:w(t+i,e+s)}}}const dr=(r,t)=>({code:0,page:0,sdf:!0,rect:new ar(0,0,11,8),textureBinding:t,metrics:{advance:0,height:4,width:r,left:0,top:0}});class _r{constructor(t,e,i){this._rotation=0,this._decorate(t,e,i),this.glyphs=t,this.bounds=this._createBounds(t),this.isMultiline=e.length>1,this._hasRotation=i.angle!==0,this._T=this._createGlyphTransform(this.bounds,i);for(const s of t)s.setTransform(this._T)}setRotation(t){if(t===0&&this._rotation===0)return;this._rotation=t;const e=this._T,i=Li(it(),t);fe(e,i,e);for(const s of this.glyphs)s.setTransform(this._T)}_decorate(t,e,i){if(!i.decoration||i.decoration==="none"||!t.length)return;const s=i.scale,n=i.decoration==="underline"?cr:ur,a=t[0].textureBinding;for(const o of e){const h=o.startX*s,l=o.startY*s,c=(o.width+o.glyphWidthEnd)*s;t.push(new Ni(h,l+n*s,dr(c,a),1))}}get boundsT(){const t=this.bounds,e=et(vt(),t.x,t.y);if(Pt(e,e,this._T),this._hasRotation){const i=Math.max(t.width,t.height);return new ct(e[0],e[1],i,i)}return new ct(e[0],e[1],t.width,t.height)}_createBounds(t){let e=1/0,i=1/0,s=0,n=0;for(const h of t)e=Math.min(e,h.xTopLeft),i=Math.min(i,h.yTopLeft),s=Math.max(s,h.xTopLeft+h.width),n=Math.max(n,h.yBottomRight);const a=s-e,o=n-i;return new ct(e+a/2,i+o/2,a,o)}_createGlyphTransform(t,e){const i=fr*e.angle,s=it(),n=vt();return ae(s,s,et(n,e.xOffset,-e.yOffset)),e.isCIM?de(s,s,i):(ae(s,s,et(n,t.x,t.y)),de(s,s,i),ae(s,s,et(n,-t.x,-t.y))),s}}class Ot{constructor(t,e,i,s,n,a){this.glyphWidthEnd=0,this.startX=0,this.startY=0,this.start=Math.max(0,Math.min(e,i)),this.end=Math.max(0,Math.max(e,i)),this.end<t.length&&(this.glyphWidthEnd=t[this.end].metrics.width),this.width=s,this.yMin=n,this.yMax=a}}const ye=r=>r===10,ii=r=>r===32;function mr(r,t,e){const i=new Array,s=1/e.scale,n=e.maxLineWidth*s,a=t?r.length-1:0,o=t?-1:r.length,h=t?-1:1;let l=a,c=0,u=0,f=l,_=f,m=0,d=1/0,p=0;for(;l!==o;){const{code:x,metrics:M}=r[l],v=Math.abs(M.top);if(ye(x)||ii(x)||(d=Math.min(d,v),p=Math.max(p,v+M.height)),ye(x))l!==a&&(i.push(new Ot(r,f,l-h,c,d,p)),d=1/0,p=0),c=0,f=l+h,_=l+h,u=0;else if(ii(x))_=l+h,u=0,m=M.advance,c+=M.advance;else if(c>n){if(_!==f){const S=_-2*h;c-=m,i.push(new Ot(r,f,S,c-u,d,p)),d=1/0,p=0,f=_,c=u}else i.push(new Ot(r,f,l-h,c,d,p)),d=1/0,p=0,f=l,_=l,c=0;c+=M.advance,u+=M.advance}else c+=M.advance,u+=M.advance;l+=h}const y=new Ot(r,f,l-h,c,d,p);return y.start>=0&&y.end<r.length&&i.push(y),i}function pr(r,t){let e=0;for(let n=0;n<r.length;n++){const{width:a}=r[n];e=Math.max(a,e)}const i=t.decoration==="underline"?Zi:0,s=r[0].yMin;return{x:0,y:s,height:r[r.length-1].yMax+t.lineHeight*(r.length-1)+i-s,width:e}}function yr(r,t,e){const i=e.scale,s=new Array,n=mr(r,t,e),a=pr(n,e),{vAlign:o,hAlign:h}=e,l=o===Ws.Baseline?1:0,c=l?0:o-1,u=(1-l)*-a.y+c*(a.height/2)+(l?1:0)*-$e;for(let f=0;f<n.length;f++){const{start:_,end:m,width:d}=n[f];let p=-1*(h+1)*(d/2)-ei;const y=f*e.lineHeight+u-ei;n[f].startX=p,n[f].startY=y;for(let x=_;x<=m;x++){const M=r[x];if(ye(M.code))continue;const v=new Ni(p+M.metrics.left,y-M.metrics.top,M,i);p+=M.metrics.advance,s.push(v)}}return new _r(s,n,e)}function xr(r,t){return r.length=0,t.forEach(e=>r.push(e)),r}const le=new Set,Vt=[],pt=new Map,si=[0,0];let Q=class extends Pi{constructor(r){super(r),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:r,process:t}=this;this._queue=new Ai({concurrency:r,process:(e,i)=>{const s=this._keyToItem.get(e);return t(s,{signal:i})},peeker:e=>e.values().next().value})}destroy(){this.clear(),this._queue.destroy(),this._queue=null}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}get updating(){return this.length>0||this.onGoingCount>0}abort(r){const t=typeof r=="string"?r:r.id;this._queue.abort(t)}clear(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")}has(r){return typeof r=="string"?this._keyToItem.has(r):this._keyToItem.has(r.id)}isOngoing(r){const t=typeof r=="string"?r:r.id;return this.has(t)&&this._queue.isOngoing(t)}pause(){this._queue.pause()}push(r,t){const e=r.key.id+"-"+t;if(this.has(e))return this.get(e);const i=this._queue.push(e),s=()=>{this._keyToItem.delete(e),this.notifyChange("updating")};return this._keyToItem.set(e,r),i.then(s,s),this.notifyChange("updating"),i}reset(){this._queue.reset(),this.notifyChange("updating")}resume(){this._queue.resume()}_peekByScaleFirst(r){if(!this.state)return r.values().next().value;const t=this.tileInfoView;let e=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY;r.forEach(l=>{const c=this._keyToItem.get(l),u=this.tileInfoView.getTileScale(c.key);pt.has(u)||(pt.set(u,[]),e=Math.max(u,e),i=Math.min(u,i)),pt.get(u).push(c.key),le.add(u)});let s=this.state.scale;pt.has(s)||(xr(Vt,le),Vt.sort((l,c)=>l-c),s=Vt.reduce((l,c)=>Math.abs(c-s)<Math.abs(l-s)?c:l,Vt[0])),s=Math.min(s,e),s=Math.max(s,i);const n=pt.get(s),a=t.getClosestInfoForScale(s),o=a.getColumnForX(this.state.center[0]),h=a.getRowForY(this.state.center[1]);return n.sort((l,c)=>{const u=a.denormalizeCol(l.col,l.world),f=a.denormalizeCol(c.col,c.world);return Math.sqrt((o-u)*(o-u)+(h-l.row)*(h-l.row))-Math.sqrt((o-f)*(o-f)+(h-c.row)*(h-c.row))}),le.clear(),pt.clear(),n[0].id}_peekByCenterFirst(r){if(!this.state)return r.values().next().value;const t=this.tileInfoView,e=this.state.center;let i=Number.POSITIVE_INFINITY,s=null;return r.forEach(n=>{const a=this._keyToItem.get(n);t.getTileCoords(si,a.key);const o=zi(si,e);o<i&&(i=o,s=a.key)}),s.id}};E([V({constructOnly:!0})],Q.prototype,"concurrency",void 0),E([V({constructOnly:!0})],Q.prototype,"process",void 0),E([V()],Q.prototype,"state",void 0),E([V({constructOnly:!0})],Q.prototype,"strategy",void 0),E([V({constructOnly:!0})],Q.prototype,"tileInfoView",void 0),E([V({readOnly:!0})],Q.prototype,"updating",null),Q=E([Ie("esri.views.2d.tiling.PagedTileQueue")],Q);function gr(r,t){return r.length=0,t.forEach(e=>r.push(e)),r}const ce=new Set,Dt=[],yt=new Map,ri=[0,0];let J=class extends Pi{constructor(r){super(r),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:r,process:t,strategy:e}=this;this._queue=new Ai({concurrency:r,process:(i,s)=>{const n=this._keyToItem.get(i);return t(n,{signal:s})},peeker:e==="scale-first"?i=>this._peekByScaleFirst(i):i=>this._peekByCenterFirst(i)})}destroy(){this.clear(),this._queue.destroy(),this._queue=null}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}get updating(){return this.length>0||this.onGoingCount>0}abort(r){const t=typeof r=="string"?r:r.id;this._queue.abort(t)}clear(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")}has(r){return typeof r=="string"?this._keyToItem.has(r):this._keyToItem.has(r.id)}isOngoing(r){const t=typeof r=="string"?r:r.id;return this.has(t)&&this._queue.isOngoing(t)}pause(){this._queue.pause()}push(r){const t=r.key.id;if(this._queue.has(t))return this._queue.get(t);const e=this._queue.push(t),i=()=>{this._keyToItem.delete(t),this.notifyChange("updating")};return this._keyToItem.set(t,r),e.then(i,i),this.notifyChange("updating"),e}reset(){this._queue.reset()}resume(){this._queue.resume()}_peekByScaleFirst(r){if(!this.state)return r.values().next().value;const t=this.tileInfoView;let e=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY;r.forEach(l=>{const c=this._keyToItem.get(l),u=this.tileInfoView.getTileScale(c.key);yt.has(u)||(yt.set(u,[]),e=Math.max(u,e),i=Math.min(u,i)),yt.get(u).push(c.key),ce.add(u)});let s=this.state.scale;yt.has(s)||(gr(Dt,ce),Dt.sort((l,c)=>l-c),s=Dt.reduce((l,c)=>Math.abs(c-s)<Math.abs(l-s)?c:l,Dt[0])),s=Math.min(s,e),s=Math.max(s,i);const n=yt.get(s),a=t.getClosestInfoForScale(s),o=a.getColumnForX(this.state.center[0]),h=a.getRowForY(this.state.center[1]);return n.sort((l,c)=>{const u=a.denormalizeCol(l.col,l.world),f=a.denormalizeCol(c.col,c.world);return Math.sqrt((o-u)*(o-u)+(h-l.row)*(h-l.row))-Math.sqrt((o-f)*(o-f)+(h-c.row)*(h-c.row))}),ce.clear(),yt.clear(),n[0].id}_peekByCenterFirst(r){if(!this.state)return r.values().next().value;const t=this.tileInfoView,e=this.state.center;let i=Number.POSITIVE_INFINITY,s=null;return r.forEach(n=>{const a=this._keyToItem.get(n);t.getTileCoords(ri,a.key);const o=zi(ri,e);o<i&&(i=o,s=a.key)}),s.id}};E([V({constructOnly:!0})],J.prototype,"concurrency",void 0),E([V({constructOnly:!0})],J.prototype,"process",void 0),E([V()],J.prototype,"state",void 0),E([V({constructOnly:!0})],J.prototype,"strategy",void 0),E([V({constructOnly:!0})],J.prototype,"tileInfoView",void 0),E([V({readOnly:!0})],J.prototype,"updating",null),J=E([Ie("esri.views.2d.tiling.TileQueue")],J);new $i(0,0,0,0);const gt=new Map;function Mr(r,t,e){const{indicesPerRecord:i,multiplier:s,verticesPerRecord:n}=gt.get(r);return{recordBytes:e*me*Uint32Array.BYTES_PER_ELEMENT,indexBytes:s*i*e*Uint32Array.BYTES_PER_ELEMENT,vertexBytes:s*n*e*t}}gt.set(I.MARKER,{multiplier:1,indicesPerRecord:6,verticesPerRecord:4}),gt.set(I.LINE,{multiplier:1,indicesPerRecord:24,verticesPerRecord:8}),gt.set(I.FILL,{multiplier:1,indicesPerRecord:10,verticesPerRecord:10}),gt.set(I.TEXT,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4}),gt.set(I.LABEL,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4});const wr=1.25;class Kt{constructor(t,e){this._pos=0;const i=e?this._roundToNearest(e,t.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(i),this._buffer=new t(this._array),this._ctor=t,this._i16View=new Int16Array(this._array)}get length(){return this._pos}_roundToNearest(t,e){const i=Math.round(t);return i+(e-i%e)}_ensureSize(t){if(this._pos+t>=this._buffer.length){const e=this._roundToNearest((this._array.byteLength+t*this._buffer.BYTES_PER_ELEMENT)*wr,this._buffer.BYTES_PER_ELEMENT),i=new ArrayBuffer(e),s=new this._ctor(i);s.set(this._buffer,0),this._array=i,this._buffer=s,this._i16View=new Int16Array(this._array)}}ensureSize(t){this._ensureSize(t)}writeF32(t){this._ensureSize(1);const e=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=t,this._pos++,e}push(t){this._ensureSize(1);const e=this._pos;return this._buffer[this._pos++]=t,e}writeFixed(t){this._buffer[this._pos++]=t}setValue(t,e){this._buffer[t]=e}i1616Add(t,e,i){this._i16View[2*t]+=e,this._i16View[2*t+1]+=i}getValue(t){return this._buffer[t]}incr(t){if(this._buffer.length<t)throw new Error("Increment index overflows the target buffer");this._buffer[t]++}decr(t){this._buffer[t]--}writeRegion(t){this._ensureSize(t.length);const e=this._pos;return this._buffer.set(t,this._pos),this._pos+=t.length,e}writeManyFrom(t,e,i){this._ensureSize(i-e);for(let s=e;s!==i;s++)this.writeFixed(t._buffer[s])}buffer(){const t=this._array.slice(0,4*this._pos);return this.destroy(),t}toArray(){const t=this._array,e=[];for(let i=0;i<t.byteLength/4;i++)e.push(t[i]);return e}seek(t){this._pos=t}destroy(){this._array=null,this._buffer=null}}class ni{constructor(t,e,i){this._start={index:0,vertex:0};const s=Mr(t,e,i),n=e/4;this.geometryType=t,this._records=new Kt(Int32Array,s.recordBytes),this._indices=new Kt(Uint32Array,s.indexBytes),this._vertices=new Kt(Uint32Array,s.vertexBytes),this._metrics=new Kt(Float32Array,0),this._strideInt=n}serialize(t){const e=this._records.buffer(),i=this._indices.buffer(),s=this._vertices.buffer(),n=this._metrics.length?this._metrics.buffer():null,a=4*this._strideInt;return t.push(e,i,s),{stride:a,records:e,indices:i,vertices:s,metrics:n}}get strideInt(){return this._strideInt}get recordCount(){return this._records.length/me}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(t){this._vertices.ensureSize(t)}indexEnsureSize(t){this._indices.ensureSize(t)}recordStart(){this._start.index=this._indices.length,this._start.vertex=this._vertices.length}recordEnd(t,e,i,s,n,a,o,h){this._records.push(t),this._records.push(e),this._records.push(i),this._records.push(s),this._records.push(n),this._records.push(a),this._records.push(o),this._records.writeF32(h)}writeIndex(t){this._indices.push(t)}writeVertex(t){this._vertices.push(t)}writeVertexF32(t){this._vertices.writeF32(t)}copyLastFrom(t,e,i){const s=t._records.length-me,n=t._records.getValue(s),a=t._records.getValue(s+1),o=t._records.getValue(s+2),h=t._records.getValue(s+4),l=t._records.getValue(s+6),c=t._records.getValue(s+7),u=this._vertices.length,f=(t._start.vertex-this._vertices.length)/this._strideInt,_=this._indices.length,m=this.vertexCount;for(let d=t._start.index;d!==t._indices.length;d++){const p=t._indices.getValue(d);this._indices.push(p-f)}for(let d=t._start.vertex;d!==t._vertices.length;d++){const p=t._vertices.getValue(d);this._vertices.push(p)}for(let d=u;d<=this._vertices.length;d+=this._strideInt)this._vertices.i1616Add(d,e,i);this._records.push(n),this._records.push(a),this._records.push(o),this._records.push(_),this._records.push(h),this._records.push(m),this._records.push(l),this._records.push(c)}}const ee=1,Ce=2,ie=4,We=8,ke=16,se=32,Fe=64,re=128;function ai(r){switch(r){case ee:case We:case se:return-1;case Ce:case Fe:return 0;case ie:case ke:case re:return 1}}function oi(r){switch(r){case ee:case Ce:case ie:return-1;case We:case ke:return 0;case se:case Fe:case re:return 1}}const hi=ee|We|se,li=ie|ke|re,ci=ee|Ce|ie,ui=se|Fe|re;class vr{constructor(t,e,i,s,n){this._hasAggregate=!1,this.hasRecords=!1,this._data={self:new Map,neighbors:new Array},this._current={geometryType:0,writer:null,overlaps:0,start:0,insertAfter:0,sortKey:0,id:0,materialKey:0,indexStart:0,vertStart:0,isDotDensity:!1,bufferingEnabled:!1,metricBoxLenPointer:0},this.hint=e,this.tileKey=t,this._hasAggregate=s,this._pixelBufferEnabled=n,this._strideOptions=i}get hasAggregates(){return this._hasAggregate}get hasPixelBufferEnabled(){return this._pixelBufferEnabled}serialize(t){const e=[];return e.push(this._serializeTileVertexData(this.tileKey,this.tileKey,this._data.self)),this._data.neighbors.forEach((i,s)=>{const n=1<<s,a=ai(n),o=oi(n),h=Js(new $i(this.tileKey),a,o,t),l=this._serializeTileVertexData(this.tileKey,h.id,i.vertexData);l.message.bufferIds=i.displayIds,e.push(l)}),e}_serializeTileVertexData(t,e,i){var s,n,a,o,h;const l=new Array;return{message:{tileKeyOrigin:t,tileKey:e,data:{[I.MARKER]:(s=i.get(I.MARKER))==null?void 0:s.serialize(l),[I.FILL]:(n=i.get(I.FILL))==null?void 0:n.serialize(l),[I.LINE]:(a=i.get(I.LINE))==null?void 0:a.serialize(l),[I.TEXT]:(o=i.get(I.TEXT))==null?void 0:o.serialize(l),[I.LABEL]:(h=i.get(I.LABEL))==null?void 0:h.serialize(l)}},transferList:l}}featureStart(t,e){this._current.insertAfter=t,this._current.sortKey=e}featureEnd(){}recordStart(t,e,i,s){this._current.writer=this._getVertexWriter(i),this._current.overlaps=0,this._current.indexStart=this._current.writer.indexCount,this._current.vertStart=this._current.writer.vertexCount,this._current.bufferingEnabled=s,this._current.id=t,this._current.materialKey=e,this._current.geometryType=i,this._current.isDotDensity=!1,this._current.writer.recordStart()}recordCount(){return this._current.writer.recordCount}vertexCount(){return this._current.writer.vertexCount}indexCount(){return this._current.writer.indexCount}vertexEnsureSize(t){this._current.writer.vertexEnsureSize(t)}indexEnsureSize(t){this._current.writer.indexEnsureSize(t)}vertexBounds(t,e,i,s){this._current.bufferingEnabled&&this._addOverlap(t,e,i,s)}vertexWrite(t){this._current.writer.writeVertex(t)}vertexWriteF32(t){this._current.writer.writeVertexF32(t)}vertexEnd(){}vertexWriter(){return this._current.writer.vertexWriter}indexWrite(t){this._current.writer.writeIndex(t)}indexWriter(){return this._current.writer.indexWriter}metricWriter(){return this._current.writer.metricWriter}metricStart(t,e,i,s,n,a,o,h){this._current.writer=this._getVertexWriter(I.LABEL);const l=this._current.writer.metricWriter;l.push(Vs(t)),l.push(e),l.push(i),l.push(s),l.push(n),l.push(a),l.push(o),l.push(h),l.push(255),this._current.metricBoxLenPointer=l.push(0)}metricEnd(){const t=this._current.writer.metricWriter;t.getValue(this._current.metricBoxLenPointer)===0&&t.seek(t.length-10)}metricBoxWrite(t,e,i,s){const n=this._current.writer.metricWriter;n.incr(this._current.metricBoxLenPointer),n.push(0),n.push(0),n.push(t),n.push(e),n.push(i),n.push(s)}recordEnd(){const t=this._current.vertStart,e=this._current.writer.vertexCount-t;if(!e)return!1;this.hasRecords=!0;const i=this._current.indexStart,s=this._current.writer.indexCount-i;if(this._current.writer.recordEnd(this._current.id,this._current.materialKey,this._current.insertAfter,i,s,t,e,this._current.sortKey),!this._pixelBufferEnabled||this._hasAggregate||this._current.overlaps===0||this._current.geometryType===I.LABEL)return!0;const n=this._current.writer;for(let a=0;a<8;a++){const o=1<<a;if(this._current.overlaps&o){this._data.neighbors[a]||(this._data.neighbors[a]={vertexData:new Map,displayIds:new Set});const h=this._data.neighbors[a],l=this._current.geometryType;if(!h.vertexData.has(l)){const m=Qe(l,this._strideOptions).geometry,d=new ni(l,m,Ds);h.vertexData.set(l,d)}const c=h.vertexData.get(this._current.geometryType),u=8,f=512*-ai(o)*u,_=512*-oi(o)*u;c.copyLastFrom(n,f,_),h.displayIds.add(this._current.id)}}return!0}_addOverlap(t,e,i,s){const n=255^((t<0+i?li:t>=bt-i?hi:li|hi)|(e<0+s?ui:e>=bt-s?ci:ui|ci));this._current.overlaps|=n}_getVertexWriter(t){if(!this._data.self.has(t)){const e=this._data.self,i=Qe(t,this._strideOptions).geometry;e.set(t,new ni(t,i,this.hint.records))}return this._data.self.get(t)}}const N=0,q=100;function fi(r,t,e){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r}function qi(r,t){return Math.sqrt(r*r+t*t)}function di(r){const t=qi(r[0],r[1]);r[0]/=t,r[1]/=t}function br(r,t){return qi(r[0]-t[0],r[1]-t[1])}function b(r){return typeof r=="function"}function xe(r=2){return 1/Math.max(r,1)}function rt(r,t){return[!!r.minScale&&t.scaleToZoom(r.minScale)||N,!!r.maxScale&&t.scaleToZoom(r.maxScale)||q]}function Sr(r,t){return r[t+1]}function Xi(r){return r.length-1}function Tr(r){let t=0;for(let e=0;e<Xi(r);e++)t+=Ir(r,e);return t}function Ir(r,t,e=1){const[i,s]=Sr(r,t);return Math.sqrt(i*i+s*s)*e}class Yt{constructor(t,e,i,s,n){this._segments=t,this._index=e,this._distance=i,this._xStart=s,this._yStart=n,this._done=!1}static create(t){return new Yt(t,0,0,t[0][0],t[0][1])}clone(){return new Yt(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(this._distance===0||t._distance===1)||t._index===this._index+1&&(this._distance===1||t._distance===0)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,e=(0*t+-1*-this.dx)/(1*this.length);let i=Math.acos(e);return t>0&&(i=2*Math.PI-i),i}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:e}=this;return Math.sqrt(t*t+e*e)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<Xi(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,e){const i=this.backwardLength;if(t<=i)return this._distance=(i-t)/this.length,this;let s=this.backwardLength;for(;this.prev();){if(s+this.length>t)return this._seekBackwards(t-s);s+=this.length}return this._distance=0,e?this:null}seek(t,e=!1){if(t<0)return this._seekBackwards(Math.abs(t),e);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let i=this.remainingLength;for(;this.next();){if(i+this.length>t)return this.seek(t-i,e);i+=this.length}return this._distance=1,e?this:null}}function Lr(r,t,e,i=!0){const s=Tr(r),n=Yt.create(r),a=s/2;if(!i)return n.seek(a),void e(n.clone(),0,a+0*t,s);const o=Math.max((s-t)/2,0),h=Math.floor(o/t),l=a-h*t;n.seek(l);for(let c=-h;c<=h;c++)n.x<512&&n.x>=0&&n.y<512&&n.y>=0&&e(n.clone(),c,a+c*t,s),n.seek(t)}function Pr(r,t){const e=t;for(let i=0;i<r.length;i++){let s=r[i];const n=[];n.push(s[0]);for(let o=1;o<s.length;o++){let[h,l]=n[o-1];h+=s[o][0],l+=s[o][1],n.push([h,l])}zr(n,e);const a=[];a.push(n[0]);for(let o=1;o<n.length;o++){const[h,l]=n[o-1],[c,u]=n[o],f=Math.round(c-h),_=Math.round(u-l);a.push([f,_])}r[i]=a,s=a}return r}function zr(r,t){if(t<=0)return;const i=r.length;if(i<3)return;const s=[];let n=0;s.push(0);for(let u=1;u<i;u++)n+=br(r[u],r[u-1]),s.push(n);t=Math.min(t,.2*n);const a=[];a.push(r[0][0]),a.push(r[0][1]);const o=r[i-1][0],h=r[i-1][1],l=fi([0,0],r[0],r[1]);di(l),r[0][0]+=t*l[0],r[0][1]+=t*l[1],fi(l,r[i-1],r[i-2]),di(l),r[i-1][0]+=t*l[0],r[i-1][1]+=t*l[1];for(let u=1;u<i;u++)s[u]+=t;s[i-1]+=t;const c=.5*t;for(let u=1;u<i-1;u++){let f=0,_=0,m=0;for(let d=u-1;d>=0&&!(s[d+1]<s[u]-c);d--){const p=c+s[d+1]-s[u],y=s[d+1]-s[d],x=s[u]-s[d]<c?1:p/y;if(Math.abs(x)<1e-6)break;const M=x*x,v=x*p-.5*M*y,S=x*y/t,T=r[d+1],L=r[d][0]-T[0],P=r[d][1]-T[1];f+=S/v*(T[0]*x*p+.5*M*(p*L-y*T[0])-M*x*y*L/3),_+=S/v*(T[1]*x*p+.5*M*(p*P-y*T[1])-M*x*y*P/3),m+=S}for(let d=u+1;d<i&&!(s[d-1]>s[u]+c);d++){const p=c-s[d-1]+s[u],y=s[d]-s[d-1],x=s[d]-s[u]<c?1:p/y;if(Math.abs(x)<1e-6)break;const M=x*x,v=x*p-.5*M*y,S=x*y/t,T=r[d-1],L=r[d][0]-T[0],P=r[d][1]-T[1];f+=S/v*(T[0]*x*p+.5*M*(p*L-y*T[0])-M*x*y*L/3),_+=S/v*(T[1]*x*p+.5*M*(p*P-y*T[1])-M*x*y*P/3),m+=S}a.push(f/m),a.push(_/m)}a.push(o),a.push(h);for(let u=0,f=0;u<i;u++)r[u][0]=a[f++],r[u][1]=a[f++]}class Hi{static getPlacement(t,e,i,s){const n=ks(e);if(!n)return null;const a=Fs(t);return n.execute(a,e,i,s)}}const Gt=8,Ui=r=>class extends r{constructor(...t){super(...t),this._isCIM=!1,this._vertexBoundsScale=1,this.geometryType=I.TEXT,this._aux=z(0,0,this._referenceSize,this._bitset)}bindTextInfo(t,e){t&&t.length?this._shapingInfo=$t(t,i=>yr(i,e,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:Ks*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM})):this._shapingInfo=null}_write(t,e,i,s){const n=e.getDisplayId();this._writeGeometry(t,e,n,i,s)}_writeGeometry(t,e,i,s,n){const a=this._shapingInfo;if(R(a))return;if(W(this._textPlacement)){const h=n!=null?n:e.readLegacyGeometryForDisplay();return this._writePlacedText(t,i,h,a,s)}const o=n?Le(Pe(n),2):e.geometryType==="esriGeometryPolygon"?e.readCentroid():e.readGeometryForDisplay();if(!R(o)){if(o.isPoint){const[h,l]=o.coords;return!t.hasAggregates&&t.hasPixelBufferEnabled&&(h<0||h>=512||l<0||l>=512)?void 0:this._writeGlyphs(t,i,{x:h,y:l},a)}o.forEachVertex((h,l)=>this._writeGlyphs(t,i,{x:h,y:l},a))}}_writePlacedText(t,e,i,s,n){const a=Jt(this._textPlacement),o=Hi.getPlacement(i,a,g(1),n.geometryEngine);if(!o)return;let h=o.next();for(;h!=null;){const l=-h.getAngle();s.setRotation(l);const c=h.tx,u=-h.ty;c<0||c>=512||u<0||u>=512||(this._writeGlyphs(t,e,{x:c,y:u},s),s.setRotation(-l)),h=o.next()}}_writeGlyphs(t,e,i,s){const n=pe.load(this._materialKey),a=w(Math.round(Gt*i.x),Math.round(Gt*i.y)),o=this._vertexBoundsScale,h=s.bounds,l=2*Math.max(h.width,h.height);for(const c of s.glyphs)n.textureBinding=c.textureBinding,t.recordStart(e,n.data,this.geometryType,!0),t.vertexBounds(i.x+h.x+this._xOffset,i.y+h.y-this._yOffset,l*o,l*o),this._writeVertices(t,e,a,c),t.recordEnd()}_writeGlyph(t,e,i,s,n){const a=pe.load(this._materialKey),o=w(Math.round(Gt*i),Math.round(Gt*s));a.textureBinding=n.textureBinding,t.recordStart(e,a.data,this.geometryType,!0);const h=n.bounds,l=this._vertexBoundsScale;t.vertexBounds(i+h.x*l,s+h.y*l,h.width*l,h.height*l),this._writeVertices(t,e,o,n),t.recordEnd()}_writeVertices(t,e,i,s){const n=t.vertexCount();this._writeVertexCommon(t,e,i,s),t.vertexWrite(s.offsets.upperLeft),t.vertexWrite(s.texcoords.upperLeft),t.vertexEnd(),this._writeVertexCommon(t,e,i,s),t.vertexWrite(s.offsets.upperRight),t.vertexWrite(s.texcoords.upperRight),t.vertexEnd(),this._writeVertexCommon(t,e,i,s),t.vertexWrite(s.offsets.lowerLeft),t.vertexWrite(s.texcoords.lowerLeft),t.vertexEnd(),this._writeVertexCommon(t,e,i,s),t.vertexWrite(s.offsets.lowerRight),t.vertexWrite(s.texcoords.lowerRight),t.vertexEnd(),t.indexWrite(n+0),t.indexWrite(n+1),t.indexWrite(n+2),t.indexWrite(n+1),t.indexWrite(n+3),t.indexWrite(n+2)}_writeVertexCommon(t,e,i,s){const n=this._color,a=this._haloColor,o=z(0,0,this._referenceSize,this._bitset),h=z(0,0,this._size,this._haloSize);t.vertexWrite(i),t.vertexWrite(e),t.vertexWrite(n),t.vertexWrite(a),t.vertexWrite(h),t.vertexWrite(o),t.vertexWrite(this._minMaxZoom)}};class Rt{bindFeature(t,e,i){}write(t,e,i,s){var n;if(R(this._effects)||((n=this._effects)==null?void 0:n.length)===0)return this._write(t,e,s);const a=he.executeEffects(this._effects,e.readLegacyGeometryForDisplay(),s.geometryEngine);let o=he.next(a);for(;o;)this._write(t,e,s,o),o=he.next(a)}_write(t,e,i,s){}}const $r=5;class St extends Ui(Rt){constructor(t,e,i,s,n,a,o,h,l,c,u,f,_,m,d,p,y,x,M=!1,v,S){super(),this._xOffset=g(_),this._yOffset=g(m),this._decoration=c||"none",this._color=n,this._haloColor=a,this._haloSize=Math.min(Math.floor($r*g(us(i))),127),this._size=Math.min(Math.round(g(e)),127);const T=Math.min(Math.round(g(s||e)),127);this._referenceSize=Math.round(Math.sqrt(256*T)),this._scale=this._size/Oi,this._angle=f,this._justify=Es(o||"center"),this._xAlignD=Ei(o||"center"),this._yAlignD=Ri(h||"baseline"),this._baseline=(h||"baseline")==="baseline",this._bitset=(l===D.MAP?1:0)|(u?1:0)<<1;const L=pe.load(t);L.sdf=!0,this._materialKey=L.data,this._lineWidth=g(d)||512,this._lineHeight=p||1,this._textPlacement=y,this._effects=x,this._isCIM=M,this._minMaxZoom=w(Math.round(v*F),Math.round(S*F))}static fromText(t,e){const i=new St(t.materialKey,t.font.size,t.haloSize||0,t.font.size,t.color&&Y(t.color)||0,t.haloColor&&Y(t.haloColor)||0,t.horizontalAlignment,t.verticalAlignment,D.SCREEN,t.font.decoration,!1,t.angle||0,t.xoffset,t.yoffset,t.lineWidth,t.lineHeight,null,null,!1,N,q),[,s]=_e(t.text);return i.bindTextInfo(e,s),i._vertexBoundsScale=t.maxVVSize?t.maxVVSize/t.font.size:1,i}static fromCIMText(t,e,i){const s=t.scaleFactor||1,n=t.size*t.sizeRatio*s,[a,o]=rt(t.scaleInfo,i),h=new St(t.materialKey,n,t.outlineSize*t.sizeRatio,t.referenceSize,C(t.color),C(t.outlineColor),t.horizontalAlignment,t.verticalAlignment,t.alignment,t.decoration,t.colorLocked,t.angle,t.offsetX*t.sizeRatio*s,t.offsetY*t.sizeRatio*s,512,1,t.markerPlacement,t.effects,!0,a,o),[,l]=_e(t.text);return h.bindTextInfo(e,l),h._vertexBoundsScale=t.maxVVSize?t.maxVVSize/n:1,h}}const Cr=ut.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),Wr=(r,t="mapview-labeling")=>Cr.error(new ft(t,r)),Zt=1,xt=0,kr=4;function Fr(r,t){const e=!!r.minScale&&t.scaleToZoom(r.minScale)||0;return Ci(e,0,25.5)}function Er(r,t){const e=!!r.maxScale&&t.scaleToZoom(r.maxScale)||255;return Ci(e,0,25.5)}function Rr(r){const t=new Map;return e=>(t.has(e)||t.set(e,r(e)),t.get(e))}const Ar=Rr(r=>{let t=0;if(r===0)return 1/0;for(;!(r%2);)t++,r/=2;return t}),Nt=r=>Math.floor(127*r+127),Lt=r=>Math.floor(10*r),qt=r=>Math.round(r*(254/360));class jt extends St{constructor(t,e,i,s){var n,a,o;super(t,i.font.size,i.haloSize||0,i.font.size,i.color&&Y(i.color)||0,i.haloColor&&Y(i.haloColor)||0,i.horizontalAlignment,i.verticalAlignment,Rs(e.labelPlacement)?D.MAP:D.SCREEN,i.font.decoration,!1,i.angle||0,i.xoffset,i.yoffset,i.lineWidth,i.lineHeight,null,null,null,null,null),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=I.LABEL,this._allowOverrun=(n=e.allowOverrun)!=null&&n,this._repeatLabel=(a=e.repeatLabel)==null||a,this._labelPosition=(o=e.labelPosition)!=null?o:"curved";const h=Fr(e,s),l=Er(e,s),c=e.labelPlacement,[u,f]=As(c);this._xAlignD=u,this._yAlignD=f,this._minZoom=h,this._maxZoom=l,this._refPlacementPadding=g(i.haloSize)+Gs,this._repeatLabelDistance=e.repeatLabelDistance?g(e.repeatLabelDistance):128;const _=rr.load(t);_.sdf=!0,this._materialKey=_.data}static fromLabelClass(t,e){if(t.labelPlacement==="esriServerLinePlacementCenterAlong"){const i=t.symbol;i.xoffset=0,i.yoffset=0,i.angle=0,i.font.decoration="none"}return new jt(t.materialKey,t,t.symbol,e)}get _shapedBox(){return Jt(this._shapingInfo).bounds}setZoomLevel(t){this._zoomLevel=t}bindReferenceTemplate(t){let e=Bs(this._xAlignD),i=Os(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,R(t))return void(this._refSymbolAndPlacementOffset=z(0,0,Nt(e),Nt(i)));if(t.boundsType==="circle"&&(e||i)){const a=Math.sqrt(e*e+i*i);e/=a,i/=a}const s=Math.max(t.height,t.width),n=this._refPlacementPadding*kr;this._refSymbolAndPlacementOffset=z(n,s,Nt(e),Nt(i)),this._referenceSize=s,this._refPlacementDirX=e,this._refPlacementDirY=i,this._refOffsetX=t.xOffset,this._refOffsetY=t.yOffset}_write(t,e){if(R(this._shapingInfo))return;const i=this._shapingInfo,s=e.getDisplayId(),n=e.geometryType==="esriGeometryPolygon"?e.readLegacyCentroid():e.readLegacyGeometry();if(n)switch(this.current={out:t,inId:s,inShaping:i,zoomLevel:this._zoomLevel},e.geometryType){case"esriGeometryPolyline":this._placeLineLabels(n);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(n);break;default:Wr("mapview-labeling",`Geometry of type ${e.geometryType} is not supported`)}}_isVisible(t,e){const i=Lt(this.current.zoomLevel);return Lt(t)<=i&&i<=Lt(e)}_placePointLabels(t){const{out:e,inId:i,inShaping:s}=this.current;this._writeGlyphs(e,i,t,s)}_placeLineLabels(t){const e=Pr(t.paths,this.current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),s=(this._shapedBox.width+this._repeatLabelDistance)/(1<<Zt);for(const n of e)Lr(n,s,i,this._repeatLabel)}_placeSubdivGlyphs(t,e,i,s){const n=Ar(e),a=this._shapedBox.width/(1<<Zt),o=Math.sqrt(this._repeatLabelDistance)/(1<<Zt),h=Math.min(i,s-i),l=Math.log2(h/(o+a/2)),c=e===0?l:Math.min(n,l),u=Math.max(this._minZoom,this.current.zoomLevel+Zt-c),f=this.current.zoomLevel-u,_=this._shapedBox.width/2*2**f;this.current.inShaping.isMultiline?e===0&&this._placeStraight(t,u):this._allowOverrun&&f<0?this._placeStraightAlong(t,this._minZoom):this._labelPosition==="parallel"?this._placeStraightAlong(t,u):this._labelPosition==="curved"&&this._placeCurved(t,u,_)}_placeStraight(t,e){const{out:i,inId:s,inShaping:n}=this.current;this._writeGlyphs(i,s,t,n,e)}_placeCurved(t,e,i){const{out:s,inId:n}=this.current;s.metricStart(n,e,t.x,t.y,0,0,0,0);const a=t.clone(),o=t.angle*(180/Math.PI)%360,h=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=qt(o),this._placeFirst(a,e,1),this._placeBack(t,a,e,i,1),this._placeForward(t,a,e,i,1),this._outLineLabelAngle=qt(h),this._placeFirst(a,e,0),this._placeBack(t,a,e,i,0),this._placeForward(t,a,e,i,0),s.metricEnd()}_placeStraightAlong(t,e){const{out:i,inId:s}=this.current;i.metricStart(s,e,t.x,t.y,0,0,0,0);const n=t.clone(),a=t.angle*(180/Math.PI)%360,o=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=qt(a),this._placeFirst(n,e,1,!0),this._outLineLabelAngle=qt(o),this._placeFirst(n,e,0,!0),i.metricEnd()}_placeBack(t,e,i,s,n){const a=t.clone();let o=t.backwardLength+xt;for(;a.prev()&&!(o>=s);)this._placeOnSegment(a,e,o,i,-1,n),o+=a.length+xt}_placeForward(t,e,i,s,n){const a=t.clone();let o=t.remainingLength+xt;for(;a.next()&&!(o>=s);)this._placeOnSegment(a,e,o,i,1,n),o+=a.length+xt}_placeFirst(t,e,i,s=!1){const n=t,a=this.current.inShaping,o=a.glyphs,h=this.current.zoomLevel,{out:l,inId:c}=this.current;for(const u of o){const f=u.x>a.bounds.x?i:1-i,_=f*t.remainingLength+(1-f)*t.backwardLength,m=Math.abs(u.x+u.width/2-a.bounds.x),d=Math.max(0,h+Math.log2(m/(_+xt))),p=Math.max(e,s?0:d);if(u.maxZoom=25,u.angle=t.angle+(1-i)*Math.PI,u.minZoom=p,this._writeGlyph(l,c,n.x,n.y,u),i&&this._isVisible(u.minZoom,u.maxZoom)){const y=u.bounds;l.metricBoxWrite(y.center[0],y.center[1],y.width,y.height)}}}_placeOnSegment(t,e,i,s,n,a){const o=this.current.inShaping.glyphs,{out:h,inId:l}=this.current,c=this.current.inShaping,u=this.current.zoomLevel,f=t.dx/t.length,_=t.dy/t.length,m={x:t.x+i*-n*f,y:t.y+i*-n*_};for(const d of o){const p=d.x>c.bounds.x?a:1-a;if(!(p&&n===1||!p&&n===-1))continue;const y=Math.abs(d.x+d.width/2-c.bounds.x),x=Math.max(0,u+Math.log2(y/i)-.1),M=Math.max(s,u+Math.log2(y/(i+t.length+xt)));if(x!==0&&(d.angle=t.angle+(1-a)*Math.PI,d.minZoom=M,d.maxZoom=x,this._writeGlyph(h,l,m.x,m.y,d),a&&this._isVisible(d.minZoom,d.maxZoom))){const v=d.bounds,S=t.x-e.x,T=t.y-e.y;h.metricBoxWrite(v.center[0]+S,v.center[1]+T,v.width,v.height)}}}_writeGlyphs(t,e,i,s,n=this._minZoom){if(i.x<0||i.x>=512||i.y<0||i.y>=512)return;const a=i.x+this._refOffsetX,o=i.y-this._refOffsetY;for(const u of s.glyphs)u.minZoom=n,u.maxZoom=this._maxZoom,this._writeGlyph(t,e,a,o,u);const h=this._refPlacementDirX,l=this._refPlacementDirY,c=s.boundsT;t.metricStart(e,n,a,o,h,l,this._referenceSize,this._materialKey),t.metricBoxWrite(c.center[0],c.center[1],c.width,c.height),t.metricEnd()}_writeVertexCommon(t,e,i,s){const n=this._color,a=this._haloColor,o=z(0,0,this._size,this._haloSize),h=Math.max(s.minZoom,this._minZoom),l=Math.min(s.maxZoom,this._maxZoom),c=z(Lt(h),Lt(l),this._outLineLabelAngle,0);t.vertexWrite(i),t.vertexWrite(e),t.vertexWrite(n),t.vertexWrite(a),t.vertexWrite(o),t.vertexWrite(this._refSymbolAndPlacementOffset),t.vertexWrite(c)}}const _i=3.14159265359/180,mi=8,Yi=r=>class extends r{constructor(...t){super(...t),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this._vertexBoundsScaleX=1,this._vertexBoundsScaleY=1,this._offsets={xUpperLeft:0,yUpperLeft:0,xUpperRight:0,yUpperRight:0,xBottomLeft:0,yBottomLeft:0,xBottomRight:0,yBottomRight:0},this.geometryType=I.MARKER}_write(t,e,i,s){const n=e.getDisplayId();t.recordStart(n,this._materialKey,this.geometryType,!0),this._writeGeometry(t,e,n,i,s),t.recordEnd()}_writeGeometry(t,e,i,s,n){if(W(this._markerPlacement))return this._writePlacedMarkers(t,e,s,n);if(!n&&e.geometryType==="esriGeometryPoint"){const o=e.getX(),h=e.getY();return!t.hasAggregates&&t.hasPixelBufferEnabled&&(o<0||o>=513||h<0||h>=513)?void 0:this._writeVertices(t,i,this._getPos(o,h),o,h)}const a=n?Le(Pe(n),2):e.geometryType==="esriGeometryPolygon"?e.readCentroid():e.readGeometryForDisplay();if(!R(a)){if(a.isPoint){const[o,h]=a.coords;return!t.hasAggregates&&t.hasPixelBufferEnabled&&(o<0||o>=512||h<0||h>=512)?void 0:this._writeVertices(t,i,this._getPos(o,h),o,h)}a.forEachVertex((o,h)=>this._writeVertices(t,i,this._getPos(o,h),o,h))}}_writePlacedMarkers(t,e,i,s){const n=s!=null?s:e.readLegacyGeometryForDisplay(),a=Hi.getPlacement(n,Jt(this._markerPlacement),g(1),i.geometryEngine);if(!a)return;const o=e.getDisplayId(),h=vt(),l=it(),c=-128,u=640;let f=a.next();for(;f!=null;){const _=f.tx,m=-f.ty;_>=c&&_<=u&&m>=c&&m<=u&&(this._applyTransformation(l,h,-f.getAngle()/_i),this._writeVertices(t,o,this._getPos(_,m),_,m)),f=a.next()}}_writeVertices(t,e,i,s,n){const a=t.vertexCount();if(this.angle){const o=Math.max(this._computedWidth*this._vertexBoundsScaleX,this._computedHeight*this._vertexBoundsScaleY);t.vertexBounds(s+this.xOffset,n-this.yOffset,o,o)}else t.vertexBounds(s+this.xOffset,n-this.yOffset,this._computedWidth*this._vertexBoundsScaleX,this._computedHeight*this._vertexBoundsScaleY);t.vertexWrite(i),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(this._texUpperLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(this._texUpperRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(this._texBottomLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(this._texBottomRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.indexWrite(a+0),t.indexWrite(a+1),t.indexWrite(a+2),t.indexWrite(a+1),t.indexWrite(a+3),t.indexWrite(a+2)}_applyTransformation(t,e,i=0){fs(t,Ii(this.xOffset,-this.yOffset)),this.angle+i!==0&&de(t,t,_i*(this.angle+i));const s=this._computedWidth,n=this._computedHeight,a=(this._anchorX-.5)*s,o=(this._anchorY-.5)*n;et(e,a,o),Pt(e,e,t),this._offsetUpperLeft=w(16*e[0],16*e[1]),this._offsets.xUpperLeft=e[0],this._offsets.yUpperLeft=e[1],et(e,a+s,o),Pt(e,e,t),this._offsetUpperRight=w(16*e[0],16*e[1]),this._offsets.xUpperRight=e[0],this._offsets.yUpperRight=e[1],et(e,a,o+n),Pt(e,e,t),this._offsetBottomLeft=w(16*e[0],16*e[1]),this._offsets.xBottomLeft=e[0],this._offsets.yBottomLeft=e[1],et(e,a+s,o+n),Pt(e,e,t),this._offsetBottomRight=w(16*e[0],16*e[1]),this._offsets.xBottomRight=e[0],this._offsets.yBottomRight=e[1]}_getPos(t,e){return w(Math.round(mi*t),Math.round(mi*e))}};class Z extends Yi(Rt){constructor(t,e,i,s,n,a,o,h,l,c,u,f,_,m,d,p,y,x,M,v,S,T,L){super(),this.angle=s,this.height=o,this.width=a,this.xOffset=e*M,this.yOffset=i*M,this._markerPlacement=v,this._effects=S,this._anchorX=.5-(.5+p)*d.width/d.width,this._anchorY=.5-(.5+y)*d.height/d.height,this._minMaxZoom=w(Math.round(T*F),Math.round(L*F));const P=(m===D.MAP?Zs:Ns)|(u?Mt:0)|(_?qs:0)|(f?Xs:0),_t=d&&d.sdf,nt=Ki.load(t);nt.sdf=_t,nt.pattern=!0,nt.textureBinding=d.textureBinding,this._materialKey=nt.data,this._fillColor=n,this._outlineColor=l,this._sizeOutlineWidth=z(Math.round(Math.min(Math.sqrt(128*a),255)),Math.round(Math.min(Math.sqrt(128*o),255)),Math.round(Math.min(Math.sqrt(128*c),255)),Math.round(Math.min(Math.sqrt(128*h),255)));const K=d.rect.x+$,at=d.rect.y+$,mt=K+d.width,At=at+d.height;this._offsets.xUpperLeft=K,this._offsets.yUpperLeft=at,this._offsets.xUpperRight=mt,this._offsets.yUpperRight=at,this._offsets.xBottomLeft=K,this._offsets.yBottomLeft=At,this._offsets.xBottomRight=mt,this._offsets.yBottomRight=At,this._texUpperLeft=w(K,at),this._texUpperRight=w(mt,at),this._texBottomLeft=w(K,At),this._texBottomRight=w(mt,At),a*=x,o*=x,a*=M,o*=M;const ss=Math.round(64*x);this._bitestAndDistRatio=w(P,ss),this._computedWidth=a,this._computedHeight=o;const rs=vt(),ns=it();this._applyTransformation(ns,rs)}static fromCIMMarker(t,e,i){const s=e&&e.width||1,n=e&&e.height||1,a=t.size,o=s/n*t.scaleX,h=t.scaleSymbolsProportionally&&t.frameHeight?a/t.frameHeight:1;let l=C(t.color);const c=C(t.outlineColor),u=g(a),f=u*o,_=g(t.offsetX||0),m=g(t.offsetY||0),d=g(t.outlineWidth||0)*h,p=t.alignment||D.SCREEN,y=g(t.referenceSize),[x,M]=rt(t.scaleInfo,i);e.sdf||l!==0||(l=-1);let v=t.rotation||0;t.rotateClockwise||(v=-v);let S=0,T=0;const L=t.anchorPoint;L&&(t.isAbsoluteAnchorPoint?a&&(S=-L.x/(a*o),T=L.y/a):(S=L.x,T=L.y));const P=new Z(t.materialKey,_,m,v,l,f,u,y,c,d,t.colorLocked,t.scaleSymbolsProportionally,!1,p,e,S,T,t.sizeRatio,Wi(t.scaleFactor,1),t.markerPlacement,t.effects,x,M);return P._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/f:1,P._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/u:1,P}static fromPictureMarker(t,e){const i=Math.round(g(t.width)),s=Math.round(g(t.height)),n=Vi,a=Math.round(g(t.xoffset||0)),o=Math.round(g(t.yoffset||0)),h=new Z(t.materialKey,a,o,t.angle,n,i,s,s,0,0,!1,!1,!1,D.SCREEN,e,0,0,1,1,null,null,N,q);return h._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.width:1,h._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.height:1,h}static fromSimpleMarker(t,e){const i=Y(t.color),s=Math.round(g(t.size)),n=s,a=Math.round(g(t.xoffset||0)),o=Math.round(g(t.yoffset||0)),h=t.style,l=t.outline,c=0|(l&&l.color&&Y(l.color)),u=0|(l&&l.width&&Math.round(g(l.width))),f=new Z(t.materialKey,a,o,t.angle,i,s,n,n,c,u,!1,!1,h==="esriSMSCross"||h==="esriSMSX",D.SCREEN,e,0,0,126/64,1,null,null,N,q);return f.boundsType=h==="esriSMSCircle"?"circle":"square",f._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.size:1,f._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.size:1,f}static fromLineSymbolMarker(t,e){const i=Y(t.color),s=6,n=Math.round(g(s*t.lineWidth)),a=n,o=t.style==="cross"||t.style==="x";let h;switch(t.placement){case"begin-end":h=Bt.Both;break;case"begin":h=Bt.JustBegin;break;case"end":h=Bt.JustEnd;break;default:h=Bt.None}const l={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:h,offsetAlongLine:0},c=new Z(t.materialKey,0,0,0,i,n,a,a/s,i,o?Math.round(g(t.lineWidth)):0,!1,!1,o,D.MAP,e,0,0,126/64,1,l,null,N,q);return c.boundsType=t.style==="circle"?"circle":"square",c}}function Br(r,t,e,i,s,n,a){we=0;const o=(i-e)*n,h=s&&s.length,l=h?(s[0]-e)*n:o;let c,u,f,_,m,d=ji(t,e,i,0,l,n,!0);if(d&&d.next!==d.prev){if(h&&(d=Kr(t,e,i,s,d,n)),o>80*n){c=f=t[0+e*n],u=_=t[1+e*n];for(let p=n;p<l;p+=n){const y=t[p+e*n],x=t[p+1+e*n];c=Math.min(c,y),u=Math.min(u,x),f=Math.max(f,y),_=Math.max(_,x)}m=Math.max(f-c,_-u),m=m!==0?1/m:0}kt(d,r,n,c,u,m,a,0)}}function ji(r,t,e,i,s,n,a){let o;if(a===Xr(r,t,e,i,s,n)>0)for(let h=i;h<s;h+=n)o=pi(h+t*n,r[h+t*n],r[h+1+t*n],o);else for(let h=s-n;h>=i;h-=n)o=pi(h+t*n,r[h+t*n],r[h+1+t*n],o);return o&&lt(o,o.next)&&(Ft(o),o=o.next),o}function Wt(r,t=r){if(!r)return r;let e,i=r;do if(e=!1,i.steiner||!lt(i,i.next)&&k(i.prev,i,i.next)!==0)i=i.next;else{if(Ft(i),i=t=i.prev,i===i.next)break;e=!0}while(e||i!==t);return t}function kt(r,t,e,i,s,n,a,o){if(!r)return;!o&&n&&(r=Qi(r,i,s,n));let h=r;for(;r.prev!==r.next;){const l=r.prev,c=r.next;if(n?Vr(r,i,s,n):Or(r))t.push(l.index/e+a),t.push(r.index/e+a),t.push(c.index/e+a),Ft(r),r=c.next,h=c.next;else if((r=c)===h){o?o===1?kt(r=Ur(r,t,e,a),t,e,i,s,n,a,2):o===2&&Yr(r,t,e,i,s,n,a):kt(Wt(r),t,e,i,s,n,a,1);break}}}function Or(r){const t=r.prev,e=r,i=r.next;if(k(t,e,i)>=0)return!1;let s=r.next.next;const n=s;let a=0;for(;s!==r.prev&&(a===0||s!==n);){if(a++,wt(t.x,t.y,e.x,e.y,i.x,i.y,s.x,s.y)&&k(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function Vr(r,t,e,i){const s=r.prev,n=r,a=r.next;if(k(s,n,a)>=0)return!1;const o=s.x<n.x?s.x<a.x?s.x:a.x:n.x<a.x?n.x:a.x,h=s.y<n.y?s.y<a.y?s.y:a.y:n.y<a.y?n.y:a.y,l=s.x>n.x?s.x>a.x?s.x:a.x:n.x>a.x?n.x:a.x,c=s.y>n.y?s.y>a.y?s.y:a.y:n.y>a.y?n.y:a.y,u=ge(o,h,t,e,i),f=ge(l,c,t,e,i);let _=r.prevZ,m=r.nextZ;for(;_&&_.z>=u&&m&&m.z<=f;){if(_!==r.prev&&_!==r.next&&wt(s.x,s.y,n.x,n.y,a.x,a.y,_.x,_.y)&&k(_.prev,_,_.next)>=0||(_=_.prevZ,m!==r.prev&&m!==r.next&&wt(s.x,s.y,n.x,n.y,a.x,a.y,m.x,m.y)&&k(m.prev,m,m.next)>=0))return!1;m=m.nextZ}for(;_&&_.z>=u;){if(_!==r.prev&&_!==r.next&&wt(s.x,s.y,n.x,n.y,a.x,a.y,_.x,_.y)&&k(_.prev,_,_.next)>=0)return!1;_=_.prevZ}for(;m&&m.z<=f;){if(m!==r.prev&&m!==r.next&&wt(s.x,s.y,n.x,n.y,a.x,a.y,m.x,m.y)&&k(m.prev,m,m.next)>=0)return!1;m=m.nextZ}return!0}function pi(r,t,e,i){const s=Tt.create(r,t,e);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}function Ft(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function Dr(r){let t=r,e=r;do(t.x<e.x||t.x===e.x&&t.y<e.y)&&(e=t),t=t.next;while(t!==r);return e}function Kr(r,t,e,i,s,n){const a=new Array;for(let o=0,h=i.length;o<h;o++){const l=ji(r,t,e,i[o]*n,o<h-1?i[o+1]*n:e*n,n,!1);l===l.next&&(l.steiner=!0),a.push(Dr(l))}a.sort(Hr);for(const o of a)Gr(o,s),s=Wt(s,s.next);return s}function Gr(r,t){if(t=Zr(r,t)){const e=ts(t,r);Wt(e,e.next)}}function Zr(r,t){let e=t;const i=r.x,s=r.y;let n,a=-1/0;do{if(s<=e.y&&s>=e.next.y&&e.next.y!==e.y){const f=e.x+(s-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(f<=i&&f>a){if(a=f,f===i){if(s===e.y)return e;if(s===e.next.y)return e.next}n=e.x<e.next.x?e:e.next}}e=e.next}while(e!==t);if(!n)return null;if(i===a)return n.prev;const o=n,h=n.x,l=n.y;let c,u=1/0;for(e=n.next;e!==o;)i>=e.x&&e.x>=h&&i!==e.x&&wt(s<l?i:a,s,h,l,s<l?a:i,s,e.x,e.y)&&(c=Math.abs(s-e.y)/(i-e.x),(c<u||c===u&&e.x>n.x)&&Et(e,r)&&(n=e,u=c)),e=e.next;return n}function Qi(r,t,e,i){for(let s;s!==r;s=s.next){if(s=s||r,s.z===null&&(s.z=ge(s.x,s.y,t,e,i)),s.prev.next!==s||s.next.prev!==s)return s.prev.next=s,s.next.prev=s,Qi(r,t,e,i);s.prevZ=s.prev,s.nextZ=s.next}return r.prevZ.nextZ=null,r.prevZ=null,Nr(r)}function Nr(r){let t,e=1;for(;;){let i,s=r;r=null,t=null;let n=0;for(;s;){n++,i=s;let a=0;for(;a<e&&i;a++)i=i.nextZ;let o=e;for(;a>0||o>0&&i;){let h;a===0?(h=i,i=i.nextZ,o--):o!==0&&i?s.z<=i.z?(h=s,s=s.nextZ,a--):(h=i,i=i.nextZ,o--):(h=s,s=s.nextZ,a--),t?t.nextZ=h:r=h,h.prevZ=t,t=h}s=i}if(t.nextZ=null,e*=2,n<2)return r}}function k(r,t,e){return(t.y-r.y)*(e.x-t.x)-(t.x-r.x)*(e.y-t.y)}function Ji(r,t,e,i){return!!(lt(r,t)&&lt(e,i)||lt(r,i)&&lt(e,t))||k(r,t,e)>0!=k(r,t,i)>0&&k(e,i,r)>0!=k(e,i,t)>0}function qr(r,t){let e=r;do{if(e.index!==r.index&&e.next.index!==r.index&&e.index!==t.index&&e.next.index!==t.index&&Ji(e,e.next,r,t))return!0;e=e.next}while(e!==r);return!1}function Xr(r,t,e,i,s,n){let a=0;for(let o=i,h=s-n;o<s;o+=n)a+=(r[h+t*n]-r[o+t*n])*(r[o+1+t*n]+r[h+1+t*n]),h=o;return a}function wt(r,t,e,i,s,n,a,o){return(s-a)*(t-o)-(r-a)*(n-o)>=0&&(r-a)*(i-o)-(e-a)*(t-o)>=0&&(e-a)*(n-o)-(s-a)*(i-o)>=0}function Et(r,t){return k(r.prev,r,r.next)<0?k(r,t,r.next)>=0&&k(r,r.prev,t)>=0:k(r,t,r.prev)<0||k(r,r.next,t)<0}function ge(r,t,e,i,s){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=32767*(r-e)*s)|r<<8))|r<<4))|r<<2))|r<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*s)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function lt(r,t){return r.x===t.x&&r.y===t.y}function Hr(r,t){return r.x-t.x}function Ur(r,t,e,i){let s=r;do{const n=s.prev,a=s.next.next;!lt(n,a)&&Ji(n,s,s.next,a)&&Et(n,a)&&Et(a,n)&&(t.push(n.index/e+i),t.push(s.index/e+i),t.push(a.index/e+i),Ft(s),Ft(s.next),s=r=a),s=s.next}while(s!==r);return s}function Yr(r,t,e,i,s,n,a){let o=r;do{let h=o.next.next;for(;h!==o.prev;){if(o.index!==h.index&&jr(o,h)){let l=ts(o,h);return o=Wt(o,o.next),l=Wt(l,l.next),kt(o,t,e,i,s,n,a,0),void kt(l,t,e,i,s,n,a,0)}h=h.next}o=o.next}while(o!==r)}function jr(r,t){return r.next.index!==t.index&&r.prev.index!==t.index&&!qr(r,t)&&Et(r,t)&&Et(t,r)&&Qr(r,t)}function Qr(r,t){let e=r,i=!1;const s=(r.x+t.x)/2,n=(r.y+t.y)/2;do e.y>n!=e.next.y>n&&e.next.y!==e.y&&s<(e.next.x-e.x)*(n-e.y)/(e.next.y-e.y)+e.x&&(i=!i),e=e.next;while(e!==r);return i}function ts(r,t){const e=Tt.create(r.index,r.x,r.y),i=Tt.create(t.index,t.x,t.y),s=r.next,n=t.prev;return r.next=t,t.prev=r,e.next=s,s.prev=e,i.next=e,e.prev=i,n.next=i,i.prev=n,i}class Tt{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,i){const s=we<Me.length?Me[we++]:new Tt;return s.index=t,s.x=e,s.y=i,s.prev=null,s.next=null,s.z=null,s.prevZ=null,s.nextZ=null,s.steiner=!1,s}}const Me=new Array,Jr=8096;let we=0;for(let r=0;r<Jr;r++)Me.push(new Tt);const tn=1e-5,ht=new Di(0,0,0,1,0),ve=new Di(0,0,0,1,0);function yi(r,t,e){let i=0;for(let s=1;s<e;s++){const n=r[2*(t+s-1)],a=r[2*(t+s-1)+1];i+=(r[2*(t+s)]-n)*(r[2*(t+s)+1]+a)}return i}function en(r,t,e,i,s){let n=0;const a=2;for(let o=e;o<i;o+=3){const h=(r[o]-s)*a,l=(r[o+1]-s)*a,c=(r[o+2]-s)*a;n+=Math.abs((t[h]-t[c])*(t[l+1]-t[h+1])-(t[h]-t[l])*(t[c+1]-t[h+1]))}return n}function sn(r,t){const{coords:e,lengths:i,hasIndeterminateRingOrder:s}=t,n=0,a=r;if(s)return!1;let o=0;for(let h=0;h<i.length;){let l=h,c=i[h],u=yi(e,o,c);const f=[];for(;++l<i.length;){const p=i[l],y=yi(e,o+c,p);if(!(y>0))break;u+=y,f.push(o+c),c+=p}const _=a.length;Br(a,e,o,o+c,f,2,n);const m=en(a,e,_,a.length,n),d=Math.abs(u);if(Math.abs((m-d)/Math.max(1e-7,d))>tn)return a.length=0,!1;h=l,o+=c}return!0}function rn(r){const{coords:t,lengths:e}=r,{buffer:i}=er(t,e);return i}function nn(r,t,e){let i=0;for(let s=0;s<r.lengths.length;s++){const n=r.lengths[s];for(let a=0;a<n;a++){const o=r.coords[2*(a+i)],h=r.coords[2*(a+i)+1];if(o<t||o>e||h<t||h>e)return!0}i+=n}return!1}function an(r,t){if(R(r))return null;if(!nn(r,-128,bt+128))return r;ht.setPixelMargin(t),ht.reset(Gi.Polygon);let e=0;for(let a=0;a<r.lengths.length;a++){const o=r.lengths[a];let h=r.coords[2*(0+e)],l=r.coords[2*(0+e)+1];ht.moveTo(h,l);for(let c=1;c<o;c++)h=r.coords[2*(c+e)],l=r.coords[2*(c+e)+1],ht.lineTo(h,l);ht.close(),e+=o}const i=ht.result(!1);if(!i)return null;const s=[],n=[];for(const a of i){let o=0;for(const h of a)n.push(h.x),n.push(h.y),o++;s.push(o)}return new ds(s,n)}function on(r,t){ve.setPixelMargin(t);const e=ve,i=-t,s=bt+t;let n=[],a=!1,o=0;for(;o<r.length;){const h=[],l=r[o];if(!l)return null;e.reset(Gi.LineString);let[c,u]=l[0];if(a)e.moveTo(c,u);else{if(c<i||c>s||u<i||u>s){a=!0;continue}h.push({x:c,y:u})}let f=!1;const _=l.length;for(let m=1;m<_;++m)if(c+=l[m][0],u+=l[m][1],a)e.lineTo(c,u);else{if(c<i||c>s||u<i||u>s){f=!0;break}h.push({x:c,y:u})}if(f)a=!0;else{if(a){const m=e.resultWithStarts();if(m)for(const d of m)n.push(d)}else n.push({line:h,start:0});o++,a=!1}}return n=n.filter(h=>h.line.length>1),n.length===0?null:n}ht.setExtent(bt),ve.setExtent(bt);const Qt=8,B=16,xi=65535,es=r=>class extends r{constructor(...t){super(...t),this.tessellationProperties={},this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0},this.geometryType=I.LINE}writeGeometry(t,e,i,s){this._writeGeometry(t,e,i,s)}_initializeTessellator(t){const e=Ut.load(this._materialKey),i=Ct.load(this._materialKey),s=this._tessellationOptions,n=e.vvSizeFieldStops||e.vvSizeMinMaxValue||e.vvSizeScaleStops||e.vvSizeUnitValue,a=this.tessellationProperties._halfWidth<Hs&&!t&&!n;this.tessellationProperties.minMaxZoom=this._minMaxZoom,s.wrapDistance=xi,s.textured=this._isDashed||this._hasPattern,s.offset=this.tessellationProperties.offset,s.halfWidth=this.tessellationProperties._halfWidth;const o=a?0:1,h=i.outlinedFill?ln:hn;this._lineTessellator=new ir(h(this.tessellationProperties,o,o),cn(this.tessellationProperties),a)}_write(t,e,i,s){const n=e.geometryType==="esriGeometryPoint";t.recordStart(e.getDisplayId(),this._materialKey,this.geometryType,n),this._writeGeometry(t,e,s,n),t.recordEnd()}_writeGeometry(t,e,i,s){const n=i!=null?i:e.readLegacyGeometryForDisplay(),a=this._getLines(n,s);R(a)||this._writeVertices(t,e,a)}_getLines(t,e){if(R(t))return null;const i=t.paths||t.rings;return R(i)?null:on(i,e?256:16)}_writeVertices(t,e,i){const s=e.getDisplayId(),n=t.vertexCount(),a=this.tessellationProperties,o=this._tessellationOptions;a.out=t,a.id=s,a.indexCount=0,a.vertexCount=0,a.offset=n,o.capType=this._capType,o.joinType=this._joinType;const h=Ct.load(this._materialKey);this.tessellationProperties.key=h.outlinedFill?h:Ut.load(this._materialKey);for(const{line:l,start:c}of i)o.initialDistance=c%xi,this._lineTessellator.tessellate(l,o)}},hn=(r,t,e)=>(i,s,n,a,o,h,l,c,u,f,_)=>{const m=w(_,Math.ceil(B*r._halfWidth)),d=z(Math.round(B*l),Math.round(B*c),Math.round(B*u),Math.round(B*f)),p=z(B*o,B*h,0,r._bitset),y=r.out;return y.vertexBounds(i,s,t,e),y.vertexWrite(w(Qt*i,Qt*s)),y.vertexWrite(r.id),y.vertexWrite(r._fillColor),y.vertexWrite(d),y.vertexWrite(m),y.vertexWrite(r._tl),y.vertexWrite(r._br),y.vertexWrite(p),y.vertexWrite(w(Math.ceil(B*r._halfReferenceWidth),0)),y.vertexWrite(r.minMaxZoom),y.vertexEnd(),r.offset+r.vertexCount++},ln=(r,t,e)=>(i,s,n,a,o,h,l,c,u,f,_)=>{const m=z(0,0,B*r._halfWidth,B*r._halfReferenceWidth),d=z(B*l+128,B*c+128,B*u+128,B*f+128),p=r.out,y=r._bitset<<24|r.id;return p.vertexBounds(i,s,t,e),p.vertexWrite(w(Qt*i,Qt*s)),p.vertexWrite(y),p.vertexWrite(r._fillColor),r.key.simple||(p.vertexWrite(0),p.vertexWrite(0)),p.vertexWrite(m),p.vertexWrite(d),r.key.simple||p.vertexWrite(r.minMaxZoom),p.vertexEnd(),r.offset+r.vertexCount++},cn=r=>(t,e,i)=>{const s=r.out;s.indexWrite(t),s.indexWrite(e),s.indexWrite(i),r.indexCount+=3},un=ut.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate");class H extends es(Rt){constructor(t,e,i,s,n,a,o,h,l,c,u,f,_,m,d,p,y,x,M){super();const v=Ut.load(t);e&&(v.sdf=e.sdf,v.pattern=!0,v.textureBinding=e.textureBinding),this._capType=s,this._joinType=n,this._miterLimitCosine=xe(a),this.tessellationProperties._fillColor=o,this.tessellationProperties._tl=h,this.tessellationProperties._br=l,this._hasPattern=c,this._isDashed=u,this._zOrder=p,this._effects=y,this._minMaxZoom=w(Math.round(x*F),Math.round(M*F)),this._materialKey=v.data;const S=(_?Mt:0)|(m?Us:0)|(f?Ys:0);this.tessellationProperties._bitset=S,this.tessellationProperties._halfWidth=.5*i,this.tessellationProperties._halfReferenceWidth=.5*d,this.tessellationProperties.offset=0,this._initializeTessellator(!1)}static fromCIMLine(t,e,i){const s=t.color,n=t.scaleFactor||1,a=!!t.dashTemplate;let o=t.cap;a&&o===Je.ROUND&&(o=Je.SQUARE);const h=t.join,l=g(t.width)*n,c=g(t.referenceWidth),u=g(t.miterLimit),f=s&&C(s)||0,[_,m]=rt(t.scaleInfo,i),d=!1;if(!e)return new H(t.materialKey,e,l,o,h,u,f,0,0,!1,a,t.scaleDash,t.colorLocked,d,c,t.zOrder,t.effects,_,m);const{rect:p,width:y,height:x}=e,M=p.x+$,v=p.y+$,S=M+y,T=v+x,L=w(M,v),P=w(S,T),_t=!1;return new H(t.materialKey,e,l,o,h,u,f,L,P,!0,a,t.scaleDash,t.colorLocked,_t,c,t.zOrder,t.effects,_,m)}static fromFillOutline(t){var e;return t.isOutlinedFill&&t.outline&&((e=t.outline)==null?void 0:e.style)==="esriSLSSolid"?H.fromSimpleLine(ot({hash:"",materialKey:t.materialKey},t.outline),null,!0):null}static fromSimpleLine(t,e,i=!1){const{color:s}=t,n=t.style!=="esriSLSSolid"&&t.style!=="esriSLSNull",a=js(t.cap||"round"),o=Qs(t.join||"round");let h=s&&t.style!=="esriSLSNull"&&Y(s)||0;t.style==="esriSLSNull"&&(h=0);const l=g(t.width),c=t.miterLimit;if(!e)return new H(t.materialKey,e,l,a,o,c,h,0,0,!1,n,!0,!1,i,l,0,null,N,q);const{rect:u,width:f,height:_}=e,m=u.x+$,d=u.y+$,p=m+f,y=d+_,x=w(m,d),M=w(p,y);return new H(t.materialKey,e,l,a,o,c,h,x,M,!0,n,!0,!1,i,l,0,null,N,q)}static fromPictureLineSymbol(t,e,i,s){return un.error("PictureLineSymbol support does not exist!"),null}}const fn=100,gi=1,is=r=>class extends r{constructor(...t){super(...t),this.forceLibtess=!1,this._bitset=0,this._lineTemplate=null,this.geometryType=I.FILL}_maybeAddLineTemplate(t){this._lineTemplate=H.fromFillOutline(t)}_write(t,e,i,s){const n=e.geometryType==="esriGeometryPoint",a=Ct.load(this._materialKey);t.recordStart(e.getDisplayId(),this._materialKey,this.geometryType,n),this._writeGeometry(t,e,a,s,n),a.outlinedFill&&W(this._lineTemplate)&&this._lineTemplate.writeGeometry(t,e,s,n),t.recordEnd()}_writeGeometry(t,e,i,s,n){const a=this._getGeometry(e,s,n);if(R(a))return;const o=[];if(!(a.maxLength>fn)&&!this.forceLibtess&&sn(o,a))return void(o.length&&this._writeVertices(t,e,a.coords,a.lengths,i,o));const h=rn(a);this._writeVertices(t,e,h,[h.length/2],i)}_writeVertex(t,e,i,s,n,a){const o=w(gi*s,gi*n);t.vertexBounds(s,n,0,0),t.vertexWrite(o),t.vertexWrite(e),i.dotDensity?t.vertexWriteF32(1/Math.abs(a.readGeometryArea())):(t.vertexWrite(this.fillColor),i.simple||(t.vertexWrite(this.tl),t.vertexWrite(this.br)),t.vertexWrite(this.aux2),t.vertexWrite(this.aux3),i.simple||t.vertexWrite(this._minMaxZoom))}_writeVertices(t,e,i,s,n,a){const o=e.getDisplayId(),h=this._bitset<<24|o,l=s.reduce((_,m)=>_+m),c=n.dotDensity?4:10,u=t.vertexCount();t.vertexEnsureSize(c*l);let f=0;if(a)for(const _ of a){const m=i[2*_],d=i[2*_+1];this._writeVertex(t,h,n,m,d,e),f++}else for(let _=0;_<i.length;_+=2){const m=Math.round(i[_]),d=Math.round(i[_+1]);this._writeVertex(t,h,n,m,d,e),f++}t.indexEnsureSize(f);for(let _=0;_<f;_++)t.indexWrite(_+u)}_getGeometry(t,e,i){const s=e?Le(Pe(e),2):t.readGeometryForDisplay();return s?an(s,i?256:8):null}},Mi=ut.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class ne extends Rt{constructor(t){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=t}analyze(t,e,i,s,n){if(n&&n.length===0)return null;const a=n&&n.length>0,o=e.readLegacyFeature(),h=this._materialCache,l=this._cimLayer.materialHash;if(!l)return Mi.error("A Dynamic mesh template must have a material hash value or function!"),Promise.reject(null);const c=typeof l=="function"?l(o,i,s):l;if(h.has(c)){const x=h.get(c);return Promise.resolve(x)}const u=this._ongoingMaterialRequestMap.get(c);if(u)return u;const f=this._cimLayer,_=hr(f.cim,this._cimLayer.materialOverrides);_.mosaicHash=c;const{type:m,url:d}=f,p={cim:_,type:m,mosaicHash:c,url:d,size:null,dashTemplate:null,text:null,fontName:null};switch(m){case"marker":p.size=oe(f.size,o,i,s);break;case"line":p.dashTemplate=f.dashTemplate;break;case"text":p.text=oe(f.text,o,i,s),p.fontName=oe(f.fontName,o,i,s)}const y=t.getMosaicItem(p,n).then(x=>(a||(this._ongoingMaterialRequestMap.delete(c),h.set(c,x)),x)).catch(x=>(this._ongoingMaterialRequestMap.delete(c),Mi.error(".analyze()",x.message),null));return a||this._ongoingMaterialRequestMap.set(c,y),y}}function O(r,t){if(r&&"name"in r){const e=r;return t&&t.error(new ft(e.name,e.message,e.details)),!1}return!0}const Xt=128;class Ee extends is(ne){constructor(t,e,i){var s;if(super(t),this._minMaxZoom=w(Math.round(e*F),Math.round(i*F)),b(t.color)){const u=(f,_,m)=>{const d=t.color(f,_,m);return d&&C(d)||0};this._dynamicPropertyMap.set("fillColor",u)}else{const u=t.color;this.fillColor=u&&C(u)||0}const n=((s=t.cim.placement)==null?void 0:s.type)==="CIMMarkerPlacementInsidePolygon"&&t.cim.placement.shiftOddRows?2:1,a=t.height;if(b(a)){const u=(f,_,m)=>a(f,_,m)*n;this._dynamicPropertyMap.set("_height",u)}else this._height=(a||0)*n;const o=t.offsetX;if(b(o)){const u=(f,_,m)=>{let d=g(o(f,_,m))+Xt;return d>255?d=255:d<0&&(d=0),d};this._dynamicPropertyMap.set("_offsetX",u)}else{let u=g(o||0)+Xt;u>255?u=255:u<0&&(u=0),this._offsetX=u}const h=t.offsetY;if(b(h)){const u=(f,_,m)=>{let d=g(-h(f,_,m))+Xt;return d>255?d=255:d<0&&(d=0),d};this._dynamicPropertyMap.set("_offsetY",u)}else{let u=g(-h||0)+Xt;u>255?u=255:u<0&&(u=0),this._offsetY=u}const l=t.scaleX;b(l)?this._dynamicPropertyMap.set("_scaleX",l):this._scaleX=l||1;const c=t.angle;if(b(c)){const u=(f,_,m)=>ti(c(f,_,m));this._dynamicPropertyMap.set("_angle",u)}else this._angle=ti(c)||0;if(W(t.effects)){const u=t.effects;b(u)?this._dynamicPropertyMap.set("_effects",u):this._effects=u}this._cimFillLayer=t,this._fillMaterialKey=Ct.load(t.materialKey)}static fromCIMFill(t,e){const[i,s]=rt(t.scaleInfo,e);return new Ee(t,i,s)}bindFeature(t,e,i){const s=t.readLegacyFeature();this._dynamicPropertyMap.forEach((c,u)=>{this[u]=c(s,e,i)});const n=this._fillMaterialKey,a=this._materialCache,o=(0,this._cimFillLayer.materialHash)(s,e,i),h=a.get(o);let l=null;if(h&&O(h.spriteMosaicItem)&&(l=h.spriteMosaicItem),l){const{rect:c,width:u,height:f}=l,_=c.x+$,m=c.y+$,d=_+u,p=m+f;let y=Math.round(g(this._height));y>255?y=255:y<=0&&(y=p-m);let x=Math.round(g(this._height/f*u||0));x>255?x=255:x<=0&&(x=d-_);const M=this._scaleX,v=1;this.tl=w(_,m),this.br=w(d,p),this.aux2=z(x,y,this._offsetX,this._offsetY),this.aux3=z(M,v,this._angle,0),n.sdf=l.sdf,n.pattern=!0,n.textureBinding=l.textureBinding}else this.tl=0,this.br=0,this.aux2=0,this.aux3=0,n.sdf=!1,n.pattern=!1,n.textureBinding=0;this._materialKey=n.data}}class Re extends es(ne){constructor(t,e,i){super(t),this._minMaxZoom=w(Math.round(e*F),Math.round(i*F)),this._cimLineLayer=t;let s=0;b(t.width)||(s=.5*g(t.width));const n=(h,l,c)=>b(t.width)?.5*g(t.width(h,l,c)):s;this._dynamicPropertyMap.set("_halfWidth",n),b(t.cap)?this._dynamicPropertyMap.set("_capType",t.cap):this._capType=t.cap,b(t.join)?this._dynamicPropertyMap.set("_joinType",t.join):this._joinType=t.join;const a=t.color;if(b(a)){const h=(l,c,u)=>C(a(l,c,u));this._dynamicPropertyMap.set("_fillColor",h)}else this._fillColor=a&&C(a)||0;const o=t.miterLimit;if(b(o)){const h=(l,c,u)=>xe(o(l,c,u));this._dynamicPropertyMap.set("_miterLimitCosine",h)}else this._miterLimitCosine=xe(o);if(W(t.effects)){const h=t.effects;b(h)?this._dynamicPropertyMap.set("_effects",h):this._effects=h}this._scaleFactor=t.scaleFactor||1,this._isDashed=t.dashTemplate!=null,this.tessellationProperties._bitset=(t.colorLocked?1:0)|(t.scaleDash?1:0)<<1,this._materialKey=t.materialKey,this._initializeTessellator(!0)}static fromCIMLine(t,e){const[i,s]=rt(t.scaleInfo,e);return new Re(t,i,s)}bindFeature(t,e,i){const s=t.readLegacyFeature();this._dynamicPropertyMap.forEach((c,u)=>{this[u]=c(s,e,i)}),this._halfWidth*=this._scaleFactor;const n=this._materialCache,a=(0,this._cimLineLayer.materialHash)(s,e,i),o=n.get(a);let h=null;if(o&&O(o.spriteMosaicItem)&&(h=o.spriteMosaicItem),h){this._hasPattern=!0;const{rect:c,width:u,height:f}=h,_=c.x+$,m=c.y+$,d=_+u,p=m+f;this.tessellationProperties._tl=w(_,m),this.tessellationProperties._br=w(d,p)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties.offset=0,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const l=Ut.load(this._materialKey);h&&(l.sdf=h.sdf,l.pattern=!0,l.textureBinding=h.textureBinding),this._materialKey=l.data}}const dn=vt(),_n=it(),mn=ut.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");class Ae extends Yi(ne){constructor(t,e,i){super(t),this._cimMarkerLayer=t,this._minMaxZoom=w(Math.round(e*F),Math.round(i*F));const s=t.color;if(b(s)){const f=(_,m,d)=>C(s(_,m,d));this._dynamicPropertyMap.set("_fillColor",f)}else this._fillColor=C(s);const n=t.outlineColor;if(b(n)){const f=(_,m,d)=>C(n(_,m,d));this._dynamicPropertyMap.set("_outlineColor",f)}else this._outlineColor=C(n);const a=t.size;if(b(a)){const f=(_,m,d)=>g(a(_,m,d));this._dynamicPropertyMap.set("_size",f)}else this._size=g(a)||0;const o=t.scaleX;b(o)?this._dynamicPropertyMap.set("_scaleX",o):this._scaleX=o||1;const h=t.offsetX;if(b(h)){const f=(_,m,d)=>g(h(_,m,d));this._dynamicPropertyMap.set("xOffset",f)}else this.xOffset=g(h)||0;const l=t.offsetY;if(b(l)){const f=(_,m,d)=>g(l(_,m,d));this._dynamicPropertyMap.set("yOffset",f)}else this.yOffset=g(l)||0;const c=t.outlineWidth;if(b(c)){const f=(_,m,d)=>g(c(_,m,d));this._dynamicPropertyMap.set("_outlineWidth",f)}else this._outlineWidth=g(c)||0;const u=t.rotation;if(b(u)?this._dynamicPropertyMap.set("_angle",u):this._angle=u||0,W(t.effects)){const f=t.effects;b(f)?this._dynamicPropertyMap.set("_effects",f):this._effects=f}if(W(t.markerPlacement)){const f=t.markerPlacement;b(f)?this._dynamicPropertyMap.set("_markerPlacement",f):this._markerPlacement=f}this._scaleFactor=Wi(t.scaleFactor,1),this._bitSet=(t.alignment===D.MAP?1:0)|(t.colorLocked?1:0)<<1|(t.scaleSymbolsProportionally?1:0)<<3,this._materialKey=t.materialKey}static fromCIMMarker(t,e){const[i,s]=rt(t.scaleInfo,e);return new Ae(t,i,s)}bindFeature(t,e,i){const s=t.readLegacyFeature();this._dynamicPropertyMap.forEach((at,mt)=>{this[mt]=at(s,e,i)});const n=this._cimMarkerLayer.materialHash,a=typeof n=="function"?n(s,e,i):n,o=this._materialCache.get(a);if(!o||!O(o.spriteMosaicItem)||!o.spriteMosaicItem)return void mn.error(new ft("mapview-cim","Encountered an error when binding feature"));const h=o.spriteMosaicItem,l=this._cimMarkerLayer.sizeRatio,c=h.width/h.height*this._scaleX,u=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let f=this._size,_=f*c;const m=this.xOffset,d=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const p=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/g(this._cimMarkerLayer.frameHeight):1,y=this._outlineWidth*p,x=g(this._cimMarkerLayer.referenceSize);let M=0,v=0;const S=this._cimMarkerLayer.anchorPoint;S&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(M=-S.x/(this._size*c),v=S.y/this._size):(M=S.x,v=S.y)),this._sizeOutlineWidth=z(Math.round(Math.min(Math.sqrt(128*_),255)),Math.round(Math.min(Math.sqrt(128*f),255)),Math.round(Math.min(Math.sqrt(128*y),255)),Math.round(Math.min(Math.sqrt(128*x),255))),this.angle=u;const T=Math.round(64*l);this._bitestAndDistRatio=w(this._bitSet,T);const L=h.rect.x+$,P=h.rect.y+$,_t=L+h.width,nt=P+h.height;this._texUpperLeft=w(L,P),this._texUpperRight=w(_t,P),this._texBottomLeft=w(L,nt),this._texBottomRight=w(_t,nt);const K=Ki.load(this._materialKey);K.sdf=h.sdf,K.pattern=!0,K.textureBinding=h.textureBinding,this._materialKey=K.data,this._anchorX=.5-(.5+M)*h.width/h.width,this._anchorY=.5-(.5+v)*h.height/h.height,_*=l,f*=l,_*=this._scaleFactor,f*=this._scaleFactor,_*=h.rect.width/h.width,f*=h.rect.height/h.height,this._computedWidth=_,this._computedHeight=f,this._applyTransformation(_n,dn),this.xOffset=m,this.yOffset=d}}function Be(r){const t=new Array(r.length);for(let e=0;e<r.length;e++)t[e]=r.charCodeAt(e);return t}const wi=5;function pn(r,t,e,i){return typeof r.text=="string"?r.text:typeof r.text=="function"?r.text(t,e,i):""}class Oe extends Ui(ne){constructor(t,e,i){super(t),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map,this._minMaxZoom=w(Math.round(e*F),Math.round(i*F));const s=t.scaleFactor||1;this._cimTextLayer=t;const n=t.color;if(b(n)){const d=(p,y,x)=>C(n(p,y,x));this._dynamicPropertyMap.set("_color",d)}else this._color=C(n);const a=t.outlineColor;if(b(a)){const d=(p,y,x)=>C(a(p,y,x));this._dynamicPropertyMap.set("_haloColor",d)}else this._haloColor=C(a);let o;b(t.size)||(o=Math.min(Math.round(g(t.size*t.sizeRatio)),127));const h=(d,p,y)=>b(t.size)?Math.min(Math.round(g(t.size(d,p,y)*t.sizeRatio)),127):o;if(this._dynamicPropertyMap.set("_size",h),b(t.outlineSize)){const d=(p,y,x)=>Math.min(Math.floor(wi*g(t.outlineSize(p,y,x)*t.sizeRatio)),127);this._dynamicPropertyMap.set("_haloSize",d)}else this._haloSize=Math.min(Math.floor(wi*g(t.outlineSize*t.sizeRatio)),127);let l;b(t.offsetX)||(l=Math.round(g(t.offsetX*t.sizeRatio)));const c=(d,p,y)=>b(t.offsetX)?Math.round(g(t.offsetX(d,p,y)*t.sizeRatio)):l;let u;this._dynamicPropertyMap.set("_xOffset",c),b(t.offsetY)||(u=Math.round(g(t.offsetY*t.sizeRatio)));const f=(d,p,y)=>b(t.offsetY)?Math.round(g(t.offsetY(d,p,y)*t.sizeRatio)):u;if(this._dynamicPropertyMap.set("_yOffset",f),b(t.angle)?this._dynamicPropertyMap.set("_angle",t.angle):this._angle=t.angle,b(t.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",t.horizontalAlignment):this._horizontalAlignment=t.horizontalAlignment,b(t.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",t.verticalAlignment):this._verticalAlignment=t.verticalAlignment,W(t.effects)){const d=t.effects;b(d)?this._dynamicPropertyMap.set("_effects",d):this._effects=d}if(W(t.markerPlacement)){const d=t.markerPlacement;b(d)?this._dynamicPropertyMap.set("_markerPlacement",d):this._textPlacement=d}b(t.text)?this._dynamicPropertyMap.set("_text",t.text):this._text=t.text,this._scaleFactor=s;const _=Math.min(Math.round(g(t.referenceSize*t.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*_)),this._materialKey=t.materialKey;const m=nr.load(this._materialKey);m.sdf=!0,this._bitset=(t.alignment===D.MAP?1:0)|(t.colorLocked?1:0)<<1,this._materialKey=m.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._isCIM=!0}static fromCIMText(t,e){const[i,s]=rt(t.scaleInfo,e);return new Oe(t,i,s)}async analyze(t,e,i,s){const n=e.readLegacyFeature(),a=pn(this._cimTextLayer,n,i,s),o=await super.analyze(t,e,i,s,Be(a));return o&&o.glyphMosaicItems&&this._textToGlyphs.set(a,o.glyphMosaicItems),o}bindFeature(t,e,i){const s=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach((a,o)=>{this[o]=a(s,e,i)}),!this._text||this._text.length===0)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/Oi,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=Ei(this._horizontalAlignment||"center"),this._yAlignD=Ri(this._verticalAlignment||"baseline");const n=this._textToGlyphs.get(this._text);this.bindTextInfo(n,!1)}}const G=128;class U extends is(Rt){constructor(t,e,i,s,n,a,o,h,l,c,u,f,_,m,d,p){super(),this._effects=m;const y=Ct.load(t);e&&(y.sdf=e.sdf,y.pattern=!0,y.textureBinding=e.textureBinding),this.fillColor=i,this.tl=s,this.br=n,this.aux2=z(a,o,h,l),this.aux3=z(c,u,f,0),this._bitset=_,this._minMaxZoom=w(Math.round(d*F),Math.round(p*F)),this._materialKey=y.data}static fromCIMFill(t,e,i){const s=t.color,n=s&&C(s)||0,a=t.materialKey,[o,h]=rt(t.scaleInfo,i);if(!e)return new U(a,null,n,0,0,0,0,0,0,0,0,0,t.colorLocked?Mt:0,t.effects,o,h);const{rect:l,width:c,height:u}=e,f=t.scaleX||1,_=l.x+$,m=l.y+$,d=_+c,p=m+u,y=t.height,x=f*y;let M=Math.round(y);M>255?M=255:M<=0&&(M=p-m);let v=Math.round(x);v>255?v=255:v<=0&&(v=d-_);let S=g(t.offsetX||0)+G;S>255&&(S=255);let T=g(-t.offsetY||0)+G;T>255&&(T=255);const L=w(_,m),P=w(d,p);return new U(a,e,n,L,P,v,M,S,T,G,G,or(t.angle),t.colorLocked?Mt:0,t.effects,o,h)}static fromSimpleFill(t,e,i=!1){const{color:s}=t,n=s&&t.style!=="esriSFSNull"&&Y(s)||0,a=i?Mt:0,o=t.materialKey;let h;if(e){const{rect:l,width:c,height:u}=e,f=l.x+$,_=l.y+$,m=f+c,d=_+u,p=w(f,_),y=w(m,d);h=new U(o,e,n,p,y,c,u,0,0,G,G,0,a,null,N,q)}else h=new U(o,null,n,0,0,0,0,0,0,0,0,0,a,null,N,q);return h._maybeAddLineTemplate(t),h}static fromPictureFill(t,e,i=!1){const s=Vi,{rect:n,width:a,height:o}=e,h=n.x+$,l=n.y+$,c=h+a,u=l+o,f=w(h,l),_=w(c,u);let m=Math.round(g(t.width));m>255&&(m=255);let d=Math.round(g(t.height));d>255&&(d=255);let p=g(t.xoffset)+G;p>255&&(p=255);let y=g(-t.yoffset)+G;y>255&&(y=255);const x=t.materialKey,M=i?Mt:0,v=new U(x,e,s,f,_,m,d,p,y,G*t.xscale,G*t.yscale,0,M,null,N,q);return v._maybeAddLineTemplate(t),v}}class yn{constructor(){this._resolver=null}isHeld(){return!!this._resolver}async acquire(){if(!this._resolver)return this._resolver=_s(),Promise.resolve();await this._resolver.promise,await this.acquire()}release(){const t=this._resolver;this._resolver=null,t.resolve()}}async function xn(r,t,e){try{await r.acquire(),await t(e),r.release()}catch(i){throw r.release(),i}}const gn={marker:I.MARKER,fill:I.FILL,line:I.LINE,text:I.TEXT};class Mn{constructor(t,e,i,s){const n={minScale:e==null?void 0:e.minScale,maxScale:e==null?void 0:e.maxScale},a=wn(n);this.layers=t,this.data=e,this.hash=this._createHash()+a,this.rendererKey=i;const o={isOutline:!1,isOutlinedFill:!1,placement:null,stride:{fill:"default"},vvFlags:i};for(const h of t){const l=gn[h.type];h.materialKey=te(l,o),h.maxVVSize=s,h.scaleInfo=n,h.templateHash+=a}}get type(){return"expanded-cim"}_createHash(){let t="";for(const e of this.layers)t+=e.templateHash;return t}}function wn(r){return r.minScale||r.maxScale?r.minScale+"-"+r.maxScale:""}async function vn(r,t,e){if(!r.name)return Promise.reject(new ft("style-symbol-reference-name-missing","Missing name in style symbol reference"));if(r.styleName&&r.styleName==="Esri2DPointSymbolsStyle")return bn(r,e);try{return Sn(await ms(r,t,e),r.name,t,e)}catch(i){return tt(i),null}}async function bn(r,t){const e=ps.replace(/\{SymbolName\}/gi,r.name);try{const i=await ki(e,t);return Fi(i.data)}catch(i){return tt(i),null}}async function Sn(r,t,e,i){const s=r.data,n={portal:e&&e.portal||ys.getDefault(),url:xs(r.baseUrl),origin:"portal-item"},a=s.items.find(h=>h.name===t);if(!a)throw new ft("symbolstyleutils:symbol-name-not-found",`The symbol name '${t}' could not be found`,{symbolName:t});let o=gs(Ms(a,"cimRef"),n);ws()&&(o=vs(o));try{const h=await ki(o,i);return Fi(h.data)}catch(h){return tt(h),null}}const vi=async(r,t,e)=>new Mn(await lr(r.data,t,e),r.data,r.rendererKey,r.maxVVSize),st=async(r,t,e,i)=>{if(!r)return null;if(r.type==="cim")return vi(r,t,e);if(r.type==="web-style"){const s={type:"cim",data:await vn(r,null,i),rendererKey:r.rendererKey,maxVVSize:r.maxVVSize};return vi(s,t,e)}return r};function Ht(r){if(!r)return null;const{type:t,cim:e,url:i,materialHash:s}=r,n={cim:e,type:t,mosaicHash:s,url:i,size:null,dashTemplate:null,path:null,text:null,fontName:null};switch(t){case"marker":n.size=r.size,n.path=r.path;break;case"line":n.dashTemplate=r.dashTemplate;break;case"text":n.text=r.text,n.fontName=r.fontName}return n}const A=ut.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),bi=new Array,Ve={isOutline:!1,isOutlinedFill:!1,placement:null,stride:{fill:"default"},vvFlags:0},Tn=It(ot({},He),{hash:JSON.stringify(He),materialKey:te(I.MARKER,Ve)}),In=It(ot({},Ue),{hash:JSON.stringify(Ue),materialKey:te(I.LINE,Ve)}),Ln=It(ot({},Ye),{hash:JSON.stringify(Ye),materialKey:te(I.FILL,Ve)});function X(r,t){const e=r.length;return r.push(null),t.then(i=>r[e]=i),r}function zt(r){return!!(1&r)}function Pn(r){return r.name==="worker:port-closed"}class zn{constructor(t,e){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new yn,this._fetchResource=t,this._tileInfo=e}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(t,e){this._initErrorTemplates();const i=t.hash;if(this._symbolToTemplate.has(i))return this._symbolToTemplate.get(i);const s=new Array;e&&this._createMeshTemplates(s,e,!0),this._createMeshTemplates(s,t,!1);const n=this._createGroupId(t.type==="expanded-cim"&&$n(t));return this._idToTemplateGroup.set(n,s),this._symbolToTemplate.set(i,n),n}getTemplateGroup(t){return this._idToTemplateGroup.has(t)?this._idToTemplateGroup.get(t):bi}getDynamicTemplateGroup(t){return this._idToTemplateGroup.has(t)?(zt(t)||A.error("mapview-template-store",`Id ${t} does not refer to a dynamic template`),this._idToTemplateGroup.get(t)):bi}getMosaicItem(t,e){const i=this._createTemplateId(),s=new Promise(n=>this._idToResolver.set(i,n));return this._fetchQueue.push({symbol:t,id:i,glyphIds:e}),s}finalize(t){return this._fetchQueue.length||this._lock.isHeld()?xn(this._lock,this._fetchAllQueuedResources.bind(this),t):Promise.resolve()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],Ln,!1),marker:this._createMeshTemplates([],Tn,!1),line:this._createMeshTemplates([],In,!1)})}_fetchAllQueuedResources(t){if(!this._fetchQueue.length)return Promise.resolve();const e=this._fetchQueue,i=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(i).then(()=>this._fetchResource(e,t).then(s=>{for(const{id:n,mosaicItem:a}of s)this._idToResolver.get(n)(a),this._idToResolver.delete(n)})).catch(s=>{ze(s)?this._fetchQueue=this._fetchQueue.concat(e):Pn(s)||A.error(new ft("mapview-template-store","Unable to fetch requested texture resources",s))})}_createGroupId(t){return this._idCounter++<<1|(t?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return O(e,A)?Z.fromSimpleMarker(t,e):this._markerError}async _createPMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return O(e,A)?Z.fromPictureMarker(t,e):this._markerError}async _createSFS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return O(i,A)?U.fromSimpleFill(t,i,e):this._fillError}async _createPFS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return O(i,A)?U.fromPictureFill(t,i,e):this._fillError}async _createSLS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return O(i,A)?H.fromSimpleLine(t,i):this._lineError}async _createLMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return O(e,A)?Z.fromLineSymbolMarker(t,e):this._markerError}async _createTS(t){const{glyphMosaicItems:e}=await this.getMosaicItem(t);return St.fromText(t,e)}async _createCIMText(t){const{glyphMosaicItems:e}=await this.getMosaicItem(Ht(t),Be(t.text));return O(e,A)?St.fromCIMText(t,e,this._tileInfo):this._textError}async _createCIMFill(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Ht(t));return O(e,A)?U.fromCIMFill(t,e,this._tileInfo):this._fillError}async _createCIMLine(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Ht(t));return O(e,A)?H.fromCIMLine(t,e,this._tileInfo):this._lineError}async _createCIMMarker(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Ht(t));return O(e,A)?Z.fromCIMMarker(t,e,this._tileInfo):this._markerError}async _createCIM(t){const e=t.templateHash;if(this._cimTemplateCache.has(e))return this._cimTemplateCache.get(e);let i;switch(t.type){case"marker":i=await this._createCIMMarker(t);break;case"line":i=await this._createCIMLine(t);break;case"fill":i=await this._createCIMFill(t);break;case"text":i=await this._createCIMText(t)}return this._cimTemplateCache.set(e,i),i}async _createDynamicCIM(t){const e=t.templateHash;if(this._cimTemplateCache.has(e))return this._cimTemplateCache.get(e);let i;switch(t.type){case"marker":i=Ae.fromCIMMarker(t,this._tileInfo);break;case"line":i=Re.fromCIMLine(t,this._tileInfo);break;case"fill":i=Ee.fromCIMFill(t,this._tileInfo);break;case"text":i=Oe.fromCIMText(t,this._tileInfo)}return this._cimTemplateCache.set(e,i),i}_createPrimitiveMeshTemplates(t,e,i){switch(e.type){case"esriSMS":return X(t,this._createSMS(e));case"esriPMS":return X(t,this._createPMS(e));case"esriSFS":return X(t,this._createSFS(e,i));case"line-marker":return X(t,this._createLMS(e));case"esriPFS":return X(t,this._createPFS(e,i));case"esriSLS":return X(t,this._createSLS(e,!1));case"esriTS":return X(t,this._createTS(e));default:return A.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),t}}_createMeshTemplates(t,e,i){if(e.type.indexOf("3d")!==-1)return A.error("3D symbols are not supported with MapView"),t;if(e.type==="expanded-cim"){for(const s of e.layers)typeof s.materialHash=="function"?X(t,this._createDynamicCIM(s)):X(t,this._createCIM(s));return t}if(e.type==="composite-symbol"){for(const s of e.layers)this._createPrimitiveMeshTemplates(t,s,i);return t}return e.type==="cim"||e.type==="label"||e.type==="web-style"?t:this._createPrimitiveMeshTemplates(t,e,i)}}const $n=r=>{if(!r.layers)return!1;for(const t of r.layers)if(typeof t.materialHash=="function")return!0;return!1};class Cn{constructor(t,e,i){this._loadPromise=sr(),this._geometryType=t,this._idField=e,this._templateStore=i}update(t,e){W(t.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(t.mesh.labels,e)),this._schema=t}_createLabelTemplates(t,e){const i=new Map;if(t.type==="simple"){for(const s of t.classes){const n=jt.fromLabelClass(s,e);i.set(s.index,n)}return i}for(const s in t.classes){const n=t.classes[s];for(const a of n){const o=jt.fromLabelClass(a,e);i.set(a.index,o)}}return i}get templates(){return this._templateStore}async analyze(t,e,i,s,n,a,o){if(je(o))return;let h;i.type==="dictionary"&&(h=await i.analyze(this._idField,t.copy(),e,n,a,o));let l=0;for(;t.next();){let c;if(c=h?h[l++]:W(s)&&Bi(t.getDisplayId())&&t.readAttribute("cluster_count")!==1?s.match(this._idField,t,this._geometryType,n,a):i.match(this._idField,t,this._geometryType,n,a),t.setGroupId(c),zt(c)){const u=this._templateStore.getDynamicTemplateGroup(c);for(const f of u)f&&f.analyze&&f.analyze(this._templateStore,t,n,a)}}return await this._loadPromise,this._templateStore.finalize(o)}async analyzeGraphics(t,e,i,s,n,a){if(je(a))return;const o=t.getCursor();for(i&&await i.analyze(this._idField,o.copy(),e,s,n,a);o.next();){let h=o.getGroupId();if(h!=null&&h!==-1||(h=i.match(this._idField,o,o.geometryType,s,n),o.setGroupId(h)),zt(h)){const l=this._templateStore.getDynamicTemplateGroup(h);for(const c of l)c&&c.analyze&&c.analyze(this._templateStore,o,s,n)}o.setGroupId(h)}return await this._loadPromise,this._templateStore.finalize(a)}writeGraphic(t,e,i,s){const n=e.getGroupId(),a=e.getDisplayId(),o=this._templateStore.getTemplateGroup(n);if(t.featureStart(e.insertAfter,0),a!=null){if(zt(n))for(const h of o)h&&h.bindFeature(e,null,null);if(o){for(const h of o)h&&h.write(t,e,i,s);t.featureEnd()}}}writeCursor(t,e,i,s,n,a,o){const h=e.getGroupId(),l=e.getDisplayId(),c=this._templateStore.getTemplateGroup(h),u=this._schema.mesh.sortKey;let f=0;if(W(u)&&(f=u.fieldIndex!=null?e.getComputedNumericAtIndex(u.fieldIndex):u.field!=null?e.readAttribute(u.field):e.readAttribute(this._idField),f*=u.order==="asc"?1:-1),t.featureStart(0,f==null||isNaN(f)?0:f),l!=null&&c){if(zt(h))for(const _ of c)_.bindFeature(e,i,s);for(const _ of c)_.write(t,e,n,o);if(W(a)&&t.hasRecords){const _=a&&this._findLabelRef(c);this._writeLabels(t,e,a,_,n,o)}t.featureEnd()}}_findLabelRef(t){for(const e of t)if(e instanceof Z)return e;return null}_writeLabels(t,e,i,s,n,a){for(const o of i)if(W(o)&&o){const{glyphs:h,rtl:l,index:c}=o,u=this._labelTemplates.get(c);u.setZoomLevel(n),u.bindReferenceTemplate(s),u.bindTextInfo(h,l),u.write(t,e,null,a)}}}const be=ut.getLogger("esri/views/2d/engine/webgl/util/Matcher");async function Se(r,t,e,i){switch(r.type){case"simple":return dt.fromBasicRenderer(r,t,e,i);case"map":return Ge.fromUVRenderer(r,t,e,i);case"interval":return Ke.fromCBRenderer(r,t,e,i);case"dictionary":return Ze.fromDictionaryRenderer(r,t,e,i);case"subtype":return De.fromSubtypes(r,t,e,i)}}class dt{constructor(){this.type="feature",this._defaultResult=null}static async fromBasicRenderer(t,e,i,s){const n=new dt;if(t.symbol){const a=await st(t.symbol,i,s),o=e.createTemplateGroup(a,null);n.setDefault(o)}return n}size(){return 1}getDefault(){return this._defaultResult}setDefault(t){this._defaultResult=t}match(t,e,i,s,n){return this.getDefault()}async analyze(t,e,i,s,n,a){return null}}class De extends dt{constructor(t,e){super(),this._subMatchers=t,this._subtypeField=e}static async fromSubtypes(t,e,i,s){const n=new Map,a=[];for(const o in t.renderers){const h=parseInt(o,10),l=Se(t.renderers[o],e,i,s).then(c=>n.set(h,c));a.push(l)}return await Promise.all(a),new De(n,t.subtypeField)}match(t,e,i,s,n){const a=e.readAttribute(this._subtypeField),o=this._subMatchers.get(a);return o?o.match(t,e,i,s,n):null}}class Ke extends dt{constructor(t,e,i,s){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=e,this._fieldIndex=s,this._field=t,this._normalizationInfo=i}static async fromCBRenderer(t,e,i,s){const{isMaxInclusive:n,normalizationField:a,normalizationTotal:o,normalizationType:h}=t,l=t.field,c=new Ke(l,n,{normalizationField:a,normalizationTotal:o,normalizationType:h},t.fieldIndex),u=await st(t.backgroundFillSymbol,i,s);await Promise.all(t.intervals.map(async _=>{const m=await st(_.symbol,i,s),d=await e.createTemplateGroup(m,u),p={min:_.min,max:_.max};c.add(p,d)}));const f=await st(t.defaultSymbol,i,s);if(f){const _=await e.createTemplateGroup(f,u);c.setDefault(_)}return c}add(t,e){this._intervals.push({interval:t,result:e}),this._intervals.sort((i,s)=>i.interval.min-s.interval.min)}size(){return super.size()+this._intervals.length}match(t,e,i,s,n){if(this._fieldIndex==null&&!this._field)return this.getDefault();const a=this._fieldIndex!=null?e.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(e);if(!a&&(a==null||isNaN(a)))return this.getDefault();for(let o=0;o<this._intervals.length;o++){const{interval:h,result:l}=this._intervals[o],c=a>=h.min,u=this._isMaxInclusive?a<=h.max:a<h.max;if(c&&u)return l}return this.getDefault()}_needsNormalization(){const t=this._normalizationInfo;return t&&(t.normalizationField||t.normalizationTotal||t.normalizationType)}_getValueFromField(t){const e=t.readAttribute(this._field);if(!this._needsNormalization()||e==null)return e;const{normalizationField:i,normalizationTotal:s,normalizationType:n}=this._normalizationInfo,a=!!i&&t.readAttribute(i);if(n)switch(n){case"esriNormalizeByField":return a?e/a:void 0;case"esriNormalizeByLog":return Math.log(e)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return e/s*100;default:return void be.error(`Found unknown normalization type: ${n}`)}else be.error("Normalization is required, but no type was set!")}}class Ge extends dt{constructor(t,e,i){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fieldsIndex=i,this._fields=t,this._seperator=e||""}static async fromUVRenderer(t,e,i,s){const n=t.fieldDelimiter,a=[t.field];t.field2&&a.push(t.field2),t.field3&&a.push(t.field3);const o=await st(t.backgroundFillSymbol,i,s),h=new Ge(a,n,t.fieldIndex);await Promise.all(t.map.map(async c=>{const u=await st(c.symbol,i,s),f=await e.createTemplateGroup(u,o);c.value==="<Null>"?h.setNullResult(f):h.add(c.value,f)}));const l=await st(t.defaultSymbol,i,s);if(l){const c=await e.createTemplateGroup(l,o);h.setDefault(c)}return h}setNullResult(t){this._nullResult=t}add(t,e){this._resultsMap.set(t.toString(),e)}size(){return super.size()+this._resultsMap.size}match(t,e,i,s,n){if(this._fieldsIndex==null&&!this._fields)return this.getDefault();const a=this._fieldsIndex!=null?e.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(e);if(this._nullResult!==null&&(a==null||a===""||a==="<Null>"))return this._nullResult;if(!a&&a==null)return this.getDefault();const o=a.toString();return this._resultsMap.has(o)?this._resultsMap.get(o):this.getDefault()}_getValueFromFields(t){const e=[];for(const i of this._fields){const s=t.readAttribute(i);s==null||s===""?e.push("<Null>"):e.push(s)}return e.join(this._seperator)}}async function Wn(r,t){const e=r||1;if(typeof e=="number")return(s,n,a)=>e;const i=await Ss(e,t.spatialReference,t.fields);return(s,n,a)=>Ts(i,s,{$view:a},t.geometryType,n)||1}let ue;async function kn(){return ue||(ue=import("./createSymbolSchema.0b773990.js")),ue}class Ze extends dt{constructor(t,e,i,s,n,a){super(),this.type="dictionary",this._groupIdCache=new bs(100),this._loader=t,this._fieldMap=t.fieldMap,this._symbolFields=t.getSymbolFields(),this._templates=e,this._info=i,this._scaleFn=s,this._schemaUtilsModule=n,this._symbolOptions=a}static async fromDictionaryRenderer(t,e,i,s){const[{DictionaryLoader:n},a]=await Promise.all([import("./vendor.f59113c8.js").then(function(l){return l.rB}),kn()]),o=new n(t.url,t.config,t.fieldMap);await o.fetchResources({spatialReference:i.spatialReference,fields:i.fields});const h=await Wn(t.scaleExpression,i);return new Ze(o,e,i,h,a,t.symbolOptions)}async _analyzeFeature(t,e,i,s,n){const a=t.readLegacyFeature(),o=this._scaleFn(a,i,s),h=this._attributeHash(a)+"-"+o,l=this._groupIdCache.get(h);if(l)return l;const c=It(ot({},s),{spatialReference:this._info.spatialReference,abortOptions:n,fields:this._info.fields}),u=await this._loader.getSymbolAsync(a,c),f=this._schemaUtilsModule.createSymbolSchema(u,this._symbolOptions),_=st(f,this._info,e,n).then(m=>{if(m.type!=="expanded-cim")return be.error(new ft("mapview-bad-type",`Found unexpected type ${m.type} in dictionary response`)),null;m.hash+="-"+o;for(const d of m.layers)d.scaleFactor=o,d.templateHash+="-"+o;return this._templates.createTemplateGroup(m,null)});return this._groupIdCache.put(h,_,1),_}async analyze(t,e,i,s,n,a){const o=e.getCursor(),h=[];for(;o.next();)h.push(this._analyzeFeature(o,i,s,n,a));return Promise.all(h)}match(t,e,i,s,n){return null}_attributeHash(t){let e="";for(const i of this._symbolFields){const s=this._fieldMap[i];s&&(e+=t.attributes[s]+"-")}return e}}class Fn{constructor(t){this._remoteClient=t,this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null}destroy(){}async fetchResource(t,e){const i=this._resourceMap,s=i.get(t);if(s)return s;let n=this._inFlightResourceMap.get(t);if(n)return n;try{n=this._remoteClient.invoke("tileRenderer.fetchResource",{url:t},ot({},e)),this._inFlightResourceMap.set(t,n),n.then(a=>(this._inFlightResourceMap.delete(t),i.set(t,a),a))}catch(a){return ze(a)?null:{width:0,height:0}}return n}getResource(t){var e;return(e=this._resourceMap.get(t))!=null?e:null}}function Si(r,t){return(!r.minScale||r.minScale>=t)&&(!r.maxScale||r.maxScale<=t)}function Ti(r){const t=r.message,e={message:{data:{},tileKey:t.tileKey,tileKeyOrigin:t.tileKeyOrigin},transferList:new Array};for(const i in t.data){const s=t.data[i];if(e.message.data[i]=null,W(s)){const n=s.stride,a=s.indices.slice(0),o=s.vertices.slice(0),h=s.records.slice(0),l={stride:n,indices:a,vertices:o,records:h,metrics:$t(s.metrics,c=>c.slice(0))};e.transferList.push(a,o,h),e.message.data[i]=l}}return e}ut.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor");let Te=class extends tr{constructor(){super(...arguments),this.type="symbol",this._matchers={feature:null,aggregate:null},this._bufferData=new Map,this._bufferIds=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))]),this._resourceManagerProxy=new Fn(this.remoteClient)}destroy(){this._resourceManagerProxy.destroy()}get supportsTileUpdates(){return!0}forEachBufferId(r){this._bufferIds.forEach(t=>{t.forEach(r)})}async update(r,t){const e=t.schema.processors[0];if(e.type!=="symbol")return;const i=Is(this._schema,e);Ls(i,"mesh")&&(Ps("esri-2d-update-debug")&&console.debug("Applying Update - Processor:",i),r.mesh=!0,r.why.mesh.push("Symbology changed"),this._schema=e,this._factory=this._createFactory(e),this._factory.update(e,this.tileStore.tileScheme.tileInfo))}onTileMessage(r,t,e,i){return tt(i),this._onTileData(r,t,e,i)}onTileClear(r){const t={clear:!0};return this._bufferData.delete(r.key.id),this._bufferIds.delete(r.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:r.id,data:t})}onTileError(r,t,e){const i=e.signal,s={tileKey:r.id,error:t};return this.remoteClient.invoke("tileRenderer.onTileError",s,{signal:i})}onTileUpdate(r){for(const t of r.removed)this._bufferData.has(t.key.id)&&this._bufferData.delete(t.key.id),this._bufferIds.has(t.key.id)&&this._bufferIds.delete(t.key.id);for(const t of r.added)this._bufferData.forEach(e=>{for(const i of e)i.message.tileKey===t.id&&this._updateTileMesh("append",t,Ti(i),[],!1,!1,null)})}_addBufferData(r,t){this._bufferData.has(r)||this._bufferData.set(r,[]),this._bufferData.get(r).push(Ti(t))}_createFactory(r){const{geometryType:t,objectIdField:e,fields:i}=this.service,s=(l,c)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",l,c),n={geometryType:t,fields:i,spatialReference:zs.fromJSON(this.spatialReference)},a=new zn(s,this.tileStore.tileScheme.tileInfo),{matcher:o,aggregateMatcher:h}=r.mesh;return this._store=a,this._matchers.feature=Se(o,a,n,this._resourceManagerProxy),this._matchers.aggregate=$t(h,l=>Se(l,a,n,this._resourceManagerProxy)),new Cn(t,e,a)}async _onTileData(r,t,e,i){tt(i);const{type:s,addOrUpdate:n,remove:a}=t,o=t.end,h=!!this._schema.mesh.sortKey;if(!n){const c={type:s,addOrUpdate:null,remove:a,clear:!1,end:o,sort:h};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:r.id,data:c},i)}const l=this._processFeatures(r,n,e,i);try{const c=await l;if(R(c)){const f={type:s,addOrUpdate:null,remove:a,clear:!1,end:o,sort:h};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:r.id,data:f},i)}const u=[];for(const f of c){let _=!1;const m=f.message.bufferIds,d=r.key.id,p=f.message.tileKey;if(d!==p&&W(m)){if(!this.tileStore.get(p)){this._addBufferData(d,f),u.push(f);continue}let y=this._bufferIds.get(p);y||(y=new Set,this._bufferIds.set(p,y));const x=Array.from(m);for(const M of x){if(y.has(M)){_=!0;break}y.add(M)}}_||(this._addBufferData(d,f),u.push(f))}await $s(u.map(f=>{const _=r.key.id===f.message.tileKey,m=_?t.remove:[],d=_&&t.end;return this._updateTileMesh(s,r,f,m,d,t.clear,i.signal)}))}catch(c){this._handleError(r,c,i)}}async _updateTileMesh(r,t,e,i,s,n,a){const o=r,h=e.message.tileKey,l=!!this._schema.mesh.sortKey;h!==t.key.id&&(s=!1);const c=$t(e,m=>m.message),u=$t(e,m=>m.transferList)||[],f={type:o,addOrUpdate:c,remove:i,clear:!1,end:s,sort:l},_={transferList:Jt(u)||[],signal:a};return tt(_),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:h,data:f},_)}async _processFeatures(r,t,e,i){if(R(t)||!t.hasFeatures)return null;const s={transform:r.transform,hasZ:!1,hasM:!1},n=this._factory,a={viewingMode:"",scale:r.scale},o=await this._matchers.feature,h=await this._matchers.aggregate;tt(i);const l=this._getLabelInfos(r,t);return await n.analyze(t.getCursor(),this._resourceManagerProxy,o,h,s,a),tt(i),this._writeFeatureSet(r,t,s,l,n,e)}_writeFeatureSet(r,t,e,i,s,n){const a=t.getSize(),o=new vr(r.key.id,{features:a,records:a,metrics:0},this._schema.mesh.matcher.stride,n,!0),h={viewingMode:"",scale:r.scale},l=t.getCursor();for(;l.next();)try{const u=l.getDisplayId(),f=W(i)?i.get(u):null;s.writeCursor(o,l,e,h,r.level,f,this._resourceManagerProxy)}catch{}const c=r.tileInfoView.tileInfo.isWrappable;return o.serialize(c)}_handleError(r,t,e){if(!ze(t)){const i={tileKey:r.id,error:t.message};return this.remoteClient.invoke("tileRenderer.onTileError",i,{signal:e.signal})}}_getLabelingSchemaForScale(r){const t=this._schema.mesh.labels;if(R(t))return null;if(t.type==="subtype"){const i={type:"subtype",classes:{}};let s=!1;for(const n in t.classes){const a=t.classes[n].filter(o=>Si(o,r.scale));s=s||!!a.length,i.classes[n]=a}return s?i:null}const e=t.classes.filter(i=>Si(i,r.scale));return e.length?{type:"simple",classes:e}:null}_getLabels(r,t){if(t.type==="subtype"){var e;const i=this.service.subtypeField,s=Cs(i,"Expected to find subtype Field"),n=r.readAttribute(s);return n==null?[]:(e=t.classes[n])!=null?e:[]}return t.classes}_getLabelInfos(r,t){const e=this._getLabelingSchemaForScale(r);if(R(e))return null;const i=new Map,s=t.getCursor();for(;s.next();){const n=s.getDisplayId(),a=[],o=Bi(n),h=o&&s.readAttribute("cluster_count")!==1?"aggregate":"feature",l=this._getLabels(s,e);for(const c of l){if(c.target!==h)continue;const u=s.getStorage(),f=o&&h==="feature"?u.getComputedStringAtIndex(s.readAttribute("referenceId"),c.fieldIndex):u.getComputedStringAtIndex(n,c.fieldIndex);if(!f)continue;const _=_e(f.toString()),m=_[0],d=_[1];this._store.getMosaicItem(c.symbol,Be(m)).then(p=>{a[c.index]={glyphs:p.glyphMosaicItems,rtl:d,index:c.index}})}i.set(n,a)}return i}};Te=E([Ie("esri.views.2d.layers.features.processors.SymbolProcessor")],Te);const ha=Te;export{ha as default};
